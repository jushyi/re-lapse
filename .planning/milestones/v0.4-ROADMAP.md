# Milestone v0.4: Production Ready

**Status:** SHIPPED 2026-01-20
**Phases:** 11-14 (including 12.1, 12.2, 13.1, 13.2 inserted phases)
**Total Plans:** 17

## Overview

This milestone prepared the Lapse Clone app for production release. The work included migrating all Firebase operations to the modular API (v22+), adding an Instagram-style Stories feature, creating Oly brand assets, building via EAS, implementing server-side darkroom reveals, and verifying push notifications end-to-end.

## Phases

### Phase 11: Firebase Modular API Migration

**Goal**: Migrate all services from namespaced API to modular API (v22+)
**Depends on**: v0.3 complete
**Plans**: 4 plans

Plans:

- [x] 11-01: Core Services (photoService, darkroomService)
- [x] 11-02: Social Services (feedService, friendshipService)
- [x] 11-03: Storage & Remaining (storageService, userService, notificationService)
- [x] 11-04: Screens & Components (AuthContext, ProfileScreen, UserSearchScreen, FriendsListScreen, FriendRequestCard)

**Details:**
Migrated all Firestore and Storage operations from `firestore().collection()` syntax to `collection(db, 'name')` modular pattern. Final audit confirmed zero namespaced patterns remain in src/ directory. 10+ files migrated, 30+ functions converted.

---

### Phase 12: Friendship Service Fix + Testing

**Goal**: Debug and fix friendship errors, verify all social features work
**Depends on**: Phase 11
**Plans**: 1 plan

Plans:

- [x] 12-01: Fix exists() Method Calls

**Details:**
Fixed incorrect `exists()` method calls in friendshipService.js. The modular API uses `docSnap.exists` property instead of `docSnap.exists()` method.

---

### Phase 12.1: Friends List Screen Crash Fix (INSERTED)

**Goal**: Fix FriendsListScreen crash - ErrorBoundary catching component tree error
**Depends on**: Phase 12
**Plans**: 1 plan + 4 FIX iterations

Plans:

- [x] 12.1-01: Fix Filter.or Usage

**Details:**
Fixed Filter.or access pattern via modular API. The `firestore.Filter.or()` pattern from namespaced API was broken. Solution: use modular `or(where(...), where(...))` pattern per React Native Firebase v22+ modular API exports.

Additional FIX plans resolved:

- 12.1-01-FIX: Changed OR query to dual-field single query
- 12.1-01-FIX2: Reverted to OR with alternative approach
- 12.1-01-FIX3: Fixed getSentRequests with or() query pattern
- 12.1-01-FIX4: Added isFriendshipMemberById() to Firestore rules for checkFriendshipStatus

---

### Phase 12.2: Feed Stories Feature (INSERTED)

**Goal**: Add Instagram Stories-style viewer for friends' photos with curated feed showing top 5 snaps
**Depends on**: Phase 12.1
**Plans**: 4 plans

Plans:

- [x] 12.2-01: Service Layer (getTopPhotosByEngagement, getFriendStoriesData)
- [x] 12.2-02: Stories Row Component (FriendStoryCard + horizontal row in FeedScreen)
- [x] 12.2-03: Stories Viewer (StoriesViewerModal with navigation gestures)
- [x] 12.2-04: Feed Curation & Polish (top 5 per friend, edge cases)

**Details:**
Feature request: PhotoCards of friends that when tapped display all of friend's snaps in IG Story-style viewer. Main feed changes to show only top 5 snaps from friends, ranked by engagement (reactionCount).

Components created:

- FriendStoryCard: Avatar circle with friend name
- StoriesViewerModal: Full-screen viewer with tap-to-advance and swipe-to-dismiss
- Feed curation: Top 5 photos per friend ranked by engagement

---

### Phase 13: Production Build & Branding

**Goal**: EAS build setup, app icon, splash screen, TestFlight prep
**Depends on**: Phase 12.2
**Plans**: 3 plans

Plans:

- [x] 13-01: Oly Brand Assets (icon, splash, app.json)
- [x] 13-02: Animated Splash Screen (shutter opening effect)
- [x] 13-03: EAS Build & Distribution (iOS build, internal distribution)

**Details:**
Created Oly brand identity:

- App icon: Camera aperture-inspired design with "OLY" text
- Animated splash: Shutter opening effect using expo-splash-screen
- Bundle ID: com.spoodsjs.oly
- iOS build available via EAS internal distribution

Build: https://expo.dev/accounts/spoodsjs/projects/Oly/builds/6db03d2f-777b-4d44-a8a8-da33f0705329

---

### Phase 13.1: Darkroom Reveal Timing Fix (INSERTED)

**Goal**: Fix inaccurate nextRevealAt calculation and change reveal interval to 0-15 minutes
**Depends on**: Phase 13
**Plans**: 1 plan + 1 FIX

Plans:

- [x] 13.1-01: Timing Fix & Darkroom Initialization

**Details:**
Fixed darkroom timing accuracy by adding ensureDarkroomInitialized() call on photo capture. Reduced reveal interval from 0-2 hours to 0-15 minutes for better testing experience.

---

### Phase 13.2: Darkroom Auto-Reveal Fix (INSERTED)

**Goal**: Fix darkroom not revealing photos when nextRevealAt time passes
**Depends on**: Phase 13.1
**Plans**: 1 plan + 1 FIX

Plans:

- [x] 13.2-01: Fix ensureDarkroomInitialized + Add foreground reveal check
- [x] 13.2-01-FIX: Server-side darkroom reveal via scheduled Cloud Function

**Details:**
Bug: When nextRevealAt time passes, nothing happens automatically. The reveal logic only runs when the user opens DarkroomScreen.

Solution: Added processDarkroomReveals scheduled Cloud Function that runs every 2 minutes, checking all darkrooms with overdue nextRevealAt and revealing photos server-side.

---

### Phase 14: Remote Notification Testing & Polish

**Goal**: End-to-end notification verification, final bug fixes
**Depends on**: Phase 13
**Plans**: 1 plan

Plans:

- [x] 14-01: Remote Notification E2E Testing (all 3 notification types)

**Details:**
All 3 notification types verified working on standalone iOS build:

- Photo reveal notifications (fixed permission flow for existing users)
- Friend request notifications
- Reaction notifications (working but sends per-tap - debouncing deferred)

Fixed: Darkroom deep link now properly opens bottom sheet via Camera tab navigation.

---

## Milestone Summary

**Inserted Phases:**

- Phase 12.1: Friends List Screen Crash Fix (urgent - Filter.or migration + Firestore rules)
- Phase 12.2: Feed Stories Feature (feature request)
- Phase 13.1: Darkroom Reveal Timing Fix (urgent - UAT discovered timing issues)
- Phase 13.2: Darkroom Auto-Reveal Fix (urgent - photos not revealing automatically)

**Key Decisions:**

- Decision: Use or(where(), where()) for OR queries (Rationale: RN Firebase v22 modular API pattern)
- Decision: Parse document IDs in Firestore rules (Rationale: Allow reads on non-existent docs)
- Decision: 2-minute schedule for processDarkroomReveals (Rationale: Balance responsiveness vs cost)
- Decision: Changed bundle ID to com.spoodsjs.oly (Rationale: Original was taken)
- Decision: Feed curation top 5 per friend by reactionCount (Rationale: No comments system exists)

**Issues Resolved:**

- Fixed Filter.or crash in FriendsListScreen
- Fixed friendship permission errors for checkFriendshipStatus
- Fixed darkroom timing initialization on photo capture
- Fixed photos not revealing automatically (server-side reveal)
- Fixed notification permission flow for existing users
- Fixed darkroom deep link navigation

**Issues Deferred:**

- Reaction notifications send per-tap (should debounce to aggregate)
- TestFlight submission (requires App Store Connect setup)

**Technical Debt Incurred:**

- None significant

---

_For current project status, see .planning/ROADMAP.md_
