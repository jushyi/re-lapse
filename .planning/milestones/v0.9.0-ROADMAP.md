# Milestone v0.9.0: Engagement & Polish

**Status:** SHIPPED 2026-02-10
**Phases:** 32-45
**Total Plans:** 30 (27 + 3 FIX)

## Overview

Clean up technical debt, build robust push notifications, add friend tagging in photos, implement notification activity feed, and conduct a full-stack security audit. This milestone transformed the app from a feature-complete prototype into a polished, secure, notification-driven social experience.

## Phases

### Phase 32: Photo Issues Fix

**Goal**: Fix ISS-001 (photo display optimization) and ISS-011 (custom profile photo crop UI)
**Depends on**: v1.6 complete
**Plans**: 2/2 complete

Plans:

- [x] 32-01: Photo display fix (AlbumPhotoViewer contentFit=contain)
- [x] 32-02: Profile photo crop UI

**Details:**
Fixed album photo display with letterboxing (contentFit="contain"). Built custom profile photo crop UI with circular preview, pinch-zoom, and pan gestures integrated into profile screens.

### Phase 33: Navigation Issues Fix

**Goal**: Fix ISS-004 (comments sheet navigation) and ISS-005 (swipe up for comments)
**Depends on**: Phase 32
**Plans**: 1/1 complete

Plans:

- [x] 33-01: Comments sheet persistence and swipe-up gesture

**Details:**
Converted comments sheet from Modal to Animated.View for persistent state. Added swipe-up gesture for comments access.

### Phase 34: Push Infrastructure

**Goal**: Complete push notification foundation — audit existing code, fix gaps, ensure reliable delivery
**Depends on**: Phase 33
**Plans**: 2/2 complete

Plans:

- [x] 34-01: Reliability foundation (expo-server-sdk, token refresh)
- [x] 34-02: Receipt checking

**Details:**
Implemented expo-server-sdk push notification infrastructure with automatic rate limiting and token refresh handling. Added scheduled receipt checking function for automatic invalid push token cleanup.

### Phase 35: Social Notification Events

**Goal**: Add notification triggers for likes, comments, follows, and friend requests
**Depends on**: Phase 34
**Plans**: 2/2 complete

Plans:

- [x] 35-01: Notification settings UI (master toggle + per-type toggles)
- [x] 35-02: Friend accepted notifications, @mentions, preference checks

**Details:**
Created NotificationSettingsScreen with master toggle and 5 per-type notification preference toggles. Implemented friend acceptance notifications, @mention parsing in comments, and preference checks on all social notification functions.

### Phase 36: Photo Notification Events

**Goal**: Add notifications for tagged in photo and new story events
**Depends on**: Phase 35
**Plans**: 2/2 complete

Plans:

- [x] 36-01: Story notifications (triage completion tracking, Cloud Function, deep linking)
- [x] 36-02: Tagged photo notifications (Cloud Function infrastructure, deep linking, schema docs)

**Details:**
Built story notifications triggered on darkroom triage completion with 5 varied message templates. Implemented tagged photo notification infrastructure with 30-second debounce window for tag batching.

### Phase 37: Darkroom Ready Notifications

**Goal**: Audit and update existing darkroom ready notification — ensure reliable delivery and clear messaging
**Depends on**: Phase 34
**Plans**: 1/1 complete

Plans:

- [x] 37-01: Audit and clean darkroom notification (dead code removal, simplified messaging, push enable banner)

**Details:**
Audited and cleaned darkroom notification. Removed dead code, simplified messaging, added push enable banner.

### Phase 38: Notification UI Polish

**Goal**: Polish in-app notification presentation and user experience
**Depends on**: Phase 35, Phase 36
**Plans**: 2/2 + 1 FIX complete

Plans:

- [x] 38-01: In-app notification banner (custom dark-themed foreground display)
- [x] 38-02: Notification list polish (bold usernames, unread dots, per-tap read, tappable items)

**Details:**
Created custom in-app notification banner with slide animation, auto-dismiss, and swipe-up dismiss replacing system alerts. Added bold username formatting, unread purple dot indicators, and per-tap mark-as-read with deep navigation.

### Phase 39: Darkroom Photo Tagging

**Goal**: Add UI to tag friends during darkroom photo triage (button on photo card)
**Depends on**: Phase 38
**Plans**: 1/1 + 1 FIX complete

Plans:

- [x] 39-01: TagFriendsModal, darkroom tag button, taggedUserIds persistence

**Details:**
Built TagFriendsModal with multi-select friend picker and integrated tag button into darkroom triage bar.

### Phase 40: Feed Photo Tagging

**Goal**: Allow tagging on existing feed photos via three-dots menu
**Depends on**: Phase 39
**Plans**: 1/1 complete

Plans:

- [x] 40-01: Tag button on PhotoDetailScreen, TaggedPeopleModal, updatePhotoTags persistence

**Details:**
Added tag button to PhotoDetailScreen with owner tagging and TaggedPeopleModal for non-owner viewing.

### Phase 41: Tagged Notification Integration

**Goal**: Connect photo tagging to notification system — notify tagged users
**Depends on**: Phase 40
**Plans**: 1/1 complete

Plans:

- [x] 41-01: Notification settings toggle + tag removal cancellation

**Details:**
Added "Tagged in Photos" notification toggle and implemented tag removal cancellation during 30-second debounce window.

### Phase 42: Mutual Friends Suggestions

**Goal**: Suggest friends based on mutual connections
**Depends on**: Phase 41
**Plans**: 2/2 complete

Plans:

- [x] 42-01: getMutualFriendSuggestions service function + FriendCard subtitle prop
- [x] 42-02: Integrate mutual friend suggestions into FriendsScreen UI + Cloud Function

**Details:**
Created getMutualFriendSuggestions service function computing friend-of-friend connections with cap at 30 friends/20 suggestions. Integrated into FriendsScreen with Cloud Function backend for secure cross-user queries.

### Phase 43: Comment Cleanup and Audit

**Goal**: Full sweep of all code comments — fix inaccurate, remove stale TODOs, cut noise
**Depends on**: Phase 42
**Plans**: 4/4 complete

Plans:

- [x] 43-01: Services + Cloud Functions comment audit
- [x] 43-02: Hooks, utils, context, navigation, App.js comment audit
- [x] 43-03: Components comment audit
- [x] 43-04: Screens, styles, constants comment audit

**Details:**
Audited entire codebase. Fixed stale comments, removed ~400+ lines of noise comments, corrected inaccurate references across services, Cloud Functions, hooks, utils, components, screens, styles, and constants.

### Phase 44: Notification Activity Feed

**Goal**: Complete the notification screen to properly display all notification types with deep linking
**Depends on**: Phase 43
**Plans**: 2/2 complete

Plans:

- [x] 44-01: Notification type renderers + photo thumbnails
- [x] 44-02: Time grouping + deep linking polish + visual verification

**Details:**
Unified deep linking for all 8 notification types across push, banner, and activity feed taps. Added reaction clumping, time-grouped section headers (Today/This Week/Earlier), and corrected all notification deep links.

### Phase 45: Security Audit

**Goal**: Full-stack security sweep — Storage rules, Cloud Functions authorization, Firestore access, input validation, client-side defense
**Depends on**: Phase 44
**Plans**: 4/4 complete

Plans:

- [x] 45-01: Firebase Security Rules hardening (Storage auth + Firestore comment access)
- [x] 45-02: Cloud Functions access control (getSignedPhotoUrl auth + CORS + error sanitization)
- [x] 45-03: Cloud Functions input validation (@mention cap + tag validation + atomic deletions)
- [x] 45-04: Client-side security (comment/tag validation + logger refinement + album sanitization)

**Details:**
Hardened Firebase security rules closing public photo access and enforcing comment/like access hierarchy. Added Cloud Functions access control with authorization checks and CORS removal on destructive functions. Implemented input validation caps on @mentions (10) and photo tags (20) with atomic Firestore batch deletion. Added client-side comment/tag validation, precise logger sanitization, and album name XSS sanitization.

---

## Milestone Summary

**Key Decisions:**

- Mutual friend computation via Cloud Function (Firestore rules block client-side cross-user queries)
- Photo notification taps open PhotoDetail directly (FeedScreen has no photoId handler)
- Main photos owner-only in Storage, friends access via Cloud Function signed URLs
- Comments as Animated.View not Modal (persistent state, better gestures)
- 30-second tag notification debounce (batch tags, allow cancellation)

**Issues Resolved:**

- ISS-001: Photo display optimization (fixed with contentFit=contain)
- ISS-004: Comments sheet navigation (fixed with Animated.View refactor)
- ISS-005: Swipe up for comments (added gesture)
- ISS-011: Custom profile photo crop UI (built with pinch-zoom/pan)

**Issues Deferred:**

None — all issues closed.

**Technical Debt Incurred:**

None identified — security audit addressed existing debt.

---

_For current project status, see .planning/ROADMAP.md_
