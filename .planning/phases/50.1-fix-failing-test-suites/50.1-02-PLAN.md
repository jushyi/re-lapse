---
phase: 50.1-fix-failing-test-suites
plan: 02
type: execute
---

<objective>
Fix diverged test expectations in feedService, photoService, and integration test suites so all 76 previously failing tests pass.

Purpose: After Plan 01 fixed test infrastructure (cloud function isolation, Firestore mock exports, service mocks), the remaining failures are test expectations that don't match refactored source code. The source was updated in Phases 46-48 but the tests (written in Phase 49) weren't updated to match.
Output: All 10 previously failing test suites passing, `npm test` green (751/751).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50.1-fix-failing-test-suites/50.1-CONTEXT.md
@.planning/phases/50.1-fix-failing-test-suites/50.1-01-SUMMARY.md

# Key files:

@**tests**/services/feedService.test.js
@**tests**/services/photoService.test.js
@**tests**/services/friendshipService.test.js
@**tests**/integration/friendshipFlow.test.js
@**tests**/integration/photoLifecycle.test.js
@**tests**/setup/jest.setup.js

# Source files (ground truth for expected behavior):

@src/services/firebase/feedService.js
@src/services/firebase/photoService.js
@src/services/firebase/friendshipService.js
@src/services/firebase/darkroomService.js

**Constraining decisions:**

- Phase 50.1 CONTEXT: No new tests, no test refactoring, minimal diffs — strictly fix failures
- Only fix mock setup and test expectations, do NOT modify source code

**Established patterns:**

- Service functions return { success, error } objects
- Tests use Arrange/Act/Assert with jest.clearAllMocks() in beforeEach
- Mock functions are globals from jest.setup.js (mockGetDoc, mockGetDocs, etc.)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Fix feedService.test.js expectations</name>
  <files>__tests__/services/feedService.test.js</files>
  <action>
Run `npm test -- __tests__/services/feedService.test.js` first to see exactly which tests still fail after Plan 01 mock fixes.

The source `feedService.js` was refactored in Phases 46-48. Key behavioral changes that tests must match:

**getFeedPhotos:**

- Source now returns early with `{ success: true, photos: [] }` if `friendUserIds` is empty (line ~120-122) — does NOT include current user's own photos in feed
- Uses server-side `in` operator with `where('userId', 'in', chunk)` for friend filtering
- Sorts by `triagedAt` (not `capturedAt`)
- Calls `getBlockedByUserIds()` from blockService to filter blocked users (now mocked globally)
- Wrapped in `withTrace` from performanceService (now mocked globally as pass-through)
- Update test expectations: remove tests expecting own photos in feed, update sort field expectations, update mock chain expectations

**subscribeFeedPhotos:**

- Uses `limit(limitCount)` in query construction (now available via mock)
- The `should handle listener errors gracefully` test times out — likely the `onSnapshot` mock signature is wrong. The source calls `onSnapshot(q, successCallback, errorCallback)` with 3 args. The test needs to invoke `errorCallback` in the mock. Ensure `mockOnSnapshot.mockImplementation((query, successCb, errorCb) => { errorCb(new Error('test error')); return jest.fn(); })` pattern is used correctly. If the test sets up `mockOnSnapshot` but the query construction itself fails (because of prior mock issues), the `onSnapshot` is never called and the test times out waiting. With `limit` now available, the query construction should succeed and `onSnapshot` will be called.

**getTopPhotosByEngagement:**

- Source uses `getCountFromServer` (now mocked) and/or `getDocs` with `limit`
- Verify mock setup: `mockGetDocs` needs to return docs sorted by reactionCount
- The test may need updated mock data setup to match new query patterns

**getFriendStoriesData:**

- Source fetches friend user IDs, then queries photos per friend
- May use `getBlockedByUserIds` (now mocked)
- Update mock chain to return proper friend data

For each failing test: read the source function, understand what it actually does now, then update the test's mock setup and assertions to match. Do NOT change the source code. Do NOT add new tests. Minimal changes to make existing tests pass.
</action>
<verify>Run `npm test -- __tests__/services/feedService.test.js` — all 34 tests pass.</verify>
<done>feedService.test.js: 0 failures (was 17). All test expectations match current source behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Fix photoService.test.js expectations</name>
  <files>__tests__/services/photoService.test.js</files>
  <action>
Run `npm test -- __tests__/services/photoService.test.js` first to see exactly which tests still fail after Plan 01 mock fixes.

Key behavioral changes in source `photoService.js`:

**createPhoto:**

- Source calls `uploadPhoto(userId, photoId, photoUri)` with 3 args (line ~72)
- Test expects `uploadPhoto(photoId, photoUri)` with 2 args
- Fix: update the mock assertion to expect 3 args: `expect(mockUploadPhoto).toHaveBeenCalledWith(userId, expect.any(String), photoUri)`

**triagePhoto:**

- `delete` action now does **soft delete**: sets `photoState: 'deleted'` with `deletionScheduledAt` (30-day grace period), does NOT call `deletePhoto` from storage or `deleteDoc`
- `journal` action now reads the photo doc first (to get `capturedAt` for month calculation), then calls `updateDoc` with additional fields: `month`, `triagedAt`, `status: 'triaged'`, `photoState: 'journal'`
- `archive` action similar to journal — reads doc, writes month/triagedAt/status/photoState
- Fix: update mock setup for `delete` tests to expect `updateDoc` call (not `deleteDoc`/`deletePhoto`); update `journal`/`archive` tests to mock `getDoc` return value and expect additional fields in `updateDoc` call

**getDevelopingPhotoCount:**

- Source now uses `getCountFromServer` aggregation instead of `getDocs().size`
- Fix: update test to mock `getCountFromServer` return value instead of `getDocs`

**getDarkroomCounts:**

- May use `getCountFromServer` — check source and update mocks accordingly

**revealPhotos:**

- Uses `query` with `limit` (now available) and `writeBatch` (now mocked)
- Update mock chain expectations if needed

**batchTriagePhotos:**

- Wrapped in `withTrace` (now mocked as pass-through)
- May have updated internal behavior matching triagePhoto changes

For each failing test: read the source function, understand what it actually does now, update mock setup and assertions. Do NOT change source code. Minimal diffs.
</action>
<verify>Run `npm test -- __tests__/services/photoService.test.js` — all 29 tests pass.</verify>
<done>photoService.test.js: 0 failures (was 17). All test expectations match current source behavior.</done>
</task>

<task type="auto">
  <name>Task 3: Fix integration tests and final verification</name>
  <files>__tests__/integration/friendshipFlow.test.js, __tests__/integration/photoLifecycle.test.js</files>
  <action>
Run each integration test to see remaining failures after Plan 01 fixes:
- `npm test -- __tests__/integration/friendshipFlow.test.js`
- `npm test -- __tests__/integration/photoLifecycle.test.js`

**friendshipFlow.test.js (12 failures):**

- This test file has its own inline `jest.mock('@react-native-firebase/firestore', ...)` that may override the jest.setup.js mock. Check if the inline mock also needs `limit`, `startAfter`, `Timestamp`, `getCountFromServer` exports added.
- Tests calling `getFriendships`, `getSentRequests`, `getPendingRequests`, `getFeedPhotos` need proper mock chain
- `checkFriendshipStatus` tests may have mock consumption order issues — `mockGetDoc.mockResolvedValueOnce` calls being consumed by earlier operations. Fix by ensuring `jest.clearAllMocks()` in `beforeEach` and that each test sets up its own mocks independently.
- If test uses `getFeedPhotos`, apply same fixes as feedService (blockService, server-side filtering)

**photoLifecycle.test.js (17 failures):**

- This test file also likely has its own inline `jest.mock` for Firestore. Ensure it exports all needed named functions.
- Apply same fixes as photoService: triagePhoto soft-delete, createPhoto 3-arg signature, getDevelopingPhotoCount with getCountFromServer
- Darkroom integration: `Timestamp.now()` and `Timestamp.fromDate()` need to work in mock (now available from jest.setup.js). Check if inline mock overrides them.
- `ensureDarkroomInitialized`, `getDarkroom`, `isDarkroomReadyToReveal` — update mock data to match current source expectations

For both files: if they have inline `jest.mock` for Firestore, update those inline mocks to include all named exports (same as what was added to jest.setup.js in Plan 01 Task 2). If they import mock references from `__tests__/__mocks__/@react-native-firebase/firestore.js`, those should still work since that file exports mock references.

**Final verification after fixing both integration tests:**

1. Run `npm test` from project root — ALL 751 tests pass, 0 failures
2. Run `cd functions && npx jest` — all cloud function tests pass
3. If any tests still fail, debug and fix (still mock/expectation issues, not source bugs)
   </action>
   <verify>
   Run `npm test` from project root — 0 test suites failing, 0 tests failing, 751/751 pass.
   Run `cd functions && npx jest` — all cloud function tests pass.
   </verify>
   <done>

- friendshipFlow.test.js: 0 failures (was 12)
- photoLifecycle.test.js: 0 failures (was 17)
- `npm test` passes with 0 failures across all 28 suites
- Cloud function tests pass independently via `cd functions && npx jest`
- Phase 50.1 complete: all 76 previously failing tests now pass
  </done>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test` — 0 failing test suites, 0 failing tests (28 suites pass from root + cloud function suites pass sequentially)
- [ ] `npm run lint` — no new lint errors introduced
- [ ] No source code files modified — only test files and jest config
</verification>

<success_criteria>

- All 76 previously failing tests now pass
- All 28 app test suites pass (751/751 tests)
- All cloud function test suites pass (via sequential npm test)
- No source code modified — only test infrastructure and test expectations
- No tests skipped or disabled
- Phase 50.1 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/50.1-fix-failing-test-suites/50.1-02-SUMMARY.md`
</output>
