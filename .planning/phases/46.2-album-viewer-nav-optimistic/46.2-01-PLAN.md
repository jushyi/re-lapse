---
phase: 46.2-album-viewer-nav-optimistic
plan: 01
type: execute
---

<objective>
Fix album grid full-screen viewer so the bottom thumbnail nav bar updates optimistically during swipe gestures instead of waiting until momentum settles.

Purpose: The current "jump" behavior feels broken — the nav outline should track the user's swipe in real-time, making the thumbnail bar feel connected to the gesture.
Output: AlbumPhotoViewer with smooth, responsive thumbnail tracking during swipes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46.2-album-viewer-nav-optimistic/46.2-CONTEXT.md

# Key files:

@src/components/AlbumPhotoViewer.js

**Root cause:** `handleMomentumScrollEnd` (line 146) is the ONLY handler that updates `currentIndex` state. This event fires only after scroll momentum fully settles, so the thumbnail border "jumps" to the new position instead of tracking the swipe.

**Established patterns:**

- Component already uses react-native-reanimated for pan gestures (swipe-to-close)
- Component already uses horizontal FlatList with `pagingEnabled`
- `currentIndex` state drives both the thumbnail active border and the header counter text
- `goToIndex()` handles programmatic scrolls (edge taps, thumbnail taps) — sets `currentIndex` immediately AND calls `scrollToIndex`

**Constraining decisions:**

- Phase 46.1: OtherUserProfile uses card presentation (no impact on this fix)
- Phase 46-04: FlatList optimizations applied — keep `getItemLayout`, keep performance patterns
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Add optimistic scroll tracking to AlbumPhotoViewer</name>
  <files>src/components/AlbumPhotoViewer.js</files>
  <action>
Add an `onScroll` handler to the main photo FlatList that updates `currentIndex` during user-initiated swipes, so the thumbnail nav bar tracks the gesture in real-time.

**Changes:**

1. Add a `isUserDragging` ref (initialized to `false`) after the existing refs (~line 70):

   ```
   const isUserDragging = useRef(false);
   ```

2. Add `handleScrollBeginDrag` callback that sets `isUserDragging.current = true`.

3. Add `handleScroll` callback that:
   - Returns early if `!isUserDragging.current` (skip programmatic scrolls from goToIndex/edge taps)
   - Calculates `Math.round(offsetX / SCREEN_WIDTH)` from `event.nativeEvent.contentOffset.x`
   - Bounds-checks the index (>= 0 and < photos.length)
   - Calls `setCurrentIndex(newIndex)` only when index changed

4. Update `handleMomentumScrollEnd` to also reset `isUserDragging.current = false` — this fires after both user swipes and programmatic scrolls settle, so it's the correct place to reset the flag.

5. Add these props to the main photo FlatList (~line 467):
   - `onScroll={handleScroll}`
   - `onScrollBeginDrag={handleScrollBeginDrag}`
   - `scrollEventThrottle={16}`

**What to avoid and WHY:**

- Do NOT remove `onMomentumScrollEnd` — it serves as the final accuracy safety net and resets the dragging flag.
- Do NOT use Animated.event or useAnimatedScrollHandler here — overkill for a simple index calculation. The standard onScroll with scrollEventThrottle={16} is sufficient because setCurrentIndex only fires when the rounded index changes (at most once per swipe).
- Do NOT modify `goToIndex` — it correctly sets `currentIndex` immediately for programmatic scrolls (edge taps, thumbnail taps). The `isUserDragging` ref prevents `handleScroll` from interfering during these animated scrolls.
- Do NOT change the thumbnail FlatList or its rendering — the existing `renderThumbnail` and auto-scroll useEffect already react to `currentIndex` changes correctly.
  </action>
  <verify>
  Run the app, open any album grid, tap a photo to enter the full-screen viewer, then swipe left/right between photos. The thumbnail outline should move to the next photo as you swipe past the halfway point, BEFORE the scroll settles. Also verify:
- Edge tap navigation still works (tap left/right 25% zones)
- Thumbnail tap navigation still works
- Header counter ("X of Y") updates at the same time as the thumbnail
- Swipe-down-to-close still works
- No console warnings about state updates or scroll handlers
  </verify>
  <done>
  Thumbnail nav bar outline updates during swipe gesture (at halfway point), not after momentum settles. Edge taps and thumbnail taps still navigate correctly without visual glitches.
  </done>
  </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Optimistic thumbnail tracking in album full-screen viewer — the nav bar outline now follows swipe gestures in real-time instead of jumping after settling.</what-built>
  <how-to-verify>
    1. Run: `npx expo start` and open the app on device/simulator
    2. Navigate to your profile (or any user with albums)
    3. Open any album grid, tap a photo to enter the full-screen viewer
    4. Test swipe navigation:
       - Slowly swipe left — watch the thumbnail outline. It should move to the next thumbnail as you cross the halfway point, BEFORE releasing
       - Slowly swipe right — same behavior in reverse
       - Fast-swipe through several photos — outline should track each transition smoothly
    5. Test edge tap navigation:
       - Tap the right 25% of the screen — thumbnail should highlight the next photo immediately
       - Tap the left 25% — thumbnail should highlight the previous photo immediately
    6. Test thumbnail tap navigation:
       - Tap any thumbnail in the bottom bar — photo should scroll to it and outline should be correct
    7. Verify header counter ("Album Name - X of Y") updates at the same time as the thumbnail
    8. Test swipe-down-to-close still works normally
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Thumbnail outline tracks swipe gesture at halfway point (not after settling)
- [ ] Edge tap navigation works correctly
- [ ] Thumbnail tap navigation works correctly
- [ ] Header counter updates in sync with thumbnail
- [ ] Swipe-down-to-close gesture unaffected
- [ ] No console warnings or errors
- [ ] `npm run lint` passes
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Thumbnail nav bar responds to swipe gestures in real-time
- No regressions in existing navigation (edge taps, thumbnail taps, swipe-to-close)
- Phase 46.2 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/46.2-album-viewer-nav-optimistic/46.2-01-SUMMARY.md`
</output>
