---
phase: 22-environment-configuration
plan: 01
type: execute
---

<objective>
Complete environment configuration audit and establish prevention guardrails.

Purpose: Ensure secret hygiene with documented audit trail, create .env.example for developer onboarding, and add pre-commit hook to prevent future secret exposure.
Output: SECURITY_AUDIT.md documenting findings, .env.example template, husky pre-commit hook with secret detection.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-environment-configuration/22-CONTEXT.md

# Prior phase context (security remediation):

@.planning/phases/21.1-api-key-remediation/21.1-01-SUMMARY.md
@.planning/phases/21.2-eas-secure-google-services/21.2-01-SUMMARY.md

# Key configuration files:

@.gitignore
@app.json
@app.config.js
@eas.json
@firebase.json
@.firebaserc

**Tech stack available:** husky (already configured from Phase 19)
**Established patterns:** ESLint + Prettier + husky pre-commit hooks from Phase 19
**Constraining decisions:**

- Phase 21.1: GoogleService-Info.plist removed from git history, .gitignore updated
- Phase 21.2: EAS file environment variable configured for secure plist injection
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Security Audit and Documentation</name>
  <files>.planning/SECURITY_AUDIT.md</files>
  <action>
Create comprehensive security audit document that:

1. **Inventory all secrets/sensitive files:**
   - GoogleService-Info.plist (local only, EAS env var for builds)
   - .firebaserc (contains project ID - low sensitivity, OK to commit)
   - No .env files currently exist
   - EAS project ID in app.json (low sensitivity, OK to commit)

2. **Verify git history is clean:**
   - Run `git log -S "AIzaSy" --all` (Firebase API keys pattern)
   - Run `git log -S "AAAA" --all` (FCM tokens pattern)
   - Run `git log --all --name-only -- "*.plist" "*.env" "google-services.json"`
   - Document findings (expected: only 21.1-RESEARCH.md contains example patterns)

3. **Verify .gitignore coverage:**
   - Confirm GoogleService-Info.plist pattern is present
   - Confirm google-services.json pattern is present
   - Confirm .env pattern is present
   - Confirm _.key, _.p8, \*.p12 patterns are present

4. **Document secret locations:**
   - Local development: GoogleService-Info.plist (root directory)
   - EAS Builds: GOOGLE_SERVICES_PLIST env var (sensitive visibility)
   - Firebase: Project ID in .firebaserc (non-sensitive)

Structure as a markdown file with clear sections for: Inventory, History Audit, Gitignore Verification, and Secret Locations.
</action>
<verify>
cat .planning/SECURITY_AUDIT.md shows complete audit with all sections populated
</verify>
<done>
Security audit document exists with:

- Complete inventory of secrets/sensitive files
- Git history audit results (no leaks found)
- Gitignore pattern verification (all patterns present)
- Clear documentation of where secrets live
  </done>
  </task>

<task type="auto">
  <name>Task 2: Create .env.example Template</name>
  <files>.env.example</files>
  <action>
Create .env.example file documenting all environment variables used by the project:

```
# Lapse Clone Environment Configuration
# Copy this file to .env and fill in your values

# ============================================
# FIREBASE (React Native Firebase)
# ============================================
# Firebase configuration is handled via:
# - Local: GoogleService-Info.plist (iOS) / google-services.json (Android)
# - EAS Builds: GOOGLE_SERVICES_PLIST environment variable (set via EAS secrets)
#
# Do NOT put Firebase API keys in this file - they belong in the platform-specific
# config files which are .gitignored

# ============================================
# EAS BUILD (set via eas secret:create)
# ============================================
# GOOGLE_SERVICES_PLIST=<path set automatically by EAS>

# ============================================
# OPTIONAL: Cloud Functions Local Emulator
# ============================================
# Set to 'true' when running local Firebase emulator
# FUNCTIONS_EMULATOR=false
```

Note: This file is primarily documentation since:

- Firebase config uses native config files (not .env)
- EAS secrets are managed via `eas secret:create` not .env
- Only Cloud Functions emulator flag uses process.env currently
  </action>
  <verify>
  cat .env.example shows documented environment configuration with clear sections
  </verify>
  <done>
  .env.example template exists explaining all environment configuration, including why Firebase config is NOT in .env
  </done>
  </task>

<task type="auto">
  <name>Task 3: Add Secret Detection Pre-commit Hook</name>
  <files>.husky/pre-commit, .secretsignore</files>
  <action>
Enhance the existing husky pre-commit hook to detect accidentally staged secrets:

1. **Update .husky/pre-commit** to add secret detection after lint-staged:

   ```bash
   # Check for accidentally staged secrets
   STAGED_SECRETS=$(git diff --cached --name-only | grep -iE "(GoogleService-Info\.plist|google-services\.json|\.env$|\.env\.local|\.p8$|\.p12$|\.key$|\.mobileprovision$)" || true)

   if [ -n "$STAGED_SECRETS" ]; then
     echo ""
     echo "‚ùå ERROR: Potentially sensitive files are staged for commit:"
     echo "$STAGED_SECRETS"
     echo ""
     echo "These files should not be committed. Please unstage them:"
     echo "  git reset HEAD <file>"
     echo ""
     echo "If this is intentional (e.g., test fixtures), add to .secretsignore"
     exit 1
   fi
   ```

2. **Create .secretsignore** for intentional exceptions:
   ```
   # Files that match secret patterns but are OK to commit
   # (e.g., test fixtures, documentation examples)
   .planning/phases/21.1-api-key-remediation/21.1-RESEARCH.md
   ```

The hook runs AFTER lint-staged (which already passes), so failed secret detection gives a clear error without interfering with linting.
</action>
<verify>
cat .husky/pre-commit shows secret detection logic
cat .secretsignore shows exception file
Test by attempting to stage GoogleService-Info.plist: `git add GoogleService-Info.plist 2>&1` should succeed but commit would fail
</verify>
<done>
Pre-commit hook enhanced with secret detection, .secretsignore created for exceptions. Attempting to commit sensitive files triggers clear error message.
</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] .planning/SECURITY_AUDIT.md exists with all sections populated
- [ ] .env.example exists with clear documentation
- [ ] .husky/pre-commit includes secret detection
- [ ] .secretsignore exists for exceptions
- [ ] `git add GoogleService-Info.plist && git commit -m "test"` shows secret detection error (then reset)
- [ ] Existing lint-staged still works: `npx lint-staged` passes
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Security audit provides confidence in current secret hygiene
- Prevention guardrails block accidental secret commits
- Developer onboarding is clear via .env.example documentation
  </success_criteria>

<output>
After completion, create `.planning/phases/22-environment-configuration/22-01-SUMMARY.md`:

# Phase 22 Plan 01: Environment and Configuration Summary

**[Substantive one-liner - what shipped]**

## Performance

- **Duration:** X min
- **Tasks:** 3
- **Files modified:** 4

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]
- [Key outcome 3]

## Task Commits

1. **Task 1:** `chore(22-01): add security audit documentation`
2. **Task 2:** `chore(22-01): create .env.example template`
3. **Task 3:** `chore(22-01): add secret detection pre-commit hook`

**Plan metadata:** `docs(22-01): complete environment configuration plan`

## Files Created/Modified

- `.planning/SECURITY_AUDIT.md` - Comprehensive security audit
- `.env.example` - Environment configuration template
- `.husky/pre-commit` - Enhanced with secret detection
- `.secretsignore` - Exception file for false positives

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 22 complete, ready for Phase 23 (Firestore Security Rules Audit)
</output>
