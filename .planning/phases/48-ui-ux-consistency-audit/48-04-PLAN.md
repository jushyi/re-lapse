---
phase: 48-ui-ux-consistency-audit
plan: 04
type: execute
---

<objective>
Fix ISS-012: FriendsScreen N+1 query pattern causing slow initial load.

Purpose: FriendsScreen makes individual getDoc() calls for each friend/request to fetch user data. With many friends this creates N+1 Firestore reads causing 1-4 second load delay. Fix by batching user data fetching, optimizing subscription callbacks, and lazy-loading non-critical sections.
Output: FriendsScreen loads significantly faster with batched queries and optimized data flow.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ISSUES.md
@.planning/phases/48-ui-ux-consistency-audit/48-CONTEXT.md
@.planning/phases/48-ui-ux-consistency-audit/48-03-SUMMARY.md

# Files to modify:

@src/screens/FriendsScreen.js
@src/services/firebase/friendshipService.js

**ISS-012 details (from ISSUES.md):**

- FriendsScreen.js `fetchFriends()` and `fetchRequests()` make individual `getDoc()` calls for each friend/request to fetch user data
- With many friends, this creates N+1 Firestore reads causing 1-4 second initial load
- Real-time subscription also triggers full `loadData()` reload on any friendship change
- Affected lines: FriendsScreen.js (100-146, 148-209, 293-302)
- Suggested fix: Batch user data fetching, lazy-load suggestions/blocked users, optimize subscription callback

**Firestore batching pattern:**
Firestore supports `documentId()` in `where()` with `in` operator for up to 30 document IDs per query. For larger sets, chunk into groups of 30 and query in parallel.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Batch user data fetching in FriendsScreen</name>
  <files>src/screens/FriendsScreen.js, src/services/firebase/friendshipService.js</files>
  <action>
Replace the N+1 pattern in FriendsScreen.js where individual `getDoc()` calls fetch user data for each friend/request.

Implementation:

1. In friendshipService.js (or inline in FriendsScreen), create a `batchGetUsers(userIds)` helper that:
   - Chunks userIds into groups of up to 30 (Firestore `in` operator limit)
   - Queries `users` collection with `where(documentId(), 'in', chunk)` for each chunk
   - Runs all chunk queries in parallel with `Promise.all()`
   - Returns a Map of userId → userData for O(1) lookups

2. In FriendsScreen.js `fetchFriends()` (lines ~100-146):
   - First, get all friendship documents
   - Collect all friend userIds
   - Call `batchGetUsers(friendUserIds)` once
   - Map friendship docs to friend objects using the returned Map

3. In FriendsScreen.js `fetchRequests()` (lines ~148-209):
   - Same pattern: collect all requester userIds, batch fetch, map

This replaces N individual getDoc() calls with ceil(N/30) batched queries.

Do NOT change the data structure returned — maintain the same friend/request object shape so the UI code doesn't need changes.
</action>
<verify>Friends screen loads, friend list displays correctly, friend requests display correctly. Console shows batched queries instead of individual getDoc calls.</verify>
<done>fetchFriends() and fetchRequests() use batched queries — N individual getDoc() calls replaced with ceil(N/30) batched where-in queries</done>
</task>

<task type="auto">
  <name>Task 2: Optimize subscription callback and lazy-load non-critical sections</name>
  <files>src/screens/FriendsScreen.js</files>
  <action>
Optimize the real-time subscription and lazy-load secondary data:

1. Subscription optimization (lines ~293-302):
   - Currently the onSnapshot callback triggers full `loadData()` reload on ANY friendship change
   - Instead, make the callback smarter: parse the document changes from the snapshot and update only the affected items in state
   - Use `snapshot.docChanges()` to get added/modified/removed docs
   - For 'added': add to state list
   - For 'modified': update in state list
   - For 'removed': remove from state list
   - This avoids re-fetching ALL friends when one friendship changes

2. Lazy-load suggestions and blocked users:
   - Currently `loadData()` fetches friends, requests, suggestions, AND blocked users all at once on mount
   - Defer suggestions and blocked users loading: fetch them only when the user navigates to those tabs/sections (if tabbed) or after the main friend list has rendered (using a short delay or InteractionManager.runAfterInteractions)
   - This prioritizes the critical path (friend list) for faster perceived load

Do NOT change the visual layout or user-facing behavior. The friend list, requests, suggestions, and blocked users should all still work — just load more efficiently.
</action>
<verify>Friends screen loads noticeably faster. Adding/removing a friend updates the list without full reload. Suggestions and blocked users still load correctly (just slightly deferred).</verify>
<done>Subscription uses docChanges() for incremental updates instead of full reload. Suggestions and blocked users are lazy-loaded after critical friend list renders.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed ISS-012 N+1 query pattern in FriendsScreen. Batched user fetching, optimized subscription to incremental updates, and lazy-loaded non-critical sections.</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. Navigate to Friends screen
    3. Check: Friend list loads noticeably faster (should be under 1 second for reasonable friend counts)
    4. Check: Friend requests display correctly
    5. Check: Suggestions section still loads (may appear slightly after main list)
    6. Check: Blocked users section still accessible
    7. Test: Accept/decline a friend request — list should update without full reload
    8. Test: Navigate away and back — list loads quickly from cache/state
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues with friends screen behavior</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx expo lint` passes without errors
- [ ] Friends screen loads significantly faster
- [ ] Friend list, requests, suggestions, blocked users all display correctly
- [ ] Real-time updates work (add/remove friend reflected without full reload)
- [ ] No regressions in friend-related functionality
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- ISS-012 resolved — N+1 query pattern replaced with batched fetching
- Friends screen initial load under 1 second for typical friend counts
- Subscription updates are incremental, not full-reload
  </success_criteria>

<output>
After completion, create `.planning/phases/48-ui-ux-consistency-audit/48-04-SUMMARY.md`

Also update `.planning/ISSUES.md` to close ISS-012.
</output>
