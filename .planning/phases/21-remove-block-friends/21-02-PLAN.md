---
phase: 21-remove-block-friends
plan: 02
type: execute
---

<objective>
Add three-dot menus to FriendCard and OtherUserProfile header with Remove, Block, Report options.

Purpose: Provide unified menu access for friend management actions in both list and profile contexts.
Output: Three-dot menus working in both locations with confirmation dialogs.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-remove-block-friends/21-CONTEXT.md
@.planning/phases/21-remove-block-friends/21-01-SUMMARY.md

# Existing components:

@src/components/FriendCard.js
@src/styles/FriendCard.styles.js
@src/components/DropdownMenu.js
@src/screens/ProfileScreen.js
@src/styles/ProfileScreen.styles.js

# Services:

@src/services/firebase/friendshipService.js (removeFriend already exists)
@src/services/firebase/blockService.js (created in 21-01)

# Key decisions:

# - Three-dot menu (ellipsis-vertical icon) consistent with app patterns

# - Options: Remove Friend, Block User, Report User

# - Remove and Block show simple confirmation dialogs

# - Report navigates to ReportUserScreen (created in 21-03)

# - Block and remove are independent actions

</context>

<tasks>

<task type="auto">
  <name>Task 1: Add three-dot menu to FriendCard</name>
  <files>src/components/FriendCard.js, src/styles/FriendCard.styles.js</files>
  <action>
Modify FriendCard to show three-dot menu button for friends (relationshipStatus === 'friends').

**Changes to FriendCard.js:**

1. Add new props:
   - `onRemove`: callback(userId) when Remove Friend confirmed
   - `onBlock`: callback(userId) when Block User confirmed
   - `onReport`: callback(userId) to navigate to report screen

2. Add state for menu visibility:

   ```javascript
   const [menuVisible, setMenuVisible] = useState(false);
   const [menuAnchor, setMenuAnchor] = useState(null);
   ```

3. In `renderActions()` case 'friends', instead of returning null, return a three-dot button:

   ```javascript
   case 'friends':
     return (
       <TouchableOpacity
         style={styles.menuButton}
         onPress={handleMenuPress}
         activeOpacity={0.7}
       >
         <Ionicons name="ellipsis-vertical" size={20} color={colors.text.secondary} />
       </TouchableOpacity>
     );
   ```

4. Add `handleMenuPress` function that captures button position and shows menu:

   ```javascript
   const menuButtonRef = useRef(null);

   const handleMenuPress = () => {
     menuButtonRef.current?.measureInWindow((x, y, width, height) => {
       setMenuAnchor({ x, y, width, height });
       setMenuVisible(true);
     });
   };
   ```

5. Add confirmation handlers:
   - `handleRemoveFriend`: Alert.alert confirmation, then call `onRemove(userId)`
   - `handleBlockUser`: Alert.alert confirmation, then call `onBlock(userId)`
   - `handleReportUser`: directly call `onReport(userId)` (no confirmation needed)

6. Add DropdownMenu component at end of render:
   ```javascript
   <DropdownMenu
     visible={menuVisible}
     onClose={() => setMenuVisible(false)}
     anchorPosition={menuAnchor}
     options={[
       { label: 'Remove Friend', icon: 'person-remove-outline', onPress: handleRemoveFriend },
       { label: 'Block User', icon: 'ban-outline', onPress: handleBlockUser },
       { label: 'Report User', icon: 'flag-outline', onPress: handleReportUser, destructive: true },
     ]}
   />
   ```

**Changes to FriendCard.styles.js:**

Add `menuButton` style:

```javascript
menuButton: {
  padding: 8,
  marginLeft: 8,
},
```

Import DropdownMenu, useState, useRef, Alert from appropriate sources.
</action>
<verify>FriendCard renders three-dot menu for friends. Menu appears when tapped with 3 options.</verify>
<done>FriendCard shows three-dot menu button for friends with Remove, Block, Report options in DropdownMenu.</done>
</task>

<task type="auto">
  <name>Task 2: Add three-dot menu to OtherUserProfile header</name>
  <files>src/screens/ProfileScreen.js, src/styles/ProfileScreen.styles.js</files>
  <action>
Modify ProfileScreen to show three-dot menu in header when viewing another user's profile.

**Changes to ProfileScreen.js:**

1. Add state for menu:

   ```javascript
   const [profileMenuVisible, setProfileMenuVisible] = useState(false);
   const [profileMenuAnchor, setProfileMenuAnchor] = useState(null);
   const profileMenuButtonRef = useRef(null);
   ```

2. Import blockUser from blockService, Alert if not already imported.

3. Add `handleProfileMenuPress` function to capture position and show menu.

4. Add confirmation handlers:
   - `handleRemoveFriend`: Alert confirmation, call removeFriend(user.uid, userId), update friendshipStatus to 'none'
   - `handleBlockUser`: Alert confirmation, call blockUser(user.uid, userId), navigate back (blocked user disappears from view)
   - `handleReportUser`: navigate to ReportUserScreen with { userId, username, displayName, profilePhotoURL }

5. Change the header right section. Replace the empty `<View style={styles.headerButton} />` for other users with:

   ```javascript
   {
     isOwnProfile ? (
       <TouchableOpacity onPress={handleSettingsPress} style={styles.headerButton}>
         <Ionicons name="settings-outline" size={24} color={colors.text.primary} />
       </TouchableOpacity>
     ) : (
       <TouchableOpacity
         ref={profileMenuButtonRef}
         onPress={handleProfileMenuPress}
         style={styles.headerButton}
       >
         <Ionicons name="ellipsis-vertical" size={24} color={colors.text.primary} />
       </TouchableOpacity>
     );
   }
   ```

6. Add DropdownMenu at end of component (before closing View):

   ```javascript
   <DropdownMenu
     visible={profileMenuVisible}
     onClose={() => setProfileMenuVisible(false)}
     anchorPosition={profileMenuAnchor}
     options={getProfileMenuOptions()}
   />
   ```

7. Create `getProfileMenuOptions()` function that returns different options based on friendship status:
   - If friends: [Remove Friend, Block User, Report User]
   - If not friends: [Block User, Report User] (no remove option)

   Later (Plan 04) will add "Unblock" option if user has blocked this profile.
   </action>
   <verify>OtherUserProfile shows three-dot menu in header. Menu options vary based on friendship status.</verify>
   <done>ProfileScreen shows three-dot menu for other user profiles with appropriate options based on friendship status.</done>
   </task>

<task type="auto">
  <name>Task 3: Wire up menu actions in FriendsScreen</name>
  <files>src/screens/FriendsScreen.js</files>
  <action>
Connect FriendCard menu callbacks to actual service calls in FriendsScreen.

**Changes to FriendsScreen.js:**

1. Import blockUser from blockService, removeFriend from friendshipService (if not already).

2. Add action handlers:

```javascript
const handleRemoveFriend = async userId => {
  try {
    const result = await removeFriend(user.uid, userId);
    if (result.success) {
      // Refresh friends list by removing from state
      setFriends(prev =>
        prev.filter(f => {
          const friendId = f.user1Id === user.uid ? f.user2Id : f.user1Id;
          return friendId !== userId;
        })
      );
      logger.info('FriendsScreen: Friend removed', { userId });
    } else {
      Alert.alert('Error', result.error || 'Could not remove friend');
    }
  } catch (error) {
    logger.error('FriendsScreen: Error removing friend', { error: error.message });
    Alert.alert('Error', 'Could not remove friend');
  }
};

const handleBlockUser = async userId => {
  try {
    const result = await blockUser(user.uid, userId);
    if (result.success) {
      // Remove from all lists (friends, requests, suggestions)
      setFriends(prev =>
        prev.filter(f => {
          const friendId = f.user1Id === user.uid ? f.user2Id : f.user1Id;
          return friendId !== userId;
        })
      );
      setSuggestions(prev => prev.filter(s => s.userId !== userId));
      logger.info('FriendsScreen: User blocked', { userId });
    } else {
      Alert.alert('Error', result.error || 'Could not block user');
    }
  } catch (error) {
    logger.error('FriendsScreen: Error blocking user', { error: error.message });
    Alert.alert('Error', 'Could not block user');
  }
};

const handleReportUser = userId => {
  // Find user data for the report screen
  const userData = friends.find(f => {
    const friendId = f.user1Id === user.uid ? f.user2Id : f.user1Id;
    return friendId === userId;
  });

  navigation.navigate('ReportUser', {
    userId,
    username: userData?.otherUser?.username,
    displayName: userData?.otherUser?.displayName,
    profilePhotoURL: userData?.otherUser?.profilePhotoURL,
  });
};
```

3. Pass callbacks to FriendCard:

```javascript
<FriendCard
  user={friendData.otherUser}
  relationshipStatus="friends"
  onPress={() => handleFriendPress(friendData)}
  showFriendsSince={true}
  friendsSince={friendData.acceptedAt}
  onRemove={handleRemoveFriend}
  onBlock={handleBlockUser}
  onReport={handleReportUser}
/>
```

Note: The long-press to remove pattern can remain as a secondary option, but the menu is now the primary method.
</action>
<verify>Tapping menu options in Friends tab triggers appropriate actions. Remove updates list, Block updates list, Report navigates (screen created in 21-03).</verify>
<done>FriendsScreen passes all three callbacks to FriendCard. Remove and Block update local state. Report navigates to ReportUserScreen.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] FriendCard shows three-dot menu for friends relationship
- [ ] DropdownMenu appears with Remove, Block, Report options
- [ ] ProfileScreen header shows three-dot menu for other users
- [ ] Menu options vary based on friendship status
- [ ] FriendsScreen handlers properly call services
- [ ] Remove Friend removes from list (optimistic update)
- [ ] Block User removes from list (optimistic update)
- [ ] Report User navigation ready (screen placeholder for now)
- [ ] `npx eslint src/components/FriendCard.js src/screens/ProfileScreen.js src/screens/FriendsScreen.js` passes
</verification>

<success_criteria>

- Three-dot menus functional in both FriendCard and ProfileScreen
- Confirmation dialogs for Remove and Block
- Service calls working with proper error handling
- UI updates optimistically on success
  </success_criteria>

<output>
After completion, create `.planning/phases/21-remove-block-friends/21-02-SUMMARY.md`
</output>
