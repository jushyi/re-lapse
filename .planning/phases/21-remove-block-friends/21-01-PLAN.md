---
phase: 21-remove-block-friends
plan: 01
type: execute
---

<objective>
Create data layer for blocking users and reporting users.

Purpose: Establish Firestore collections and service functions for block/report features before building UI.
Output: blockService.js and reportService.js with full CRUD operations.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-remove-block-friends/21-CONTEXT.md

# Existing patterns:

@src/services/firebase/friendshipService.js
@src/services/firebase/commentService.js
@src/services/firebase/feedService.js

# Key decisions from context:

# - Block and remove are independent (can block a friend, unblocking restores friendship)

# - Block makes YOU invisible to blocked user (not vice versa)

# - When blocking: remove blocked user's comments/reactions from blocker's photos

# - Reports stored with profile snapshot for evidence

</context>

<tasks>

<task type="auto">
  <name>Task 1: Create blockService.js</name>
  <files>src/services/firebase/blockService.js, src/services/firebase/index.js</files>
  <action>
Create blockService.js following existing service patterns (async functions, success/error returns, logger usage).

**Block data model:** Collection `blocks` with document ID `{blockerId}_{blockedId}`:

```
{
  blockerId: string,      // User who blocked
  blockedId: string,      // User who is blocked
  createdAt: serverTimestamp()
}
```

**Functions to implement:**

1. `blockUser(blockerId, blockedId)`:
   - Create block document with deterministic ID
   - After creating block, cascade delete blocked user's comments and reactions from blocker's photos:
     - Query `photos` where `userId === blockerId`
     - For each photo, query comments subcollection where `userId === blockedId` and delete them
     - For each photo, remove blocked user's reactions from `reactions[blockedId]` field
   - Return `{ success: true }` or `{ success: false, error }`

2. `unblockUser(blockerId, blockedId)`:
   - Delete block document
   - Return `{ success: true }` or `{ success: false, error }`

3. `isBlocked(blockerId, blockedId)`:
   - Check if specific block document exists
   - Return `{ success: true, isBlocked: boolean }`

4. `getBlockedByUserIds(userId)`:
   - Query blocks where `blockedId === userId` (users who blocked this user)
   - Return `{ success: true, blockedByUserIds: string[] }` - list of users who have blocked this user
   - Used to filter content from people who blocked current user

5. `getBlockedUserIds(userId)`:
   - Query blocks where `blockerId === userId` (users this user has blocked)
   - Return `{ success: true, blockedUserIds: string[] }`
   - Used to show "Unblock" option on profiles user has blocked

Export all functions. Add to src/services/firebase/index.js exports.
</action>
<verify>File exists with all 5 functions exported. No syntax errors: `npx eslint src/services/firebase/blockService.js`</verify>
<done>blockService.js created with blockUser, unblockUser, isBlocked, getBlockedByUserIds, getBlockedUserIds. Exported in index.js.</done>
</task>

<task type="auto">
  <name>Task 2: Create reportService.js</name>
  <files>src/services/firebase/reportService.js, src/services/firebase/index.js</files>
  <action>
Create reportService.js for user reports (reviewed manually in Firebase Console).

**Report data model:** Collection `reports` with auto-generated document IDs:

```
{
  reporterId: string,           // User who filed the report
  reportedUserId: string,       // User being reported
  reason: string,               // 'spam' | 'harassment' | 'inappropriate' | 'impersonation' | 'other'
  details: string | null,       // Optional additional details
  profileSnapshot: {            // Snapshot of reported user's profile at time of report
    displayName: string | null,
    username: string | null,
    bio: string | null,
    profilePhotoURL: string | null
  },
  status: 'pending',            // For future admin review (always 'pending' on creation)
  createdAt: serverTimestamp()
}
```

**Functions to implement:**

1. `submitReport(reporterId, reportedUserId, reason, details, profileSnapshot)`:
   - Validate reason is one of: 'spam', 'harassment', 'inappropriate', 'impersonation', 'other'
   - Create report document with addDoc (auto-generated ID)
   - Return `{ success: true, reportId }` or `{ success: false, error }`

2. `REPORT_REASONS` constant array exported for UI:
   - `['spam', 'harassment', 'inappropriate', 'impersonation', 'other']`

Export functions. Add to src/services/firebase/index.js exports.
</action>
<verify>File exists with submitReport function and REPORT_REASONS constant. No syntax errors: `npx eslint src/services/firebase/reportService.js`</verify>
<done>reportService.js created with submitReport function and REPORT_REASONS constant. Exported in index.js.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] blockService.js exists with all 5 functions
- [ ] reportService.js exists with submitReport and REPORT_REASONS
- [ ] Both services exported in src/services/firebase/index.js
- [ ] `npx eslint src/services/firebase/blockService.js src/services/firebase/reportService.js` passes
</verification>

<success_criteria>

- All service functions implemented following existing patterns
- Proper error handling with try/catch and logger
- Services exported and importable
- No lint errors
  </success_criteria>

<output>
After completion, create `.planning/phases/21-remove-block-friends/21-01-SUMMARY.md`
</output>
