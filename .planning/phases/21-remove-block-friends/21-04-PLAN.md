---
phase: 21-remove-block-friends
plan: 04
type: execute
---

<objective>
Enforce blocking across feed, stories, search, and profile viewing.

Purpose: Make blocked users invisible to the person who blocked them, and vice versa for profile access.
Output: Users who blocked you can't see your content; you can view and unblock profiles you've blocked.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-remove-block-friends/21-CONTEXT.md
@.planning/phases/21-remove-block-friends/21-01-SUMMARY.md
@.planning/phases/21-remove-block-friends/21-02-SUMMARY.md
@.planning/phases/21-remove-block-friends/21-03-SUMMARY.md

# Services to modify:

@src/services/firebase/feedService.js
@src/services/firebase/blockService.js

# Screens to modify:

@src/screens/ProfileScreen.js
@src/screens/FriendsScreen.js

# Key behavior from context:

# - Block makes YOU invisible to the blocked user (they can't see your profile/content)

# - When YOU view a blocked person's profile, you see it normally with "Unblock" option

# - Search should hide users who have blocked the searcher

# - Content from mutual friends showing blocked person still visible (block only affects direct interaction)

</context>

<tasks>

<task type="auto">
  <name>Task 1: Filter blocked users from feed and stories</name>
  <files>src/services/firebase/feedService.js, src/hooks/useFeedPhotos.js</files>
  <action>
Modify feed service to exclude photos from users who have blocked the current user.

**Understanding block direction:**

- If User A blocks User B: B cannot see A's content
- So when fetching content for user B, we need to exclude content from anyone who has blocked B
- We use `getBlockedByUserIds(userId)` to get list of users who blocked us

**Changes to feedService.js:**

1. Import getBlockedByUserIds from blockService:

   ```javascript
   import { getBlockedByUserIds } from './blockService';
   ```

2. Modify `getFeedPhotos` function:
   - After getting friendUserIds, also get blockedByUserIds
   - Filter friendUserIds to exclude anyone who blocked current user
   - This prevents seeing content from friends who later blocked you

   ```javascript
   // Get users who have blocked the current user
   const blockedByResult = await getBlockedByUserIds(userId);
   const blockedByUserIds = blockedByResult.success ? blockedByResult.blockedByUserIds : [];

   // Filter out blocked users from friends list
   const visibleFriendIds = friendUserIds.filter(fid => !blockedByUserIds.includes(fid));
   ```

3. Modify `getFriendStoriesData` similarly:
   - Fetch blockedByUserIds
   - Filter friend stories to exclude users who blocked current user

4. Modify `getUserStoriesData` - no changes needed (own stories always visible)

**Changes to useFeedPhotos.js (if exists as separate hook):**

- If this hook caches friend IDs, ensure it respects blocked users
- May need to accept blockedByUserIds as parameter or fetch internally

Note: The filtering happens client-side after fetching friend IDs, which is acceptable since:

- Block list is typically small
- We already do client-side filtering for friend photos
- Firestore doesn't support "NOT IN" queries efficiently
  </action>
  <verify>Photos from users who blocked current user don't appear in feed or stories.</verify>
  <done>feedService excludes content from users who have blocked the current user.</done>
  </task>

<task type="auto">
  <name>Task 2: Handle blocked status in profile viewing and search</name>
  <files>src/screens/ProfileScreen.js, src/screens/FriendsScreen.js</files>
  <action>
Update profile viewing and user search to handle block relationships.

**Changes to ProfileScreen.js:**

1. Import isBlocked, getBlockedUserIds from blockService.

2. Add state for block status:

   ```javascript
   const [isBlockedByMe, setIsBlockedByMe] = useState(false);
   const [hasBlockedMe, setHasBlockedMe] = useState(false);
   ```

3. In fetchOtherUserProfile or as separate effect, check block status:

   ```javascript
   // Check if I blocked this user
   const blockedByMeResult = await isBlocked(user.uid, userId);
   setIsBlockedByMe(blockedByMeResult.success && blockedByMeResult.isBlocked);

   // Check if this user blocked me
   const blockedMeResult = await isBlocked(userId, user.uid);
   setHasBlockedMe(blockedMeResult.success && blockedMeResult.isBlocked);
   ```

4. If `hasBlockedMe` is true, show "User not found" error state:

   ```javascript
   if (!isOwnProfile && hasBlockedMe) {
     return (
       <View style={styles.container}>
         <View style={[styles.header, { paddingTop: insets.top }]}>
           <TouchableOpacity onPress={handleBackPress} style={styles.headerButton}>
             <Ionicons name="chevron-back" size={28} color={colors.text.primary} />
           </TouchableOpacity>
           <Text style={styles.headerTitle}>Profile</Text>
           <View style={styles.headerButton} />
         </View>
         <View style={styles.errorContainer}>
           <Text style={styles.errorText}>User not found</Text>
         </View>
       </View>
     );
   }
   ```

5. Update `getProfileMenuOptions()` to include Unblock option when `isBlockedByMe`:

   ```javascript
   const getProfileMenuOptions = () => {
     const options = [];

     if (isBlockedByMe) {
       options.push({
         label: 'Unblock User',
         icon: 'checkmark-circle-outline',
         onPress: handleUnblockUser,
       });
     }

     if (friendshipStatus === 'friends' && !isBlockedByMe) {
       options.push({
         label: 'Remove Friend',
         icon: 'person-remove-outline',
         onPress: handleRemoveFriend,
       });
     }

     if (!isBlockedByMe) {
       options.push({
         label: 'Block User',
         icon: 'ban-outline',
         onPress: handleBlockUser,
       });
     }

     options.push({
       label: 'Report User',
       icon: 'flag-outline',
       onPress: handleReportUser,
       destructive: true,
     });

     return options;
   };
   ```

6. Add `handleUnblockUser` function:
   ```javascript
   const handleUnblockUser = async () => {
     Alert.alert('Unblock User', `Unblock ${otherUserProfile?.displayName || routeUsername}?`, [
       { text: 'Cancel', style: 'cancel' },
       {
         text: 'Unblock',
         onPress: async () => {
           try {
             const result = await unblockUser(user.uid, userId);
             if (result.success) {
               setIsBlockedByMe(false);
               // Re-fetch friendship status (may have been friends before block)
               fetchFriendshipStatus();
               logger.info('ProfileScreen: User unblocked', { userId });
             } else {
               Alert.alert('Error', result.error || 'Could not unblock user');
             }
           } catch (error) {
             logger.error('ProfileScreen: Error unblocking user', { error: error.message });
             Alert.alert('Error', 'Could not unblock user');
           }
         },
       },
     ]);
   };
   ```

**Changes to FriendsScreen.js:**

1. In user search (Requests tab), filter out users who have blocked current user:

   ```javascript
   // In search results processing, after fetching users:
   const blockedByResult = await getBlockedByUserIds(user.uid);
   const blockedByUserIds = blockedByResult.success ? blockedByResult.blockedByUserIds : [];

   // Filter search results
   const visibleResults = searchResults.filter(u => !blockedByUserIds.includes(u.userId));
   ```

2. This ensures users can't find or send requests to people who have blocked them.

Note: We don't filter out users YOU have blocked from search - you should be able to search for them to access their profile and unblock.
</action>
<verify>Blocked users see "User not found" when viewing blocker's profile. Unblock option appears on profiles user has blocked. Search excludes users who blocked current user.</verify>
<done>Block enforcement working: blocked users can't see blocker's profile, unblock available for profiles user blocked, search respects blocks.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Feed excludes photos from users who blocked current user
- [ ] Stories bar excludes users who blocked current user
- [ ] Profile shows "User not found" if profile owner blocked current user
- [ ] Profile shows "Unblock" option if current user blocked profile owner
- [ ] User search excludes users who blocked current user
- [ ] Unblocking restores ability to see profile
- [ ] `npx eslint src/services/firebase/feedService.js src/screens/ProfileScreen.js src/screens/FriendsScreen.js` passes
</verification>

<success_criteria>

- Complete invisibility for blocked relationships
- Graceful "User not found" handling
- Unblock path available through profile viewing
- No leaked content from blocked users in feed/stories
  </success_criteria>

<output>
After completion, create `.planning/phases/21-remove-block-friends/21-04-SUMMARY.md`

When all 4 plans complete, Phase 21 is done. Update ROADMAP.md and STATE.md.
</output>
