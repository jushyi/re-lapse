---
phase: 47.1-comment-at-tagging
plan: 47.1-02-FIX
type: fix
---

<objective>
Fix 3 UAT issues from plan 47.1-02.

Source: 47.1-02-ISSUES.md
Priority: 0 blocker, 1 major, 2 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/47.1-comment-at-tagging/47.1-02-ISSUES.md

**Original plan for reference:**
@.planning/phases/47.1-comment-at-tagging/47.1-02-PLAN.md

**Key source files:**
@src/components/comments/CommentInput.js
@src/hooks/useMentionSuggestions.js
@src/components/comments/CommentsBottomSheet.js
@src/screens/PhotoDetailScreen.js
@src/context/PhotoDetailContext.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-001 + UAT-003 — Stale cursor position in CommentInput.handleChangeText</name>
  <files>src/components/comments/CommentInput.js</files>
  <action>
**Root cause:** In React Native, `onChangeText` fires BEFORE `onSelectionChange`. So when the user types `@`, `handleChangeText` passes `cursorPositionRef.current` which is still the OLD cursor position (before the character was typed). This causes `findActiveMention` to search the wrong text slice, missing the `@` entirely.

This same off-by-one also causes UAT-003: when `selectSuggestion` uses the stale cursor position, `fullText.slice(cursorPosition)` includes the trigger character in `textAfter`, so it leaks into the final text.

**Fix:** In `handleChangeText`, compute an adjusted cursor position that accounts for the text length change. Add a ref to track previous text length:

1. Add a `prevTextLengthRef` ref initialized to `0`:

   ```
   const prevTextLengthRef = useRef(0);
   ```

2. Modify `handleChangeText` to compute adjusted cursor position:

   ```
   const handleChangeText = useCallback(
     newText => {
       const lengthDiff = newText.length - prevTextLengthRef.current;
       prevTextLengthRef.current = newText.length;
       setText(newText);
       // Adjust cursor: onChangeText fires before onSelectionChange,
       // so cursorPositionRef is stale. Advance by the length difference.
       const adjustedCursor = cursorPositionRef.current + Math.max(0, lengthDiff);
       onTextChangeForMentions?.(newText, adjustedCursor);
     },
     [onTextChangeForMentions]
   );
   ```

3. Also update `prevTextLengthRef` when `setText` is called via ref (the `useImperativeHandle` `setText` method) so it stays in sync:

   ```
   setText: newText => {
     logger.debug('CommentInput: setText called via ref', { textLength: newText?.length });
     prevTextLengthRef.current = newText?.length || 0;
     setText(newText);
   },
   ```

4. Update `prevTextLengthRef` in the `initialMention` useEffect too:
   ```
   useEffect(() => {
     if (initialMention) {
       const mentionText = `@${initialMention} `;
       prevTextLengthRef.current = mentionText.length;
       setText(mentionText);
     }
   }, [initialMention]);
   ```

**Why this works:**

- When user types `@` (oldLen=5, newLen=6): adjustedCursor = oldCursor + 1 = correct position after `@`
- `findActiveMention("hello @", 7)` now finds the `@` at index 6
- When selecting a suggestion, `selectSuggestion` uses the correct cursor position, so `textAfter` doesn't include the trigger character
  </action>
  <verify>
  `npx eslint src/components/comments/CommentInput.js` passes with no errors.
  </verify>
  <done>
  Typing `@` immediately triggers suggestion overlay (UAT-001 fixed). Selecting a suggestion in replies doesn't leak the trigger character (UAT-003 fixed).
  </done>
  </task>

<task type="auto">
  <name>Task 2: Fix UAT-002 — @mention profile navigation renders behind PhotoDetailScreen</name>
  <files>src/components/comments/CommentsBottomSheet.js, functions/index.js</files>
  <action>
**Context:** Avatar taps on profile pics in comments correctly navigate to the user's profile while keeping the full-screen photo and comments sheet open. The @mention taps should mirror this exact behavior — photo+comments stay open, profile appears on top.

**Both code paths converge to the same `onAvatarPress` callback:**

- Avatar tap: CommentRow → `onAvatarPress(comment.userId, user?.displayName)` → PhotoDetailScreen's `handleCommentAvatarPress` → `contextAvatarPress`
- @mention tap: MentionText → `handleMentionPress` → `handleMentionProfilePress(username)` → username lookup → `onAvatarPress(userId, displayName)` → same path

**Investigation steps (during execution):**

1. **Verify the Cloud Function return format:** Read `getMutualFriendsForComments` in `functions/index.js`. Check if the mutual friend objects use `userId` (matching comment data format) or a different field name like `uid` or `id`. If the field name is wrong, `friend.userId` would be `undefined`, causing `onAvatarPress(undefined, displayName)` — which navigates to OtherUserProfile with no userId, potentially rendering a broken/empty profile.

2. **Verify `handleMentionProfilePress` lookup:** Add a `logger.info` call RIGHT BEFORE `onAvatarPress` is called in `handleMentionProfilePress` to log the exact `userId` and `displayName` being passed. Compare with what avatar taps pass.

3. **Apply fix based on findings:**
   - **If field name mismatch in CF data:** Fix `handleMentionProfilePress` to use the correct field name (e.g., `friend.uid` instead of `friend.userId`), OR fix the CF to return `userId` consistently.

   - **If userId is correct but navigation still fails:** The issue is in how `contextAvatarPress` behaves when called from within CommentsBottomSheet's callback chain vs directly from CommentRow. In this case, simplify by having `handleMentionProfilePress` call `onAvatarPress` in a `requestAnimationFrame` to ensure it runs outside the current React event handler batch.

   - **If userId is undefined (user not found):** The username lookup in `handleMentionProfilePress` is failing. This can happen if the @mentioned user hasn't commented (not in `threadedComments`) AND isn't in the mutual friends list. Fix by ensuring the CF data always has the correct fields and the lookup is robust.

**CRITICAL: Do NOT dismiss PhotoDetailScreen or CommentsBottomSheet.** The fix must mirror avatar tap behavior — profile appears on top while photo+comments remain open underneath.
</action>
<verify>
`npx eslint src/components/comments/CommentsBottomSheet.js` passes with no errors.
Test: Tap @mention in posted comment → profile screen appears on top → press back → return to photo with comments still visible (same as avatar taps).
</verify>
<done>
Tapping an @mention in a comment navigates to the mentioned user's profile screen the same way avatar taps do — profile visible on top, photo+comments stay open underneath. UAT-002 fixed.
</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 3 UAT issues addressed (UAT-001, UAT-002, UAT-003)
- [ ] `npx eslint src/components/comments/CommentInput.js src/screens/PhotoDetailScreen.js src/hooks/useMentionSuggestions.js src/components/comments/CommentsBottomSheet.js` passes
- [ ] No new ESLint errors or warnings introduced
</verification>

<success_criteria>

- UAT-001: Typing `@` immediately shows suggestion overlay (no extra character needed)
- UAT-002: Tapping @mention navigates to profile correctly (visible, not behind modal)
- UAT-003: Selecting autocomplete suggestion in replies doesn't leak trigger character
- All ESLint checks pass
- Ready for re-verification
  </success_criteria>

<output>
After completion, create `.planning/phases/47.1-comment-at-tagging/47.1-02-FIX-SUMMARY.md`
</output>
