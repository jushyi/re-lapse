---
phase: 47.1-comment-at-tagging
plan: 47.1-02-FIX
subsystem: comments
tags: [mentions, cursor-position, navigation, requestAnimationFrame, react-native]

requires:
  - phase: 47.1-comment-at-tagging
    provides: Comment @-mention autocomplete UI and integration
provides:
  - Fixed @-trigger cursor detection (immediate overlay on @ keystroke)
  - Fixed @mention profile navigation (renders on top, not behind)
  - Fixed reply autocomplete trigger character leak
affects: []

tech-stack:
  added: []
  patterns:
    - 'requestAnimationFrame deferral for Text.onPress navigation in Animated.View hierarchies'
    - 'Adjusted cursor position in onChangeText to compensate for stale onSelectionChange timing'

key-files:
  created: []
  modified:
    - src/components/comments/CommentInput.js
    - src/components/comments/CommentsBottomSheet.js

key-decisions:
  - 'Used prevTextLengthRef + lengthDiff to compute adjusted cursor position rather than moving cursor tracking to onChangeText'
  - 'Wrapped onAvatarPress in requestAnimationFrame to fix Text.onPress vs TouchableOpacity.onPress navigation timing difference'
  - 'No Cloud Function changes needed — getMutualFriendsForComments already returns userId field correctly'

patterns-established: []

issues-created: []

duration: 4min
completed: 2026-02-11
---

# Phase 47.1 Plan 02 FIX: Comment @-Tagging UAT Fixes Summary

**Fixed stale cursor position causing delayed @-trigger and trigger char leak, plus requestAnimationFrame deferral for @mention profile navigation**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-11T20:00:00Z
- **Completed:** 2026-02-11T20:04:00Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- Fixed UAT-001: @-trigger now shows overlay immediately when `@` is typed (no extra character needed)
- Fixed UAT-002: @mention profile navigation renders on top of photo+comments (matches avatar tap behavior)
- Fixed UAT-003: Selecting autocomplete suggestion in replies no longer leaks trigger character

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix stale cursor position in CommentInput.handleChangeText** - `aae3026` (fix) — UAT-001 + UAT-003
2. **Task 2: Fix @mention profile navigation via requestAnimationFrame** - `d3a9a47` (fix) — UAT-002

## Files Created/Modified

- `src/components/comments/CommentInput.js` - Added prevTextLengthRef to compute adjusted cursor position, fixing stale onSelectionChange timing
- `src/components/comments/CommentsBottomSheet.js` - Wrapped onAvatarPress in requestAnimationFrame in handleMentionProfilePress to fix Text.onPress navigation timing

## Decisions Made

- Used lengthDiff approach (prevTextLengthRef tracking) rather than trying to move cursor tracking entirely into onChangeText — simpler, minimal change, preserves existing onSelectionChange for other uses
- Applied requestAnimationFrame deferral for @mention navigation rather than changing the navigation architecture — mirrors the fundamental difference between Text.onPress and TouchableOpacity.onPress event batching in React Native's Animated.View hierarchy
- No Cloud Function changes needed — investigation confirmed getMutualFriendsForComments returns `userId` field correctly

## Deviations from Plan

None - plan executed exactly as written. Task 2 followed the second investigation path (requestAnimationFrame deferral) after confirming CF data format was correct.

## Issues Encountered

None

## Next Phase Readiness

- All 3 UAT issues (UAT-001, UAT-002, UAT-003) resolved
- Ready for re-verification with /gsd:verify-work
- Phase 47.1 FIX complete, ready to continue with Phase 48

---

_Phase: 47.1-comment-at-tagging_
_Completed: 2026-02-11_
