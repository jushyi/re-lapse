---
phase: 47.1-comment-at-tagging
plan: 47.1-02-FIX2
type: fix
---

<objective>
Fix 1 remaining UAT issue from plan 47.1-02 (UAT-003: reply autocomplete text corruption).

UAT-002 (profile navigation behind modal) deferred to ISS-014 — regression from Phase 46.1 affecting all profile navigation from PhotoDetail, not specific to @mentions.

Source: 47.1-02-ISSUES.md
Priority: 0 blocker, 1 major, 0 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/47.1-comment-at-tagging/47.1-02-ISSUES.md

**Previous fix attempt (failed for UAT-003):**
@.planning/phases/47.1-comment-at-tagging/47.1-02-FIX-SUMMARY.md

**Key source files:**
@src/hooks/useMentionSuggestions.js
@src/components/comments/CommentsBottomSheet.js
@src/components/comments/CommentInput.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-003 — Use query text state for mention replacement instead of stale cursor</name>
  <files>src/hooks/useMentionSuggestions.js</files>
  <action>
**Root cause:** `selectSuggestion` calls `findActiveMention(fullText, cursorPosition)` which depends on `cursorPosition` passed from `latestCursorRef` in CommentsBottomSheet. This cursor position is computed via `prevTextLengthRef` adjustment in CommentInput, but the adjustment can be wrong when:
- The user is in reply mode (text starts with `@alice ` pre-filled)
- The `cursorPositionRef` is stale from the last `onSelectionChange` event
- The adjusted cursor points to the wrong position, causing `findActiveMention` to search backward and find the FIRST `@` (the auto-inserted reply @mention) instead of the one the user is currently typing

**Fix:** Modify `selectSuggestion` to use the hook's own `queryText` state instead of the fragile cursor-based approach. The `queryText` is already correctly set by `handleTextChange` and represents exactly what the user typed after `@`. Use it to find and replace the correct mention:

1. In `selectSuggestion`, instead of calling `findActiveMention(fullText, cursorPosition)`, search for `@${queryText}` from the end of the text using `lastIndexOf`:

```javascript
const selectSuggestion = useCallback(
  (user, fullText, cursorPosition) => {
    const username = user.username || user.displayName || 'user';
    const replacement = `@${username} `;

    // Use queryText (hook state) to find the exact @mention being typed.
    // This avoids depending on potentially stale cursor position.
    const searchPattern = `@${queryText}`;
    let atIndex = -1;
    let matchEnd = -1;

    // Search from end of text to find the most recent matching @mention
    const lastIndex = fullText.lastIndexOf(searchPattern);
    if (lastIndex !== -1) {
      // Validate: @ must be at start of text or preceded by space/newline
      if (lastIndex === 0 || fullText[lastIndex - 1] === ' ' || fullText[lastIndex - 1] === '\n') {
        atIndex = lastIndex;
        matchEnd = lastIndex + searchPattern.length;
      }
    }

    // Fallback to cursor-based approach if queryText search fails
    if (atIndex === -1) {
      const activeMention = findActiveMention(fullText, cursorPosition);
      if (!activeMention) {
        logger.warn('useMentionSuggestions.selectSuggestion: No active mention found');
        return { newText: fullText, newCursorPosition: cursorPosition };
      }
      atIndex = activeMention.atIndex;
      matchEnd = cursorPosition; // Original behavior as fallback
    }

    // Build new text: text before @ + replacement + text after the matched query
    const textBefore = fullText.slice(0, atIndex);
    const textAfter = fullText.slice(matchEnd);
    const newText = textBefore + replacement + textAfter;
    const newCursorPosition = atIndex + replacement.length;

    logger.info('useMentionSuggestions.selectSuggestion: Inserted mention', {
      username,
      atIndex,
      matchEnd,
      usedQueryText: true,
    });

    setShowSuggestions(false);
    setFilteredSuggestions([]);
    setQueryText('');

    return { newText, newCursorPosition };
  },
  [findActiveMention, queryText]
);
```

**Key changes:**

- `lastIndexOf` with `@${queryText}` finds the LAST (most recent) @mention matching the query — this is always the one the user just typed, not a pre-existing @mention
- `matchEnd = lastIndex + searchPattern.length` replaces the exact range of `@query` instead of `text[atIndex..cursorPosition]` — no dependency on cursor position
- Fallback to original cursor-based approach if query text search fails (defensive)

**Why this works for reply mode:**

- Text: `@alice hey @b` (user typed `@b` after `@alice hey `)
- `queryText` state = `"b"` (set by `handleTextChange`)
- `searchPattern = "@b"`
- `lastIndexOf("@b")` = 11 (finds the correct @, not @alice at index 0)
- `textBefore = "@alice hey "`, replacement = `"@bob "`, `textAfter = ""`
- Result: `"@alice hey @bob "` — CORRECT

**Why this works for empty query (just `@` typed):**

- Text: `@alice hey @` (user typed just `@`)
- `queryText` state = `""` (empty query, all friends shown)
- `searchPattern = "@"`
- `lastIndexOf("@")` = 11 (finds the last @, which is the one just typed)
- Validation: `text[10] = ' '` → passes
- `textBefore = "@alice hey "`, replacement = `"@bob "`, `textAfter = ""`
- Result: `"@alice hey @bob "` — CORRECT
  </action>
  <verify>
  `npx eslint src/hooks/useMentionSuggestions.js` passes with no errors.
  </verify>
  <done>
  Selecting a mention suggestion in reply mode replaces the correct @query (the one being typed), leaving the auto-inserted reply @mention intact. No text corruption, no leftover characters.
  </done>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] UAT-003 fixed: Selecting mention suggestion in reply mode replaces the correct @mention
- [ ] `npx eslint src/hooks/useMentionSuggestions.js` passes
- [ ] No new ESLint errors or warnings introduced
</verification>

<success_criteria>

- UAT-003: Reply autocomplete replaces correct @query, leaves reply @mention intact
- ESLint checks pass
- Ready for re-verification
  </success_criteria>

<output>
After completion, create `.planning/phases/47.1-comment-at-tagging/47.1-02-FIX2-SUMMARY.md`
</output>
