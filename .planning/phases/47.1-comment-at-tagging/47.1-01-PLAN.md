---
phase: 47.1-comment-at-tagging
plan: 01
type: execute
---

<objective>
Create the backend infrastructure for @-mention tagging: a callable Cloud Function to fetch mutual friends (friends shared between commenter and photo owner), and fix the existing comment notification function to process @mentions in replies.

Purpose: Provide the data layer that the autocomplete UI needs (Plan 02) and ensure notifications work for @mentions in all comment types.
Output: Working Cloud Function returning mutual friends list, and updated notification function processing @mentions in both top-level comments and replies.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47.1-comment-at-tagging/47.1-CONTEXT.md

# Key source files:

@functions/index.js
@src/services/firebase/friendshipService.js
@src/services/firebase/commentService.js

**Established patterns:**

- Cloud Functions use `onCall` from `firebase-functions/v2/https` with `HttpsError` for errors
- Admin SDK: `const db = admin.firestore()` already initialized at top of functions/index.js
- Friendship queries: `user1Id`/`user2Id` fields with OR pattern (query both, merge results)
- Existing `getMutualFriendSuggestions` CF is the reference pattern for friend graph traversal
- Client calls CFs via `httpsCallable(getFunctions(), 'functionName')` from `@react-native-firebase/functions`

**Constraining decisions:**

- Phase 42: Mutual friend computation must use Cloud Function (admin SDK) since Firestore rules block cross-user queries
- Phase 47: DEV guard pattern for performance traces (not relevant here but shows the pattern)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create getMutualFriendsForComments callable Cloud Function</name>
  <files>functions/index.js</files>
  <action>
Add a new callable Cloud Function `getMutualFriendsForComments` that computes the intersection of the authenticated caller's friends and a given photo owner's friends. This is simpler than `getMutualFriendSuggestions` (which does friends-of-friends) — we just need the direct intersection.

**Input validation:** Require `photoOwnerId` (string) in request data. Throw `HttpsError('invalid-argument')` if missing. Require authentication.

**Logic:**

1. Get caller's accepted friendships (query `user1Id == callerId` and `user2Id == callerId`, filter status === 'accepted', extract other user IDs into `callerFriendIds` Set)
2. Get photo owner's accepted friendships (same pattern with `photoOwnerId`, extract into `ownerFriendIds` Set)
3. Run both queries in parallel with `Promise.all`
4. Compute intersection: filter `callerFriendIds` where `ownerFriendIds.has(id)`. Also include the photo owner themselves (they're always a valid tag target since they're friends with the commenter)
5. Cap at 50 mutual friends to limit profile fetches
6. Fetch user profiles in parallel for the intersection set: `{ userId, username, displayName, profilePhotoURL }`
7. Return `{ mutualFriends: [...] }` sorted alphabetically by displayName

**Configuration:** `{ memory: '512MiB', timeoutSeconds: 60 }` — lighter than getMutualFriendSuggestions since no graph traversal.

**Place after** the existing `getMutualFriendSuggestions` export in functions/index.js.

**Avoid:** Don't use the same friends-of-friends pattern as getMutualFriendSuggestions. This is a simple intersection — get both friend lists, find overlap. Much cheaper and faster.
</action>
<verify>
Deploy Cloud Function: `cd functions && npm run lint` passes with no errors on the new function.
Manually verify: read the function code, confirm it queries both users' friendships, computes intersection, returns profiles.
</verify>
<done>
`getMutualFriendsForComments` exists in functions/index.js, accepts `photoOwnerId`, requires auth, returns `{ mutualFriends: [{ userId, username, displayName, profilePhotoURL }] }`. Lint passes.
</done>
</task>

<task type="auto">
  <name>Task 2: Fix sendCommentNotification to process @mentions in replies</name>
  <files>functions/index.js</files>
  <action>
Currently `sendCommentNotification` returns early for ALL replies (`if (comment.parentId) return null`). This means @mentions in reply comments never trigger notifications. Fix this so:

1. **Reply comments still skip the "comment to photo owner" notification** (Part 1 of the function) — this is correct, the owner was already notified of the top-level comment.
2. **Reply comments DO process @mentions** (Part 2 of the function) — @mentions in replies should send notifications to mentioned users.

**Implementation:** Replace the early return for replies with a flag. Change:

```javascript
if (comment.parentId) {
  // Early return - skip everything
  return null;
}
```

To:

```javascript
const isReply = !!comment.parentId;
```

Then wrap Part 1 (comment notification to photo owner) in `if (!isReply) { ... }` and let Part 2 (@mention processing) run unconditionally for both top-level comments and replies.

The rest of the @mention processing logic (regex extraction, username lookup, preference checking, notification sending) works as-is for replies — no changes needed there.

**Also:** Update the function's JSDoc comment to reflect that replies now process @mentions.

**Avoid:** Don't change the notification type or data format. Don't change how @mentions are extracted from text. The existing regex `/@(\w+)/g` and username lookup pattern work correctly.
</action>
<verify>
`cd functions && npm run lint` passes.
Read the updated function: confirm replies skip Part 1 (comment notification) but run Part 2 (@mention processing).
</verify>
<done>
`sendCommentNotification` processes @mentions in both top-level comments and replies. Top-level comments still send comment notification to photo owner. Replies skip comment notification but process @mentions. Lint passes.
</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd functions && npm run lint` passes with no errors
- [ ] `getMutualFriendsForComments` CF exists with auth guard, input validation, intersection logic
- [ ] `sendCommentNotification` no longer early-returns for replies — @mentions in replies are processed
- [ ] No other Cloud Functions broken (existing tests/lint pass)
</verification>

<success_criteria>

- Both Cloud Function changes implemented and lint-clean
- getMutualFriendsForComments returns mutual friends between caller and photo owner
- sendCommentNotification processes @mentions in replies
- No regressions to existing Cloud Functions
  </success_criteria>

<output>
After completion, create `.planning/phases/47.1-comment-at-tagging/47.1-01-SUMMARY.md`
</output>
