---
phase: 47.1-comment-at-tagging
plan: 02
type: execute
---

<objective>
Build the client-side autocomplete UI for @-mention tagging: a service to call the Cloud Function, a suggestions hook, an autocomplete overlay component, CommentInput @-trigger detection, and CommentsBottomSheet integration with MentionText profile navigation.

Purpose: Give users the Instagram-style @-mention experience — type @, see mutual friends, tap to insert, mentions navigate to profiles.
Output: Working @-mention autocomplete in comments with profile navigation on mention taps.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47.1-comment-at-tagging/47.1-CONTEXT.md
@.planning/phases/47.1-comment-at-tagging/47.1-01-SUMMARY.md

# Key source files:

@src/components/comments/CommentInput.js
@src/components/comments/CommentsBottomSheet.js
@src/components/comments/MentionText.js
@src/components/comments/CommentRow.js
@src/hooks/useComments.js
@src/services/firebase/friendshipService.js
@src/services/firebase/accountService.js
@src/styles/CommentInput.styles.js
@src/styles/CommentsBottomSheet.styles.js
@src/styles/MentionText.styles.js
@src/constants/colors.js

**Established patterns:**

- Client calls CFs via `httpsCallable(getFunctions(), 'functionName')` from `@react-native-firebase/functions`
- Services return `{ success: true, data }` or `{ success: false, error }` pattern
- Hooks use `useState` + `useEffect` + `useCallback` — no external state libs
- Components use `StyleSheet.create` in separate `.styles.js` files
- Colors from `src/constants/colors.js` — NEVER hardcode hex values
- Dark theme: `colors.background.secondary` for cards/overlays, `colors.text.primary` for main text
- `colors.brand.purple` / `colors.interactive.primary` for highlights/interactive elements

**Constraining decisions:**

- Phase 42: Cloud Function pattern for cross-user queries (getMutualFriendsForComments from Plan 01)
- Phase 17: Flat comment threading with @mention auto-insertion on reply
- Phase 33: CommentsBottomSheet uses Animated.View (not Modal) — overlay must layer correctly
- Phase 46.1: OtherUserProfile as card (not fullScreenModal) for navigation
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create mentionService and useMentionSuggestions hook</name>
  <files>src/services/firebase/mentionService.js, src/services/firebase/index.js, src/hooks/useMentionSuggestions.js</files>
  <action>
**mentionService.js:** Create a new service file following the established pattern (see accountService.js for CF calling pattern).

```
import { getFunctions, httpsCallable } from '@react-native-firebase/functions';
```

Export `getMutualFriendsForTagging(photoOwnerId)`:

- Call `httpsCallable(getFunctions(), 'getMutualFriendsForComments')` with `{ photoOwnerId }`
- Return `{ success: true, data: result.data.mutualFriends }` or `{ success: false, error }`
- Log via logger at debug (start) and info (success) levels

**index.js:** Add the export for mentionService in the barrel file.

**useMentionSuggestions.js:** Create a hook that manages the autocomplete state.

Parameters: `(photoOwnerId, currentUserId)`

State:

- `allMutualFriends` — full list from CF (loaded once when hook mounts)
- `filteredSuggestions` — filtered by current query text
- `loading` — initial load state
- `showSuggestions` — whether to display overlay
- `queryText` — current text after @ trigger

Functions to expose:

- `handleTextChange(fullText, cursorPosition)` — Detect if cursor is inside an @-mention being typed. Parse text to find the `@` trigger nearest to cursor with no space after it. Extract query text (e.g., `@joh` → `"joh"`). If active @-mention found, set `showSuggestions = true` and filter `allMutualFriends` by username/displayName matching query (case-insensitive startsWith). If no active @-mention, hide suggestions.
- `selectSuggestion(user, fullText, cursorPosition)` — Replace the `@query` text with `@username ` (with trailing space). Return the new text string and new cursor position. Set `showSuggestions = false`.
- `dismissSuggestions()` — Set `showSuggestions = false`.

Load mutual friends on mount via useEffect (call `getMutualFriendsForTagging`). Cache — don't re-fetch if `photoOwnerId` hasn't changed.

**Avoid:** Don't use a debounce on filtering — the list is already loaded and filtering a max-50 array is instant. Don't re-fetch from CF on every keystroke.
</action>
<verify>
Files exist: `src/services/firebase/mentionService.js`, `src/hooks/useMentionSuggestions.js`.
`npx eslint src/services/firebase/mentionService.js src/hooks/useMentionSuggestions.js` passes.
</verify>
<done>
mentionService.js exports `getMutualFriendsForTagging`. useMentionSuggestions hook loads mutual friends on mount, exposes `handleTextChange`, `selectSuggestion`, `dismissSuggestions`, `filteredSuggestions`, `showSuggestions`, `loading`. ESLint passes.
</done>
</task>

<task type="auto">
  <name>Task 2: Create MentionSuggestionsOverlay component and integrate with CommentInput</name>
  <files>src/components/comments/MentionSuggestionsOverlay.js, src/styles/MentionSuggestionsOverlay.styles.js, src/components/comments/CommentInput.js, src/styles/CommentInput.styles.js, src/components/comments/index.js</files>
  <action>
**MentionSuggestionsOverlay.js:** A floating overlay component positioned above the CommentInput.

Props:

- `suggestions` — array of `{ userId, username, displayName, profilePhotoURL }`
- `onSelect` — callback `(user) => void`
- `visible` — boolean
- `loading` — boolean (show spinner while mutual friends load)

Render:

- Only render when `visible && (suggestions.length > 0 || loading)`
- `View` with absolute positioning (NOT a Modal — must layer inside the CommentsBottomSheet Animated.View)
- Position: above CommentInput using negative `bottom` offset or absolute positioning at the bottom of the comments list area
- Max height ~200px, scrollable via `FlatList` or `ScrollView`
- Each suggestion row: profile photo (24px circle via `expo-image`), display name (bold, `colors.text.primary`), @username (muted, `colors.text.secondary`)
- `TouchableOpacity` on each row calling `onSelect(user)`
- Background: `colors.background.tertiary` with subtle border top (`colors.background.secondary`)
- If `loading`: show `PixelSpinner` centered
- Haptic feedback on selection (`Haptics.impactAsync(Light)`)

**MentionSuggestionsOverlay.styles.js:** Styles for the overlay. Keep it minimal — dark card style matching CommentsBottomSheet.

**CommentInput.js modifications:**

Add new props:

- `mentionSuggestions` — array of suggestion objects
- `showMentionSuggestions` — boolean
- `mentionSuggestionsLoading` — boolean
- `onTextChangeForMentions` — callback `(text, cursorPosition) => void`
- `onMentionSelect` — callback `(user) => void`

Changes:

1. Track cursor position: Add `onSelectionChange` handler to TextInput that captures `event.nativeEvent.selection.start` into a ref (`cursorPositionRef`).
2. Update `handleChangeText`: After calling `setText(newText)`, also call `onTextChangeForMentions?.(newText, cursorPositionRef.current)` to notify parent of text changes with cursor position.
3. Render `MentionSuggestionsOverlay` ABOVE the input row (before the input row in the JSX, positioned absolutely). Pass through `mentionSuggestions`, `showMentionSuggestions`, `mentionSuggestionsLoading`, and a selection handler.
4. The selection handler: when user taps a suggestion, call `onMentionSelect(user)`. The parent (CommentsBottomSheet) will call `selectSuggestion` from the hook, get back the new text, and update the input via a new imperative method `setText(newText)` exposed via ref.

Add to `useImperativeHandle`: `setText: (newText) => setText(newText)` so parent can update text after mention selection.

**index.js:** Export `MentionSuggestionsOverlay` from the barrel file.

**Avoid:** Don't use a Modal or Portal for the overlay — it must render inline within the CommentsBottomSheet's Animated.View hierarchy. Don't use `position: 'absolute'` relative to the screen — position relative to the CommentInput container. Don't create a rich text editor — mentions are plain text with `@username` syntax.
</action>
<verify>
`npx eslint src/components/comments/MentionSuggestionsOverlay.js src/components/comments/CommentInput.js` passes.
Check that MentionSuggestionsOverlay renders a scrollable list of suggestions with profile photos and names.
Check that CommentInput tracks cursor position and passes text changes to parent.
</verify>
<done>
MentionSuggestionsOverlay renders floating suggestion list with profile photos, display names, and @usernames. CommentInput tracks cursor position, notifies parent of text changes, renders overlay above input, exposes `setText` via ref. ESLint passes.
</done>
</task>

<task type="auto">
  <name>Task 3: Wire everything in CommentsBottomSheet and add MentionText profile navigation</name>
  <files>src/components/comments/CommentsBottomSheet.js, src/components/comments/MentionText.js</files>
  <action>
**CommentsBottomSheet.js:**

1. Import `useMentionSuggestions` hook.
2. Initialize: `const mentionSuggestions = useMentionSuggestions(photoOwnerId, currentUserId);`
3. Create `handleTextChangeForMentions` callback that calls `mentionSuggestions.handleTextChange(text, cursorPosition)`.
4. Create `handleMentionSelect` callback that:
   - Calls `mentionSuggestions.selectSuggestion(user, currentText, cursorPosition)` to get new text
   - Calls `inputRef.current?.setText(newText)` to update the input
   - Calls `inputRef.current?.focus()` to keep keyboard open
5. Pass to CommentInput: `mentionSuggestions={mentionSuggestions.filteredSuggestions}`, `showMentionSuggestions={mentionSuggestions.showSuggestions}`, `mentionSuggestionsLoading={mentionSuggestions.loading}`, `onTextChangeForMentions={handleTextChangeForMentions}`, `onMentionSelect={handleMentionSelect}`.
6. When `cancelReply` or submit happens, also call `mentionSuggestions.dismissSuggestions()`.

**Note on text state:** The `useMentionSuggestions.selectSuggestion` needs the current text. Track it via a ref in CommentsBottomSheet that updates when `onTextChangeForMentions` fires, OR pass it through from CommentInput's text state. The simplest approach: have `selectSuggestion` accept the current text as a parameter, and CommentsBottomSheet stores the latest text in a ref updated by `handleTextChangeForMentions`.

**MentionText.js:**

Update `handleMentionPress` to support profile navigation for non-reply @mentions:

Currently, when `mentionedCommentId` is null (non-first @mention or manually typed), it's a no-op. Change behavior:

- If `mentionedCommentId` exists → existing behavior (scroll to comment)
- If `mentionedCommentId` is null → call a new `onProfilePress(username)` callback prop

Add new prop `onProfilePress` — optional callback `(username) => void`.

**CommentsBottomSheet.js (additional):**

Pass `onProfilePress` to `CommentWithReplies` → `CommentRow` → `MentionText`:

- The callback should look up the username from the mutual friends list or the comment user data, then call `onAvatarPress(userId, displayName)` to navigate to the user's profile.
- Simple approach: `handleMentionProfilePress(username)` — search all comments for a user with that username, if found call `onAvatarPress(userId, displayName)`. If not found in comments, search `mentionSuggestions.allMutualFriends` for the username.

**CommentWithReplies.js and CommentRow.js:** Thread the `onProfilePress` prop down to `MentionText`. Check if these components already pass `onMentionPress` — `onProfilePress` follows the same threading pattern.

**Avoid:** Don't over-engineer the profile lookup. Username matching on existing comment data + mutual friends list covers all realistic cases. Don't modify the notification system — that was handled in Plan 01.
</action>
<verify>
`npx eslint src/components/comments/CommentsBottomSheet.js src/components/comments/MentionText.js` passes.
`npm run lint` passes with no new errors across the project.
</verify>
<done>
CommentsBottomSheet initializes useMentionSuggestions, passes suggestion data and handlers to CommentInput. MentionText calls onProfilePress for non-reply @mentions. Profile navigation works for tapped mentions. ESLint passes project-wide.
</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run lint` passes with no errors
- [ ] All new files have proper imports and exports
- [ ] Typing `@` in comment input shows mutual friends overlay
- [ ] Selecting a suggestion inserts `@username ` into text
- [ ] Tapping a posted @mention navigates to that user's profile (when not a reply-linked mention)
- [ ] Reply-linked mentions still scroll to the referenced comment (existing behavior preserved)
- [ ] Overlay dismisses when: suggestion selected, text cleared, input blurred, comment submitted
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No ESLint errors or warnings introduced
- @-mention autocomplete works end-to-end: type @ → see suggestions → tap → inserted
- Mention profile navigation works for non-reply mentions
- Existing reply @mention scroll-to behavior preserved
- Phase 47.1 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/47.1-comment-at-tagging/47.1-02-SUMMARY.md`

Then update:

- `.planning/STATE.md` — Phase 47.1 complete, current position = Phase 48
- `.planning/ROADMAP.md` — Mark Phase 47.1 plans as complete
  </output>
