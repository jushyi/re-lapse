---
phase: 47.1-comment-at-tagging
plan: 47.1-02-FIX2
subsystem: comments
tags: [mentions, queryText, lastIndexOf, reply-mode, autocomplete, react-native]

requires:
  - phase: 47.1-comment-at-tagging
    provides: Comment @-mention autocomplete UI and integration
provides:
  - Fixed reply-mode autocomplete text corruption (UAT-003) via queryText-based mention replacement
affects: []

tech-stack:
  added: []
  patterns:
    - 'queryText state + lastIndexOf for mention replacement instead of stale cursor position'
    - 'Fallback to cursor-based findActiveMention for defensive safety'

key-files:
  created: []
  modified:
    - src/hooks/useMentionSuggestions.js

key-decisions:
  - 'Used lastIndexOf with @${queryText} to find the most recent matching @mention from end of text'
  - 'Validates @ is at start of text or preceded by space/newline before accepting match'
  - 'Retained cursor-based findActiveMention as fallback for edge cases where queryText search fails'
  - 'Added queryText to useCallback dependency array'

patterns-established: []

issues-created: []

duration: 3min
completed: 2026-02-11
---

# Phase 47.1 Plan 02 FIX2: Reply Autocomplete Fix Summary

**queryText-based mention replacement to fix reply mode autocomplete corruption**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-11T21:00:00Z
- **Completed:** 2026-02-11T21:03:00Z
- **Tasks:** 1
- **Files modified:** 1

## Accomplishments

- Fixed UAT-003: Selecting autocomplete suggestion in reply mode now replaces the correct @mention (the one being typed), leaving the auto-inserted reply @mention intact. No text corruption or leftover characters.

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix UAT-003 — Use queryText state for mention replacement** - `24903fd` (fix) — UAT-003

## Files Created/Modified

- `src/hooks/useMentionSuggestions.js` - Replaced cursor-based `findActiveMention` in `selectSuggestion` with `lastIndexOf(@${queryText})` approach. Searches from end of text to find the most recent matching @mention, with validation that @ is at start or preceded by whitespace. Falls back to cursor-based approach if queryText search fails.

## Decisions Made

- Used `lastIndexOf` with `@${queryText}` rather than fixing cursor position propagation — the queryText is already correctly maintained by `handleTextChange` and represents exactly what the user typed after `@`, making it the most reliable source of truth
- Kept `findActiveMention` as fallback rather than removing it entirely — defensive programming for edge cases where queryText might be empty or stale
- Added `queryText` to the `useCallback` dependency array so `selectSuggestion` always captures the latest query state

## Deviations from Plan

None - plan executed exactly as written. Prettier formatting adjustment was needed for the long conditional (line break), but this was a cosmetic auto-fix, not a logic deviation.

## Issues Encountered

None

## Next Phase Readiness

- UAT-003 (reply autocomplete text corruption) resolved
- Ready for re-verification on device
- Phase 47.1 FIX2 complete, ready to continue with Phase 48

---

_Phase: 47.1-comment-at-tagging_
_Completed: 2026-02-11_
