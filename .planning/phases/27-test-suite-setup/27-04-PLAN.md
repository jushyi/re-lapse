---
phase: 27-test-suite-setup
plan: 04
type: execute
---

<objective>
Write integration tests for critical multi-service flows: photo lifecycle and friendship flow.

Purpose: Verify that services work correctly together for the most critical user journeys - these are the flows that break most often during refactoring.
Output: Integration test files that exercise complete user flows spanning multiple services.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-test-suite-setup/27-RESEARCH.md
@.planning/phases/27-test-suite-setup/27-CONTEXT.md
@src/services/firebase/photoService.js
@src/services/firebase/darkroomService.js
@src/services/firebase/friendshipService.js
@src/services/firebase/feedService.js
@__tests__/setup/jest.setup.js
@__tests__/setup/testFactories.js

**Critical flows to test (from CONTEXT.md):**

1. Photo lifecycle: capture → developing → reveal → triage
2. Friendship flow: request → accept → feed filtering

**Integration test approach:**

- Tests exercise multiple services together
- Use mocks but verify correct inter-service calls
- Test the contracts between services, not internal implementation
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Write photo lifecycle integration tests</name>
  <files>__tests__/integration/photoLifecycle.test.js</files>
  <action>
  Create integration tests for the complete photo lifecycle:

1. **Photo Capture → Developing flow:**
   - Create a photo with createPhoto()
   - Verify photo document created with status='developing'
   - Verify storage upload was called
   - Verify ensureDarkroomInitialized was called
   - Verify photo appears in getDevelopingPhotos()

2. **Developing → Reveal flow:**
   - Set up user with developing photos
   - Mock time so isDarkroomReadyToReveal() returns true
   - Call revealPhotos()
   - Verify all 'developing' photos updated to 'revealed'
   - Verify revealedAt timestamp set
   - Verify scheduleNextReveal() was called

3. **Reveal → Triage flow:**
   - Set up user with revealed photos
   - Verify photos appear in getRevealedPhotos()
   - Call triagePhoto() with 'journal'
   - Verify status='triaged', photoState='journal'
   - Call triagePhoto() with 'archive'
   - Verify status='triaged', photoState='archive'

4. **Triage → Feed flow:**
   - Set up user A with triaged photo (photoState='journal')
   - Set up user B as friend of user A
   - Get feed for user B
   - Verify user A's journal photo appears in user B's feed
   - Verify archived photos do NOT appear in feed

5. **Delete flow:**
   - Set up photo in triage state
   - Call deletePhotoById()
   - Verify Firestore document deleted
   - Verify Storage file deleted

Mock patterns for integration:

```javascript
// Set up interconnected mock data
const mockUser = createTestUser({ uid: 'user1' });
const mockPhoto = createTestPhoto({
  userId: 'user1',
  status: 'developing',
});
const mockDarkroom = createTestDarkroom({
  userId: 'user1',
  nextRevealAt: pastTimestamp, // Ready to reveal
});
```

  </action>
  <verify>
  - `npm test -- --testPathPattern=photoLifecycle` passes
  - Tests cover complete lifecycle from capture to feed
  - Service interactions verified (photoService calls darkroomService)
  </verify>
  <done>
  - photoLifecycle.test.js exists with 5+ integration tests
  - All tests pass
  - Complete capture → develop → reveal → triage → feed flow tested
  </done>
</task>

<task type="auto">
  <name>Task 2: Write friendship flow integration tests</name>
  <files>__tests__/integration/friendshipFlow.test.js</files>
  <action>
  Create integration tests for the friendship flow:

1. **Friend Request → Accept flow:**
   - User A sends friend request to User B
   - Verify friendship document created with status='pending'
   - User B accepts request
   - Verify status updated to 'accepted'
   - Verify User A appears in User B's getFriendships()
   - Verify User B appears in User A's getFriendships()

2. **Friend Request → Decline flow:**
   - User A sends friend request to User B
   - User B declines request
   - Verify friendship document deleted
   - Verify User A NOT in User B's friendships
   - Verify User A can send new request after decline

3. **Pending Requests management:**
   - User A sends requests to Users B, C, D
   - Verify User A's getSentRequests() returns 3 pending
   - User B accepts, User C declines
   - Verify User A's getSentRequests() returns 1 pending (User D)
   - Verify User D's getPendingRequests() returns 1 pending (from User A)

4. **Remove Friend flow:**
   - Set up accepted friendship between User A and User B
   - User A removes User B
   - Verify friendship document deleted
   - Verify User B no longer in User A's feed
   - Verify User A no longer in User B's feed

5. **Feed Filtering by Friendship:**
   - User A has journal photos
   - User B is NOT friends with User A
   - Verify User A's photos NOT in User B's feed
   - User B sends friend request, User A accepts
   - Verify User A's photos NOW appear in User B's feed
   - User A removes User B
   - Verify User A's photos NO LONGER in User B's feed

6. **Edge Cases:**
   - Self-friend request rejected
   - Duplicate friend request rejected
   - Accept request from non-recipient rejected
   - Remove non-friend returns error
     </action>
     <verify>

- `npm test -- --testPathPattern=friendshipFlow` passes
- Tests cover request → accept/decline → feed filtering
- Edge cases tested and handled correctly
  </verify>
  <done>
- friendshipFlow.test.js exists with 6+ integration tests
- All tests pass
- Feed filtering correctly tied to friendship status
- Edge cases (self-request, duplicates) handled
  </done>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test` runs all tests (unit + integration) and passes
- [ ] Photo lifecycle integration tests verify multi-service flow
- [ ] Friendship integration tests verify request/accept/feed flow
- [ ] Edge cases covered in both test files
- [ ] `npm test -- --coverage` shows reasonable coverage for tested services
</verification>

<success_criteria>

- photoLifecycle.test.js with 5+ integration tests
- friendshipFlow.test.js with 6+ integration tests
- All tests pass
- Complete Phase 27 test suite: `npm test` runs 60+ tests and passes
- Tests provide safety net for future refactoring
  </success_criteria>

<output>
After completion, create `.planning/phases/27-test-suite-setup/27-04-SUMMARY.md`:

# Phase 27 Plan 04: Integration Tests Summary

**[Substantive one-liner about what was accomplished]**

## Accomplishments

- [Integration test outcomes]

## Files Created/Modified

- `__tests__/integration/photoLifecycle.test.js` - Photo lifecycle integration tests
- `__tests__/integration/friendshipFlow.test.js` - Friendship flow integration tests

## Decisions Made

[Any decisions about test structure or patterns]

## Issues Encountered

[Any challenges with mocking or test setup]

## Phase Complete

Phase 27 (Test Suite Setup) is complete. The test suite provides:

- Jest infrastructure with jest-expo preset
- Comprehensive Firebase mock infrastructure
- Unit tests for auth, photo, darkroom, friendship, and feed services
- Integration tests for photo lifecycle and friendship flows

Ready for Phase 28: Code Refactoring (tests provide safety net)
</output>
