---
phase: 27-test-suite-setup
plan: 02
type: execute
---

<objective>
Write unit tests for authentication and photo lifecycle services.

Purpose: Create a safety net for the auth and photo services that are most fragile during refactoring - login/logout, session handling, and photo capture/reveal/triage flows.
Output: Test files covering phoneAuthService, photoService, and darkroomService with high-confidence assertions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-test-suite-setup/27-RESEARCH.md
@.planning/phases/27-test-suite-setup/27-CONTEXT.md
@src/services/firebase/phoneAuthService.js
@src/services/firebase/photoService.js
@src/services/firebase/darkroomService.js
@__tests__/setup/jest.setup.js
@__tests__/setup/testFactories.js

**Services to test:**

- phoneAuthService: validatePhoneNumber, getPhoneAuthErrorMessage, sendVerificationCode, verifyCode
- photoService: createPhoto, getPhotoById, getDevelopingPhotos, getRevealedPhotos, triagePhoto, deletePhotoById
- darkroomService: getDarkroom, isDarkroomReadyToReveal, scheduleNextReveal, revealPhotos, calculateNextRevealTime

**Testing patterns from RESEARCH.md:**

- Test behavior, not implementation (test public API)
- One concept per test
- Descriptive test names ("should reject empty email")
- Assert on mock function CALLS (mockWhere called with correct args), not on results
- Use beforeEach to clear mocks
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Write phoneAuthService unit tests</name>
  <files>__tests__/services/phoneAuthService.test.js</files>
  <action>
  Create comprehensive tests for phoneAuthService:

1. **validatePhoneNumber tests:**
   - Valid US phone number returns { valid: true, e164: '+1...' }
   - Valid UK phone number returns { valid: true, e164: '+44...' }
   - Empty phone number returns { valid: false, error: 'Please enter...' }
   - Invalid format returns { valid: false, error: '...' }
   - Missing country code handled gracefully

2. **getPhoneAuthErrorMessage tests:**
   - 'auth/invalid-phone-number' maps to user-friendly message
   - 'auth/code-expired' maps to user-friendly message
   - 'auth/too-many-requests' maps to user-friendly message
   - Unknown error code returns generic message
   - Each known error code returns distinct, helpful message

3. **sendVerificationCode tests (mocked):**
   - Calls Firebase signInWithPhoneNumber with E.164 formatted number
   - Returns confirmation object on success
   - Returns error object on Firebase error
   - Handles network errors gracefully

4. **verifyCode tests (mocked):**
   - Valid 6-digit code calls confirm() on confirmation object
   - Returns user object on success
   - Returns error on invalid code
   - Returns error on expired session

Test structure:

- Use describe() blocks for each function
- Use beforeEach to reset mocks and set up test data
- Name tests descriptively: "should return valid:true for correct US number"
  </action>
  <verify>
- `npm test -- --testPathPattern=phoneAuthService` passes
- All test cases cover happy path and error cases
- No console errors during test run
  </verify>
  <done>
- phoneAuthService.test.js exists with 15+ test cases
- All tests pass
- Covers validation, error mapping, and Firebase interactions
  </done>
  </task>

<task type="auto">
  <name>Task 2: Write photoService and darkroomService unit tests</name>
  <files>__tests__/services/photoService.test.js, __tests__/services/darkroomService.test.js</files>
  <action>
  **photoService.test.js:**

1. **createPhoto tests:**
   - Creates Firestore document with correct fields (userId, status: 'developing', etc.)
   - Calls storageService.uploadPhoto with photoUri
   - Updates document with imageURL after upload
   - Calls ensureDarkroomInitialized after photo creation
   - Returns { success: true, photoId } on success
   - Rolls back Firestore document on upload failure
   - Returns { success: false, error } on failure

2. **getDevelopingPhotos tests:**
   - Queries photos collection with userId and status='developing'
   - Returns array of photos with correct structure
   - Returns empty array when no photos match
   - Handles Firestore errors gracefully

3. **getRevealedPhotos tests:**
   - Queries photos with status='revealed'
   - Orders by capturedAt descending
   - Returns photos ready for triage

4. **triagePhoto tests:**
   - Updates status to 'triaged' and photoState to specified value
   - Accepts 'journal' or 'archive' as valid photoState
   - Returns success on valid triage
   - Returns error on invalid photoState

**darkroomService.test.js:**

1. **getDarkroom tests:**
   - Returns existing darkroom document if exists
   - Creates new darkroom with nextRevealAt if doesn't exist
   - Returns { success: true, darkroom: {...} }

2. **isDarkroomReadyToReveal tests:**
   - Returns true when nextRevealAt <= now
   - Returns false when nextRevealAt > now
   - Returns false on error

3. **calculateNextRevealTime tests:**
   - Returns Timestamp in future (0-5 minutes per project spec)
   - Returns valid Firestore Timestamp object

4. **revealPhotos tests:**
   - Updates all 'developing' photos to 'revealed'
   - Sets revealedAt timestamp on each photo
   - Calls scheduleNextReveal after revealing
   - Returns count of revealed photos

Use firestore-jest-mock where helpful:

```javascript
const { mockReactNativeFirestore } = require('firestore-jest-mock');
const { mockCollection, mockWhere } = require('firestore-jest-mock/mocks/firestore');
```

  </action>
  <verify>
  - `npm test -- --testPathPattern=photoService` passes
  - `npm test -- --testPathPattern=darkroomService` passes
  - Tests verify Firestore queries are called correctly
  - Tests cover error handling paths
  </verify>
  <done>
  - photoService.test.js exists with 10+ test cases
  - darkroomService.test.js exists with 8+ test cases
  - All tests pass
  - Photo lifecycle covered: create → develop → reveal → triage
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test -- --testPathPattern=services` passes all tests
- [ ] phoneAuthService tests cover validation and Firebase auth flow
- [ ] photoService tests cover full photo lifecycle
- [ ] darkroomService tests cover reveal timing logic
- [ ] Error handling tested in all services
</verification>

<success_criteria>

- phoneAuthService.test.js with 15+ test cases
- photoService.test.js with 10+ test cases
- darkroomService.test.js with 8+ test cases
- All tests pass
- Tests assert on mock calls, not mock data
- Clear, descriptive test names
  </success_criteria>

<output>
After completion, create `.planning/phases/27-test-suite-setup/27-02-SUMMARY.md`
</output>
