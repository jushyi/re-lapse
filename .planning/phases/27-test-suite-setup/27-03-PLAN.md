---
phase: 27-test-suite-setup
plan: 03
type: execute
---

<objective>
Write unit tests for social features - friendship management and feed filtering.

Purpose: Create a safety net for the friendship service which has many edge cases (requests, acceptance, feed filtering) and is fragile when making changes.
Output: Test files covering friendshipService and feedService with thorough edge case coverage.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-test-suite-setup/27-RESEARCH.md
@.planning/phases/27-test-suite-setup/27-CONTEXT.md
@src/services/firebase/friendshipService.js
@src/services/firebase/feedService.js
@__tests__/setup/jest.setup.js
@__tests__/setup/testFactories.js

**Services to test:**

- friendshipService: generateFriendshipId, sendFriendRequest, acceptFriendRequest, declineFriendRequest, removeFriend, getFriendships, getPendingRequests, getSentRequests, checkFriendshipStatus, getFriendUserIds
- feedService: getFeedPhotos, subscribeFeedPhotos, toggleReaction

**Friendship model (from CLAUDE.md):**

- Deterministic ID: [lowerUserId]\_[higherUserId]
- Status: 'pending' | 'accepted'
- requestedBy: userId who sent the request

**Testing patterns from RESEARCH.md:**

- Pure functions (generateFriendshipId) can be tested without mocks
- Firestore operations: assert on mock calls, not results
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Write friendshipService unit tests</name>
  <files>__tests__/services/friendshipService.test.js</files>
  <action>
  Create comprehensive tests for friendshipService:

1. **generateFriendshipId tests (pure function - no mocks):**
   - Alphabetically sorts user IDs: generateFriendshipId('zebra', 'apple') === 'apple_zebra'
   - Returns same ID regardless of argument order
   - Handles edge cases (same user IDs, empty strings)

2. **sendFriendRequest tests:**
   - Creates friendship document with status='pending'
   - Sets requestedBy to fromUserId
   - Sets user1Id/user2Id in alphabetical order
   - Returns { success: false, error } if friendship already exists
   - Returns { success: false, error } if request already pending
   - Returns { success: false, error } if same user (self-request)
   - Returns { success: false, error } if invalid user IDs

3. **acceptFriendRequest tests:**
   - Updates status from 'pending' to 'accepted'
   - Sets acceptedAt timestamp
   - Returns error if friendship doesn't exist
   - Returns error if already accepted
   - Returns error if user not authorized (not the recipient)

4. **declineFriendRequest tests:**
   - Deletes the friendship document
   - Returns success on deletion
   - Returns error if friendship doesn't exist
   - Returns error if user not authorized

5. **removeFriend tests:**
   - Deletes accepted friendship
   - Returns success on deletion
   - Returns error if not friends (status !== 'accepted')

6. **getFriendships tests:**
   - Queries friendships where user is user1Id OR user2Id
   - Filters by status='accepted'
   - Returns array of friendships with friend info

7. **getPendingRequests tests:**
   - Returns friendships where status='pending' AND user is recipient (not requestedBy)
   - Does NOT return requests sent BY the user

8. **getSentRequests tests:**
   - Returns friendships where status='pending' AND requestedBy === userId

9. **checkFriendshipStatus tests:**
   - Returns 'accepted' if friends
   - Returns 'pending' if request pending
   - Returns null if no relationship exists

10. **getFriendUserIds tests:** - Returns array of friend user IDs (not friendship documents) - Excludes the requesting user's own ID from results
    </action>
    <verify>

- `npm test -- --testPathPattern=friendshipService` passes
- Tests cover all 10+ exported functions
- Edge cases tested (self-request, duplicate request, unauthorized actions)
  </verify>
  <done>
- friendshipService.test.js exists with 20+ test cases
- All tests pass
- Pure function tests work without mocks
- Firestore interaction tests verify correct query calls
  </done>
  </task>

<task type="auto">
  <name>Task 2: Write feedService unit tests</name>
  <files>__tests__/services/feedService.test.js</files>
  <action>
  Create tests for feedService:

1. **getFeedPhotos tests:**
   - Queries photos with photoState='journal' (NOT 'journaled')
   - Filters to only friends' photos (uses friendUserIds)
   - Orders by capturedAt descending (client-side sort)
   - Implements pagination correctly
   - Returns { photos: [], hasMore: boolean }
   - Returns empty array when no friends
   - Returns empty array when friends have no journal photos

2. **subscribeFeedPhotos tests:**
   - Sets up Firestore onSnapshot listener
   - Returns unsubscribe function
   - Calls callback with photos array on update
   - Handles listener errors gracefully

3. **toggleReaction tests:**
   - Increments reaction count for emoji
   - Creates user's reaction entry if doesn't exist
   - Updates reactionCount field
   - Handles concurrent updates (field increment)
   - Returns { success: true } on success
   - Returns { success: false, error } on failure

Feed query logic to verify:

- photoState === 'journal' (NOT 'journaled' - this was a past bug)
- Client-side filtering for friends-only (not Firestore where clause)
- Client-side sorting by capturedAt

Reaction data structure:

```javascript
reactions: {
  [userId]: {
    [emoji]: count  // e.g., { 'üòÇ': 3, '‚ù§Ô∏è': 1 }
  }
}
reactionCount: number // Total across all users
```

  </action>
  <verify>
  - `npm test -- --testPathPattern=feedService` passes
  - Tests verify correct photoState filter ('journal' not 'journaled')
  - Reaction tests verify data structure updates
  </verify>
  <done>
  - feedService.test.js exists with 10+ test cases
  - All tests pass
  - Feed filtering logic verified
  - Reaction toggle logic verified
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test -- --testPathPattern=services` passes all tests
- [ ] friendshipService tests cover all exported functions
- [ ] feedService tests verify correct filter values
- [ ] Edge cases covered (empty results, errors, unauthorized actions)
</verification>

<success_criteria>

- friendshipService.test.js with 20+ test cases covering all functions
- feedService.test.js with 10+ test cases
- All tests pass
- deterministic friendship ID generation verified
- Feed photoState filter uses 'journal' (not 'journaled')
  </success_criteria>

<output>
After completion, create `.planning/phases/27-test-suite-setup/27-03-SUMMARY.md`
</output>
