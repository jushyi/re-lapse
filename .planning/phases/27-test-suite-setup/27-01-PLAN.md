---
phase: 27-test-suite-setup
plan: 01
type: execute
---

<objective>
Set up Jest testing infrastructure with comprehensive Firebase mocking for React Native Firebase SDK.

Purpose: Establish the test foundation that all subsequent test plans will build upon, ensuring reliable and fast test execution with proper Firebase isolation.
Output: Working Jest configuration, Firebase mock infrastructure, and test utility files ready for service tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-test-suite-setup/27-RESEARCH.md
@.planning/phases/27-test-suite-setup/27-CONTEXT.md
@package.json

**Tech stack:**

- jest-expo preset (official Expo recommendation)
- firestore-jest-mock for Firestore query assertions
- Manual mocks for @react-native-firebase/\* modules

**From RESEARCH.md - Don't hand-roll:**

- Firebase mocking - use official jest.setup.ts patterns from RNFirebase repo
- Firestore assertions - use firestore-jest-mock helpers (mockCollection, mockWhere, mockDoc)
- Expo module mocks - jest-expo preset handles these automatically
- Transform patterns - jest-expo defaults handle node_modules transpiling

**From RESEARCH.md - Common pitfalls to avoid:**

- Define mock functions OUTSIDE jest.mock(), then reference inside (scoping issue)
- Mock @react-native-firebase/app FIRST before other modules
- Assert on mock function CALLS, not results (firestore-jest-mock doesn't filter data)
- Always await async functions in tests
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Install Jest dependencies and configure jest-expo</name>
  <files>package.json, jest.config.js</files>
  <action>
  1. Install required packages:
     - `npx expo install jest-expo jest --dev` (use expo install for compatibility)
     - `npm install --save-dev firestore-jest-mock`

2. Create jest.config.js at project root:
   - preset: 'jest-expo'
   - setupFilesAfterEnv: ['<rootDir>/__tests__/setup/jest.setup.js']
   - testPathIgnorePatterns: ['/node_modules/', '/__tests__/setup/']
   - moduleNameMapper for @/ alias if used
   - clearMocks: true (auto-clear mocks between tests)
   - testMatch: ['**/__tests__/**/*.test.js']

3. Add npm scripts to package.json:
   - "test": "jest"
   - "test:watch": "jest --watchAll"
   - "test:coverage": "jest --coverage"

4. Create directory structure:
   - **tests**/setup/ (for jest.setup.js)
   - **tests**/services/ (for service unit tests)
   - **tests**/integration/ (for integration tests)
   - **tests**/**mocks**/ (for manual mocks)

Do NOT use 'react-native' preset (jest-expo is correct for Expo projects).
</action>
<verify>

- `npm test -- --version` shows Jest version
- Directory structure exists: **tests**/setup/, **tests**/services/, **tests**/integration/
- package.json has test scripts
  </verify>
  <done>
- Jest installed and configured with jest-expo preset
- Directory structure created
- Test scripts available in package.json
  </done>
  </task>

<task type="auto">
  <name>Task 2: Create Firebase mock infrastructure and test utilities</name>
  <files>__tests__/setup/jest.setup.js, __tests__/__mocks__/@react-native-firebase/app.js, __tests__/__mocks__/@react-native-firebase/auth.js, __tests__/__mocks__/@react-native-firebase/firestore.js, __tests__/__mocks__/@react-native-firebase/storage.js, __tests__/setup/testFactories.js</files>
  <action>
  1. Create __tests__/setup/jest.setup.js with:
     - Import and apply all Firebase mocks
     - Mock expo-secure-store (getItemAsync, setItemAsync, deleteItemAsync)
     - Mock expo-haptics (impactAsync, notificationAsync, selectionAsync)
     - Mock expo-notifications (for notificationService tests)
     - Export mock functions globally for test assertions
     - Add beforeEach to clear all mocks

2. Create **tests**/**mocks**/@react-native-firebase/app.js:
   - Default export factory function returning { app: jest.fn() }
   - Named export firebase object
   - Must be mocked FIRST (other modules depend on it)

3. Create **tests**/**mocks**/@react-native-firebase/auth.js:
   - Define mock functions OUTSIDE jest.mock (signInWithPhoneNumber, signOut, onAuthStateChanged, etc.)
   - PhoneAuthProvider mock for phone auth flow
   - currentUser mock object
   - Export mock functions for test assertions

4. Create **tests**/**mocks**/@react-native-firebase/firestore.js:
   - getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc
   - query, where, or, orderBy, serverTimestamp, Timestamp
   - onSnapshot for real-time listeners
   - All functions must be jest.fn() with sensible defaults
   - Structure compatible with firestore-jest-mock mockReactNativeFirestore

5. Create **tests**/**mocks**/@react-native-firebase/storage.js:
   - ref, putFile, getDownloadURL, delete
   - Return mock URLs for upload operations

6. Create **tests**/setup/testFactories.js with factory functions:
   - createTestUser({ uid, phoneNumber, displayName, username, bio, ... })
   - createTestPhoto({ id, userId, status, photoState, capturedAt, ... })
   - createTestFriendship({ user1Id, user2Id, status, requestedBy, ... })
   - createTestDarkroom({ userId, nextRevealAt, lastRevealedAt, ... })
   - All factories use sensible defaults with optional overrides

CRITICAL: Mock functions must be defined OUTSIDE the jest.mock() call, then referenced inside. This prevents the "Cannot read property 'mockResolvedValue' of undefined" error.
</action>
<verify>

- Create a simple smoke test **tests**/services/smoke.test.js:

  ```javascript
  describe('Jest setup', () => {
    test('jest runs', () => {
      expect(1 + 1).toBe(2);
    });

    test('firebase mocks load without errors', () => {
      const auth = require('@react-native-firebase/auth');
      expect(auth).toBeDefined();
    });
  });
  ```

- Run `npm test` - smoke test passes
- No "native module not found" errors
  </verify>
  <done>
- jest.setup.js configures all mocks
- All 4 Firebase module mocks exist and load correctly
- Test factories available for creating test data
- Smoke test passes with mocked Firebase
  </done>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test` runs without errors
- [ ] Smoke test passes (jest runs, firebase mocks load)
- [ ] All mock files exist in __tests__/__mocks__/@react-native-firebase/
- [ ] Test factories create valid mock data
- [ ] No native module errors during test run
</verification>

<success_criteria>

- Jest infrastructure installed and configured with jest-expo preset
- Firebase mock files handle all required modules (@react-native-firebase/app, auth, firestore, storage)
- Mock functions accessible in tests for assertions
- Test factories available for creating test data
- Smoke test demonstrates working setup
  </success_criteria>

<output>
After completion, create `.planning/phases/27-test-suite-setup/27-01-SUMMARY.md`
</output>
