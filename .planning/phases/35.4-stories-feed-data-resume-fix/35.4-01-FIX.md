---
phase: 35.4-stories-feed-data-resume-fix
plan: 01-FIX
type: fix
---

<objective>
Fix 3 UAT issues from plan 35.4-01.

Source: 35.4-01-ISSUES.md
Priority: 0 critical, 2 major, 1 minor

**Architectural change:** UAT-002 requires migrating viewed stories from AsyncStorage (client-side, device-bound) to Firestore (cloud-side, user-bound) to fix account switching issues.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/35.4-stories-feed-data-resume-fix/35.4-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/35.4-stories-feed-data-resume-fix/35.4-01-PLAN.md

**Key source files:**
@src/components/PhotoDetailModal.js
@src/hooks/useViewedStories.js
</context>

<tasks>

<task type="auto">
  <name>Fix UAT-001: Segmented progress line disappears with many stories</name>
  <files>src/components/PhotoDetailModal.js</files>
  <action>
Fix the story progress segments disappearing when a friend has many photos.

**Investigation:**

1. Find the progress bar/segments rendering code in PhotoDetailModal.js
2. Check how segment width is calculated
3. Identify why segments disappear with high photo counts

**Likely issues:**

- Segment width calculation results in 0 or near-0 width for many photos
- No minimum segment width enforced
- Segments container has overflow hidden cutting off thin segments

**Fix approach:**

1. Ensure minimum segment width (e.g., 2-4px) so segments remain visible
2. If segments would be too thin, consider alternative display (e.g., scrolling progress line or current/total count display)
3. Test with 10+, 20+, 50+ photos to ensure visibility at any count

**Reference:** Instagram stories shrink segments to very thin lines but keep them visible
</action>
<verify>Open a friend's story with 10+ photos - progress segments should be visible (thin but present)</verify>
<done>Progress segments display correctly for any number of photos in a story</done>
</task>

<task type="auto">
  <name>Fix UAT-002: Migrate viewed stories to Firestore (cloud-side storage)</name>
  <files>src/hooks/useViewedStories.js, src/services/firebase/viewedStoriesService.js</files>
  <action>
Migrate viewed stories state from AsyncStorage (client-side) to Firestore (cloud-side).

**Root cause:**
Current AsyncStorage keys are global (`@viewed_stories`, `@viewed_story_photos`) with NO user ID.
When switching accounts, all accounts share the same viewed data on that device.

**Fix approach - Firestore storage:**

1. **Create viewedStoriesService.js:**
   - Store viewed photos in Firestore: `users/{userId}/viewedPhotos/{photoId}`
   - Each document: `{ viewedAt: timestamp }`
   - Use batch writes for efficiency when marking multiple photos

2. **Data structure:**

   ```
   users/{userId}/viewedPhotos/{photoId}
   {
     viewedAt: Timestamp,
     friendId: string  // Optional: for querying by friend
   }
   ```

3. **Update useViewedStories.js:**
   - Accept userId as parameter or get from AuthContext
   - Replace AsyncStorage calls with Firestore service calls
   - Load viewed photos on mount (filtered by 24-hour expiry)
   - Keep local state + ref for performance (Firestore is source of truth)

4. **Benefits:**
   - Data persists per user account
   - Works across devices
   - Survives app reinstall
   - Account switching loads correct data

5. **Migration path:**
   - Remove old AsyncStorage code entirely (no migration needed - viewed state can reset)
   - Or optionally: migrate existing AsyncStorage data on first load

**Firestore security rules:**

```
match /users/{userId}/viewedPhotos/{photoId} {
  allow read, write: if request.auth != null && request.auth.uid == userId;
}
```

  </action>
  <verify>
1. Log in as User A, partially view some stories, log out
2. Log in as User B, view different stories, log out
3. Log back in as User A - should see User A's viewed state (not User B's)
4. Resume should work correctly for User A
  </verify>
  <done>Viewed stories persisted per-user in Firestore, resume works across sessions and devices</done>
</task>

<task type="auto">
  <name>Fix UAT-003: Rapid tapping and story transitions like Instagram</name>
  <files>src/components/PhotoDetailModal.js</files>
  <action>
Improve story navigation to match Instagram's look and feel.

**Requirements:**

1. **Photo-to-photo: Instant cut (no transitions)**
   - Remove any fade/slide animations between photos within same friend's story
   - Photo switch should be instantaneous - just swap the image
   - No opacity transitions, no translateX/Y animations

2. **Rapid tapping: Brief display of each photo**
   - When tapping rapidly, each photo should briefly flash/display before moving to next
   - User should see they're progressing through photos (not jumping to end)
   - Minimum display time per photo during rapid tap (e.g., 50-100ms)
   - This gives visual feedback that taps are registering

3. **Friend-to-friend: Cube/rotation transition**
   - When finishing one friend's story and moving to next friend, use Instagram-style 3D rotation
   - Current friend's story rotates out (like turning a cube face)
   - Next friend's story rotates in from the side
   - Use react-native-reanimated for 3D perspective transform
   - Transform: rotateY with perspective for cube effect

**Implementation:**

1. **Remove photo transition:**
   - Find any Animated.timing or transition on photo change
   - Replace with immediate state update (no animation)

2. **Add minimum display time:**
   - Track lastTapTime, ensure at least 50ms between photo advances
   - Or use requestAnimationFrame to ensure paint before next tap processes

3. **Cube transition for friend switch:**
   ```javascript
   // Outgoing friend: rotateY 0 -> -90deg
   // Incoming friend: rotateY 90deg -> 0
   // With perspective for 3D depth
   transform: [{ perspective: 1000 }, { rotateY: `${rotation}deg` }];
   ```

**Reference:** Instagram stories - instant photo cuts, cube rotation between friends
</action>
<verify>

1. Tap through photos - should be instant cuts, no fade
2. Tap rapidly - should briefly see each photo, not skip
3. Finish one friend's story - should rotate/cube to next friend
   </verify>
   <done>Photo navigation is instant cuts, rapid taps show each photo briefly, friend transitions use 3D cube rotation</done>
   </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed all 3 UAT issues: progress segments, resume consistency, rapid tap performance</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. Open app on device
    3. **Test segments:** Find friend with 10+ photos, open story, verify progress segments visible
    4. **Test resume:** Partially view 3 friends' stories, close each, reopen each - all should resume correctly
    5. **Test performance:** Rapidly tap through a long story - should feel smooth
  </how-to-verify>
  <resume-signal>Type "approved" or describe remaining issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] UAT-001 (segments) fixed - visible with any photo count
- [ ] UAT-002 (resume) fixed - consistent across all friends
- [ ] UAT-003 (performance) fixed - smooth rapid tapping
- [ ] No new regressions introduced
</verification>

<success_criteria>

- All UAT issues from 35.4-01-ISSUES.md addressed
- Stories experience feels polished and Instagram-like
- Ready for re-verification
  </success_criteria>

<output>
After completion, create `.planning/phases/35.4-stories-feed-data-resume-fix/35.4-01-FIX-SUMMARY.md`
</output>
