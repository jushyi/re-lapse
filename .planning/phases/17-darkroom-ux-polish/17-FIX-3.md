---
phase: 17-darkroom-ux-polish
plan: 17-FIX-3
type: fix
---

<objective>
Fix 2 remaining UAT issues from Phase 17 Darkroom UX Polish (Final UAT round).

Source: 17-ISSUES.md
Priority: 0 critical, 0 major, 1 minor, 1 cosmetic enhancement
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/17-darkroom-ux-polish/17-ISSUES.md

**Key files:**
@src/components/SwipeablePhotoCard.js
@src/screens/DarkroomScreen.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-010 - Card flashes gray before revealing during cascade</name>
  <files>src/components/SwipeablePhotoCard.js</files>
  <action>
**Issue:** When the top card is triaged and the next card cascades forward, it flashes gray for a moment before the image is visible. This creates janky appearance.

**Root cause:** React Native's Image component starts loading when the component mounts. When a stack card becomes the front card, the image may not be fully loaded in the Image component's cache, causing a brief gray placeholder.

**Fix approach:**

1. **Preload images for all visible stack cards:**
   In SwipeablePhotoCard, ensure the Image component has the image ready by:
   - Setting `fadeDuration={0}` on Android to disable default fade-in
   - The image should already be loaded since the card was rendered in the stack

2. **Add proper placeholder/loading handling:**
   - Add a `defaultSource` or background color that matches the expected content
   - Use the card's backgroundColor (`#2C2C2E`) as a fallback

3. **Track image load state:**
   - Add `const [imageLoaded, setImageLoaded] = useState(false)`
   - Set to `true` on Image `onLoad` callback
   - Keep the image opacity at 1 (images should already be cached from stack rendering)

4. **Key insight:** The gray flash is likely due to re-render timing. The stack card already has the image loaded, but when it becomes active, the re-render may cause a brief flash.

   Solution: Ensure the Image component uses proper caching:
   - Add `cachePolicy="memory-disk"` if using Expo Image
   - If using RN Image, ensure URI is stable and consistent

5. **Alternative fix if above doesn't work:**
   - Keep a second Image component that preloads the next photo
   - Use `Image.prefetch(nextPhoto.imageURL)` in DarkroomScreen for upcoming cards
  </action>
  <verify>
1. Open darkroom with 3+ photos
2. Triage the front card (swipe or button)
3. Watch the next card - should cascade smoothly WITHOUT gray flash
4. Image should be visible immediately as card moves to front
5. Repeat for all cards
  </verify>
  <done>No gray flash during cascade animation, images appear immediately</done>
</task>

<task type="auto">
  <name>Task 2: Implement UAT-011 - Blur background stack cards</name>
  <files>src/components/SwipeablePhotoCard.js</files>
  <action>
**Enhancement request:** Cards behind the main card should be slightly blurred, and when they come to the front they should fade in unblurred.

**Implementation approach:**

1. **Add blur overlay for stack cards:**
   - Create a semi-transparent blur overlay that sits on top of the photo for non-active cards
   - Use React Native's `blurRadius` prop on Image (simpler) OR
   - Use `expo-blur` BlurView component (more control)

2. **Using Image blurRadius (simpler approach):**
   ```jsx
   <Image
     source={{ uri: photo.imageURL }}
     style={styles.photoImage}
     blurRadius={isActive ? 0 : (stackIndex === 1 ? 2 : 4)}
   />
   ```
   - Front card (isActive): blurRadius = 0 (sharp)
   - Stack index 1: blurRadius = 2 (slight blur)
   - Stack index 2: blurRadius = 4 (more blur)

3. **Animate blur on cascade:**
   Unfortunately, `blurRadius` on Image is not animatable. Need alternative approach:

   **Better approach - opacity overlay:**
   - Add a frosted glass effect overlay on stack cards
   - Use a semi-transparent white/gray overlay that reduces visibility
   - Animate overlay opacity along with other stack animations

4. **Implementation with overlay (recommended):**
   - Add a `stackBlurOverlay` View on top of the image for stack cards
   - Style: semi-transparent dark overlay that simulates depth-of-field blur
   - Animate opacity: stackIndex 1 = 0.15, stackIndex 2 = 0.3
   - As card moves to front, overlay fades out with other stack animations

5. **Add to cardContent:**
   ```jsx
   {!isActive && (
     <Animated.View
       style={[
         styles.stackBlurOverlay,
         { opacity: stackBlurOpacityAnim }
       ]}
     />
   )}
   ```

6. **Add animated value:**
   - `stackBlurOpacityAnim` = stackIndex 1 ? 0.15 : stackIndex 2 ? 0.3 : 0
   - Animate in useEffect alongside other stack values
  </action>
  <verify>
1. Open darkroom with 3+ photos
2. Observe stack cards behind the front card
3. Verify they appear slightly dimmed/blurred compared to front card
4. Triage front card - watch next card become sharp as it moves forward
5. Blur/dim effect should animate smoothly during cascade
  </verify>
  <done>Stack cards have blur/dim effect, front card is sharp, smooth transition on cascade</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed gray flash during cascade (UAT-010) and added blur effect to background stack cards (UAT-011)</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. Navigate to Darkroom with 3+ photos

    **Test UAT-010 (Gray flash fix):**
    3. Triage the front card (swipe or button)
    4. Watch the next card cascade forward
    5. Verify NO gray flash - image should be visible immediately
    6. Repeat 2-3 times to confirm consistency

    **Test UAT-011 (Stack blur effect):**
    7. Look at the cards behind the front card
    8. Verify they appear slightly dimmed/blurred
    9. Triage front card and watch the blur fade as next card comes forward
    10. Verify front card is always sharp and clear
  </how-to-verify>
  <resume-signal>Type "approved" or describe any remaining issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] UAT-010: No gray flash during cascade animation
- [ ] UAT-011: Background stack cards have blur/dim effect
- [ ] Blur animates smoothly during cascade
- [ ] Front card always appears sharp
- [ ] All existing swipe/button functionality still works
- [ ] App builds without errors
</verification>

<success_criteria>
- All 2 remaining UAT issues from 17-ISSUES.md addressed
- Smooth visual experience during card transitions
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/17-darkroom-ux-polish/17-FIX-3-SUMMARY.md`

Update 17-ISSUES.md to move fixed issues to "Resolved Issues" section.
</output>
