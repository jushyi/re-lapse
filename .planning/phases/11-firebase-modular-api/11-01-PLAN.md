---
phase: 11-firebase-modular-api
plan: 01
type: execute
---

<objective>
Migrate core photo and darkroom services from namespaced to modular Firestore API.

Purpose: Eliminate deprecation warnings by adopting React Native Firebase v22+ modular patterns, starting with the most heavily-used services.
Output: photoService.js and darkroomService.js using modular imports (getFirestore, collection, doc, etc.)
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-firestore-services-migration/09-02-SUMMARY.md
@.planning/phases/10-storage-migration-cleanup/10-02-SUMMARY.md
@src/services/firebase/photoService.js
@src/services/firebase/darkroomService.js

**Migration Pattern Reference:**

The namespaced API:
```javascript
import firestore from '@react-native-firebase/firestore';
firestore().collection('photos').doc(id).get()
firestore.FieldValue.serverTimestamp()
firestore.Timestamp.now()
```

Becomes modular API:
```javascript
import { getFirestore, collection, doc, getDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, Timestamp } from '@react-native-firebase/firestore';
const db = getFirestore();
getDoc(doc(db, 'photos', id))
serverTimestamp()
Timestamp.now()
```

**Key patterns:**
- `firestore()` → `getFirestore()` (call once, reuse instance)
- `firestore().collection(x).doc(y)` → `doc(db, x, y)`
- `firestore().collection(x)` → `collection(db, x)`
- `ref.get()` → `getDoc(ref)`
- `ref.add(data)` → `addDoc(collectionRef, data)`
- `ref.set(data)` → `setDoc(ref, data)`
- `ref.update(data)` → `updateDoc(ref, data)`
- `ref.delete()` → `deleteDoc(ref)`
- `firestore.FieldValue.serverTimestamp()` → `serverTimestamp()`
- `firestore.Timestamp.now()` → `Timestamp.now()`
- `firestore.Timestamp.fromDate(d)` → `Timestamp.fromDate(d)`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate photoService.js to modular Firestore API</name>
  <files>src/services/firebase/photoService.js</files>
  <action>
Transform all Firestore operations to modular API pattern:

1. Update imports:
   - Remove: `import firestore from '@react-native-firebase/firestore'`
   - Add: `import { getFirestore, collection, doc, addDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where, orderBy, serverTimestamp, Timestamp } from '@react-native-firebase/firestore'`

2. Initialize Firestore once at module level:
   - Add: `const db = getFirestore();`

3. Transform each function:

   **createPhoto:**
   - `firestore().collection('photos').add(data)` → `addDoc(collection(db, 'photos'), data)`
   - `firestore.FieldValue.serverTimestamp()` → `serverTimestamp()`
   - `photoRef.update(data)` → `updateDoc(photoRef, data)`
   - `photoRef.delete()` → `deleteDoc(photoRef)`

   **getDevelopingPhotos:**
   - `firestore().collection('photos').where(...).get()` → `getDocs(query(collection(db, 'photos'), where(...)))`

   **getRevealedPhotos:**
   - Same pattern as getDevelopingPhotos

   **getDarkroomPhotoCount:**
   - Same pattern, update both developing and revealed queries

   **subscribeToDarkroomCount:**
   - `firestore().collection(...).onSnapshot()` → Keep onSnapshot attached to query result
   - NOTE: For real-time listeners, create query with `query(collection(db, 'photos'), where(...))` then call `.onSnapshot()` on the query

   **getDevelopingPhotosByMonth:**
   - Same query pattern transformation

   **triagePhoto:**
   - `firestore().collection('photos').doc(id)` → `doc(db, 'photos', id)`
   - `photoRef.get()` → `getDoc(photoRef)`
   - Check `docSnap.exists` (it's a property in modular API, not function)
   - `photoRef.update(data)` → `updateDoc(photoRef, data)`

   **revealPhoto:**
   - Same pattern as triagePhoto

   **deletePhotoDocument:**
   - `firestore().collection('photos').doc(id)` → `doc(db, 'photos', id)`
   - `ref.delete()` → `deleteDoc(ref)`

4. IMPORTANT: For `exists` check, modular API returns boolean property directly:
   - Old: `doc.exists()` or `doc.exists` (version-dependent)
   - New: `docSnap.exists` (always property)

Keep all logging, error handling, and return patterns identical.
  </action>
  <verify>Run the app, capture a photo, verify it saves to Firestore with no deprecation warnings in console</verify>
  <done>photoService.js uses only modular imports, all CRUD operations functional, no namespaced API usage</done>
</task>

<task type="auto">
  <name>Task 2: Migrate darkroomService.js to modular Firestore API</name>
  <files>src/services/firebase/darkroomService.js</files>
  <action>
Transform all Firestore operations to modular API pattern:

1. Update imports:
   - Remove: `import firestore from '@react-native-firebase/firestore'`
   - Add: `import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, Timestamp } from '@react-native-firebase/firestore'`

2. Initialize Firestore once at module level:
   - Add: `const db = getFirestore();`

3. Transform each function:

   **getDarkroom:**
   - `firestore().collection('darkrooms').doc(userId)` → `doc(db, 'darkrooms', userId)`
   - `darkroomRef.get()` → `getDoc(darkroomRef)`
   - `firestore.Timestamp.now()` → `Timestamp.now()`
   - `darkroomRef.set(data)` → `setDoc(darkroomRef, data)`
   - Update exists check: `docSnap.exists` (property)

   **isDarkroomReadyToReveal:**
   - `firestore.Timestamp.now()` → `Timestamp.now()`
   - No other Firestore calls (uses getDarkroom)

   **scheduleNextReveal:**
   - `firestore().collection('darkrooms').doc(userId)` → `doc(db, 'darkrooms', userId)`
   - `firestore.FieldValue.serverTimestamp()` → `serverTimestamp()`
   - `darkroomRef.update(data)` → `updateDoc(darkroomRef, data)`

   **calculateNextRevealTime:**
   - `firestore.Timestamp.fromDate(d)` → `Timestamp.fromDate(d)`

Keep all logging, error handling, and return patterns identical.
  </action>
  <verify>Run the app, check darkroom badge count updates correctly, verify reveal scheduling works</verify>
  <done>darkroomService.js uses only modular imports, all darkroom operations functional, no namespaced API usage</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm start` runs without errors
- [ ] No "This method is deprecated" warnings for Firestore operations in photoService or darkroomService
- [ ] Photo capture works: creates photo document, uploads to storage, updates with URL
- [ ] Darkroom count badge shows correct count
- [ ] Photo reveal flow works (if photos ready)
- [ ] Photo triage (Archive/Journal) works
</verification>

<success_criteria>

- Both photoService.js and darkroomService.js use modular imports only
- All Firestore operations converted: collection, doc, get, add, set, update, delete
- FieldValue operations converted: serverTimestamp, Timestamp
- No regressions in camera/darkroom functionality
- Deprecation warnings eliminated for these services
  </success_criteria>

<output>
After completion, create `.planning/phases/11-firebase-modular-api/11-01-SUMMARY.md`
</output>
