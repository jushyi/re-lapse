---
phase: 11-firebase-modular-api
plan: 04
type: execute
---

<objective>
Migrate screens and components from namespaced to modular Firestore API.

Purpose: Complete Phase 11 by migrating remaining files with direct Firestore queries.
Output: All screens and components using modular Firestore imports, deprecation warnings eliminated.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-firebase-modular-api/11-03-SUMMARY.md
@src/context/AuthContext.js
@src/screens/ProfileScreen.js
@src/screens/UserSearchScreen.js
@src/screens/FriendsListScreen.js
@src/components/FriendRequestCard.js

**Modular Pattern (established in 11-01 through 11-03):**
```javascript
import { getFirestore, collection, doc, getDoc, getDocs, query, where, orderBy } from '@react-native-firebase/firestore';
const db = getFirestore();

// Queries
getDocs(query(collection(db, 'users'), where('username', '>=', term)))
getDoc(doc(db, 'users', userId))
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate AuthContext.js to fully modular API</name>
  <files>src/context/AuthContext.js</files>
  <action>
AuthContext already uses modular auth imports, but still uses namespaced Firestore:

1. Update imports:
   - Keep: `import { getAuth, onAuthStateChanged as firebaseOnAuthStateChanged } from '@react-native-firebase/auth'`
   - Remove: `import firestore from '@react-native-firebase/firestore'`
   - Add: `import { getFirestore, doc, getDoc, onSnapshot } from '@react-native-firebase/firestore'`

2. Initialize Firestore:
   - Add: `const db = getFirestore();`

3. Transform Firestore operations:

   Look for patterns like:
   - `firestore().collection('users').doc(userId)` → `doc(db, 'users', userId)`
   - `userRef.get()` → `getDoc(userRef)`
   - `firestore().collection('users').doc(userId).onSnapshot()` → `onSnapshot(doc(db, 'users', userId), callback)`

   Update exists check: use `docSnap.exists` (property)

Keep all auth logic, state management, and error handling identical.
  </action>
  <verify>Sign out and sign back in, verify auth flow works and user profile loads</verify>
  <done>AuthContext.js uses fully modular imports for both Auth and Firestore</done>
</task>

<task type="auto">
  <name>Task 2: Migrate screen and component files to modular Firestore API</name>
  <files>src/screens/ProfileScreen.js, src/screens/UserSearchScreen.js, src/screens/FriendsListScreen.js, src/components/FriendRequestCard.js</files>
  <action>
Migrate all 4 files with direct Firestore queries:

**ProfileScreen.js:**

1. Update imports:
   - Remove: `import firestore from '@react-native-firebase/firestore'`
   - Add: `import { getFirestore, collection, doc, getDoc, getDocs, query, where } from '@react-native-firebase/firestore'`

2. Add: `const db = getFirestore();`

3. Transform:
   - `firestore().collection('users').doc(userId).get()` → `getDoc(doc(db, 'users', userId))`
   - Any collection queries → `getDocs(query(collection(db, 'collectionName'), where(...)))`

---

**UserSearchScreen.js:**

1. Update imports:
   - Remove: `import firestore from '@react-native-firebase/firestore'`
   - Add: `import { getFirestore, collection, getDocs, query, where, orderBy, limit } from '@react-native-firebase/firestore'`

2. Add: `const db = getFirestore();`

3. Transform search query:
   - `firestore().collection('users').where('username', '>=', term).where('username', '<=', term + '\uf8ff').limit(20).get()` →
     `getDocs(query(collection(db, 'users'), where('username', '>=', term), where('username', '<=', term + '\uf8ff'), limit(20)))`

---

**FriendsListScreen.js:**

1. Update imports:
   - Remove: `import firestore from '@react-native-firebase/firestore'`
   - Add: `import { getFirestore, doc, getDoc } from '@react-native-firebase/firestore'`

2. Add: `const db = getFirestore();`

3. Transform:
   - `firestore().collection('users').doc(userId).get()` → `getDoc(doc(db, 'users', userId))`

---

**FriendRequestCard.js:**

1. Update imports:
   - Remove: `import firestore from '@react-native-firebase/firestore'`
   - Add: `import { getFirestore, doc, getDoc } from '@react-native-firebase/firestore'`

2. Add: `const db = getFirestore();`

3. Transform:
   - `firestore().collection('users').doc(userId).get()` → `getDoc(doc(db, 'users', userId))`

For all files:
- Update exists check: use `docSnap.exists` (property)
- Keep all UI, state management, and error handling identical
  </action>
  <verify>Test Profile screen loads, user search works, friends list displays, friend request cards render correctly</verify>
  <done>All 4 files use modular imports, no namespaced Firestore usage in any screen or component</done>
</task>

<task type="auto">
  <name>Task 3: Verify complete migration and update index exports</name>
  <files>src/services/firebase/index.js</files>
  <action>
1. Check src/services/firebase/index.js for any remaining namespaced imports or exports

2. Search entire src/ directory for any remaining namespaced patterns:
   - `import firestore from` (should find 0)
   - `import storage from` (should find 0)
   - `firestore()` calls (should find 0)
   - `storage()` calls (should find 0)

3. If any remain, migrate them following established patterns

4. Run the app and check Metro bundler logs for any deprecation warnings:
   - "This method is deprecated and will be removed"
   - Should see NONE related to Firestore or Storage

5. Test core flows:
   - Sign in → Profile loads
   - Camera → Capture photo → Saves to darkroom
   - Darkroom → Badge count → Reveal photos
   - Feed → Load photos → React to photo
   - Friends → Search users → Send/accept request

Document any remaining warnings (if from other Firebase modules like Analytics) for future phases.
  </action>
  <verify>No deprecation warnings in console, all features work end-to-end</verify>
  <done>Complete audit passed, no namespaced API usage remains, Phase 11 migration complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm start` runs without errors
- [ ] grep for `import firestore from` returns 0 results in src/
- [ ] grep for `import storage from` returns 0 results in src/
- [ ] grep for `firestore()` returns 0 results in src/
- [ ] grep for `storage()` returns 0 results in src/
- [ ] No "This method is deprecated" warnings in console for Firestore/Storage
- [ ] Auth flow works (sign in, sign out)
- [ ] Profile screen loads user data
- [ ] User search works
- [ ] Friend requests work
- [ ] Friends list displays correctly
</verification>

<success_criteria>

- All 5 files migrated to modular imports
- Zero namespaced API patterns remain in codebase
- All features work end-to-end
- Deprecation warnings eliminated
- Phase 11: Firebase Modular API Migration complete
  </success_criteria>

<output>
After completion, create `.planning/phases/11-firebase-modular-api/11-04-SUMMARY.md`

**Phase 11 Complete:**
Update STATE.md:
- Phase: 12 of 14
- Status: Ready to plan

Update ROADMAP.md:
- Mark Phase 11 complete with plan counts
</output>
