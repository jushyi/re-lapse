---
phase: 11-firebase-modular-api
plan: 03
type: execute
---

<objective>
Migrate storage, user, and notification services from namespaced to modular Firebase API.

Purpose: Complete service layer migration including Storage module (different from Firestore).
Output: storageService.js, userService.js, and notificationService.js using modular imports.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-firebase-modular-api/11-02-SUMMARY.md
@src/services/firebase/storageService.js
@src/services/firebase/userService.js
@src/services/firebase/notificationService.js

**Firestore Modular Pattern (from 11-01, 11-02):**
```javascript
import { getFirestore, doc, getDoc, setDoc, updateDoc } from '@react-native-firebase/firestore';
const db = getFirestore();
```

**Storage Modular Pattern:**
```javascript
// Namespaced
import storage from '@react-native-firebase/storage';
storage().ref('path/file.jpg').putFile(localPath)
storage().ref('path/file.jpg').getDownloadURL()
storage().ref('path/file.jpg').delete()

// Modular
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from '@react-native-firebase/storage';
const storageInstance = getStorage();
// BUT: putFile is RN Firebase specific, check if modular API supports it
```

**NOTE:** React Native Firebase storage uses putFile() for native file uploads which is different from web SDK's uploadBytes(). Verify the modular pattern for RN-specific methods.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate storageService.js to modular Storage API</name>
  <files>src/services/firebase/storageService.js</files>
  <action>
Transform Storage operations to modular API pattern:

1. Update imports:
   - Remove: `import storage from '@react-native-firebase/storage'`
   - Add: `import { getStorage, ref } from '@react-native-firebase/storage'`

   NOTE: For React Native Firebase, the modular API may still use putFile() on the reference object. Check the API:
   - If putFile exists on ref result: `const storageRef = ref(storageInstance, 'path'); await storageRef.putFile(localPath)`
   - The key change is `storage()` → `getStorage()` and `storage().ref(path)` → `ref(getStorage(), path)`

2. Initialize Storage once at module level:
   - Add: `const storageInstance = getStorage();`

3. Transform each function:

   **uploadProfilePhoto:**
   - `storage().ref(\`profile_photos/${userId}.jpg\`)` → `ref(storageInstance, \`profile_photos/${userId}.jpg\`)`
   - `storageRef.putFile(filePath)` → stays `storageRef.putFile(filePath)` (RN-specific method)
   - `storageRef.getDownloadURL()` → stays `storageRef.getDownloadURL()` (method on ref)

   OR if fully modular:
   - `getDownloadURL(storageRef)` (function import)

   **uploadPhoto:**
   - Same pattern as uploadProfilePhoto

   **deleteProfilePhoto:**
   - `storage().ref(path)` → `ref(storageInstance, path)`
   - `storageRef.delete()` → `deleteObject(storageRef)` if fully modular, or stays `storageRef.delete()`

   **deletePhoto:**
   - Same pattern as deleteProfilePhoto

   **getPhotoURL:**
   - `storage().ref(path)` → `ref(storageInstance, path)`
   - `storageRef.getDownloadURL()` → stays same or `getDownloadURL(storageRef)`

IMPORTANT: RN Firebase storage modular API may differ from web SDK. The key transformation is:
- `storage()` → `getStorage()`
- `storage().ref(path)` → `ref(getStorage(), path)`

Method calls on the reference (putFile, getDownloadURL, delete) may stay as methods or become standalone functions. Test to verify which works.

Keep all logging, error handling, compression logic, and return patterns identical.
  </action>
  <verify>Run the app, capture a photo, verify upload works. Update profile photo, verify upload works.</verify>
  <done>storageService.js uses modular imports (getStorage, ref), all upload/download/delete operations functional</done>
</task>

<task type="auto">
  <name>Task 2: Migrate userService.js and notificationService.js to modular Firestore API</name>
  <files>src/services/firebase/userService.js, src/services/firebase/notificationService.js</files>
  <action>
Transform both services (both have light Firestore usage):

**userService.js:**

1. Update imports:
   - Remove: `import firestore from '@react-native-firebase/firestore'`
   - Add: `import { getFirestore, doc, getDoc, setDoc } from '@react-native-firebase/firestore'`

2. Initialize Firestore:
   - Add: `const db = getFirestore();`

3. Transform functions:

   **createUserProfile:**
   - `firestore().collection('users').doc(userId)` → `doc(db, 'users', userId)`
   - `userRef.set(data)` → `setDoc(userRef, data)`

   **getUserProfile:**
   - `firestore().collection('users').doc(userId)` → `doc(db, 'users', userId)`
   - `userRef.get()` → `getDoc(userRef)`
   - Update exists check: use `docSnap.exists` (property)

---

**notificationService.js:**

1. Update imports:
   - Remove: `import firestore from '@react-native-firebase/firestore'`
   - Add: `import { getFirestore, doc, updateDoc } from '@react-native-firebase/firestore'`

2. Initialize Firestore:
   - Add: `const db = getFirestore();`

3. Transform functions:

   **storeNotificationToken:**
   - `firestore().collection('users').doc(userId).update(data)` → `updateDoc(doc(db, 'users', userId), data)`

Keep all logging, error handling, and return patterns identical.
  </action>
  <verify>Create new account or update profile, verify userService works. Check notification token storage in Firestore.</verify>
  <done>userService.js and notificationService.js use modular imports, profile and notification token operations functional</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm start` runs without errors
- [ ] No "This method is deprecated" warnings for Storage or Firestore in these services
- [ ] Photo upload works (uses storageService)
- [ ] Profile photo upload works (uses storageService)
- [ ] User profile creation/retrieval works (userService)
- [ ] Notification token storage works (notificationService)
</verification>

<success_criteria>

- storageService.js uses modular imports (getStorage, ref)
- userService.js uses modular Firestore imports
- notificationService.js uses modular Firestore imports
- All storage operations (upload, download URL, delete) work
- User profile CRUD operations work
- Notification token storage works
- Deprecation warnings eliminated for these services
  </success_criteria>

<output>
After completion, create `.planning/phases/11-firebase-modular-api/11-03-SUMMARY.md`
</output>
