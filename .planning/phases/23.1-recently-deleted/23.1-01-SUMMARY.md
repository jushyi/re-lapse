---
phase: 23.1-recently-deleted
plan: 01
subsystem: database, api
tags: [soft-delete, cloud-functions, firestore, scheduled-tasks]

# Dependency graph
requires:
  - phase: 23
    provides: Photo deletion cascade logic (deletePhotoCompletely)
  - phase: 19
    provides: Scheduled deletion pattern (scheduledForDeletionAt, daily cron)
provides:
  - Soft delete infrastructure for photos
  - softDeletePhoto, restoreDeletedPhoto, getDeletedPhotos, permanentlyDeletePhoto exports
  - processScheduledPhotoDeletions Cloud Function (3:15 AM UTC daily)
  - Composite index for photo state + deletion timestamp query
affects: [23.1-02-recently-deleted-ui]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'Soft delete with 30-day grace period'
    - 'Scheduled Cloud Function cleanup at 3:15 AM UTC'
    - 'FieldValue.delete() for clearing optional fields'

key-files:
  created: []
  modified:
    - src/services/firebase/photoService.js
    - functions/index.js
    - firestore.indexes.json

key-decisions:
  - '3:15 AM UTC schedule offset from account deletion (3 AM) to avoid resource contention'
  - 'Refactored deletePhotoCompletely into internal cascadeDeletePhoto function'
  - 'softDeletePhoto separate from triagePhoto for different UI contexts'

patterns-established:
  - "photoState: 'deleted' for soft-deleted photos"
  - 'scheduledForPermanentDeletionAt + deletionScheduledAt fields for grace period'
  - 'cascadeDeletePhoto as internal cascade function'

issues-created: []

# Metrics
duration: 4min
completed: 2026-02-05
---

# Phase 23.1 Plan 01: Soft Delete Infrastructure Summary

**Soft delete methods in photoService with 30-day grace period and scheduled Cloud Function cleanup**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-05T14:18:08Z
- **Completed:** 2026-02-05T14:22:16Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments

- Modified triagePhoto to set soft delete fields instead of immediate deletion
- Added softDeletePhoto, restoreDeletedPhoto, getDeletedPhotos, permanentlyDeletePhoto exports
- Added processScheduledPhotoDeletions Cloud Function (3:15 AM UTC daily)
- Added composite Firestore index for photoState + scheduledForPermanentDeletionAt

## Task Commits

Each task was committed atomically:

1. **Task 1: Add soft delete methods to photoService** - `7bc1adc` (feat)
2. **Task 2: Add scheduled photo deletion Cloud Function** - `8686cee` (feat)

**Plan metadata:** (this commit)

## Files Created/Modified

- `src/services/firebase/photoService.js` - Added soft delete infrastructure:
  - Modified triagePhoto delete action to set soft delete fields
  - Added softDeletePhoto, restoreDeletedPhoto, getDeletedPhotos, permanentlyDeletePhoto
  - Refactored deletePhotoCompletely into internal cascadeDeletePhoto
- `functions/index.js` - Added processScheduledPhotoDeletions Cloud Function
- `firestore.indexes.json` - Added composite index for deletion query

## Decisions Made

- **3:15 AM UTC schedule**: Offset from account deletion (3 AM) to avoid resource contention
- **Separate softDeletePhoto function**: Different from triagePhoto for PhotoDetailScreen/Album menu contexts
- **Internal cascadeDeletePhoto**: Refactored from deletePhotoCompletely for reuse by permanentlyDeletePhoto and Cloud Function

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## Next Phase Readiness

- Soft delete infrastructure complete, ready for UI layer (Plan 02)
- Note: Composite index needs to be deployed to Firebase before Cloud Function can be tested

---

_Phase: 23.1-recently-deleted_
_Completed: 2026-02-05_
