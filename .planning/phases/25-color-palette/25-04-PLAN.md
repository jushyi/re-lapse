---
phase: 25-color-palette
plan: 04
type: execute
domain: react-native
teaching: true
---

<objective>
Create custom palette editor allowing users to customize 5 theme colors.

Purpose: Enable users to create their own personalized color theme.
Output: CustomThemeEditorScreen with color pickers for all 5 theme colors, save/reset functionality.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-color-palette/25-CONTEXT.md
@src/context/ThemeContext.js
@src/constants/themes.js
@src/screens/AppearanceSettingsScreen.js
@.planning/phases/25-color-palette/25-03-SUMMARY.md (if exists)

**Current State:**

- AppearanceSettingsScreen has "Create Custom Theme" button
- ThemeContext can apply themes
- Need to add custom theme storage

**This Plan Creates:**

- Color picker component/integration
- CustomThemeEditorScreen with 5 color pickers
- Custom theme persistence in AsyncStorage
- Reset to defaults functionality
  </context>

<learning_objectives>
By the end of this plan, you will:

1. Install and use a third-party React Native library
2. Build a form-like UI with multiple inputs
3. Implement custom data persistence with AsyncStorage
4. Handle complex state (multiple color values)
   </learning_objectives>

<tasks>

<task type="auto">
  <name>Task 1: Install color picker library and create color picker component</name>
  <files>package.json, src/components/ColorPickerRow.js</files>
  <action>
**Install a color picker library for React Native.**

**Option 1 (Recommended): react-native-wheel-color-picker**

```bash
npm install react-native-wheel-color-picker
```

Simple wheel-based color picker, works with Expo.

**Option 2: reanimated-color-picker**

```bash
npm install reanimated-color-picker
```

More modern, requires react-native-reanimated (already installed).

**Create a wrapper component for consistent usage:**

```javascript
// src/components/ColorPickerRow.js
import React, { useState } from 'react';
import { View, Text, TouchableOpacity, Modal, StyleSheet } from 'react-native';
import ColorPicker from 'react-native-wheel-color-picker';
import { colors } from '../constants/colors';

/**
 * A row component showing a color label and swatch
 * Tapping opens a modal with color picker
 */
const ColorPickerRow = ({ label, color, onColorChange }) => {
  const [modalVisible, setModalVisible] = useState(false);
  const [tempColor, setTempColor] = useState(color);

  const handleConfirm = () => {
    onColorChange(tempColor);
    setModalVisible(false);
  };

  const handleCancel = () => {
    setTempColor(color); // Reset to original
    setModalVisible(false);
  };

  return (
    <View style={styles.row}>
      <Text style={styles.label}>{label}</Text>

      <TouchableOpacity
        style={[styles.swatch, { backgroundColor: color }]}
        onPress={() => setModalVisible(true)}
      />

      <Modal visible={modalVisible} transparent animationType="fade" onRequestClose={handleCancel}>
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>Choose {label}</Text>

            <ColorPicker
              color={tempColor}
              onColorChangeComplete={color => setTempColor(color)}
              thumbSize={30}
              sliderSize={30}
              noSnap={true}
              row={false}
            />

            <View style={styles.buttonRow}>
              <TouchableOpacity style={styles.cancelButton} onPress={handleCancel}>
                <Text style={styles.cancelText}>Cancel</Text>
              </TouchableOpacity>
              <TouchableOpacity style={styles.confirmButton} onPress={handleConfirm}>
                <Text style={styles.confirmText}>Confirm</Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>
    </View>
  );
};

const styles = StyleSheet.create({
  row: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingVertical: 16,
    borderBottomWidth: 1,
    borderBottomColor: colors.border.subtle,
  },
  label: {
    color: colors.text.primary,
    fontSize: 16,
  },
  swatch: {
    width: 40,
    height: 40,
    borderRadius: 8,
    borderWidth: 2,
    borderColor: colors.border.subtle,
  },
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.8)',
    justifyContent: 'center',
    padding: 20,
  },
  modalContent: {
    backgroundColor: colors.background.card,
    borderRadius: 16,
    padding: 20,
  },
  modalTitle: {
    color: colors.text.primary,
    fontSize: 18,
    fontWeight: '600',
    marginBottom: 20,
    textAlign: 'center',
  },
  buttonRow: {
    flexDirection: 'row',
    marginTop: 20,
    gap: 12,
  },
  cancelButton: {
    flex: 1,
    padding: 14,
    borderRadius: 8,
    backgroundColor: colors.background.tertiary,
    alignItems: 'center',
  },
  cancelText: {
    color: colors.text.secondary,
    fontSize: 16,
  },
  confirmButton: {
    flex: 1,
    padding: 14,
    borderRadius: 8,
    backgroundColor: colors.interactive.primary,
    alignItems: 'center',
  },
  confirmText: {
    color: colors.text.primary,
    fontSize: 16,
    fontWeight: '600',
  },
});

export default ColorPickerRow;
```

**Learning point - Library selection:**
When choosing a library, consider:

- Expo compatibility (check "expo" in README or issues)
- Bundle size (smaller is better)
- Maintenance status (recent updates)
- API simplicity

For color pickers in Expo, wheel-based pickers generally work better than native ones.
</action>
<verify>

1. npm install completes without errors
2. App builds and runs
3. ColorPickerRow component created
4. Import works in test file
   </verify>
   <done>Color picker library installed, ColorPickerRow component created</done>
   </task>

<task type="auto">
  <name>Task 2: Create CustomThemeEditorScreen</name>
  <files>src/screens/CustomThemeEditorScreen.js</files>
  <action>
**Create the custom theme editor screen.**

**Screen layout:**

```
┌─────────────────────────────┐
│  < Custom Theme             │
├─────────────────────────────┤
│                             │
│  ┌───────────────────────┐ │
│  │     Live Preview      │ │  <- Shows how theme looks
│  │   (mini app mockup)   │ │
│  └───────────────────────┘ │
│                             │
│  Background         [████] │  <- ColorPickerRow for each
│  Card               [████] │
│  Text               [████] │
│  Accent             [████] │
│  Accent Secondary   [████] │
│                             │
│  ┌─────────────────────┐   │
│  │   Reset to Default   │   │  <- Reset button
│  └─────────────────────┘   │
│                             │
│  ┌─────────────────────┐   │
│  │    Save Theme        │   │  <- Save button
│  └─────────────────────┘   │
│                             │
└─────────────────────────────┘
```

**Implementation:**

```javascript
import React, { useState, useEffect } from 'react';
import { View, Text, ScrollView, TouchableOpacity, StyleSheet } from 'react-native';
import { useNavigation } from '@react-navigation/native';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { useTheme } from '../context/ThemeContext';
import ColorPickerRow from '../components/ColorPickerRow';
import { colors } from '../constants/colors';
import { THEMES } from '../constants/themes';

const CUSTOM_THEME_KEY = '@rewind_custom_theme';

// Default custom theme starts as copy of dark theme
const DEFAULT_CUSTOM_COLORS = { ...THEMES.dark.colors };

const CustomThemeEditorScreen = () => {
  const navigation = useNavigation();
  const { setTheme, setCustomTheme } = useTheme();

  const [customColors, setCustomColors] = useState(DEFAULT_CUSTOM_COLORS);
  const [hasChanges, setHasChanges] = useState(false);

  // Load saved custom theme on mount
  useEffect(() => {
    loadCustomTheme();
  }, []);

  const loadCustomTheme = async () => {
    try {
      const saved = await AsyncStorage.getItem(CUSTOM_THEME_KEY);
      if (saved) {
        setCustomColors(JSON.parse(saved));
      }
    } catch (error) {
      console.warn('Failed to load custom theme:', error);
    }
  };

  const updateColor = (key, value) => {
    setCustomColors(prev => ({ ...prev, [key]: value }));
    setHasChanges(true);
  };

  const handleReset = () => {
    setCustomColors(DEFAULT_CUSTOM_COLORS);
    setHasChanges(true);
  };

  const handleSave = async () => {
    try {
      await AsyncStorage.setItem(CUSTOM_THEME_KEY, JSON.stringify(customColors));
      // Apply the custom theme
      setCustomTheme(customColors);
      navigation.goBack();
    } catch (error) {
      console.error('Failed to save custom theme:', error);
    }
  };

  // Mini preview component showing the theme
  const ThemePreview = () => (
    <View style={[styles.preview, { backgroundColor: customColors.background }]}>
      <View style={[styles.previewCard, { backgroundColor: customColors.card }]}>
        <Text style={[styles.previewText, { color: customColors.text }]}>Preview Text</Text>
        <View style={styles.previewButtonRow}>
          <View style={[styles.previewButton, { backgroundColor: customColors.accent }]} />
          <View style={[styles.previewButton, { backgroundColor: customColors.accentSecondary }]} />
        </View>
      </View>
    </View>
  );

  return (
    <View style={styles.container}>
      <ScrollView contentContainerStyle={styles.content}>
        <ThemePreview />

        <View style={styles.section}>
          <Text style={styles.sectionTitle}>Colors</Text>

          <ColorPickerRow
            label="Background"
            color={customColors.background}
            onColorChange={color => updateColor('background', color)}
          />
          <ColorPickerRow
            label="Card"
            color={customColors.card}
            onColorChange={color => updateColor('card', color)}
          />
          <ColorPickerRow
            label="Text"
            color={customColors.text}
            onColorChange={color => updateColor('text', color)}
          />
          <ColorPickerRow
            label="Accent"
            color={customColors.accent}
            onColorChange={color => updateColor('accent', color)}
          />
          <ColorPickerRow
            label="Accent Secondary"
            color={customColors.accentSecondary}
            onColorChange={color => updateColor('accentSecondary', color)}
          />
        </View>

        <TouchableOpacity style={styles.resetButton} onPress={handleReset}>
          <Text style={styles.resetText}>Reset to Default</Text>
        </TouchableOpacity>
      </ScrollView>

      {hasChanges && (
        <TouchableOpacity style={styles.saveButton} onPress={handleSave}>
          <Text style={styles.saveText}>Save Theme</Text>
        </TouchableOpacity>
      )}
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: colors.background.primary,
  },
  content: {
    padding: 16,
  },
  preview: {
    height: 150,
    borderRadius: 12,
    padding: 16,
    marginBottom: 24,
  },
  previewCard: {
    flex: 1,
    borderRadius: 8,
    padding: 12,
    justifyContent: 'center',
  },
  previewText: {
    fontSize: 16,
    marginBottom: 12,
  },
  previewButtonRow: {
    flexDirection: 'row',
    gap: 8,
  },
  previewButton: {
    width: 60,
    height: 30,
    borderRadius: 6,
  },
  section: {
    marginBottom: 24,
  },
  sectionTitle: {
    color: colors.text.primary,
    fontSize: 18,
    fontWeight: '600',
    marginBottom: 16,
  },
  resetButton: {
    padding: 14,
    borderRadius: 8,
    backgroundColor: colors.background.tertiary,
    alignItems: 'center',
    marginTop: 12,
  },
  resetText: {
    color: colors.text.secondary,
    fontSize: 16,
  },
  saveButton: {
    position: 'absolute',
    bottom: 40,
    left: 16,
    right: 16,
    padding: 16,
    borderRadius: 12,
    backgroundColor: colors.interactive.primary,
    alignItems: 'center',
  },
  saveText: {
    color: colors.text.primary,
    fontSize: 16,
    fontWeight: '600',
  },
});

export default CustomThemeEditorScreen;
```

**Note:** This requires adding `setCustomTheme` to ThemeContext (next task).
</action>
<verify>

1. Screen renders without errors
2. All 5 color rows display
3. Preview updates when colors change
4. Save button only appears when changes made
   </verify>
   <done>CustomThemeEditorScreen created with color pickers and preview</done>
   </task>

<task type="auto">
  <name>Task 3: Add custom theme support to ThemeContext</name>
  <files>src/context/ThemeContext.js, src/constants/themes.js, src/navigation/AppNavigator.js</files>
  <action>
**Update ThemeContext to support custom themes.**

**1. Add custom theme to THEMES in themes.js:**

```javascript
// At the end of THEMES object:
custom: {
  id: 'custom',
  name: 'Custom',
  description: 'Your personalized theme',
  isCustom: true,
  colors: {
    // These will be overridden by user's saved colors
    background: '#000000',
    card: '#111111',
    text: '#FFFFFF',
    accent: '#8B5CF6',
    accentSecondary: '#EC4899',
  },
},
```

**2. Add setCustomTheme to ThemeContext:**

```javascript
const CUSTOM_THEME_KEY = '@rewind_custom_theme';

// In ThemeProvider:
const [customColors, setCustomColors] = useState(null);

// Load custom colors on mount
useEffect(() => {
  const loadCustomColors = async () => {
    try {
      const saved = await AsyncStorage.getItem(CUSTOM_THEME_KEY);
      if (saved) {
        setCustomColors(JSON.parse(saved));
      }
    } catch (error) {
      logger.warn('Failed to load custom colors:', error);
    }
  };
  loadCustomColors();
}, []);

// Function to set and apply custom theme
const setCustomTheme = async colors => {
  setCustomColors(colors);
  setCurrentThemeId('custom');
  try {
    await AsyncStorage.setItem(CUSTOM_THEME_KEY, JSON.stringify(colors));
    await AsyncStorage.setItem(THEME_STORAGE_KEY, 'custom');
  } catch (error) {
    logger.warn('Failed to save custom theme:', error);
  }
};

// Update theme building to use custom colors when custom theme selected
const currentTheme = getTheme(currentThemeId);
const themeColors =
  currentThemeId === 'custom' && customColors ? customColors : currentTheme.colors;

const theme = {
  id: currentTheme.id,
  name: currentTheme.name,
  colors: themeColors,
  // ... rest of theme building
};

// Add to context value:
const value = {
  // ... existing
  setCustomTheme,
  customColors,
};
```

**3. Register CustomThemeEditorScreen in AppNavigator:**

```javascript
import CustomThemeEditorScreen from '../screens/CustomThemeEditorScreen';

// In Stack.Navigator:
<Stack.Screen
  name="CustomThemeEditor"
  component={CustomThemeEditorScreen}
  options={{
    title: 'Custom Theme',
    headerStyle: { backgroundColor: colors.background.primary },
    headerTintColor: colors.text.primary,
  }}
/>;
```

  </action>
  <verify>
1. Custom theme appears in theme list on AppearanceSettingsScreen
2. Selecting Custom theme applies saved custom colors
3. Editing custom theme updates live
4. Custom theme persists after app restart
  </verify>
  <done>Custom theme support added to ThemeContext and navigation registered</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Custom theme editor with color pickers and persistence</what-built>
  <how-to-verify>
1. Run the app: `npx expo start`
2. Navigate to Settings → Appearance
3. Tap "Create Custom Theme"
4. Verify:
   - All 5 color picker rows displayed
   - Live preview updates when colors change
5. Tap "Background" color swatch
   - Color picker modal opens
   - Can select a different color
   - Confirm applies the color
6. Make changes to several colors
   - "Save Theme" button appears
7. Tap "Save Theme"
   - Navigates back to Appearance screen
   - "Custom" theme now selected
8. Navigate around the app
   - Custom colors applied throughout
9. Close app completely and reopen
   - Custom theme still active
10. Go to Appearance, select "Dark"
    - App reverts to dark theme
11. Select "Custom" again
    - Your saved custom colors restored

**Also test:**

- "Reset to Default" button works
- Cancel (back) without saving doesn't persist changes
  </how-to-verify>
  <resume-signal>Type "custom editor approved" if working correctly, or describe issues</resume-signal>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Color picker library installed and working
- [ ] ColorPickerRow component created
- [ ] CustomThemeEditorScreen created with all 5 colors
- [ ] Live preview updates correctly
- [ ] Custom theme saves to AsyncStorage
- [ ] ThemeContext supports custom theme
- [ ] Navigation registered and working
</verification>

<success_criteria>

- Users can create custom theme with 5 colors
- Color picker modal works for each color
- Live preview shows changes
- Save persists custom theme
- Reset returns to defaults
- Custom theme persists after app restart
  </success_criteria>

<output>
After completion, create `.planning/phases/25-color-palette/25-04-SUMMARY.md`:

# Phase 25 Plan 04: Custom Palette Editor Summary

**[One-liner describing what was accomplished]**

## Files Created/Modified

- `src/components/ColorPickerRow.js` - Color picker with modal (NEW)
- `src/screens/CustomThemeEditorScreen.js` - Custom editor screen (NEW)
- `src/context/ThemeContext.js` - Added setCustomTheme support
- `src/constants/themes.js` - Added custom theme entry
- `src/navigation/AppNavigator.js` - Registered custom editor screen

## Libraries Added

- react-native-wheel-color-picker (or alternative)

## Key Patterns Learned

- Third-party library integration
- Complex state management (multiple values)
- AsyncStorage for structured data (JSON)

## Next Step

Ready for 25-05-PLAN.md (Onboarding Integration)
</output>
