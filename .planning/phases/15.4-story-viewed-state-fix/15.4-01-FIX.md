---
phase: 15.4-story-viewed-state-fix
plan: 01-FIX
type: fix
---

<objective>
Fix 3 UAT issues from plan 15.4-01.

Source: 15.4-01-ISSUES.md
Priority: 1 blocker, 2 major
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/15.4-story-viewed-state-fix/15.4-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/15.4-story-viewed-state-fix/15.4-01-PLAN.md

# Key files affected:

@src/screens/FeedScreen.js
@src/hooks/useViewedStories.js

**Root cause analysis:**

1. **UAT-001 (Blocker): Reactions not persisting** - The `friendStories` state is loaded at mount and never updated when reactions change. When reopening stories, `handleOpenStories` uses stale data from `friendStories` instead of fresh data. The fix requires updating `friendStories` state when reactions are toggled in stories mode.

2. **UAT-002/003 (Major): Own story viewed state** - When `markPhotosAsViewed` is called in `handleCloseMyStories`, it updates the viewed tracking hook's state. However, `myStories` state isn't being refreshed to reflect the new viewed state. Additionally, the MeStoryCard may not re-render because the `isViewed` prop depends on `hasViewedAllPhotos` which needs the hook's state change to propagate through React's render cycle correctly.
   </context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-001 - Update friendStories state on reaction toggle</name>
  <files>src/screens/FeedScreen.js</files>
  <action>
Update `handleStoriesReactionToggle` to also update the `friendStories` state, ensuring reaction data persists when closing and reopening stories.

After updating `selectedFriendRef.current`, also update the `friendStories` state:

```javascript
// Update friendStories state so data persists after close/reopen
setFriendStories(prevStories =>
  prevStories.map(friend =>
    friend.userId === selectedFriend.userId ? { ...friend, topPhotos: updatedPhotos } : friend
  )
);
```

This ensures:

1. Optimistic UI update via `selectedFriendRef.current` (immediate)
2. Context update via `updatePhotoAtIndex` (PhotoDetailScreen re-render)
3. State update via `setFriendStories` (persists for reopening)

Why this fixes UAT-001: When user closes and reopens the same friend's story, `handleOpenStories` uses `friend` from `friendStories` state. By updating the state when reactions change, the reopened story will have the correct reaction data.
</action>
<verify>

1. Open friend's story
2. Add a reaction (tap emoji)
3. Observe count increments immediately (existing behavior)
4. Close story viewer
5. Reopen the same friend's story
6. Reaction count should persist (not reset to 0)
   </verify>
   <done>friendStories state updated on reaction toggle, reactions persist after close/reopen</done>
   </task>

<task type="auto">
  <name>Task 2: Fix UAT-002/003 - Refresh myStories after viewing to update ring indicator</name>
  <files>src/screens/FeedScreen.js</files>
  <action>
The issue is that `myStories` state holds stale photo data that doesn't reflect viewed status. When `hasViewedAllPhotos(myStories.topPhotos)` is called, it checks against `viewedPhotosRef.current` which IS updated, but the MeStoryCard needs to re-render to show the updated ring.

The problem: `useViewedStories` hook's state changes should trigger a FeedScreen re-render, but the `hasViewedAllPhotos` callback may not be causing the necessary re-render due to React's optimization.

**Fix approach 1: Force re-render by tracking viewed state in FeedScreen**

Add a state variable that tracks whether we need to re-evaluate viewed state:

```javascript
// Add this state to trigger re-render when viewed state changes
const [viewedStateVersion, setViewedStateVersion] = useState(0);
```

After `markPhotosAsViewed` is called in `handleCloseMyStories`, increment this version:

```javascript
const handleCloseMyStories = () => {
  // ... existing code ...

  // Force re-render to update MeStoryCard ring
  setViewedStateVersion(v => v + 1);

  // Mode flags are cleared in the onClose callback
};
```

**Fix approach 2: Simpler - Use useViewedStories loading/state for dependency**

Actually, the simpler fix is to ensure FeedScreen re-renders when `viewedPhotos` in the hook changes. The hook already exposes `loading` - we can add a `viewedPhotosCount` or similar to trigger re-renders.

**Chosen fix (simplest):** In `handleCloseMyStories`, after calling `markPhotosAsViewed`, also reload `myStories` to trigger re-render:

```javascript
const handleCloseMyStories = () => {
  logger.debug('FeedScreen: Closing own stories viewer');
  if (myStories) {
    const allPhotos = myStories.topPhotos || [];
    const isAtEnd = storiesCurrentIndexRef.current >= allPhotos.length - 1;

    if (isAtEnd) {
      // User viewed all photos - mark all as viewed
      markAsViewed(myStories.userId);
      const photoIds = allPhotos.map(p => p.id);
      if (photoIds.length > 0) {
        markPhotosAsViewed(photoIds);
      }
    } else {
      // User closed mid-story - only mark photos up to current index as viewed
      const viewedPhotoIds = allPhotos.slice(0, storiesCurrentIndexRef.current + 1).map(p => p.id);
      if (viewedPhotoIds.length > 0) {
        markPhotosAsViewed(viewedPhotoIds);
      }
    }

    // Reload myStories to update the MeStoryCard viewed ring
    // Small delay ensures markPhotosAsViewed state update completes first
    setTimeout(() => {
      loadMyStories();
    }, 100);
  }
  // Mode flags are cleared in the onClose callback
};
```

Wait - this won't help because `loadMyStories` fetches from Firestore which doesn't store viewed state. The viewed state is stored separately in `users/{userId}/viewedPhotos/`.

**Correct fix:** The `hasViewedAllPhotos` function works correctly - it checks `viewedPhotosRef.current`. The issue is that FeedScreen's `renderStoriesRow` isn't re-rendering when the hook's state changes.

Add `viewedPhotos` tracking to force re-render:

1. In `useViewedStories`, add to the return:

```javascript
return {
  // ... existing
  viewedPhotoCount: viewedPhotos.size, // New - for dependency tracking
};
```

2. In FeedScreen, destructure this new value (even if unused, it creates a render dependency):

```javascript
const {
  markAsViewed,
  markPhotosAsViewed,
  getFirstUnviewedIndex,
  hasViewedAllPhotos,
  loading: viewedStoriesLoading,
  viewedPhotoCount, // Add this - forces re-render when count changes
} = useViewedStories();
```

This ensures FeedScreen re-renders when `viewedPhotos` state changes, which updates the `isViewed` prop on MeStoryCard.
</action>
<verify>

1. Have unviewed photos in your own story (MeStoryCard shows purple ring)
2. Tap to open your own story
3. View all photos and close
4. Ring should change from purple to gray (viewed state)
5. Reopen own story - should start from photo 1 (all viewed)

For partial viewing:

1. Have 5+ photos in own story
2. View 2 photos and close
3. Reopen - should start at photo 3 (first unviewed)
   </verify>
   <done>MeStoryCard ring updates correctly after viewing own photos, resume position works for own stories</done>
   </task>

<task type="auto">
  <name>Task 3: Also update handleCloseStories for consistency</name>
  <files>src/screens/FeedScreen.js</files>
  <action>
Apply the same fix to friend stories to ensure consistency. While UAT-001 fixes the reaction persistence issue, we should ensure the viewed state also triggers proper re-renders for the FriendStoryCard ring indicators.

Currently `handleCloseStories` marks photos as viewed but the FriendStoryCard ring may not update immediately due to the same re-render issue.

With the `viewedPhotoCount` dependency added in Task 2, this should already work. Verify that closing a friend's story updates their ring from purple to gray when all photos are viewed.

No code changes expected if Task 2 fix is comprehensive. This task is for verification.
</action>
<verify>

1. Open a friend's story
2. View all photos and close
3. Friend's ring should change from purple to gray immediately
4. Reopen - should start from photo 1
   </verify>
   <done>Friend story ring indicators update correctly on close</done>
   </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] UAT-001: Reactions persist after close/reopen stories
- [ ] UAT-002: Own story ring updates after viewing
- [ ] UAT-003: Own story resumes at correct position
- [ ] Friend story ring updates after viewing (consistency)
- [ ] No console errors or warnings
</verification>

<success_criteria>

- All UAT issues from 15.4-01-ISSUES.md addressed
- Tests pass (npm start without errors)
- Ready for re-verification
  </success_criteria>

<output>
After completion, create `.planning/phases/15.4-story-viewed-state-fix/15.4-01-FIX-SUMMARY.md`
</output>
