---
phase: 15.4-story-viewed-state-fix
plan: 03-FIX
subsystem: stories
tags: [react-native, useMemo, dependencies, sorting, reactions]

# Dependency graph
requires:
  - phase: 15.4-02-FIX
    provides: Initial reaction sorting fix attempt (frozenOrder reset)
provides:
  - Fixed reaction emoji sorting by total count
  - Fixed stale data in React useMemo with proper dependencies
affects: [feed, stories, reactions]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'Read from source object inside useMemo rather than destructured variables'
    - 'Sort all items together when uniform ordering is expected'

key-files:
  created: []
  modified:
    - src/hooks/usePhotoDetailModal.js
    - .planning/ISSUES.md

key-decisions:
  - 'Depend on currentPhoto object rather than destructured reactions for useMemo'
  - 'Sort all emojis (custom + curated) together by count instead of separate groups'

patterns-established:
  - 'useMemo dependencies: Use source object reference, not destructured variables'

issues-created: []

# Metrics
duration: 15 min
completed: 2026-02-03
---

# Phase 15.4 Plan 03-FIX: Reaction Sorting Fix Summary

**Fixed ISS-009: Reactions now sort correctly by total count (highest count leftmost)**

## Performance

- **Duration:** 15 min
- **Started:** 2026-02-03
- **Completed:** 2026-02-03
- **Tasks:** 3 (debug, fix, close issue)
- **Files modified:** 2

## Accomplishments

- Fixed stale data bug in `groupedReactions` useMemo that prevented reactions loaded from Firestore from being counted
- Fixed `orderedEmojis` to sort ALL emojis (custom + curated) by count, not just curated emojis
- Closed ISS-009 with detailed root cause documentation

## Root Cause Analysis

**Issue 1: Stale data in useMemo (reactions not counted from database)**

The `groupedReactions` useMemo depended on a destructured `reactions` variable:

```javascript
const { reactions = {} } = currentPhoto || {};
const groupedReactions = useMemo(() => {
  // Uses `reactions` variable
}, [reactions]); // React didn't detect changes
```

React's dependency comparison for the destructured variable was unreliable when photos loaded from Firestore. The reference identity of `reactions` wasn't changing in a way React detected.

**Fix:** Read directly from the source object inside the memo:

```javascript
const groupedReactions = useMemo(() => {
  const photoReactions = currentPhoto?.reactions || {};
  // Use photoReactions directly
}, [currentPhoto]); // Depend on the whole photo object
```

**Issue 2: Custom emojis not sorted (user-added emojis always appeared first)**

The previous `orderedEmojis` logic only sorted curated emojis by count. Custom emojis (added via the emoji picker) were prepended to the front without considering their counts.

**Fix:** Combine all emojis (custom + curated) and sort them together:

```javascript
const allEmojis = [...customToAdd, ...curatedEmojis];
const sortedAll = allEmojis
  .map(emoji => ({ emoji, totalCount: groupedReactions[emoji] || 0 }))
  .sort((a, b) => b.totalCount - a.totalCount)
  .map(item => item.emoji);
```

## Task Commits

1. **Task 1-2: Debug and fix** - `792e930` (fix)
   - Added debug logging to trace data flow
   - Identified both root causes from console output
   - Fixed `groupedReactions` to read from `currentPhoto?.reactions`
   - Fixed `getUserReactionCount` similarly
   - Fixed `activeCustomEmojis` useEffect to read from `currentPhoto?.reactions`
   - Changed `orderedEmojis` to sort all emojis together
   - Removed debug logging after verification

2. **Task 3: Close ISS-009** - (same commit)
   - Moved ISS-009 to Closed section in ISSUES.md
   - Documented resolution and pattern learned

## Files Modified

- `src/hooks/usePhotoDetailModal.js` - Fixed useMemo dependencies and sorting logic
- `.planning/ISSUES.md` - Closed ISS-009 with resolution details

## Decisions Made

1. **Depend on source object**: Rather than destructured variables, depend on the parent object (`currentPhoto`) in useMemo/useCallback. This ensures React's comparison detects all nested changes.

2. **Unified sorting**: Sort all emojis together rather than having separate groups with different ordering rules. This provides consistent, predictable behavior.

## Pattern Learned

**React useMemo dependency pitfall:** When destructuring an object's property and using it in a useMemo, React's shallow comparison on the destructured variable may not detect when the underlying data changes (especially with complex nested objects like Firestore documents). Always read from the source object inside the memo and depend on the source object itself.

## Verification Results

- Reactions load from database with correct counts
- All emojis (custom and curated) sort by total count
- Highest count emoji appears leftmost
- Sorting updates correctly after 1.5s freeze timer expires
- No regressions to reaction toggle or highlight animations

## Next Phase Readiness

- Phase 15.4 complete (all 3 FIX plans executed)
- All Phase 15.x work complete
- Ready for Phase 16: Color Constants Standardization

---

_Phase: 15.4-story-viewed-state-fix_
_Completed: 2026-02-03_
