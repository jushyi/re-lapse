---
phase: 15.4-story-viewed-state-fix
plan: 01
subsystem: feed
tags: [stories, reactions, refs, context, closure-fix]

# Dependency graph
requires:
  - phase: 15.3-modal-architecture
    provides: PhotoDetailContext with callbacks pattern, navigation screen architecture
provides:
  - Story viewed state tracking works correctly
  - Real-time reaction updates in PhotoDetailScreen
  - storiesCurrentIndexRef pattern for callback-safe state
affects: [stories, feed, reactions]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'useRef for callback-captured state'
    - 'Context state update for cross-component reactivity'

key-files:
  created: []
  modified:
    - src/screens/FeedScreen.js
    - src/context/PhotoDetailContext.js

key-decisions:
  - 'Convert storiesCurrentIndex from useState to useRef to fix closure capture'
  - 'Add updatePhotoAtIndex to context for real-time reaction propagation'

patterns-established:
  - 'Use refs instead of state for values read inside callbacks registered via useEffect'
  - 'Update context state to trigger re-renders in consuming components'

issues-created: []

# Metrics
duration: 12min
completed: 2026-02-03
---

# Phase 15.4 Plan 01: Story Viewed State Fix Summary

**Fixed closure capture bug causing incorrect viewed state tracking, added context method for real-time reaction updates in stories mode**

## Performance

- **Duration:** 12 min
- **Started:** 2026-02-03T14:00:00Z
- **Completed:** 2026-02-03T14:12:00Z
- **Tasks:** 3
- **Files modified:** 2

## Accomplishments

- Fixed story viewed state tracking by converting `storiesCurrentIndex` from React state to ref
- Added `updatePhotoAtIndex` method to PhotoDetailContext for real-time reaction updates
- Stories now correctly mark only viewed photos when closing mid-story
- Reaction counts now update immediately in PhotoDetailScreen during story viewing

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix storiesCurrentIndex closure capture** - `de5bae3` (fix)
2. **Task 2: Add updatePhotoAtIndex for reactions** - `3ba23a4` (feat)
3. **Task 3: Verify end-to-end** - No code changes (verification only)

**Plan metadata:** `0a693cc` (docs: complete plan)

## Files Created/Modified

- `src/screens/FeedScreen.js` - Converted storiesCurrentIndex to ref, added updatePhotoAtIndex call
- `src/context/PhotoDetailContext.js` - Added updatePhotoAtIndex method

## Decisions Made

1. **Use ref instead of state for storiesCurrentIndex** - Callbacks registered in useEffect capture state at definition time. Refs are read at call-time, fixing the closure capture issue.

2. **Update context state for reaction propagation** - PhotoDetailScreen reads photos from context. Updating context state triggers re-render with new reaction counts.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## Next Phase Readiness

Phase 15.4 complete, ready for Phase 16: Color Constants Standardization

---

_Phase: 15.4-story-viewed-state-fix_
_Completed: 2026-02-03_
