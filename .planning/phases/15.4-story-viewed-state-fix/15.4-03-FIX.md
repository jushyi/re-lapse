---
phase: 15.4-story-viewed-state-fix
plan: 03-FIX
type: fix
---

<objective>
Fix ISS-009: Reactions not sorting by count (highest count should be leftmost).

Source: .planning/ISSUES.md (ISS-009)
Priority: 1 bug (reaction sorting broken)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issue being fixed:**
@.planning/ISSUES.md (ISS-009 section)

**Previous fix attempts:**
@.planning/phases/15.4-story-viewed-state-fix/15.4-02-FIX-SUMMARY.md

**Key files:**
@src/hooks/usePhotoDetailModal.js (sorting logic)
@src/screens/PhotoDetailScreen.js (UI rendering)
@src/screens/FeedScreen.js (reaction toggle handler)
@src/context/PhotoDetailContext.js (state management)
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add debug logging to trace reaction data flow</name>
  <files>src/hooks/usePhotoDetailModal.js</files>
  <action>
Add temporary console.log statements to trace the reaction sorting data flow:

1. In `groupedReactions` useMemo - log input `reactions` and output `grouped`:

```javascript
console.log('[DEBUG] groupedReactions input (reactions):', JSON.stringify(reactions));
console.log('[DEBUG] groupedReactions output:', JSON.stringify(grouped));
```

2. In `orderedEmojis` useMemo - log sorting steps:

```javascript
console.log('[DEBUG] orderedEmojis - curatedData:', JSON.stringify(curatedData));
console.log('[DEBUG] orderedEmojis - sortedCurated:', sortedCurated);
console.log('[DEBUG] orderedEmojis - frozenOrder:', frozenOrder);
console.log('[DEBUG] orderedEmojis - final result:', result);
```

3. In `handleEmojiPress` - log when freezing order:

```javascript
console.log('[DEBUG] handleEmojiPress - freezing order:', currentSortedOrder);
```

Run the app, tap a reaction multiple times on one emoji and once on another, wait 2 seconds, and check console logs to identify where the sorting breaks down.
</action>
<verify>Console logs show data flow at each step - identify which step has incorrect data</verify>
<done>Debug logging added and root cause identified from console output</done>
</task>

<task type="auto">
  <name>Task 2: Fix identified sorting issue</name>
  <files>src/hooks/usePhotoDetailModal.js</files>
  <action>
Based on debug findings, fix the root cause. Most likely issues:

**Issue A: groupedReactions not updating**
If `groupedReactions` shows stale counts:

- Check that `reactions` reference changes when photo updates
- May need to add `currentPhoto?.id` to groupedReactions dependencies as a trigger

**Issue B: orderedEmojis using wrong counts**
If `curatedData` has wrong totalCount values:

- Verify `groupedReactions` is the latest version at time of sorting
- The sorting code itself is correct - issue is input data

**Issue C: frozenOrder not clearing properly**
If `frozenOrder` stays set when it shouldn't:

- Verify the 1.5 second timer is firing
- Check if timer is being cleared prematurely

**Issue D: State not propagating from context**
If context `photos` array updates but component doesn't re-render:

- Check that PhotoDetailScreen is reading from context correctly
- May need to verify `photos` identity changes in context

Apply the appropriate fix based on debug findings. Remove temporary logging after fix.
</action>
<verify>

1. Run app, view a story
2. Tap an emoji multiple times (e.g., tap ‚ù§Ô∏è 3 times)
3. Tap a different emoji once (e.g., tap üòÇ once)
4. Wait 2 seconds for freeze timer to expire
5. Verify emoji with 3 taps appears leftmost (highest count)
6. Close and reopen story - verify order persists
   </verify>
   <done>Reactions sort correctly with highest count on left after freeze timer expires</done>
   </task>

<task type="auto">
  <name>Task 3: Close ISS-009 in ISSUES.md</name>
  <files>.planning/ISSUES.md</files>
  <action>
Move ISS-009 from "Open Enhancements" to "Closed Enhancements" section.

Add resolution details:

- **Closed:** [today's date]
- **Type:** Bug
- **Resolution:** [describe the fix applied based on Task 2 findings]
  </action>
  <verify>ISS-009 is in Closed section with resolution documented</verify>
  <done>Issue properly closed with fix documentation</done>
  </task>
  </tasks>

<verification>
Before declaring plan complete:
- [ ] Reaction sorting works correctly (highest count leftmost)
- [ ] Sorting updates in real-time after freeze timer expires
- [ ] No regressions to other reaction functionality
- [ ] ISS-009 closed in ISSUES.md
</verification>

<success_criteria>

- Reactions display sorted by total count (highest count on left)
- Sorting respects 1.5 second freeze during rapid tapping
- After freeze expires, emojis re-sort by count
- ISS-009 documented as resolved
  </success_criteria>

<output>
After completion, create `.planning/phases/15.4-story-viewed-state-fix/15.4-03-FIX-SUMMARY.md`
</output>
