---
phase: 15.4-story-viewed-state-fix
plan: 02-FIX
subsystem: stories
tags: [react-native, closures, refs, sorting, state-management]

# Dependency graph
requires:
  - phase: 15.4
    provides: Story viewed tracking with PhotoDetailScreen navigation
provides:
  - Fixed own story ring indicator updates
  - Fixed own story resume position tracking
  - Fixed reaction emoji sorting by count
affects: [feed, stories, reactions]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'Use refs to avoid stale closures in useEffect callbacks'
    - 'Reset ephemeral state (frozenOrder) on entity change (photo ID)'

key-files:
  created: []
  modified:
    - src/screens/FeedScreen.js
    - src/hooks/usePhotoDetailModal.js

key-decisions:
  - 'Used handler refs pattern instead of dependency array updates'
  - 'Reset frozenOrder in existing photo change effect (no new effect)'

patterns-established:
  - 'Handler refs: Store handlers in refs, update on each render, call via ref in callbacks'

issues-created: []

# Metrics
duration: 8 min
completed: 2026-02-03
---

# Phase 15.4 Plan 02-FIX: Story Viewed State & Reaction Sorting Summary

**Fixed 3 UAT issues: own story ring indicator, resume position, and reaction sorting by count**

## Performance

- **Duration:** 8 min
- **Started:** 2026-02-03T10:00:00Z
- **Completed:** 2026-02-03T10:08:00Z
- **Tasks:** 3 (2 with code changes, 1 no-op)
- **Files modified:** 2

## Accomplishments

- Fixed stale closure bug preventing own story viewed state from updating (ISS-006, ISS-007)
- Fixed reaction emoji sorting by resetting frozenOrder on photo change (ISS-008)
- Verified no excessive debug logging needed cleanup

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix own story viewed state** - `dbeb160` (fix)
   - Added `handleCloseMyStoriesRef` and `handleCloseStoriesRef` refs
   - Update refs on each render with latest handler versions
   - Use refs in setCallbacks effect to avoid stale closures

2. **Task 2: Fix reaction sorting** - `20e7a0f` (fix)
   - Added `setFrozenOrder(null)` in photo change effect
   - Ensures emojis re-sort by count when switching photos

3. **Task 3: Clean up debug logging** - No commit (no changes needed)
   - Root causes identified via code analysis, not debug logging
   - Existing logging at appropriate levels

**Plan metadata:** (this commit)

## Files Created/Modified

- `src/screens/FeedScreen.js` - Added handler refs pattern for close callbacks
- `src/hooks/usePhotoDetailModal.js` - Added frozenOrder reset on photo change

## Decisions Made

1. **Handler refs pattern over dependency array**: Instead of adding all handlers to the useEffect dependency array (which would cause excessive re-runs and potential infinite loops), used refs to hold the latest handler versions. This ensures callbacks always invoke the current handler without useEffect re-execution.

2. **Reset frozenOrder in existing effect**: Rather than creating a new useEffect specifically for frozenOrder, added the reset to the existing photo change effect that already handles other state resets.

## Deviations from Plan

None - plan executed exactly as written. Root causes identified via code analysis instead of debug logging approach suggested in plan.

## Issues Encountered

None - fixes were straightforward once root causes were identified.

## Root Cause Analysis

**ISS-006/007 (Own story ring indicator and resume position):**
The `setCallbacks` effect in FeedScreen captured `handleCloseMyStories` when it ran, but didn't update when the handler changed. This meant the callback had a stale version of `handleCloseMyStories` that referenced the initial `myStories` state (null), causing `markPhotosAsViewed` to never be called with valid photo IDs.

**ISS-008 (Reaction sorting):**
The `frozenOrder` state preserved emoji order during rapid tapping (to prevent jumpy UI), but was never reset when switching photos. This caused the old photo's frozen order to persist for the new photo.

## Next Phase Readiness

- Phase 15.4 complete (all 3 FIX plans executed)
- All Phase 15.x work complete
- Ready for Phase 16: Color Constants Standardization

---

_Phase: 15.4-story-viewed-state-fix_
_Completed: 2026-02-03_
