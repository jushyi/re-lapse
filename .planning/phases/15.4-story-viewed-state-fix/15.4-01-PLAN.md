---
phase: 15.4-story-viewed-state-fix
plan: 01
type: execute
---

<objective>
Restore story viewed state tracking and real-time reaction updates broken by Phase 15.3 navigation changes.

Purpose: Fix regressions where story ring indicators don't update after viewing, stories don't resume from correct position, and reaction counts don't update in real-time.

Output: Working story viewed state with immediate ring updates, correct resume positions, and real-time reaction count updates.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15.4-story-viewed-state-fix/15.4-CONTEXT.md
@.planning/phases/15.3-modal-architecture/15.3-02-SUMMARY.md

# Key files affected:

@src/screens/FeedScreen.js
@src/context/PhotoDetailContext.js
@src/screens/PhotoDetailScreen.js
@src/hooks/useViewedStories.js

**Root cause analysis:**

1. **storiesCurrentIndex closure capture bug**: The `onClose` callback is set once via `setCallbacks()` in a useEffect, but `handleCloseStories` reads `storiesCurrentIndex` from React state. The callback captures the function reference from when the effect ran, so it reads stale state (initial value 0). Result: markPhotosAsViewed always marks from index 0, not actual position.

2. **Reactions not propagating to context**: `handleStoriesReactionToggle` updates `selectedFriendRef.current.topPhotos` (a ref) but PhotoDetailScreen reads photos from context state. The context's `photos` array never gets updated, so the UI doesn't reflect new reactions.

**Constraining decisions from 15.3:**

- Context + refs pattern for callbacks (avoids re-renders when callbacks change)
- transparentModal presentation keeps previous screen visible
- Navigation screen replaces Modal component
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Fix storiesCurrentIndex closure capture with ref</name>
  <files>src/screens/FeedScreen.js</files>
  <action>
Convert `storiesCurrentIndex` from React state to a ref to fix the closure capture issue.

1. Replace `const [storiesCurrentIndex, setStoriesCurrentIndex] = useState(0);` with `const storiesCurrentIndexRef = useRef(0);`

2. Update all usages:
   - `setStoriesCurrentIndex(startIndex)` → `storiesCurrentIndexRef.current = startIndex`
   - `setStoriesCurrentIndex(index)` → `storiesCurrentIndexRef.current = index`
   - `storiesCurrentIndex >= allPhotos.length - 1` → `storiesCurrentIndexRef.current >= allPhotos.length - 1`
   - `allPhotos.slice(0, storiesCurrentIndex + 1)` → `allPhotos.slice(0, storiesCurrentIndexRef.current + 1)`

3. In `handleStoriesPhotoChange`, update the ref: `storiesCurrentIndexRef.current = index;`

4. The callback pattern now works because refs are read at call-time, not captured at definition-time.

Why refs fix this: When `handleCloseStories` runs via the callback, it reads `storiesCurrentIndexRef.current` which has the current value, not a stale closure-captured value.
</action>
<verify>
Add console.log in handleCloseStories to verify storiesCurrentIndexRef.current has correct value:
`console.log('Closing at index:', storiesCurrentIndexRef.current, 'of', allPhotos.length);`
Run app, open stories, navigate to photo 3 of 5, close. Log should show "Closing at index: 2 of 5".
</verify>
<done>storiesCurrentIndex converted to ref, handleCloseStories reads correct index, photos marked as viewed up to actual viewing position</done>
</task>

<task type="auto">
  <name>Task 2: Add context method to update photos for real-time reactions</name>
  <files>src/context/PhotoDetailContext.js, src/screens/FeedScreen.js</files>
  <action>
Add a method to PhotoDetailContext that updates a specific photo in the photos array, enabling real-time reaction updates.

**In PhotoDetailContext.js:**

1. Add new method `updatePhotoAtIndex`:

```javascript
/**
 * Update a photo at a specific index - for real-time reaction updates
 */
const updatePhotoAtIndex = useCallback((index, updatedPhoto) => {
  setPhotos(prevPhotos => {
    const newPhotos = [...prevPhotos];
    newPhotos[index] = updatedPhoto;
    return newPhotos;
  });
}, []);
```

2. Add to context value object:

```javascript
const value = {
  // ... existing
  updatePhotoAtIndex,
  // ...
};
```

**In FeedScreen.js:**

1. Destructure `updatePhotoAtIndex` from `usePhotoDetail()`

2. Update `handleStoriesReactionToggle` to also update context:
   After updating `selectedFriendRef.current`, add:

```javascript
// Update context photos for PhotoDetailScreen re-render
updatePhotoAtIndex(storiesCurrentIndexRef.current, updatedPhotos[storiesCurrentIndexRef.current]);
```

This ensures PhotoDetailScreen sees the updated reaction counts immediately.

Why this works: PhotoDetailScreen reads `photos` from context. When context state changes, PhotoDetailScreen re-renders with updated data.
</action>
<verify>
Run app, open friend's story, tap reaction emoji. Count should increment immediately without closing/reopening. Tap same emoji again - count should increment again.
</verify>
<done>Context has updatePhotoAtIndex method, FeedScreen calls it on reaction toggle, PhotoDetailScreen shows real-time reaction count updates</done>
</task>

<task type="auto">
  <name>Task 3: Verify end-to-end viewed state and reactions</name>
  <files>src/screens/FeedScreen.js</files>
  <action>
Remove debug logging added during development and verify complete flow works.

1. Remove any `console.log` statements added for debugging in Task 1

2. Verify the complete flow:
   - Story ring shows gradient (unviewed) initially
   - Opening story starts at first unviewed photo
   - Closing mid-story marks only viewed photos as viewed
   - Story ring updates to gray immediately when all photos viewed
   - Reactions increment in real-time as tapped
   - Viewed state persists after app restart (Firestore persistence)

3. Test edge cases:
   - Open story, view all photos, close → ring should be gray
   - Open same story again → should start at photo 1 (all viewed)
   - Open different friend's story → should start at first unviewed
   - Own stories: reactions disabled, but viewed state should track
     </action>
     <verify>
     Manual testing checklist:

- [ ] Story ring gradient → gray after viewing all photos
- [ ] Story resumes at first unviewed photo
- [ ] Story resumes at photo 1 if all viewed
- [ ] Reaction counts update immediately on tap
- [ ] Multiple taps increment count each time
- [ ] Viewed state persists after force-closing app
      </verify>
      <done>Debug logging removed, all viewed state behaviors work correctly, reactions update in real-time</done>
      </task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm start` - app runs without errors
- [ ] Story ring updates from gradient to gray after viewing all photos
- [ ] Stories resume from correct position (first unviewed, or photo 1 if all viewed)
- [ ] Reaction counts update immediately as tapped (no need to reopen)
- [ ] Viewed state persists after logout/login
- [ ] No console errors or warnings related to state/refs
</verification>

<success_criteria>

- storiesCurrentIndex converted from state to ref
- Context has updatePhotoAtIndex method
- handleStoriesReactionToggle calls updatePhotoAtIndex
- Story ring indicators update correctly after viewing
- Stories resume from correct position
- Reaction counts update in real-time
- All functionality matches pre-15.3 behavior
  </success_criteria>

<output>
After completion, create `.planning/phases/15.4-story-viewed-state-fix/15.4-01-SUMMARY.md`:

# Phase 15.4 Plan 01: Story Viewed State Fix Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

[Phase 15.4 complete, ready for Phase 16: Color Constants Standardization]
</output>
