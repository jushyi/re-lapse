---
phase: 14-remote-notification-testing
plan: 01
type: execute
---

<objective>
Test remote push notifications end-to-end on the standalone iOS build and verify deep linking navigation works correctly for all notification types.

Purpose: Validate that Cloud Functions trigger correctly and notifications reach devices with proper deep linking before MVP release.
Output: Verified notification system working for all 3 types (photo reveals, friend requests, reactions) with documented results.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-production-build-branding/13-03-SUMMARY.md

**Build Info (from Phase 13-03):**
- Build ID: 6db03d2f-777b-4d44-a8a8-da33f0705329
- Profile: preview (internal distribution)
- IPA URL: https://expo.dev/artifacts/eas/exAG85m1tXdaKrVhaFcuB4.ipa
- Build Page: https://expo.dev/accounts/spoodsjs/projects/Oly/builds/6db03d2f-777b-4d44-a8a8-da33f0705329

**Notification System (from functions/):**
- 3 Cloud Functions deployed: sendPhotoRevealNotification, sendFriendRequestNotification, sendReactionNotification
- Expo Push Token stored in users/{userId}/fcmToken
- Deep links: lapse://darkroom, lapse://friends/requests, lapse://feed

**Key Files:**
@functions/index.js - Cloud Functions for notifications
@src/services/firebase/notificationService.js - Client-side notification handling
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <action>Install standalone iOS build on physical device</action>
  <instructions>
    The standalone build must be installed to test remote notifications (Expo Go cannot receive remote push notifications).

    1. On your registered iOS device, visit:
       https://expo.dev/accounts/spoodsjs/projects/Oly/builds/6db03d2f-777b-4d44-a8a8-da33f0705329
    2. Scan QR code or tap "Install" button
    3. iOS will prompt to install the Oly app
    4. Open Settings ‚Üí General ‚Üí VPN & Device Management
    5. Trust the developer certificate if prompted
    6. Open the Oly app and sign in

    NOTE: Device must be registered in Apple Developer provisioning profile.
  </instructions>
  <verification>App opens successfully and user can sign in</verification>
  <resume-signal>Type "installed" when app is running on device, or describe any issues</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Verify notification permissions granted</action>
  <instructions>
    When the app requests notification permissions:
    1. Tap "Allow" on the iOS notification permission prompt
    2. Verify in Settings ‚Üí Notifications ‚Üí Oly that notifications are enabled

    If permission wasn't requested during sign-in:
    1. Go to iOS Settings ‚Üí Notifications ‚Üí Oly
    2. Enable "Allow Notifications"
  </instructions>
  <verification>Check Firebase Console ‚Üí Firestore ‚Üí users/{yourUserId} - should have fcmToken field populated with ExponentPushToken[...]</verification>
  <resume-signal>Type "permissions granted" when fcmToken is visible in Firestore, or describe issues</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Photo Reveal Notification Test</what-built>
  <how-to-verify>
    **Setup:** Need at least one photo in "developing" status

    1. In the app, take a photo (it will go to darkroom as "developing")
    2. Wait for the reveal time (0-15 minutes based on Phase 13.1 fix) OR
       manually trigger reveal by opening darkroom and pressing hold to reveal
    3. When photos are revealed, the darkroom document updates, triggering Cloud Function

    **Expected Result:**
    - Push notification appears: "üì∏ Photos Ready! X photos are ready to view in the darkroom"
    - Tapping notification navigates to Darkroom tab

    **Verify in Firebase Console:**
    - Functions ‚Üí sendPhotoRevealNotification ‚Üí Logs should show notification sent

    **If notification doesn't arrive:**
    - Check Functions logs for errors
    - Verify fcmToken is valid ExponentPushToken format
    - Check if darkroom document has both nextRevealAt AND lastRevealedAt updated
  </how-to-verify>
  <resume-signal>Type "photo reveal works" if notification arrived and deep link worked, or describe what happened</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Friend Request Notification Test</what-built>
  <how-to-verify>
    **Setup:** Need a second test account to send friend request

    1. Sign out of current account
    2. Create or sign in to a second test account
    3. Make sure this account also has fcmToken (check Firestore)
    4. Search for the first account and send a friend request
    5. The friendship document creation triggers Cloud Function

    **Expected Result:**
    - Push notification appears on first user's device: "üëã Friend Request - [Name] sent you a friend request"
    - Tapping notification navigates to Friends ‚Üí FriendRequests screen

    **Verify in Firebase Console:**
    - Functions ‚Üí sendFriendRequestNotification ‚Üí Logs should show notification sent

    **If notification doesn't arrive:**
    - Check Functions logs for errors
    - Verify recipient has fcmToken
    - Check friendship document has status: 'pending'
  </how-to-verify>
  <resume-signal>Type "friend request works" if notification arrived and deep link worked, or describe what happened</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Reaction Notification Test</what-built>
  <how-to-verify>
    **Setup:** Need a photo in "journal" state (visible in feed) from first account

    1. On second account, go to Feed
    2. Find a photo from the first account (they need to be friends, or use a fresh photo)
    3. Tap the photo to open PhotoDetailModal
    4. Tap an emoji to react
    5. The photo document update triggers Cloud Function

    **Expected Result:**
    - Push notification appears on first user's device: "‚ù§Ô∏è New Reaction - [Name] reacted to your photo"
    - Tapping notification navigates to Feed tab

    **Verify in Firebase Console:**
    - Functions ‚Üí sendReactionNotification ‚Üí Logs should show notification sent

    **If notification doesn't arrive:**
    - Check Functions logs for errors
    - Verify photo owner has fcmToken
    - Check that reactionCount actually increased
  </how-to-verify>
  <resume-signal>Type "reaction works" if notification arrived and deep link worked, or describe what happened</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Standalone build installed and running on physical iOS device
- [ ] Notification permissions granted and fcmToken stored in Firestore
- [ ] Photo reveal notification: received and deep link to Darkroom works
- [ ] Friend request notification: received and deep link to FriendRequests works
- [ ] Reaction notification: received and deep link to Feed works
- [ ] Cloud Function logs show successful sends for all 3 types
</verification>

<success_criteria>

- All 3 notification types verified working end-to-end
- Deep linking correctly navigates to appropriate screens
- No critical bugs discovered during testing
- Phase 14 marked complete in ROADMAP.md
- v1.4 milestone ready for completion
</success_criteria>

<output>
After completion, create `.planning/phases/14-remote-notification-testing/14-01-SUMMARY.md`:

# Phase 14 Plan 01: Remote Notification Testing Summary

**[All 3 notification types verified working on standalone iOS build]**

## Test Results

| Notification Type | Received | Deep Link | Notes |
|-------------------|----------|-----------|-------|
| Photo Reveal | ‚úÖ/‚ùå | ‚úÖ/‚ùå | ... |
| Friend Request | ‚úÖ/‚ùå | ‚úÖ/‚ùå | ... |
| Reaction | ‚úÖ/‚ùå | ‚úÖ/‚ùå | ... |

## Accomplishments

- [Key outcomes]

## Issues Found

[Any bugs discovered, or "None"]

## v1.4 Milestone Status

Phase 14 complete. v1.4 Production Ready milestone can now be marked complete.
</output>
