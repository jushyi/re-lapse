---
phase: 39-darkroom-tagging
plan: 01
type: execute
domain: react-native
---

<objective>
Add UI to tag friends during darkroom photo triage with a tag button on the triage bar.

Purpose: Allow users to tag friends in photos before publishing, enabling tagged notifications via the Cloud Function infrastructure built in Phase 36-02.
Output: Working tag button in darkroom, friend picker modal, and photo documents updated with taggedUserIds on triage completion.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-photo-notification-events/36-02-SUMMARY.md
@.planning/phases/36-photo-notification-events/TAGGING-SCHEMA.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/ARCHITECTURE.md

# Key source files:

@src/screens/DarkroomScreen.js
@src/hooks/useDarkroom.js
@src/components/SwipeablePhotoCard.js
@src/services/firebase/friendshipService.js
@src/services/firebase/userService.js
@src/services/firebase/photoService.js

**Tech stack available:** React Native, Expo, Firebase Firestore, expo-image
**Established patterns:**

- Three-way separation (Screen/Hook/Styles)
- Service returns { success, data/error }
- Color constants from colors.js
- Modal components (ClipSelectionModal, RenameAlbumModal patterns)

**Constraining decisions from Phase 36-02:**

- taggedUserIds array schema with taggedAt timestamp
- sendTaggedPhotoNotification Cloud Function already watching for changes
- 30-second debounce window for batching notifications
- Deep link opens tagger's story and scrolls to tagged photo

**Integration point:**
When photos are triaged with tags, the Cloud Function will detect taggedUserIds changes and send notifications automatically.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TagFriendsModal component</name>
  <files>src/components/TagFriendsModal.js, src/styles/TagFriendsModal.styles.js, src/components/index.js</files>
  <action>
Create a modal component for selecting friends to tag in a photo:

1. **TagFriendsModal.js:**
   - Accept props: visible, onClose, onConfirm, initialSelectedIds (array of pre-selected friend IDs)
   - Fetch user's accepted friends on mount using getFriendships() + getUserProfile() for each
   - Display scrollable FlatList of friends with profile photo, display name, username
   - Multi-select with checkmark indicator on selected items
   - Header with "Tag Friends" title and "Done" button
   - "Done" calls onConfirm(selectedFriendIds) and closes modal
   - Empty state: "No friends yet" message
   - Loading state while fetching friends

2. **Styling:**
   - Use Modal with transparent background and slide-up animation
   - Dark theme matching existing modals (colors.background.secondary for content)
   - Friend row: 52px height, profile photo (40px circle), name/username, checkmark
   - Selected state: checkmark icon (Ionicons checkmark-circle) in colors.interactive.primary
   - Unselected state: empty circle outline

3. **Pattern to follow:**
   - Similar to ClipSelectionModal for modal structure
   - Use FriendCard-like layout for friend rows
   - Export from components/index.js

Note: DO NOT use getFriendUserIds - that only returns IDs. Use getFriendships to get friendship docs, then hydrate with getUserProfile for each friend.
</action>
<verify>Component file exists, imports correctly, renders without errors when visible={true}</verify>
<done>TagFriendsModal displays friend list with selection, calls onConfirm with selected IDs array</done>
</task>

<task type="auto">
  <name>Task 2: Add tag button and state tracking to darkroom</name>
  <files>src/hooks/useDarkroom.js, src/screens/DarkroomScreen.js, src/styles/DarkroomScreen.styles.js</files>
  <action>
Add tagging capability to the darkroom triage flow:

1. **useDarkroom.js changes:**
   - Add state: `photoTags` - Map/object of { photoId: string[] } tracking tags per photo
   - Add handler: `handleTagFriends(photoId, selectedFriendIds)` - updates photoTags for the photo
   - Add handler: `getTagsForPhoto(photoId)` - returns current tags array or []
   - Add state: `tagModalVisible` - boolean to control modal visibility
   - Add handler: `handleOpenTagModal()` - sets tagModalVisible true (only if currentPhoto exists)
   - Add handler: `handleCloseTagModal()` - sets tagModalVisible false
   - Export all new state/handlers

2. **DarkroomScreen.js changes:**
   - Import TagFriendsModal
   - Add tag button to triageButtonBar between Archive and Delete buttons
   - Tag button: Ionicons "person-add-outline", 24px, same styling as other triage buttons
   - Show badge/indicator on tag button if current photo has tags (small dot or count)
   - Render TagFriendsModal at bottom of component:
     - visible={tagModalVisible}
     - onClose={handleCloseTagModal}
     - onConfirm={(ids) => { handleTagFriends(currentPhoto.id, ids); handleCloseTagModal(); }}
     - initialSelectedIds={getTagsForPhoto(currentPhoto?.id)}

3. **Styling:**
   - Tag button same size as delete button (48px circle)
   - Position between Archive and Delete (new button order: Archive | Tag | Delete | Journal)
   - Badge: small purple dot positioned at top-right of button if photo has tags

Note: Tags are tracked locally and saved to Firestore only when Done is tapped (same as triage decisions).
</action>
<verify>Tag button renders in triage bar, tapping opens modal, selecting friends updates state, badge shows when tags exist</verify>
<done>Tag button visible in darkroom, modal opens with friends, selections tracked per photo in local state</done>
</task>

<task type="auto">
  <name>Task 3: Save taggedUserIds to photos on triage completion</name>
  <files>src/services/firebase/photoService.js, src/hooks/useDarkroom.js</files>
  <action>
Update photo documents with tags when user completes triage:

1. **photoService.js changes:**
   - Modify `batchTriagePhotos` to accept optional `photoTags` parameter (object mapping photoId to taggedUserIds array)
   - Before triaging each photo, if photoTags[photoId] exists and has items:
     - updateDoc with taggedUserIds array and taggedAt: serverTimestamp()
   - This triggers sendTaggedPhotoNotification Cloud Function automatically
   - Update JSDoc to document the new parameter

2. **useDarkroom.js changes:**
   - In handleDone, pass photoTags to batchTriagePhotos:
     ```javascript
     const result = await batchTriagePhotos(decisions, photoTags);
     ```
   - Clear photoTags state after successful save (already happens via setUndoStack([]) pattern)

3. **Undo handling:**
   - When handleUndo is called, also restore tags for the undone photo
   - Store tags in undo stack entry: { photo, action, exitDirection, tags }
   - On undo, restore tags to photoTags state

4. **Edge cases:**
   - Skip empty taggedUserIds arrays (don't write field if no tags)
   - Self-tagging is allowed (Cloud Function skips notification for self)
   - Tags persist if photo is undone and re-triaged

Per TAGGING-SCHEMA.md:

```javascript
await updateDoc(doc(db, 'photos', photoId), {
  taggedUserIds: selectedFriendIds,
  taggedAt: serverTimestamp(),
});
```

  </action>
  <verify>Journal a photo with tags, check Firestore - photo document has taggedUserIds array and taggedAt timestamp</verify>
  <done>Photos saved with taggedUserIds, Cloud Function sends notifications to tagged users, undo restores tags correctly</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Tag button visible in darkroom triage bar
- [ ] Tapping tag button opens friend picker modal
- [ ] Modal shows all accepted friends with profile photos
- [ ] Multi-select works with checkmark indicators
- [ ] Badge appears on tag button when current photo has tags
- [ ] Tags persist across undo/redo cycles
- [ ] `npm run lint` passes
- [ ] Triage a photo with tags and verify taggedUserIds in Firestore
- [ ] Verify sendTaggedPhotoNotification Cloud Function triggers (check Firebase logs)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript/ESLint errors
- Tag button integrated into darkroom UI
- Friends can be selected and tagged during triage
- Photo documents updated with taggedUserIds on save
- Cloud Function receives tag updates and can send notifications
  </success_criteria>

<output>
After completion, create `.planning/phases/39-darkroom-tagging/39-01-SUMMARY.md`:

# Phase 39 Plan 01: Darkroom Photo Tagging Summary

**[Substantive one-liner]**

## Performance

- **Duration:** X min
- **Started:** YYYY-MM-DD
- **Completed:** YYYY-MM-DD

## Accomplishments

- [Key outcomes]

## Task Commits

1. **Task 1:** commit-hash (type)
2. **Task 2:** commit-hash (type)
3. **Task 3:** commit-hash (type)

## Files Created/Modified

- `path/to/file.js` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Steps

Phase 39 complete. Ready for Phase 40: Feed Photo Tagging.
</output>
