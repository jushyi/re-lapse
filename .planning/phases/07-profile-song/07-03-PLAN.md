---
phase: 07-profile-song
plan: 03
type: execute
---

<objective>
Create SongSearchModal with search input, results list, and preview playback.

Purpose: Allow users to search and preview songs before selecting one for their profile.
Output: SongSearchModal component with search, results, and preview functionality.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-profile-song/07-CONTEXT.md
@.planning/phases/07-profile-song/07-01-SUMMARY.md
@.planning/phases/07-profile-song/07-02-SUMMARY.md
@src/services/iTunesService.js
@src/services/audioPlayer.js
@src/components/ProfileSong/ProfileSongCard.js

**Tech stack available:**

- iTunesService.searchSongs, formatDuration
- audioPlayer for preview playback
- React Native FlatList, Modal, TextInput

**Established patterns:**

- Modal overlay patterns from SelectsEditOverlay
- Dark theme styling

**From CONTEXT.md:**

- Search bar at top
- Results in same card layout as ProfileSongCard (WYSIWYG)
- Tap play button to preview, tap elsewhere on card to select
- Selection navigates to waveform scrubber (next plan)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create SongSearchModal component</name>
  <files>src/components/ProfileSong/SongSearchModal.js, src/components/ProfileSong/index.js</files>
  <action>
Create SongSearchModal component:

**Props:**

```javascript
{
  visible: boolean,
  onClose: () => void,
  onSelectSong: (song: Song) => void,  // Called when user selects a song
}
```

**Layout:**

1. Modal with transparent background, slide-up animation
2. Container (full screen, dark background colors.background.primary)
3. Header row:
   - Back/close button (Ionicons chevron-down, 24px)
   - Title "Search Songs" centered
   - Empty space for balance
4. Search input:
   - TextInput with search icon
   - Placeholder "Search for a song..."
   - Dark styling matching Input component
   - autoFocus={true}
5. Results FlatList:
   - Renders SongSearchResult for each item
   - Empty state: "Search to find songs"
   - Loading state: ActivityIndicator
   - No results: "No songs found"

**State:**

```javascript
const [query, setQuery] = useState('');
const [results, setResults] = useState([]);
const [loading, setLoading] = useState(false);
const [playingId, setPlayingId] = useState(null);
```

**Search with debounce:**

- useRef for timeout
- On query change:
  - Clear previous timeout
  - If query length < 2, clear results, return
  - Set 500ms timeout to call iTunesService.searchSongs
  - Set loading true during search
  - Set results from response
  - Clear loading

**Preview playback management:**

- When a result's play button pressed:
  - If same song already playing, pause it (setPlayingId(null), audioPlayer.stopPreview)
  - Otherwise, stop any current preview, play new one, setPlayingId(song.id)
- Pass playingId to results so they know if they're the currently playing song

**Cleanup:**

- Stop preview on modal close
- Clear search on close
- useEffect cleanup: stop preview on unmount

Avoid: Implementing the waveform scrubber here (Plan 04). Just call onSelectSong with the chosen song.
</action>
<verify>Render modal, type search query, see results appear, play preview, select song</verify>
<done>SongSearchModal with search, results, preview playback, and selection callback</done>
</task>

<task type="auto">
  <name>Task 2: Create SongSearchResult component</name>
  <files>src/components/ProfileSong/SongSearchResult.js, src/components/ProfileSong/index.js</files>
  <action>
Create SongSearchResult component (same layout as ProfileSongCard for WYSIWYG):

**Props:**

```javascript
{
  song: Song,
  isPlaying: boolean,
  onPlayPress: () => void,
  onSelectPress: () => void,
}
```

**Layout (horizontal row, ~60px height):**

1. Album art thumbnail (48x48, rounded corners 8px)
   - expo-image for loading
2. Song info (flex: 1):
   - Title (14pt, bold, colors.text.primary, numberOfLines 1)
   - Artist + Duration (12pt, colors.text.secondary)
     - Format: "Artist Name - 3:45"
     - Use iTunesService.formatDuration
3. Play/Pause button (44x44 touch target):
   - Ionicons play-circle or pause-circle based on isPlaying
   - 32px size

**TouchableOpacity:**

- Main card touch: onSelectPress (select the song)
- Play button: separate TouchableOpacity with onPlayPress

**Visual distinction when playing:**

- Subtle background highlight (colors.background.secondary)
- Or left border accent

Avoid: Managing playback state here (parent manages via playingId). No progress bar (just indicating playing/not playing).
</action>
<verify>Render in a list, verify tap areas work correctly (play vs select)</verify>
<done>SongSearchResult displays song info, has separate tap targets for play preview and select</done>
</task>

<task type="auto">
  <name>Task 3: Wire modal into ProfileScreen</name>
  <files>src/screens/ProfileScreen.js, src/components/index.js</files>
  <action>
Connect SongSearchModal to ProfileScreen:

1. Export SongSearchModal from components/index.js

2. Import SongSearchModal in ProfileScreen

3. The showSongSearch state already exists from Plan 02

4. Add handler for song selection:

```javascript
const handleSongSelected = song => {
  logger.info('ProfileScreen: Song selected', { songId: song.id });
  setShowSongSearch(false);
  // For now, directly save to profile (waveform scrubber in Plan 04)
  // Default clip: 0-30 seconds
  const profileSong = {
    ...song,
    clipStart: 0,
    clipEnd: 30,
  };
  // TODO: Navigate to waveform scrubber (Plan 04)
  // For now, save directly:
  handleSaveSong(profileSong);
};

const handleSaveSong = async songData => {
  try {
    const result = await updateUserDocumentNative(user.uid, { profileSong: songData });
    if (result.success) {
      updateUserProfile({ ...userProfile, profileSong: songData });
      logger.info('ProfileScreen: Profile song saved');
    } else {
      Alert.alert('Error', 'Could not save song. Please try again.');
    }
  } catch (error) {
    logger.error('ProfileScreen: Failed to save song', { error: error.message });
    Alert.alert('Error', error.message || 'An error occurred');
  }
};
```

5. Render SongSearchModal:

```javascript
<SongSearchModal
  visible={showSongSearch}
  onClose={() => setShowSongSearch(false)}
  onSelectSong={handleSongSelected}
/>
```

6. Update handleSongPress to open modal when no song:

```javascript
const handleSongPress = () => {
  if (!profileData?.profileSong) {
    setShowSongSearch(true);
  }
  // Play/pause handled by ProfileSongCard
};
```

Avoid: Implementing waveform scrubber here (Plan 04 will add it between selection and save).
</action>
<verify>On profile, tap empty song card, search modal opens, search for song, select it, modal closes, song appears on profile</verify>
<done>SongSearchModal integrated, users can search and add songs to their profile</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] SongSearchModal component exists and opens from ProfileScreen
- [ ] Search input debounces and returns results
- [ ] Results display with album art, title, artist, duration
- [ ] Preview playback works on play button tap
- [ ] Selecting song (tapping card) saves to profile
- [ ] Song appears on ProfileSongCard after selection
- [ ] No TypeScript/ESLint errors
</verification>

<success_criteria>

- Search modal opens from empty ProfileSongCard
- iTunes search returns and displays results
- Preview playback works
- Song selection saves to Firestore and updates UI
- Modal properly cleans up on close
  </success_criteria>

<output>
After completion, create `.planning/phases/07-profile-song/07-03-SUMMARY.md`
</output>
