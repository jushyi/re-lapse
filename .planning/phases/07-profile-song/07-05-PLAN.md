---
phase: 07-profile-song
plan: 05
type: execute
---

<objective>
Complete profile song integration: ProfileSetupScreen, long-press edit menu, and navigation fade out.

Purpose: Wire up all remaining pieces for a complete profile song experience.
Output: Full integration with onboarding, edit functionality, and polished UX.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-profile-song/07-CONTEXT.md
@.planning/phases/07-profile-song/07-04-SUMMARY.md
@src/screens/ProfileSetupScreen.js
@src/screens/ProfileScreen.js
@src/components/ProfileSong/

**Established patterns:**

- ProfileSetupScreen has placeholder song section (lines 377-405)
- Alert.alert for simple menus (existing pattern)
- Navigation focus/blur listeners for cleanup

**From CONTEXT.md:**

- Long-press menu: Change song, Remove
- Fade out on navigation (1-2 seconds)
- Onboarding: Profile song optional in setup flow
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate song selection into ProfileSetupScreen</name>
  <files>src/screens/ProfileSetupScreen.js</files>
  <action>
Replace placeholder song section with functional song selection:

1. Import required components:

```javascript
import { SongSearchModal, ClipSelectionModal, ProfileSongCard } from '../components';
```

2. Add state for song selection:

```javascript
const [showSongSearch, setShowSongSearch] = useState(false);
const [selectedSongForClip, setSelectedSongForClip] = useState(null);
```

3. Replace handleSongPress placeholder Alert:

```javascript
const handleSongPress = () => {
  if (selectedSong) {
    // If already have a song, could show options
    // For now, just open search to replace
    setShowSongSearch(true);
  } else {
    setShowSongSearch(true);
  }
};
```

4. Add song selection handlers:

```javascript
const handleSongSearchSelect = song => {
  setShowSongSearch(false);
  setSelectedSongForClip(song);
};

const handleClipConfirm = songWithClip => {
  setSelectedSongForClip(null);
  setSelectedSong(songWithClip);
  logger.info('ProfileSetupScreen: Song selected', { songId: songWithClip.id });
};

const handleClipCancel = () => {
  setSelectedSongForClip(null);
};
```

5. Replace song section JSX (lines 377-405):

```javascript
<View style={styles.songSection}>
  <Text style={styles.songLabel}>Profile Song (Optional)</Text>
  <ProfileSongCard
    song={selectedSong}
    isOwnProfile={true}
    onPress={handleSongPress}
    onLongPress={() => {
      if (selectedSong) {
        // Simple remove option during setup
        Alert.alert('Remove Song', 'Remove this song from your profile?', [
          { text: 'Cancel', style: 'cancel' },
          { text: 'Remove', style: 'destructive', onPress: () => setSelectedSong(null) },
        ]);
      }
    }}
  />
</View>
```

6. Add modals at end of component (before closing SafeAreaView):

```javascript
<SongSearchModal
  visible={showSongSearch}
  onClose={() => setShowSongSearch(false)}
  onSelectSong={handleSongSearchSelect}
/>

<ClipSelectionModal
  visible={selectedSongForClip !== null}
  song={selectedSongForClip}
  onConfirm={handleClipConfirm}
  onCancel={handleClipCancel}
/>
```

7. Update styles if needed - ProfileSongCard should fit the existing song section width.

Avoid: Major styling changes (keep consistent with existing design).
</action>
<verify>Navigate to profile setup, tap song section, search and select song, verify clip selection works, song displays in setup</verify>
<done>ProfileSetupScreen has functional song selection with search and clip selection</done>
</task>

<task type="auto">
  <name>Task 2: Add long-press edit menu to ProfileScreen</name>
  <files>src/screens/ProfileScreen.js</files>
  <action>
Implement long-press menu for changing/removing profile song:

1. The showSongMenu state already exists from Plan 02

2. Update handleSongLongPress to show options:

```javascript
const handleSongLongPress = () => {
  if (!profileData?.profileSong) return;

  Alert.alert('Profile Song', profileData.profileSong.title, [
    {
      text: 'Change Song',
      onPress: () => {
        setShowSongSearch(true);
      },
    },
    {
      text: 'Edit Clip',
      onPress: () => {
        // Open clip editor with current song
        setSelectedSongForClip(profileData.profileSong);
      },
    },
    {
      text: 'Remove',
      style: 'destructive',
      onPress: handleRemoveSong,
    },
    {
      text: 'Cancel',
      style: 'cancel',
    },
  ]);
};
```

3. Add remove handler:

```javascript
const handleRemoveSong = async () => {
  logger.info('ProfileScreen: Removing profile song');
  try {
    const result = await updateUserDocumentNative(user.uid, { profileSong: null });
    if (result.success) {
      updateUserProfile({ ...userProfile, profileSong: null });
      logger.info('ProfileScreen: Profile song removed');
    } else {
      Alert.alert('Error', 'Could not remove song. Please try again.');
    }
  } catch (error) {
    logger.error('ProfileScreen: Failed to remove song', { error: error.message });
    Alert.alert('Error', error.message || 'An error occurred');
  }
};
```

4. Add state for clip editing if not exists:

```javascript
const [selectedSongForClip, setSelectedSongForClip] = useState(null);
```

5. Add ClipSelectionModal if not already present:

```javascript
<ClipSelectionModal
  visible={selectedSongForClip !== null}
  song={selectedSongForClip}
  onConfirm={songWithClip => {
    setSelectedSongForClip(null);
    handleSaveSong(songWithClip);
  }}
  onCancel={() => setSelectedSongForClip(null)}
/>
```

Avoid: Complex custom menu (Alert.alert is established pattern).
</action>
<verify>Long-press on profile song, menu appears with Change/Edit Clip/Remove options, each option works</verify>
<done>ProfileScreen has long-press menu for editing profile song</done>
</task>

<task type="auto">
  <name>Task 3: Add navigation fade out for audio cleanup</name>
  <files>src/components/ProfileSong/ProfileSongCard.js</files>
  <action>
Stop audio with fade when navigating away from profile:

1. Import navigation hooks:

```javascript
import { useNavigation, useFocusEffect } from '@react-navigation/native';
import { useCallback } from 'react';
```

2. Add focus effect for cleanup:

```javascript
useFocusEffect(
  useCallback(() => {
    // When screen loses focus (navigate away)
    return () => {
      if (isPlaying) {
        // Fade out and stop
        audioPlayer.stopPreview(); // stopPreview already fades out
        setIsPlaying(false);
        setProgress(0);
      }
    };
  }, [isPlaying])
);
```

3. Ensure audioPlayer.stopPreview uses the fade:
   The fade is already implemented in audioPlayer.js from Plan 01. The 1.5s fade duration is appropriate for navigation transitions.

4. Also clean up on component unmount (already should be there from Plan 02):

```javascript
useEffect(() => {
  return () => {
    audioPlayer.stopPreview();
  };
}, []);
```

Avoid: Playing audio in background (not desired for this feature).
</action>
<verify>Play profile song, navigate to another tab, audio fades out smoothly</verify>
<done>Audio fades out when navigating away from profile</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete profile song feature with all integrations</what-built>
  <how-to-verify>
    1. Run: npx expo start (dev build)

    **Test ProfileSetupScreen flow:**
    2. Sign out and sign up with new phone number
    3. On profile setup, tap "Add a song"
    4. Search and select a song
    5. Select your clip with the waveform
    6. Verify song appears in setup form
    7. Complete profile setup

    **Test ProfileScreen display:**
    8. Navigate to profile tab
    9. Verify your song displays with album art, title, artist
    10. Tap play - audio plays your clip selection
    11. Verify progress bar and glow animation
    12. Navigate to another tab - audio fades out

    **Test long-press menu:**
    13. Return to profile, long-press song card
    14. Verify menu shows: Change Song, Edit Clip, Remove, Cancel
    15. Tap "Edit Clip" - clip selection opens with current settings
    16. Adjust clip and confirm - verify new clip plays
    17. Long-press again, tap "Remove"
    18. Verify song is removed, empty card shows "Add a song"

    **Test empty state:**
    19. Tap empty card - search modal opens
    20. Cancel search - modal closes properly

  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ProfileSetupScreen has functional song selection
- [ ] Song persists through profile setup completion
- [ ] ProfileScreen long-press menu works (Change/Edit Clip/Remove)
- [ ] Audio fades out on navigation
- [ ] All modals open/close properly
- [ ] No TypeScript/ESLint errors
- [ ] Full user journey works end-to-end
</verification>

<success_criteria>

- Profile song works in both setup and profile screens
- Edit menu allows changing, editing clip, and removing song
- Audio cleanup with fade on navigation
- Complete user journey functional
- Phase 7: Profile Song complete
  </success_criteria>

<output>
After completion, create `.planning/phases/07-profile-song/07-05-SUMMARY.md`:

# Phase 7 Plan 05: Full Integration Summary

**Complete profile song integration with setup screen, edit menu, and navigation fade**

## Accomplishments

- ProfileSetupScreen song selection
- Long-press edit menu on ProfileScreen
- Navigation fade out for audio cleanup
- Full feature complete

## Files Created/Modified

- src/screens/ProfileSetupScreen.js - Song selection integration
- src/screens/ProfileScreen.js - Edit menu handlers
- src/components/ProfileSong/ProfileSongCard.js - Navigation cleanup

## Decisions Made

- Alert.alert for edit menu (established pattern)
- Fade out on navigation (not background play)

## Next Phase Readiness

- Phase 7: Profile Song complete
- Ready for Phase 8: User Albums Display
  </output>
