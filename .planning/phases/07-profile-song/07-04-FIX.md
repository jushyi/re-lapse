---
phase: 07-profile-song
plan: 07-04-FIX
type: fix
---

<objective>
Fix 3 UX issues from plan 07-04.

Source: 07-04-ISSUES.md
Priority: 0 critical, 0 major, 3 minor

Note: UAT-001 (full song access) deferred to Phase 7.1 for Spotify/Apple Music integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/07-profile-song/07-04-ISSUES.md

**Original plan for reference:**
@.planning/phases/07-profile-song/07-04-PLAN.md

**Files to modify:**
@src/components/ProfileSong/ClipSelectionModal.js
@src/components/ProfileSong/WaveformScrubber.js
@src/screens/ProfileScreen.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-002 - Make ClipSelectionModal partial height with backdrop dismiss</name>
  <files>src/components/ProfileSong/ClipSelectionModal.js</files>
  <action>
Modify ClipSelectionModal to be ~1/3 screen height with tap-outside dismissal:

1. Change Modal to use transparent background with pressable backdrop
2. Position content container at bottom ~1/3 of screen height
3. Add TouchableWithoutFeedback on backdrop area to call onCancel (which will now go back to search per UAT-004)
4. Content container: rounded top corners, solid background

Layout structure:

```javascript
<Modal transparent animationType="slide">
  <View style={styles.backdrop}>
    <TouchableWithoutFeedback onPress={handleBackdropPress}>
      <View style={styles.backdropTouchable} />
    </TouchableWithoutFeedback>
    <View style={styles.contentContainer}>{/* Song info, waveform, buttons */}</View>
  </View>
</Modal>
```

Styles:

- backdrop: flex 1, backgroundColor transparent
- backdropTouchable: flex 2 (takes ~2/3 of screen)
- contentContainer: flex 1, backgroundColor colors.background.secondary, borderTopLeftRadius 20, borderTopRightRadius 20, padding

Avoid: Making modal too small - needs room for waveform + buttons comfortably
</action>
<verify>Open clip selection, verify modal is ~1/3 height at bottom, tap above modal closes it</verify>
<done>ClipSelectionModal is partial height, tap-outside dismisses back to song search</done>
</task>

<task type="auto">
  <name>Task 2: Fix UAT-003 - Add playback position indicator to WaveformScrubber</name>
  <files>src/components/ProfileSong/WaveformScrubber.js</files>
  <action>
Add a moving vertical line that shows current playback position during preview:

1. Add new prop:

```javascript
currentTime: number; // Current playback position in seconds (0 if not playing)
```

2. Add playback position indicator (vertical line):

- Position calculated: (currentTime / duration) \* waveformWidth
- Render as Animated.View with vertical line style
- Color: distinct from handles (e.g., white or colors.text.primary)
- Width: 2px
- Height: full waveform height
- Only visible when currentTime > 0

3. Use animated position for smooth movement:

```javascript
const playbackPosition = useSharedValue(0);

useEffect(() => {
  playbackPosition.value = withTiming((currentTime / duration) * waveformWidth, { duration: 100 });
}, [currentTime]);
```

4. Render the indicator:

```javascript
{
  currentTime > 0 && (
    <Animated.View
      style={[styles.playbackIndicator, { transform: [{ translateX: playbackPosition }] }]}
    />
  );
}
```

Avoid: Interfering with handle dragging - indicator is display-only, not interactive
</action>
<verify>Play preview, verify white line moves across waveform following playback</verify>
<done>WaveformScrubber shows real-time playback position indicator during preview</done>
</task>

<task type="auto">
  <name>Task 3: Wire playback position to WaveformScrubber</name>
  <files>src/components/ProfileSong/ClipSelectionModal.js</files>
  <action>
Connect audioPlayer position updates to WaveformScrubber:

1. Add position tracking state:

```javascript
const [playbackPosition, setPlaybackPosition] = useState(0);
```

2. Set up position listener when preview plays:

- audioPlayer should have onPlaybackStatusUpdate or similar callback
- Update playbackPosition state with current position

3. If audioPlayer doesn't expose position updates, use setInterval:

```javascript
useEffect(() => {
  let interval;
  if (isPlaying) {
    interval = setInterval(async () => {
      const status = await audioPlayer.getStatus();
      if (status?.isPlaying) {
        // Position relative to clip start
        const position = status.positionMillis / 1000 - clipStart;
        setPlaybackPosition(Math.max(0, position));
      }
    }, 100);
  } else {
    setPlaybackPosition(0);
  }
  return () => clearInterval(interval);
}, [isPlaying, clipStart]);
```

4. Pass to WaveformScrubber:

```javascript
<WaveformScrubber
  currentTime={playbackPosition}
  // ... other props
/>
```

5. Reset position when playback stops or clip range changes

Avoid: Memory leaks - clean up interval on unmount. Polling too frequently.
</action>
<verify>Play preview, verify WaveformScrubber indicator tracks audio position in real-time</verify>
<done>Playback position updates flow from audio player to WaveformScrubber indicator</done>
</task>

<task type="auto">
  <name>Task 4: Fix UAT-004 - Cancel returns to song search</name>
  <files>src/screens/ProfileScreen.js</files>
  <action>
Modify the clip selection flow so cancelling returns to song search:

1. Change onCancel behavior in ClipSelectionModal usage:

```javascript
<ClipSelectionModal
  visible={selectedSongForClip !== null}
  song={selectedSongForClip}
  onConfirm={songWithClip => {
    setSelectedSongForClip(null);
    handleSaveSong(songWithClip);
  }}
  onCancel={() => {
    setSelectedSongForClip(null);
    setShowSongSearch(true); // Re-open song search
  }}
/>
```

2. This allows users to:

- Select a song -> opens clip modal
- Cancel clip selection -> returns to song search to pick different song
- Or confirm clip -> saves and closes everything

3. The backdrop tap in ClipSelectionModal calls onCancel, which now properly returns to search

Avoid: Complex state management - simple flag toggling is sufficient
</action>
<verify>Select song, cancel in clip modal, verify song search reopens instead of closing everything</verify>
<done>Cancelling clip selection returns user to song search modal</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed 3 UX issues: partial-height modal, playback indicator, cancel-to-search navigation</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. Navigate to Profile
    3. Tap song card to open song search
    4. Search and select a song
    5. Verify: ClipSelectionModal is ~1/3 screen height at bottom
    6. Tap the dark area above modal -> should return to song search
    7. Select another song
    8. Tap Preview button
    9. Verify: White/light line moves across waveform showing playback position
    10. Tap X or cancel in clip modal -> should return to song search
    11. Select a song, adjust clip range, tap Confirm
    12. Verify: Song saves to profile
  </how-to-verify>
  <resume-signal>Type "approved" or describe remaining issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] UAT-002 fixed: Modal is partial height with backdrop dismiss
- [ ] UAT-003 fixed: Playback position indicator visible during preview
- [ ] UAT-004 fixed: Cancel returns to song search
- [ ] All flows work end-to-end
</verification>

<success_criteria>

- All UAT issues from 07-04-ISSUES.md addressed
- UX improvements verified by user
- Ready for re-verification or next phase
  </success_criteria>

<output>
After completion, create `.planning/phases/07-profile-song/07-04-FIX-SUMMARY.md`
</output>
