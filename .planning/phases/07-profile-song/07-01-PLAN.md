---
phase: 07-profile-song
plan: 01
type: execute
---

<objective>
Create audio infrastructure for profile song feature - iTunes Search API service and audio player service with fade out.

Purpose: Establish the service layer that all profile song components will use for search and playback.
Output: Two services - iTunesService.js for song search, audioPlayer.js for preview playback with fade and clip support.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-profile-song/07-RESEARCH.md
@.planning/phases/07-profile-song/07-CONTEXT.md
@src/utils/soundUtils.js

**Tech stack available:**

- expo-av 16.0.8 (already installed)
- date-fns 4.1.0 (already installed)
- iTunes Search API (no auth required)

**Established patterns:**

- soundUtils.js shows Audio.Sound.createAsync pattern with auto-unload
- Service layer pattern in src/services/

**From RESEARCH.md:**

- iTunes API: https://itunes.apple.com/search?term={query}&media=music&entity=song&limit=25
- Response includes: trackId, trackName, artistName, artworkUrl100, previewUrl (30s M4A)
- Fade out: loop setVolumeAsync from 1.0 to 0.0 over ~1.5s
- Clip playback: seek to clipStart, schedule fade out before clipEnd
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create iTunes Search API service</name>
  <files>src/services/iTunesService.js</files>
  <action>
Create iTunes Search API service with:

1. Song type definition:

```javascript
/**
 * @typedef {Object} Song
 * @property {string} id - iTunes trackId as string
 * @property {string} title - Track name
 * @property {string} artist - Artist name
 * @property {string} album - Album/collection name
 * @property {string} albumArt - Artwork URL (300x300)
 * @property {string} previewUrl - 30-second preview URL
 * @property {number} duration - Track duration in ms
 */
```

2. searchSongs(query, limit = 25) function:

- Return early with empty array if query is empty/whitespace
- URL encode the query
- Fetch from https://itunes.apple.com/search with params: term, media=music, entity=song, limit
- Map results to Song type
- Replace artworkUrl100 with 300x300 version (regex replace 100x100 with 300x300)
- Handle errors gracefully, return empty array on failure
- Add logger calls for debugging

3. formatDuration(ms) helper:

- Convert milliseconds to "M:SS" format (e.g., 243000 -> "4:03")
- Use for display in song cards

Avoid: Adding debounce here (UI layer handles debounce). No caching (simple API calls).
</action>
<verify>Create a test file that imports iTunesService and calls searchSongs("Taylor Swift") - verify it returns results with all expected fields</verify>
<done>iTunesService.js exports searchSongs and formatDuration, returns properly typed Song objects with 300x300 album art</done>
</task>

<task type="auto">
  <name>Task 2: Create audio player service</name>
  <files>src/services/audioPlayer.js</files>
  <action>
Create audio player service for preview playback with clip support and fade out:

1. Module-level state:

```javascript
let currentSound = null;
let fadeTimeout = null;
let clipEndTimeout = null;
```

2. playPreview(previewUrl, options = {}) function:

- Options: { clipStart = 0, clipEnd = 30, onProgress, onComplete }
- Stop any existing playback first (call stopPreview)
- Create new Audio.Sound with previewUrl
- Seek to clipStart position (in seconds \* 1000)
- Set up playback status update handler:
  - Calculate progress percentage within clip range
  - Call onProgress(progress) where progress is 0-1
  - When position reaches (clipEnd - 1.5) seconds, start fade out
- Start playback
- Schedule clip end timeout for backup stop
- Return sound object for external control

3. stopPreview() function:

- Clear all timeouts
- If currentSound exists, call fadeOutAndStop(currentSound)
- Set currentSound to null

4. fadeOutAndStop(sound, durationMs = 1500) function:

- Pattern from RESEARCH.md:
  - 15 steps over durationMs
  - Loop setVolumeAsync from 1.0 to 0.0
  - After loop, call stopAsync() and unloadAsync()
- Handle errors gracefully (sound may already be unloaded)

5. pausePreview() / resumePreview() functions:

- Simple wrappers around sound.pauseAsync() / sound.playAsync()

6. seekTo(seconds) function:

- sound.setPositionAsync(seconds \* 1000)

Avoid: Background audio mode (profile songs should stop when navigating away - that's desired behavior). No global audio state management (keep it simple).
</action>
<verify>Test by importing and calling playPreview with a known iTunes preview URL, verify audio plays and fades out</verify>
<done>audioPlayer.js exports playPreview, stopPreview, pausePreview, resumePreview, seekTo with proper fade out and clip range support</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] iTunesService.js exists with searchSongs and formatDuration
- [ ] audioPlayer.js exists with all playback functions
- [ ] No TypeScript/ESLint errors
- [ ] Manual test: search returns results, preview plays with fade out
</verification>

<success_criteria>

- Both service files created with documented APIs
- iTunes search returns properly formatted Song objects
- Audio playback includes fade out, clip range support
- No errors when importing services
  </success_criteria>

<output>
After completion, create `.planning/phases/07-profile-song/07-01-SUMMARY.md`
</output>
