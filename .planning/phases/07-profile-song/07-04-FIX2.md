---
phase: 07-profile-song
plan: 07-04-FIX2
type: fix
---

<objective>
Fix 2 UAT issues from plan 07-04 (second round).

Source: 07-04-ISSUES.md
Priority: 0 critical, 1 major, 1 minor

**Deferred:**

- UAT-001 (full song access) → Phase 7.1 for Spotify/Apple Music integration
- UAT-007 (modal stacking) → Phase 7.1 or separate refactor plan (requires screen navigation conversion)
  </objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/07-profile-song/07-04-ISSUES.md

**Previous fix plan:**
@.planning/phases/07-profile-song/07-04-FIX.md

**Files to modify:**
@src/components/ProfileSong/WaveformScrubber.js
@src/components/ProfileSong/ProfileSongCard.js
@src/services/audioPlayer.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-006 - Configure iOS audio to play in silent mode</name>
  <files>src/services/audioPlayer.js</files>
  <action>
Configure expo-av Audio to use playback category so songs play even in silent mode:

1. At the top of audioPlayer.js (or in initialization), set audio mode:

```javascript
import { Audio } from 'expo-av';

// Configure audio to play even in silent mode (like music apps)
Audio.setAudioModeAsync({
  allowsRecordingIOS: false,
  staysActiveInBackground: false,
  playsInSilentModeIOS: true, // Key setting for silent mode
  shouldDuckAndroid: true,
  playThroughEarpieceAndroid: false,
});
```

2. This should be called once when the module initializes, before any sound is played

3. The key setting is `playsInSilentModeIOS: true` which tells iOS to treat this as media playback, not a system sound

4. Note: staysActiveInBackground is false because we want songs to stop when navigating away (per Phase 7 decisions)

Avoid: Setting allowsRecordingIOS to true (not needed, adds permission requirements). Setting staysActiveInBackground to true (we don't want background audio for profile songs).
</action>
<verify>Toggle phone to silent mode, play a profile song preview, verify audio is audible</verify>
<done>Profile song audio plays through speakers regardless of silent switch position</done>
</task>

<task type="auto">
  <name>Task 2: Fix UAT-005 - Smooth playback position animation in WaveformScrubber</name>
  <files>src/components/ProfileSong/WaveformScrubber.js</files>
  <action>
Make the playback position indicator slide smoothly instead of jumping:

1. Current implementation likely uses withTiming with discrete updates
2. Change to use continuous animation that tracks between position updates:

```javascript
// Instead of just updating to new position:
useEffect(() => {
  // Use a longer duration that matches the update interval
  // If we update every 100ms, animate over 100ms for smooth movement
  playbackPosition.value = withTiming((currentTime / duration) * waveformWidth, {
    duration: 100,
    easing: Easing.linear, // Linear for constant speed playback
  });
}, [currentTime, duration, waveformWidth]);
```

3. Ensure the animated style uses the animated value correctly:

```javascript
const animatedIndicatorStyle = useAnimatedStyle(() => ({
  transform: [{ translateX: playbackPosition.value }],
}));
```

4. If updates are coming in too discretely (big jumps), consider:
   - Reducing polling interval in ClipSelectionModal from 100ms to 50ms
   - Or interpolating between known positions

Avoid: Over-complicating with spring animations (linear motion is correct for audio playback)
</action>
<verify>Play preview, verify playback indicator slides smoothly across waveform without visible jumps</verify>
<done>Playback position indicator animates smoothly during preview</done>
</task>

<task type="auto">
  <name>Task 3: Fix UAT-005 - Smooth progress bar animation in ProfileSongCard</name>
  <files>src/components/ProfileSong/ProfileSongCard.js</files>
  <action>
Apply same smooth animation fix to ProfileSongCard progress bar:

1. Check current progress bar implementation
2. If using direct width or transform updates, change to animated values:

```javascript
const progressWidth = useSharedValue(0);

useEffect(() => {
  progressWidth.value = withTiming((currentPosition / clipDuration) * cardWidth, {
    duration: 100,
    easing: Easing.linear,
  });
}, [currentPosition, clipDuration]);

const animatedProgressStyle = useAnimatedStyle(() => ({
  width: progressWidth.value,
}));
```

3. Ensure the progress bar View uses Animated.View with animatedProgressStyle

4. The progress bar should also reset smoothly when playback stops (animate to 0)

Avoid: Abrupt reset when stopping - use a quick fade or slide back
</action>
<verify>Play song from profile, verify progress bar slides smoothly without jumping</verify>
<done>ProfileSongCard progress bar animates smoothly during playback</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed 2 UX issues: audio in silent mode, smooth playback animations</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. **Test silent mode audio (UAT-006):**
       - Set phone to silent mode (flip switch on iPhone)
       - Navigate to Profile
       - Tap song card to play
       - Verify: Audio plays through speaker despite silent mode
    3. **Test smooth animations (UAT-005):**
       - Watch the progress bar on ProfileSongCard
       - Verify: Bar slides smoothly, no visible jumping/snapping
       - Tap to open song search, select a song
       - Play preview in clip selection
       - Verify: White playback indicator slides smoothly across waveform
    4. Toggle phone back to ringer mode
  </how-to-verify>
  <resume-signal>Type "approved" or describe remaining issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] UAT-006 fixed: Song audio plays in silent mode
- [ ] UAT-005 fixed: Playback indicators animate smoothly
- [ ] Both ProfileSongCard and WaveformScrubber have smooth animations
- [ ] Audio session configured correctly for music playback
</verification>

<success_criteria>

- UAT-005 and UAT-006 from 07-04-ISSUES.md resolved
- Smooth playback experience
- Audio behavior matches music apps (plays in silent mode)
- Ready for re-verification or next phase
  </success_criteria>

<output>
After completion, create `.planning/phases/07-profile-song/07-04-FIX2-SUMMARY.md`

Update 07-04-ISSUES.md to mark UAT-005 and UAT-006 as resolved.
</output>
