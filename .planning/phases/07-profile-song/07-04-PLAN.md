---
phase: 07-profile-song
plan: 04
type: execute
---

<objective>
Create WaveformScrubber component for clip selection with start/end range and integrate into song selection flow.

Purpose: Allow users to pick exactly which portion of the 30-second preview plays on their profile.
Output: WaveformScrubber component with dual handles and ClipSelectionModal for the selection flow.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-profile-song/07-RESEARCH.md
@.planning/phases/07-profile-song/07-CONTEXT.md
@.planning/phases/07-profile-song/07-03-SUMMARY.md
@src/services/audioPlayer.js

**Tech stack to install:**

- @simform_solutions/react-native-audio-waveform (native waveform visualization)
- expo-file-system (download audio for waveform)

**From RESEARCH.md:**

- Waveform library requires local file path (not remote URL)
- Download preview to cache first using expo-file-system
- Library supports static mode for file visualization

**From CONTEXT.md:**

- Classic vertical bars showing audio amplitude
- Drag to select start and end points
- Audio plays live as you scrub
- Play button to preview current selection
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Install waveform library and create audio download helper</name>
  <files>src/services/audioDownloader.js, package.json</files>
  <action>
1. Install waveform library:
```bash
npm install @simform_solutions/react-native-audio-waveform
```
Note: This is a native module. Project uses expo-dev-client so it will work in dev builds.

2. Create audio download helper (src/services/audioDownloader.js):

```javascript
import * as FileSystem from 'expo-file-system';
import logger from '../utils/logger';

/**
 * Download audio file for waveform generation.
 * Waveform library requires local file path.
 *
 * @param {string} previewUrl - Remote audio URL
 * @param {string} songId - Unique song ID for cache key
 * @returns {Promise<string>} Local file path
 */
export const downloadForWaveform = async (previewUrl, songId) => {
  const localPath = `${FileSystem.cacheDirectory}preview_${songId}.m4a`;

  try {
    // Check if already cached
    const fileInfo = await FileSystem.getInfoAsync(localPath);
    if (fileInfo.exists) {
      logger.debug('audioDownloader: Using cached file', { songId });
      return localPath;
    }

    // Download file
    logger.info('audioDownloader: Downloading preview', { songId });
    const download = await FileSystem.downloadAsync(previewUrl, localPath);

    if (download.status !== 200) {
      throw new Error(`Download failed with status ${download.status}`);
    }

    logger.info('audioDownloader: Download complete', { songId, uri: download.uri });
    return download.uri;
  } catch (error) {
    logger.error('audioDownloader: Failed to download', { songId, error: error.message });
    throw error;
  }
};

/**
 * Clear cached audio file.
 */
export const clearCachedAudio = async songId => {
  const localPath = `${FileSystem.cacheDirectory}preview_${songId}.m4a`;
  try {
    await FileSystem.deleteAsync(localPath, { idempotent: true });
  } catch (error) {
    logger.warn('audioDownloader: Failed to clear cache', { songId });
  }
};
```

Avoid: Downloading in the waveform component itself (separate concerns).
</action>
<verify>Import and call downloadForWaveform with a test iTunes preview URL, verify file downloads to cache</verify>
<done>Waveform library installed, audioDownloader.js provides local file paths for waveform generation</done>
</task>

<task type="auto">
  <name>Task 2: Create WaveformScrubber component with range selection</name>
  <files>src/components/ProfileSong/WaveformScrubber.js, src/components/ProfileSong/index.js</files>
  <action>
Create WaveformScrubber component:

**Props:**

```javascript
{
  audioPath: string,          // Local file path
  initialStart: number,       // Initial clip start (seconds)
  initialEnd: number,         // Initial clip end (seconds)
  duration: number,           // Total duration (seconds, usually 30)
  onRangeChange: (start, end) => void,  // Called when range changes
}
```

**Important:** The @simform_solutions/react-native-audio-waveform library provides a Waveform component with built-in scrubbing. However, it only supports single-position seeking, not range selection. We need to build dual-handle range selection ON TOP of the waveform visualization.

**Layout:**

1. Container (height ~100px)
2. Waveform visualization (using library's Waveform component in static mode)
3. Range selection overlay:
   - Start handle (draggable vertical line, left)
   - End handle (draggable vertical line, right)
   - Selected region highlight between handles
   - Dimmed regions outside selection

**Waveform component setup:**

```javascript
<Waveform
  mode="static"
  path={audioPath}
  candleSpace={2}
  candleWidth={3}
  candleHeightScale={4}
  containerStyle={{ height: 80 }}
  waveColor="#555"
  scrubColor={colors.text.primary}
/>
```

**Range handles:**

- Use react-native-gesture-handler Pan gesture
- Each handle is a vertical line (4px wide) with larger touch area (40px)
- Start handle: colors.accent.primary or bright color
- End handle: same color
- Clamp positions: start < end, min gap of 5 seconds

**Visual feedback:**

- Dim regions: overlay with colors.background.primary at 0.5 opacity
- Selected region: full brightness
- Handle lines: clear vertical markers

**State:**

```javascript
const [startPos, setStartPos] = useState(initialStart);
const [endPos, setEndPos] = useState(initialEnd);
```

**Pan gesture handling:**

```javascript
const startPanGesture = Gesture.Pan()
  .onUpdate(e => {
    const newStart = positionToSeconds(e.x);
    const clampedStart = Math.min(Math.max(0, newStart), endPos - 5);
    setStartPos(clampedStart);
  })
  .onEnd(() => {
    onRangeChange(startPos, endPos);
  });
```

**Time display:**

- Show start time and end time labels below handles
- Format as "0:15" style

Avoid: Playing audio in this component (parent handles preview). Over-engineering - keep it simple.
</action>
<verify>Render with test audio path, verify waveform displays, handles can be dragged, range updates</verify>
<done>WaveformScrubber displays waveform with draggable start/end handles for clip range selection</done>
</task>

<task type="auto">
  <name>Task 3: Create ClipSelectionModal and wire into selection flow</name>
  <files>src/components/ProfileSong/ClipSelectionModal.js, src/components/ProfileSong/index.js, src/screens/ProfileScreen.js</files>
  <action>
Create ClipSelectionModal:

**Props:**

```javascript
{
  visible: boolean,
  song: Song,                 // Selected song
  onConfirm: (song with clip) => void,
  onCancel: () => void,
}
```

**Layout:**

1. Modal container (similar to SongSearchModal)
2. Header: "Select Your Clip" + close button
3. Song info row (album art, title, artist) - reuse SongSearchResult style
4. WaveformScrubber (80% width, centered)
5. Preview button: Play the current selection
6. Confirm button: "Use This Clip"

**State:**

```javascript
const [clipStart, setClipStart] = useState(0);
const [clipEnd, setClipEnd] = useState(30);
const [audioPath, setAudioPath] = useState(null);
const [loading, setLoading] = useState(true);
const [isPlaying, setIsPlaying] = useState(false);
```

**On mount:**

- Download audio using audioDownloader.downloadForWaveform
- Set audioPath when complete
- Set loading false

**Preview button:**

- Call audioPlayer.playPreview with clipStart, clipEnd
- Toggle isPlaying state
- Stop on second press

**Confirm button:**

- Stop any playback
- Call onConfirm with:

```javascript
{
  ...song,
  clipStart,
  clipEnd,
}
```

**Update ProfileScreen:**

1. Add state:

```javascript
const [selectedSongForClip, setSelectedSongForClip] = useState(null);
```

2. Update handleSongSelected (from Plan 03):

```javascript
const handleSongSelected = song => {
  setShowSongSearch(false);
  setSelectedSongForClip(song); // Open clip selector
};
```

3. Add ClipSelectionModal:

```javascript
<ClipSelectionModal
  visible={selectedSongForClip !== null}
  song={selectedSongForClip}
  onConfirm={songWithClip => {
    setSelectedSongForClip(null);
    handleSaveSong(songWithClip);
  }}
  onCancel={() => setSelectedSongForClip(null)}
/>
```

Avoid: Complex waveform editing features (just start/end selection). Background playback.
</action>
<verify>Select song from search, clip selection modal opens, waveform displays, can select range, preview plays selected range, confirm saves</verify>
<done>ClipSelectionModal allows users to select clip range before saving profile song</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Waveform scrubber with range selection for profile song clip</what-built>
  <how-to-verify>
    1. Run: npx expo start (dev build required for native waveform module)
    2. Navigate to your profile
    3. Tap the empty song card ("Add a song")
    4. Search for any song (e.g., "Beyonce")
    5. Tap a song card (not play button) to select it
    6. Verify clip selection modal opens with waveform
    7. Drag start and end handles to select a portion
    8. Tap "Preview" to hear the selected range
    9. Verify audio plays only the selected portion
    10. Tap "Use This Clip" to confirm
    11. Verify song appears on profile with your clip settings
    12. Play song on profile - verify it plays your selected clip
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Waveform library installed
- [ ] audioDownloader.js downloads and caches audio files
- [ ] WaveformScrubber displays waveform with draggable handles
- [ ] Range selection works (start/end clamped properly)
- [ ] ClipSelectionModal integrates waveform and preview
- [ ] Full flow works: search -> select -> clip selection -> save
- [ ] Audio plays selected clip range on profile
</verification>

<success_criteria>

- Waveform visualization works (native module)
- Range selection with start/end handles
- Preview plays selected portion
- Clip settings saved to profile
- Full song selection flow complete
  </success_criteria>

<output>
After completion, create `.planning/phases/07-profile-song/07-04-SUMMARY.md`
</output>
