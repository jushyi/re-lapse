---
phase: 36-photo-notification-events
plan: 02
type: execute
---

<objective>
Implement tagged photo notification infrastructure that will alert users when they're tagged in photos.

Purpose: Build the notification backend for photo tagging so friends get a subtle heads-up when they're included in someone's moment.
Output: Tagged notification Cloud Function ready to fire when tagging UI is added (Phase 39/40), with grouped notifications and varied templates.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-photo-notification-events/36-CONTEXT.md
@.planning/phases/36-photo-notification-events/36-01-PLAN.md

# Key source files:

@functions/index.js
@src/services/firebase/notificationService.js

# Key requirements from CONTEXT.md:

# - Varied tag templates (4-5+ different wordings)

# - Grouped notifications for batch tags ("Alex tagged you in 3 photos")

# - Deep link: Tagged notification → Opens the photo within that person's story

# - Subtle/informative vibe, not shouty

# Note: Tagging UI will be added in Phase 39 (Darkroom) and Phase 40 (Feed).

# This plan builds the notification infrastructure that those phases will trigger.

</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sendTaggedPhotoNotification Cloud Function</name>
  <files>functions/index.js</files>
  <action>
Create Cloud Function that will fire when photos are tagged (once tagging UI exists):

1. Define the expected photo schema for tagging (for future reference):
   - taggedUserIds: string[] — Array of user IDs tagged in this photo
   - This field will be added by Phase 39/40 when implementing tagging UI

2. Add varied notification templates at top of file:

```javascript
const TAG_NOTIFICATION_TEMPLATES = [
  '{name} tagged you in a photo',
  "You're in {name}'s latest snap",
  '{name} included you in a moment',
  "You made it into {name}'s photo",
  '{name} captured you!',
];

// For batch tags (multiple photos)
const TAG_BATCH_TEMPLATES = [
  '{name} tagged you in {count} photos',
  "You're in {count} of {name}'s snaps",
  '{name} included you in {count} moments',
];
```

3. Create batching mechanism for multiple tags in same session:
   - Track pending tags: `{ "taggerId_taggedId": { photos: [], timeout, ... } }`
   - Debounce window: 30 seconds (longer than reaction debounce since tagging is slower)
   - After window expires, send single grouped notification

4. Create `sendTaggedPhotoNotification` Cloud Function:
   - Trigger: `functions.firestore.document('photos/{photoId}').onUpdate`
   - Check if taggedUserIds array has NEW entries (compare before/after)
   - For each newly tagged user:
     a. Check if pending batch exists for this tagger+tagged combo
     b. If yes: add photoId to batch, reset timeout
     c. If no: create new pending batch, start timeout

5. Batch send function `sendBatchedTagNotification(pendingKey)`:
   - Get tagger's displayName/username and profilePhotoURL
   - Get tagged user's FCM token
   - Choose template based on count (single vs batch)
   - Send push notification with data: { type: 'tagged', photoId, taggerId, photoIds }
   - Write to notifications collection:

```javascript
{
  recipientId: taggedUserId,
  type: 'tagged',
  senderId: taggerId,
  senderName: taggerName,
  senderProfilePhotoURL: profilePhotoURL || null,
  photoId: photoIds[0], // First photo for deep link
  photoIds: photoIds, // All photos in batch
  photoCount: photoIds.length,
  message: selectedTemplate,
  createdAt: serverTimestamp(),
  read: false,
}
```

6. Guard clauses:
   - Skip if tagger is tagging themselves
   - Skip if tagged user has no FCM token
   - Skip if photo was deleted (photoState === 'deleted')

Pattern note: Follow the debouncing pattern from sendReactionNotification which already handles batching reactions from same user.

Why 30-second debounce: Tagging multiple photos during darkroom triage is common. Group them so user gets "tagged you in 3 photos" instead of 3 separate notifications.
</action>
<verify>

- Deploy function: `firebase deploy --only functions`
- Function appears in Firebase Console
- Note: Full testing requires tagging UI from Phase 39/40. For now, verify function deploys and logs show it's registered.
  </verify>
  <done>
- sendTaggedPhotoNotification Cloud Function deployed
- 5+ varied templates for single tags
- 3+ templates for batch tags
- Debouncing with 30-second window
- Notification stored in notifications collection
- Function ready to fire when photos have taggedUserIds field
  </done>
  </task>

<task type="auto">
  <name>Task 2: Add tagged notification deep link handler</name>
  <files>src/services/firebase/notificationService.js</files>
  <action>
Add handler for 'tagged' notification type:

1. In `handleNotificationTapped()`, add case for type === 'tagged':

```javascript
case 'tagged':
  return {
    success: true,
    data: {
      type: 'tagged',
      screen: 'Feed',
      params: {
        highlightUserId: data.taggerId, // Person who tagged (their story)
        highlightPhotoId: data.photoId, // Specific photo to show
        openStory: true,
        scrollToPhoto: true, // Scroll to the specific tagged photo
      },
    },
  };
```

2. The params tell the Feed/Story viewer to:
   - Open the tagger's story
   - Scroll to or highlight the specific photo where user is tagged
   - This allows user to swipe through and see other photos too

Deep link UX from CONTEXT.md: "Tapping a tagged notification → Opens the photo within that person's story (can swipe to see more)"

Implementation note: Full photo-level deep linking may require Story viewer enhancements. For now, structure the params correctly. If Feed/Story viewer needs updates to consume these params, that can be addressed when tagging UI is added.
</action>
<verify>

- Build passes: `npm run lint`
- handleNotificationTapped returns correct data for type === 'tagged'
  </verify>
  <done>
- handleNotificationTapped handles 'tagged' type
- Deep link params include taggerId, photoId for precise navigation
- Navigation structure ready for Feed/Story viewer to consume
  </done>
  </task>

<task type="auto">
  <name>Task 3: Document taggedUserIds schema for Phase 39/40</name>
  <files>.planning/phases/36-photo-notification-events/TAGGING-SCHEMA.md</files>
  <action>
Create documentation file that Phase 39/40 can reference when implementing tagging UI:

````markdown
# Photo Tagging Schema

## Photo Document Updates

When a user tags friends in a photo, the photo document should be updated with:

```javascript
{
  taggedUserIds: ['userId1', 'userId2'], // Array of tagged user IDs
  taggedAt: serverTimestamp(), // When tags were last modified
}
```
````

## Cloud Function Trigger

The `sendTaggedPhotoNotification` Cloud Function (created in Phase 36) watches for:

- `photos/{photoId}.onUpdate`
- Compares before/after `taggedUserIds` arrays
- Sends notifications only for NEWLY added tags

## Integration Points

### Phase 39 (Darkroom Tagging)

- Add tag button to SwipeablePhotoCard or DarkroomScreen
- Before calling triagePhoto(), update photo with taggedUserIds
- Or: Add taggedUserIds to triagePhoto() params

### Phase 40 (Feed Tagging)

- Add "Tag Friends" option to photo three-dots menu
- Call updateDoc on photo with new taggedUserIds array

## Notification Behavior

- Debounced: Multiple tags in 30-second window grouped into single notification
- Templates: Varied wordings to feel human
- Deep link: Opens tagger's story, scrolls to tagged photo

```

This ensures Phase 39/40 implementers know exactly what schema to use for notifications to fire correctly.
  </action>
  <verify>
- File exists at .planning/phases/36-photo-notification-events/TAGGING-SCHEMA.md
- Content clearly documents the expected schema and integration points
  </verify>
  <done>
- Schema documentation created
- Integration points for Phase 39/40 clearly documented
- Cloud Function trigger conditions documented
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run lint` passes in root
- [ ] `cd functions && npm run lint` passes
- [ ] Cloud Function deploys without errors
- [ ] handleNotificationTapped handles 'tagged' type
- [ ] TAGGING-SCHEMA.md exists with clear documentation
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Tagged notification Cloud Function deployed and ready
- Deep link handler in place
- Schema documented for Phase 39/40 integration
- Note: Full end-to-end testing requires tagging UI from Phase 39/40
</success_criteria>

<output>
After completion, create `.planning/phases/36-photo-notification-events/36-02-SUMMARY.md`

Phase 36 complete when both plans are done.
</output>
```
