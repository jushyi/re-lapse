---
phase: 36-photo-notification-events
plan: 01
type: execute
---

<objective>
Implement story notifications that alert friends when someone completes their darkroom triage and posts photos to their story.

Purpose: Keep friends engaged by notifying them when new content is available from people they care about, creating an invitation to view without being pushy.
Output: Working story notification system with varied templates, proper grouping, and deep linking to the poster's story.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-photo-notification-events/36-CONTEXT.md

# Key source files:

@functions/index.js
@src/hooks/useDarkroom.js
@src/services/firebase/photoService.js
@src/services/firebase/notificationService.js
@src/services/firebase/darkroomService.js

# Existing notification patterns:

# - sendPushNotification() utility for Expo Push API

# - sendPhotoRevealNotification triggers on darkroom.onUpdate

# - sendFriendRequestNotification, sendReactionNotification, sendCommentNotification

# Key requirements from CONTEXT.md:

# - Trigger when someone COMPLETES triage (not on each individual post)

# - Varied templates (4-5+ wordings) so notifications feel human

# - Deep link: Opens that user's story view on their last unviewed story

# - "Alex just journaled some snaps" style messaging

</context>

<tasks>

<task type="auto">
  <name>Task 1: Add triage completion tracking</name>
  <files>src/services/firebase/photoService.js, src/services/firebase/darkroomService.js</files>
  <action>
Modify the triage completion flow to track when a user finishes their darkroom session:

1. In photoService.js `batchTriagePhotos()`:
   - After successful triage, count how many photos were journaled (action === 'journal')
   - Return this count in the result: { success: true, journaledCount: X }

2. In darkroomService.js, add new function `recordTriageCompletion(userId, journaledCount)`:
   - Updates darkroom doc with:
     - lastTriageCompletedAt: serverTimestamp()
     - lastJournaledCount: number (how many photos were posted to story)
   - This triggers the Cloud Function

3. In useDarkroom.js `handleDone()`:
   - After batchTriagePhotos succeeds AND journaledCount > 0
   - Call recordTriageCompletion(user.uid, result.journaledCount)
   - Only record if journaledCount > 0 (don't notify for archive-only sessions)

Pattern: Follow existing darkroom update pattern from scheduleNextReveal() for consistency.

Why track journaledCount: Cloud Function needs to know if ANY photos were posted to story. Archive-only sessions shouldn't trigger notifications.
</action>
<verify>

- Build passes: `npm run lint`
- After triaging photos with at least one "Journal" action, darkroom doc in Firebase should have updated lastTriageCompletedAt and lastJournaledCount fields
  </verify>
  <done>
- batchTriagePhotos returns journaledCount
- recordTriageCompletion function exists and updates darkroom doc
- handleDone calls recordTriageCompletion when photos are journaled
- Darkroom doc updates visible in Firebase Console after triage
  </done>
  </task>

<task type="auto">
  <name>Task 2: Create sendStoryNotification Cloud Function</name>
  <files>functions/index.js</files>
  <action>
Create new Cloud Function that triggers when someone posts to their story:

1. Add varied notification templates array at top of file:

```javascript
const STORY_NOTIFICATION_TEMPLATES = [
  '{name} just journaled some snaps',
  '{name} shared new moments',
  'New photos from {name}',
  '{name} posted to their story',
  'See what {name} captured today',
];
```

2. Create helper function `getRandomTemplate(templates)` that picks random template.

3. Create `sendStoryNotification` Cloud Function:
   - Trigger: `functions.firestore.document('darkrooms/{userId}').onUpdate`
   - Check if lastTriageCompletedAt changed (similar to sendPhotoRevealNotification pattern)
   - Check if lastJournaledCount > 0 (only notify for story posts, not archive-only)
   - Guard against duplicate notifications using lastStoryNotifiedAt field

4. Function logic:
   a. Get user's displayName/username for notification
   b. Query friendships where (user1Id == userId OR user2Id == userId) AND status == 'accepted'
   c. For each friend:
   - Get their FCM token from users collection
   - Pick random template, substitute {name}
   - Send push notification with data: { type: 'story', userId: posterId }
   - Write to notifications collection for in-app display
     d. Update darkroom with lastStoryNotifiedAt to prevent duplicates

5. Notification structure for in-app display:

```javascript
{
  recipientId: friendId,
  type: 'story',
  senderId: userId, // person who posted
  senderName: displayName,
  senderProfilePhotoURL: profilePhotoURL || null,
  message: selectedTemplate,
  createdAt: serverTimestamp(),
  read: false,
}
```

Performance note: Query friends once, then batch FCM sends. Don't send notifications in a loop that re-queries for each friend.

Why random templates: Makes notifications feel human and not robotic per CONTEXT.md requirements.
</action>
<verify>

- Deploy function: `cd functions && npm run deploy` (or `firebase deploy --only functions`)
- Check Firebase console shows sendStoryNotification function deployed
- Test by completing a darkroom triage with journaled photos - friends should receive push notification
  </verify>
  <done>
- sendStoryNotification Cloud Function deployed
- 5 varied templates implemented
- Notifications sent to all friends when user posts to story
- Duplicate prevention via lastStoryNotifiedAt
- Notification stored in notifications collection
  </done>
  </task>

<task type="auto">
  <name>Task 3: Add story notification deep link handler</name>
  <files>src/services/firebase/notificationService.js, src/navigation/AppNavigator.js</files>
  <action>
Add handler for 'story' notification type to enable deep linking:

1. In notificationService.js `handleNotificationTapped()`:
   - Add case for type === 'story':

```javascript
case 'story':
  return {
    success: true,
    data: {
      type: 'story',
      screen: 'Feed', // Navigate to Feed where stories are shown
      params: {
        highlightUserId: data.userId, // User whose story to show
        openStory: true, // Signal to auto-open their story
      },
    },
  };
```

2. In AppNavigator.js (or FeedScreen.js depending on where notification handling lives):
   - Check for initialParams.highlightUserId and initialParams.openStory
   - If present, scroll to that user's story card and auto-tap to open story view
   - Clear the params after handling to prevent re-triggering on nav back

Implementation note: The exact navigation depends on how stories are currently displayed. If stories are in a horizontal bar at top of Feed, the handler should:
a. Navigate to Feed screen
b. Find the story card for highlightUserId
c. Auto-open that user's story (simulate tap on their story card)

If this requires significant FeedScreen changes, simplify to just navigating to Feed with the userId. Full auto-open can be enhanced later.
</action>
<verify>

- Build passes: `npm run lint`
- Tap a story notification → should navigate to Feed screen with highlightUserId param
- (Full auto-open verification may need follow-up depending on complexity)
  </verify>
  <done>
- handleNotificationTapped handles 'story' type
- Tapping story notification navigates toward the poster's content
- Navigation params properly structured for FeedScreen to consume
  </done>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run lint` passes in root
- [ ] `cd functions && npm run lint` passes
- [ ] Cloud Function deploys without errors
- [ ] Completing darkroom triage with journaled photos updates lastTriageCompletedAt
- [ ] Friends receive push notification when user posts to story
- [ ] Notification appears in notifications collection with correct structure
- [ ] Tapping notification navigates to Feed
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Story notifications work end-to-end: triage → Cloud Function → push to friends
- Varied templates provide human feel
- Duplicate notifications prevented
- Deep linking works (navigation to Feed at minimum)
  </success_criteria>

<output>
After completion, create `.planning/phases/36-photo-notification-events/36-01-SUMMARY.md`
</output>
