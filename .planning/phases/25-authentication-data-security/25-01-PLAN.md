---
phase: 25-authentication-data-security
plan: 01
type: execute
---

<objective>
Create SecureStore service for encrypted storage and implement comprehensive secure logout with full cleanup.

Purpose: Migrate sensitive FCM token storage from AsyncStorage to iOS Keychain via expo-secure-store, and ensure logout properly clears all local and remote state.
Output: secureStorageService.js, updated AuthContext with secure logout, updated notificationService using SecureStore.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-authentication-data-security/25-RESEARCH.md
@.planning/phases/25-authentication-data-security/25-CONTEXT.md
@.planning/phases/24-cloud-functions-validation/24-01-SUMMARY.md

**Key files to modify:**
@src/context/AuthContext.js
@src/services/firebase/notificationService.js

**Tech stack available:**

- expo-secure-store (to be installed)
- @react-native-firebase/messaging (existing, provides deleteToken())
- AsyncStorage (existing, for non-sensitive data)

**Established patterns:**

- Services use module pattern with exported functions
- Logger utility for structured logging
- try/catch with { success, error } return objects

**Constraining decisions from prior phases:**

- Phase 24: Guard clauses with early null returns pattern
- Zod validation for data shapes (functions layer)

**Research findings to apply:**

- Use AFTER_FIRST_UNLOCK for keychainAccessible (not deprecated ALWAYS)
- Clear Firestore fcmToken BEFORE auth.signOut() to maintain write permission
- messaging().deleteToken() + Firestore cleanup for complete logout
- Don't rely on iOS deleteToken() for new token generation - focus on server-side cleanup
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Install expo-secure-store and create secureStorageService</name>
  <files>package.json, src/services/secureStorageService.js</files>
  <action>
1. Install expo-secure-store: `npx expo install expo-secure-store`

2. Create `src/services/secureStorageService.js` with:
   - Import expo-secure-store and logger
   - KEYCHAIN_SERVICE constant = 'com.spoodsjs.oly' (matches bundle ID)
   - STORAGE_KEYS constant object with FCM_TOKEN key
   - setItem(key, value) - uses SecureStore.setItemAsync with keychainService and keychainAccessible: AFTER_FIRST_UNLOCK, returns boolean success, catches errors gracefully (2KB limit can fail)
   - getItem(key) - uses SecureStore.getItemAsync, returns string | null, catches errors
   - deleteItem(key) - uses SecureStore.deleteItemAsync, returns boolean success
   - clearAll() - deletes all known keys from STORAGE_KEYS

Use logger.debug for operations and logger.error for failures. Pattern matches existing services.

**AVOID:** Using deprecated ALWAYS keychainAccessible - use AFTER_FIRST_UNLOCK per research.
**AVOID:** Storing anything >2KB - FCM tokens are small, this is fine.
</action>
<verify>

- `npm run lint` passes
- Service file exists with all 4 methods
- AFTER_FIRST_UNLOCK is used (grep for it)
  </verify>
  <done>
- expo-secure-store installed in package.json
- secureStorageService.js created with setItem, getItem, deleteItem, clearAll
- Uses AFTER_FIRST_UNLOCK, not ALWAYS
  </done>
  </task>

<task type="auto">
  <name>Task 2: Update notificationService to use SecureStore for FCM token</name>
  <files>src/services/firebase/notificationService.js</files>
  <action>
1. Import secureStorageService at top: `import { secureStorage, STORAGE_KEYS } from '../secureStorageService';`

2. Update storeNotificationToken function:
   - After successfully storing to Firestore, also store locally: `await secureStorage.setItem(STORAGE_KEYS.FCM_TOKEN, token);`
   - Log success for both Firestore and SecureStore

3. Add new function getLocalNotificationToken():
   - Returns token from SecureStore: `return secureStorage.getItem(STORAGE_KEYS.FCM_TOKEN);`
   - Used for checking if token exists without network call

4. Add new function clearLocalNotificationToken():
   - Calls `secureStorage.deleteItem(STORAGE_KEYS.FCM_TOKEN)`
   - Used during logout cleanup

**AVOID:** Removing Firestore storage - tokens still need to be in Firestore for Cloud Functions to send notifications.
</action>
<verify>

- `npm run lint` passes
- storeNotificationToken stores to both Firestore AND SecureStore
- New functions getLocalNotificationToken and clearLocalNotificationToken exist
  </verify>
  <done>
- FCM token stored in SecureStore after Firestore write
- getLocalNotificationToken function added
- clearLocalNotificationToken function added
  </done>
  </task>

<task type="auto">
  <name>Task 3: Implement comprehensive secure logout in AuthContext</name>
  <files>src/context/AuthContext.js</files>
  <action>
1. Add imports at top:
   - `import messaging from '@react-native-firebase/messaging';`
   - `import AsyncStorage from '@react-native-async-storage/async-storage';`
   - `import { clearLocalNotificationToken } from '../services/firebase/notificationService';`
   - `import { secureStorage } from '../services/secureStorageService';`

2. Replace signOut function with comprehensive cleanup:

```javascript
const signOut = async () => {
  logger.info('AuthContext: Sign out requested - starting comprehensive cleanup');
  try {
    setLoading(true);
    const userId = user?.uid;

    // Step 1: Clear FCM token from Firestore FIRST (while still authenticated)
    if (userId) {
      logger.debug('AuthContext: Clearing FCM token from Firestore', { userId });
      const userRef = doc(db, 'users', userId);
      await updateDoc(userRef, {
        fcmToken: null,
        updatedAt: serverTimestamp(),
      });
      logger.info('AuthContext: FCM token cleared from Firestore');
    }

    // Step 2: Delete local FCM token from RN Firebase (stops receiving notifications)
    try {
      await messaging().deleteToken();
      logger.info('AuthContext: Local FCM token deleted');
    } catch (fcmError) {
      // Non-fatal - continue with logout even if this fails
      logger.warn('AuthContext: Failed to delete FCM token', { error: fcmError.message });
    }

    // Step 3: Clear SecureStore items
    await secureStorage.clearAll();
    logger.info('AuthContext: SecureStore cleared');

    // Step 4: Clear local notification token reference
    await clearLocalNotificationToken();

    // Step 5: Clear AsyncStorage (non-sensitive cached data like upload queue)
    await AsyncStorage.clear();
    logger.info('AuthContext: AsyncStorage cleared');

    // Step 6: Sign out from Firebase Auth (last - after all cleanup)
    const auth = getAuth();
    await auth.signOut();

    setUser(null);
    setUserProfile(null);
    logger.info('AuthContext: Sign out successful - all cleanup complete');
    return { success: true };
  } catch (error) {
    logger.error('AuthContext: Sign out failed', { error: error.message });
    return { success: false, error: error.message };
  } finally {
    setLoading(false);
  }
};
```

**CRITICAL ORDER:** Firestore cleanup MUST happen before auth.signOut() - user loses write permission after signing out.

**AVOID:** Skipping any cleanup step - all 6 steps are needed for complete logout.
**AVOID:** Throwing on FCM deleteToken failure - it's non-fatal, wrap in try/catch.
</action>
<verify>

- `npm run lint` passes
- signOut function has all 6 cleanup steps in correct order
- FCM token Firestore update happens BEFORE auth.signOut()
- FCM deleteToken wrapped in try/catch (non-fatal)
  </verify>
  <done>
- AuthContext signOut performs comprehensive cleanup
- Order: Firestore FCM → deleteToken → SecureStore → AsyncStorage → signOut
- All steps logged for debugging
  </done>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run lint` passes
- [ ] expo-secure-store in package.json dependencies
- [ ] secureStorageService.js exists with 4 methods
- [ ] notificationService stores FCM token to SecureStore
- [ ] AuthContext signOut has 6-step cleanup in correct order
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No lint errors
- FCM tokens stored securely in iOS Keychain via SecureStore
- Logout properly cleans up: Firestore → FCM → SecureStore → AsyncStorage → Auth
  </success_criteria>

<output>
After completion, create `.planning/phases/25-authentication-data-security/25-01-SUMMARY.md`
</output>
