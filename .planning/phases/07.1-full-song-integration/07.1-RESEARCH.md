# Phase 7.1: Full Song Music Integration - Research

**Researched:** 2026-01-28
**Domain:** Spotify Web API, Apple MusicKit, React Native music streaming
**Confidence:** HIGH

<research_summary>

## Summary

Researched Spotify and Apple Music integration for allowing users to select any 30-second clip from full songs (not just iTunes 30-second previews). The research uncovered a **critical constraint** that fundamentally impacts the phase design.

**Critical finding:** Spotify does NOT allow third-party mobile apps to stream full songs directly. Their mobile streaming SDKs were deprecated in 2022. The App Remote SDK only _controls_ the external Spotify app (which must be installed) - it doesn't stream audio within your app. This means the user's vision of "full scrollable waveform in-app" is **not possible with Spotify**.

Apple MusicKit CAN stream full songs natively in iOS apps (with active subscription), making it the only viable option for true in-app full song playback.

**Revised recommendation:** Either (A) Apple Music-only full song integration (iOS only), (B) Spotify App Remote that controls external Spotify app (requires app installed + Premium), or (C) keep the current iTunes 30s preview approach. The original vision of seamless in-app full song scrubbing for both services is not technically feasible with Spotify's current APIs.

**Primary recommendation:** Implement Apple MusicKit for iOS full song integration. For Spotify users, either use App Remote (opens Spotify app for playback) or gracefully fall back to iTunes 30s previews while clearly communicating the limitation.
</research_summary>

<standard_stack>

## Standard Stack

### Core

| Library                          | Version | Purpose                 | Why Standard                           |
| -------------------------------- | ------- | ----------------------- | -------------------------------------- |
| @lomray/react-native-apple-music | 1.2.1   | Apple MusicKit wrapper  | Active, supports playback/search/queue |
| react-native-spotify-remote      | 1.4.0   | Spotify App Remote SDK  | Only maintained Spotify library for RN |
| react-native-app-auth            | 7.x     | OAuth PKCE flows        | Handles token exchange, PKCE challenge |
| expo-av                          | 16.x    | iTunes preview playback | Already in project, works for fallback |

### Supporting

| Library                                        | Version | Purpose                | When to Use                                |
| ---------------------------------------------- | ------- | ---------------------- | ------------------------------------------ |
| expo-secure-store                              | latest  | Token storage          | Store OAuth tokens securely                |
| @simform_solutions/react-native-audio-waveform | 1.3.x   | Waveform visualization | For Apple Music local playback             |
| jsonwebtoken                                   | 9.x     | JWT generation         | Apple Music developer tokens (server-side) |

### Alternatives Considered

| Instead of                       | Could Use                | Tradeoff                                |
| -------------------------------- | ------------------------ | --------------------------------------- |
| react-native-spotify-remote      | Spotify Web Playback SDK | Web SDK doesn't work in React Native    |
| @lomray/react-native-apple-music | expo-music-kit           | expo-music-kit is less mature, dev only |
| react-native-app-auth            | expo-auth-session        | app-auth has better Spotify docs        |

**Installation:**

```bash
npm install @lomray/react-native-apple-music react-native-spotify-remote react-native-app-auth expo-secure-store
# Requires iOS development build, cannot test in Expo Go
```

**iOS Requirements:**

- iOS 16.0+ for full MusicKit functionality
- MusicKit entitlement in Apple Developer account
- Physical device required (simulator doesn't support MusicKit)
  </standard_stack>

<architecture_patterns>

## Architecture Patterns

### Recommended Project Structure

```
src/
├── services/
│   ├── musicProviders/
│   │   ├── types.ts              # Shared types for all providers
│   │   ├── appleMusicService.ts  # Apple MusicKit wrapper
│   │   ├── spotifyService.ts     # Spotify Remote SDK wrapper
│   │   ├── iTunesService.ts      # Existing iTunes API (fallback)
│   │   └── index.ts              # Provider factory/manager
│   ├── audioPlayer.js            # Keep existing for iTunes playback
│   └── authService.ts            # OAuth token management
├── contexts/
│   └── MusicProviderContext.tsx  # Connected accounts state
├── screens/
│   └── ConnectedAccountsScreen/  # Settings: link/unlink accounts
└── components/
    └── ProfileSong/
        ├── SongSearchModal.tsx   # Enhanced with inline connect prompt
        └── ClipSelectionModal.tsx # Full song waveform for Apple Music
```

### Pattern 1: Provider Abstraction

**What:** Abstract music providers behind common interface
**When to use:** Any music search/playback operation
**Example:**

```typescript
// Unified provider interface
interface MusicProvider {
  name: 'spotify' | 'appleMusic' | 'itunes';
  isConnected: boolean;
  canStreamFullSongs: boolean;

  search(query: string): Promise<Song[]>;
  getStreamUrl(songId: string): Promise<string | null>;
  seekTo(positionMs: number): Promise<void>;
}

// Factory returns appropriate provider based on connected accounts
function getMusicProvider(connectedAccounts: ConnectedAccounts): MusicProvider {
  if (connectedAccounts.appleMusic && Platform.OS === 'ios') {
    return new AppleMusicProvider();
  }
  if (connectedAccounts.spotify) {
    return new SpotifyRemoteProvider(); // Note: controls external app
  }
  return new ITunesProvider(); // Fallback: 30s previews
}
```

### Pattern 2: Spotify App Remote Control

**What:** Control playback in external Spotify app
**When to use:** When user has Spotify linked and wants full songs
**Example:**

```typescript
// Source: react-native-spotify-remote docs
import {
  auth as SpotifyAuth,
  remote as SpotifyRemote,
  ApiScope,
} from 'react-native-spotify-remote';

const spotifyConfig = {
  clientID: 'YOUR_CLIENT_ID',
  redirectURL: 'yourapp://spotify-auth',
  tokenSwapURL: 'https://your-server.com/api/spotify/swap',
  tokenRefreshURL: 'https://your-server.com/api/spotify/refresh',
  scopes: [ApiScope.AppRemoteControlScope],
};

async function playSpotifySong(trackUri: string, positionMs: number) {
  const session = await SpotifyAuth.authorize(spotifyConfig);
  await SpotifyRemote.connect(session.accessToken);
  await SpotifyRemote.playUri(trackUri);
  await SpotifyRemote.seek(positionMs); // Seek to clip start
}
```

### Pattern 3: Apple MusicKit Playback

**What:** Native in-app playback via MusicKit
**When to use:** iOS users with Apple Music subscription
**Example:**

```typescript
// Source: @lomray/react-native-apple-music
import { Auth, MusicKit, Player } from '@lomray/react-native-apple-music';

async function playAppleMusicSong(songId: string, positionSec: number) {
  // Check subscription first
  const hasSubscription = await Auth.checkSubscription();
  if (!hasSubscription) {
    throw new Error('Apple Music subscription required');
  }

  // Set queue and play
  await MusicKit.setPlaybackQueue(songId, 'song');
  await Player.play();

  // Note: Seek functionality may need custom implementation
  // Native MusicKit has playbackTime but RN wrapper may be limited
}
```

### Pattern 4: OAuth Token Management

**What:** Secure storage and refresh of OAuth tokens
**When to use:** All authenticated API calls
**Example:**

```typescript
// Source: react-native-app-auth + expo-secure-store
import { authorize, refresh } from 'react-native-app-auth';
import * as SecureStore from 'expo-secure-store';

const SPOTIFY_CONFIG = {
  clientId: 'YOUR_CLIENT_ID',
  redirectUrl: 'yourapp://callback',
  scopes: ['app-remote-control', 'user-read-playback-state'],
  serviceConfiguration: {
    authorizationEndpoint: 'https://accounts.spotify.com/authorize',
    tokenEndpoint: 'https://accounts.spotify.com/api/token',
  },
  usePKCE: true, // Required as of Nov 2025
};

async function connectSpotify() {
  const result = await authorize(SPOTIFY_CONFIG);
  await SecureStore.setItemAsync('spotify_access', result.accessToken);
  await SecureStore.setItemAsync('spotify_refresh', result.refreshToken);
  return result;
}
```

### Anti-Patterns to Avoid

- **Expecting in-app Spotify streaming:** Not possible - SDK was deprecated 2022
- **Skipping PKCE for Spotify OAuth:** Implicit grant deprecated Nov 2025
- **Testing MusicKit in simulator:** Only works on physical iOS devices
- **Storing tokens in AsyncStorage:** Use SecureStore for OAuth tokens
- **Generating Apple developer tokens client-side:** Must be server-side with private key
  </architecture_patterns>

<dont_hand_roll>

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem               | Don't Build                    | Use Instead                   | Why                                 |
| --------------------- | ------------------------------ | ----------------------------- | ----------------------------------- |
| OAuth PKCE flow       | Manual code verifier/challenge | react-native-app-auth         | Complex crypto, platform quirks     |
| Apple developer token | Client-side JWT                | Server-side with private key  | Key must never be in app bundle     |
| Spotify playback      | Web Playback SDK in WebView    | App Remote SDK                | WebView stops audio when locked     |
| Token refresh         | Manual timer logic             | react-native-app-auth refresh | Handles edge cases, race conditions |
| Secure token storage  | AsyncStorage                   | expo-secure-store             | Encrypted, keychain/keystore backed |
| Waveform from stream  | Custom FFT analysis            | Download first + waveform lib | Real-time waveform from URL is hard |

**Key insight:** Music service integration requires precise OAuth implementation and platform-specific SDKs. The Spotify Mobile Streaming SDK being deprecated means there's literally no way to stream Spotify audio directly in a React Native app - you MUST use App Remote which controls the external Spotify app.
</dont_hand_roll>

<common_pitfalls>

## Common Pitfalls

### Pitfall 1: Assuming Spotify Streams In-App (CRITICAL)

**What goes wrong:** Building UI expecting Spotify audio to play within app
**Why it happens:** Spotify's Web Playback SDK works in browsers, easy to assume mobile works too
**How to avoid:** Understand that react-native-spotify-remote controls external Spotify app
**Warning signs:** Planning "seamless" experience without acknowledging Spotify app requirement

### Pitfall 2: Spotify Extended Quota Unavailable

**What goes wrong:** App works for dev team but fails to scale
**Why it happens:** Since May 2025, extended quota only available to organizations, not individuals
**How to avoid:** Development mode allows only 25 users (must be allowlisted). Plan for this limit or apply as organization.
**Warning signs:** Planning features requiring many users without quota extension

### Pitfall 3: Apple MusicKit Requires Physical Device

**What goes wrong:** Crashes or "not available" errors during development
**Why it happens:** MusicKit doesn't work in iOS Simulator
**How to avoid:** Always test Apple Music features on real device
**Warning signs:** "MusicKit is not available" errors in development

### Pitfall 4: Missing Token Swap Server for Spotify

**What goes wrong:** OAuth flow fails or tokens can't refresh
**Why it happens:** Spotify PKCE requires token swap/refresh endpoints
**How to avoid:** Set up server endpoints or use Firebase Functions
**Warning signs:** "Invalid redirect URI" errors, token refresh failures

### Pitfall 5: Waveform Generation from Remote URL

**What goes wrong:** Waveform library fails with streaming URL
**Why it happens:** Many waveform libraries only support local file paths
**How to avoid:** For full songs, may need to process segments or use different approach
**Warning signs:** Empty waveform, timeout errors with long URLs

### Pitfall 6: Silent Mode on iOS

**What goes wrong:** Audio doesn't play when phone is on silent
**Why it happens:** Default iOS audio session respects silent switch
**How to avoid:** Already configured in audioPlayer.js with playsInSilentModeIOS: true
**Warning signs:** Audio works with ringer on but not in silent mode
</common_pitfalls>

<code_examples>

## Code Examples

Verified patterns from official sources:

### Spotify OAuth with PKCE (react-native-app-auth)

```typescript
// Source: react-native-app-auth Spotify docs
// https://nearform.com/open-source/react-native-app-auth/docs/providers/spotify/
import { authorize } from 'react-native-app-auth';

const config = {
  clientId: 'SPOTIFY_CLIENT_ID',
  redirectUrl: 'com.yourapp:/oauth',
  scopes: ['app-remote-control', 'user-read-playback-state'],
  serviceConfiguration: {
    authorizationEndpoint: 'https://accounts.spotify.com/authorize',
    tokenEndpoint: 'https://accounts.spotify.com/api/token',
  },
  usePKCE: true,
};

// Note: Spotify requires token swap server for refresh
// tokenSwapEndpoint and tokenRefreshEndpoint needed for production
```

### Spotify Remote SDK Seek

```typescript
// Source: cjam.github.io/react-native-spotify-remote
import { remote as SpotifyRemote } from 'react-native-spotify-remote';

// Seek to 58 seconds (position in milliseconds)
await SpotifyRemote.seek(58000);

// Get current state
const state = await SpotifyRemote.getPlayerState();
console.log('Position:', state.playbackPosition); // milliseconds
```

### Apple MusicKit Authorization

```typescript
// Source: @lomray/react-native-apple-music npm
import { Auth, MusicKit } from '@lomray/react-native-apple-music';

async function connectAppleMusic() {
  // Request user authorization
  const status = await Auth.authorize();

  // Check subscription status
  const canPlay = await Auth.checkSubscription();

  if (canPlay) {
    // User has active subscription, can play catalog
    return true;
  }
  return false;
}
```

### Apple Music Developer Token (Server-Side)

```typescript
// Source: Apple Developer Documentation
// https://developer.apple.com/documentation/applemusicapi/generating-developer-tokens
// This MUST run on server, not in app

import jwt from 'jsonwebtoken';
import fs from 'fs';

function generateAppleMusicToken() {
  const privateKey = fs.readFileSync('AuthKey_XXXXXXXXXX.p8');

  const token = jwt.sign({}, privateKey, {
    algorithm: 'ES256',
    expiresIn: '180d',
    issuer: 'YOUR_TEAM_ID', // 10-character Team ID
    header: {
      alg: 'ES256',
      kid: 'YOUR_KEY_ID', // 10-character Key ID
    },
  });

  return token;
}
```

### Connected Accounts Context

```typescript
// Pattern for managing linked music services
interface ConnectedAccounts {
  spotify: { connected: boolean; hasPremium: boolean } | null;
  appleMusic: { connected: boolean; hasSubscription: boolean } | null;
}

const MusicProviderContext = createContext<{
  accounts: ConnectedAccounts;
  connectSpotify: () => Promise<void>;
  connectAppleMusic: () => Promise<void>;
  disconnect: (provider: 'spotify' | 'appleMusic') => Promise<void>;
  preferredProvider: 'spotify' | 'appleMusic' | 'itunes';
}>({...});
```

</code_examples>

<sota_updates>

## State of the Art (2025-2026)

| Old Approach                         | Current Approach            | When Changed | Impact                                      |
| ------------------------------------ | --------------------------- | ------------ | ------------------------------------------- |
| Spotify Mobile Streaming SDK         | App Remote SDK only         | 2022         | Cannot stream in third-party apps           |
| Spotify implicit grant OAuth         | PKCE required               | Nov 2025     | All apps must use Authorization Code + PKCE |
| HTTP OAuth redirects                 | HTTPS only                  | Nov 2025     | Deep link schemes must be HTTPS             |
| Spotify extended quota (individuals) | Organizations only          | May 2025     | Individual devs limited to 25 users         |
| react-native-spotify (lufinkey)      | react-native-spotify-remote | Ongoing      | Old lib deprecated, new uses Remote SDK     |

**New tools/patterns to consider:**

- **expo-music-kit:** Apple MusicKit for Expo/React Native (iOS + Web) - emerging option
- **Spotify Web Playback SDK in WebView:** Works but audio stops when screen locks
- **react-native-audio-api:** Software Mansion's new audio library, <10ms latency

**Deprecated/outdated:**

- **Spotify Mobile Streaming SDK:** Completely non-functional since 2022
- **rn-spotify-sdk / react-native-spotify:** Uses deprecated streaming SDK
- **Spotify implicit grant flow:** Deadline Nov 27, 2025
- **localhost/HTTP redirect URIs for Spotify:** No longer supported
  </sota_updates>

<open_questions>

## Open Questions

Things that couldn't be fully resolved:

1. **Spotify UX When Controlling External App**
   - What we know: App Remote controls Spotify app, audio plays in Spotify
   - What's unclear: How to show waveform when audio isn't in your app
   - Recommendation: May need to show "Playing in Spotify" state, or just show clip bounds without live scrubbing

2. **Apple MusicKit Seek Functionality in React Native**
   - What we know: Native MusicKit has playbackTime, @lomray wrapper has basic controls
   - What's unclear: Whether wrapper exposes precise seek to position
   - Recommendation: May need to fork library or use native module for seek

3. **Full Song Waveform Generation**
   - What we know: Waveform libs work with local files
   - What's unclear: How to generate waveform for 3-4 minute song without downloading entire file
   - Recommendation: Could pre-render waveform on server, or use approximation/placeholder visualization

4. **User Expectation Management**
   - What we know: User expected seamless in-app experience for both services
   - What's unclear: Whether "control Spotify app" UX is acceptable
   - Recommendation: Discuss with user before implementing - may want Apple Music only, or accept current iTunes approach
     </open_questions>

<sources>
## Sources

### Primary (HIGH confidence)

- [Spotify Web API Documentation](https://developer.spotify.com/documentation/web-api) - Rate limits, quota modes, scopes
- [Spotify App Remote SDK (Android)](https://spotify.github.io/android-sdk/app-remote-lib/) - PlayerApi, seek functionality
- [Spotify OAuth Migration Reminder](https://developer.spotify.com/blog/2025-10-14-reminder-oauth-migration-27-nov-2025) - PKCE requirement deadline
- [Spotify Extended Quota Update May 2025](https://developer.spotify.com/blog/2025-04-15-updating-the-criteria-for-web-api-extended-access) - Organizations only policy
- [Apple MusicKit Documentation](https://developer.apple.com/musickit/) - Official Apple reference
- [Apple MusicKit playbackTime](https://developer.apple.com/documentation/musickit/musicplayer/playbacktime) - Seek/position docs
- [react-native-spotify-remote](https://github.com/cjam/react-native-spotify-remote) - Maintained RN Spotify library
- [@lomray/react-native-apple-music](https://github.com/Lomray-Software/react-native-apple-music) - RN MusicKit wrapper
- [react-native-app-auth Spotify](https://nearform.com/open-source/react-native-app-auth/docs/providers/spotify/) - OAuth implementation

### Secondary (MEDIUM confidence)

- [Spotify Community: Web Playback SDK in React Native](https://community.spotify.com/t5/Spotify-for-Developers/Spotify-Web-Playback-SDK-in-React-Native-WebView/td-p/5370122) - Confirmed not supported
- [Spotify Community: React Native integration](https://community.spotify.com/t5/Spotify-for-Developers/how-to-integrate-spotify-with-my-own-react-native-application/td-p/5852534) - Remote SDK recommendation
- [Apple Developer Forums: MusicKit playbackTime](https://developer.apple.com/forums/thread/687487) - Observing playback position

### Tertiary (LOW confidence - needs validation)

- [npm-compare audio libraries](https://npmtrends.com/expo-av-vs-react-native-track-player) - Popularity metrics
- Various GitHub issues on waveform from streaming URLs
  </sources>

<metadata>
## Metadata

**Research scope:**

- Core technology: Spotify Web API + App Remote SDK, Apple MusicKit
- Ecosystem: OAuth libraries, audio playback, React Native wrappers
- Patterns: Multi-provider auth, token management, graceful fallback
- Pitfalls: Streaming limitations, quota restrictions, platform constraints

**Confidence breakdown:**

- Standard stack: HIGH - verified with official docs and npm
- Architecture: HIGH - patterns from official library documentation
- Pitfalls: HIGH - critical constraints from official Spotify blog posts
- Code examples: HIGH - from official library documentation

**Research date:** 2026-01-28
**Valid until:** 2026-02-28 (30 days - music API policies actively changing)
</metadata>

---

_Phase: 07.1-full-song-integration_
_Research completed: 2026-01-28_
_Ready for planning: NEEDS DISCUSSION - critical Spotify constraint affects scope_
