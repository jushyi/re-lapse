---
phase: 02-darkroom-bottom-sheet
plan: 02
type: execute
---

<objective>
Connect press-and-hold completion to darkroom reveal flow and add haptic feedback for tactile confirmation.

Purpose: Complete the reveal interaction by navigating to DarkroomScreen on press completion and providing haptic feedback for engagement.
Output: Press-and-hold triggers photo reveal navigation, haptic feedback at progress milestones, seamless integration with existing darkroom logic.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-darkroom-bottom-sheet/02-01-SUMMARY.md
@src/components/DarkroomBottomSheet.js
@src/screens/CameraScreen.js
@src/screens/DarkroomScreen.js

**Tech stack available (from Plan 02-01):**
- DarkroomBottomSheet component with press-and-hold progress bar
- expo-haptics ~15.0.8 (already in package.json)
- Existing darkroom reveal logic in DarkroomScreen (Phase 0)

**Established patterns (from Plan 02-01):**
- DarkroomBottomSheet onComplete callback fires at 100% progress
- CameraScreen passes navigation prop to components
- DarkroomScreen automatically checks isDarkroomReadyToReveal and calls revealPhotos
- Badge count polling updates every 30s

**Constraining decisions:**
- Keep existing darkroom reveal logic in DarkroomScreen unchanged (no backend changes)
- Navigation to Darkroom triggers existing reveal flow (batch reveal + schedule next)
- Haptic feedback should enhance, not overwhelm (milestone-based, not continuous)

**From prior phase:**
- Phase 1: Darkroom access moved from tab to CameraScreen button
- Plan 02-01: Bottom sheet with progress bar interaction created

</context>

<tasks>

<task type="auto">
  <name>Task 1: Connect press-and-hold completion to darkroom navigation</name>
  <files>src/components/DarkroomBottomSheet.js, src/screens/CameraScreen.js</files>
  <action>
**In DarkroomBottomSheet.js:**
- When progress reaches 100% (animated value = 1), call onComplete callback prop
- Add small delay (200ms) after completion before allowing close (let user see full bar)
- Logger: logger.info('DarkroomBottomSheet: Press-and-hold completed', { count })

**In CameraScreen.js:**
- Update onComplete prop in DarkroomBottomSheet:
  ```javascript
  onComplete={() => {
    logger.info('CameraScreen: Navigating to Darkroom after press-and-hold', { count: darkroomCount });
    setIsBottomSheetVisible(false);
    navigation.navigate('Darkroom');
  }}
  ```
- Close bottom sheet before navigation (setIsBottomSheetVisible(false))
- Navigate to 'Darkroom' screen (existing screen, no changes needed)

**Integration with Existing Flow:**
- DarkroomScreen already handles reveal logic in useFocusEffect (lines 23-28 in DarkroomScreen.js)
- isDarkroomReadyToReveal checks if nextRevealAt <= currentTime
- revealPhotos updates ALL developing photos to revealed status
- scheduleNextReveal sets next reveal time (0-2 hours from now)
- No changes needed in DarkroomScreen - navigation triggers existing flow

**Edge Cases:**
- If user closes bottom sheet manually (backdrop press), do NOT navigate
- Only navigate when onComplete fires (100% progress reached)
- Badge count will update on next poll (30s) or when returning to Camera tab

**What NOT to change:**
- Do not modify DarkroomScreen reveal logic (keep existing backend flow)
- Do not change photoService or darkroomService (backend unchanged)
- Do not add loading states (existing DarkroomScreen handles that)
  </action>
  <verify>
1. npm start and test in Expo Go on physical device
2. Take a photo to create developing photo (count > 0)
3. Wait for badge count to update
4. Tap darkroom button to open bottom sheet
5. Press and hold until progress bar reaches 100%
6. Verify:
   - Bottom sheet closes automatically
   - App navigates to DarkroomScreen
   - DarkroomScreen shows loading state
   - Photos reveal and appear for triage
   - Returning to Camera tab, badge count decreases (after triage)
7. Test edge case: Open sheet, release before 100%, press backdrop to close
   - Should NOT navigate (only backdrop closes sheet)
  </verify>
  <done>
- onComplete callback in DarkroomBottomSheet fires at 100% progress
- onComplete in CameraScreen closes sheet and navigates to Darkroom
- Navigation to DarkroomScreen triggers existing reveal logic
- Photos reveal in batch, triage UI appears
- Badge count updates after triage completed
- Edge case: Manual close (backdrop) does not navigate
- Logger output shows completion and navigation events
  </done>
</task>

<task type="auto">
  <name>Task 2: Add haptic feedback during press-and-hold progress</name>
  <files>src/components/DarkroomBottomSheet.js</files>
  <action>
Add haptic feedback at progress milestones for tactile confirmation:

**Import:**
- Import * as Haptics from 'expo-haptics' at top of file

**Haptic Feedback Strategy:**
- Use milestone-based haptics (NOT continuous) to avoid over-triggering
- Trigger at 25%, 50%, 75%, and 100% progress
- Use light impact for milestones, success notification for completion

**Implementation:**
1. Track milestone state to prevent duplicate triggers:
   ```javascript
   const [hapticTriggered, setHapticTriggered] = useState({
     25: false,
     50: false,
     75: false,
     100: false
   });
   ```

2. Add listener to animated value in useEffect:
   ```javascript
   const listener = progressAnim.addListener(({ value }) => {
     // Trigger haptics at milestones
     if (value >= 0.25 && !hapticTriggered[25]) {
       Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
       setHapticTriggered(prev => ({ ...prev, 25: true }));
       logger.debug('DarkroomBottomSheet: Haptic at 25%');
     }
     if (value >= 0.50 && !hapticTriggered[50]) {
       Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
       setHapticTriggered(prev => ({ ...prev, 50: true }));
       logger.debug('DarkroomBottomSheet: Haptic at 50%');
     }
     if (value >= 0.75 && !hapticTriggered[75]) {
       Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
       setHapticTriggered(prev => ({ ...prev, 75: true }));
       logger.debug('DarkroomBottomSheet: Haptic at 75%');
     }
     if (value >= 1.0 && !hapticTriggered[100]) {
       Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success);
       setHapticTriggered(prev => ({ ...prev, 100: true }));
       logger.info('DarkroomBottomSheet: Haptic at 100% (completion)');
       onComplete();
     }
   });

   return () => progressAnim.removeListener(listener);
   ```

3. Reset hapticTriggered state when press starts (onPressIn) and when sheet closes

**Haptic Feedback Types:**
- 25%, 50%, 75%: Haptics.ImpactFeedbackStyle.Light (subtle tap)
- 100%: Haptics.NotificationFeedbackType.Success (stronger confirmation)

**Error Handling:**
- Wrap Haptics calls in try/catch (may fail on simulator)
- logger.debug if haptic fails (not a critical error)

**Testing Note:**
- Haptics ONLY work on physical device (not simulator/Expo Go on simulator)
- Test on real iPhone to feel the feedback

**What NOT to change:**
- Do not add haptics to other interactions (button taps, backdrop press) - keep focused on press-and-hold
- Do not add continuous haptics (would drain battery and feel overwhelming)
  </action>
  <verify>
1. Test on PHYSICAL iOS device (haptics don't work in simulator)
2. npm start and open app in Expo Go
3. Take photo to create developing photo
4. Tap darkroom button to open bottom sheet
5. Press and hold progress bar:
   - Feel light tap at 25% progress
   - Feel light tap at 50% progress
   - Feel light tap at 75% progress
   - Feel stronger success vibration at 100%
6. Release before 100%, press again:
   - Haptics should re-trigger at milestones (state reset)
7. Check logs for haptic debug messages at each milestone
8. Test multiple cycles to ensure no duplicate triggers per press
  </verify>
  <done>
- expo-haptics imported in DarkroomBottomSheet.js
- Haptic feedback fires at 25%, 50%, 75% progress (Light impact)
- Haptic feedback fires at 100% completion (Success notification)
- Milestone state prevents duplicate triggers during single press
- State resets when press starts and when sheet closes
- Haptics feel responsive, not overwhelming
- Logger output shows haptic trigger events
- Tested on physical device (not simulator)
- Error handling for haptic failures
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm start runs without errors
- [ ] Press-and-hold completes and navigates to DarkroomScreen
- [ ] DarkroomScreen reveals photos automatically (existing logic works)
- [ ] Haptic feedback fires at 25%, 50%, 75%, 100% (tested on physical device)
- [ ] Releasing before 100% does not navigate
- [ ] Backdrop press closes sheet without navigation
- [ ] Badge count decreases after photo triage
- [ ] No errors in console
- [ ] Logger output shows completion, navigation, haptic events
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Press-and-hold completion navigates to DarkroomScreen
- Existing darkroom reveal logic works seamlessly
- Haptic feedback enhances interaction (responsive, not overwhelming)
- Edge cases handled (manual close, incomplete press)
- No errors or warnings
- Phase 2 complete - ready for Phase 3 (Swipe Gesture Triage)
</success_criteria>

<output>
After completion, create `.planning/phases/02-darkroom-bottom-sheet/02-02-SUMMARY.md`:

# Phase 2 Plan 2: Reveal Logic and Haptic Feedback Summary

**[One-line description of what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `src/components/DarkroomBottomSheet.js` - Description
- `src/screens/CameraScreen.js` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 2 complete. Phase 3 ready to begin: Replace Archive/Journal buttons with iOS Mail-style swipe gestures in DarkroomScreen triage flow.

**Dependencies met:**
- Press-and-hold reveal interaction working end-to-end
- Navigation to DarkroomScreen established from Camera
- Haptic feedback pattern established for gesture interactions
- Existing photo triage logic ready for swipe gesture replacement
</output>
