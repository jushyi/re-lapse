---
phase: 20-friend-suggestions-contacts-sync
plan: 03
type: execute
---

<objective>
Integrate friend suggestions into the FriendsScreen Requests tab with dismissible cards and sync prompt.

Purpose: Allow users to access contact-based friend suggestions beyond the onboarding flow, with ability to dismiss suggestions and re-sync contacts.
Output: Updated FriendsScreen with suggestions section, dismissible suggestion cards, and "Sync contacts" prompt for users who skipped.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-friend-suggestions-contacts-sync/20-CONTEXT.md
@.planning/phases/20-friend-suggestions-contacts-sync/20-RESEARCH.md
@.planning/phases/20-friend-suggestions-contacts-sync/20-01-SUMMARY.md
@.planning/phases/20-friend-suggestions-contacts-sync/20-02-SUMMARY.md

# Key source files:

@src/screens/FriendsScreen.js
@src/components/FriendCard.js
@src/services/firebase/contactSyncService.js
@src/styles/FriendsScreen.styles.js
@src/constants/colors.js

**Tech stack available:**

- contactSyncService.js with sync, dismiss, and state functions
- FriendCard component
- FriendsScreen with tabbed interface (Requests | Friends)

**Established patterns from FriendsScreen:**

- Sections rendering with headers
- FlatList with sections data
- Real-time listener pattern
- Action loading state management

**Constraining decisions from CONTEXT.md:**

- Suggestions appear in Requests tab, below any active requests
- If no pending/sent requests, suggestions appear at top
- "Sync contacts to find friends" prompt if user skipped onboarding
- Dismissible suggestions
- Card consistency: use FriendCard component
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Add suggestions state and data fetching to FriendsScreen</name>
  <files>src/screens/FriendsScreen.js</files>
  <action>
Add imports and state for suggestions:

1. Add imports at top:

```javascript
import {
  hasUserSyncedContacts,
  syncContactsAndFindSuggestions,
  getDismissedSuggestionIds,
  filterDismissedSuggestions,
  dismissSuggestion,
  markContactsSyncCompleted,
} from '../services/firebase/contactSyncService';
```

2. Add state variables (alongside existing state):

```javascript
// Suggestions state
const [suggestions, setSuggestions] = useState([]);
const [hasSyncedContacts, setHasSyncedContacts] = useState(false);
const [suggestionsLoading, setSuggestionsLoading] = useState(false);
```

3. Add function to fetch suggestions:

```javascript
/**
 * Fetch contact-based friend suggestions
 */
const fetchSuggestions = async () => {
  try {
    // Check if user has synced contacts
    const synced = await hasUserSyncedContacts(user.uid);
    setHasSyncedContacts(synced);

    if (!synced) {
      setSuggestions([]);
      return;
    }

    // Get suggestions from contacts
    const result = await syncContactsAndFindSuggestions(user.uid, userProfile?.phoneNumber);

    if (result.success && result.suggestions) {
      // Filter out dismissed suggestions
      const dismissedIds = await getDismissedSuggestionIds(user.uid);
      const filteredSuggestions = filterDismissedSuggestions(result.suggestions, dismissedIds);
      setSuggestions(filteredSuggestions);
    } else {
      setSuggestions([]);
    }
  } catch (err) {
    logger.error('Error fetching suggestions', err);
    setSuggestions([]);
  }
};
```

4. Update loadData to include suggestions:

```javascript
const loadData = async () => {
  setError(null);
  try {
    await Promise.all([
      fetchFriends(),
      fetchRequests(),
      fetchSuggestions(), // Add this
    ]);
  } catch (err) {
    logger.error('Error loading data', err);
    setError('Failed to load data');
  } finally {
    setLoading(false);
    setRefreshing(false);
  }
};
```

5. Add useAuth import for userProfile:
   Make sure `userProfile` is destructured from useAuth (already exists).
   </action>
   <verify>

- FriendsScreen loads without errors
- Suggestions state is initialized
- fetchSuggestions is called on load
  </verify>
  <done>
- Suggestions state added to FriendsScreen
- fetchSuggestions function created
- Data loading includes suggestions
- Dismissed suggestions filtered out
  </done>
  </task>

<task type="auto">
  <name>Task 2: Add suggestion actions (dismiss, sync prompt)</name>
  <files>src/screens/FriendsScreen.js</files>
  <action>
Add handlers for suggestion-specific actions:

1. Add dismiss suggestion handler:

```javascript
/**
 * Handle dismiss suggestion
 */
const handleDismissSuggestion = async userId => {
  try {
    mediumImpact();

    // Optimistic update
    setSuggestions(prev => prev.filter(s => s.id !== userId));

    // Persist dismissal
    await dismissSuggestion(user.uid, userId);
  } catch (err) {
    logger.error('Error dismissing suggestion', err);
    // Refresh suggestions on error
    fetchSuggestions();
  }
};
```

2. Add sync contacts handler (for users who skipped):

```javascript
/**
 * Handle sync contacts from Requests tab
 */
const handleSyncContacts = async () => {
  try {
    setSuggestionsLoading(true);
    mediumImpact();

    const result = await syncContactsAndFindSuggestions(user.uid, userProfile?.phoneNumber);

    if (!result.success) {
      if (result.error === 'permission_denied' || result.error === 'permission_denied_permanent') {
        // Permission handling is done in the service
        setSuggestionsLoading(false);
        return;
      }
      Alert.alert('Error', 'Failed to sync contacts. Please try again.');
      setSuggestionsLoading(false);
      return;
    }

    // Mark sync as completed
    await markContactsSyncCompleted(user.uid, true);
    setHasSyncedContacts(true);

    // Update suggestions
    const dismissedIds = await getDismissedSuggestionIds(user.uid);
    const filteredSuggestions = filterDismissedSuggestions(result.suggestions || [], dismissedIds);
    setSuggestions(filteredSuggestions);

    if (filteredSuggestions.length === 0) {
      Alert.alert(
        'No Friends Found',
        'None of your contacts are on REWIND yet. Invite them to join!'
      );
    }
  } catch (err) {
    logger.error('Error syncing contacts', err);
    Alert.alert('Error', 'Failed to sync contacts');
  } finally {
    setSuggestionsLoading(false);
  }
};
```

3. Add handler for adding friend from suggestion (reuse existing handleAddFriend):
   The existing handleAddFriend should work. After successful add, remove from suggestions:

```javascript
// Modify existing handleAddFriend to also remove from suggestions
const handleAddFriend = async userId => {
  try {
    setActionLoading(prev => ({ ...prev, [userId]: true }));
    mediumImpact();

    const result = await sendFriendRequest(user.uid, userId);
    if (!result.success) {
      Alert.alert('Error', result.error || 'Failed to send friend request');
    } else {
      // Remove from suggestions if present
      setSuggestions(prev => prev.filter(s => s.id !== userId));
      // Update local state for search results
      setFriendshipStatuses(prev => ({
        ...prev,
        [userId]: { status: 'pending_sent', friendshipId: result.friendshipId },
      }));
    }
  } catch (err) {
    logger.error('Error sending friend request', err);
    Alert.alert('Error', 'Failed to send friend request');
  } finally {
    setActionLoading(prev => ({ ...prev, [userId]: false }));
  }
};
```

  </action>
  <verify>
- Dismiss removes suggestion from list
- Sync contacts works from Requests tab
- Adding friend removes from suggestions
  </verify>
  <done>
- handleDismissSuggestion removes and persists dismissal
- handleSyncContacts allows syncing from Requests tab
- handleAddFriend removes from suggestions on success
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Requests tab UI to show suggestions section</name>
  <files>src/screens/FriendsScreen.js, src/styles/FriendsScreen.styles.js</files>
  <action>
1. Add styles to FriendsScreen.styles.js:
```javascript
// Sync contacts prompt
syncPromptContainer: {
  alignItems: 'center',
  paddingVertical: 24,
  paddingHorizontal: 20,
  backgroundColor: colors.background.secondary,
  borderRadius: 12,
  marginHorizontal: 16,
  marginVertical: 8,
},
syncPromptIcon: {
  marginBottom: 12,
},
syncPromptTitle: {
  fontSize: 16,
  fontWeight: '600',
  color: colors.text.primary,
  textAlign: 'center',
  marginBottom: 4,
},
syncPromptText: {
  fontSize: 14,
  color: colors.text.secondary,
  textAlign: 'center',
  marginBottom: 16,
},
syncPromptButton: {
  backgroundColor: colors.brand.purple,
  paddingVertical: 12,
  paddingHorizontal: 24,
  borderRadius: 8,
},
syncPromptButtonText: {
  color: colors.text.primary,
  fontSize: 14,
  fontWeight: '600',
},
// Suggestion card dismiss button
suggestionDismiss: {
  position: 'absolute',
  right: 8,
  top: 8,
  padding: 4,
},
```

2. Update renderRequestsTab to include suggestions section.

Find the existing sections building code and update:

```javascript
/**
 * Render Requests tab content
 */
const renderRequestsTab = () => {
  if (loading) {
    return (/* existing loading state */);
  }

  // If searching, show search results (existing code)
  if (requestsSearchQuery.trim()) {
    return (/* existing search results code */);
  }

  // Build sections data
  const hasIncoming = incomingRequests.length > 0;
  const hasSent = sentRequests.length > 0;
  const hasSuggestions = suggestions.length > 0;
  const hasRequests = hasIncoming || hasSent;

  const sections = [];

  // Add incoming requests section
  if (hasIncoming) {
    sections.push({ type: 'header', title: 'Incoming' });
    incomingRequests.forEach((request) => {
      sections.push({ type: 'incoming', data: request });
    });
  }

  // Add sent requests section
  if (hasSent) {
    sections.push({ type: 'header', title: 'Sent' });
    sentRequests.forEach((request) => {
      sections.push({ type: 'sent', data: request });
    });
  }

  // Add suggestions section (or sync prompt)
  if (hasSyncedContacts) {
    if (hasSuggestions) {
      sections.push({ type: 'header', title: 'Suggestions' });
      suggestions.forEach((suggestion) => {
        sections.push({ type: 'suggestion', data: suggestion });
      });
    }
  } else {
    // User hasn't synced contacts - show prompt
    sections.push({ type: 'sync_prompt' });
  }

  // Render function for items
  const renderItem = ({ item }) => {
    if (item.type === 'header') {
      return renderSectionHeader(item.title);
    }

    if (item.type === 'sync_prompt') {
      return renderSyncPrompt();
    }

    if (item.type === 'incoming') {
      return (
        <FriendCard
          user={item.data}
          relationshipStatus="pending_received"
          friendshipId={item.data.id}
          onAccept={handleAcceptRequest}
          onDeny={handleDenyRequest}
          loading={actionLoading[item.data.id]}
          onPress={() => {
            navigation.navigate('OtherUserProfile', {
              userId: item.data.userId,
              username: item.data.username,
            });
          }}
        />
      );
    }

    if (item.type === 'sent') {
      return (
        <FriendCard
          user={item.data}
          relationshipStatus="pending_sent"
          friendshipId={item.data.id}
          onAction={handleCancelRequest}
          loading={actionLoading[item.data.id]}
          onPress={() => {
            navigation.navigate('OtherUserProfile', {
              userId: item.data.userId,
              username: item.data.username,
            });
          }}
        />
      );
    }

    if (item.type === 'suggestion') {
      return renderSuggestionCard(item.data);
    }

    return null;
  };

  // Key extractor
  const keyExtractor = (item, index) => {
    if (item.type === 'header') return `header-${item.title}`;
    if (item.type === 'sync_prompt') return 'sync-prompt';
    return item.data?.id || `item-${index}`;
  };

  return (
    <>
      {renderSearchBar(requestsSearchQuery, setRequestsSearchQuery, 'Search users to add...')}
      {sections.length > 0 ? (
        <FlatList
          data={sections}
          renderItem={renderItem}
          keyExtractor={keyExtractor}
          contentContainerStyle={styles.listContent}
          showsVerticalScrollIndicator={false}
          refreshControl={
            <RefreshControl
              refreshing={refreshing}
              onRefresh={handleRefresh}
              tintColor={colors.text.primary}
            />
          }
        />
      ) : (
        <View style={{ flex: 1 }}>
          {renderEmptyState(
            'mail-outline',
            'No friend requests',
            'Search for users by username to add friends'
          )}
        </View>
      )}
    </>
  );
};
```

3. Add helper render functions:

```javascript
/**
 * Render sync contacts prompt
 */
const renderSyncPrompt = () => (
  <View style={styles.syncPromptContainer}>
    <Ionicons
      name="people-outline"
      size={40}
      color={colors.brand.purple}
      style={styles.syncPromptIcon}
    />
    <Text style={styles.syncPromptTitle}>Find Friends from Contacts</Text>
    <Text style={styles.syncPromptText}>See which of your contacts are on REWIND</Text>
    <TouchableOpacity
      style={styles.syncPromptButton}
      onPress={handleSyncContacts}
      activeOpacity={0.7}
      disabled={suggestionsLoading}
    >
      {suggestionsLoading ? (
        <ActivityIndicator size="small" color={colors.text.primary} />
      ) : (
        <Text style={styles.syncPromptButtonText}>Sync Contacts</Text>
      )}
    </TouchableOpacity>
  </View>
);

/**
 * Render suggestion card with dismiss option
 */
const renderSuggestionCard = suggestion => (
  <View style={{ position: 'relative' }}>
    <FriendCard
      user={{
        userId: suggestion.id,
        displayName: suggestion.displayName,
        username: suggestion.username,
        profilePhotoURL: suggestion.profilePhotoURL || suggestion.photoURL,
      }}
      relationshipStatus="none"
      onAction={userId => handleAddFriend(userId)}
      loading={actionLoading[suggestion.id]}
      onPress={() => {
        navigation.navigate('OtherUserProfile', {
          userId: suggestion.id,
          username: suggestion.username,
        });
      }}
    />
    <TouchableOpacity
      style={styles.suggestionDismiss}
      onPress={() => handleDismissSuggestion(suggestion.id)}
      hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}
    >
      <Ionicons name="close" size={18} color={colors.text.tertiary} />
    </TouchableOpacity>
  </View>
);
```

  </action>
  <verify>
- Requests tab shows suggestions section below requests
- Sync prompt appears for users who haven't synced
- Suggestions have dismiss (X) button
- Dismiss removes suggestion from list
- Adding friend removes from suggestions
- Pull-to-refresh reloads suggestions
  </verify>
  <done>
- Suggestions section added to Requests tab
- Sync prompt shows for users who skipped onboarding sync
- Dismissible suggestion cards with X button
- FriendCard integration for consistent styling
- Full integration with existing FriendsScreen patterns
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm start` runs without errors
- [ ] Requests tab shows suggestions below incoming/sent requests
- [ ] Users who skipped sync see "Sync Contacts" prompt
- [ ] Sync prompt triggers contact sync flow
- [ ] Suggestions have dismiss button
- [ ] Dismiss removes suggestion and persists
- [ ] Adding friend removes from suggestions
- [ ] Pull-to-refresh reloads suggestions
- [ ] No TypeScript/lint errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Suggestions integrated seamlessly into Requests tab
- Consistent with existing FriendsScreen patterns
- Dismiss functionality persists across sessions
  </success_criteria>

<output>
After completion, create `.planning/phases/20-friend-suggestions-contacts-sync/20-03-SUMMARY.md`
</output>
