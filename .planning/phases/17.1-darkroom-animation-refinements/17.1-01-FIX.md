---
phase: 17.1-darkroom-animation-refinements
plan: 01-FIX
type: fix
---

<objective>
Fix 3 UAT issues from plan 17.1-01.

Source: 17.1-01-ISSUES.md
Priority: 0 critical, 0 major, 3 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/17.1-darkroom-animation-refinements/17.1-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/17.1-darkroom-animation-refinements/17.1-01-PLAN.md

**Key files:**
@src/screens/DarkroomScreen.js
</context>

<tasks>

<task type="auto">
  <name>Fix UAT-001: Prevent empty state flash before success state</name>
  <files>src/screens/DarkroomScreen.js</files>
  <action>
Fix the timing issue where empty state briefly appears before success state:

1. Find the render logic that shows empty state vs success state
2. The issue: When photos.length becomes 0, the empty state renders before triageComplete is set
3. Solution: Show success state if triageComplete OR if we just finished triaging (add pendingSuccess state)

Approach A (Recommended): Track when we're about to complete
- Add state: `const [pendingSuccess, setPendingSuccess] = useState(false);`
- In handleTriage, when isLastPhoto:
  - Set `setPendingSuccess(true)` BEFORE the animation starts
  - This ensures success state renders immediately when photos.length hits 0
- Render condition: `if (photos.length === 0 && (triageComplete || pendingSuccess))`

Approach B: Simpler - just check if we had photos and now don't
- Track previous photo count with useRef
- If previous count > 0 and current === 0, show success instead of empty

The key is: never show empty state if we reached 0 photos via triage (only show it if darkroom opened with 0 photos).
  </action>
  <verify>Triage last photo, success state appears immediately with no flash of empty state</verify>
  <done>Empty state no longer flashes before success state after triaging final photo</done>
</task>

<task type="auto">
  <name>Fix UAT-002: Polish success state UI</name>
  <files>src/screens/DarkroomScreen.js</files>
  <action>
Update the success state UI per user feedback:

1. **Remove animated sparkles:**
   - Delete the SparkleAnimation component or animated sparkle rendering
   - Remove any related Animated values for sparkle movement

2. **Add sparkle emojis to message:**
   - Change "Hooray!" text to "✨ Hooray! ✨"
   - Keep the same text styling (large, bold, white, centered)

3. **Move Done button to bottom:**
   - Position the button at the bottom of the screen with absolute positioning
   - Add adequate padding from bottom (safe area + ~40px)
   - Keep button styling (blue #007AFF or similar, rounded corners)

4. **Add checkmark to Done button:**
   - Add checkmark symbol before "Done" text: "✓ Done" or use a View-based checkmark icon
   - Ensure good spacing between checkmark and text

5. **Add fade-in animation:**
   - If not already present, wrap success content in Animated.View
   - Animate opacity from 0 to 1 over 300-400ms
   - This creates smooth appearance effect

Layout should be:
```
[                  ]
[                  ]
[    ✨ Hooray! ✨  ]  <- Centered vertically in upper 2/3
[                  ]
[                  ]
[   [✓ Done]       ]  <- At bottom with padding
```
  </action>
  <verify>Success state shows sparkle emojis in text, Done button at bottom with checkmark, smooth fade-in animation</verify>
  <done>Success state UI polished: no animated sparkles, emoji text, bottom button with checkmark, fade-in</done>
</task>

<task type="auto">
  <name>Fix UAT-003: Add swipe-down gesture to header for closing</name>
  <files>src/screens/DarkroomScreen.js</files>
  <action>
Add swipe-down-to-close gesture on the header area:

1. **Identify header area:**
   - The header contains: title, status indicator, back button
   - This area should be "grabbable" for the swipe gesture
   - Do NOT make the photo cards area swipeable (conflicts with triage gestures)

2. **Implement gesture handler:**
   - Use react-native-gesture-handler's GestureDetector + Gesture.Pan()
   - Only trigger on header container (not full screen)
   - Track vertical translation during drag

3. **Gesture logic:**
   ```jsx
   const headerPanGesture = Gesture.Pan()
     .onUpdate((event) => {
       // Only respond to downward swipes
       if (event.translationY > 0) {
         headerTranslateY.value = event.translationY;
       }
     })
     .onEnd((event) => {
       // If dragged down enough (e.g., 100px) or fast enough, close
       if (event.translationY > 100 || event.velocityY > 500) {
         navigation.goBack();
       } else {
         // Spring back
         headerTranslateY.value = withSpring(0);
       }
     });
   ```

4. **Visual feedback (optional but nice):**
   - As user drags, slightly fade/translate the whole screen
   - This provides feedback that dismiss is happening

5. **Wrap header in GestureDetector:**
   ```jsx
   <GestureDetector gesture={headerPanGesture}>
     <Animated.View style={[styles.header, headerAnimatedStyle]}>
       {/* header content */}
     </Animated.View>
   </GestureDetector>
   ```

Key: Only the header area responds to this gesture. The photo card area uses its own swipe gestures for triage.
  </action>
  <verify>Swiping down on header (not photo area) closes darkroom with slide-down animation</verify>
  <done>Header responds to swipe-down gesture to close darkroom, doesn't interfere with photo triage swipes</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed 3 UAT issues: empty state flash, success UI polish, header swipe gesture</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. Open app, ensure you have at least 1 revealed photo in darkroom

    **Test UAT-001 fix (no empty state flash):**
    3. Open darkroom, triage all photos until one remains
    4. Triage the final photo
    5. Verify: Success state appears immediately - NO brief flash of empty state (camera emoji)

    **Test UAT-002 fix (success UI polish):**
    6. On success state, verify:
       - No animated sparkles floating around
       - Text shows "✨ Hooray! ✨" with sparkle emojis
       - Done button is at BOTTOM of screen (not center)
       - Done button has checkmark: "✓ Done"
       - Content fades in smoothly
    7. Tap Done, verify returns to Camera

    **Test UAT-003 fix (header swipe to close):**
    8. Capture new photo, wait for reveal, open darkroom again
    9. Place finger on HEADER area (title/back button area, NOT on photo)
    10. Swipe downward
    11. Verify: Darkroom closes with slide-down animation
    12. Reopen darkroom, try swiping down on the PHOTO card
    13. Verify: Photo card triage gesture works (left/right swipe), not close gesture
  </how-to-verify>
  <resume-signal>Type "approved" or describe any remaining issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All critical issues fixed (0)
- [ ] All major issues fixed (0)
- [ ] Minor issues fixed or documented as deferred (3 fixed)
- [ ] Original acceptance criteria from issues met
- [ ] No new issues introduced
</verification>

<success_criteria>
- All 3 UAT issues from 17.1-01-ISSUES.md addressed
- No empty state flash before success
- Success UI has emoji text, bottom button with checkmark, fade-in
- Header swipe-down closes darkroom without interfering with photo gestures
- App builds and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17.1-darkroom-animation-refinements/17.1-01-FIX-SUMMARY.md`
</output>
