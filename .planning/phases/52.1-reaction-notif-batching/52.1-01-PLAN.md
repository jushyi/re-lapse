---
phase: 52.1-reaction-notif-batching
plan: 01
type: execute
subsystem: notifications
---

<objective>
Fix reaction notification batching broken by Cloud Functions stateless instances. Replace in-memory pendingReactions state with Firestore-based batching using transactions and Cloud Tasks.

Purpose: Eliminate duplicate reaction notifications by ensuring batching state persists across Cloud Function instances. Currently, each photo update can trigger a separate instance with its own in-memory state, causing multiple notifications instead of proper batching.

Output: Zero duplicate notifications - same user's reactions within 30 seconds batch into single notification regardless of instance scaling.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52.1-reaction-notif-batching/52.1-CONTEXT.md
@.planning/phases/52.1-reaction-notif-batching/52.1-RESEARCH.md
@.planning/phases/52-systematic-uat/52-02-SUMMARY.md

**Current implementation:**

- In-memory `pendingReactions` object at line 22 of functions/index.js
- `sendReactionNotification` Cloud Function (lines 799-979) uses setTimeout for 10-second batching
- Batching logic merges reactions and extends timeout (lines 888-910)
- This pattern fails in serverless: each instance has separate memory

**Issue discovered:**

- Found during Plan 52-02 UAT testing (Multi-Device Tests)
- Logged as ISS-015 in .planning/STATE.md
- Rapid reactions send multiple individual notifications instead of one batched notification

**Solution architecture (from RESEARCH.md):**

- Firestore `reactionBatches` collection stores pending batches
- Firestore transactions provide atomic read-modify-write
- Cloud Tasks schedule 30-second delayed notification sends
- Status field tracks lifecycle: 'pending' → 'processing' → 'sent'
- Idempotent sender prevents duplicates on retry

**Dependencies already installed:**

- firebase-admin: 12.0.0
- firebase-functions: 4.5.0

**Need to add:**

- @google-cloud/tasks for delayed execution
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Install Cloud Tasks and create Firestore batching utilities</name>
  <files>functions/package.json, functions/notifications/batching.js</files>
  <action>
Install @google-cloud/tasks dependency:
```bash
cd functions && npm install @google-cloud/tasks --save
```

Create new file `functions/notifications/batching.js` with Firestore-based batching logic:

- Export `addReactionToBatch(photoId, reactorId, reactions)` function
- Use Firestore collection `reactionBatches` with document ID format: `${photoId}_${reactorId}`
- Implement transaction pattern: check if batch exists → create or update → schedule Cloud Task
- Batch document schema:
  ```
  {
    photoId: string,
    reactorId: string,
    reactions: { [emoji]: count },
    createdAt: Timestamp,
    updatedAt: Timestamp,
    expiresAt: Date (now + 30s),
    status: 'pending' | 'processing' | 'sent'
  }
  ```
- Transaction logic:
  - If batch exists: merge reactions into existing, update updatedAt
  - If batch doesn't exist: create with 30s expiresAt, schedule Cloud Task for delayed send
- Export `scheduleNotificationTask(batchId, delaySeconds)` function using Cloud Tasks
- Task targets Cloud Function HTTP endpoint (will create in Task 2)
- Use region: 'us-central1' (same as Cloud Functions), queue: 'default'
- Include logger.debug statements for transaction actions

AVOID global/module-level CloudTasksClient initialization - create client inside scheduleNotificationTask to avoid cold start issues. Initialize as: `const { CloudTasksClient } = require('@google-cloud/tasks'); const client = new CloudTasksClient();`
</action>
<verify>

- `npm list @google-cloud/tasks` shows installed package
- `functions/notifications/batching.js` exists with exports: addReactionToBatch, scheduleNotificationTask
- Code uses `admin.firestore()` and `db.runTransaction()` pattern
- No syntax errors: `cd functions && npm run lint` (or manual review if no lint script)
  </verify>
  <done>
- @google-cloud/tasks dependency added to package.json
- batching.js implements transaction-based batch creation/update
- Cloud Tasks scheduling function ready for Task 2 integration
  </done>
  </task>

<task type="auto">
  <name>Task 2: Create Cloud Task handler for delayed sends</name>
  <files>functions/tasks/sendBatchedNotification.js, functions/index.js</files>
  <action>
Create new directory `functions/tasks/` and file `sendBatchedNotification.js`:
- Export async function `sendBatchedNotificationHandler(req, res)` as HTTP Cloud Function handler
- Extract `batchId` from request body: `const { batchId } = req.body;`
- Implement idempotent send pattern:
  1. Use transaction to check batch exists and status !== 'sent'
  2. Mark status as 'processing' in transaction
  3. If already sent or doesn't exist, return early (idempotency)
  4. Fetch batch data from transaction
  5. Call existing `sendBatchedReactionNotification` helper (refactor from current implementation)
  6. Mark batch as 'sent' with sentAt timestamp
  7. On error: reset status to 'pending' so retry can re-attempt
- Include comprehensive logger.debug statements for each step
- Return 200 status on success, 500 on error

Modify `functions/index.js`:

- Export new HTTP Cloud Function:
  ```javascript
  exports.sendBatchedNotification = functions
    .runWith({ memory: '256MB', timeoutSeconds: 60 })
    .https.onRequest(sendBatchedNotificationHandler);
  ```
- Keep existing `sendBatchedReactionNotification` function (lines 721-788) as helper, but rename to `sendReactionPushNotification` to clarify it's the actual sender (not the batched trigger)
- This helper will be called by the new Cloud Task handler after batch window expires

AVOID exposing handler without authentication - rely on Cloud Tasks service account permissions. The task queue automatically authenticates requests.
</action>
<verify>

- `functions/tasks/sendBatchedNotification.js` exists with exported handler
- `functions/index.js` exports `sendBatchedNotification` HTTP function
- Handler implements transaction status check (idempotency)
- Error handling resets status to 'pending' for retry
- Syntax check: `cd functions && node -c tasks/sendBatchedNotification.js`
  </verify>
  <done>
- Cloud Task HTTP handler ready to receive scheduled tasks
- Idempotent send logic prevents duplicate notifications on retry
- Exported as Cloud Function in index.js
  </done>
  </task>

<task type="auto">
  <name>Task 3: Refactor sendReactionNotification to use Firestore batching</name>
  <files>functions/index.js</files>
  <action>
Refactor `exports.sendReactionNotification` Cloud Function (lines 799-979):

1. Remove in-memory state:
   - Delete `const pendingReactions = {};` (line 22)
   - Remove all references to `pendingReactions[pendingKey]`
   - Remove `clearTimeout` and `setTimeout` calls (lines 890, 904, 962-965)

2. Import batching utilities:

   ```javascript
   const { addReactionToBatch } = require('./notifications/batching');
   ```

3. Replace batching logic (lines 887-973) with single call:

   ```javascript
   // Add reaction to Firestore batch (replaces in-memory batching)
   await addReactionToBatch(photoId, reactorId, reactionDiff);

   logger.debug('sendReactionNotification: Added to Firestore batch', {
     photoId,
     reactorId,
     pendingKey, // Keep for logging continuity
   });

   return null;
   ```

4. Keep all validation logic BEFORE batching call:
   - Guard checks (lines 804-834)
   - Reaction diff calculation (lines 842-873)
   - Self-reaction check (line 876)

5. Remove user data fetching (lines 912-951):
   - Photo owner FCM token fetch
   - Notification preferences check
   - Reactor display name fetch
   - These will move to Cloud Task handler (they need to be fetched at send time, not batch time, in case user changes preferences)

6. Update Cloud Task handler to fetch user data:
   - Modify `sendBatchedNotificationHandler` from Task 2 to fetch photo owner, reactor data before calling `sendReactionPushNotification`
   - Include notification preference checks (lines 933-944)
   - Pass all needed data to `sendReactionPushNotification` helper

7. Keep `sendReactionPushNotification` helper (renamed from `sendBatchedReactionNotification`) mostly unchanged:
   - Accept all needed params (no longer reads from pendingReactions)
   - Keep push notification send logic (lines 748-768)
   - Keep in-app notification write (lines 771-782)

8. Update the constant:
   - Change `REACTION_DEBOUNCE_MS = 10000` to `REACTION_BATCH_WINDOW_MS = 30000` (line 21)
   - Update batching.js to use 30-second window (per CONTEXT.md)

AVOID removing the `formatReactionSummary` helper - it's still needed for notification body formatting.

WHY this approach: Firestore persists state across instances, transactions prevent race conditions, Cloud Tasks handle delayed execution reliably. In-memory state fails when multiple instances handle reactions to the same photo.
</action>
<verify>

- `const pendingReactions = {};` removed from functions/index.js
- All setTimeout/clearTimeout calls removed from sendReactionNotification
- `addReactionToBatch` imported and called instead of in-memory logic
- User data fetching moved to Cloud Task handler
- Syntax check: `cd functions && node -c index.js`
- Deploy to Firebase (will verify in overall verification): `firebase deploy --only functions`
  </verify>
  <done>
- sendReactionNotification no longer uses in-memory state
- Firestore batching integrated via addReactionToBatch
- Cloud Task handler fetches user data at send time
- All batching logic Firestore-based and stateless-safe
  </done>
  </task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] All three tasks completed (dependencies installed, utilities created, refactoring complete)
- [ ] No `pendingReactions` references remain in functions/index.js
- [ ] Cloud Functions deploy successfully: `cd functions && firebase deploy --only functions`
- [ ] No deployment errors or warnings
- [ ] Test with rapid reactions: send 3 reactions within 10 seconds, verify single batched notification after 30s
- [ ] Test idempotency: trigger same batch twice, verify no duplicate notifications
</verification>

<success_criteria>

- All tasks completed
- In-memory batching state completely removed
- Firestore-based batching operational
- Cloud Tasks schedule and execute correctly
- Zero duplicate notifications during testing
- Cloud Functions successfully deployed to Firebase
  </success_criteria>

<output>
After completion, create `.planning/phases/52.1-reaction-notif-batching/52.1-01-SUMMARY.md`:

# Phase 52.1 Plan 01: Fix Reaction Notification Batching - Summary

**Replaced in-memory batching with Firestore-based state and Cloud Tasks for zero duplicate notifications.**

## Accomplishments

- Installed @google-cloud/tasks dependency
- Created `functions/notifications/batching.js` with transaction-based batch management
- Created `functions/tasks/sendBatchedNotification.js` HTTP handler for delayed sends
- Refactored `sendReactionNotification` to remove all in-memory state
- Integrated Firestore batching with 30-second window
- Cloud Functions successfully deployed

## Files Created/Modified

**Created:**

- `functions/notifications/batching.js` - Firestore batch creation/update with transactions
- `functions/tasks/sendBatchedNotification.js` - Cloud Task HTTP handler for delayed sends

**Modified:**

- `functions/package.json` - Added @google-cloud/tasks dependency
- `functions/index.js` - Removed pendingReactions object, refactored sendReactionNotification to use Firestore batching, exported sendBatchedNotification HTTP function, renamed helper to sendReactionPushNotification

## Decisions Made

- 30-second batching window (increased from original 10 seconds per CONTEXT.md)
- Firestore collection name: `reactionBatches`
- Document ID format: `${photoId}_${reactorId}` (same as original pendingKey)
- Cloud Tasks queue: 'default' (no custom queue needed)
- Status lifecycle: 'pending' → 'processing' → 'sent'
- User data fetching moved to send time (not batch creation time) to respect preference changes

## Issues Encountered

[Document any issues encountered, or "None"]

## Next Phase Readiness

**Phase 52.1 complete.** ISS-015 resolved.

Return to Phase 52 UAT - ready to continue with Plan 52-03 (Auth & Account Management) or address ISS-016 (Photo Tagging Lag) via Phase 52.2.

**Concerns for future phases:**

- Monitor Cloud Tasks execution in Cloud Logging for any delayed send failures
- Consider adding Firestore TTL policy to auto-cleanup old 'sent' batches after 7 days (optional optimization)
  </output>
