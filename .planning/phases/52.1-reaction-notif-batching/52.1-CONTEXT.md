# Phase 52.1: Fix Reaction Notification Batching - Context

**Gathered:** 2026-02-13
**Status:** Ready for planning

<vision>
## How This Should Work

When a user sends multiple reactions to the same photo within a short time window, they should be batched into a single notification instead of spamming the photo owner with duplicates. The key principle: **same person = batch their reactions, different people = separate notifications**.

The user should never know batching is happening - it should just work seamlessly. No duplicate notifications, no notification spam, just clean delivery.

</vision>

<essential>
## What Must Be Nailed

- **Zero duplicate notifications** - This is the core bug fix. No matter what edge cases occur, if the same person sends multiple reactions within 30 seconds, they must result in exactly one notification.
- **Reliable Firestore-based batching** - The solution must work across stateless Cloud Function instances. In-memory state doesn't work, so Firestore documents must reliably track pending reactions and batching windows.

</essential>

<boundaries>
## What's Out of Scope

- **No cross-user batching** - Different people reacting to the same photo get separate notifications. This phase only batches reactions from the SAME user.
- **No retroactive fixes** - Only prevent future duplicates. Don't try to clean up or deduplicate past notifications already sent.
- **Reaction notifications only** - Focus exclusively on reaction batching. Comments, tags, and other notification types have separate systems.
- **No UI changes** - Pure backend fix. The notification appearance in the app UI stays exactly the same.

</boundaries>

<specifics>
## Specific Ideas

**Firestore-based batching approach:**

- Use Firestore documents to track pending reactions (not in-memory state)
- 30-second batching window per photo per user
- When a reaction comes in, check for existing pending batch document
- If exists and within window, add to batch
- If doesn't exist or window expired, create new batch document
- After 30s window, send single consolidated notification per photo per user

**Notification format:** Should read naturally like "4 reactions to your photo" (not "reaction batch complete" or technical jargon).

</specifics>

<notes>
## Additional Context

**Issue discovered during:** Plan 52-02 UAT testing (Multi-Device Tests)

**Root cause:** Cloud Functions are stateless - each photo update can trigger a separate Cloud Function instance with its own memory space. The original in-memory `pendingReactions` state doesn't persist across instances, causing each reaction to trigger a separate notification instead of batching properly.

**Priority:** This is a deferred issue (ISS-015) found during UAT. Not blocking release but should be fixed post-UAT before wider rollout to prevent notification spam.

</notes>

---

_Phase: 52.1-reaction-notif-batching_
_Context gathered: 2026-02-13_
