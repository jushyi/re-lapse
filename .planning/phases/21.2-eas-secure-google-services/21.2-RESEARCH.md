# Phase 21.2: EAS Secure Google Services File - Research

**Researched:** 2026-01-24
**Domain:** EAS Build file environment variables for iOS Firebase configuration
**Confidence:** HIGH

<research_summary>

## Summary

Researched the EAS Build ecosystem for securely injecting GoogleService-Info.plist into builds without committing to version control. EAS supports file-type environment variables that store files on EAS servers and inject them as file paths during builds.

The standard approach uses `eas env:create` with `--type file` to upload the plist, then reference it in app.config.js via `process.env.VARIABLE_NAME`. For managed Expo workflows (like this project), the file is automatically placed where iOS expects it during the prebuild step.

**Primary recommendation:** Use EAS file environment variables with "sensitive" visibility. Create the variable for the "production" environment, update app.json to use app.config.js with process.env fallback, and verify with a test build.
</research_summary>

<standard_stack>

## Standard Stack

### Core

| Tool          | Version    | Purpose                             | Why Standard                     |
| ------------- | ---------- | ----------------------------------- | -------------------------------- |
| EAS CLI       | >= 16.28.0 | Create/manage environment variables | Official Expo tooling for builds |
| app.config.js | N/A        | Dynamic config with env var support | Allows process.env references    |

### Supporting

| Tool         | Purpose                        | When to Use                                       |
| ------------ | ------------------------------ | ------------------------------------------------- |
| .easignore   | Override .gitignore for builds | When you need files in builds that are gitignored |
| eas env:list | Verify variables exist         | Debugging/verification                            |
| eas env:pull | Pull env vars locally          | Local development setup                           |

### Alternatives Considered

| Instead of        | Could Use                                  | Tradeoff                                       |
| ----------------- | ------------------------------------------ | ---------------------------------------------- |
| EAS file secrets  | Base64 in string secret + pre-install hook | More complex, manual decoding required         |
| EAS file secrets  | .easignore with ! prefix                   | File still needs to exist locally before build |
| Secret visibility | Sensitive visibility                       | Secret not readable in CLI, harder to debug    |

**Commands:**

```bash
# Create file environment variable
eas env:create --name GOOGLE_SERVICES_PLIST --type file --value ./GoogleService-Info.plist --visibility sensitive --environment production --scope project

# List environment variables
eas env:list --environment production

# Delete if needed
eas env:delete --name GOOGLE_SERVICES_PLIST --environment production
```

</standard_stack>

<architecture_patterns>

## Architecture Patterns

### Recommended Project Structure

```
project-root/
├── app.json                    # Keep for static config, reference app.config.js
├── app.config.js               # Dynamic config with process.env references
├── eas.json                    # Build profiles
├── .gitignore                  # GoogleService-Info.plist listed here
├── GoogleService-Info.plist    # LOCAL ONLY - never committed (for local dev)
└── ...
```

### Pattern 1: app.config.js with Environment Variable Fallback

**What:** Dynamic Expo config that reads file path from environment variable with local fallback
**When to use:** Always for managed Expo workflows with sensitive files
**Example:**

```javascript
// app.config.js
export default ({ config }) => {
  return {
    ...config,
    ios: {
      ...config.ios,
      googleServicesFile: process.env.GOOGLE_SERVICES_PLIST ?? './GoogleService-Info.plist',
    },
  };
};
```

### Pattern 2: Preserving app.json with app.config.js Extension

**What:** Keep app.json for static config, use app.config.js for dynamic values only
**When to use:** When you have existing app.json and only need env vars for specific fields
**Example:**

```javascript
// app.config.js
const config = require('./app.json');

module.exports = () => {
  return {
    ...config.expo,
    ios: {
      ...config.expo.ios,
      googleServicesFile: process.env.GOOGLE_SERVICES_PLIST ?? './GoogleService-Info.plist',
    },
  };
};
```

### Anti-Patterns to Avoid

- **Hardcoding file paths in app.json:** Makes it impossible to inject from environment
- **Using "secret" visibility for googleServicesFile:** Secret variables aren't available during local config resolution, causing fallback issues
- **Committing GoogleService-Info.plist to repo:** Defeats the security purpose
- **Not having a local fallback:** Breaks local development workflow
  </architecture_patterns>

<dont_hand_roll>

## Don't Hand-Roll

| Problem                    | Don't Build                            | Use Instead                                 | Why                           |
| -------------------------- | -------------------------------------- | ------------------------------------------- | ----------------------------- |
| File injection into builds | Custom pre-install scripts with base64 | EAS file environment variables              | Built-in, tested, secure      |
| Secret storage             | Environment variables in eas.json      | EAS environment variables via CLI/dashboard | eas.json is committed to repo |
| Firebase config management | Multiple plist files for environments  | Single plist with EAS env per environment   | Simpler, official pattern     |
| Local dev fallback         | Complex conditional logic              | Simple `??` fallback in app.config.js       | Clear, maintainable           |

**Key insight:** EAS has first-class support for file-type environment variables specifically for this use case. The infrastructure handles secure storage, injection at build time, and proper file placement. Custom solutions add complexity and potential failure points.
</dont_hand_roll>

<common_pitfalls>

## Common Pitfalls

### Pitfall 1: Using "secret" Instead of "sensitive" Visibility

**What goes wrong:** Build fails or falls back to local file unexpectedly
**Why it happens:** Secret-type variables aren't readable during local EAS CLI config resolution
**How to avoid:** Use "sensitive" visibility for file variables referenced in app.config.js
**Warning signs:** Config shows fallback value in build logs even when variable exists

### Pitfall 2: File Still in .gitignore Without .easignore Override

**What goes wrong:** EAS build can't find the file even with environment variable set
**Why it happens:** EAS respects .gitignore when creating build archive
**How to avoid:** For file env vars, the file doesn't need to be in the archive - EAS injects it from the stored secret. Ensure app.config.js properly references the env var.
**Warning signs:** "Build input file cannot be found" error

### Pitfall 3: Not Creating Variable for Correct Environment

**What goes wrong:** Build runs but variable is empty, falls back to local (which doesn't exist on server)
**Why it happens:** Variable created for "development" but building with "production" profile
**How to avoid:** Match environment to build profile (production profile = production environment)
**Warning signs:** "No environment variables found for 'production' environment"

### Pitfall 4: Local Development Without Fallback

**What goes wrong:** `expo start` or local builds fail
**Why it happens:** Environment variable not set locally, no fallback path
**How to avoid:** Always use `process.env.VAR ?? './local-path'` pattern
**Warning signs:** "googleServicesFile is missing" during local development

### Pitfall 5: Incorrect File Path in Environment Variable Value

**What goes wrong:** Variable created but points to wrong file
**Why it happens:** Using relative path that doesn't exist or typo in filename
**How to avoid:** Use `--value ./GoogleService-Info.plist` from project root, verify file exists first
**Warning signs:** Build succeeds but Firebase features don't work
</common_pitfalls>

<code_examples>

## Code Examples

Verified patterns from official sources:

### Creating the Environment Variable

```bash
# Source: EAS CLI documentation
# Run from project root where GoogleService-Info.plist exists locally

eas env:create \
  --name GOOGLE_SERVICES_PLIST \
  --type file \
  --value ./GoogleService-Info.plist \
  --visibility sensitive \
  --environment production \
  --scope project
```

### app.config.js for Managed Expo Workflow

```javascript
// Source: Expo environment variables documentation
// app.config.js

const baseConfig = require('./app.json');

module.exports = () => {
  return {
    ...baseConfig.expo,
    ios: {
      ...baseConfig.expo.ios,
      // EAS sets this to file path during builds
      // Falls back to local file for development
      googleServicesFile: process.env.GOOGLE_SERVICES_PLIST ?? './GoogleService-Info.plist',
    },
  };
};
```

### Verifying Environment Variable Exists

```bash
# Source: EAS CLI documentation
eas env:list --environment production

# Expected output should show:
# GOOGLE_SERVICES_PLIST | file | sensitive | production
```

### Build Command (No Changes Needed)

```bash
# Source: Standard EAS build command
# The environment variable is automatically loaded for production builds
eas build --platform ios --profile production
```

</code_examples>

<sota_updates>

## State of the Art (2024-2025)

| Old Approach                      | Current Approach                                  | When Changed | Impact                                 |
| --------------------------------- | ------------------------------------------------- | ------------ | -------------------------------------- |
| `eas secret:create`               | `eas env:create`                                  | 2024         | Unified CLI, environment scoping       |
| Base64 encoding in string secrets | Native file type                                  | 2023+        | Simpler, no manual encoding/decoding   |
| Per-profile env in eas.json       | EAS environments (production/preview/development) | 2024         | Better organization, environment-based |

**New tools/patterns to consider:**

- **EAS environments:** production, preview, development - variables scoped per environment
- **eas env:pull:** Pull variables locally for development (except secrets)
- **Sensitive visibility:** Obfuscated in logs but readable in CLI - ideal for file references

**Deprecated/outdated:**

- **`eas secret:create`:** Replaced by `eas env:create` with `--visibility secret`
- **Storing secrets in eas.json env field:** Committed to repo, not secure
- **Manual pre-install hooks for file injection:** Unnecessary with file type variables
  </sota_updates>

<open_questions>

## Open Questions

Things that couldn't be fully resolved:

1. **Local builds (`eas build --local`) with file secrets**
   - What we know: Local builds don't have access to EAS secrets
   - What's unclear: Whether the fallback pattern works reliably for local EAS builds
   - Recommendation: Always have local GoogleService-Info.plist for development, rely on EAS cloud builds for production

2. **Multiple environments (dev/staging/prod)**
   - What we know: EAS supports separate environments with separate variables
   - What's unclear: Whether different Firebase projects per environment is common practice
   - Recommendation: Out of scope for this phase per CONTEXT.md, but architecture supports it
     </open_questions>

<sources>
## Sources

### Primary (HIGH confidence)

- [Environment variables in EAS - Expo Documentation](https://docs.expo.dev/eas/environment-variables/) - file variables, visibility options, CLI commands
- [Configure EAS Build with eas.json - Expo Documentation](https://docs.expo.dev/build/eas-json/) - build profile configuration
- [app.json / app.config.js - Expo Documentation](https://docs.expo.dev/versions/latest/config/app/) - ios.googleServicesFile field specification
- [Ignore files via .easignore - Expo Documentation](https://docs.expo.dev/build-reference/easignore/) - alternative approach documentation

### Secondary (MEDIUM confidence)

- [EAS CLI README - GitHub](https://github.com/expo/eas-cli) - command syntax verification
- [expo/eas-cli issues #1821, #2199, #2876](https://github.com/expo/eas-cli/issues) - real-world problems and solutions

### Tertiary (LOW confidence - needs validation during implementation)

- Community patterns for fallback syntax - verified against multiple sources but test during implementation
  </sources>

<metadata>
## Metadata

**Research scope:**

- Core technology: EAS Build file environment variables
- Ecosystem: EAS CLI, app.config.js, managed Expo workflow
- Patterns: File injection, environment variable fallbacks, visibility options
- Pitfalls: Visibility levels, environment mismatches, local development

**Confidence breakdown:**

- Standard stack: HIGH - official Expo documentation, verified CLI commands
- Architecture: HIGH - multiple official examples, verified patterns
- Pitfalls: HIGH - documented in GitHub issues, official troubleshooting
- Code examples: HIGH - from official documentation

**Research date:** 2026-01-24
**Valid until:** 2026-02-24 (30 days - EAS ecosystem stable)
</metadata>

---

_Phase: 21.2-eas-secure-google-services_
_Research completed: 2026-01-24_
_Ready for planning: yes_
