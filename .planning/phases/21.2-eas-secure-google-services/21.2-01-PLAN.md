---
phase: 21.2-eas-secure-google-services
plan: 01
type: execute
---

<objective>
Configure EAS file environment variables to securely inject GoogleService-Info.plist into iOS builds without committing to version control.

Purpose: Enable EAS builds to succeed now that the plist is excluded from git, while maintaining local development workflow.
Output: Working EAS build with plist injected from EAS secrets, app.config.js with fallback for local development.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21.2-eas-secure-google-services/21.2-RESEARCH.md
@.planning/phases/21.2-eas-secure-google-services/21.2-CONTEXT.md
@.planning/phases/21.1-api-key-remediation/21.1-01-SUMMARY.md

**Prior phase context:**

- Phase 21.1 removed GoogleService-Info.plist from git history
- Local plist preserved at project root (untracked, in .gitignore)
- Keys were rotated prior to remediation

**Current app.json state (line 17):**

```json
"googleServicesFile": "./GoogleService-Info.plist"
```

**Current eas.json:**

- CLI version >= 16.28.0 (compatible with file env vars)
- Production, preview, development profiles defined

**Files referenced:**
@app.json
@eas.json
@GoogleService-Info.plist (local only, not in repo)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EAS file environment variable for GoogleService-Info.plist</name>
  <files>None (EAS server-side configuration)</files>
  <action>
Run from project root where GoogleService-Info.plist exists:

```bash
eas env:create \
  --name GOOGLE_SERVICES_PLIST \
  --type file \
  --value ./GoogleService-Info.plist \
  --visibility sensitive \
  --environment production \
  --scope project
```

If prompted to log in, complete authentication via browser.

After creation, verify the variable exists:

```bash
eas env:list --environment production
```

Expected output should show: `GOOGLE_SERVICES_PLIST | file | sensitive | production`

**What to avoid:** Don't use `--visibility secret` (secret variables aren't readable during local config resolution, causes fallback issues). Use `sensitive` visibility.
</action>
<verify>eas env:list --environment production shows GOOGLE_SERVICES_PLIST with file type and sensitive visibility</verify>
<done>EAS environment variable created and visible in production environment</done>
</task>

<task type="auto">
  <name>Task 2: Convert app.json to app.config.js with dynamic googleServicesFile</name>
  <files>app.config.js (new), app.json (modify)</files>
  <action>
Create app.config.js at project root that:
1. Imports the existing app.json config
2. Overrides ios.googleServicesFile with environment variable + local fallback

```javascript
// app.config.js
const baseConfig = require('./app.json');

module.exports = () => {
  return {
    ...baseConfig.expo,
    ios: {
      ...baseConfig.expo.ios,
      // EAS sets this to file path during builds
      // Falls back to local file for development
      googleServicesFile: process.env.GOOGLE_SERVICES_PLIST ?? './GoogleService-Info.plist',
    },
  };
};
```

Then update app.json to remove the googleServicesFile line (line 17) since app.config.js now handles it dynamically. Keep all other iOS config in app.json - app.config.js spreads it via `...baseConfig.expo.ios`.

**What to avoid:**

- Don't hardcode the path in app.config.js without the fallback (breaks local dev)
- Don't use secret visibility in research (we're using sensitive)
  </action>
  <verify>

1. app.config.js exists at project root with correct content
2. app.json no longer has googleServicesFile field in ios section
3. `npx expo config --type public` shows googleServicesFile resolves to ./GoogleService-Info.plist locally
   </verify>
   <done>

- app.config.js created with dynamic googleServicesFile
- app.json updated (googleServicesFile removed)
- Local config resolution works (shows fallback path)
  </done>
  </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>EAS file environment variable and dynamic app.config.js configuration</what-built>
  <how-to-verify>
1. Verify EAS variable: Run `eas env:list --environment production`
   - Should show GOOGLE_SERVICES_PLIST with file type

2. Verify local config: Run `npx expo config --type public | grep googleServicesFile`
   - Should show `./GoogleService-Info.plist` (fallback working)

3. Trigger EAS build (optional but recommended):

   ```bash
   eas build --platform ios --profile production --non-interactive
   ```

   - Build should start without errors about missing GoogleService-Info.plist
   - Build logs should confirm the environment variable was loaded

4. If you don't want to wait for full build, you can cancel after confirming:
   - "Loaded environment variables: GOOGLE_SERVICES_PLIST" appears in logs
   - Prebuild step completes without googleServicesFile errors
     </how-to-verify>
     <resume-signal>Type "approved" if EAS variable exists and local config works. If you ran a build, confirm it succeeded. Or describe any issues found.</resume-signal>
     </task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `eas env:list --environment production` shows GOOGLE_SERVICES_PLIST variable
- [ ] app.config.js exists with fallback pattern
- [ ] app.json no longer has hardcoded googleServicesFile
- [ ] `npx expo config --type public` resolves googleServicesFile correctly
- [ ] EAS build starts without errors (ideally completes successfully)
</verification>

<success_criteria>

- EAS file environment variable created for production environment
- app.config.js properly references env var with local fallback
- app.json cleaned up (googleServicesFile removed)
- Local development workflow preserved (npx expo start still works)
- EAS builds can access the plist without it being in git
  </success_criteria>

<output>
After completion, create `.planning/phases/21.2-eas-secure-google-services/21.2-01-SUMMARY.md`:

# Phase 21.2 Plan 01: EAS Secure Google Services File Summary

**[Substantive one-liner about what was accomplished]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `app.config.js` - Dynamic config with googleServicesFile fallback
- `app.json` - Removed hardcoded googleServicesFile

## Decisions Made

[Any decisions during execution]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

- Phase 21.2 complete, ready for Phase 22 (Environment and Configuration)
- EAS builds now work with secure plist injection
  </output>
