---
phase: 15-background-photo-upload
plan: 15-01-FIX
type: fix
---

<objective>
Fix 2 UAT issues from plan 15-01.

Source: 15-01-ISSUES.md
Priority: 0 critical, 1 major, 1 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/15-background-photo-upload/15-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/15-background-photo-upload/15-01-PLAN.md

**Key files to investigate:**
@src/screens/CameraScreen.js
@src/services/uploadQueueService.js
</context>

<tasks>

<task type="auto">
  <name>Fix UAT-001: Remove spinner and blocking after capture</name>
  <files>src/screens/CameraScreen.js</files>
  <action>
**Issue:** Camera still shows loading spinner and delay after capture despite background queue.

**Root cause to investigate:**
The spinner likely still appears because:
1. `isCapturing` state isn't being released immediately, OR
2. There's still an `await` on something blocking the capture flow, OR
3. The `setIsCapturing(false)` is in a try/finally that awaits something

**Fix approach:**

1. Read CameraScreen.js and locate the takePicture function
2. Verify that `addToQueue()` is NOT being awaited
3. Ensure `setIsCapturing(false)` happens immediately after queueing, not after upload
4. Check if there's any other blocking operation (image processing, compression)

**Expected flow (non-blocking):**
```javascript
const takePicture = async () => {
  if (!cameraRef.current || isCapturing || !user) return;

  setIsCapturing(true);  // Show briefly during capture itself

  try {
    // Only await the actual camera capture (fast, <100ms)
    const photo = await cameraRef.current.takePictureAsync({
      quality: 0.8,
      skipProcessing: true,
    });

    // NON-BLOCKING: Queue for background upload (no await!)
    addToQueue(user.uid, photo.uri);

    // Play animation (non-blocking)
    playPhotoAnimation(photo.uri);

    // Optimistic badge update
    setDarkroomCounts(prev => ({...}));

  } catch (error) {
    logger.error('CameraScreen: Error capturing photo', error);
  } finally {
    setIsCapturing(false);  // Must happen immediately
  }
};
```

**If compression is blocking:** Move compression INTO uploadQueueService so it happens in the background, not during capture.

**Verify the fix works by:**
- Taking a photo and confirming no spinner appears
- Confirming camera is ready immediately for next shot
  </action>
  <verify>
- Take a photo - no spinner visible after shutter press
- Camera ready for next shot immediately (< 200ms)
- Photos still upload successfully in background (check Firestore)
  </verify>
  <done>
- Loading spinner no longer appears after capture
- Camera releases instantly
- Background upload still functions correctly
  </done>
</task>

<task type="auto">
  <name>Fix UAT-002: Correct arc animation destination</name>
  <files>src/screens/CameraScreen.js</files>
  <action>
**Issue:** Photo thumbnail animation ends at wrong location instead of darkroom badge.

**Root cause to investigate:**
The animation endpoint coordinates are likely:
1. Hardcoded to incorrect position, OR
2. Not accounting for device screen dimensions correctly, OR
3. Not measuring the actual darkroom badge position

**Fix approach:**

1. Find where the darkroom badge is positioned on screen
2. Update the animation's final translateX/translateY values to target that position
3. The badge is likely in the bottom-right area of the camera controls

**Steps:**
1. Locate the playPhotoAnimation function
2. Find the interpolation outputRange for translateX and translateY
3. Identify where the DarkroomButton component is rendered
4. Measure or calculate its position
5. Update the animation endpoint to match

**Typical darkroom badge position:**
- Usually bottom-right of the camera screen
- Might be at position like (SCREEN_WIDTH - 60, SCREEN_HEIGHT - 150)

**If using hardcoded values, consider:**
```javascript
// Calculate based on badge layout position
const BADGE_POSITION_X = SCREEN_WIDTH - 70;  // Right side
const BADGE_POSITION_Y = SCREEN_HEIGHT - 180; // Above bottom controls

const photoTranslateX = animatedValue.interpolate({
  inputRange: [0, 0.3, 0.7, 1],
  outputRange: [0, -20, BADGE_POSITION_X * 0.4, BADGE_POSITION_X - SCREEN_WIDTH/2],
});

const photoTranslateY = animatedValue.interpolate({
  inputRange: [0, 0.3, 0.7, 1],
  outputRange: [0, -40, BADGE_POSITION_Y * 0.5, BADGE_POSITION_Y - SCREEN_HEIGHT/2],
});
```

**Note:** The exact values depend on the camera layout. Adjust based on actual badge position in the UI.
  </action>
  <verify>
- Take a photo and watch the arc animation
- Photo thumbnail should land on/near the darkroom badge
- Badge bounce should trigger when photo arrives
  </verify>
  <done>
- Arc animation ends at darkroom badge position
- Visual connection between photo and badge is clear
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] UAT-001: No spinner after capture, camera ready instantly
- [ ] UAT-002: Arc animation lands on darkroom badge
- [ ] Background uploads still work correctly
- [ ] Badge bounce still triggers when photo lands
- [ ] No console errors
</verification>

<success_criteria>
- All UAT issues from 15-01-ISSUES.md addressed
- Tests pass
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/15-background-photo-upload/15-01-FIX-SUMMARY.md`
</output>
