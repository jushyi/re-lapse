---
phase: 46-full-notifications-testing
plan: 01
type: execute
---

<objective>
Audit all notification code paths — Cloud Functions and client-side handling — to find and fix issues before manual device testing.

Purpose: Catch code-level bugs (missing preference checks, incorrect payloads, broken routing) before spending time on manual device testing. Known gaps from prior phases include comment reply notifications being skipped, reaction/comment notifications not appearing (noted Phase 38-02), and FeedScreen not consuming deep link route params.
Output: All notification Cloud Functions and client-side handlers verified correct and consistent. Issues fixed in-place.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-full-notifications-testing/46-CONTEXT.md

# Notification phase summaries (dependency graph):

@.planning/phases/34-push-infrastructure/34-01-SUMMARY.md
@.planning/phases/34-push-infrastructure/34-02-SUMMARY.md
@.planning/phases/35-social-notification-events/35-01-SUMMARY.md
@.planning/phases/35-social-notification-events/35-02-SUMMARY.md
@.planning/phases/36-photo-notification-events/36-01-SUMMARY.md
@.planning/phases/36-photo-notification-events/36-02-SUMMARY.md
@.planning/phases/37-darkroom-notifications/37-01-SUMMARY.md
@.planning/phases/38-notification-ui-polish/38-01-SUMMARY.md
@.planning/phases/38-notification-ui-polish/38-02-SUMMARY.md
@.planning/phases/41-tagged-notification-integration/41-01-SUMMARY.md

# Key source files:

@functions/index.js
@functions/notifications/sender.js
@functions/notifications/receipts.js
@src/services/firebase/notificationService.js
@src/screens/NotificationSettingsScreen.js
@src/screens/NotificationsScreen.js
@src/components/InAppNotificationBanner.js
@App.js
@src/navigation/AppNavigator.js

**Notification types to verify:** photo_reveal, friend_request, friend_accepted, reaction, comment, mention, story, tagged
**Preference keys:** enabled (master), likes, comments, mentions, follows, friendRequests, tags
**Known issues from prior phases:**

- Phase 38-02: "reaction and comment notifications not appearing — pre-existing gap"
- sendCommentNotification skips replies (parentId check) — verify if intentional or gap
- FeedScreen does not consume route params (photoId, highlightUserId) — deep linking partial
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Audit Cloud Function notification handlers</name>
  <files>functions/index.js, functions/notifications/sender.js, functions/notifications/receipts.js</files>
  <action>Read all notification-related Cloud Functions and verify each one has:

1. **Correct Firestore trigger path** — the onUpdate/onCreate path matches the actual collection structure
2. **shouldSendNotification() preference check** — every notification type (except photo_reveal which bypasses) calls shouldSendNotification with the correct preference key
3. **Proper notification payload** — title, body, and data object with `type` field matching one of: photo_reveal, friend_request, friend_accepted, reaction, comment, mention, story, tagged
4. **Deep link data in payload** — data object includes the params needed for client-side routing (photoId, senderId, friendshipId, highlightUserId, etc.)
5. **Self-notification prevention** — no function sends a notification to the user who triggered the action
6. **Debounce correctness** — reaction (10s) and tag (30s) debounce windows work correctly, pending notifications are cancelled on removal

Specific checks:

- sendReactionNotification: Verify it actually sends notifications (Phase 38-02 noted they weren't appearing). Check trigger path, verify reactions array change detection works.
- sendCommentNotification: Verify it sends for top-level comments. Check if skipping replies (parentId) is intentional or a gap that needs fixing. Verify @mention extraction works.
- sendFriendAcceptedNotification: Verify it triggers on status change to 'accepted', not on initial creation.
- sendStoryNotification: Verify it triggers on triage completion, not on every user document update.
- sendTaggedPhotoNotification: Verify tag removal cancels pending notifications.

Fix any issues found. Document what was checked and what was fixed.</action>
<verify>Read through each function and confirm: trigger path correct, preference check present, payload has type + routing data, self-notification prevented. No silent failure paths.</verify>
<done>All 8 notification Cloud Functions verified. Each has: correct trigger, preference check (or documented bypass), complete payload with deep link data, self-notification guard. Any fixes committed.</done>
</task>

<task type="auto">
  <name>Task 2: Audit client-side notification handling and routing</name>
  <files>src/services/firebase/notificationService.js, App.js, src/navigation/AppNavigator.js, src/components/InAppNotificationBanner.js, src/screens/NotificationSettingsScreen.js, src/screens/NotificationsScreen.js</files>
  <action>Read all client-side notification code and verify:

1. **handleNotificationTapped routing** — every notification type (photo_reveal, friend_request, friend_accepted, reaction, comment, mention, story, tagged) has a routing case that maps to the correct screen with correct params
2. **App.js listeners** — notification received listener (foreground), notification response listener (background/killed), and token refresh listener are all properly registered and cleaned up on unmount
3. **InAppNotificationBanner** — foreground notifications display correctly, tap navigates, auto-dismiss works, swipe-up dismiss works
4. **NotificationSettingsScreen preference keys** — the NOTIFICATION_TYPES array keys (likes, comments, mentions, follows, friendRequests, tags) exactly match what Cloud Functions check via shouldSendNotification()
5. **NotificationsScreen rendering** — all notification types render with appropriate icon, message, and tap handler
6. **Deep link config** — AppNavigator linking config covers all screens that notifications navigate to (Feed, Camera/Darkroom, FriendRequests, FriendsList)

Specific checks:

- Verify handleNotificationTapped has cases for ALL 8 notification types (not just some)
- Check if notification type strings are consistent between Cloud Functions (data.type) and client routing (switch cases)
- Verify the navigateToNotification function in App.js correctly passes params to the navigation ref
- Check that NotificationsScreen handles tap for each notification type (navigates to correct screen)

Fix any issues found (missing routing cases, mismatched type strings, missing cleanup).</action>
<verify>Every notification type has a matching routing case in handleNotificationTapped. Preference keys match between settings UI and Cloud Functions. App.js listeners have proper cleanup.</verify>
<done>All client-side notification handling verified. Every notification type routes correctly. Preference keys aligned. App.js listeners properly managed. Any fixes committed.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 8 Cloud Function notification handlers audited
- [ ] All client-side routing cases verified for all notification types
- [ ] Preference key alignment confirmed between settings UI and Cloud Functions
- [ ] No silent failure paths in notification pipeline
- [ ] Any fixes tested (if code changes made)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No notification type has a broken code path
- Preference keys are consistent across server and client
- Known gaps documented (if intentional) or fixed (if bugs)
  </success_criteria>

<output>
After completion, create `.planning/phases/46-full-notifications-testing/46-01-SUMMARY.md`
</output>
