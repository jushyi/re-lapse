---
phase: 46-full-notifications-testing
plan: 02
type: execute
---

<objective>
Execute systematic end-to-end device testing of every notification type — trigger, fire, receive, tap, deep link — and fix any issues discovered.

Purpose: Verify the entire notification pipeline works on a real device, catching runtime issues that code audit alone can't find (timing, permissions, Expo Push API, deep linking).
Output: Every notification type verified working end-to-end. Test results documented. All discovered issues fixed in-place.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-full-notifications-testing/46-CONTEXT.md
@.planning/phases/46-full-notifications-testing/46-01-SUMMARY.md

# Key source files:

@functions/index.js
@src/services/firebase/notificationService.js
@src/screens/NotificationSettingsScreen.js
@src/screens/NotificationsScreen.js
@App.js

**Pre-requisites:** 46-01 code audit complete. All code paths verified correct.
**Test environment:** Real iOS device via Expo Go or dev build. Two test user accounts with accepted friendship.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Compile notification test checklist</name>
  <files>.planning/phases/46-full-notifications-testing/NOTIFICATION-TEST-CHECKLIST.md</files>
  <action>Create a comprehensive, step-by-step test checklist document based on the 46-01 audit findings. Structure as follows:

**Pre-test Setup:**

- Ensure two test accounts exist (User A and User B) with accepted friendship
- Ensure push notifications enabled on device (Settings > Notifications)
- Ensure notification preferences all enabled for both users (NotificationSettingsScreen)
- Verify push token is stored in Firestore for both users (check users/{uid}/fcmToken)
- Ensure Cloud Functions are deployed (`firebase deploy --only functions`)

**For each notification type, include:**

1. **Type name and preference key**
2. **Trigger steps** — exact actions to perform (which user, which screen, what action)
3. **Expected notification** — title, body text pattern, notification type
4. **Expected deep link** — which screen should open, what params/content to verify
5. **Preference toggle test** — disable the preference, re-trigger, verify NO notification sent
6. **Pass/Fail checkbox**

**Notification types to cover (in testing order):**

1. **Friend Request** (friendRequests) — User B sends friend request to new User C → User C receives notification → tap → FriendRequests screen
2. **Friend Accepted** (follows) — User C accepts friend request → User B receives notification → tap → friends list
3. **Photo Reveal** (no preference, always sends) — User A takes photo → wait for darkroom reveal → notification → tap → Darkroom screen
4. **Reaction** (likes) — User B reacts to User A's photo → User A receives notification → tap → Feed with photo
5. **Comment** (comments) — User B comments on User A's photo → User A receives notification → tap → Feed with photo
6. **@Mention** (mentions) — User B writes comment mentioning @UserA on any photo → User A receives notification → tap → Feed with photo
7. **Story** (follows) — User A completes darkroom triage → User B receives story notification → tap → Feed with User A's story
8. **Tagged in Photo** (tags) — User B tags User A in a photo → User A receives notification → tap → Feed with tagged photo

**Cross-cutting tests:**

- Master toggle OFF → no notifications of any type
- Foreground test: Receive notification while app is open → InAppNotificationBanner appears → tap banner → navigates correctly
- Background test: Receive notification while app is backgrounded → system notification appears → tap → app opens to correct screen
- Killed app test: Receive notification while app is killed → system notification → tap → app launches to correct screen

**End of checklist:** Summary section with pass/fail counts and notes on any issues found.</action>
<verify>Checklist covers all 8 notification types with trigger steps, expected results, and preference toggle tests. Cross-cutting tests included.</verify>
<done>NOTIFICATION-TEST-CHECKLIST.md created with complete step-by-step instructions for all notification types plus cross-cutting tests.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Comprehensive notification test checklist covering all 8 notification types and cross-cutting concerns (foreground/background/killed app, master toggle, preference toggles).</what-built>
  <how-to-verify>
    1. Open: `.planning/phases/46-full-notifications-testing/NOTIFICATION-TEST-CHECKLIST.md`
    2. Follow Pre-test Setup steps to prepare test environment
    3. Work through each notification type in order:
       - Perform the trigger steps
       - Verify notification arrives with expected content
       - Tap notification and verify deep link lands on correct screen
       - Toggle preference OFF, re-trigger, verify notification does NOT arrive
       - Toggle preference back ON
    4. After all types tested, run cross-cutting tests:
       - Master toggle OFF → verify silence
       - Foreground banner test
       - Background notification test
       - Killed app notification test
    5. Note any failures with: which type, what step failed, what happened vs expected
  </how-to-verify>
  <resume-signal>Report results: "all passed" or describe each failure (which notification type, what step failed, what actually happened). Failures will be fixed in-place before completing this phase.</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] All 8 notification types tested end-to-end on real device
- [ ] All preference toggles verified (per-type + master)
- [ ] Foreground, background, and killed-app delivery verified
- [ ] Deep linking verified for each notification type
- [ ] All discovered issues fixed and re-tested
- [ ] Test results documented
</verification>

<success_criteria>

- All tasks completed
- All 8 notification types pass full pipeline test (trigger → fire → receive → tap → correct screen)
- Preference toggles correctly prevent/allow each notification type
- Foreground InAppNotificationBanner works
- Background and killed-app notifications work
- No broken notification paths remain
- Phase 46 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/46-full-notifications-testing/46-02-SUMMARY.md`:

# Phase 46 Plan 02: End-to-End Device Testing Summary

**[Test results summary — X/8 types passed, issues found and fixed]**

## Accomplishments

- [Test results per notification type]
- [Issues discovered and fixed]

## Files Created/Modified

- `NOTIFICATION-TEST-CHECKLIST.md` - Test script
- [Any files fixed during testing]

## Decisions Made

[Any decisions about notification behavior]

## Issues Encountered

[Failures found during testing and how they were resolved]

## Next Step

Phase 46 complete, ready for next phase.
</output>
