---
phase: 16.2-fix-ultra-wide-zoom
plan: 01
type: execute
domain: expo-camera
---

<objective>
Fix 0.5x ultra-wide zoom which shows same view as 1x and doesn't switch cameras properly.

Purpose: The 0.5x ultra-wide zoom implemented in Phase 15.3 stopped working - tapping 1x/2x/3x after 0.5x has no effect because expo-camera doesn't reset the lens when selectedLens is null.
Output: Working lens switching between ultra-wide (0.5x) and standard wide-angle (1x/2x/3x) on iOS devices.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Research document with root cause analysis:
@.planning/phases/16.2-fix-ultra-wide-zoom/16.2-RESEARCH.md

# Prior phase that implemented the broken zoom:
@.planning/phases/15.3-ultra-wide-zoom/15.3-01-SUMMARY.md

# Source file to fix:
@src/screens/CameraScreen.js

**Root Cause (from research):**
The current implementation sets `selectedLens` to `null` for 1x/2x/3x zoom levels (lines 26-30), but expo-camera does NOT automatically revert to the default wide-angle camera when `selectedLens` is null. The camera stays on whatever lens was previously selected (ultra-wide), so switching from 0.5x to 1x has no effect.

**Evidence from user's device logs:**
```
LOG  CameraScreen: Zoom level changed {"lens": "Back Ultra Wide Camera", "zoom": 0.5}  // Works
LOG  CameraScreen: Zoom level changed {"lens": null, "zoom": 1}  // BUG: null doesn't switch
```

**Fix approach:**
Use explicit `lens: wideAngleLens` (from availableLenses, typically "Back Camera") for base zoom levels instead of `null`.

**Available lenses on user's device:**
- "Back Camera" - Standard wide-angle (1x baseline) - USE THIS
- "Back Ultra Wide Camera" - 0.5x ultra-wide lens
- Other virtual cameras (Dual, Triple) - not used
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add wideAngleLens detection useMemo</name>
  <files>src/screens/CameraScreen.js</files>
  <action>
Add a new `wideAngleLens` useMemo hook that extracts the wide-angle camera lens string from `availableLenses`. This will be used to explicitly set the lens for 1x/2x/3x zoom levels instead of null.

```javascript
// Get wide-angle lens string (typically "Back Camera") for base zoom levels
const wideAngleLens = useMemo(() => {
  if (Platform.OS !== 'ios' || facing !== 'back' || availableLenses.length === 0) {
    return null;
  }
  // Look for standard wide-angle camera
  return availableLenses.find(lens =>
    lens.toLowerCase() === 'back camera'
  ) || null;
}, [availableLenses, facing]);
```

Place this BEFORE the existing `zoomLevels` useMemo hook (around line 129).

**Why:** expo-camera requires explicit lens strings - passing null keeps the camera on the previous lens.
  </action>
  <verify>No TypeScript/JS errors. Console log shows wideAngleLens value when camera loads.</verify>
  <done>wideAngleLens useMemo added and returns "Back Camera" string on iOS back camera.</done>
</task>

<task type="auto">
  <name>Task 2: Update zoomLevels to use explicit wideAngleLens</name>
  <files>src/screens/CameraScreen.js</files>
  <action>
Modify the existing `zoomLevels` useMemo (around line 130) to use `wideAngleLens` for base zoom levels instead of `lens: null`.

**Current (broken):**
```javascript
const zoomLevels = useMemo(() => {
  if (Platform.OS === 'ios' && hasUltraWide && facing === 'back') {
    // ... ultra-wide logic
    return [
      { ...ULTRA_WIDE_LEVEL, lens: ultraWideLens },
      ...ZOOM_LEVELS_BASE,  // <-- These have lens: null
    ];
  }
  return ZOOM_LEVELS_BASE;
}, [hasUltraWide, facing, availableLenses]);
```

**Fixed:**
```javascript
const zoomLevels = useMemo(() => {
  // Build base levels with explicit wide-angle lens (on iOS) or null (on Android)
  const baseLevels = ZOOM_LEVELS_BASE.map(level => ({
    ...level,
    lens: wideAngleLens, // Explicit lens instead of null
  }));

  // Add 0.5x only on iOS with ultra-wide support, on back camera
  if (Platform.OS === 'ios' && hasUltraWide && facing === 'back') {
    const ultraWideLens = availableLenses.find(lens =>
      lens.toLowerCase().includes('ultra wide') ||
      lens.toLowerCase().includes('ultrawide')
    );
    logger.debug('CameraScreen: Building zoom levels with ultra-wide', {
      ultraWideLens,
      wideAngleLens,
      facing,
    });
    return [
      { ...ULTRA_WIDE_LEVEL, lens: ultraWideLens },
      ...baseLevels,
    ];
  }
  return baseLevels;
}, [hasUltraWide, facing, availableLenses, wideAngleLens]);
```

**Add wideAngleLens to dependency array.** Remove the old log statement since we're replacing it.

**Why:** This ensures switching from 0.5x to 1x explicitly sets the lens to "Back Camera" instead of null.
  </action>
  <verify>Console log shows both ultraWideLens and wideAngleLens values when building zoom levels.</verify>
  <done>zoomLevels useMemo updated to use explicit wideAngleLens for base levels.</done>
</task>

<task type="auto">
  <name>Task 3: Add debug logging for lens switching</name>
  <files>src/screens/CameraScreen.js</files>
  <action>
Add a useEffect to log selectedLens changes for debugging. This helps verify the fix is working.

```javascript
// Debug: Log lens changes to verify switching works
useEffect(() => {
  logger.info('CameraScreen: selectedLens changed', { selectedLens });
}, [selectedLens]);
```

Place this after the existing `useEffect` hooks (around line 230, before the permission check).

Also update the existing `handleZoomChange` log (line 290-293) to show both old and new lens values:
```javascript
logger.info('CameraScreen: Zoom level changed', {
  from: zoom.value,
  to: zoomLevel.value,
  lens: zoomLevel.lens,
  selectedLens: zoomLevel.lens || null,
});
```

**Why:** Clear logging helps verify the fix works and aids future debugging.
  </action>
  <verify>Console shows lens changes when tapping zoom levels.</verify>
  <done>Debug logging added for selectedLens changes and zoom level changes.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed 0.5x ultra-wide zoom lens switching on iOS</what-built>
  <how-to-verify>
    1. Run: `npx expo start` and open on physical iOS device
    2. Open Camera tab
    3. Verify zoom bar shows: 0.5x, 1x, 2x, 3x (on device with ultra-wide)
    4. Tap 0.5x - view should zoom OUT (wider angle)
    5. Tap 1x - view should zoom IN to standard wide-angle (noticeably different from 0.5x)
    6. Tap 2x - view should zoom IN further
    7. Tap 0.5x again - should return to ultra-wide
    8. Check console logs show lens changes like:
       - "selectedLens changed" {"selectedLens": "Back Ultra Wide Camera"}
       - "selectedLens changed" {"selectedLens": "Back Camera"}
    9. Verify front camera still works (has no 0.5x option)
  </how-to-verify>
  <resume-signal>Type "approved" if zoom switching works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx expo start` runs without errors
- [ ] No console warnings/errors related to camera or selectedLens
- [ ] 0.5x shows ultra-wide view (wider than 1x)
- [ ] 1x/2x/3x show progressively zoomed views (different from 0.5x)
- [ ] Switching between 0.5x and 1x produces visible view change
- [ ] Front camera works without 0.5x option
- [ ] Console logs show correct lens values during switching
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Ultra-wide zoom (0.5x) works correctly on iOS
- Switching from 0.5x to 1x/2x/3x properly switches back to wide-angle lens
- No regression on front camera or Android
</success_criteria>

<output>
After completion, create `.planning/phases/16.2-fix-ultra-wide-zoom/16.2-01-SUMMARY.md`:

# Phase 16.2 Plan 01: Fix 0.5x Ultra-Wide Zoom Summary

**[One-liner describing what was fixed]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `src/screens/CameraScreen.js` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase complete, ready for Phase 17: Darkroom UX Polish
</output>
