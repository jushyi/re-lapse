---
phase: 50-cicd-pipeline
plan: 01
type: execute
---

<objective>
Set up production build configuration and create the PR checks workflow.

Purpose: Establish the config changes needed for production builds (aps-environment switching, APP_ENV) and create the first GitHub Actions workflow that gates PR quality with lint, test, and JS bundle verification.
Output: Updated app.config.js and eas.json for production builds, plus .github/workflows/pr-checks.yml that runs lint, tests, and expo export on every PR to main.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-cicd-pipeline/50-RESEARCH.md
@.planning/phases/50-cicd-pipeline/50-CONTEXT.md

# Prior summaries (dependency graph):

@.planning/phases/49-automated-test-suite/49-01-SUMMARY.md

# Key source files:

@app.config.js
@app.json
@eas.json
@package.json

**Tech stack available:** Jest ~29.7.0, ESLint 9.x, Expo SDK 54, EAS CLI >= 16.28.0
**Established patterns:** Dynamic app.config.js extending app.json, eas.json build profiles with remote version source
**Constraining decisions:**

- [Phase 49]: Jest test suite established with `npm test` command
- [Phase 49]: `--legacy-peer-deps` used for RNTL install
- [50-RESEARCH]: Use `npx expo export --platform ios` for free PR verification (NOT full EAS builds)
- [50-RESEARCH]: aps-environment must switch to "production" for App Store builds via APP_ENV env var
- [50-CONTEXT]: iOS only, no Android. Cloud Functions deployment stays manual.
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Add dynamic aps-environment to app.config.js and APP_ENV to eas.json</name>
  <files>app.config.js, eas.json</files>
  <action>
Update app.config.js to dynamically switch aps-environment based on APP_ENV environment variable. The file already extends app.json and handles GOOGLE_SERVICES_PLIST dynamically — extend the same pattern:

- Add `const isProduction = process.env.APP_ENV === 'production';` at the top of the export function
- Add `entitlements` spread from baseConfig.expo.ios with aps-environment override: `'aps-environment': isProduction ? 'production' : 'development'`
- Preserve the existing googleServicesFile logic

Update eas.json to set APP_ENV for the production build profile:

- Add `"env": { "APP_ENV": "production" }` to the `build.production` object
- Leave development and preview profiles unchanged (they default to development aps-environment)
- Leave submit.production empty for now (ASC API Key configuration is Phase 51)

Do NOT modify app.json — the base "development" value stays there as the default. The dynamic override in app.config.js handles production.
</action>
<verify>
Run `node -e "const config = require('./app.config.js')(); console.log(config.ios.entitlements['aps-environment'])"` — should print "development" (no APP_ENV set).
Run `APP_ENV=production node -e "const config = require('./app.config.js')(); console.log(config.ios.entitlements['aps-environment'])"` — should print "production".
Verify eas.json is valid JSON: `node -e "JSON.parse(require('fs').readFileSync('eas.json','utf8')); console.log('valid')"`.
</verify>
<done>app.config.js dynamically switches aps-environment based on APP_ENV. eas.json production profile sets APP_ENV=production. Both files are valid and parseable.</done>
</task>

<task type="auto">
  <name>Task 2: Create PR checks workflow</name>
  <files>.github/workflows/pr-checks.yml</files>
  <action>
Create the directory .github/workflows/ if it doesn't exist.

Create .github/workflows/pr-checks.yml with:

Trigger: pull_request targeting main branch.

Single job "quality" running on ubuntu-latest with these steps:

1. actions/checkout@v4
2. actions/setup-node@v4 with node-version 22 and cache: npm
3. `npm ci` to install dependencies (NOT `npm install` — ci is faster and deterministic)
4. `npm run lint` to check code style
5. `npm test` to run all Jest tests
6. `npx expo export --platform ios` to verify the JS bundle compiles

Use descriptive step names: "Checkout code", "Setup Node.js", "Install dependencies", "Lint", "Run tests", "Verify iOS bundle compiles".

Do NOT add --legacy-peer-deps to npm ci — the lockfile already accounts for peer deps. npm ci installs exactly what's in the lockfile.

Do NOT add any caching beyond the built-in actions/setup-node cache (which caches ~/.npm). No need for node_modules caching — npm ci with ~/.npm cache is fast enough.
</action>
<verify>
Verify the YAML file is valid: `node -e "const yaml = require('fs').readFileSync('.github/workflows/pr-checks.yml','utf8'); console.log('YAML file exists, length:', yaml.length)"`.
Verify the workflow steps match what we'd run locally: `npm run lint && npm test && npx expo export --platform ios` (do NOT actually run expo export — just verify the file content is correct).
Run `npm run lint` and `npm test` locally to confirm these commands pass (they should, per Phase 49).
</verify>
<done>pr-checks.yml exists at .github/workflows/, triggers on PRs to main, runs lint + test + expo export in a single job on ubuntu-latest with Node 22 and npm caching.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] app.config.js returns "development" aps-environment by default
- [ ] app.config.js returns "production" aps-environment when APP_ENV=production
- [ ] eas.json has APP_ENV: production in build.production.env
- [ ] eas.json is valid JSON
- [ ] .github/workflows/pr-checks.yml exists with correct structure
- [ ] `npm run lint` passes locally
- [ ] `npm test` passes locally
</verification>

<success_criteria>

- app.config.js dynamically switches aps-environment based on APP_ENV
- eas.json production profile includes APP_ENV=production
- PR checks workflow created with lint, test, and bundle verification
- All local verification commands pass
  </success_criteria>

<output>
After completion, create `.planning/phases/50-cicd-pipeline/50-01-SUMMARY.md`
</output>
