---
phase: 23-photo-deletion-archiving
plan: 01
type: execute
---

<objective>
Implement data layer functions for photo deletion with cascade cleanup and archive/restore operations.

Purpose: Enable permanent photo deletion (with proper cleanup of album references, comments, storage) and reversible archiving that removes photos from active views while preserving them in albums.

Output: photoService.js with deletePhotoCompletely(), archivePhoto(), and restorePhoto() functions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-photo-deletion-archiving/23-CONTEXT.md

# Key source files:

@src/services/firebase/photoService.js
@src/services/firebase/albumService.js
@src/services/firebase/commentService.js
@src/services/firebase/storageService.js

**Existing infrastructure:**

- `triagePhoto(photoId, action)` already supports 'journal', 'archive', 'delete' actions
- `deletePhoto(userId, photoId)` in storageService deletes from Firebase Storage
- Albums store `photoIds` array - need to remove photo from all containing albums
- Comments are stored as subcollection `photos/{photoId}/comments/` - need to delete

**Data model:**

- Photo has `photoState: 'journal' | 'archive'` field
- Feed/stories queries filter by `photoState: 'journal'`
- Albums and monthly albums show all triaged photos regardless of photoState

**Cascade requirements on delete:**

1. Remove photo from all albums containing it (auto-update cover if needed)
2. Delete all comments in the photo's subcollection
3. Delete photo from Firebase Storage
4. Delete photo document from Firestore
   </context>

<tasks>

<task type="auto">
  <name>Task 1: Add cascade delete function</name>
  <files>src/services/firebase/photoService.js</files>
  <action>
Add `deletePhotoCompletely(photoId, userId)` function that performs full cascade deletion:

1. **Get photo document** - verify it exists and belongs to userId (security check)
2. **Remove from albums** - Query all albums where `photoIds` array contains `photoId`:
   - For each album: use `removePhotoFromAlbum(albumId, photoId)` from albumService
   - If albumService returns warning about last photo, call `deleteAlbum(albumId)` instead
3. **Delete comments subcollection** - Get all docs in `photos/{photoId}/comments/`, delete each
4. **Delete from storage** - Call `deletePhoto(userId, photoId)` from storageService
5. **Delete document** - Delete the photo document from Firestore

Import `getUserAlbums`, `removePhotoFromAlbum`, `deleteAlbum` from albumService.
Use batch operations where efficient but handle edge cases gracefully.
Log progress at each step for debugging.
Return `{ success: true }` or `{ success: false, error: string }`.
</action>
<verify>Function exists and can be imported. Manual verification deferred to Plan 02 UI integration.</verify>
<done>deletePhotoCompletely function implemented with full cascade: album removal, comment deletion, storage deletion, document deletion</done>
</task>

<task type="auto">
  <name>Task 2: Add archive and restore functions</name>
  <files>src/services/firebase/photoService.js</files>
  <action>
Add two simple functions for toggling photo visibility:

1. **archivePhoto(photoId, userId):**
   - Verify photo exists and belongs to userId
   - Update document: `photoState: 'archive'`, `triagedAt: serverTimestamp()` (reset visibility window)
   - Return `{ success: true }` or `{ success: false, error }`

2. **restorePhoto(photoId, userId):**
   - Verify photo exists and belongs to userId
   - Update document: `photoState: 'journal'`, `triagedAt: serverTimestamp()` (reset visibility window)
   - Return `{ success: true }` or `{ success: false, error }`

Note: `triagedAt` is updated on both archive and restore so the visibility window resets when photo returns to journal (user chose to share it again).

Both functions follow same pattern as existing service functions with proper logging and error handling.
</action>
<verify>Functions exist and can be imported. Check with grep: `grep -n "archivePhoto\|restorePhoto" src/services/firebase/photoService.js`</verify>
<done>archivePhoto and restorePhoto functions implemented with proper ownership verification and triagedAt updates</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `deletePhotoCompletely` function exported from photoService.js
- [ ] `archivePhoto` function exported from photoService.js
- [ ] `restorePhoto` function exported from photoService.js
- [ ] All functions have proper error handling and logging
- [ ] No TypeScript/ESLint errors: `npm run lint`
</verification>

<success_criteria>

- All three functions implemented and exported
- Cascade delete properly removes from albums, comments, storage, and document
- Archive/restore properly toggle photoState and update triagedAt
- Code follows existing service patterns (error handling, logging, return format)
  </success_criteria>

<output>
After completion, create `.planning/phases/23-photo-deletion-archiving/23-01-SUMMARY.md`
</output>
