---
phase: 23-photo-deletion-archiving
plan: 02
type: execute
---

<objective>
Add three-dot menu to PhotoDetailScreen with delete/archive/restore actions for photo owners.

Purpose: Enable users to manage their photos directly from the fullscreen photo viewer with clear, confirmable actions.

Output: PhotoDetailScreen with owner menu supporting Delete Forever, Remove from Journal (archive), and Restore to Journal actions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-photo-deletion-archiving/23-CONTEXT.md
@.planning/phases/23-photo-deletion-archiving/23-01-PLAN.md

# Key source files:

@src/screens/PhotoDetailScreen.js
@src/styles/PhotoDetailScreen.styles.js
@src/components/DropdownMenu.js
@src/services/firebase/photoService.js
@src/context/PhotoDetailContext.js

**From CONTEXT.md:**

- Three-dot menu positioned in bottom right corner (thumb-friendly)
- Use existing DropdownMenu pattern from album photo viewer
- Different menu options for owner vs friend
- Clear confirmation before destructive actions

**Existing patterns:**

- PhotoDetailScreen has `isOwnPhoto` detection (line 184)
- DropdownMenu supports anchored positioning with `anchorPosition` prop
- Alert.alert for confirmation dialogs (consistent with other confirmations in app)

**Menu options by viewer:**

- **Owner viewing journaled photo:** "Remove from Journal", "Delete Forever"
- **Owner viewing archived photo:** "Restore to Journal", "Delete Forever"
- **Friend viewing photo:** (nothing for now - Phase 21 handles Report)

**After delete/archive:** Close the photo viewer and navigate back (photo is gone/hidden)
**After restore:** Update local state to reflect restored photoState
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add three-dot menu button and DropdownMenu</name>
  <files>src/screens/PhotoDetailScreen.js, src/styles/PhotoDetailScreen.styles.js</files>
  <action>
Add menu UI to PhotoDetailScreen:

1. **Import DropdownMenu** from '../components/DropdownMenu'
2. **Import photo service functions** from photoService (deletePhotoCompletely, archivePhoto, restorePhoto)

3. **Add state:**
   - `const [showPhotoMenu, setShowPhotoMenu] = useState(false)`
   - `const [menuAnchor, setMenuAnchor] = useState(null)` (for anchored position)

4. **Add menu button** (only for own photos):
   - Position: bottom-right corner of photo, above footer (similar to album viewer)
   - Use `onLayout` to capture button position for anchored menu
   - Icon: `ellipsis-horizontal` from Ionicons
   - Only render when `isOwnPhoto` is true

5. **Add DropdownMenu component** at end of component:
   - `visible={showPhotoMenu}`
   - `onClose={() => setShowPhotoMenu(false)}`
   - `anchorPosition={menuAnchor}`
   - Options array built dynamically based on `currentPhoto.photoState`

6. **Build menu options:**

   ```javascript
   const menuOptions = useMemo(() => {
     if (!isOwnPhoto) return [];

     const options = [];

     if (currentPhoto?.photoState === 'journal') {
       options.push({
         label: 'Remove from Journal',
         icon: 'archive-outline',
         onPress: handleArchive,
       });
     } else if (currentPhoto?.photoState === 'archive') {
       options.push({
         label: 'Restore to Journal',
         icon: 'refresh-outline',
         onPress: handleRestore,
       });
     }

     options.push({
       label: 'Delete Forever',
       icon: 'trash-outline',
       onPress: handleDeleteConfirm,
       destructive: true,
     });

     return options;
   }, [isOwnPhoto, currentPhoto?.photoState]);
   ```

7. **Add styles** for menu button (bottom-right positioning, semi-transparent background for visibility over photo).
   </action>
   <verify>Menu button appears on own photos. Tapping opens DropdownMenu with correct options based on photoState.</verify>
   <done>Three-dot menu button renders for own photos only, DropdownMenu shows with correct archive/restore/delete options</done>
   </task>

<task type="auto">
  <name>Task 2: Implement menu action handlers with confirmations</name>
  <files>src/screens/PhotoDetailScreen.js</files>
  <action>
Implement the three action handlers:

1. **handleArchive:**

   ```javascript
   const handleArchive = useCallback(() => {
     Alert.alert(
       'Remove from Journal',
       'This photo will be hidden from your stories and feed but remain in your albums. You can restore it anytime.',
       [
         { text: 'Cancel', style: 'cancel' },
         {
           text: 'Remove',
           onPress: async () => {
             const result = await archivePhoto(currentPhoto.id, contextUserId);
             if (result.success) {
               handleClose(); // Close viewer - photo is now hidden
             } else {
               Alert.alert('Error', result.error || 'Failed to archive photo');
             }
           },
         },
       ]
     );
   }, [currentPhoto?.id, contextUserId, handleClose]);
   ```

2. **handleRestore:**

   ```javascript
   const handleRestore = useCallback(async () => {
     // No confirmation needed for restore - it's not destructive
     const result = await restorePhoto(currentPhoto.id, contextUserId);
     if (result.success) {
       // Update local photo state to reflect change (so menu updates)
       // The photo will now appear in feed/stories again
       Alert.alert('Restored', 'Photo has been restored to your journal.');
     } else {
       Alert.alert('Error', result.error || 'Failed to restore photo');
     }
   }, [currentPhoto?.id, contextUserId]);
   ```

3. **handleDeleteConfirm:**

   ```javascript
   const handleDeleteConfirm = useCallback(() => {
     Alert.alert(
       'Delete Forever',
       'This will permanently delete this photo from your account, including all albums, comments, and reactions. This cannot be undone.',
       [
         { text: 'Cancel', style: 'cancel' },
         {
           text: 'Delete',
           style: 'destructive',
           onPress: async () => {
             const result = await deletePhotoCompletely(currentPhoto.id, contextUserId);
             if (result.success) {
               handleClose(); // Close viewer - photo is deleted
             } else {
               Alert.alert('Error', result.error || 'Failed to delete photo');
             }
           },
         },
       ]
     );
   }, [currentPhoto?.id, contextUserId, handleClose]);
   ```

4. **Import Alert** from react-native if not already imported.

Note: After archive or delete, `handleClose()` navigates away since the photo is no longer visible/exists. After restore, we stay on the photo but could optionally show a success message.
</action>
<verify>Tapping menu options shows appropriate confirmation dialogs. Confirming delete/archive closes the viewer.</verify>
<done>All three action handlers implemented with proper confirmations, service calls, and navigation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Photo management menu in PhotoDetailScreen with delete, archive, and restore functionality</what-built>
  <how-to-verify>
    1. Run: `npx expo start` and open app on device/simulator
    2. Navigate to your own photo (via Me story card or feed if you have recent photos)
    3. Verify: Three-dot menu button appears in bottom-right corner
    4. Tap menu and verify options:
       - For journaled photo: "Remove from Journal" and "Delete Forever"
       - For archived photo (view via album): "Restore to Journal" and "Delete Forever"
    5. Test Archive:
       - Tap "Remove from Journal"
       - Confirm dialog appears explaining the action
       - Tap "Remove"
       - Verify: Viewer closes, photo no longer appears in stories/feed
       - Verify: Photo still visible in albums/monthly albums
    6. Test Restore:
       - View an archived photo from an album
       - Tap menu → "Restore to Journal"
       - Verify: Success message appears
       - Verify: Photo now appears in stories/feed (if within visibility window)
    7. Test Delete:
       - View a photo you want to permanently delete
       - Tap menu → "Delete Forever"
       - Confirm dialog appears with serious warning
       - Tap "Delete"
       - Verify: Viewer closes
       - Verify: Photo is gone from all albums, stories, feed
    8. Test as Friend:
       - View a friend's photo
       - Verify: No three-dot menu appears (owner only)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Menu button renders only for own photos
- [ ] DropdownMenu shows correct options based on photoState
- [ ] Archive shows confirmation and hides photo from active views
- [ ] Restore works and returns photo to journal
- [ ] Delete shows serious confirmation and permanently removes photo
- [ ] No errors in console during operations
- [ ] `npm run lint` passes
</verification>

<success_criteria>

- Users can archive photos to hide from feed/stories while keeping in albums
- Users can restore archived photos to make them visible again
- Users can permanently delete photos with full cascade cleanup
- Menu only appears for photo owners
- All actions have appropriate confirmations
- Phase 23 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/23-photo-deletion-archiving/23-02-SUMMARY.md`
</output>
