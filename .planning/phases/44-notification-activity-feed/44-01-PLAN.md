---
phase: 44-notification-activity-feed
plan: 01
type: execute
---

<objective>
Fix deep linking so every notification type navigates to the correct destination across all three tap paths: push notification taps, in-app banner taps, and activity feed taps.

Purpose: Currently comment, mention, and friend_accepted notifications navigate to wrong destinations (generic feed or sender profile instead of the relevant content). The tagged notification in the activity feed also fails due to a field name mismatch (taggerId vs senderId).
Output: All 6 notification types navigate correctly on tap from push notifications, in-app banners, and the activity feed.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-notification-activity-feed/44-CONTEXT.md
@.planning/phases/38-notification-ui-polish/38-02-SUMMARY.md

@src/services/firebase/notificationService.js
@src/screens/ActivityScreen.js
@App.js

**Three deep linking paths that must be unified:**

1. **Push notification tap** → handleNotificationTapped() in notificationService.js → navigateToNotification() in App.js
2. **In-app banner tap** → handleBannerPress() in App.js → same handleNotificationTapped() → same navigateToNotification()
3. **Activity feed tap** → handleNotificationPress() in ActivityScreen.js

**Current gaps in handleNotificationTapped (notificationService.js switch statement):**

- `comment` type: no case → falls to default (Feed with empty params). Should go to Feed with photoId.
- `mention` type: no case → falls to default. Should go to Feed with photoId.
- `friend_accepted` type: no case → falls to default. Should go to FriendRequests screen.

**Current gaps in handleNotificationPress (ActivityScreen.js):**

- `comment` type: no handler → falls to default (sender profile). Should navigate to Feed with photoId.
- `mention` type: no handler → falls to default (sender profile). Should navigate to Feed with photoId.
- `tagged` type: destructures `taggerId` from item (line 196) but Firestore notification documents store this value as `senderId`, not `taggerId`. So `taggerId` is always undefined → condition `type === 'tagged' && taggerId` fails → falls to sender profile.

**Firestore notification document fields by type (from Cloud Functions):**

- `reaction`: senderId, photoId, reactions (emoji map)
- `comment`: senderId, photoId, commentId
- `mention`: senderId, photoId, commentId
- `tagged`: senderId (=tagger), photoId, photoIds, photoCount
- `story`: senderId (=poster), userId (=poster)
- `friend_accepted`: senderId, friendshipId

**Established patterns:**

- Optimistic UI: update local state immediately, then persist to Firestore
- Per-tap mark-as-read (from Phase 38-02)
- Navigation targets: MainTabs→Feed (with photoId), FriendsList, OtherUserProfile
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Fix push/banner deep linking in handleNotificationTapped</name>
  <files>src/services/firebase/notificationService.js</files>
  <action>
Add three missing cases to the switch statement in handleNotificationTapped (currently handles photo_reveal, friend_request, reaction, story, tagged):

1. `case 'comment':` — Navigate to Feed with photoId (same pattern as reaction):

   ```
   return { success: true, data: { type: 'comment', screen: 'Feed', params: { photoId } } }
   ```

2. `case 'mention':` — Navigate to Feed with photoId (same as comment — the mention is on a photo's comment):

   ```
   return { success: true, data: { type: 'mention', screen: 'Feed', params: { photoId } } }
   ```

3. `case 'friend_accepted':` — Navigate to FriendRequests screen (same pattern as friend_request):
   ```
   return { success: true, data: { type: 'friend_accepted', screen: 'FriendRequests', params: {} } }
   ```

Place the comment and mention cases together (they share the same navigation target). Place friend_accepted next to friend_request since they share the same screen target.

Also destructure `commentId` from data alongside the existing destructured fields — it's available in comment/mention notifications and may be useful for future scroll-to-comment functionality.
</action>
<verify>npm run lint -- src/services/firebase/notificationService.js passes with no errors</verify>
<done>handleNotificationTapped switch covers all 8 notification types (photo_reveal, friend_request, friend_accepted, reaction, comment, mention, story, tagged) with explicit navigation targets. No type falls through to default.</done>
</task>

<task type="auto">
  <name>Task 2: Fix activity feed deep linking in handleNotificationPress</name>
  <files>src/screens/ActivityScreen.js</files>
  <action>
Fix three issues in handleNotificationPress:

1. **Add comment/mention handlers** — Add a condition before the friend_accepted check:

   ```javascript
   } else if ((type === 'comment' || type === 'mention') && photoId) {
     navigation.navigate('MainTabs', { screen: 'Feed', params: { photoId } });
   }
   ```

   This follows the exact same navigation pattern as reaction.

2. **Fix tagged handler field name** — The current code destructures `taggerId` from item (line 196) but Firestore notification docs store the tagger's ID as `senderId`, not `taggerId`. Fix the tagged condition from:

   ```javascript
   } else if (type === 'tagged' && taggerId) {
     navigation.navigate('MainTabs', {
       screen: 'Feed',
       params: { highlightUserId: taggerId, highlightPhotoId: photoId, openStory: true },
     });
   ```

   to use `item.senderId` instead of `taggerId`:

   ```javascript
   } else if (type === 'tagged' && item.senderId) {
     navigation.navigate('MainTabs', {
       screen: 'Feed',
       params: { highlightUserId: item.senderId, highlightPhotoId: photoId, openStory: true },
     });
   ```

   Remove `taggerId` from the destructuring on line 196 since it's no longer used.

3. **Order of conditions** after the fix should be:
   - reaction && photoId → Feed with photoId
   - story && notifUserId → Feed with highlightUserId + openStory
   - tagged && item.senderId → Feed with highlightUserId + highlightPhotoId + openStory
   - (comment || mention) && photoId → Feed with photoId
   - friend_accepted || friend_request → FriendsList
   - default: senderId → OtherUserProfile
     </action>
     <verify>npm run lint -- src/screens/ActivityScreen.js passes with no errors</verify>
     <done>All 6 notification types in the activity feed have explicit navigation handlers. Tagged notifications use senderId (correct Firestore field) instead of taggerId. Comment and mention navigate to Feed with photoId.</done>
     </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run lint -- src/services/firebase/notificationService.js` passes
- [ ] `npm run lint -- src/screens/ActivityScreen.js` passes
- [ ] handleNotificationTapped covers: photo_reveal, friend_request, friend_accepted, reaction, comment, mention, story, tagged
- [ ] handleNotificationPress covers: reaction, story, tagged (with senderId), comment, mention, friend_accepted, friend_request
- [ ] No notification type falls through to default handler
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Every notification type navigates to the correct screen across all 3 tap paths
- Tagged notification uses correct field name (senderId not taggerId)
- No lint errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/44-notification-activity-feed/44-01-SUMMARY.md`
</output>
