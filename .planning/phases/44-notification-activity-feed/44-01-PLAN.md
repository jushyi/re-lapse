---
phase: 44-notification-activity-feed
plan: 01
type: execute
---

<objective>
Refactor ActivityScreen to properly render all notification types with distinct formatting and add photo thumbnails for photo-related notifications.

Purpose: The notification list currently only renders reaction notifications properly — all other types (comment, mention, tagged, story, friend_accepted) fall back to raw message text. This plan makes every notification type visually distinct and adds photo thumbnails for an Instagram-style activity feed.
Output: ActivityScreen renders all 6 notification types with proper action text, and photo-related notifications show a thumbnail preview on the right side.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-notification-activity-feed/44-CONTEXT.md
@.planning/phases/38-notification-ui-polish/38-02-SUMMARY.md

@src/screens/ActivityScreen.js
@src/services/firebase/notificationService.js
@src/services/firebase/photoService.js
@src/constants/colors.js
@src/constants/typography.js

**Notification types stored in Firestore (from Cloud Functions):**

- `reaction` — fields: senderId, senderName, senderProfilePhotoURL, photoId, reactions (emoji map), message
- `comment` — fields: senderId, senderName, senderProfilePhotoURL, photoId, commentText, message
- `mention` — fields: senderId, senderName, senderProfilePhotoURL, photoId, commentText, message
- `tagged` — fields: taggerId, senderName, senderProfilePhotoURL, photoId, message
- `story` — fields: senderId, senderName, senderProfilePhotoURL, userId, message
- `friend_accepted` — fields: senderId, senderName, senderProfilePhotoURL, userId, message

**Key existing patterns:**

- getActionText (line 188) currently only handles reactions properly, falls back to raw message for others
- renderNotification (line 285) renders: unread dot, avatar, sender name (bold) + action text, time
- Photo documents have `imageURL` field; `getPhotosByIds` from photoService batch-fetches photos
- Friend requests section remains pinned at top (uses separate friendships collection data)
- Optimistic UI: update local state immediately, then persist to Firestore

**Known gap:** Reply notifications are NOT stored — sendCommentNotification explicitly skips replies (parentId check). Not addressed in this plan.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update notification renderers for all types</name>
  <files>src/screens/ActivityScreen.js</files>
  <action>
Refactor getActionText to return type-specific action text for each notification type:
- `reaction`: Keep existing — "reacted {emoji summary} to your photo"
- `comment`: "commented: {commentText truncated to ~40 chars}" — use item.commentText if available, else strip senderName prefix from item.message
- `mention`: "mentioned you in a comment" — concise, no need to show comment text
- `tagged`: "tagged you in a photo"
- `story`: "shared a new story"
- `friend_accepted`: "accepted your friend request"
- Default fallback: "sent you a notification"

Use a switch on item.type at the top of getActionText for clear routing instead of the current if/else chain. Keep formatReactionsText helper for reaction type.

Rename the "Reactions" section header (line 400) from "Reactions" to "Activity" since it now shows all notification types.

Update the empty state text (line 332) from "Friend requests and reactions will appear here" to "Likes, comments, and other activity will appear here".
</action>
<verify>npm run lint -- src/screens/ActivityScreen.js passes with no errors</verify>
<done>getActionText returns distinct, descriptive text for all 6 notification types. Section header reads "Activity". Empty state updated.</done>
</task>

<task type="auto">
  <name>Task 2: Add photo thumbnails to notification items</name>
  <files>src/screens/ActivityScreen.js</files>
  <action>
Add a small square photo thumbnail on the right side of notification items for photo-related notifications (reaction, comment, mention, tagged).

Implementation:

1. Import `getPhotosByIds` from `../services/firebase/photoService` (already exported from photoService.js)
2. Add state: `const [photoMap, setPhotoMap] = useState({})` to store photoId → imageURL mapping
3. In loadData (after fetchNotifications returns), extract unique photoIds from notifications that have a photoId field, call getPhotosByIds to batch-fetch photo documents, build a map of photoId → imageURL, and set it to photoMap state
4. In renderNotification, after the time text, conditionally render a thumbnail: if item.photoId exists and photoMap[item.photoId] has an imageURL, render an Image component with that URL

Thumbnail styling:

- Size: 44×44px with borderRadius 6 (small rounded square, NOT circular — distinct from the circular avatar)
- marginLeft: 8 (space between time and thumbnail)
- Use expo-image's Image if already imported, otherwise use React Native Image (check existing imports)
- backgroundColor: colors.background.tertiary as placeholder while loading

Layout adjustment:

- Move the time text into the notifContent flex container (before the closing tag) so it sits below the message text instead of taking its own flex space
- This frees the right side for the thumbnail
- Time moves from standalone element to inside notifContent, rendered below the message
- The thumbnail sits at the far right of the row

For story and friend_accepted types (no photo thumbnail): the right side remains empty — the row layout handles this gracefully since the thumbnail is conditionally rendered.

Do NOT fetch photos for every re-render — only fetch when notifications change. Use a useEffect or include the fetch in loadData.
</action>
<verify>npm run lint -- src/screens/ActivityScreen.js passes with no errors</verify>
<done>Photo-related notifications (reaction, comment, mention, tagged) show a 44×44 rounded-square photo thumbnail on the right side. Non-photo notifications render without thumbnail. No extra network calls on re-render.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run lint -- src/screens/ActivityScreen.js` passes
- [ ] All 6 notification types produce distinct action text in getActionText
- [ ] Photo thumbnails render for photo-related notification types
- [ ] Friend requests section still works (unchanged)
- [ ] No new warnings or errors introduced
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- ActivityScreen renders all notification types with descriptive action text
- Photo thumbnails display for reaction, comment, mention, tagged notifications
- No TypeScript/lint errors or warnings
  </success_criteria>

<output>
After completion, create `.planning/phases/44-notification-activity-feed/44-01-SUMMARY.md`
</output>
