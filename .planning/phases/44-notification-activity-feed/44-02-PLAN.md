---
phase: 44-notification-activity-feed
plan: 02
type: execute
---

<objective>
Add reaction clumping (per-user-per-photo deduplication) and time-grouped section headers to the notification activity feed.

Purpose: Reaction spam floods the inbox when someone toggles multiple emojis on the same photo. Time grouping gives temporal context (Instagram-style sections). Minor text updates reflect that the feed shows all activity, not just reactions.
Output: ActivityScreen shows deduplicated reaction notifications grouped under Today / This Week / Earlier section headers.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-notification-activity-feed/44-CONTEXT.md
@.planning/phases/44-notification-activity-feed/44-01-SUMMARY.md

@src/screens/ActivityScreen.js
@src/utils/timeUtils.js
@src/constants/colors.js
@src/constants/typography.js

**Reaction clumping context:**

The Cloud Function creates a notification document each time a user's reactions change on a photo. The `reactions` field is a map of the user's CURRENT reactions on that photo at that moment (e.g., `{ "‚ù§Ô∏è": 1, "üòÇ": 1 }`). So if User A adds ‚ù§Ô∏è then later adds üòÇ, there are TWO notification documents for the same (senderId, photoId) pair. The LATEST document already has the complete reaction state. Clumping = keep only the newest notification per (senderId, photoId) and discard older duplicates.

**Time grouping context:**

Notifications have a `createdAt` field (Firestore Timestamp with `.seconds` property or `.toDate()` method). Group into: Today (since midnight), This Week (past 7 days), Earlier (everything else). Skip empty sections.

**Existing layout:**

- ScrollView with RefreshControl wraps everything
- Friend requests section pinned at top (separate data, unchanged)
- "Reactions" section header for notifications (should become time-grouped sections)
- sectionTitle style already exists: uppercase, bold, secondary color, letterSpacing 0.5

**Established patterns:**

- useMemo for derived data
- getTimeAgo from timeUtils for relative timestamps
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Add client-side reaction clumping</name>
  <files>src/screens/ActivityScreen.js</files>
  <action>
Add a deduplication step after fetching notifications to collapse multiple reaction notifications from the same user on the same photo into one.

1. Import `useMemo` from React (add to existing import).

2. Create a memoized deduplication:

   ```javascript
   const clumpedNotifications = useMemo(() => {
     // Group reaction notifications by senderId+photoId, keep latest
     const reactionKeys = new Map(); // key ‚Üí notification
     const result = [];

     for (const notif of notifications) {
       if (notif.type === 'reaction' && notif.senderId && notif.photoId) {
         const key = `${notif.senderId}-${notif.photoId}`;
         const existing = reactionKeys.get(key);
         if (!existing) {
           reactionKeys.set(key, notif);
           result.push(notif);
         } else {
           // Keep the one with the latest createdAt
           const existingTime = existing.createdAt?.seconds || 0;
           const newTime = notif.createdAt?.seconds || 0;
           if (newTime > existingTime) {
             // Replace existing in result array
             const idx = result.indexOf(existing);
             result[idx] = notif;
             reactionKeys.set(key, notif);
           }
           // else discard the older duplicate
         }
       } else {
         // Non-reaction notifications pass through unchanged
         result.push(notif);
       }
     }

     return result;
   }, [notifications]);
   ```

3. Replace all references to `notifications` in the render section with `clumpedNotifications`:
   - The notifications.length check (line 365) ‚Üí `clumpedNotifications.length`
   - The notifications.map (line 370) ‚Üí `clumpedNotifications.map`
   - The empty state check (line 294) ‚Üí `clumpedNotifications.length`

Keep the original `notifications` state for the raw data (needed for re-clumping on refresh). Only the rendered output uses `clumpedNotifications`.
</action>
<verify>npm run lint -- src/screens/ActivityScreen.js passes with no errors</verify>
<done>Multiple reaction notifications from the same user on the same photo collapse into a single item showing the latest reaction state. Non-reaction notifications are unaffected.</done>
</task>

<task type="auto">
  <name>Task 2: Add time-grouped section headers and text updates</name>
  <files>src/screens/ActivityScreen.js</files>
  <action>
Replace the flat "Reactions" section with time-grouped sections (Today / This Week / Earlier).

1. Create a helper function `groupNotificationsByTime(notifs)`:
   - Calculate boundaries: `todayStart` = start of today (midnight), `weekAgo` = 7 days ago
   - Iterate notifications and assign to sections based on createdAt:
     - createdAt >= todayStart ‚Üí "Today"
     - createdAt >= weekAgo ‚Üí "This Week"
     - else ‚Üí "Earlier"
   - Handle createdAt as Firestore Timestamp: use `notif.createdAt?.seconds * 1000` to get ms, or `notif.createdAt?.toDate?.()` if available, fallback to treating as Date
   - Return array of `{ title, data }` objects, filtering out empty sections
   - Notifications within each section maintain their original order (already sorted desc by createdAt from the query)

2. Memoize the grouping:

   ```javascript
   const groupedSections = useMemo(
     () => groupNotificationsByTime(clumpedNotifications),
     [clumpedNotifications]
   );
   ```

3. Replace the notifications render block (lines 364-374) ‚Äî instead of a single "Reactions" header + flat list, render grouped sections:

   ```jsx
   {
     groupedSections.length > 0 && (
       <View style={styles.section}>
         {groupedSections.map(section => (
           <View key={section.title}>
             <Text style={[styles.sectionTitle, styles.timeSectionHeader]}>{section.title}</Text>
             {section.data.map(item => (
               <View key={item.id}>{renderNotification({ item })}</View>
             ))}
           </View>
         ))}
       </View>
     );
   }
   ```

4. Add `timeSectionHeader` style:

   ```javascript
   timeSectionHeader: {
     paddingHorizontal: 16,
     paddingTop: 20,
     paddingBottom: 8,
   },
   ```

   This reuses the existing `sectionTitle` base style (uppercase, bold, secondary color, letterSpacing) and adds specific padding. The first "Reactions" header that was inline-styled with `paddingHorizontal: 16, paddingVertical: 12` is now replaced by the time section headers.

5. Update empty state text (line 299) from:
   `"Friend requests and reactions will appear here"`
   to:
   `"Likes, comments, and other activity will appear here"`

6. Update the empty state check to use `clumpedNotifications.length` (if not already done in Task 1) and `groupedSections.length` for the section rendering.
   </action>
   <verify>npm run lint -- src/screens/ActivityScreen.js passes with no errors</verify>
   <done>Notifications display under time-grouped section headers ("Today", "This Week", "Earlier"). Empty sections omitted. Empty state text updated. Friend requests section unchanged at top.</done>
   </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete notification activity feed with deep linking fixes (Plan 1), reaction clumping, and time-grouped sections</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. Open the app and navigate to the Notifications screen (heart icon)
    3. Verify friend requests section still appears at top (if any pending)
    4. Verify notifications are grouped under section headers: "Today", "This Week", "Earlier"
    5. Check that reaction notifications from the same person on the same photo are collapsed into one item (not repeated)
    6. Check each notification type renders with correct action text
    7. Tap a reaction notification ‚Äî verify it navigates to the Feed (not sender profile)
    8. Tap a comment/mention notification ‚Äî verify it navigates to the Feed (not sender profile)
    9. Tap a tagged notification ‚Äî verify it navigates to the Feed with the tagger's content
    10. Tap a friend_accepted notification ‚Äî verify it navigates to the Friends list
    11. Verify tapping marks notification as read (dot disappears)
    12. Pull to refresh ‚Äî verify notifications reload correctly
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run lint -- src/screens/ActivityScreen.js` passes
- [ ] Reaction clumping works (same user + same photo = one notification)
- [ ] Time sections display correctly (Today / This Week / Earlier)
- [ ] Empty sections are omitted
- [ ] Friend requests section unchanged
- [ ] Pull-to-refresh still works
- [ ] No regressions from Plan 1 deep linking fixes
- [ ] Visual verification approved by user
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Reaction spam is collapsed per-user-per-photo
- Notifications display in time-grouped sections
- Visual verification approved
- Phase 44 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/44-notification-activity-feed/44-02-SUMMARY.md`
</output>
