---
phase: 44-notification-activity-feed
plan: 02
type: execute
---

<objective>
Add time-grouped section headers and polish deep linking for comment/mention notification types to complete the Instagram-style activity feed.

Purpose: Time grouping gives temporal context to the notification stream ("Today", "This Week", "Earlier"), and proper deep linking ensures every notification is tappable and navigates to relevant content.
Output: ActivityScreen shows notifications grouped by time period with styled section headers, and all notification types navigate correctly on tap.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-notification-activity-feed/44-CONTEXT.md
@.planning/phases/44-notification-activity-feed/44-01-SUMMARY.md

@src/screens/ActivityScreen.js
@src/services/firebase/notificationService.js
@src/constants/colors.js
@src/constants/typography.js
@src/utils/timeUtils.js

**Established patterns:**

- Optimistic UI: update local state immediately, then persist to Firestore
- Per-tap mark-as-read (from Phase 38-02)
- handleNotificationPress already handles: reaction, story, tagged, friend_accepted, friend_request
- Navigation targets: Feed (with photoId), FriendsList, OtherUserProfile

**Deep linking gap:** comment and mention types have no navigation handler — they fall through to the default (sender profile view). Should navigate to Feed with photoId (same pattern as reactions) since the Feed is where photos live.

**Pre-existing limitation:** FeedScreen does not currently consume route params (photoId, highlightUserId, etc.). All notification types navigate to the Feed tab — the specific photo highlighting is not yet implemented. This is consistent across all types and not in scope for this plan.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add time-grouped section headers</name>
  <files>src/screens/ActivityScreen.js</files>
  <action>
Group notifications into time-based sections: "Today", "This Week", "Earlier".

Implementation:

1. Create a helper function `groupNotificationsByTime(notifications)` that:
   - Gets current date and calculates boundaries: today (start of today), thisWeek (7 days ago), earlier (everything else)
   - Iterates notifications and assigns each to a section based on its createdAt timestamp
   - Returns an array of section objects: `[{ title: 'Today', data: [...] }, { title: 'This Week', data: [...] }, { title: 'Earlier', data: [...] }]`
   - Filters out empty sections (don't show "Today" header if no today notifications)
   - Handle createdAt as Firestore Timestamp (has .seconds or .toDate() method) or as Date

2. Replace the notifications map rendering (lines 398-407) with a SectionList approach:
   - Import SectionList from react-native (replace ScrollView usage for the notifications portion)
   - Actually, keep the ScrollView for the overall layout (friend requests at top + notification sections below) since friend requests are NOT part of the sections
   - Instead of SectionList, render section headers manually: iterate through grouped sections and render a header Text + notification items for each section
   - This keeps the existing ScrollView + RefreshControl + friend requests layout intact

3. Render section headers with styling:
   - Text component with the section title ("Today", "This Week", "Earlier")
   - Style: colors.text.secondary, uppercase, typography.fontFamily.bodyBold, typography.size.sm
   - paddingHorizontal: 16, paddingTop: 20, paddingBottom: 8
   - letterSpacing: 0.5

4. Use useMemo to memoize the grouped sections so they only recompute when notifications array changes:
   `const groupedSections = useMemo(() => groupNotificationsByTime(notifications), [notifications]);`

Do NOT change the friend requests section — it stays pinned at top, before the activity sections.
</action>
<verify>npm run lint -- src/screens/ActivityScreen.js passes with no errors</verify>
<done>Notifications display under time-grouped section headers ("Today", "This Week", "Earlier"). Empty sections are omitted. Friend requests section unchanged at top.</done>
</task>

<task type="auto">
  <name>Task 2: Add deep linking for comment and mention notification types</name>
  <files>src/screens/ActivityScreen.js</files>
  <action>
Add navigation handlers for `comment` and `mention` notification types in handleNotificationPress.

Implementation:

1. In handleNotificationPress (line 212), add two new cases before the default fallback:
   - `comment` type: if photoId exists, navigate to Feed with photoId (same pattern as reaction): `navigation.navigate('MainTabs', { screen: 'Feed', params: { photoId } })`
   - `mention` type: same as comment — navigate to Feed with photoId since the mention is within a comment on a photo

2. Add the cases after the existing `tagged` handler and before the `friend_accepted` check:

```javascript
} else if ((type === 'comment' || type === 'mention') && photoId) {
  navigation.navigate('MainTabs', { screen: 'Feed', params: { photoId } });
}
```

This follows the exact same navigation pattern as reactions. When FeedScreen eventually supports consuming photoId params, all three types will benefit.
</action>
<verify>npm run lint -- src/screens/ActivityScreen.js passes with no errors</verify>
<done>Comment and mention notifications navigate to Feed with photoId on tap. All 6 notification types have explicit navigation handlers.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete notification activity feed with all types rendered, photo thumbnails, time grouping, and deep linking</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. Open the app and navigate to the Notifications screen (heart icon)
    3. Verify friend requests section still appears at top (if any pending)
    4. Verify notifications are grouped under section headers: "Today", "This Week", "Earlier"
    5. Check each notification type renders with distinct action text:
       - Reactions: "reacted {emojis} to your photo"
       - Comments: "commented: {text preview}"
       - Mentions: "mentioned you in a comment"
       - Tagged: "tagged you in a photo"
       - Story: "shared a new story"
       - Friend accepted: "accepted your friend request"
    6. Verify photo-related notifications (reaction, comment, mention, tagged) show a small square thumbnail on the right
    7. Verify non-photo notifications (story, friend_accepted) have no thumbnail
    8. Tap a notification — verify it marks as read (dot disappears) and navigates appropriately
    9. Pull to refresh — verify notifications reload
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run lint -- src/screens/ActivityScreen.js` passes
- [ ] Notifications grouped by "Today", "This Week", "Earlier" sections
- [ ] Comment and mention notifications navigate to Feed on tap
- [ ] All notification types have explicit navigation handlers
- [ ] No regressions in friend requests section
- [ ] Pull-to-refresh still works
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Notifications display in time-grouped sections
- All 6 notification types navigate correctly on tap
- Visual verification approved by user
- Phase 44 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/44-notification-activity-feed/44-02-SUMMARY.md`
</output>
