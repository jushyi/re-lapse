---
phase: 13.1-darkroom-reveal-timing-fix
plan: 01-FIX
type: fix
---

<objective>
Fix 2 UAT issues from plan 13.1-01: Darkroom initialization not working on photo capture.

Source: 13.1-01-ISSUES.md
Priority: 0 critical, 2 major, 0 minor

Both issues stem from the same root cause: `ensureDarkroomInitialized()` is not executing successfully after photo capture.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/13.1-darkroom-reveal-timing-fix/13.1-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/13.1-darkroom-reveal-timing-fix/13.1-01-PLAN.md

**Key files:**
@src/services/firebase/darkroomService.js
@src/services/firebase/photoService.js

**Root Cause Analysis:**

Both UAT issues (001 and 002) indicate `ensureDarkroomInitialized()` is not working:
- UAT-001: Existing darkroom not refreshed when stale
- UAT-002: New darkroom not created on photo capture

The code at photoService.js:77-83 calls `ensureDarkroomInitialized(userId)` and logs the result, but:
1. The function may be failing silently
2. The Firestore write may be failing
3. There may be an async/await issue

**Investigation approach:**
1. Add comprehensive logging already done (need to test with logs)
2. Check if photo is being captured successfully (user confirmed: YES)
3. Check Metro bundler serving latest code (user confirmed: cleared cache)
4. Debug the actual error from logs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Debug ensureDarkroomInitialized with test capture</name>
  <files>src/services/firebase/darkroomService.js, src/services/firebase/photoService.js</files>
  <action>
The logging has already been added. This task is to:

1. Review the current code to ensure it's correct:
   - Verify `ensureDarkroomInitialized` is properly exported
   - Verify import in photoService.js is correct
   - Verify the function is being awaited properly

2. Check for any obvious issues in the code that could cause silent failure:
   - Missing exports
   - Typos in function names
   - Incorrect Firestore references

3. If code looks correct, the issue may be:
   - Firebase permissions (check Firestore rules for darkrooms collection)
   - The function runs but writes fail silently

Read the current code and verify correctness.
  </action>
  <verify>
1. ensureDarkroomInitialized is exported from darkroomService.js
2. photoService.js imports and awaits ensureDarkroomInitialized correctly
3. No obvious code errors
  </verify>
  <done>
- Code reviewed and verified correct (or issues identified)
- Root cause identified
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix Firestore security rules for darkrooms collection</name>
  <files>firestore.rules (or Firebase console)</files>
  <action>
Check if Firestore security rules allow writing to darkrooms collection.

The user can create photos (photos collection works), but darkrooms may have different rules.

If this is the issue, the rules should allow:
- Users to read/write their own darkroom document: `darkrooms/{userId}` where `userId == request.auth.uid`

Check current rules and ensure darkrooms collection has proper write permissions.

**If rules file exists locally:**
- Review firestore.rules
- Ensure darkrooms collection has write permissions

**If rules are only in Firebase console:**
- Note that user needs to update rules in console

Common rule pattern:
```
match /darkrooms/{userId} {
  allow read, write: if request.auth != null && request.auth.uid == userId;
}
```
  </action>
  <verify>
1. Check if firestore.rules file exists locally
2. Review rules for darkrooms collection
3. Ensure authenticated users can write to their own darkroom document
  </verify>
  <done>
- Firestore rules verified or updated for darkrooms collection
- Users can write to darkrooms/{userId} where userId matches their auth
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Added logging and verified code/rules</what-built>
  <how-to-verify>
1. Restart Metro with cache clear: `npx expo start -c`
2. Open the app
3. Navigate to Camera and capture a photo
4. Check Metro console logs for:
   - "PhotoService.createPhoto: Calling ensureDarkroomInitialized"
   - "DarkroomService.ensureDarkroomInitialized: ENTRY"
   - Success or FAILED messages
5. Check Firestore darkrooms collection for the user's document

Report what you see in the logs and Firestore.
  </how-to-verify>
  <resume-signal>Describe what logs appear and whether darkroom document was created/updated</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Apply fix based on checkpoint findings</name>
  <files>Depends on findings</files>
  <action>
Based on checkpoint findings, apply the appropriate fix:

**If logs show "ENTRY" but "FAILED":**
- Read error message from logs
- Fix the specific issue (permissions, reference error, etc.)

**If logs show "ENTRY" and "SUCCESS" but Firestore not updated:**
- Check if there's a Firestore emulator conflict
- Verify Firebase project configuration

**If logs don't show "ENTRY" at all:**
- The function isn't being reached
- Check if Metro is serving old code
- Force refresh the app completely

**If logs show "SUCCESS - Created new darkroom" but Firestore empty:**
- Firestore security rules are blocking
- Update rules to allow darkrooms writes

Apply the fix based on the actual error discovered.
  </action>
  <verify>
After applying fix:
1. Capture a new photo
2. Check Firestore - darkroom document should be created/updated
3. nextRevealAt should be within 0-15 minutes of current time
  </verify>
  <done>
- Root cause fixed
- Darkroom document created/updated on photo capture
- nextRevealAt is accurate
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] UAT-001 fixed: Existing stale darkrooms get nextRevealAt refreshed on photo capture
- [ ] UAT-002 fixed: New darkroom documents created on photo capture for new users
- [ ] Logs confirm ensureDarkroomInitialized runs successfully
- [ ] Firestore shows correct darkroom data after photo capture
</verification>

<success_criteria>
- All UAT issues from 13.1-01-ISSUES.md addressed
- Tests pass (photo capture creates/updates darkroom)
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/13.1-darkroom-reveal-timing-fix/13.1-01-FIX-SUMMARY.md`
</output>
