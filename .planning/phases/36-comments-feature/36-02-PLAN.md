---
phase: 36-comments-feature
plan: 02
type: execute
---

<objective>
Build the core comment UI components: CommentRow, CommentInput, and CommentsBottomSheet.

Purpose: Create reusable components for displaying comments, entering new comments, and containing the full comment thread in a keyboard-aware bottom sheet.
Output: Three new components in src/components/comments/ directory with proper styling.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-comments-feature/36-CONTEXT.md
@.planning/phases/36-comments-feature/36-RESEARCH.md

**Key source files:**
@src/components/PhotoDetailModal.js
@src/styles/PhotoDetailModal.styles.js
@src/constants/theme.js

**From CONTEXT.md - Comment row layout:**

- Left: Profile photo
- Middle column: Name (bold), comment text, "Reply" button at bottom-left
- Right: Heart button to like (Plan 04)

**From RESEARCH.md - Bottom sheet approach:**

- Use custom Animated Modal (NOT @gorhom/bottom-sheet due to Expo 54 compatibility)
- KeyboardAvoidingView with `behavior={Platform.OS === 'ios' ? 'padding' : 'height'}`
- Sheet covers ~60% of screen, photo stays visible at top
- FlatList for comments with `keyboardShouldPersistTaps="handled"`
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create CommentRow component</name>
  <files>src/components/comments/CommentRow.js</files>
  <action>
Create CommentRow.js for displaying a single comment:

**Props:**

- `comment` - Comment object with userId, text, mediaUrl, mediaType, likeCount, createdAt
- `user` - User object with displayName, profilePhotoURL
- `onReply` - Callback when Reply button pressed (receives comment)
- `onLike` - Callback when heart pressed (Plan 04, wire up placeholder)
- `onDelete` - Callback when delete pressed (Plan 04)
- `isOwnerComment` - Boolean if this is photo owner's comment (show "Author" badge)
- `canDelete` - Boolean if current user can delete this comment
- `isLiked` - Boolean if current user liked this comment (Plan 04)

**Layout:**

```
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚ 40  â”‚ Name (bold)                â”‚ â™¡   â”‚
â”‚ px  â”‚ Comment text wraps here... â”‚ 12  â”‚
â”‚ img â”‚ [Reply]  Â· 2h              â”‚     â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
```

**Implementation:**

- Profile photo (40x40, rounded) on left using expo-image
- Fallback to initials if no profilePhotoURL
- Name in bold, comment text below (can wrap)
- "Reply" TouchableOpacity at bottom-left, light gray text
- Timestamp (getTimeAgo) next to Reply, separated by dot
- Heart icon on right (outline for not liked, filled for liked - use Ionicons)
- If `canDelete`, show ellipsis menu or swipe-to-delete (simple: long-press to delete)
- If `isOwnerComment`, show small "Author" badge next to name

**Media comments:**

- If mediaUrl exists, show thumbnail below text (100x100, rounded corners)
- Use expo-image for efficient loading

**Styles:** Create src/styles/CommentRow.styles.js with StyleSheet.create()
</action>
<verify>
Import CommentRow in a test component and render with mock data. Verify layout matches design.
</verify>
<done>

- CommentRow.js created in src/components/comments/
- Shows profile photo, name, text, Reply button, timestamp, heart placeholder
- Handles media comments (thumbnail display)
- Author badge for owner comments
- Long-press for delete (when canDelete)
- Styles in separate file
  </done>
  </task>

<task type="auto">
  <name>Task 2: Create CommentInput component</name>
  <files>src/components/comments/CommentInput.js</files>
  <action>
Create CommentInput.js for the comment text entry:

**Props:**

- `onSubmit` - Callback with (text, mediaUrl, mediaType) when sent
- `onImagePick` - Callback to open image picker (Plan 06)
- `replyingTo` - Comment object if replying (shows "Replying to @name" indicator)
- `onCancelReply` - Callback to cancel reply mode
- `placeholder` - Custom placeholder text
- `autoFocus` - Boolean to auto-focus input
- `inputRef` - Ref forwarded to TextInput for external focus control

**Layout:**

```
[Replying to @username                    âœ•]  <- only if replyingTo
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ Add a comment...                â”‚ ğŸ“·â”‚ â¤ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
```

**Implementation:**

- TextInput with flex: 1, multiline, maxHeight constraint (~100px)
- Image picker button on right (ğŸ“· icon) - onPress calls onImagePick
- Send button (â¤ arrow icon) - disabled when text empty, onPress calls onSubmit
- If `replyingTo`, show banner above input with "Replying to @{name}" and X to cancel
- Use forwardRef so parent can programmatically focus
- Clear text after successful submit

**Keyboard handling:**

- returnKeyType="send" on TextInput
- onSubmitEditing calls onSubmit if text not empty

**Styles:** Create src/styles/CommentInput.styles.js

- Input row has subtle border or background
- Match theme colors from constants/theme.js
  </action>
  <verify>
  Render CommentInput standalone, verify text entry, send button enables/disables, reply banner shows when replyingTo provided.
  </verify>
  <done>
- CommentInput.js created with TextInput, image button, send button
- Reply banner with cancel functionality
- forwardRef for external focus control
- Send button disabled when empty
- Styles match app theme
  </done>
  </task>

<task type="auto">
  <name>Task 3: Create CommentsBottomSheet with keyboard handling</name>
  <files>src/components/comments/CommentsBottomSheet.js</files>
  <action>
Create CommentsBottomSheet.js as the container for the full comment thread:

**Props:**

- `visible` - Boolean to show/hide sheet
- `onClose` - Callback when sheet dismissed
- `photoId` - Photo ID to load comments for
- `photoOwnerId` - Photo owner's user ID (for delete permissions)
- `currentUserId` - Current user's ID
- `onCommentAdded` - Callback after comment successfully added

**Implementation (custom Animated Modal approach from RESEARCH.md):**

```javascript
const SHEET_HEIGHT = Dimensions.get('window').height * 0.6;

// Use Animated.Value for slide-up animation
const translateY = useRef(new Animated.Value(SHEET_HEIGHT)).current;

useEffect(() => {
  Animated.spring(translateY, {
    toValue: visible ? 0 : SHEET_HEIGHT,
    useNativeDriver: true,
    damping: 20,
    stiffness: 100,
  }).start();
}, [visible]);
```

**Structure:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Handle bar for drag gesture]       â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ Comments (X)              [Close X] â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                     â”‚
â”‚  [CommentRow]                       â”‚
â”‚  [CommentRow]                       â”‚
â”‚  [CommentRow]                       â”‚
â”‚  ...scrollable...                   â”‚
â”‚                                     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ [CommentInput]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key elements:**

- Modal with transparent background
- TouchableWithoutFeedback on backdrop to close
- Animated.View for sheet with slide-up animation
- KeyboardAvoidingView wrapping content (behavior per platform)
- FlatList for comments with keyboardShouldPersistTaps="handled"
- useComments hook (create simple version) for loading/subscribing
- CommentInput at bottom
- Handle drag-to-close gesture (optional - can use just backdrop tap)

**State management:**

- Load comments via commentService.subscribeToComments on mount
- Track replyingTo state (which comment being replied to)
- Pass onReply callback to CommentRow that sets replyingTo
- Pass replyingTo to CommentInput

**useComments hook:** Create src/hooks/useComments.js

- Subscribe to comments on photoId
- Return { comments, loading, error, addComment, deleteComment }
- Handle user data joining

**Styles:** Create src/styles/CommentsBottomSheet.styles.js

- Dark theme matching PhotoDetailModal
- Semi-transparent backdrop
- Sheet with rounded top corners
  </action>
  <verify>
  Import CommentsBottomSheet in PhotoDetailModal (temporary test), pass a photoId, verify it opens with keyboard handling working on iOS.
  </verify>
  <done>
- CommentsBottomSheet.js created with custom Animated Modal
- KeyboardAvoidingView properly configured for iOS/Android
- FlatList displays comments with CommentRow
- CommentInput at bottom with reply state management
- useComments.js hook created for state management
- Sheet height is 60% of screen (photo visible above)
- Backdrop tap closes sheet
- Styles match dark theme
  </done>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] src/components/comments/ directory exists with 3 components
- [ ] src/styles/ has corresponding style files
- [ ] src/hooks/useComments.js exists
- [ ] No ESLint errors in new files
- [ ] Components can be imported without errors
</verification>

<success_criteria>

- CommentRow displays comment with profile, name, text, reply button, heart placeholder
- CommentInput handles text entry with send button and reply banner
- CommentsBottomSheet opens as slide-up modal with keyboard handling
- useComments hook subscribes to real-time comment updates
- All components follow established patterns (StyleSheet.create, expo-image, theme colors)
- Keyboard doesn't cover input on iOS or Android
  </success_criteria>

<output>
After completion, create `.planning/phases/36-comments-feature/36-02-SUMMARY.md`
</output>
