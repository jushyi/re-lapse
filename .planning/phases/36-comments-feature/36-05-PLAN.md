---
phase: 36-comments-feature
plan: 05
type: execute
---

<objective>
Implement one-level threaded replies for comments.

Purpose: Enable Instagram-style reply threading where users can reply to top-level comments (but not to replies), with proper visual nesting and "View replies" expansion.
Output: Working reply system with visual threading, collapsible reply sections, smooth UX.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-comments-feature/36-CONTEXT.md
@.planning/phases/36-comments-feature/36-RESEARCH.md

**Key source files:**
@src/components/comments/CommentRow.js
@src/components/comments/CommentInput.js
@src/components/comments/CommentsBottomSheet.js
@src/hooks/useComments.js
@src/services/firebase/commentService.js

**From CONTEXT.md - Threading rules:**

- One level deep (Instagram-style): comments can have replies, but replies can't have further replies
- Reply button appears on top-level comments only
- Replies shown indented below parent

**From RESEARCH.md - Data model:**

- parentId: string | null - null for top-level, commentId for reply
- Query replies: where('parentId', '==', parentCommentId)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Add reply functionality to comment input</name>
  <files>src/components/comments/CommentsBottomSheet.js, src/components/comments/CommentInput.js, src/hooks/useComments.js</files>
  <action>
**Update CommentsBottomSheet state:**
```javascript
const [replyingTo, setReplyingTo] = useState(null); // Comment object being replied to
```

**Pass to CommentRow:**

```javascript
onReply={(comment) => {
  setReplyingTo(comment);
  // Focus the input
  inputRef.current?.focus();
}}
```

**Pass to CommentInput:**

```javascript
replyingTo={replyingTo}
onCancelReply={() => setReplyingTo(null)}
```

**CommentInput already has replyingTo handling** (from Plan 02):

- Shows "Replying to @{username}" banner when replyingTo is set
- X button to cancel
- Clear replyingTo after successful submit

**Update addComment call in useComments:**

```javascript
const addComment = async (text, mediaUrl = null, mediaType = null) => {
  const parentId = replyingTo?.id || null;
  const result = await commentService.addComment(
    photoId,
    currentUserId,
    text,
    mediaUrl,
    mediaType,
    parentId // Pass parentId for replies
  );

  if (result.success) {
    setReplyingTo(null); // Clear reply state
    // Comment will appear via subscription
  }
  return result;
};
```

**CommentRow Reply button:**

- Only show Reply button on top-level comments (where parentId === null)
- Tapping Reply triggers onReply callback with the comment object
- Input focuses and shows "Replying to @{username}" banner
  </action>
  <verify>
  Tap "Reply" on a top-level comment. Verify:

1. Input shows "Replying to @username" banner
2. Keyboard appears and input is focused
3. Cancel (X) clears the reply state
4. Submitting creates a comment with parentId set
   </verify>
   <done>

- replyingTo state managed in CommentsBottomSheet
- Reply button on top-level comments triggers reply mode
- CommentInput shows reply banner with cancel option
- addComment passes parentId for replies
- Reply state cleared after successful submit
  </done>
  </task>

<task type="auto">
  <name>Task 2: Display threaded replies with visual nesting</name>
  <files>src/components/comments/CommentsBottomSheet.js, src/components/comments/CommentRow.js, src/hooks/useComments.js</files>
  <action>
**Update useComments.js to organize comments:**

```javascript
// Organize comments into threaded structure
const organizeComments = flatComments => {
  const topLevel = flatComments.filter(c => !c.parentId);
  const replies = flatComments.filter(c => c.parentId);

  // Group replies by parent
  const repliesByParent = {};
  replies.forEach(reply => {
    if (!repliesByParent[reply.parentId]) {
      repliesByParent[reply.parentId] = [];
    }
    repliesByParent[reply.parentId].push(reply);
  });

  // Sort replies by createdAt
  Object.keys(repliesByParent).forEach(parentId => {
    repliesByParent[parentId].sort((a, b) => a.createdAt?.toMillis() - b.createdAt?.toMillis());
  });

  return { topLevel, repliesByParent };
};
```

**Return from useComments:**

```javascript
return {
  topLevelComments, // Array of top-level comments
  repliesByParent, // { [parentId]: Comment[] }
  // ... other existing returns
};
```

**Update CommentsBottomSheet FlatList:**

```javascript
const renderComment = ({ item: comment }) => {
  const replies = repliesByParent[comment.id] || [];
  const hasReplies = replies.length > 0;
  const [showReplies, setShowReplies] = useState(false);

  return (
    <View>
      {/* Top-level comment */}
      <CommentRow
        comment={comment}
        user={comment.user}
        onReply={() => handleReply(comment)}
        onLike={() => toggleLike(comment.id)}
        onDelete={() => handleDelete(comment.id)}
        canDelete={canDelete(comment)}
        isOwnerComment={comment.userId === photoOwnerId}
        isLiked={userLikes[comment.id]}
        isTopLevel={true}
      />

      {/* Replies section */}
      {hasReplies && (
        <View style={styles.repliesSection}>
          {/* Show/hide toggle */}
          <TouchableOpacity onPress={() => setShowReplies(!showReplies)}>
            <Text style={styles.viewRepliesText}>
              {showReplies ? 'Hide replies' : `View ${replies.length} ${replies.length === 1 ? 'reply' : 'replies'}`}
            </Text>
          </TouchableOpacity>

          {/* Replies (when expanded) */}
          {showReplies && replies.map(reply => (
            <View key={reply.id} style={styles.replyContainer}>
              <CommentRow
                comment={reply}
                user={reply.user}
                onReply={null}  // No reply on replies (one level only)
                onLike={() => toggleLike(reply.id)}
                onDelete={() => handleDelete(reply.id)}
                canDelete={canDelete(reply)}
                isOwnerComment={reply.userId === photoOwnerId}
                isLiked={userLikes[reply.id]}
                isTopLevel={false}
              />
            </View>
          ))}
        </View>
      )}
    </View>
  );
};

// Use topLevelComments for FlatList data
<FlatList
  data={topLevelComments}
  renderItem={renderComment}
  keyExtractor={item => item.id}
  ...
/>
```

**Styles for replies:**

```javascript
repliesSection: {
  marginLeft: 48,  // Indent to align with comment text (past profile pic)
  borderLeftWidth: 1,
  borderLeftColor: 'rgba(255,255,255,0.1)',
  paddingLeft: 12,
},
replyContainer: {
  marginTop: 8,
},
viewRepliesText: {
  color: 'rgba(255,255,255,0.6)',
  fontSize: 13,
  marginTop: 4,
  marginBottom: 8,
},
```

**CommentRow changes:**

- Add `isTopLevel` prop
- Only show Reply button when isTopLevel === true
- Slightly smaller styling for replies (optional: smaller font, tighter padding)
  </action>
  <verify>
  Add a reply to a comment. Verify:

1. "View 1 reply" link appears below parent comment
2. Tapping expands to show the reply indented
3. Reply doesn't have a Reply button (one level only)
4. "Hide replies" collapses the section
5. Multiple replies stack vertically when expanded
   </verify>
   <done>

- Comments organized into topLevel and repliesByParent structure
- "View X replies" toggle expands/collapses reply section
- Replies visually indented with left border
- Reply button hidden on replies (one-level threading)
- Replies sorted by createdAt ascending
- Clean visual hierarchy with proper indentation
  </done>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Reply button appears only on top-level comments
- [ ] Tapping Reply focuses input with "Replying to" banner
- [ ] Cancel clears reply state
- [ ] Submitting reply creates comment with parentId
- [ ] Replies grouped under parent with expand/collapse
- [ ] Visual nesting makes thread structure clear
</verification>

<success_criteria>

- One-level reply threading works as designed
- Reply button only on top-level comments
- "Replying to @username" banner shows when replying
- Replies visually nested under parent (indented)
- "View X replies" expand/collapse toggle
- Reply button hidden on replies (prevents deeper nesting)
- Threaded structure clear and intuitive
  </success_criteria>

<output>
After completion, create `.planning/phases/36-comments-feature/36-05-SUMMARY.md`
</output>
