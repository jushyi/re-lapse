---
phase: 36-comments-feature
plan: 06
type: execute
---

<objective>
Add comment notifications and media comments (images + GIFs).

Purpose: Notify photo owners when someone comments on their photo, and enable users to attach images from camera roll OR GIFs via Giphy to comments.
Output: Cloud Function for comment notifications, image picker + Giphy SDK integration in CommentInput, media display in comments.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/36-comments-feature/36-CONTEXT.md
@.planning/phases/36-comments-feature/36-RESEARCH.md

**Key source files:**
@functions/index.js
@src/components/comments/CommentInput.js
@src/components/comments/CommentRow.js
@src/services/firebase/commentService.js

**Existing notification patterns:**

- Cloud Functions triggered by Firestore onCreate/onUpdate
- Fetch recipient's fcmToken from users collection
- Send via Expo Push API
- Deep linking to relevant screen

**From RESEARCH.md:**

- expo-image-picker already installed
- @giphy/react-native-sdk for GIF picker (dev client available)
- Image/GIF comments shown as thumbnails (100x100 in comment)
- mediaType: 'image' | 'gif' | null
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Add comment notification Cloud Function</name>
  <files>functions/index.js</files>
  <action>
**Add new Cloud Function for comment notifications:**

```javascript
// Send notification when someone comments on a photo
exports.sendCommentNotification = functions.firestore
  .document('photos/{photoId}/comments/{commentId}')
  .onCreate(async (snap, context) => {
    const { photoId, commentId } = context.params;
    const comment = snap.data();

    // Don't notify for replies (optional: or notify parent comment author)
    // For now, only notify photo owner
    if (comment.parentId) {
      // Could add: notify parent comment author about reply
      logger.info('Skipping notification for reply', { commentId });
      return null;
    }

    try {
      // Get photo to find owner
      const photoDoc = await admin.firestore().collection('photos').doc(photoId).get();

      if (!photoDoc.exists) {
        logger.warn('Photo not found for comment notification', { photoId });
        return null;
      }

      const photo = photoDoc.data();
      const photoOwnerId = photo.userId;

      // Don't notify if commenter is the photo owner
      if (comment.userId === photoOwnerId) {
        logger.info('Skipping self-comment notification', { photoId, commentId });
        return null;
      }

      // Get photo owner's FCM token
      const ownerDoc = await admin.firestore().collection('users').doc(photoOwnerId).get();

      if (!ownerDoc.exists || !ownerDoc.data().fcmToken) {
        logger.warn('No FCM token for photo owner', { photoOwnerId });
        return null;
      }

      // Get commenter's name for notification
      const commenterDoc = await admin.firestore().collection('users').doc(comment.userId).get();

      const commenterName = commenterDoc.exists
        ? commenterDoc.data().displayName || 'Someone'
        : 'Someone';

      // Truncate comment text for notification
      let commentPreview;
      if (comment.text) {
        commentPreview = comment.text.substring(0, 50) + (comment.text.length > 50 ? '...' : '');
      } else if (comment.mediaType === 'gif') {
        commentPreview = 'sent a GIF';
      } else if (comment.mediaType === 'image') {
        commentPreview = 'sent a photo';
      } else {
        commentPreview = 'commented';
      }

      // Send notification via Expo
      const message = {
        to: ownerDoc.data().fcmToken,
        sound: 'default',
        title: 'ðŸ’¬ New Comment',
        body: `${commenterName}: ${commentPreview}`,
        data: {
          type: 'comment',
          photoId,
          commentId,
          screen: 'Feed', // Deep link to feed (will open photo modal)
        },
      };

      const response = await fetch('https://exp.host/--/api/v2/push/send', {
        method: 'POST',
        headers: {
          Accept: 'application/json',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(message),
      });

      if (!response.ok) {
        throw new Error(`Expo push failed: ${response.status}`);
      }

      logger.info('Comment notification sent', {
        photoId,
        commentId,
        to: photoOwnerId,
      });

      return { success: true };
    } catch (error) {
      logger.error('Failed to send comment notification', {
        error: error.message,
        photoId,
        commentId,
      });
      return null;
    }
  });
```

**Deploy:**

```bash
cd functions && npm run deploy
# Or: firebase deploy --only functions
```

  </action>
  <verify>
After deploying:
1. Have User A post a photo to journal
2. Have User B add a comment
3. Verify User A receives notification "ðŸ’¬ New Comment - UserB: comment text..."
  </verify>
  <done>
- sendCommentNotification Cloud Function created
- Triggers on photos/{photoId}/comments/{commentId} onCreate
- Skips self-comments and replies (only top-level to photo owner)
- Handles text, image, and GIF comment preview messages
- Function deployed successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Add image picker to CommentInput</name>
  <files>src/components/comments/CommentInput.js, src/services/firebase/commentService.js</files>
  <action>
**Update CommentInput.js:**

```javascript
import * as ImagePicker from 'expo-image-picker';
import { Image } from 'expo-image';

// Add state for selected media
const [selectedMedia, setSelectedMedia] = useState(null); // { uri, type: 'image' | 'gif' }

// Image picker handler
const handleImagePick = async () => {
  // Request permission
  const permissionResult = await ImagePicker.requestMediaLibraryPermissionsAsync();

  if (!permissionResult.granted) {
    Alert.alert('Permission Required', 'Please grant camera roll access to attach images.');
    return;
  }

  const result = await ImagePicker.launchImageLibraryAsync({
    mediaTypes: ImagePicker.MediaTypeOptions.Images,
    allowsEditing: true,
    aspect: [1, 1], // Square crop for thumbnails
    quality: 0.8,
  });

  if (!result.canceled && result.assets[0]) {
    setSelectedMedia({ uri: result.assets[0].uri, type: 'image' });
  }
};

// Clear media on cancel or after submit
const clearMedia = () => setSelectedMedia(null);

// Update submit handler
const handleSubmit = async () => {
  if (!text.trim() && !selectedMedia) return;

  let mediaUrl = null;
  let mediaType = null;

  if (selectedMedia) {
    if (selectedMedia.type === 'image') {
      // Upload image to Firebase Storage
      mediaUrl = await uploadCommentImage(selectedMedia.uri);
      mediaType = 'image';
    } else if (selectedMedia.type === 'gif') {
      // GIF URL is already a remote URL from Giphy
      mediaUrl = selectedMedia.uri;
      mediaType = 'gif';
    }
  }

  await onSubmit(text, mediaUrl, mediaType);
  setText('');
  clearMedia();
};
```

**Add image upload function to commentService.js:**

```javascript
import { getStorage, ref, uploadBytes, getDownloadURL } from 'firebase/storage';

export const uploadCommentImage = async localUri => {
  try {
    const storage = getStorage();
    const filename = `comment-images/${Date.now()}-${Math.random().toString(36).substr(2, 9)}.jpg`;
    const storageRef = ref(storage, filename);

    // Fetch the image as blob
    const response = await fetch(localUri);
    const blob = await response.blob();

    // Upload
    await uploadBytes(storageRef, blob);

    // Get download URL
    const downloadURL = await getDownloadURL(storageRef);
    return downloadURL;
  } catch (error) {
    logger.error('CommentService.uploadCommentImage: Failed', { error: error.message });
    throw error;
  }
};
```

**Update layout to show media preview:**

```javascript
{
  /* Media preview (above input row) */
}
{
  selectedMedia && (
    <View style={styles.mediaPreviewContainer}>
      <Image source={{ uri: selectedMedia.uri }} style={styles.mediaPreview} />
      <TouchableOpacity onPress={clearMedia} style={styles.removeMediaButton}>
        <Ionicons name="close-circle" size={24} color="white" />
      </TouchableOpacity>
      {selectedMedia.type === 'gif' && (
        <View style={styles.gifBadge}>
          <Text style={styles.gifBadgeText}>GIF</Text>
        </View>
      )}
    </View>
  );
}
```

**Styles:**

```javascript
mediaPreviewContainer: {
  position: 'relative',
  marginBottom: 8,
},
mediaPreview: {
  width: 80,
  height: 80,
  borderRadius: 8,
},
removeMediaButton: {
  position: 'absolute',
  top: -8,
  right: -8,
},
gifBadge: {
  position: 'absolute',
  bottom: 4,
  left: 4,
  backgroundColor: 'rgba(0,0,0,0.7)',
  paddingHorizontal: 4,
  paddingVertical: 2,
  borderRadius: 4,
},
gifBadgeText: {
  color: 'white',
  fontSize: 10,
  fontWeight: 'bold',
},
```

  </action>
  <verify>
In CommentsBottomSheet:
1. Tap camera/image icon in input
2. Verify permission prompt appears (first time)
3. Select an image from camera roll
4. Verify preview appears above input with X to remove
5. Submit comment with image
6. Verify image uploads and displays in comment thread
  </verify>
  <done>
- Image picker integrated using expo-image-picker
- Camera icon in CommentInput triggers picker
- Selected media preview with remove button
- Image uploaded to Firebase Storage on submit
- State supports both image and gif types (for Task 3)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Giphy SDK for GIF comments</name>
  <files>src/components/comments/CommentInput.js, src/components/comments/GifPicker.js, app.json</files>
  <action>
**Install Giphy SDK:**
```bash
npx expo install @giphy/react-native-sdk
```

**Configure in app.json** (if not already):
Add to plugins array if needed. The SDK should work with dev client.

**Create GifPicker.js component:**

File: src/components/comments/GifPicker.js

```javascript
import React, { useEffect } from 'react';
import { GiphyDialog, GiphyDialogEvent, GiphySDK, GiphyContentType } from '@giphy/react-native-sdk';

// Initialize SDK once (call in App.js or at top level)
// Get API key from https://developers.giphy.com/
export const initializeGiphy = apiKey => {
  GiphySDK.configure({ apiKey });
};

// Open the GIF picker dialog
export const openGifPicker = () => {
  GiphyDialog.configure({
    mediaTypeConfig: [GiphyContentType.Gif, GiphyContentType.Sticker],
    showConfirmationScreen: false,
  });
  GiphyDialog.show();
};

// Hook to handle GIF selection
export const useGifSelection = onGifSelected => {
  useEffect(() => {
    const listener = GiphyDialog.addListener(GiphyDialogEvent.MediaSelected, event => {
      // Get the GIF URL (use the fixed_height or downsized version for comments)
      const gifUrl = event.media.url || event.media.images?.fixed_height?.url;
      if (gifUrl && onGifSelected) {
        onGifSelected(gifUrl);
      }
      GiphyDialog.hide();
    });

    return () => {
      listener.remove();
    };
  }, [onGifSelected]);
};
```

**Initialize Giphy in App.js:**

```javascript
import { initializeGiphy } from './src/components/comments/GifPicker';

// In App.js, after other initializations
// TODO: Move API key to environment variable
initializeGiphy('YOUR_GIPHY_API_KEY');
```

**Note:** Get a Giphy API key from https://developers.giphy.com/ (free tier available).

**Update CommentInput.js to add GIF button:**

```javascript
import { openGifPicker, useGifSelection } from './GifPicker';

// In component:
// Handle GIF selection
const handleGifSelected = (gifUrl) => {
  setSelectedMedia({ uri: gifUrl, type: 'gif' });
};

useGifSelection(handleGifSelected);

// Add GIF button next to image button in input row
<View style={styles.inputRow}>
  <TextInput ... />
  <TouchableOpacity onPress={handleImagePick} style={styles.mediaButton}>
    <Ionicons name="image-outline" size={22} color="rgba(255,255,255,0.7)" />
  </TouchableOpacity>
  <TouchableOpacity onPress={openGifPicker} style={styles.mediaButton}>
    <Text style={styles.gifButtonText}>GIF</Text>
  </TouchableOpacity>
  <TouchableOpacity onPress={handleSubmit} disabled={!canSubmit}>
    <Ionicons name="send" size={22} color={canSubmit ? '#007AFF' : 'rgba(255,255,255,0.3)'} />
  </TouchableOpacity>
</View>
```

**Styles for GIF button:**

```javascript
gifButtonText: {
  color: 'rgba(255,255,255,0.7)',
  fontSize: 12,
  fontWeight: 'bold',
  borderWidth: 1,
  borderColor: 'rgba(255,255,255,0.3)',
  borderRadius: 4,
  paddingHorizontal: 6,
  paddingVertical: 2,
},
```

**Update CommentRow.js for GIF display:**
GIFs use expo-image which handles animated GIFs automatically:

```javascript
{
  comment.mediaUrl && (
    <TouchableOpacity onPress={() => openFullMedia(comment.mediaUrl, comment.mediaType)}>
      <Image
        source={{ uri: comment.mediaUrl }}
        style={styles.commentMedia}
        contentFit="cover"
        // expo-image handles GIF animation automatically
      />
      {comment.mediaType === 'gif' && (
        <View style={styles.gifIndicator}>
          <Text style={styles.gifIndicatorText}>GIF</Text>
        </View>
      )}
    </TouchableOpacity>
  );
}
```

  </action>
  <verify>
1. Tap GIF button in comment input
2. Verify Giphy dialog opens with search and trending GIFs
3. Select a GIF
4. Verify GIF preview appears in input with "GIF" badge
5. Submit comment
6. Verify GIF plays/animates in comment thread
  </verify>
  <done>
- @giphy/react-native-sdk installed
- GifPicker.js helper with SDK init and selection hook
- GIF button added to CommentInput (next to image button)
- Giphy dialog opens for GIF search/selection
- GIF URL stored directly (no upload needed - Giphy hosted)
- GIFs display and animate in comment thread via expo-image
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Comment notifications, image comments, and GIF comments</what-built>
  <how-to-verify>
**Test notifications (requires two accounts):**
1. Deploy functions: `cd functions && npm run deploy`
2. On Device A (User A): Post a photo and journal it
3. On Device B (User B): Find User A's photo in feed, add a comment
4. Verify: User A receives push notification "ðŸ’¬ New Comment - UserB: comment text..."
5. Tap notification on Device A, verify app opens to Feed

**Test image comments:**

1. Open any photo modal, tap "Add a comment..."
2. Tap image icon in comment input
3. Grant camera roll permission if prompted
4. Select an image
5. Verify: Preview appears with X button
6. Submit comment
7. Verify: Comment appears with image thumbnail

**Test GIF comments:**

1. Tap GIF button in comment input
2. Verify: Giphy dialog opens with trending/search
3. Search for a GIF (e.g., "thumbs up")
4. Select a GIF
5. Verify: GIF preview appears with "GIF" badge
6. Submit comment
7. Verify: GIF plays/animates in comment thread
8. Close and reopen comments, verify GIF still animates
   </how-to-verify>
   <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
   </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] sendCommentNotification Cloud Function deployed
- [ ] Notifications sent for new comments (not self-comments)
- [ ] Image picker opens and allows selection
- [ ] Image uploads to Storage and displays in comments
- [ ] Giphy SDK initialized and dialog opens
- [ ] GIF selection works and displays animated in thread
</verification>

<success_criteria>

- Comment notifications work for top-level comments to photo owner
- Self-comments don't trigger notifications
- Notification includes appropriate preview (text, "sent a GIF", "sent a photo")
- Image picker integration with permission handling
- GIF picker via @giphy/react-native-sdk
- Both image and GIF previews in input with remove capability
- Images uploaded to Storage, GIFs use Giphy URL directly
- Media comments display properly (images static, GIFs animated)
  </success_criteria>

<output>
After completion, create `.planning/phases/36-comments-feature/36-06-SUMMARY.md`
</output>
