---
phase: 36-comments-feature
plan: 03-FIX
type: fix
---

<objective>
Fix UAT issues from plan 36-03 (Round 2).

Source: 36-03-ISSUES.md
Priority: 1 Blocker, 2 Major, 3 Minor

**Round 1 (Resolved):** UAT-001 through UAT-008 - all fixed

**Round 2 (Current):**

- **UAT-009 (BLOCKER):** CommentsBottomSheet cannot be closed - keeps reopening
- **UAT-013 (Major):** Keyboard covers comment input when typing
- **UAT-014 (Major):** Comment tap doesn't open sheet in feed mode (only stories work)
- UAT-010: Comment input clips into bottom safe area
- UAT-011: Comment preview still misaligned with username
- UAT-012: Show single rotating comment preview instead of multiple
  </objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/36-comments-feature/36-03-ISSUES.md

**Original plan for reference:**
@.planning/phases/36-comments-feature/36-03-PLAN.md

**Key source files:**
@src/components/PhotoDetailModal.js
@src/hooks/usePhotoDetailModal.js
@src/styles/PhotoDetailModal.styles.js
@src/components/comments/CommentsBottomSheet.js
@src/components/comments/CommentInput.js
@src/components/comments/CommentPreview.js
@src/components/FeedPhotoCard.js
@src/hooks/useComments.js
@src/services/firebase/commentService.js
@firestore.indexes.json
</context>

<tasks>

<!-- ====== ROUND 2 FIXES (New Issues from UAT) ====== -->

<task type="auto">
  <name>Task R2-1: Fix UAT-009 - CommentsBottomSheet cannot be closed (BLOCKER)</name>
  <files>src/components/PhotoDetailModal.js</files>
  <action>
**Root cause:** In PhotoDetailModal.js lines 85-91, the useEffect resets `showComments` to `initialShowComments` on every re-render when any dependency changes. If `initialShowComments` is true (from feed card comment tap), this keeps reopening the sheet.

**Fix:** Only apply `initialShowComments` when the modal FIRST becomes visible (false -> true transition), not on subsequent re-renders.

**Implementation:**

1. Add a ref to track previous visibility: `const wasVisible = useRef(false)`
2. Modify the useEffect to only set showComments when transitioning from invisible to visible
3. Update wasVisible.current at end of effect

**Code pattern:**

```javascript
const wasVisible = useRef(false);

useEffect(() => {
  if (visible && !wasVisible.current) {
    // Only on initial open (false -> true transition)
    cubeRotation.setValue(0);
    setIsTransitioning(false);
    setShowComments(initialShowComments);
  } else if (!visible) {
    // Reset on close
    setIsTransitioning(false);
  }
  wasVisible.current = visible;
}, [visible, initialShowComments]);
```

Remove `photos` from dependency array as it's not needed for this logic.
</action>
<verify>

1. Open photo from feed, tap comment area to open CommentsBottomSheet
2. Try closing via: swipe down, tap backdrop, close button
3. All methods should successfully close the sheet
4. Open from feed card comment preview - should open then close correctly
   </verify>
   <done>CommentsBottomSheet closes on all close attempts without reopening</done>
   </task>

<task type="auto">
  <name>Task R2-2: Fix UAT-010 - Comment input clips into bottom safe area</name>
  <files>src/components/comments/CommentsBottomSheet.js, src/styles/CommentsBottomSheet.styles.js</files>
  <action>
**Issue:** The CommentInput at the bottom of CommentsBottomSheet clips into the device's bottom safe area (home indicator region on notched iPhones).

**Fix:** Use useSafeAreaInsets() to add proper bottom padding around CommentInput.

**Implementation in CommentsBottomSheet.js:**

1. Import useSafeAreaInsets from react-native-safe-area-context
2. Get insets at top of component: `const insets = useSafeAreaInsets()`
3. Wrap CommentInput in a View with paddingBottom: Math.max(insets.bottom, 8)

**Code:**

```javascript
import { useSafeAreaInsets } from 'react-native-safe-area-context';

// In component:
const insets = useSafeAreaInsets();

// Around CommentInput:
<View style={{ paddingBottom: Math.max(insets.bottom, 8) }}>
  <CommentInput ... />
</View>
```

Also verify send button vertical alignment in CommentInput - should be centered with the input field.
</action>
<verify>

1. Open CommentsBottomSheet on device with notch/home indicator
2. Verify comment input and send button are above the safe area
3. Send button should be vertically centered with input field
   </verify>
   <done>Comment input respects safe area, send button vertically aligned</done>
   </task>

<task type="auto">
  <name>Task R2-3: Fix UAT-013 - Keyboard covers comment input (MAJOR)</name>
  <files>src/components/comments/CommentsBottomSheet.js, src/styles/CommentsBottomSheet.styles.js</files>
  <action>
**Issue:** When keyboard opens, it covers the comment input area. The KeyboardAvoidingView in CommentsBottomSheet isn't working properly.

**Root cause analysis:**
Looking at CommentsBottomSheet.js lines 298-302, there's already a KeyboardAvoidingView but:

1. `keyboardAvoidContainer` has `maxHeight: SHEET_HEIGHT` which may restrict upward movement
2. The `keyboardVerticalOffset` may be incorrect
3. The KeyboardAvoidingView might need to wrap the entire sheet content, not just part of it

**Fix options (try in order):**

**Option 1: Adjust KeyboardAvoidingView configuration**

```javascript
<KeyboardAvoidingView
  behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
  style={styles.keyboardAvoidContainer}
  keyboardVerticalOffset={Platform.OS === 'ios' ? 60 : 20}
>
```

**Option 2: Remove maxHeight constraint when keyboard is open**
Use Keyboard.addListener to detect keyboard show/hide and dynamically adjust maxHeight:

```javascript
import { Keyboard } from 'react-native';

const [keyboardVisible, setKeyboardVisible] = useState(false);

useEffect(() => {
  const showSub = Keyboard.addListener('keyboardWillShow', () => setKeyboardVisible(true));
  const hideSub = Keyboard.addListener('keyboardWillHide', () => setKeyboardVisible(false));
  return () => {
    showSub.remove();
    hideSub.remove();
  };
}, []);

// In styles, remove maxHeight when keyboard is visible
style={[styles.keyboardAvoidContainer, keyboardVisible && { maxHeight: undefined }]}
```

**Option 3: Use react-native-keyboard-aware-scroll-view**
Replace KeyboardAvoidingView with KeyboardAwareScrollView for better handling.

**Recommended approach:** Start with Option 1 (adjust offset), if that doesn't work try Option 2 (dynamic maxHeight).
</action>
<verify>

1. Open CommentsBottomSheet
2. Tap input field to open keyboard
3. Verify: Input field and send button are visible ABOVE the keyboard
4. Type a message - should be able to see what you're typing
5. Submit comment - should work normally
   </verify>
   <done>Comment input stays visible above keyboard when typing</done>
   </task>

<task type="auto">
  <name>Task R2-4: Fix UAT-014 - Comment tap doesn't open sheet in feed mode (MAJOR)</name>
  <files>src/components/PhotoDetailModal.js, src/screens/FeedScreen.js</files>
  <action>
**Issue:** Tapping the comment area in PhotoDetailModal footer doesn't open CommentsBottomSheet when in feed mode, but works in stories mode.

**Debug approach:**

1. Check if the TouchableOpacity on line 342-353 is receiving touches in feed mode
2. Check if `setShowComments(true)` is being called
3. Check if something in feed mode is blocking the touch (e.g., panResponder)

**Likely causes:**

1. The panResponder on the Animated.View (line 239) might be capturing all touches in feed mode
2. Different gesture handling between feed and stories modes
3. The footer touch area might be outside the touchable region

**Investigation:**
Add console.log to the onPress handler:

```javascript
<TouchableOpacity
  style={styles.commentInputTrigger}
  onPress={() => {
    console.log('Comment trigger pressed, mode:', mode);
    setShowComments(true);
  }}
```

**Potential fixes:**

**Option 1: Exclude footer from panResponder**
The panResponder for swipe-to-dismiss might be capturing touches meant for the footer. Check if footer needs to be outside the panResponder area or use `onMoveShouldSetPanResponder` to exclude footer region.

**Option 2: Different touch handling for feed mode**
If panResponder is only needed for swipe gesture, it might be interfering with button taps. Consider:

- Using `onStartShouldSetPanResponder: () => false` for tap events
- Or checking the touch location before capturing

**Option 3: Check z-index/positioning**
Ensure the footer TouchableOpacity is not being overlapped by another view.

**Implement the fix based on investigation findings.**
</action>
<verify>

1. Open a photo from the Feed (feed mode)
2. Tap the comment area in the footer
3. Verify: CommentsBottomSheet opens
4. Also verify stories mode still works
   </verify>
   <done>Comment tap opens CommentsBottomSheet in both feed and stories modes</done>
   </task>

<task type="auto">
  <name>Task R2-5: Fix UAT-011 - Comment preview misaligned with username</name>
  <files>src/styles/PhotoDetailModal.styles.js</files>
  <action>
**Issue:** The comment preview container has `left: 16` but userInfoOverlay has `left: 24`. They should match.

**Fix:** Change userInfoOverlay's left value from 24 to 16 to align with the comment preview (user prefers 16px margin).

**Code change in PhotoDetailModal.styles.js:**

```javascript
userInfoOverlay: {
  position: 'absolute',
  bottom: 140,
  left: 16,  // Changed from 24 to match commentPreviewContainer
  flexDirection: 'row',
  alignItems: 'center',
  gap: 8,
},
```

Also update profilePicContainer.left from 24 to 16 to keep profile photo aligned with username.
</action>
<verify>

1. Open photo modal with comments
2. Verify comment preview left edge aligns with username left edge
3. Verify profile photo is still properly positioned relative to username
   </verify>
   <done>Comment preview aligns with username (both at left: 16)</done>
   </task>

<task type="auto">
  <name>Task R2-6: Fix UAT-012 - Single rotating comment preview</name>
  <files>src/components/comments/CommentPreview.js</files>
  <action>
**User request:** Show only one comment at a time and rotate through comments if there are multiple.

**Implementation:**

1. Add useState for currentIndex (0)
2. Add useRef for fade animation
3. Add useEffect with setInterval to rotate comments every 4 seconds
4. Only display comments[currentIndex] instead of mapping all comments
5. Add subtle fade animation for transition

**Code pattern:**

```javascript
import { useState, useRef, useEffect } from 'react';
import { Animated } from 'react-native';

const CommentPreview = ({ comments = [], totalCount = 0, onPress, compact = false }) => {
  const [currentIndex, setCurrentIndex] = useState(0);
  const fadeAnim = useRef(new Animated.Value(1)).current;

  // Rotate comments every 4 seconds with fade animation
  useEffect(() => {
    if (comments.length <= 1) return;

    const interval = setInterval(() => {
      // Fade out
      Animated.timing(fadeAnim, {
        toValue: 0,
        duration: 200,
        useNativeDriver: true,
      }).start(() => {
        // Change index
        setCurrentIndex(prev => (prev + 1) % comments.length);
        // Fade in
        Animated.timing(fadeAnim, {
          toValue: 1,
          duration: 200,
          useNativeDriver: true,
        }).start();
      });
    }, 4000);

    return () => clearInterval(interval);
  }, [comments.length, fadeAnim]);

  // Reset index when comments change
  useEffect(() => {
    setCurrentIndex(0);
    fadeAnim.setValue(1);
  }, [comments]);

  // ... rest of component

  // Render only current comment with fade
  const currentComment = comments[currentIndex];

  return (
    <TouchableOpacity ...>
      <Animated.View style={{ opacity: fadeAnim }}>
        <View style={styles.commentRow}>
          <Text style={styles.commentText} numberOfLines={compact ? 1 : 2}>
            <Text style={styles.username}>{currentComment?.user?.displayName || 'User'} </Text>
            <Text>{currentComment?.text}</Text>
          </Text>
        </View>
      </Animated.View>

      {hasMoreComments && <Text style={styles.viewAllText}>View all {totalCount} comments</Text>}
    </TouchableOpacity>
  );
};
```

  </action>
  <verify>
1. Open photo modal with multiple comments
2. Verify only one comment shows at a time
3. Wait ~4-5 seconds, verify comment rotates to next
4. Verify smooth fade transition between comments
  </verify>
  <done>Single rotating comment preview with 4-second interval and fade transition</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Round 2 fixes:
- UAT-009: Fixed CommentsBottomSheet closing issue (BLOCKER)
- UAT-013: Fixed keyboard covering comment input (MAJOR)
- UAT-014: Fixed comment tap not working in feed mode (MAJOR)
- UAT-010: Fixed safe area clipping for comment input
- UAT-011: Fixed comment preview alignment
- UAT-012: Implemented single rotating comment preview
  </what-built>
  <how-to-verify>
1. Start the app: `npx expo start`
2. Navigate to Feed

**Test UAT-009 (Blocker - sheet won't close):** 3. Tap on a photo to open modal 4. Tap comment area to open CommentsBottomSheet 5. Try ALL close methods:

- Swipe down on sheet
- Tap the backdrop (dark area above sheet)
- Tap the X close button

6. Each method should close the sheet and it should STAY closed

**Test UAT-014 (Major - feed mode comment tap):** 7. Close everything, go back to Feed 8. Tap a photo to open modal (feed mode) 9. Tap the comment area in footer 10. Verify: CommentsBottomSheet opens (was broken before)

**Test UAT-013 (Major - keyboard covers input):** 11. With CommentsBottomSheet open, tap the input field 12. Verify: Keyboard appears and input/send button are ABOVE the keyboard 13. Type a message - should be visible while typing

**Test UAT-010 (Safe area fix):** 14. Verify input area is above home indicator (safe area respected)

**Test UAT-011 (Alignment fix):** 15. Close comments sheet, look at comment preview 16. Verify preview text aligns with username above it

**Test UAT-012 (Rotating preview):** 17. Find/use a photo with multiple comments 18. Watch the comment preview for ~10 seconds 19. Verify it shows one comment at a time and rotates with fade
</how-to-verify>
<resume-signal>Type "approved" or describe any remaining issues</resume-signal>
</task>

<!-- ====== ROUND 1 FIXES (Previously Resolved) ====== -->

<task type="auto">
  <name>Task 1: Fix UAT-002 - Comment not appearing in list after submitting</name>
  <files>src/hooks/useComments.js, src/components/comments/CommentsBottomSheet.js, src/services/firebase/commentService.js</files>
  <action>
**Investigate and fix why new comments don't appear in the list:**

Likely causes:

1. Real-time subscription not set up correctly
2. Optimistic UI update missing
3. Comment being added to different collection/path than subscription is watching

**Debug steps:**

1. Check commentService.subscribeToComments - verify it's watching the correct path: `photos/{photoId}/comments`
2. Check useComments hook - verify subscription is active and updating state
3. Check addComment - verify it writes to the same path the subscription watches

**Implementation:**

1. In useComments.js, ensure subscribeToComments is called on mount and cleans up on unmount
2. Verify the onSnapshot callback properly updates the comments array state
3. Add optimistic update: append new comment to state immediately after addComment succeeds
4. Ensure Firestore subcollection path matches between write and read

**If subscription works but needs refresh:**

- After addComment completes, manually trigger a refresh of the comments list
- Or ensure the subscription is receiving the update (check Firestore rules allow reading)

**Note:** Do NOT rely solely on optimistic updates - the subscription should work. But optimistic update improves UX.
</action>
<verify>
Open CommentsBottomSheet, type a comment, submit. Comment should appear in the list immediately (or within 1-2 seconds via subscription).
</verify>
<done>

- Comments appear in list after submitting
- Real-time subscription working correctly
- Optimistic UI update for instant feedback
  </done>
  </task>

<task type="auto">
  <name>Task 2: Fix UAT-003 + UAT-007 + UAT-008 - Bottom sheet UX improvements</name>
  <files>src/components/comments/CommentsBottomSheet.js, src/components/comments/CommentInput.js</files>
  <action>
**Fix three related bottom sheet UX issues:**

**UAT-003: Sheet closes on comment send**

- Find where the sheet closes after sending
- Remove or disable the onClose call in the send handler
- Sheet should stay open to allow viewing/adding more comments

**UAT-007: Keyboard doesn't auto-open**

- Add autoFocus={true} to the TextInput in CommentInput.js
- Or use useRef + useEffect to focus the input when sheet becomes visible
- May need to delay focus slightly: `setTimeout(() => inputRef.current?.focus(), 300)`

**UAT-008: Poor empty state**

- Add consistent height to CommentsBottomSheet when empty
- Add empty state view: "No comments yet" centered text
- Set minHeight to ~50% of screen height (use Dimensions.get('window').height \* 0.5)

**Implementation details:**

In CommentsBottomSheet.js:

```javascript
// Set consistent height
const { height: screenHeight } = Dimensions.get('window');
const MIN_SHEET_HEIGHT = screenHeight * 0.5;

// Empty state
{
  comments.length === 0 && (
    <View style={styles.emptyState}>
      <Text style={styles.emptyStateText}>No comments yet</Text>
      <Text style={styles.emptyStateSubtext}>Be the first to comment</Text>
    </View>
  );
}
```

In CommentInput.js:

```javascript
const inputRef = useRef(null);

useEffect(() => {
  // Auto-focus when component mounts (sheet opened)
  const timer = setTimeout(() => {
    inputRef.current?.focus();
  }, 300); // Delay for sheet animation
  return () => clearTimeout(timer);
}, []);
```

For staying open after send - find the onSubmit/handleSend and remove any setShowComments(false) call.
</action>
<verify>

1. Open CommentsBottomSheet - keyboard should appear automatically
2. On empty photo - sheet should be ~50% height with "No comments yet" message
3. Submit a comment - sheet should stay open, not close
   </verify>
   <done>

- Sheet stays open after sending comment (UAT-003)
- Keyboard auto-opens when sheet appears (UAT-007)
- Empty state shows ~50% height with message (UAT-008)
  </done>
  </task>

<task type="auto">
  <name>Task 3: Fix UAT-005 - Feed card comment button doesn't open CommentsBottomSheet</name>
  <files>src/components/FeedPhotoCard.js, src/screens/FeedScreen.js</files>
  <action>
**Wire up comment button on feed cards to open PhotoDetailModal with comments visible:**

The feed card should have a comment button/icon that:

1. Opens the PhotoDetailModal
2. Automatically opens the CommentsBottomSheet

**Implementation:**

In FeedPhotoCard.js:

- Add onCommentsPress prop
- Render a comment icon/button (speech bubble)
- onPress calls onCommentsPress(photo)

In FeedScreen.js:

- Add handler: handleCommentsPress = (photo) => { ... }
- This handler should:
  1. Open PhotoDetailModal with the selected photo
  2. Signal that comments should auto-open

**Option A: Use navigation params**

```javascript
// FeedScreen
const handleCommentsPress = photo => {
  setSelectedPhoto(photo);
  setShowModal(true);
  setAutoOpenComments(true); // New state
};
```

Then pass autoOpenComments to PhotoDetailModal which triggers setShowComments(true) on mount.

**Option B: Direct callback**

```javascript
// Pass showComments setter to PhotoDetailModal
<PhotoDetailModal
  ...
  initialShowComments={autoOpenComments}
  onOpened={() => setAutoOpenComments(false)} // Reset
/>
```

In PhotoDetailModal, check initialShowComments prop in useEffect and open sheet if true.

**Also check:**

- Does CommentPreview's "View all X comments" link work?
- Does the preview in feed card respond to taps?
  </action>
  <verify>
  On Feed screen, tap the comment button on a feed card. PhotoDetailModal should open with CommentsBottomSheet already visible.
  </verify>
  <done>
- Comment button on feed cards triggers modal + comments sheet
- Tapping comment preview also opens comments
- "View all X comments" link works
  </done>
  </task>

<task type="auto">
  <name>Task 4: Fix UAT-001 + UAT-004 - Footer layout and preview overlap</name>
  <files>src/styles/PhotoDetailModal.styles.js, src/components/PhotoDetailModal.js, src/components/comments/CommentPreview.js</files>
  <action>
**Fix two layout issues:**

**UAT-001: Footer layout ~1/3 not 50/50**

In PhotoDetailModal.styles.js, ensure footer children have equal flex:

```javascript
footer: {
  flexDirection: 'row',
  alignItems: 'center',
  paddingHorizontal: 16,
  paddingVertical: 8,
},
commentInputTrigger: {
  flex: 1, // Equal flex
  // ... other styles
},
emojiPickerContainer: {
  flex: 1, // Equal flex (was probably missing or different)
  // ... other styles
},
```

Check if there's padding/margin causing the imbalance.

**UAT-004: Preview comments overlap with user's name**

In PhotoDetailModal.js, ensure CommentPreview is positioned correctly:

- Should be BELOW the userInfoOverlay
- Add proper marginTop to create spacing
- Check z-index if needed

Layout order should be:

1. Photo
2. User info (name + timestamp)
3. CommentPreview (with margin from user info)
4. Progress bar (stories mode)
5. Footer (comment input + emojis)

**In styles:**

```javascript
commentPreviewContainer: {
  marginTop: 8, // Space from user info
  marginBottom: 8, // Space before progress/footer
  paddingHorizontal: 16,
},
```

Ensure there's no absolute positioning causing overlap.
</action>
<verify>

1. Footer should be visually 50/50 split between comment trigger and emoji pills
2. Preview comments should appear below username with clear spacing, no overlap
   </verify>
   <done>

- Footer is 50/50 split (UAT-001)
- Preview comments properly positioned below user info (UAT-004)
- No layout overlaps
  </done>
  </task>

<task type="auto">
  <name>Task 5: Fix UAT-006 - Deploy Firestore composite index for comments</name>
  <files>firestore.indexes.json, src/services/firebase/commentService.js</files>
  <action>
**Deploy proper Firestore composite index instead of client-side filtering:**

**Step 1: Create/update firestore.indexes.json**

Add the composite index for the comments subcollection query:

```json
{
  "indexes": [
    {
      "collectionGroup": "comments",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "parentId", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    }
  ],
  "fieldOverrides": []
}
```

**Note:** The collectionGroup "comments" will apply to all photos/{photoId}/comments subcollections.

**Step 2: Deploy the index**

```bash
firebase deploy --only firestore:indexes
```

**Step 3: Revert client-side filtering in commentService.js**

In getPreviewComments, restore the proper query:

```javascript
const q = query(
  collection(db, 'photos', photoId, 'comments'),
  where('parentId', '==', null),
  orderBy('createdAt', 'desc'),
  limit(3)
);
```

Remove the client-side filter that was added as workaround.

**Step 4: Handle index building delay**

Composite indexes take time to build (minutes to hours for large collections).

- Keep a fallback to client-side filtering if query fails with "index not ready"
- Log a warning instead of error during transition period
- Once index is ready, the query will work server-side

**Alternative if index deployment is blocked:**
Document this as a production deployment task and keep client-side filtering for now, but clean up the error logging so it doesn't spam the console.
</action>
<verify>

1. Run firebase deploy --only firestore:indexes
2. Wait for index to build (check Firebase console)
3. Open a photo modal - no more ERROR in console for getPreviewComments
4. Preview comments load without errors
   </verify>
   <done>

- Firestore composite index deployed
- Query uses server-side filtering
- No more error logs for preview comments
- Client-side fallback for transition period (if needed)
  </done>
  </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixes for all 8 UAT issues from plan 36-03</what-built>
  <how-to-verify>
1. Run: npx expo start
2. Open the app on a test device

**Test UAT-001 (Footer layout):** 3. Open PhotoDetailModal on any photo 4. Verify: Footer is 50/50 split - comment area and emoji pills equal width

**Test UAT-002 (Comment appears in list):** 5. Open CommentsBottomSheet 6. Type and submit a comment 7. Verify: Comment appears in list immediately

**Test UAT-003 (Sheet stays open):** 8. After submitting comment, verify sheet stays open (doesn't close)

**Test UAT-004 (No overlap):** 9. Check preview comments in modal - should be below username, no overlap

**Test UAT-005 (Feed card comment button):** 10. Close modal, return to feed 11. Tap comment icon/button on a feed card 12. Verify: Modal opens with CommentsBottomSheet already visible

**Test UAT-006 (No console errors):** 13. Check console - should not see ERROR for getPreviewComments

**Test UAT-007 (Keyboard auto-open):** 14. Open CommentsBottomSheet 15. Verify: Keyboard appears automatically without extra tap

**Test UAT-008 (Empty state):** 16. Find a photo with no comments, open CommentsBottomSheet 17. Verify: Sheet is ~50% height with "No comments yet" message
</how-to-verify>
<resume-signal>Type "approved" if all issues fixed, or describe remaining issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
**Round 2 (Current Focus):**
- [ ] BLOCKER fixed: UAT-009 (CommentsBottomSheet closes correctly)
- [ ] Major issues fixed: UAT-013 (keyboard), UAT-014 (feed mode tap)
- [ ] Minor issues fixed: UAT-010, UAT-011, UAT-012
- [ ] Build compiles without errors

**Round 1 (Previously Resolved):**

- [x] All 3 Major issues fixed (UAT-002, UAT-005, UAT-006)
- [x] All 5 Minor issues fixed (UAT-001, UAT-003, UAT-004, UAT-007, UAT-008)
      </verification>

<success_criteria>

- CommentsBottomSheet can be closed via all methods without reopening (UAT-009)
- Keyboard doesn't cover comment input when typing (UAT-013)
- Comment tap works in feed mode, not just stories (UAT-014)
- Comment input respects safe area insets (UAT-010)
- Comment preview aligns with username (UAT-011)
- Single rotating comment preview with fade animation (UAT-012)
- All tests pass during human verification
  </success_criteria>

<output>
After completion, create `.planning/phases/36-comments-feature/36-03-FIX-SUMMARY.md`
</output>
