---
phase: 36-comments-feature
plan: 36-03-FIX-4
type: fix
---

<objective>
Fix 6 UAT issues from plan 36-03 Round 5.

Source: 36-03-ISSUES.md
Priority: 1 blocker, 1 major, 1 minor, 3 cosmetic
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/36-comments-feature/36-03-ISSUES.md

**Original plan for reference:**
@.planning/phases/36-comments-feature/36-03-PLAN.md

**Key files:**
@src/components/PhotoDetailModal.js
@src/hooks/usePhotoDetailModal.js
@src/components/comments/CommentsBottomSheet.js
@src/components/comments/CommentRow.js
@src/components/comments/CommentInput.js
@src/styles/PhotoDetailModal.styles.js
@src/styles/CommentRow.styles.js
@src/styles/CommentInput.styles.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-028 - PhotoDetailModal swipe-to-close regression (BLOCKER)</name>
  <files>src/hooks/usePhotoDetailModal.js</files>
  <action>
The PanResponder on PhotoDetailModal isn't capturing swipe gestures in feed mode. The issue is that `onStartShouldSetPanResponder: () => false` prevents gesture tracking from the start, so when `onMoveShouldSetPanResponder` is called, there's no gesture state to evaluate.

Fix by returning true from `onStartShouldSetPanResponderCapture` when a vertical gesture begins:

1. Keep `onStartShouldSetPanResponder: () => false` (don't capture initial tap)
2. Keep `onStartShouldSetPanResponderCapture: () => false`
3. Change `onMoveShouldSetPanResponder` to check for vertical movement: `Math.abs(gestureState.dy) > Math.abs(gestureState.dx) && gestureState.dy > 5`
4. Change `onMoveShouldSetPanResponderCapture` to same logic but return true to capture
5. Ensure footerThreshold check still prevents gestures starting in footer

This ensures the gesture is recognized as a swipe when vertical movement exceeds horizontal and is downward.
</action>
<verify>

1. Open app, go to Feed tab
2. Tap any photo to open modal
3. Swipe down from photo area - modal should close with animation
4. Verify stories mode still works (tap navigation + swipe close)
   </verify>
   <done>Swipe-to-close works in both feed mode and stories mode</done>
   </task>

<task type="auto">
  <name>Task 2: Fix UAT-030 - CommentsBottomSheet swipe-to-close regression (MAJOR)</name>
  <files>src/components/comments/CommentsBottomSheet.js</files>
  <action>
Same issue as UAT-028 - PanResponder on handle bar isn't working because `onStartShouldSetPanResponder: () => false` prevents gesture tracking.

Fix by updating the PanResponder configuration:

1. Change `onStartShouldSetPanResponder` to return true when touch is on handle bar area
2. Change `onMoveShouldSetPanResponder` to check for vertical movement: `Math.abs(gestureState.dy) > Math.abs(gestureState.dx) && gestureState.dy > 5`
3. Or alternatively, use `onStartShouldSetPanResponder: () => true` since the panResponder is already only on the handleBarContainer, not the entire sheet

The simplest fix: Change `onStartShouldSetPanResponder: () => false` to `onStartShouldSetPanResponder: () => true` since we WANT to capture touches that start on the handle bar.
</action>
<verify>

1. Open CommentsBottomSheet from any photo
2. Swipe down on handle bar at top
3. Sheet should close with slide-down animation
4. Verify tapping backdrop still closes
5. Verify X button still closes
   </verify>
   <done>Handle bar swipe-to-close gesture works</done>
   </task>

<task type="auto">
  <name>Task 3: Fix UAT-029 - Keyboard moves sheet too high (MINOR)</name>
  <files>src/components/comments/CommentsBottomSheet.js</files>
  <action>
The sheet translates up by full keyboard height, causing excess gap above keyboard.

The issue is that SHEET_HEIGHT is 60% of screen, but when keyboard appears, we're moving the entire sheet up by keyboardHeight which is too much. We only need to move it up enough to keep the input visible.

Fix:

1. Instead of translating by full keyboardHeight, calculate the overlap:
   - Sheet bottom is at 40% from screen bottom (60% sheet height)
   - We only need to move if keyboard overlaps with input
   - Calculate: `Math.max(0, keyboardHeight - (SCREEN_HEIGHT * 0.4 - inputHeight - safeArea))`
   - Simplify: Use a smaller offset, approximately `keyboardHeight - (SCREEN_HEIGHT * 0.4)` or just reduce to 60-70% of keyboardHeight

Simpler fix: Reduce the translateY to 60% of keyboard height: `toValue: -(keyboardHeight * 0.6)`

This keeps the input visible while reducing the excessive gap.
</action>
<verify>

1. Open CommentsBottomSheet
2. Tap input to bring up keyboard
3. Verify sheet moves up but not excessively
4. Verify input is still visible and usable
5. Verify comments list is still visible above keyboard
   </verify>
   <done>Sheet moves up appropriate amount when keyboard appears</done>
   </task>

<task type="auto">
  <name>Task 4: Fix UAT-031 - Timestamp/Reply spacing still too wide (COSMETIC)</name>
  <files>src/styles/CommentRow.styles.js</files>
  <action>
Current dot marginHorizontal is 4px (reduced from 6 in previous fix). User still reports it's too wide.

Reduce to minimum spacing:

1. Change `dot.marginHorizontal` from 4 to 2
2. This creates 4px total gap between Reply and timestamp (2px each side)

This is the tightest reasonable spacing while maintaining visual separation.
</action>
<verify>

1. Open CommentsBottomSheet with existing comments
2. Look at timestamp and Reply text spacing
3. Verify spacing is tighter but elements don't touch
   </verify>
   <done>Timestamp/Reply spacing is appropriately tight</done>
   </task>

<task type="auto">
  <name>Task 5: Fix UAT-032 - Send button still smaller than input (COSMETIC)</name>
  <files>src/styles/CommentInput.styles.js</files>
  <action>
Current send button is 40x40, input minHeight is 40. But inputWrapper has paddingVertical which makes it visually taller.

Looking at inputWrapper: `paddingVertical: Platform.OS === 'ios' ? 10 : 6` and `minHeight: 40`
This means iOS actual height is 40 + 20 (padding) = up to 60px visually.

Fix:

1. Match send button to inputWrapper visual height
2. Calculate: If inputWrapper is minHeight 40 with paddingVertical 10, the visual height is ~40-44px (content-based)
3. Increase sendButton to 44x44 to better match
4. Update borderRadius to 22 to maintain circular shape

Alternative: Make both elements use same explicit height by setting inputWrapper minHeight to 44 and sendButton to 44x44.
</action>
<verify>

1. Open CommentsBottomSheet
2. Compare send button height to input field height
3. Verify they appear same height visually
4. Verify send button maintains circular shape
   </verify>
   <done>Send button height matches input field height</done>
   </task>

<task type="auto">
  <name>Task 6: Fix UAT-033 - Username position too low without comments (COSMETIC)</name>
  <files>src/components/PhotoDetailModal.js</files>
  <action>
Current no-comments position is bottom: 102. User wants username higher when no comments present.

The user info should be closer to the photo bottom edge when there's no comment preview taking up space.

Fix:

1. In PhotoDetailModal.js, change the no-comments case from bottom: 102 to bottom: 110
2. This moves the username 8px higher
3. The with-comments case stays at 130 (30px gap from comment preview at 100)

Alternative values to try if 110 isn't enough: 115 or 120
</action>
<verify>

1. Open a story photo that has no comments
2. Verify username is positioned higher than before
3. Compare with a photo that has comments - verify the spacing difference makes sense
4. Verify username doesn't overlap with other elements
   </verify>
   <done>Username positioned appropriately higher when no comments</done>
   </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 6 UAT issues fixed
- [ ] Swipe-to-close works in PhotoDetailModal (feed mode)
- [ ] Swipe-to-close works on CommentsBottomSheet handle
- [ ] Keyboard sheet positioning is reasonable
- [ ] UI spacing/sizing improvements applied
- [ ] No regressions to stories mode or other existing functionality
</verification>

<success_criteria>

- All UAT issues from 36-03-ISSUES.md Round 5 addressed
- Gesture recognition works reliably for swipe-to-close
- App tested and ready for re-verification
  </success_criteria>

<output>
After completion, create `.planning/phases/36-comments-feature/36-03-FIX-4-SUMMARY.md`
</output>
