---
phase: 07.2-song-modal-stacking
plan: 01
type: execute
---

<objective>
Fix modal navigation so clip selection overlays song search instead of replacing it (UAT-007).

Purpose: Create connected flow where canceling clip selection returns to search with preserved state.
Output: SongSearchScreen (navigation) + ClipSelectionModal (transparent modal on top).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary-frontmatter.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.2-song-modal-stacking/07.2-CONTEXT.md
@.planning/phases/07-profile-song/07-04-ISSUES.md

# Key files:

@src/screens/ProfileScreen.js
@src/components/ProfileSong/SongSearchModal.js
@src/components/ProfileSong/ClipSelectionModal.js
@src/navigation/AppNavigator.js

**Source issue:** UAT-007 - Clip selection should overlay song search instead of replacing it

**Why stacking modals doesn't work:**
React Native doesn't reliably support stacking two Modal components, especially on iOS.
The correct pattern is: Screen (navigation) + Modal (on top of screen).

**Solution approach:**

1. Convert SongSearchModal to SongSearchScreen (navigation screen)
2. Add SongSearchScreen to ProfileStackNavigator
3. ClipSelectionModal remains a transparent Modal
4. Navigation: ProfileMain → SongSearchScreen (with ClipSelectionModal overlay)
5. Search state preserved because screen stays mounted while modal is visible

**Navigation flow:**

- Add song: `navigation.navigate('SongSearch')` → screen with ClipSelectionModal overlay
- Confirm clip: `navigation.goBack()` with song data via params/callback
- Cancel clip: Modal closes, still on SongSearchScreen
- Cancel search: `navigation.goBack()` to ProfileMain
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create SongSearchScreen from SongSearchModal</name>
  <files>src/screens/SongSearchScreen.js</files>
  <action>
Create a new screen component based on SongSearchModal:

1. Copy SongSearchModal.js content to new SongSearchScreen.js
2. Convert from Modal wrapper to regular View (screen container)
3. Change close button to navigation.goBack()
4. Add ClipSelectionModal integration directly in this screen:
   - State: `selectedSongForClip`
   - When song tapped: set `selectedSongForClip` (opens ClipSelectionModal)
   - On confirm: navigate back with song data via route params callback
   - On cancel: just close modal (clear selectedSongForClip), stay on search

Key changes from Modal to Screen:

- Remove `<Modal visible={visible}>` wrapper
- Use `navigation.goBack()` instead of `onClose()`
- Accept `route.params.onSongSelected` callback for returning data
- Keep same styling but as full screen (already has safe area handling)

Import ClipSelectionModal and manage its state locally in this screen.
</action>
<verify>

- File exists: src/screens/SongSearchScreen.js
- No Modal wrapper (uses View as container)
- Has navigation prop usage
- Has ClipSelectionModal integration
- Has selectedSongForClip state
  </verify>
  <done>
  SongSearchScreen created with integrated ClipSelectionModal.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Add SongSearchScreen to navigation</name>
  <files>src/navigation/AppNavigator.js</files>
  <action>
Add SongSearchScreen to ProfileStackNavigator:

1. Import SongSearchScreen at top of file
2. Add Stack.Screen inside ProfileStackNavigator:
   ```jsx
   <Stack.Screen
     name="SongSearch"
     component={SongSearchScreen}
     options={{
       presentation: 'card',
       animation: 'slide_from_bottom',
     }}
   />
   ```

Use slide_from_bottom animation to match the feel of the previous modal behavior.
</action>
<verify>

- SongSearchScreen imported
- Stack.Screen added to ProfileStackNavigator
- Animation set to slide_from_bottom
  </verify>
  <done>
  SongSearchScreen registered in navigation.
  </done>
  </task>

<task type="auto">
  <name>Task 3: Update ProfileScreen to use navigation</name>
  <files>src/screens/ProfileScreen.js</files>
  <action>
Replace modal-based song search with navigation:

1. Remove SongSearchModal import
2. Remove ClipSelectionModal import (now in SongSearchScreen)
3. Remove state: `showSongSearch`, `selectedSongForClip`
4. Remove handlers: `handleSongSelected`, `handleClipConfirm`, `handleClipCancel`
5. Remove modal JSX at bottom of component

6. Update handleSongPress (add song when empty):

   ```jsx
   const handleSongPress = () => {
     if (!profileData?.profileSong) {
       navigation.navigate('SongSearch', {
         onSongSelected: songWithClip => {
           handleSaveSong(songWithClip);
         },
       });
     }
   };
   ```

7. Update handleSongLongPress "Change Song" option:

   ```jsx
   {
     text: 'Change Song',
     onPress: () => {
       navigation.navigate('SongSearch', {
         onSongSelected: (songWithClip) => {
           handleSaveSong(songWithClip);
         },
       });
     },
   }
   ```

8. Update handleSongLongPress "Edit Clip" option:
   - Navigate to SongSearch with existing song pre-selected for clip editing
   - Pass current song data so clip selection opens immediately

   ```jsx
   {
     text: 'Edit Clip',
     onPress: () => {
       navigation.navigate('SongSearch', {
         editSong: profileData.profileSong, // Pre-select this song for clip editing
         onSongSelected: (songWithClip) => {
           handleSaveSong(songWithClip);
         },
       });
     },
   }
   ```

9. Keep handleSaveSong as-is (saves to Firestore)
   </action>
   <verify>

- No SongSearchModal or ClipSelectionModal imports
- No showSongSearch or selectedSongForClip state
- navigation.navigate('SongSearch', {...}) used for song selection
- Edit clip passes editSong param
  </verify>
  <done>
  ProfileScreen uses navigation instead of modals.
  </done>
  </task>

<task type="auto">
  <name>Task 4: Handle editSong param in SongSearchScreen</name>
  <files>src/screens/SongSearchScreen.js</files>
  <action>
Support the "Edit Clip" flow where user wants to edit clip of existing song:

1. Get editSong from route.params
2. If editSong exists on mount, immediately open ClipSelectionModal:

   ```jsx
   useEffect(() => {
     if (route.params?.editSong) {
       setSelectedSongForClip(route.params.editSong);
     }
   }, [route.params?.editSong]);
   ```

3. When canceling clip selection in edit mode:
   - If we came from edit flow (editSong was set), navigate back
   - If we came from search flow, just close modal (stay on search)

   Track this with a ref or check if there are search results:

   ```jsx
   const handleClipCancel = () => {
     setSelectedSongForClip(null);
     // If we were in edit-only mode (no search happening), go back
     if (route.params?.editSong && results.length === 0) {
       navigation.goBack();
     }
   };
   ```

4. ClipSelectionModal onConfirm calls the route.params.onSongSelected callback and navigates back:
   ```jsx
   const handleClipConfirm = songWithClip => {
     setSelectedSongForClip(null);
     route.params?.onSongSelected?.(songWithClip);
     navigation.goBack();
   };
   ```
   </action>
   <verify>

- editSong param triggers immediate clip selection
- Cancel in edit mode navigates back
- Cancel in search mode stays on search
- Confirm always calls callback and navigates back
  </verify>
  <done>
  Edit clip flow works correctly from profile long-press menu.
  </done>
  </task>

<task type="auto">
  <name>Task 5: Cleanup old SongSearchModal</name>
  <files>src/components/ProfileSong/SongSearchModal.js, src/components/ProfileSong/index.js, src/components/index.js</files>
  <action>
Remove the old modal component:

1. Delete src/components/ProfileSong/SongSearchModal.js
2. Remove SongSearchModal export from src/components/ProfileSong/index.js
3. Remove SongSearchModal export from src/components/index.js
4. Keep ClipSelectionModal in components (now imported by SongSearchScreen)

Update exports:

- ProfileSong/index.js: Remove SongSearchModal, keep others
- components/index.js: Remove SongSearchModal line
  </action>
  <verify>
- SongSearchModal.js deleted
- No SongSearchModal exports remain
- ClipSelectionModal still exported (used by SongSearchScreen)
- No import errors in codebase
  </verify>
  <done>
  Old modal removed, exports cleaned up.
  </done>
  </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Screen-based song search with modal clip selection overlay</what-built>
  <how-to-verify>
Test the SEARCH → CLIP → CANCEL flow:
1. Run: `npx expo start` and open on device/simulator
2. Navigate to Profile tab
3. Tap the song card (when empty) or long-press → Change Song
4. **Verify:** SongSearchScreen slides up from bottom
5. Search for a song (e.g., "Taylor Swift")
6. Scroll down in results to remember your position
7. Tap a song card to select it
8. **Verify:** ClipSelectionModal appears OVER SongSearchScreen
9. **Verify:** Search results visible behind, dimmed by backdrop
10. Tap Cancel (X button or tap backdrop)
11. **Verify:** Returns to search with same results, same scroll position

Test the SEARCH → CLIP → CONFIRM flow:

1. Search for a song and select it
2. Adjust clip handles if desired
3. Tap "Use This Clip"
4. **Verify:** Returns to profile
5. **Verify:** Song is saved and displays on profile

Test the EDIT CLIP flow:

1. Long-press existing song on profile
2. Tap "Edit Clip"
3. **Verify:** Goes to SongSearchScreen with ClipSelectionModal immediately open
4. Tap Cancel
5. **Verify:** Returns to profile (not to empty search)
6. Long-press → Edit Clip again
7. Adjust clip and tap "Use This Clip"
8. **Verify:** Returns to profile with updated clip
   </how-to-verify>
   <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
   </task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] SongSearchScreen works as navigation screen
- [ ] ClipSelectionModal overlays SongSearchScreen (not replacing it)
- [ ] Search state preserved on clip cancel
- [ ] Confirm flow returns to profile with saved song
- [ ] Edit clip flow works (opens clip selection immediately)
- [ ] No TypeScript/ESLint errors
- [ ] App builds and runs without crashes
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- UAT-007 resolved: Clip selection overlays song search
- Connected flow feel: cancel returns to exact search position
- Phase 7.2 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/07.2-song-modal-stacking/07.2-01-SUMMARY.md`
</output>
