---
phase: 07.2-song-modal-stacking
plan: 01
type: execute
---

<objective>
Fix modal navigation so clip selection overlays song search instead of replacing it (UAT-007).

Purpose: Create connected flow where canceling clip selection returns to search with preserved state.
Output: Stacked modal behavior - ClipSelectionModal appears over SongSearchModal.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary-frontmatter.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.2-song-modal-stacking/07.2-CONTEXT.md
@.planning/phases/07-profile-song/07-04-ISSUES.md

# Key files from Phase 7:

@src/screens/ProfileScreen.js
@src/components/ProfileSong/SongSearchModal.js
@src/components/ProfileSong/ClipSelectionModal.js

**Source issue:** UAT-007 - Clip selection should overlay song search instead of replacing it

**Context from CONTEXT.md:**

- ClipSelectionModal (~40% height) should slide up over SongSearchModal
- Search results stay visible behind, dimmed but present
- Cancel must bring user back to exactly where they were in search
- No visual redesign - just fix the stacking behavior

**Current architecture:**

- SongSearchModal: Full-screen Modal with `animationType="slide"`
- ClipSelectionModal: Transparent Modal with backdrop (`rgba(0,0,0,0.5)`)
- ProfileScreen manages both via `showSongSearch` and `selectedSongForClip` state

**Root cause:**

- `handleSongSelected` closes SongSearchModal before opening ClipSelectionModal
- SongSearchModal resets all state (query, results, scroll) when `visible` becomes false
- On cancel, we re-open SongSearchModal but user has to start search over

**Solution approach:**

- Keep SongSearchModal open while ClipSelectionModal is visible
- React Native allows multiple Modals; ClipSelectionModal (transparent) stacks on top
- Search state preserved since SongSearchModal never unmounts
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Modify ProfileScreen modal visibility logic</name>
  <files>src/screens/ProfileScreen.js</files>
  <action>
Modify the song selection handlers in ProfileScreen to keep SongSearchModal open during clip selection:

1. **handleSongSelected** - Remove `setShowSongSearch(false)`:
   - Currently closes search, then opens clip selection
   - Change to: Only set `selectedSongForClip(song)`, keep search open
   - ClipSelectionModal's transparent backdrop will dim search behind it

2. **handleClipConfirm** - Add `setShowSongSearch(false)`:
   - User confirmed their clip, flow is complete
   - Close both modals: clear `selectedSongForClip` AND `showSongSearch`

3. **handleClipCancel** - Remove `setShowSongSearch(true)`:
   - Currently re-opens search (which was closed and reset)
   - Change to: Only clear `selectedSongForClip`
   - SongSearchModal is already visible with preserved state

4. **handleSongLongPress "Edit Clip"** - Special case:
   - Currently opens ClipSelectionModal directly from profile (no search)
   - Should work as-is since showSongSearch is false in this flow
   - Verify cancel behavior doesn't incorrectly show search modal
     </action>
     <verify>
     Code review:

- `handleSongSelected` does NOT call `setShowSongSearch(false)`
- `handleClipConfirm` calls BOTH `setSelectedSongForClip(null)` AND `setShowSongSearch(false)`
- `handleClipCancel` does NOT call `setShowSongSearch(true)`
  </verify>
  <done>
  ProfileScreen handlers modified to keep SongSearchModal open during clip selection.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Fix handleClipCancel for edit flow</name>
  <files>src/screens/ProfileScreen.js</files>
  <action>
The "Edit Clip" flow from long-press menu opens ClipSelectionModal directly (without SongSearchModal).
When user cancels from edit flow, we should NOT open SongSearchModal.

Modify `handleClipCancel` to check if SongSearchModal was open:

- If `showSongSearch` is true: Just close clip selection (search is still visible)
- If `showSongSearch` is false: Just close clip selection (was editing, not searching)

This is already the correct behavior with the Task 1 changes:

- `handleClipCancel` just sets `selectedSongForClip = null`
- Search modal visibility is unchanged (stays whatever it was)

**Verify the edit clip flow:**

- Long press song → Edit Clip → Cancel should return to profile (no search modal)
- This should work automatically with the simplified handler
  </action>
  <verify>
  Code review confirms `handleClipCancel` only clears `selectedSongForClip` without touching `showSongSearch`.
  </verify>
  <done>
  Cancel behavior correct for both search flow and edit flow.
  </done>
  </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Stacked modal behavior for song selection flow</what-built>
  <how-to-verify>
Test the SEARCH → CLIP → CANCEL flow:
1. Run: `npx expo start` and open on device/simulator
2. Navigate to Profile tab
3. Tap the song card (or long-press existing song → Change Song)
4. Search for a song (e.g., "Taylor Swift")
5. Scroll down in results to remember your position
6. Tap a song card to select it
7. **Verify:** ClipSelectionModal appears OVER SongSearchModal
8. **Verify:** Search results visible behind, dimmed by backdrop
9. Tap Cancel (or tap the dimmed backdrop)
10. **Verify:** Returns to search with same results, same scroll position

Test the SEARCH → CLIP → CONFIRM flow:

1. Search for a song and select it
2. Adjust clip handles if desired
3. Tap "Use This Clip"
4. **Verify:** Both modals close, returns to profile
5. **Verify:** Song is saved to profile

Test the EDIT CLIP flow (no search):

1. Long-press existing song on profile
2. Tap "Edit Clip"
3. **Verify:** ClipSelectionModal appears (no search modal behind)
4. Tap Cancel
5. **Verify:** Returns to profile (not to song search)
   </how-to-verify>
   <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
   </task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] ClipSelectionModal stacks over SongSearchModal (not replacing it)
- [ ] Search state preserved on cancel (query, results, scroll position)
- [ ] Confirm flow closes both modals
- [ ] Edit clip flow (from long-press) doesn't open search on cancel
- [ ] No TypeScript/ESLint errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- UAT-007 resolved: Clip selection overlays song search
- Connected flow feel: cancel returns to exact search position
- Phase 7.2 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/07.2-song-modal-stacking/07.2-01-SUMMARY.md`
</output>
