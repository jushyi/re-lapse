---
phase: 49-automated-test-suite
plan: 01
type: execute
---

<objective>
Install @testing-library/react-native v13 for hook/component testing, extend test infrastructure with new mocks and factories, and write comprehensive utility function tests.

Purpose: Establish the foundation all subsequent test plans depend on — RNTL for hooks, expanded mocks for untested modules, updated factories for new test data types, and high-ROI utility tests for pure functions.
Output: Working RNTL integration, expanded mocks/factories, passing utility tests for validation.js, timeUtils.js, phoneUtils.js.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/49-automated-test-suite/49-RESEARCH.md
@.planning/phases/49-automated-test-suite/49-CONTEXT.md
@.planning/codebase/TESTING.md
@.planning/codebase/CONVENTIONS.md

@jest.config.js
@**tests**/setup/jest.setup.js
@**tests**/setup/testFactories.js
@src/utils/validation.js
@src/utils/timeUtils.js
@src/utils/phoneUtils.js

**Tech stack available:** Jest ~29.7.0, jest-expo ~54.0.16, firestore-jest-mock ^0.26.0
**Established patterns:** Service unit tests with beforeEach/clearAllMocks, Arrange/Act/Assert, testFactories for data, **mocks**/ for module mocks
**Constraining decisions:**

- RNTL v13 APIs are async (await render, await fireEvent) per RESEARCH.md Pitfall 3
- react-test-renderer is deprecated in React 19 — do NOT use
- babel-plugin-react-compiler runs during Jest transforms — don't test re-render counts
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Install @testing-library/react-native and add infrastructure mocks</name>
  <files>package.json, __tests__/setup/jest.setup.js</files>
  <action>
1. Install RNTL v13: `npx expo install @testing-library/react-native`
2. Add to jest.setup.js — mock react-native-reanimated:
   ```
   jest.mock('react-native-reanimated', () => require('react-native-reanimated/mock'));
   ```
3. Add Navigation mock to jest.setup.js:
   ```
   jest.mock('@react-navigation/native', () => ({
     useNavigation: () => ({ navigate: jest.fn(), goBack: jest.fn(), setOptions: jest.fn() }),
     useRoute: () => ({ params: {} }),
     useFocusEffect: jest.fn(),
   }));
   ```
4. Add mock for @react-native-firebase/functions (needed for mentionService tests):
   ```
   jest.mock('@react-native-firebase/functions', () => {
     const mockHttpsCallable = jest.fn(() => jest.fn());
     return () => ({ httpsCallable: mockHttpsCallable });
   });
   ```
5. Add mock for @react-native-firebase/perf (needed for performanceService):
   ```
   jest.mock('@react-native-firebase/perf', () => {
     const mockTrace = { start: jest.fn(), stop: jest.fn(), putAttribute: jest.fn(), putMetric: jest.fn() };
     return () => ({ newTrace: jest.fn(() => mockTrace), setPerformanceCollectionEnabled: jest.fn() });
   });
   ```
6. Export new mock references for test assertions (follow existing pattern of exporting __mocks__ from jest.setup.js global mocks).

Do NOT modify existing mock patterns — extend only. Keep all existing Firebase module mocks intact.
</action>
<verify>npx expo install --check shows no dependency issues; npm test passes all existing tests (6 service + 2 integration)</verify>
<done>RNTL v13 installed, reanimated/navigation/functions/perf mocks added, all existing tests still pass</done>
</task>

<task type="auto">
  <name>Task 2: Extend test factories and write utility tests</name>
  <files>__tests__/setup/testFactories.js, __tests__/utils/validation.test.js, __tests__/utils/timeUtils.test.js, __tests__/utils/phoneUtils.test.js</files>
  <action>
1. Extend testFactories.js with new factory functions (follow existing pattern — default values with override spread):
   - `createTestComment(overrides)` — { id, photoId, userId, text, parentId: null, mentionedCommentId: null, createdAt, likes: 0 }
   - `createTestAlbum(overrides)` — { id, userId, name, photoIds: [], coverPhotoId: null, createdAt, updatedAt }
   - `createTestMention(overrides)` — { uid, displayName, username, profilePhotoURL }
   - `createTestBlock(overrides)` — { id, blockerId, blockedId, createdAt }

2. Create **tests**/utils/validation.test.js:
   - Test isValidEmail: valid emails, invalid emails (no @, no domain, empty), edge cases
   - Test isValidUsername: valid usernames, too short, too long, invalid characters, reserved words
   - Test normalizeUsername: lowercases, trims whitespace
   - Test sanitizeInput: strips XSS attempts, handles null/undefined
   - Test sanitizeDisplayName: respects maxLength, trims
   - Test sanitizeBio: respects maxLength, trims
   - Test validateRequired: empty string, null, undefined, whitespace-only
   - Test validateLength: within range, too short, too long
   - Test isValidUrl: valid URLs, invalid URLs
   - Test isValidPhotoSize / isValidPhotoType: boundary values

3. Create **tests**/utils/timeUtils.test.js:
   - Test getTimeAgo: seconds ago, minutes ago, hours ago, days ago, weeks ago
   - Test formatDate: valid dates, edge cases
   - Test formatFullDateTime: timestamp formatting
   - Test getRevealCountdown: future time, past time, exact now
   - Test isToday: today, yesterday, future
   - Test isWithinLastWeek: within 7 days, 8 days ago, edge

4. Create **tests**/utils/phoneUtils.test.js:
   - Test formatPhoneWithCountry: US numbers, international numbers
   - Test formatPhoneForDisplay: various country codes
   - Test formatAsUserTypes: progressive digit entry
   - Test getInputPreview: raw digit formatting

Import real modules (do NOT mock utility functions — they're pure functions). Use descriptive test names: `it('should return "just now" for timestamps less than 60 seconds ago')`.
</action>
<verify>npm test -- --testPathPattern="utils" passes all utility tests; npm test passes full suite</verify>
<done>Test factories extended with 4 new types; validation.test.js, timeUtils.test.js, phoneUtils.test.js all pass; full suite green</done>
</task>

<task type="auto">
  <name>Task 3: Verify full test suite and document test counts</name>
  <files>None (verification only)</files>
  <action>
1. Run full test suite: `npm test` — verify all existing + new tests pass
2. Run with coverage: `npm run test:coverage` — note coverage numbers for documentation
3. Verify no deprecation warnings from react-test-renderer (should NOT appear since we use RNTL)
4. Verify test execution time is fast (utility tests should complete in <2 seconds)
  </action>
  <verify>npm test shows 0 failures; npm run test:coverage completes</verify>
  <done>All tests pass, no deprecation warnings, utility tests execute in <2s</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test` passes all tests (existing + new utility tests)
- [ ] @testing-library/react-native v13 is in package.json devDependencies
- [ ] jest.setup.js has reanimated, navigation, functions, perf mocks
- [ ] testFactories.js has createTestComment, createTestAlbum, createTestMention, createTestBlock
- [ ] validation.test.js covers all exported validators
- [ ] timeUtils.test.js covers all 6 exported functions
- [ ] phoneUtils.test.js covers all 4 exported functions
- [ ] No react-test-renderer deprecation warnings in test output
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- RNTL v13 available for subsequent plans
- Utility tests provide fast, reliable regression guards for pure functions
  </success_criteria>

<output>
After completion, create `.planning/phases/49-automated-test-suite/49-01-SUMMARY.md`
</output>
