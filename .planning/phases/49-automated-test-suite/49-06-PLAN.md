---
phase: 49-automated-test-suite
plan: 06
type: execute
---

<objective>
Write Cloud Functions tests for all remaining triggers, callable functions, and scheduled functions.

Purpose: Complete Cloud Functions test coverage — triggers handle real-time notifications, callables handle friend suggestions and account deletion, scheduleds handle darkroom reveals and cleanup. These are the server-side behaviors that can silently break.
Output: Passing tests for all 18 exported Cloud Functions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/49-automated-test-suite/49-RESEARCH.md

@functions/index.js
@functions/**tests**/setup.js (created in 49-05)

**Tech stack available:** firebase-functions-test, jest, firebase-admin mock, expo-server-sdk mock (all from 49-05)
**Established patterns:** wrap() for triggers, makeDocumentSnapshot for Firestore data, makeChange(before, after) for onUpdate triggers
**Constraining decisions:**

- Test via wrap() since helpers aren't exported
- Each trigger function needs its own describe block
- Mock admin.firestore() responses per-test using beforeEach
- Use testEnv.cleanup() in afterAll
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Write notification trigger tests</name>
  <files>functions/__tests__/triggers/notifications.test.js</files>
  <action>
Test all 6 notification trigger functions (sendFriendRequestNotification was partially tested in 49-05 — complete remaining triggers):

1. **sendFriendAcceptedNotification** (onCreate on friendships where status becomes 'accepted'):
   - Sends notification to the original requester when their request is accepted
   - Skips if acceptor is the original requester (edge case)

2. **sendStoryNotification** (onUpdate on photos — photoState changes to 'journal'):
   - Sends notification to friends when user journals a photo to stories
   - Skips for private photos or if no friends

3. **sendReactionNotification** (onUpdate on photos — reactionCount increases):
   - Detects new reactions by comparing before/after reaction counts
   - Debounces multiple reactions (30-second window per RESEARCH.md)
   - Skips self-reactions (reactor === photo owner)

4. **sendTaggedPhotoNotification** (onUpdate on photos — tagged users added):
   - Detects newly tagged users by comparing before/after taggedUsers
   - Sends individual notifications to each new tagged user
   - Debounce pattern similar to reactions

5. **sendCommentNotification** (onCreate on comments subcollection):
   - Notifies photo owner of new comment
   - Skips if commenter is photo owner (self-comment)
   - Handles @mentions in comment text

6. **sendPhotoRevealNotification** (onUpdate on photos — photoState changes from 'developing' to revealed):
   - Notifies photo owner when their photo is revealed from darkroom

For onUpdate triggers, use testEnv.makeChange(before, after):

```javascript
const before = testEnv.firestore.makeDocumentSnapshot(beforeData, docPath);
const after = testEnv.firestore.makeDocumentSnapshot(afterData, docPath);
const change = testEnv.makeChange(before, after);
await wrapped(change, { params: { photoId: 'p1' } });
```

For each trigger: test sends-notification case, skip-self case, skip-no-token case.
</action>
<verify>cd functions && npm test -- --testPathPattern="triggers" passes all trigger tests</verify>
<done>All 6 notification triggers tested with send + skip scenarios; trigger tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Write callable function tests</name>
  <files>functions/__tests__/callable/functions.test.js</files>
  <action>
Test all 5 callable/HTTPS functions:

1. **getMutualFriendSuggestions(data, context):**
   - Returns mutual friend suggestions for the authenticated user
   - Requires auth context (context.auth.uid)
   - Queries friendships to find friends-of-friends
   - Test: returns suggestions when mutual friends exist, empty array when none, throws if unauthenticated

2. **getMutualFriendsForComments(data, context):**
   - Returns mutual friends between current user and photo owner (for @mention tagging)
   - data.photoOwnerId is required
   - Test: returns mutual friends list, handles no mutual friends, validates input

3. **deleteUserAccount(data, context):**
   - Deletes user's photos, albums, friendships, notifications, auth account
   - Requires auth context
   - Test: calls all deletion steps (verify mock calls to admin.auth().deleteUser, storage bucket delete, etc.)
   - Test: throws on unauthenticated call

4. **scheduleUserAccountDeletion(data, context):**
   - Sets deletionScheduledAt on user document (30-day grace period)
   - Test: updates user document with scheduled date

5. **cancelUserAccountDeletion(data, context):**
   - Removes deletionScheduledAt from user document
   - Test: updates user document to clear deletion

For callable functions with wrap():

```javascript
const { getMutualFriendSuggestions } = require('../../index');
const wrapped = testEnv.wrap(getMutualFriendSuggestions);
const result = await wrapped(
  {
    /* data */
  },
  { auth: { uid: 'test-user' } }
);
```

  </action>
  <verify>cd functions && npm test -- --testPathPattern="callable" passes all callable tests</verify>
  <done>All 5 callable functions tested with auth + no-auth + business logic scenarios</done>
</task>

<task type="auto">
  <name>Task 3: Write scheduled function tests and run full CF suite</name>
  <files>functions/__tests__/scheduled/functions.test.js</files>
  <action>
Test all 3 scheduled functions:

1. **processDarkroomReveals:**
   - Queries photos with photoState='developing' and revealAt <= now
   - Updates each qualifying photo's photoState to 'revealed' (or appropriate state)
   - Test: reveals photos past their reveal time, skips photos not yet ready

2. **processScheduledDeletions:**
   - Queries users with deletionScheduledAt <= now
   - Calls full account deletion for each qualifying user
   - Test: processes due deletions, skips future-scheduled

3. **processScheduledPhotoDeletions:**
   - Queries photos in 'deleted' state past their 30-day grace period
   - Permanently removes photo data and storage files
   - Test: permanently deletes expired photos, skips non-expired

4. **checkPushReceipts:**
   - Checks push notification receipt status with Expo servers
   - Handles failed receipts (e.g., DeviceNotRegistered — should remove token)
   - Test: processes OK receipts, handles error receipts

For scheduled functions, wrap() still works — they're just functions without document trigger params:

```javascript
const wrapped = testEnv.wrap(processDarkroomReveals);
await wrapped(); // No params for scheduled functions
```

After writing all tests, run the full Cloud Functions test suite:

```bash
cd functions && npm test
```

Verify all trigger, callable, and scheduled tests pass together.
</action>
<verify>cd functions && npm test passes all CF tests (triggers + callables + scheduled + smoke); report total test count</verify>
<done>All 18 Cloud Functions tested; full CF suite passes with 0 failures</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd functions && npm test` passes all tests
- [ ] 6 notification trigger functions tested
- [ ] 5 callable functions tested (including auth checks)
- [ ] 3 scheduled functions tested
- [ ] checkPushReceipts tested
- [ ] sendFriendRequestNotification + sendCommentNotification tested (from 49-05, verified still passing)
- [ ] No test interdependencies (each test is isolated with clearAllMocks)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- All 18 exported Cloud Functions have test coverage
- Auth context validation tested for all callable functions
- Trigger skip conditions (self-action, no token, disabled) tested
  </success_criteria>

<output>
After completion, create `.planning/phases/49-automated-test-suite/49-06-SUMMARY.md`
</output>
