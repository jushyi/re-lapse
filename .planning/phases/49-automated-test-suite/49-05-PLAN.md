---
phase: 49-automated-test-suite
plan: 05
type: execute
---

<objective>
Set up Cloud Functions test infrastructure and write notification sender tests.

Purpose: The 18 Cloud Functions have zero test coverage. This plan establishes the test foundation (jest config, mocks, test script) and tests the core notification sender utility that all trigger functions depend on.
Output: Working Cloud Functions test infrastructure, expo-server-sdk mock, passing notification sender tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/49-automated-test-suite/49-RESEARCH.md
@.planning/codebase/TESTING.md

@functions/index.js
@functions/package.json

**Tech stack available:** firebase-functions-test (already in devDependencies), firebase-admin, firebase-functions, expo-server-sdk, zod
**Established patterns:** firebase-functions-test wrap() for trigger testing, jest.mock('firebase-admin') before requiring functions
**Constraining decisions:**

- Cloud Functions use Node.js environment — separate jest.config.js with testEnvironment: 'node'
- firebase-admin must be mocked BEFORE requiring index.js (module initialization side effects)
- expo-server-sdk mock needs: Expo class with sendPushNotificationsAsync, chunkPushNotifications, isExpoPushToken static method
- functions/index.js is ~2500 lines — helpers are not exported, test via wrap() on exported functions
- Use forceExit: true in jest config (firebase-admin keeps connections open)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Set up Cloud Functions test infrastructure</name>
  <files>functions/jest.config.js, functions/__tests__/setup.js, functions/package.json</files>
  <action>
1. Install jest in functions directory: `cd functions && npm install --save-dev jest@^29.7.0`

2. Create functions/jest.config.js:

   ```javascript
   module.exports = {
     testEnvironment: 'node',
     testMatch: ['**/__tests__/**/*.test.js'],
     setupFilesAfterSetup: ['<rootDir>/__tests__/setup.js'],
     clearMocks: true,
     forceExit: true,
     detectOpenHandles: true,
     verbose: true,
   };
   ```

3. Add test script to functions/package.json scripts: `"test": "jest"`

4. Create functions/**tests**/setup.js with comprehensive mocks:

   **firebase-admin mock:**

   ```javascript
   jest.mock('firebase-admin', () => {
     const mockBatch = {
       set: jest.fn(),
       update: jest.fn(),
       delete: jest.fn(),
       commit: jest.fn().mockResolvedValue(),
     };
     const mockDocRef = {
       get: jest.fn().mockResolvedValue({ exists: false, data: () => null }),
       set: jest.fn().mockResolvedValue(),
       update: jest.fn().mockResolvedValue(),
       delete: jest.fn().mockResolvedValue(),
     };
     const mockCollectionRef = {
       doc: jest.fn(() => mockDocRef),
       add: jest.fn().mockResolvedValue({ id: 'mock-id' }),
       get: jest.fn().mockResolvedValue({ docs: [], empty: true }),
       where: jest.fn().mockReturnThis(),
       orderBy: jest.fn().mockReturnThis(),
       limit: jest.fn().mockReturnThis(),
     };
     const mockFirestore = {
       collection: jest.fn(() => mockCollectionRef),
       doc: jest.fn(() => mockDocRef),
       batch: jest.fn(() => mockBatch),
       runTransaction: jest.fn(fn => fn({ get: jest.fn(), set: jest.fn(), update: jest.fn() })),
     };
     mockFirestore.FieldValue = {
       serverTimestamp: jest.fn(() => 'mock-timestamp'),
       increment: jest.fn(n => n),
       arrayUnion: jest.fn((...args) => args),
       arrayRemove: jest.fn((...args) => args),
       delete: jest.fn(),
     };
     mockFirestore.Timestamp = { now: jest.fn(() => ({ toDate: () => new Date() })) };
     return {
       initializeApp: jest.fn(),
       firestore: jest.fn(() => mockFirestore),
       auth: jest.fn(() => ({ getUser: jest.fn(), deleteUser: jest.fn() })),
       storage: jest.fn(() => ({
         bucket: jest.fn(() => ({ file: jest.fn(() => ({ delete: jest.fn() })) })),
       })),
     };
   });
   ```

   **expo-server-sdk mock:**

   ```javascript
   jest.mock('expo-server-sdk', () => {
     const mockSend = jest.fn().mockResolvedValue([{ status: 'ok', id: 'receipt-123' }]);
     class MockExpo {
       constructor() {
         this.sendPushNotificationsAsync = mockSend;
         this.chunkPushNotifications = jest.fn(msgs => [msgs]);
         this.chunkPushNotificationReceiptIds = jest.fn(ids => [ids]);
         this.getPushNotificationReceiptsAsync = jest.fn().mockResolvedValue({});
       }
     }
     MockExpo.isExpoPushToken = jest.fn(
       token => typeof token === 'string' && token.startsWith('ExponentPushToken[')
     );
     return { Expo: MockExpo };
   });
   ```

   Export all mock references for assertion access in tests.

5. Create functions/**tests**/ directory structure:
   - functions/**tests**/setup.js (above)
   - functions/**tests**/triggers/ (empty, for Plan 06)
   - functions/**tests**/callable/ (empty, for Plan 06)

6. Create a smoke test: functions/**tests**/smoke.test.js that verifies the mock setup works and index.js can be required without errors.
   </action>
   <verify>cd functions && npm test passes smoke test with 0 errors</verify>
   <done>functions/jest.config.js created, setup.js with firebase-admin + expo-server-sdk mocks, test script added, smoke test passes</done>
   </task>

<task type="auto">
  <name>Task 2: Write notification sender tests</name>
  <files>functions/__tests__/notifications/sender.test.js</files>
  <action>
Read functions/index.js to understand the notification sending pattern. The notification logic is likely inline in each trigger function, but there may be shared patterns for:
- Checking if recipient has a valid Expo push token
- Checking notification preferences (enabled/disabled)
- Constructing notification payload (title, body, data)
- Sending via expo-server-sdk

Since helpers aren't exported, test the notification behavior THROUGH the trigger functions using firebase-functions-test wrap(). Start with the simplest trigger function.

**Test sendFriendRequestNotification via wrap():**

```javascript
const firebaseFunctionsTest = require('firebase-functions-test');
const testEnv = firebaseFunctionsTest();

// Setup mocks (from setup.js)
const admin = require('firebase-admin');

describe('sendFriendRequestNotification', () => {
  let wrapped;

  beforeAll(() => {
    const { sendFriendRequestNotification } = require('../../index');
    wrapped = testEnv.wrap(sendFriendRequestNotification);
  });

  beforeEach(() => jest.clearAllMocks());
  afterAll(() => testEnv.cleanup());

  it('sends notification when friend request is created', async () => {
    // Mock: recipient has push token and notifications enabled
    // Create document snapshot for new friendship
    const snap = testEnv.firestore.makeDocumentSnapshot(
      { user1Id: 'sender', user2Id: 'receiver', status: 'pending', requestedBy: 'sender' },
      'friendships/f-123'
    );

    // Mock admin.firestore() to return recipient user with push token
    // ... (set up mock chain for user document lookup)

    await wrapped(snap, { params: { friendshipId: 'f-123' } });

    // Assert expo-server-sdk sendPushNotificationsAsync was called
  });

  it('skips notification when recipient has no push token', async () => {
    // Mock: recipient has no push token
    // ... verify sendPushNotificationsAsync was NOT called
  });

  it('skips notification when recipient disabled friend request notifications', async () => {
    // Mock: recipient has push token but notificationSettings.friendRequests === false
    // ... verify sendPushNotificationsAsync was NOT called
  });
});
```

Also test sendCommentNotification (another common trigger) to verify the pattern works for different trigger types. Each test should verify:

1. Correct Firestore lookups (recipient user, notification preferences)
2. Notification payload construction (title, body, data)
3. Skip conditions (no token, disabled, self-notification)
   </action>
   <verify>cd functions && npm test passes all notification tests</verify>
   <done>Notification sender tests pass covering send, skip-no-token, skip-disabled scenarios for at least 2 trigger types</done>
   </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd functions && npm test` passes all tests
- [ ] functions/jest.config.js configured for Node environment
- [ ] functions/__tests__/setup.js mocks firebase-admin and expo-server-sdk
- [ ] functions/package.json has jest devDependency and test script
- [ ] Smoke test verifies index.js loads without errors
- [ ] Notification tests cover send + skip conditions
- [ ] firebase-functions-test wrap() pattern working correctly
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Cloud Functions test infrastructure is CI-ready (Phase 50 dependency)
- Notification sending patterns are verified through trigger tests
  </success_criteria>

<output>
After completion, create `.planning/phases/49-automated-test-suite/49-05-SUMMARY.md`
</output>
