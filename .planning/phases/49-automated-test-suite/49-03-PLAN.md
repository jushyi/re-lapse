---
phase: 49-automated-test-suite
plan: 03
type: execute
---

<objective>
Write unit tests for content and account Firebase services: albumService, userService, accountService, and notificationService.

Purpose: Cover the content management and account lifecycle services — album CRUD, user profiles, account deletion, and push notification registration are foundational to the app's data layer.
Output: Passing test suites for all 4 services with mocked Firebase calls.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/49-automated-test-suite/49-RESEARCH.md
@.planning/codebase/TESTING.md
@.planning/codebase/CONVENTIONS.md

@**tests**/setup/jest.setup.js
@**tests**/setup/testFactories.js
@**tests**/services/photoService.test.js (reference for existing patterns)
@src/services/firebase/albumService.js
@src/services/firebase/userService.js
@src/services/firebase/accountService.js
@src/services/firebase/notificationService.js

**Established patterns:** Mock Firestore chain (collection→doc→get/set/update/delete), mockResolvedValueOnce for sequential calls, test factories for data
**Constraining decisions:**

- accountService calls Cloud Functions (deleteUserAccount, scheduleAccountDeletion, cancelAccountDeletion) — mock @react-native-firebase/functions httpsCallable
- notificationService uses expo-notifications (already mocked in jest.setup.js) and expo-secure-store
- userService.checkUsernameAvailability queries Firestore where('username', '==', username)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Write albumService unit tests</name>
  <files>__tests__/services/albumService.test.js</files>
  <action>
Test all 8 exported functions:

1. **createAlbum(userId, name, photoIds)** — creates album doc with correct fields, returns { success: true, albumId }. Test empty photoIds, multiple photoIds.
2. **getAlbum(albumId)** — returns album data for existing album, handles non-existent album
3. **getUserAlbums(userId)** — returns array of user's albums, empty array for no albums
4. **updateAlbum(albumId, updates)** — updates specified fields, returns success
5. **deleteAlbum(albumId)** — deletes album doc, returns success
6. **addPhotosToAlbum(albumId, photoIds)** — adds photos to existing album's photoIds array
7. **removePhotoFromAlbum(albumId, photoId)** — removes single photo from album
8. **setCoverPhoto(albumId, photoId)** — updates coverPhotoId field

Use createTestAlbum factory. Mock Firestore arrayUnion/arrayRemove for photo add/remove operations. Test success + error paths for each function.
</action>
<verify>npm test -- --testPathPattern="albumService" passes all tests</verify>
<done>albumService.test.js passes with tests for all 8 functions, success + error paths</done>
</task>

<task type="auto">
  <name>Task 2: Write userService unit tests</name>
  <files>__tests__/services/userService.test.js</files>
  <action>
Test all 8 exported functions:

1. **getUserProfile(userId)** — returns user profile data, handles non-existent user
2. **updateUserProfile(userId, updates, currentUsername)** — updates profile fields, handles username change (checks availability first), returns success/failure
3. **checkUsernameAvailability(username, currentUserId)** — queries Firestore, returns true if available (no other user has it), false if taken, handles current user's own username
4. **canChangeUsername(lastUsernameChange)** — returns boolean based on cooldown period (read source to determine cooldown logic)
5. **getDailyPhotoCount(userId)** — returns count from user's daily stats
6. **incrementDailyPhotoCount(userId)** — increments daily counter
7. **checkDailyLimit(userId)** — checks if user has exceeded daily photo limit
8. **cancelProfileSetup(userId)** — handles cancellation of profile setup flow

Focus on business logic correctness. checkUsernameAvailability should verify Firestore where() query is constructed correctly. canChangeUsername should test boundary conditions around the cooldown period.
</action>
<verify>npm test -- --testPathPattern="userService" passes all tests</verify>
<done>userService.test.js passes with tests for all 8 functions including business logic edge cases</done>
</task>

<task type="auto">
  <name>Task 3: Write accountService and notificationService unit tests</name>
  <files>__tests__/services/accountService.test.js, __tests__/services/notificationService.test.js</files>
  <action>
**accountService (4 functions):**
All functions call Cloud Functions via httpsCallable — mock the callable chain:
1. **deleteUserAccount()** — calls Cloud Function, returns success/failure
2. **scheduleAccountDeletion()** — calls Cloud Function to schedule 30-day deletion
3. **cancelAccountDeletion()** — calls Cloud Function to cancel scheduled deletion
4. **checkDeletionStatus()** — checks if account has pending deletion

Test: success responses, Cloud Function errors, network failures.

**notificationService (12 functions):**
Focus on the most important functions (skip trivial getters/setters):

1. **initializeNotifications()** — sets up notification handling
2. **requestNotificationPermission()** — calls expo-notifications permission API, returns grant status
3. **getNotificationToken()** — gets Expo push token
4. **storeNotificationToken(userId, token)** — writes token to Firestore user document
5. **handleNotificationReceived(notification)** — processes incoming notification
6. **handleNotificationTapped(notification)** — handles navigation on notification tap
7. **markNotificationsAsRead(userId)** — batch updates notification documents
8. **markSingleNotificationAsRead(notificationId)** — updates single notification

Mock expo-notifications (already in jest.setup.js) and expo-secure-store. Test permission granted vs denied for requestNotificationPermission. Test notification routing in handleNotificationTapped.
</action>
<verify>npm test -- --testPathPattern="accountService|notificationService" passes all tests; npm test passes full suite</verify>
<done>accountService.test.js and notificationService.test.js pass; all 4 content/account test files green; full suite green</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm test` passes all tests (existing + new content/account service tests)
- [ ] albumService.test.js covers all 8 CRUD functions
- [ ] userService.test.js covers all 8 functions including business logic
- [ ] accountService.test.js covers all 4 Cloud Function-backed functions
- [ ] notificationService.test.js covers key notification lifecycle functions
- [ ] Tests follow established patterns and use testFactories
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Content and account services have regression guards
- Business logic edge cases (username cooldown, daily limits) are tested
  </success_criteria>

<output>
After completion, create `.planning/phases/49-automated-test-suite/49-03-SUMMARY.md`
</output>
