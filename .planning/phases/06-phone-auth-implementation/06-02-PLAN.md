---
phase: 06-phone-auth-implementation
plan: 02
type: execute
domain: firebase-phone-auth
---

<objective>
Create phone authentication service and UI screens for phone number input and SMS verification.

Purpose: Build the core phone auth infrastructure - a service layer for Firebase Phone Auth operations and two new screens (PhoneInputScreen, VerificationScreen) for the user flow.
Output: Working phone auth service with phoneAuthService.js, PhoneInputScreen.js, and VerificationScreen.js.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-phone-auth-implementation/06-RESEARCH.md
@.planning/phases/06-phone-auth-implementation/06-01-SUMMARY.md

# Existing patterns to follow:
@src/services/firebase/authService.js
@src/screens/LoginScreen.js
@src/components/Button.js
@src/components/Input.js
@src/utils/validation.js

**From RESEARCH.md - Key patterns:**
- Two-step flow: PhoneInputScreen → VerificationScreen
- Validate with libphonenumber-js BEFORE calling Firebase
- E.164 format required (+[country][number])
- Auto-submit when 6 digits entered
- Resend timer (60 seconds)
- Error code mapping for user-friendly messages

**Tech decisions:**
- Use @react-native-firebase/auth (NOT Firebase JS SDK) for phone auth
- Keep Firebase JS SDK for Firestore/Storage (hybrid approach)
- Use country code picker (manual implementation, no external library)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create phoneAuthService.js</name>
  <files>src/services/firebase/phoneAuthService.js</files>
  <action>
Create new service file for phone authentication operations:

```javascript
// src/services/firebase/phoneAuthService.js
import auth from '@react-native-firebase/auth';
import { parsePhoneNumberFromString, isValidPhoneNumber } from 'libphonenumber-js';
import logger from '../../utils/logger';
```

Implement these functions:

1. `getPhoneAuthErrorMessage(errorCode)` - Map Firebase error codes to user-friendly messages:
   - auth/invalid-phone-number → "Invalid phone number format"
   - auth/missing-phone-number → "Please enter your phone number"
   - auth/quota-exceeded → "Too many attempts. Try again later"
   - auth/invalid-verification-code → "Invalid verification code"
   - auth/session-expired → "Verification expired. Request new code"
   - auth/too-many-requests → "Too many requests. Please wait"
   - auth/operation-not-allowed → "Phone authentication is not enabled"
   - default → "An error occurred. Please try again"

2. `validatePhoneNumber(phoneNumber, countryCode)` - Returns { valid, e164?, formatted?, error? }:
   - Check phoneNumber not empty
   - Use parsePhoneNumberFromString(phoneNumber, countryCode)
   - Check parsed.isValid()
   - Return { valid: true, e164: parsed.format('E.164'), formatted: parsed.formatNational() }
   - On failure return { valid: false, error: 'specific message' }

3. `sendVerificationCode(phoneNumber, countryCode)` - Returns { success, confirmation?, formattedNumber?, error? }:
   - Call validatePhoneNumber first
   - If invalid, return { success: false, error }
   - Call auth().signInWithPhoneNumber(e164)
   - Return { success: true, confirmation, formattedNumber }
   - Catch errors, log with logger.error, return { success: false, error: getPhoneAuthErrorMessage(code) }

4. `verifyCode(confirmation, code)` - Returns { success, user?, error? }:
   - Validate confirmation exists
   - Validate code is 6 digits
   - Call confirmation.confirm(code)
   - Return { success: true, user: credential.user }
   - Catch errors, return { success: false, error: getPhoneAuthErrorMessage(code) }

5. `getCurrentUser()` - Return auth().currentUser

6. `signOut()` - Return auth().signOut()

Use comprehensive logging (logger.debug on entry, logger.info on success, logger.error on failure).
  </action>
  <verify>
- File exists at src/services/firebase/phoneAuthService.js
- Exports: validatePhoneNumber, sendVerificationCode, verifyCode, getCurrentUser, signOut
- No syntax errors: `node --check src/services/firebase/phoneAuthService.js` (may fail due to imports, that's OK)
  </verify>
  <done>phoneAuthService.js created with all 6 functions, proper error handling, and logging</done>
</task>

<task type="auto">
  <name>Task 2: Create PhoneInputScreen.js</name>
  <files>src/screens/PhoneInputScreen.js</files>
  <action>
Create phone number input screen following existing LoginScreen.js patterns:

Key features:
1. Country code selector (dropdown or button showing flag emoji + code)
   - Default to US (+1)
   - Support common countries: US, UK, CA, AU, DE, FR, JP, IN, BR, MX
   - Store as { code: '+1', country: 'US', flag: 'US flag emoji' }

2. Phone number input field:
   - Use existing Input component
   - keyboardType="phone-pad"
   - Placeholder: "Phone number"
   - Clear error on change

3. "Send Code" button:
   - Use existing Button component with variant="primary"
   - Disabled when loading or phone empty
   - Shows "Sending..." when loading

4. Error display below input

5. Navigation:
   - On success, navigate to 'Verification' screen with params: { confirmation, phoneNumber: formattedNumber }
   - Back button/link to return to Login

Layout structure (follow LoginScreen style):
- SafeAreaView with light background
- KeyboardAvoidingView
- Logo "LAPSE" + subtitle
- Form section with country picker + phone input + send button
- "Already have an account? Login" link at bottom

State: phoneNumber, selectedCountry, loading, error

Handler: handleSendCode() calls sendVerificationCode from phoneAuthService
  </action>
  <verify>
- File exists at src/screens/PhoneInputScreen.js
- Imports phoneAuthService functions
- Has country selector UI (at minimum a TouchableOpacity showing country code)
- Has phone input field with proper keyboard type
- Has send code button with loading state
- Navigates to 'Verification' on success
  </verify>
  <done>PhoneInputScreen.js created with country selector, phone input, validation, and navigation to verification</done>
</task>

<task type="auto">
  <name>Task 3: Create VerificationScreen.js</name>
  <files>src/screens/VerificationScreen.js</files>
  <action>
Create SMS code verification screen:

Key features:
1. Display message: "Enter the 6-digit code sent to {phoneNumber}"
   - Get phoneNumber from route.params

2. Code input:
   - Single TextInput for 6-digit code
   - keyboardType="number-pad"
   - maxLength={6}
   - textContentType="oneTimeCode" (iOS auto-fill)
   - autoComplete="sms-otp" (Android auto-fill)
   - Large, centered styling
   - Auto-focus on mount (useEffect + inputRef.current?.focus())

3. Auto-submit:
   - When code reaches 6 digits, automatically call handleVerify()
   - Clear code on error

4. Resend timer:
   - Start at 60 seconds
   - Countdown using useEffect with setInterval
   - "Resend code in Xs" when timer > 0
   - "Resend code" button when timer = 0
   - On resend, navigate back to PhoneInput (or call sendVerificationCode again)

5. Error display

6. Loading state during verification

State: code, loading, error, resendTimer (60)

Handler: handleVerify() calls verifyCode from phoneAuthService
- On success, auth state listener in AuthContext handles navigation
- On failure, show error, clear code

Layout:
- SafeAreaView
- Title "Verify your number"
- Subtitle with phone number
- Large code input (styled prominently)
- Error message
- Resend button/timer
  </action>
  <verify>
- File exists at src/screens/VerificationScreen.js
- Receives confirmation and phoneNumber from route.params
- Has 6-digit code input with proper keyboard and auto-fill attributes
- Auto-submits when 6 digits entered
- Has resend timer counting down from 60
- Calls verifyCode from phoneAuthService
  </verify>
  <done>VerificationScreen.js created with code input, auto-submit, resend timer, and proper error handling</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] phoneAuthService.js exists with all exported functions
- [ ] PhoneInputScreen.js renders without errors
- [ ] VerificationScreen.js renders without errors
- [ ] Both screens follow existing app styling patterns
- [ ] Proper error handling throughout
- [ ] Logger used for all service operations
</verification>

<success_criteria>
- All three files created
- phoneAuthService properly integrates with @react-native-firebase/auth
- Screens use existing Button/Input components for consistency
- Phone validation uses libphonenumber-js
- Ready for Plan 03 (AuthContext integration)
</success_criteria>

<output>
After completion, create `.planning/phases/06-phone-auth-implementation/06-02-SUMMARY.md`
</output>
