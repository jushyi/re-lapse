---
phase: 06-phone-auth-implementation
plan: 03
type: execute
domain: firebase-phone-auth
---

<objective>
Integrate phone authentication into AuthContext and update navigation to include phone auth screens.

Purpose: Wire up the phone auth flow with the app's existing auth state management and navigation, enabling users to sign up/in with phone number.
Output: Working phone auth flow from PhoneInput → Verification → ProfileSetup (new users) or MainTabs (existing users).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-phone-auth-implementation/06-RESEARCH.md
@.planning/phases/06-phone-auth-implementation/06-01-SUMMARY.md
@.planning/phases/06-phone-auth-implementation/06-02-SUMMARY.md

# Files to modify:
@src/context/AuthContext.js
@src/navigation/AppNavigator.js
@src/screens/LoginScreen.js

# Reference files created in Plan 02:
@src/services/firebase/phoneAuthService.js
@src/screens/PhoneInputScreen.js
@src/screens/VerificationScreen.js

**Key integration points:**
- AuthContext needs to listen to React Native Firebase auth state (NOT Firebase JS SDK)
- Navigation must add PhoneInput and Verification screens to auth stack
- LoginScreen needs "Sign in with Phone" button
- On verification success, check if user exists in Firestore → ProfileSetup or MainTabs

**Critical consideration:**
The project uses Firebase JS SDK for Firestore/Storage. AuthContext currently listens to Firebase JS SDK's onAuthStateChanged. With React Native Firebase for phone auth, we need to:
1. Listen to @react-native-firebase/auth's onAuthStateChanged (not Firebase JS SDK)
2. Keep Firebase JS SDK for Firestore operations
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update AuthContext for phone auth</name>
  <files>src/context/AuthContext.js</files>
  <action>
Modify AuthContext to support phone authentication:

1. **Change auth state listener to React Native Firebase:**
```javascript
// REPLACE this import:
// import { onAuthStateChanged } from 'firebase/auth';
// import { auth } from '../services/firebase/firebaseConfig';

// WITH:
import auth from '@react-native-firebase/auth';
```

2. **Update useEffect auth listener:**
```javascript
useEffect(() => {
  // Use React Native Firebase auth listener
  const unsubscribe = auth().onAuthStateChanged(async (firebaseUser) => {
    // ... existing logic stays the same
  });
  return unsubscribe;
}, []);
```

3. **Add phone auth state and functions:**
```javascript
const [confirmationResult, setConfirmationResult] = useState(null);

const sendPhoneVerification = async (phoneNumber, countryCode) => {
  setLoading(true);
  try {
    const result = await sendVerificationCode(phoneNumber, countryCode);
    if (result.success) {
      setConfirmationResult(result.confirmation);
    }
    return result;
  } catch (error) {
    return { success: false, error: error.message };
  } finally {
    setLoading(false);
  }
};

const verifyPhoneCode = async (code) => {
  if (!confirmationResult) {
    return { success: false, error: 'No verification in progress' };
  }
  setLoading(true);
  try {
    const result = await verifyCode(confirmationResult, code);
    if (result.success) {
      // Check if user exists in Firestore
      const profileResult = await getUserDocument(result.user.uid);
      if (!profileResult.success) {
        // New user - create basic profile
        const userDoc = {
          uid: result.user.uid,
          phoneNumber: result.user.phoneNumber,
          email: '',
          username: `user_${Date.now()}`,
          displayName: 'New User',
          photoURL: null,
          bio: '',
          friends: [],
          profileSetupCompleted: false,
          createdAt: new Date(),
        };
        await createUserDocument(result.user.uid, userDoc);
        return { success: true, user: result.user, needsProfileSetup: true };
      }
      return { success: true, user: result.user };
    }
    return result;
  } catch (error) {
    return { success: false, error: error.message };
  } finally {
    setLoading(false);
    setConfirmationResult(null);
  }
};
```

4. **Update sign out to use React Native Firebase:**
```javascript
const signOut = async () => {
  try {
    setLoading(true);
    await auth().signOut(); // Use RN Firebase
    setUser(null);
    setUserProfile(null);
    return { success: true };
  } catch (error) {
    return { success: false, error: error.message };
  } finally {
    setLoading(false);
  }
};
```

5. **Add to context value:**
```javascript
const value = {
  user,
  userProfile,
  loading,
  initializing,
  signUp,        // Keep for now (Phase 7 removes)
  signIn,        // Keep for now (Phase 7 removes)
  signInWithApple, // Keep for now (Phase 7 removes)
  signOut,
  updateUserProfile,
  // New phone auth:
  sendPhoneVerification,
  verifyPhoneCode,
  confirmationResult,
};
```

Import sendVerificationCode and verifyCode from phoneAuthService.js at the top.
  </action>
  <verify>
- AuthContext imports auth from '@react-native-firebase/auth'
- onAuthStateChanged uses auth().onAuthStateChanged
- sendPhoneVerification function exists
- verifyPhoneCode function exists
- signOut uses auth().signOut()
- Context value includes new phone auth functions
  </verify>
  <done>AuthContext updated with React Native Firebase auth listener and phone auth functions</done>
</task>

<task type="auto">
  <name>Task 2: Update AppNavigator with phone auth screens</name>
  <files>src/navigation/AppNavigator.js</files>
  <action>
Add phone auth screens to the auth stack:

1. **Import new screens:**
```javascript
import PhoneInputScreen from '../screens/PhoneInputScreen';
import VerificationScreen from '../screens/VerificationScreen';
```

2. **Add to auth stack (when !isAuthenticated):**
```javascript
{!isAuthenticated ? (
  // Auth Stack - User not logged in
  <>
    <Stack.Screen name="Login" component={LoginScreen} />
    <Stack.Screen name="SignUp" component={SignUpScreen} />
    <Stack.Screen name="ForgotPassword" component={ForgotPasswordScreen} />
    <Stack.Screen name="PhoneInput" component={PhoneInputScreen} />
    <Stack.Screen name="Verification" component={VerificationScreen} />
  </>
) : // ... rest stays same
```

3. **Update deep linking config:**
```javascript
const linking = {
  prefixes: ['lapse://', 'com.lapseclone.app://'],
  config: {
    screens: {
      // ... existing screens
      PhoneInput: 'phone-input',
      Verification: 'verification',
    },
  },
};
```
  </action>
  <verify>
- PhoneInputScreen and VerificationScreen imported
- Both screens added to auth stack
- Deep linking config includes phone-input and verification routes
  </verify>
  <done>AppNavigator updated with phone auth screens in auth stack</done>
</task>

<task type="auto">
  <name>Task 3: Add phone sign-in option to LoginScreen</name>
  <files>src/screens/LoginScreen.js</files>
  <action>
Add "Sign in with Phone" button to LoginScreen:

1. **Add navigation to phone input:**
```javascript
const handlePhoneSignIn = () => {
  navigation.navigate('PhoneInput');
};
```

2. **Add button after Apple Sign In button (before signup text):**
```jsx
<Button
  title="Sign in with Phone"
  variant="secondary"
  onPress={handlePhoneSignIn}
/>
```

The button order should be:
1. Login (email/password)
2. OR divider
3. Sign in with Apple
4. Sign in with Phone
5. "Don't have an account? Sign Up"

This keeps phone auth visible but secondary to existing methods during transition. Phase 7 will make phone auth primary and remove email/Apple options.
  </action>
  <verify>
- LoginScreen has handlePhoneSignIn function
- "Sign in with Phone" button renders
- Button navigates to 'PhoneInput' screen
  </verify>
  <done>LoginScreen updated with "Sign in with Phone" button</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete phone authentication flow: PhoneInput → Verification → App</what-built>
  <how-to-verify>
**IMPORTANT:** This requires a development build (not Expo Go) because React Native Firebase uses native modules.

1. Build development client:
   ```bash
   npx expo run:ios
   # OR for Android:
   npx expo run:android
   ```

   First build will take 10-15 minutes. Subsequent builds are faster.

2. Once the dev build is running, test the flow:
   - Open app → Login screen
   - Tap "Sign in with Phone"
   - Enter a test phone number (if configured in Firebase) or real number
   - Tap "Send Code"
   - Enter the 6-digit code
   - Should navigate to ProfileSetup (new user) or MainTabs (existing)

3. Verify error handling:
   - Try invalid phone format → Should show validation error
   - Try wrong verification code → Should show "Invalid verification code"

4. Verify resend timer:
   - On verification screen, timer counts down from 60
   - After 60s, "Resend code" button is enabled

**If using Expo Go:** The app will crash on phone auth calls. This is expected - React Native Firebase requires native modules.
  </how-to-verify>
  <resume-signal>Type "approved" if phone auth flow works, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] AuthContext uses React Native Firebase auth listener
- [ ] sendPhoneVerification and verifyPhoneCode work correctly
- [ ] Phone auth screens accessible from LoginScreen
- [ ] New users go to ProfileSetup after verification
- [ ] Existing users go to MainTabs after verification
- [ ] Error states handled gracefully
</verification>

<success_criteria>
- Complete phone auth flow working end-to-end
- AuthContext properly manages phone auth state
- Navigation correctly routes authenticated users
- Phase 6 complete - ready for Phase 7 (Legacy Auth Removal)
</success_criteria>

<output>
After completion, create `.planning/phases/06-phone-auth-implementation/06-03-SUMMARY.md`
</output>
