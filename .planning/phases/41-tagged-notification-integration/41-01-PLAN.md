---
phase: 41-tagged-notification-integration
plan: 01
type: execute
---

<objective>
Connect photo tagging to the notification system — add user-facing settings toggle and handle tag removal cancellation.

Purpose: Complete the tagged notification integration by filling the two remaining gaps: users need a UI toggle to control tag notifications (the Cloud Function already checks `prefs.tags` but no toggle exists), and removing a tag during the debounce window should cancel the pending notification.
Output: Notification settings toggle for "Tagged in Photos", tag removal cancellation in Cloud Function.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-tagged-notification-integration/41-CONTEXT.md
@.planning/phases/36-photo-notification-events/36-02-SUMMARY.md
@.planning/phases/36-photo-notification-events/TAGGING-SCHEMA.md
@.planning/phases/39-darkroom-tagging/39-01-SUMMARY.md

# Key files:

@src/screens/NotificationSettingsScreen.js
@functions/index.js

**Tech stack available:** expo-server-sdk, Cloud Functions, Firestore triggers
**Established patterns:** NOTIFICATION_TYPES array + DEFAULT_PREFERENCES object for settings toggles, pendingTags object with setTimeout for debouncing, `prefs.tags !== false` preference checking
**Constraining decisions:**

- Phase 36-02: 30-second debounce window, `prefs.tags` preference key, pendingKey format `${taggerId}_${taggedUserId}`
- Phase 39: Tags written to Firestore at triage completion (not individually), Cloud Function triggers automatically
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Add "Tagged in Photos" notification settings toggle</name>
  <files>src/screens/NotificationSettingsScreen.js</files>
  <action>
Add the tags notification type to the settings screen:

1. Add `tags: true` to `DEFAULT_PREFERENCES` object (after `mentions: true`)

2. Add a new entry to `NOTIFICATION_TYPES` array (after the mentions entry):
   ```
   {
     id: 'tags',
     icon: 'pricetag-outline',
     label: 'Tagged in Photos',
     subtitle: 'When someone tags you in a photo',
   }
   ```

This follows the exact same pattern as all other notification types. The Cloud Function already checks `prefs.tags !== false` (functions/index.js:1339), so this toggle will immediately control tag notification delivery.

3. Update the comment on line 1338 of functions/index.js from "Tags fall under a general social category - could add specific 'tags' preference later" to "Tags preference controlled via NotificationSettingsScreen toggle" since the toggle now exists.
   </action>
   <verify>Open NotificationSettingsScreen in the app — verify 6 notification type toggles appear (Likes, Comments, Follows, Friend Requests, Mentions, Tagged in Photos). Toggle "Tagged in Photos" off, verify it saves to Firestore notificationPreferences.tags = false.</verify>
   <done>Tagged in Photos toggle appears in notification settings with pricetag-outline icon. Toggling saves `tags` preference to Firestore. Cloud Function comment updated.</done>
   </task>

<task type="auto">
  <name>Task 2: Handle tag removal cancellation in Cloud Function</name>
  <files>functions/index.js</files>
  <action>
In the `sendTaggedPhotoNotification` Cloud Function, add tag removal detection AFTER the existing newlyTaggedUserIds check (after line 1284, before the early return is fine — but this logic should run even when there are no new tags):

1. Before the `newlyTaggedUserIds.length === 0` early return, compute removed tags:

   ```
   const removedTaggedUserIds = beforeTaggedUserIds.filter(id => !afterTaggedUserIds.includes(id));
   ```

2. For each removed user ID, check if there's a pending debounce and cancel it:

   ```
   for (const removedUserId of removedTaggedUserIds) {
     const pendingKey = `${after.userId}_${removedUserId}`;
     if (pendingTags[pendingKey]) {
       clearTimeout(pendingTags[pendingKey].timeout);
       // Remove the photoId from the pending batch
       const idx = pendingTags[pendingKey].photoIds.indexOf(photoId);
       if (idx !== -1) {
         pendingTags[pendingKey].photoIds.splice(idx, 1);
       }
       // If no photos left in batch, delete the entire pending entry
       if (pendingTags[pendingKey].photoIds.length === 0) {
         delete pendingTags[pendingKey];
         logger.debug('sendTaggedPhotoNotification: Cancelled pending notification (all photos untagged)', {
           pendingKey,
           removedUserId,
         });
       } else {
         // Restart debounce timer with remaining photos
         pendingTags[pendingKey].timeout = setTimeout(
           () => sendBatchedTagNotification(pendingKey),
           TAG_DEBOUNCE_MS
         );
         logger.debug('sendTaggedPhotoNotification: Removed photo from pending batch', {
           pendingKey,
           removedPhotoId: photoId,
           remainingCount: pendingTags[pendingKey].photoIds.length,
         });
       }
     }
   }
   ```

3. Place this cancellation logic BEFORE the `newlyTaggedUserIds.length === 0` return so it runs even when only removals happen (no new tags). The existing new-tag logic continues unchanged after.

Do NOT change any other part of the Cloud Function — the debounce, batching, template, and notification storage logic remain exactly the same.
</action>
<verify>Deploy functions with `cd functions && npm run deploy` (or `firebase deploy --only functions:sendTaggedPhotoNotification`). Check Firebase console logs to confirm function deployed successfully.</verify>
<done>Cloud Function handles tag removals by cancelling pending debounce timeouts for removed users. If all photos untagged, entire pending entry deleted. If partial removal, batch continues with remaining photos.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] NotificationSettingsScreen shows 6 toggle types including "Tagged in Photos"
- [ ] Tags preference toggle saves to Firestore `notificationPreferences.tags`
- [ ] Cloud Function deployed with tag removal cancellation logic
- [ ] No errors in `npx expo start` or Cloud Function logs
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors introduced
- Tagged in Photos toggle controls notification delivery
- Tag removal within 30-second debounce window cancels pending notification
- Phase 41 complete — v1.7 milestone complete
  </success_criteria>

<output>
After completion, create `.planning/phases/41-tagged-notification-integration/41-01-SUMMARY.md`
</output>
