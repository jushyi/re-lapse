---
phase: 15.3-ultra-wide-zoom
plan: 01
type: execute
---

<objective>
Implement true 0.5x ultra-wide zoom by switching to the physical ultra-wide lens on iOS devices that support it.

Purpose: Enable native 0.5x zoom using device hardware instead of digital zoom, providing higher quality ultra-wide shots.
Output: CameraScreen with dynamic 0.5x zoom option that appears only on iOS devices with ultra-wide lens support.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15.3-ultra-wide-zoom/15.3-RESEARCH.md
@src/screens/CameraScreen.js

**Tech stack available:** expo-camera (already has selectedLens prop on iOS)
**Established patterns:** ZOOM_LEVELS constant drives zoom bar UI, handleZoomChange switches zoom level
**Constraining decisions:**
- Phase 15.2: Current zoom bar shows 1x, 2x, 3x with cameraZoom values
- Research: iOS-only feature via expo-camera selectedLens prop

**Key findings from research:**
- expo-camera added `selectedLens` prop and `getAvailableLensesAsync()` in April 2025 (PR #36233)
- iOS-only - Android has no equivalent in expo-camera
- Ultra-wide lens string: Check for "UltraWide" or "ultrawide" in available lenses array
- When using ultra-wide lens, set cameraZoom to 0 (lens is the zoom, not digital)
- Front camera typically doesn't have ultra-wide - only show 0.5x on back camera

**Pitfalls to avoid (from research):**
- Don't show 0.5x before capability check completes (UI flash)
- Don't hardcode device names - use API detection
- Reset to 1x when switching to front camera (no ultra-wide on front)
- Set cameraZoom to 0 when using ultra-wide lens
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add lens capability detection and state management</name>
  <files>src/screens/CameraScreen.js</files>
  <action>
Add state and capability detection for ultra-wide lens:

1. Add new state variables after existing useState declarations:
   - `const [availableLenses, setAvailableLenses] = useState([]);`
   - `const [selectedLens, setSelectedLens] = useState(null);`
   - `const [hasUltraWide, setHasUltraWide] = useState(false);`

2. Add Platform import at top: `import { Platform } from 'react-native';`

3. Add `onAvailableLensesChanged` callback handler that:
   - Only processes on iOS (`Platform.OS === 'ios'`)
   - Sets availableLenses from event.lenses
   - Detects ultra-wide: `event.lenses.some(lens => lens.toLowerCase().includes('ultrawide'))`
   - Sets hasUltraWide state accordingly
   - Logs available lenses for debugging

4. When `facing` changes to 'front', reset selectedLens to null (ultra-wide is back-camera only)

IMPORTANT: Initialize state with defaults that hide 0.5x until capability check completes (prevents UI flash).
  </action>
  <verify>
No runtime errors when app starts.
Log statement shows available lenses on camera load (on iOS simulator or device).
  </verify>
  <done>
- availableLenses, selectedLens, hasUltraWide state added
- onAvailableLensesChanged handler added
- Platform import present
- Front camera switch resets selectedLens
  </done>
</task>

<task type="auto">
  <name>Task 2: Update zoom levels to include dynamic 0.5x option</name>
  <files>src/screens/CameraScreen.js</files>
  <action>
Modify ZOOM_LEVELS to dynamically include 0.5x when ultra-wide is available:

1. Rename current ZOOM_LEVELS constant to ZOOM_LEVELS_BASE (move inside component or keep outside):
   ```javascript
   const ZOOM_LEVELS_BASE = [
     { label: '1', value: 1, lens: null, cameraZoom: 0 },
     { label: '2', value: 2, lens: null, cameraZoom: 0.17 },
     { label: '3', value: 3, lens: null, cameraZoom: 0.33 },
   ];
   ```

2. Add ULTRA_WIDE_LEVEL constant:
   ```javascript
   // Lens string from iOS AVFoundation - will be matched against actual values
   const ULTRA_WIDE_LEVEL = {
     label: '0.5',
     value: 0.5,
     lens: 'ultra-wide', // Marker - actual lens string comes from availableLenses
     cameraZoom: 0, // Ultra-wide uses native lens, not digital zoom
   };
   ```

3. Use useMemo to build dynamic zoom levels inside component:
   ```javascript
   const zoomLevels = useMemo(() => {
     // Only show 0.5x on iOS, with ultra-wide support, on back camera
     if (Platform.OS === 'ios' && hasUltraWide && facing === 'back') {
       // Find the actual ultra-wide lens string from availableLenses
       const ultraWideLens = availableLenses.find(lens =>
         lens.toLowerCase().includes('ultrawide')
       );
       return [
         { ...ULTRA_WIDE_LEVEL, lens: ultraWideLens },
         ...ZOOM_LEVELS_BASE,
       ];
     }
     return ZOOM_LEVELS_BASE;
   }, [hasUltraWide, facing, availableLenses]);
   ```

4. Add useMemo import at top if not present

5. Update handleZoomChange to also set selectedLens when changing zoom:
   ```javascript
   const handleZoomChange = (zoomLevel) => {
     if (zoomLevel.value !== zoom.value) {
       lightImpact();
       setZoom(zoomLevel);
       // Set lens for ultra-wide, null for standard zoom
       if (Platform.OS === 'ios') {
         setSelectedLens(zoomLevel.lens || null);
       }
       logger.debug('CameraScreen: Zoom level changed', {
         zoom: zoomLevel.value,
         lens: zoomLevel.lens
       });
     }
   };
   ```

6. Update zoom bar to iterate over `zoomLevels` (the memo) instead of `ZOOM_LEVELS`:
   Change `ZOOM_LEVELS.map((level) => {` to `zoomLevels.map((level) => {`

7. When facing changes, if current zoom is 0.5x and we're switching to front camera, reset to 1x:
   Update the toggleCameraFacing function to check and reset zoom if needed.
  </action>
  <verify>
- On iOS device with ultra-wide: zoom bar shows 0.5x, 1x, 2x, 3x on back camera
- On front camera: zoom bar shows 1x, 2x, 3x (no 0.5x)
- On Android: zoom bar shows 1x, 2x, 3x (no 0.5x)
  </verify>
  <done>
- ZOOM_LEVELS_BASE constant defined
- ULTRA_WIDE_LEVEL constant defined
- zoomLevels useMemo with platform/capability checks
- handleZoomChange sets selectedLens
- Zoom bar uses dynamic zoomLevels
- Front camera switch resets to 1x if was on 0.5x
  </done>
</task>

<task type="auto">
  <name>Task 3: Connect selectedLens to CameraView component</name>
  <files>src/screens/CameraScreen.js</files>
  <action>
Wire up the selectedLens prop to CameraView:

1. Add onAvailableLensesChanged callback to CameraView:
   ```jsx
   <CameraView
     ref={cameraRef}
     style={styles.camera}
     facing={facing}
     flash={flash}
     zoom={zoom.cameraZoom}
     onAvailableLensesChanged={(event) => {
       if (Platform.OS === 'ios') {
         logger.debug('CameraScreen: Available lenses', { lenses: event.lenses });
         setAvailableLenses(event.lenses);
         const hasUW = event.lenses.some(lens =>
           lens.toLowerCase().includes('ultrawide')
         );
         setHasUltraWide(hasUW);
       }
     }}
     {...(Platform.OS === 'ios' && selectedLens && { selectedLens })}
   />
   ```

2. The spread operator `{...}` conditionally adds selectedLens only on iOS when a lens is selected.
   This prevents passing undefined or causing issues on Android.

3. When user taps 0.5x, the flow is:
   - handleZoomChange sets zoom state (with lens property)
   - handleZoomChange sets selectedLens to the ultra-wide lens string
   - CameraView receives selectedLens prop
   - iOS switches to physical ultra-wide lens

4. Ensure the component handles the lens switching gracefully - there may be a brief flash during lens change (this is iOS native behavior, not something we control).
  </action>
  <verify>
Test on iOS device with ultra-wide lens (iPhone 11 or newer):
1. Open camera on back camera
2. Verify 0.5x option appears in zoom bar
3. Tap 0.5x - camera should switch to ultra-wide lens (wider field of view)
4. Tap 1x - camera should switch back to standard wide lens
5. Switch to front camera - 0.5x option should disappear
6. Switch back to back camera - 0.5x option should reappear
  </verify>
  <done>
- CameraView has onAvailableLensesChanged callback
- CameraView receives selectedLens prop conditionally
- Tapping 0.5x switches to ultra-wide lens
- Tapping 1x switches back to standard lens
- No errors on Android (selectedLens not passed)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>True 0.5x ultra-wide zoom using physical lens switching on iOS</what-built>
  <how-to-verify>
    1. Start the app in Expo Go or standalone build on iOS device with ultra-wide camera (iPhone 11+)
    2. Open Camera tab
    3. Verify zoom bar shows: 0.5x, 1x, 2x, 3x
    4. Tap 0.5x - verify camera switches to wider field of view (ultra-wide lens)
    5. Take a photo at 0.5x - verify photo captures the wide angle
    6. Tap 1x - verify camera returns to standard view
    7. Switch to front camera - verify 0.5x option disappears
    8. Switch back to back camera - verify 0.5x option reappears
    9. If testing on Android: verify app works normally with 1x, 2x, 3x (no 0.5x shown)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] App starts without errors on iOS
- [ ] App starts without errors on Android
- [ ] 0.5x option visible on iOS devices with ultra-wide lens (back camera only)
- [ ] 0.5x not visible on front camera
- [ ] 0.5x not visible on Android
- [ ] Tapping 0.5x actually switches to ultra-wide lens (visibly wider view)
- [ ] Photos captured at 0.5x use the ultra-wide field of view
- [ ] No UI flash when switching cameras
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- iOS users with ultra-wide cameras can use true 0.5x zoom
- Android users unaffected (app works normally, no 0.5x option)
- No runtime errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/15.3-ultra-wide-zoom/15.3-01-SUMMARY.md`:

# Phase 15.3 Plan 01: True 0.5x Ultra-Wide Zoom Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `src/screens/CameraScreen.js` - Added lens detection and switching

## Decisions Made

[Any decisions made during implementation]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

[Ready for Phase 16: Camera Capture Feedback]
</output>
