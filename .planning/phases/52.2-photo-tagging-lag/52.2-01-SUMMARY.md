---
phase: 52.2-photo-tagging-lag
plan: 01
subsystem: ui
tags: [firestore, real-time, subscriptions, flatlist, photo-tagging]

# Dependency graph
requires:
  - phase: 52-02
    provides: UAT testing that identified ISS-016
provides:
  - Real-time photo subscription pattern for live data updates
  - FlatList extraData fix for external state re-rendering
  - Instant tag updates across all photo views
affects: [photo-detail, tagging, darkroom]

# Tech tracking
tech-stack:
  added: []
  patterns: [firestore-subscriptions, flatlist-extradata]

key-files:
  created: []
  modified:
    - src/services/firebase/photoService.js
    - src/components/TagFriendsModal.js
    - src/screens/PhotoDetailScreen.js

key-decisions:
  - 'Use subscribePhoto in PhotoDetailScreen (not TagFriendsModal) - keeps modal simple, parent owns data'
  - 'Follow feedService subscription pattern for consistency'

patterns-established:
  - 'Photo subscription pattern: subscribePhoto(photoId, callback) returns unsubscribe function'
  - 'FlatList extraData for external state dependencies'

issues-created: []

# Metrics
duration: 3min
completed: 2026-02-14
---

# Phase 52.2 Plan 01: Fix Photo Tagging Lag Summary

**Fixed photo tag state sync with real-time Firestore subscriptions and FlatList extraData - tags now update instantly across all views**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-14T04:57:02Z
- **Completed:** 2026-02-14T05:00:12Z
- **Tasks:** 3
- **Files modified:** 3

## Accomplishments

- Added subscribePhoto service function for real-time photo updates following feedService pattern
- Fixed FlatList re-rendering in TagFriendsModal with extraData prop
- Added photo subscription to PhotoDetailScreen for live tag/reaction updates
- ISS-016 resolved - tags now sync instantly when reopening tag sheet

## Task Commits

Each task was committed atomically:

1. **Task 1: Add photo subscription service function** - `f6bcce3` (feat)
2. **Task 2: Add FlatList extraData to TagFriendsModal** - `e2ee031` (fix)
3. **Task 3: Subscribe to photo in PhotoDetailScreen** - `34f8832` (feat)

## Files Created/Modified

- `src/services/firebase/photoService.js` - Added subscribePhoto(photoId, callback) function with onSnapshot pattern, returns unsubscribe for cleanup
- `src/components/TagFriendsModal.js` - Added extraData={selectedIds} to FlatList (line 217) to force re-render when selection changes
- `src/screens/PhotoDetailScreen.js` - Added useEffect hook subscribing to contextPhoto.id, updates context via updateCurrentPhoto when Firestore changes

## Decisions Made

- **PhotoDetailScreen subscription (not TagFriendsModal)** - Parent screen owns data and subscribes to changes; modal receives fresh initialSelectedIds each time it opens. Keeps modal simple and stateless.
- **Follow feedService pattern** - subscribePhoto uses same onSnapshot callback pattern as subscribeFeedPhotos for consistency across codebase
- **No user data hydration in subscribePhoto** - Keep service function simple, return photo document only. Parent components can hydrate user data if needed.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

**1. ESLint error on first commit attempt (Task 3)**

- **Issue:** Used non-existent `setCurrentPhoto` - PhotoDetailScreen uses context, not local state
- **Resolution:** Changed to `updateCurrentPhoto(result.photo)` from PhotoDetailContext, fixed `currentPhoto` references to `contextPhoto`
- **Verification:** ESLint passed, commit succeeded on retry

## Next Phase Readiness

- ISS-016 fix ready for UAT verification
- Test case: Tag someone in photo → close tag sheet → reopen → checkmark should appear instantly
- Tag badges should update in real-time across feed, story mode, and photo detail views
- DarkroomScreen may need subscription if tagging photos in darkroom stack - defer to UAT testing

---

_Phase: 52.2-photo-tagging-lag_
_Completed: 2026-02-14_
