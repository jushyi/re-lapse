# Phase 21.3: App Crashes When Inputting Phone Number - Research

**Researched:** 2026-01-24
**Domain:** Firebase Phone Authentication crash diagnosis on iOS with React Native/Expo
**Confidence:** HIGH

<research_summary>

## Summary

Researched the React Native Firebase phone authentication crash ecosystem to understand why the app crashes when inputting phone numbers. Based on investigation of the codebase and multiple GitHub issues, the crash is likely caused by one of several known issues with `signInWithPhoneNumber` on iOS:

1. **Swift assertion failure in PhoneAuthProvider** - A known crash (EXC_BREAKPOINT) occurs in Firebase's `PhoneAuthProvider.verifyPhoneNumber` at line 112, particularly with Expo SDK 52+ and New Architecture enabled
2. **useState serialization crash** - Storing the ConfirmationResult object directly in React state causes iOS to crash (SIGABRT) because the object contains non-serializable functions
3. **Missing reCAPTCHA URL scheme configuration** - Without the REVERSED_CLIENT_ID URL scheme, the reCAPTCHA fallback flow crashes
4. **APNs/Silent push not configured** - When silent APNs can't be used and reCAPTCHA fallback isn't properly set up

The codebase currently uses `@react-native-firebase/auth` v23.8.2 with Expo 54, which is a newer version than most reported crash issues. The code stores the confirmation object in navigation params (passed to VerificationScreen), which may trigger serialization issues.

**Primary recommendation:** Investigate the URL scheme configuration for reCAPTCHA in app.json, check if confirmation object storage is causing crashes, and consider using useRef instead of state/params for the confirmation object.
</research_summary>

<standard_stack>

## Standard Stack

The current project already uses the established libraries for this domain:

### Core

| Library                     | Version | Purpose                            | Why Standard                                    |
| --------------------------- | ------- | ---------------------------------- | ----------------------------------------------- |
| @react-native-firebase/auth | 23.8.2  | Native Firebase phone auth         | Official React Native Firebase SDK              |
| @react-native-firebase/app  | 23.8.2  | Firebase core                      | Required base for all Firebase services         |
| libphonenumber-js           | 1.12.34 | Phone number validation/formatting | Google's libphonenumber port, industry standard |
| expo-build-properties       | 1.0.10  | Native build configuration         | Required for useFrameworks: static              |

### Supporting

| Library         | Version | Purpose                            | When to Use                     |
| --------------- | ------- | ---------------------------------- | ------------------------------- |
| expo-dev-client | 6.0.20  | Development client for native code | Required for testing phone auth |

### Configuration Plugins Required

| Plugin                      | Purpose                            | Status in Project |
| --------------------------- | ---------------------------------- | ----------------- |
| @react-native-firebase/app  | Firebase iOS configuration         | Present           |
| @react-native-firebase/auth | Phone auth reCAPTCHA setup for iOS | Present           |
| expo-build-properties       | useFrameworks: static for Firebase | Present           |

**Current app.json plugins (verified):**

```json
"plugins": [
  "@react-native-firebase/app",
  "@react-native-firebase/auth",
  ["expo-build-properties", {
    "ios": { "useFrameworks": "static" }
  }]
]
```

</standard_stack>

<architecture_patterns>

## Architecture Patterns

### Current Project Implementation

```
src/
├── screens/
│   ├── PhoneInputScreen.js    # Phone number entry, calls sendVerificationCode
│   └── VerificationScreen.js  # 6-digit code entry, calls verifyCode
├── services/firebase/
│   └── phoneAuthService.js    # signInWithPhoneNumber, verifyCode
└── utils/
    └── phoneUtils.js          # Phone formatting utilities
```

### Pattern 1: Confirmation Object Handling (CRITICAL)

**What:** Store Firebase ConfirmationResult in useRef instead of state or navigation params
**When to use:** Always for phone auth confirmation objects
**Current code (potentially problematic):**

```javascript
// PhoneInputScreen.js:93-97 - passes confirmation in navigation params
navigation.navigate('Verification', {
  confirmation: result.confirmation, // <-- PROBLEM: May crash on iOS
  phoneNumber: result.formattedNumber,
  e164: result.e164,
});
```

**Recommended pattern (from GitHub issue #8122):**

```javascript
// Use useRef to avoid serialization crash
const confirmationRef = useRef(null);

// In handleSendCode:
confirmationRef.current = result.confirmation;
navigation.navigate('Verification', {
  phoneNumber: result.formattedNumber,
  e164: result.e164,
});

// Pass confirmationRef through context or global state
```

### Pattern 2: URL Scheme Configuration for reCAPTCHA

**What:** Add REVERSED_CLIENT_ID from GoogleService-Info.plist to URL schemes
**When to use:** Required for iOS reCAPTCHA fallback flow
**Current app.json:**

```json
"CFBundleURLTypes": [
  {
    "CFBundleURLSchemes": [
      "com.googleusercontent.apps.958995611148-k8nl243l2h21n9sh0ugss4ad6qbldk7a"
    ]
  }
]
```

**Note:** This appears to be configured correctly. Need to verify this matches REVERSED_CLIENT_ID in GoogleService-Info.plist.

### Pattern 3: APNs Silent Push for App Verification

**What:** Configure APNs to enable automatic app verification (no reCAPTCHA needed)
**When to use:** Production iOS apps to avoid reCAPTCHA flow entirely
**Current app.json:**

```json
"ios": {
  "entitlements": {
    "aps-environment": "development"
  },
  "infoPlist": {
    "UIBackgroundModes": ["remote-notification"]
  }
}
```

**Note:** This configuration looks correct for APNs silent push.

### Anti-Patterns to Avoid

- **Passing confirmation object in navigation params:** Causes serialization crash on iOS
- **Storing ConfirmationResult in useState:** Non-serializable object crashes React on iOS
- **Missing URL scheme for reCAPTCHA:** Crashes when silent push isn't available
- **Not handling reCAPTCHA redirect:** Expo Router redirects to `/firebaseauth/link` unexpectedly
  </architecture_patterns>

<dont_hand_roll>

## Don't Hand-Roll

| Problem                     | Don't Build       | Use Instead                 | Why                                          |
| --------------------------- | ----------------- | --------------------------- | -------------------------------------------- |
| Phone number validation     | Custom regex      | libphonenumber-js           | International format complexity, edge cases  |
| Phone auth flow             | Custom OTP system | @react-native-firebase/auth | Security, rate limiting, carrier integration |
| reCAPTCHA verification      | Custom captcha    | Firebase built-in reCAPTCHA | Already integrated with phone auth flow      |
| Confirmation object storage | React state       | useRef or context           | Serialization issues cause iOS crashes       |

**Key insight:** Firebase phone auth on iOS requires specific native configuration. The crash is almost certainly a configuration or object serialization issue, not a code logic problem. Don't try to work around Firebase's phone auth - fix the configuration.
</dont_hand_roll>

<common_pitfalls>

## Common Pitfalls

### Pitfall 1: ConfirmationResult in React State (LIKELY CAUSE)

**What goes wrong:** iOS crashes with SIGABRT when storing signInWithPhoneNumber result in useState or passing through navigation params
**Why it happens:** ConfirmationResult contains non-serializable functions; React/React Navigation tries to serialize
**How to avoid:** Use useRef to store confirmation object, not state or navigation params
**Warning signs:** Crash occurs after successful signInWithPhoneNumber call, before navigation completes
**Source:** [GitHub Issue #8122](https://github.com/invertase/react-native-firebase/issues/8122)

### Pitfall 2: Swift Assertion Failure (EXC_BREAKPOINT)

**What goes wrong:** App crashes with EXC_BREAKPOINT in PhoneAuthProvider.verifyPhoneNumber
**Why it happens:** Known issue with Expo 52+ and New Architecture enabled, related to Firebase SDK internals
**How to avoid:**

- Update to latest @react-native-firebase/auth
- Disable New Architecture if needed for testing
- Use test phone numbers for development
  **Warning signs:** Crash in native code, no JavaScript error, stack trace shows Swift assertion
  **Source:** [GitHub Issue #8535](https://github.com/invertase/react-native-firebase/issues/8535)

### Pitfall 3: Missing URL Scheme for reCAPTCHA

**What goes wrong:** reCAPTCHA verification cannot complete, app crashes or hangs
**Why it happens:** REVERSED_CLIENT_ID URL scheme not configured in Info.plist/app.json
**How to avoid:** Add URL scheme matching REVERSED_CLIENT_ID from GoogleService-Info.plist
**Warning signs:** reCAPTCHA appears but doesn't complete, crash after captcha solve
**Source:** [Firebase iOS Phone Auth Docs](https://firebase.google.com/docs/auth/ios/phone-auth)

### Pitfall 4: APNs Not Configured

**What goes wrong:** Firebase falls back to reCAPTCHA on every auth attempt
**Why it happens:** Silent push notifications can't be received to verify app
**How to avoid:**

- Upload APNs authentication key to Firebase console
- Add Background Modes: remote-notification
- Add Push Notifications capability
  **Warning signs:** reCAPTCHA always shows, even on real device with background refresh enabled
  **Source:** [Firebase APNs Setup](https://firebase.google.com/docs/auth/ios/phone-auth)

### Pitfall 5: TestFlight/Production Build Differences

**What goes wrong:** Works in debug, crashes in TestFlight/production builds
**Why it happens:** Code optimization/minification affects native Firebase bindings
**How to avoid:** Test on production builds locally before TestFlight submission
**Warning signs:** Error: "NSInvalidArgumentException: -[__NSFrozenDictionaryM length]"
**Source:** [GitHub Issue #31721](https://github.com/expo/expo/issues/31721)
</common_pitfalls>

<code_examples>

## Code Examples

### Fix: Use useRef for Confirmation Object

```javascript
// Source: GitHub Issue #8122 workaround
// PhoneInputScreen.js - Store confirmation in ref, not navigation params

import { useRef, createContext, useContext } from 'react';

// Create a context for sharing the confirmation ref
export const PhoneAuthContext = createContext(null);

const PhoneInputScreen = ({ navigation }) => {
  const confirmationRef = useRef(null);

  const handleSendCode = async () => {
    const result = await sendVerificationCode(phoneNumber, countryCode);

    if (result.success) {
      // Store in ref instead of passing through navigation
      confirmationRef.current = result.confirmation;

      // Navigate without confirmation object
      navigation.navigate('Verification', {
        phoneNumber: result.formattedNumber,
        e164: result.e164,
        // confirmationRef will be accessed via context
      });
    }
  };

  // Provide ref through context
  return (
    <PhoneAuthContext.Provider value={confirmationRef}>
      {/* ... rest of component */}
    </PhoneAuthContext.Provider>
  );
};
```

### Verify URL Scheme Configuration

```javascript
// Check GoogleService-Info.plist for REVERSED_CLIENT_ID
// This should match what's in app.json CFBundleURLSchemes

// Example: If GoogleService-Info.plist contains:
// <key>REVERSED_CLIENT_ID</key>
// <string>com.googleusercontent.apps.958995611148-xxxxx</string>

// Then app.json should have:
// "CFBundleURLSchemes": ["com.googleusercontent.apps.958995611148-xxxxx"]
```

### Test Phone Numbers (Firebase Console)

```javascript
// For development, add test numbers in Firebase Console > Authentication > Phone
// These bypass real SMS and reCAPTCHA

// Example test configuration:
// Phone: +1 650-555-1234
// Code: 123456

// In code:
const testPhoneNumber = '+16505551234'; // For development only
```

### Debug Logging for Crash Investigation

```javascript
// Add detailed logging around signInWithPhoneNumber
const sendVerificationCode = async (phoneNumber, countryCode) => {
  logger.info('phoneAuthService: Starting signInWithPhoneNumber', {
    phoneNumber: `${phoneNumber.slice(0, 3)}***`,
    countryCode,
  });

  try {
    const auth = getAuth();
    logger.debug('phoneAuthService: Got auth instance', {
      currentUser: !!auth.currentUser,
    });

    // This is where the crash likely occurs
    logger.debug('phoneAuthService: Calling signInWithPhoneNumber...');
    const confirmation = await signInWithPhoneNumber(auth, e164Number);
    logger.info('phoneAuthService: signInWithPhoneNumber succeeded');

    return { success: true, confirmation };
  } catch (error) {
    // If we get here, it's a handled error, not a crash
    logger.error('phoneAuthService: signInWithPhoneNumber failed', {
      code: error.code,
      message: error.message,
    });
    return { success: false, error: getPhoneAuthErrorMessage(error.code) };
  }
};
```

</code_examples>

<sota_updates>

## State of the Art (2025-2026)

| Old Approach                  | Current Approach                      | When Changed | Impact                                        |
| ----------------------------- | ------------------------------------- | ------------ | --------------------------------------------- |
| expo-firebase-recaptcha       | @react-native-firebase/auth plugin    | 2023         | Plugin auto-configures reCAPTCHA for iOS      |
| Firebase JS SDK phone auth    | React Native Firebase native          | 2024         | Native SDKs more reliable, no webview captcha |
| Expo Go for phone auth        | expo-dev-client required              | Always       | Native code required for phone auth           |
| Passing objects in nav params | Use refs/context for non-serializable | 2025         | Fixes iOS serialization crashes               |

**New patterns to consider:**

- **useRef for confirmation objects:** Standard pattern now for phone auth
- **Test phone numbers:** Development should always use Firebase test numbers
- **APNs over reCAPTCHA:** Configure APNs properly to avoid captcha friction

**Known issues with current versions:**

- Expo 52+ with New Architecture: Some reports of EXC_BREAKPOINT crashes
- @react-native-firebase/auth 22-23.x: Confirmation object serialization issues persist
- TestFlight builds: May behave differently than debug builds
  </sota_updates>

<diagnosis_checklist>

## Diagnosis Checklist for This Crash

Execute these checks to identify the exact cause:

### 1. Verify URL Scheme Configuration

- [ ] Read GoogleService-Info.plist (securely, locally)
- [ ] Extract REVERSED_CLIENT_ID value
- [ ] Verify it matches CFBundleURLSchemes in app.json
- [ ] Check for typos or mismatches

### 2. Check Confirmation Object Handling

- [ ] Review PhoneInputScreen.js navigation.navigate call
- [ ] Confirm whether confirmation object is passed in params
- [ ] If yes, this is likely the crash cause

### 3. Verify APNs Configuration

- [ ] Check Firebase Console > Project Settings > Cloud Messaging > APNs
- [ ] Verify APNs key is uploaded
- [ ] Verify app.json has UIBackgroundModes: remote-notification
- [ ] Verify aps-environment entitlement is set

### 4. Check for Known Version Issues

- [ ] Current RN Firebase auth: 23.8.2 - Check changelog for known issues
- [ ] Current Expo: 54 - Check compatibility
- [ ] Check if New Architecture is enabled (could cause EXC_BREAKPOINT)

### 5. Reproduce and Capture Logs

- [ ] Add detailed logging before signInWithPhoneNumber call
- [ ] Capture crash logs from Xcode console
- [ ] Identify exact crash point (before/during/after signInWithPhoneNumber)
- [ ] Check if crash is in JS or native code
      </diagnosis_checklist>

<open_questions>

## Open Questions

1. **Exact crash location**
   - What we know: Crash happens during phone input flow
   - What's unclear: Is it during signInWithPhoneNumber call or when navigating with confirmation?
   - Recommendation: Add logging, capture Xcode crash logs

2. **GoogleService-Info.plist verification**
   - What we know: File was removed from git in Phase 21.1, restored via EAS env var
   - What's unclear: Does REVERSED_CLIENT_ID match URL scheme in app.json?
   - Recommendation: Verify locally during debugging

3. **New Architecture impact**
   - What we know: Some crashes related to New Architecture with Firebase
   - What's unclear: Is New Architecture enabled in this project?
   - Recommendation: Check expo-build-properties config
     </open_questions>

<sources>
## Sources

### Primary (HIGH confidence)

- [React Native Firebase Phone Auth Docs](https://rnfirebase.io/auth/phone-auth) - Official setup guide
- [Firebase iOS Phone Auth Docs](https://firebase.google.com/docs/auth/ios/phone-auth) - Native iOS requirements

### Secondary (MEDIUM confidence)

- [GitHub Issue #8122](https://github.com/invertase/react-native-firebase/issues/8122) - ConfirmationResult useState crash, useRef workaround confirmed
- [GitHub Issue #8535](https://github.com/invertase/react-native-firebase/issues/8535) - EXC_BREAKPOINT crash with Expo 52, issue CLOSED
- [GitHub Issue #31721 (Expo)](https://github.com/expo/expo/issues/31721) - TestFlight-only crash, NSInvalidArgumentException

### Tertiary (LOW confidence - needs validation)

- GitHub discussions on reCAPTCHA redirect issues
- Stack Overflow answers on phone auth configuration
  </sources>

<metadata>
## Metadata

**Research scope:**

- Core technology: Firebase Phone Authentication (iOS) with React Native Firebase
- Ecosystem: Expo 54, @react-native-firebase/auth 23.8.2, libphonenumber-js
- Patterns: Confirmation object handling, reCAPTCHA configuration, APNs setup
- Pitfalls: Serialization crashes, URL scheme misconfig, TestFlight differences

**Confidence breakdown:**

- Crash causes: HIGH - Multiple sources document these specific issues
- ConfirmationResult fix: HIGH - useRef pattern documented and confirmed working
- URL scheme fix: HIGH - Official Firebase documentation
- Version-specific issues: MEDIUM - Need to verify against current versions

**Research date:** 2026-01-24
**Valid until:** 2026-02-24 (30 days - phone auth ecosystem relatively stable)
</metadata>

---

_Phase: 21.3-phone-crash_
_Research completed: 2026-01-24_
_Ready for planning: yes_
