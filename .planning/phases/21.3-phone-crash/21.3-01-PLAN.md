---
phase: 21.3-phone-crash
plan: 01
type: execute
---

<objective>
Fix app crash when inputting phone number by storing Firebase ConfirmationResult in useRef instead of React Navigation params.

Purpose: The crash blocks all authentication - users cannot sign up or log in. This is a critical user-facing bug.
Output: Working phone authentication flow - user can enter phone, receive SMS, enter code, and authenticate.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21.3-phone-crash/21.3-RESEARCH.md
@.planning/phases/21.3-phone-crash/21.3-CONTEXT.md

# Relevant source files:

@src/screens/PhoneInputScreen.js
@src/screens/VerificationScreen.js
@src/services/firebase/phoneAuthService.js
@src/navigation/AppNavigator.js
@src/context/AuthContext.js

**Root cause (confirmed):**
The crash occurs at PhoneInputScreen.js:93-97 where `navigation.navigate('Verification', { confirmation: result.confirmation, ... })` passes the Firebase ConfirmationResult through navigation params. React Navigation serializes params on iOS, and ConfirmationResult contains non-serializable functions (like `.confirm()`), causing a SIGABRT crash.

**Fix approach (from research):**
Use useRef to store the confirmation object instead of passing through navigation. Share via React Context between PhoneInputScreen and VerificationScreen.

**Key constraint:**

- ConfirmationResult must NOT be serialized (no useState, no navigation params)
- useRef is the correct pattern - ref values aren't serialized
- Context provides clean sharing between screens without serialization
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create PhoneAuthContext for confirmation sharing</name>
  <files>src/context/PhoneAuthContext.js</files>
  <action>
Create a new React Context to share the phone auth confirmation ref between screens:

1. Create PhoneAuthContext with createContext(null)
2. Create PhoneAuthProvider component that:
   - Creates a useRef(null) for confirmationRef
   - Provides { confirmationRef } through context value
3. Export usePhoneAuth hook for consuming components
4. Export PhoneAuthProvider for wrapping auth screens

Pattern to follow (from research):

```javascript
import React, { createContext, useContext, useRef } from 'react';

const PhoneAuthContext = createContext(null);

export const PhoneAuthProvider = ({ children }) => {
  const confirmationRef = useRef(null);
  return (
    <PhoneAuthContext.Provider value={{ confirmationRef }}>{children}</PhoneAuthContext.Provider>
  );
};

export const usePhoneAuth = () => {
  const context = useContext(PhoneAuthContext);
  if (!context) {
    throw new Error('usePhoneAuth must be used within PhoneAuthProvider');
  }
  return context;
};
```

Add logging with the project's logger utility for debugging.
</action>
<verify>File exists with correct exports: PhoneAuthProvider, usePhoneAuth, PhoneAuthContext</verify>
<done>PhoneAuthContext.js created with Provider and hook exports</done>
</task>

<task type="auto">
  <name>Task 2: Update PhoneInputScreen to use context</name>
  <files>src/screens/PhoneInputScreen.js</files>
  <action>
Modify PhoneInputScreen to store confirmation in context ref instead of navigation params:

1. Import usePhoneAuth from '../context/PhoneAuthContext'
2. Get confirmationRef from usePhoneAuth() at component top
3. In handleSendCode success block (line ~93-97), change from:

   ```javascript
   navigation.navigate('Verification', {
     confirmation: result.confirmation, // REMOVE THIS
     phoneNumber: result.formattedNumber,
     e164: result.e164,
   });
   ```

   To:

   ```javascript
   // Store in ref (not serialized)
   confirmationRef.current = result.confirmation;

   // Navigate without confirmation object
   navigation.navigate('Verification', {
     phoneNumber: result.formattedNumber,
     e164: result.e164,
   });
   ```

4. Add logging when storing confirmation in ref

Do NOT change any other functionality - this is a minimal fix.
</action>
<verify>grep for "confirmation:" in the navigate call should return 0 results; grep for "confirmationRef.current" should find the assignment</verify>
<done>PhoneInputScreen stores confirmation in context ref, not navigation params</done>
</task>

<task type="auto">
  <name>Task 3: Update VerificationScreen and wrap auth stack</name>
  <files>src/screens/VerificationScreen.js, src/navigation/AppNavigator.js</files>
  <action>
Part A - Update VerificationScreen:
1. Import usePhoneAuth from '../context/PhoneAuthContext'
2. Get confirmationRef from usePhoneAuth() at component top
3. Change line ~24 from:
   ```javascript
   const { confirmation, phoneNumber, e164 } = route.params || {};
   ```
   To:
   ```javascript
   const { phoneNumber, e164 } = route.params || {};
   const { confirmationRef } = usePhoneAuth();
   const confirmation = confirmationRef.current;
   ```
4. Add logging when reading confirmation from ref
5. The rest of the component remains unchanged - it already uses `confirmation` variable

Part B - Update AppNavigator:

1. Import PhoneAuthProvider from '../context/PhoneAuthContext'
2. Wrap the auth screens section (lines ~320-325) with PhoneAuthProvider:
   ```javascript
   {!isAuthenticated ? (
     // Auth Stack - Phone-only authentication
     <PhoneAuthProvider>
       <Stack.Screen name="PhoneInput" component={PhoneInputScreen} />
       <Stack.Screen name="Verification" component={VerificationScreen} />
     </PhoneAuthProvider>
   ) : ...
   ```

Note: PhoneAuthProvider wraps the Stack.Screen elements directly since they're rendered conditionally. This ensures the context is available to both screens during the auth flow.
</action>
<verify>

- VerificationScreen: grep for "route.params" should NOT include "confirmation"
- AppNavigator: grep for "PhoneAuthProvider" should find the import and the wrapper
- No TypeScript/ESLint errors
  </verify>
  <done>VerificationScreen reads from context; auth screens wrapped with PhoneAuthProvider</done>
  </task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] App builds without errors (`npx expo start` runs)
- [ ] No ESLint errors in modified files
- [ ] PhoneInputScreen navigates to Verification without crash
- [ ] VerificationScreen can access confirmation object from context
- [ ] Full auth flow works: enter phone → receive code → enter code → authenticated
</verification>

<success_criteria>

- All tasks completed
- App does not crash when entering phone number
- Phone authentication flow works end-to-end
- No TypeScript/ESLint errors introduced
- Confirmation object properly shared via context (not navigation params)
  </success_criteria>

<output>
After completion, create `.planning/phases/21.3-phone-crash/21.3-01-SUMMARY.md` using the summary template.
</output>
