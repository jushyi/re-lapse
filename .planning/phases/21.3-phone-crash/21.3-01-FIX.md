# Phase 21.3-01 Fix Plan: Complete Firebase Phone Auth Configuration

**Issue:** UAT-001 - App crashes when tapping Send Code button
**Root Cause:** GoogleService-Info.plist missing CLIENT_ID and REVERSED_CLIENT_ID keys required for Firebase Phone Auth reCAPTCHA flow
**Priority:** Blocker

---

## Overview

Firebase Phone Authentication on iOS requires proper OAuth configuration for the reCAPTCHA verification flow. The current GoogleService-Info.plist is missing critical keys that Firebase generates when you add an OAuth client to your Firebase project.

## Prerequisites

- Access to Firebase Console (https://console.firebase.google.com)
- Access to Google Cloud Console (https://console.cloud.google.com)
- EAS CLI installed and authenticated

---

## Task 1: Enable reCAPTCHA for Firebase Auth in Google Cloud Console

**Manual Steps (User must complete):**

1. Go to Google Cloud Console: https://console.cloud.google.com
2. Select your Firebase project: `re-lapse-fa89b`
3. Navigate to: **APIs & Services** → **Credentials**
4. Under "OAuth 2.0 Client IDs", check if you have an iOS client:
   - If YES: Note the Client ID
   - If NO: Create one:
     a. Click **+ CREATE CREDENTIALS** → **OAuth client ID**
     b. Select **iOS** as application type
     c. Enter Name: `Oly iOS App` (or similar)
     d. Enter Bundle ID: `com.spoodsjs.oly`
     e. Click **CREATE**
     f. Note the generated Client ID

5. The Client ID format should be: `958995611148-XXXXXXXXXXXX.apps.googleusercontent.com`
6. The REVERSED_CLIENT_ID is the reverse: `com.googleusercontent.apps.958995611148-XXXXXXXXXXXX`

**Checkpoint:** Confirm you have an iOS OAuth 2.0 Client ID created for bundle ID `com.spoodsjs.oly`

---

## Task 2: Verify Firebase Phone Auth is Enabled

**Manual Steps (User must complete):**

1. Go to Firebase Console: https://console.firebase.google.com
2. Select project: `re-lapse-fa89b`
3. Navigate to: **Authentication** → **Sign-in method**
4. Verify **Phone** is enabled:
   - If NOT enabled: Click Phone → Enable → Save
5. Under Phone provider settings, note if any phone numbers are in the test phone numbers list (useful for testing)

**Checkpoint:** Phone authentication is enabled in Firebase Console

---

## Task 3: Download Fresh GoogleService-Info.plist

**Manual Steps (User must complete):**

1. Go to Firebase Console: https://console.firebase.google.com
2. Select project: `re-lapse-fa89b`
3. Click the **gear icon** ⚙️ → **Project settings**
4. Scroll to **Your apps** section
5. Find the iOS app with Bundle ID: `com.spoodsjs.oly`
6. Click **GoogleService-Info.plist** download button
7. Save the file

**Verification:** Open the downloaded file and confirm it contains these keys:

```xml
<key>CLIENT_ID</key>
<string>958995611148-XXXXXXXXXXXX.apps.googleusercontent.com</string>
<key>REVERSED_CLIENT_ID</key>
<string>com.googleusercontent.apps.958995611148-XXXXXXXXXXXX</string>
```

If these keys are STILL missing after download, you need to complete Task 1 first (create OAuth client), then re-download.

**Checkpoint:** GoogleService-Info.plist contains CLIENT_ID and REVERSED_CLIENT_ID

---

## Task 4: Update Local GoogleService-Info.plist

**Manual Step:**

Replace `c:\Users\maser\Lapse Clone\GoogleService-Info.plist` with the newly downloaded file.

**Checkpoint:** Local file replaced

---

## Task 5: Update app.json URL Schemes

**Code Change (Claude will assist):**

Add the REVERSED_CLIENT_ID to CFBundleURLSchemes in app.json.

The REVERSED_CLIENT_ID from your new plist needs to be added to the URL schemes so iOS can handle the reCAPTCHA callback.

**File:** `app.json`
**Section:** `expo.ios.infoPlist.CFBundleURLTypes[0].CFBundleURLSchemes`

Example (replace XXXX with actual value from plist):

```json
"CFBundleURLSchemes": [
  "com.googleusercontent.apps.958995611148-XXXXXXXXXXXX"
]
```

Note: The existing scheme `com.googleusercontent.apps.958995611148-k8nl243l2h21n9sh0ugss4ad6qbldk7a` may be for Google Sign-In. You may need BOTH schemes, or the new REVERSED_CLIENT_ID may replace it depending on your OAuth configuration.

**Checkpoint:** app.json updated with correct REVERSED_CLIENT_ID

---

## Task 6: Upload New plist to EAS

**Command:**

```bash
# Delete the old secret first
eas secret:delete --key GOOGLE_SERVICES_PLIST --scope project

# Or update with new file
eas secret:create --name GOOGLE_SERVICES_PLIST --type file --value ./GoogleService-Info.plist --scope project
```

If using environment-specific secrets:

```bash
eas env:create --environment development --name GOOGLE_SERVICES_PLIST --type file --value ./GoogleService-Info.plist --visibility sensitive
```

**Checkpoint:** EAS secret updated with new plist

---

## Task 7: Rebuild Development Client

**Command:**

```bash
eas build --profile development --platform ios
```

**Checkpoint:** New build created and installed on device

---

## Task 8: Verify Fix

**Test Steps:**

1. Install the new development build
2. Open app
3. Enter phone number
4. Tap "Send Code"
5. **Expected:** reCAPTCHA should appear OR SMS code should be sent directly
6. **Success criteria:** App does NOT crash

---

## Rollback Plan

If the fix doesn't work:

1. Check device logs in Xcode/Console for specific error messages
2. Verify the REVERSED_CLIENT_ID in app.json matches exactly what's in GoogleService-Info.plist
3. Verify APNs is configured for the dev build (Settings → Apple Push Notifications)

---

## Summary

| Task                         | Type   | Owner  |
| ---------------------------- | ------ | ------ |
| 1. Create iOS OAuth Client   | Manual | User   |
| 2. Verify Phone Auth enabled | Manual | User   |
| 3. Download fresh plist      | Manual | User   |
| 4. Replace local plist       | Manual | User   |
| 5. Update app.json           | Code   | Claude |
| 6. Upload to EAS             | Manual | User   |
| 7. Rebuild                   | Manual | User   |
| 8. Verify                    | Manual | User   |

---

_Created: 2026-01-24_
_Issue: UAT-001_
_Phase: 21.3-phone-crash_
