# Phase 48.1: PhotoDetail Profile Navigation Fix — Research

**Researched:** 2026-02-12
**Domain:** React Navigation native stack modal presentation z-order on iOS
**Confidence:** HIGH

<research_summary>

## Summary

Researched the React Navigation native stack presentation mode hierarchy on iOS to understand why navigating from PhotoDetail (`transparentModal`) to OtherUserProfile (`card`) renders the profile behind the modal overlay, and how to fix it.

The root cause is a fundamental iOS UIKit behavior: modal presentations (`transparentModal`, `fullScreenModal`, `modal`) create native `UIViewController` modal layers that always render above non-modal (`card`) screens in the same stack. When PhotoDetail is presented as `transparentModal`, any subsequent `card` screen navigated to in the same stack renders in the stack's base view hierarchy — below the modal layer. This is not a bug but expected iOS native behavior, confirmed by React Navigation maintainers.

The recommended solution is a **duplicate screen with nested navigator** approach: register a separate root-level screen (`ProfileFromPhotoDetail`) with `presentation: 'fullScreenModal'` whose component is a nested stack navigator containing ProfileScreen, AlbumGrid, and MonthlyAlbumGrid. iOS supports presenting modals on top of modals (the stack grows), so `fullScreenModal` renders above `transparentModal`. Card screens inside the nested navigator work normally because they push within the nested stack's own view hierarchy inside the modal. The existing `OtherUserProfile` (card) stays untouched for all other navigation contexts.

**Primary recommendation:** Create a `fullScreenModal` wrapper screen with nested navigator for profile navigation from PhotoDetail; keep existing `card` OtherUserProfile for all other flows.
</research_summary>

<standard_stack>

## Standard Stack

No new libraries needed — this is a navigation architecture fix using existing dependencies.

### Core (already in project)

| Library                        | Version | Purpose                  | Why Standard                                                          |
| ------------------------------ | ------- | ------------------------ | --------------------------------------------------------------------- |
| @react-navigation/native-stack | ^7.9.0  | Native stack navigator   | Provides presentation modes (card, transparentModal, fullScreenModal) |
| @react-navigation/native       | ^7.1.26 | Navigation container     | Core navigation infrastructure                                        |
| react-native-screens           | ~4.16.0 | Native screen primitives | Implements iOS UIViewController presentation under the hood           |

### Supporting (already in project)

| Library                | Version | Purpose                  | When to Use                                             |
| ---------------------- | ------- | ------------------------ | ------------------------------------------------------- |
| @react-navigation/core | ^7.14.0 | Navigation actions/state | CommonActions, StackActions for programmatic navigation |

### Alternatives Considered

| Instead of                          | Could Use                                 | Tradeoff                                                                              |
| ----------------------------------- | ----------------------------------------- | ------------------------------------------------------------------------------------- |
| Nested navigator in fullScreenModal | Dismiss-navigate-restore pattern          | Simpler code but loses PhotoDetail state, janky double animation, fragile restoration |
| Nested navigator in fullScreenModal | CommonActions.reset                       | Single action but extremely brittle state management, hard to maintain                |
| Nested navigator in fullScreenModal | React Native `<Modal>` component          | Decouples from nav stack but massive architectural change, breaks gestures/animation  |
| fullScreenModal wrapper             | containedTransparentModal for PhotoDetail | Might change z-order but uncertain behavior, changes PhotoDetail visual presentation  |

</standard_stack>

<architecture_patterns>

## Architecture Patterns

### Current Architecture (Broken)

```
Root Stack Navigator
├── MainTabs (card)
├── PhotoDetail (transparentModal) ← Native modal layer (HIGHEST)
├── OtherUserProfile (card) ← Non-modal, renders BELOW PhotoDetail
├── AlbumGrid (card)
├── MonthlyAlbumGrid (card)
└── ...other screens (card)
```

**Problem:** Navigating from PhotoDetail → OtherUserProfile pushes a card screen. Card screens render in the stack's base view hierarchy, which is below the transparentModal native layer. OtherUserProfile is invisible behind PhotoDetail.

### Recommended Architecture (Fix)

```
Root Stack Navigator
├── MainTabs (card)
├── PhotoDetail (transparentModal) ← Native modal layer
├── ProfileFromPhotoDetail (fullScreenModal) ← HIGHER native modal layer
│   └── Nested Stack Navigator (component)
│       ├── ProfileScreen (card, initial route)
│       ├── AlbumGrid (card) ← pushes within nested stack
│       └── MonthlyAlbumGrid (card) ← pushes within nested stack
├── OtherUserProfile (card) ← Unchanged, for non-PhotoDetail contexts
├── AlbumGrid (card) ← Unchanged, for non-PhotoDetail contexts
├── MonthlyAlbumGrid (card) ← Unchanged, for non-PhotoDetail contexts
└── ...other screens
```

### Pattern 1: Duplicate Screen with Nested Navigator

**What:** Register the same logical screen twice — once as `card` for normal use, once wrapped in `fullScreenModal` with a nested navigator for use from modal contexts.
**When to use:** When navigating FROM a modal screen TO a screen that needs child navigation, and the target screen can't be modal in its primary context.
**Why it works:** iOS UIKit supports modal stacking — each new `presentViewController:animated:` adds to the presentation stack. `fullScreenModal` (presented after `transparentModal`) renders on top. Card screens inside the nested navigator push within the modal's own view hierarchy, not the root stack's.

**Example structure:**

```javascript
// Root stack — new screen definition
<Stack.Screen
  name="ProfileFromPhotoDetail"
  component={ProfileFromPhotoDetailNavigator}
  options={{
    presentation: 'fullScreenModal',
    headerShown: false,
    animation: 'slide_from_right', // or 'slide_from_bottom'
    contentStyle: { backgroundColor: colors.background.primary },
  }}
/>
```

```javascript
// Nested navigator component
const ProfileStack = createNativeStackNavigator();

function ProfileFromPhotoDetailNavigator({ route }) {
  const { userId, username } = route.params;
  return (
    <ProfileStack.Navigator screenOptions={{ headerShown: false }}>
      <ProfileStack.Screen
        name="ProfileMain"
        component={ProfileScreen}
        initialParams={{ userId, username }}
      />
      <ProfileStack.Screen name="AlbumGrid" component={AlbumGridScreen} />
      <ProfileStack.Screen name="MonthlyAlbumGrid" component={MonthlyAlbumGridScreen} />
    </ProfileStack.Navigator>
  );
}
```

### Pattern 2: Context-Aware Navigation

**What:** The navigation callback in PhotoDetail checks context and routes to the appropriate screen variant.
**When to use:** When the same user action (tap avatar) should navigate to different screen registrations depending on the source screen.

**Example:**

```javascript
// In PhotoDetail or FeedScreen's PhotoDetail callback setup
const handleAvatarPress = (userId, displayName) => {
  // From PhotoDetail context → use fullScreenModal variant
  navigation.navigate('ProfileFromPhotoDetail', { userId, username: displayName });
};
```

### Anti-Patterns to Avoid

- **Changing OtherUserProfile to fullScreenModal globally:** Breaks Phase 46.1 fix — AlbumGrid/MonthlyAlbumGrid siblings can't push on top of fullScreenModal in root stack
- **Using React Native `<Modal>` to bypass navigation:** Breaks gesture handling, back navigation, deep linking, and state management
- **Manual z-index manipulation:** React Navigation uses native iOS UIViewController presentation, not React Native views — `zIndex` style has no effect
- **Conditional presentation per-navigate:** React Navigation presentation is a screen-level option, not a navigate-level option — can't pass `presentation` as a param
  </architecture_patterns>

<dont_hand_roll>

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem                                 | Don't Build                                | Use Instead                                                           | Why                                                                                        |
| --------------------------------------- | ------------------------------------------ | --------------------------------------------------------------------- | ------------------------------------------------------------------------------------------ |
| Modal z-order                           | Custom zIndex/elevation styles             | React Navigation presentation modes                                   | Native modal layers are managed by iOS UIKit, not React Native views                       |
| Modal stacking                          | Custom overlay management                  | iOS native modal stack (fullScreenModal on top of transparentModal)   | iOS UIKit handles `presentViewController:animated:` stacking correctly                     |
| Child navigation inside modal           | Passing navigation callbacks through props | Nested native stack navigator inside fullScreenModal                  | Nested navigator creates proper view hierarchy with push/pop, gesture back, deep linking   |
| State preservation across modal dismiss | Manual state serialization/restoration     | Keep PhotoDetail mounted (don't dismiss) while showing profile on top | iOS keeps the entire modal stack alive — PhotoDetail stays in place behind fullScreenModal |
| Back navigation from nested stack       | Custom back handlers                       | React Navigation's built-in gesture back + headerBackButton           | Native stack handles iOS swipe-back gesture automatically within nested navigator          |

**Key insight:** The fix is purely a navigation architecture change. React Navigation + react-native-screens + iOS UIKit already handle modal stacking, nested navigation, gesture back, and state preservation. The only thing needed is the right screen registration and presentation mode — zero custom view hierarchy management.
</dont_hand_roll>

<common_pitfalls>

## Common Pitfalls

### Pitfall 1: Animation Glitches When Stacking Modals

**What goes wrong:** When presenting a modal on top of another modal (fullScreenModal on top of transparentModal), animations may not play correctly — views can change without transition.
**Why it happens:** react-native-screens issue #1819 documents that iOS doesn't always animate transitions between stacked modals correctly.
**How to avoid:** Test the animation explicitly. May need to use `animation: 'slide_from_right'` (card-like) instead of default modal animation (`slide_from_bottom`), or `animation: 'none'` if transitions look janky. The `fullScreenModal` gives native iOS handling which should work, but verify on device.
**Warning signs:** Profile screen appears instantly without slide animation, or PhotoDetail flickers during transition.

### Pitfall 2: Gesture Back Dismisses Wrong Screen

**What goes wrong:** iOS swipe-back gesture from OtherUserProfile dismisses both the fullScreenModal AND returns past PhotoDetail.
**Why it happens:** `fullScreenModal` dismissal behavior may propagate to the transparentModal layer.
**How to avoid:** Set `gestureEnabled: true` on the nested navigator screens but carefully test the gesture behavior. The nested stack navigator's gesture should handle back within the nested stack first. Only the last screen in the nested stack should dismiss the fullScreenModal.
**Warning signs:** Single swipe-back from ProfileScreen goes all the way to Feed, skipping PhotoDetail.

### Pitfall 3: initialParams Not Passing Through Nested Navigator

**What goes wrong:** The userId/username params passed to `ProfileFromPhotoDetail` don't reach the ProfileScreen inside the nested navigator.
**Why it happens:** Params are passed to the wrapper screen, not directly to the nested navigator's initial screen. Must forward params explicitly.
**How to avoid:** Use `route.params` in the wrapper component to extract params and pass them as `initialParams` to the nested navigator's initial screen (shown in the architecture pattern above).
**Warning signs:** ProfileScreen shows blank/loading state because it has no userId.

### Pitfall 4: Duplicate Screen Names in Nested Navigator

**What goes wrong:** Navigating to `AlbumGrid` from ProfileScreen goes to the wrong AlbumGrid (root stack's instead of nested stack's).
**Why it happens:** React Navigation resolves screen names by searching the nearest navigator first, then parent navigators. If both root stack and nested stack have `AlbumGrid`, the resolution depends on which navigator the navigation call originates from.
**How to avoid:** Use unique screen names in the nested navigator (e.g., `ProfileAlbumGrid`) OR ensure navigation calls originate from within the nested navigator context. Test that album navigation from the profile-inside-modal goes to the nested AlbumGrid.
**Warning signs:** Tapping an album in the modal profile navigates but the album appears behind the modal.

### Pitfall 5: Deep Linking / Notification Navigation Breaks

**What goes wrong:** Push notifications or deep links that navigate to OtherUserProfile stop working because the navigation path changed.
**Why it happens:** If notification handlers use `navigation.navigate('OtherUserProfile', ...)`, they'll still go to the card variant (correct for notification context). But if they somehow trigger from within PhotoDetail context, they'd hit the same z-order issue.
**How to avoid:** Only change the navigation call FROM PhotoDetail/CommentsBottomSheet context. All other navigation to OtherUserProfile stays unchanged. Verify notification deep linking still works.
**Warning signs:** Tapping a notification while PhotoDetail is open navigates but profile is invisible.
</common_pitfalls>

<code_examples>

## Code Examples

Verified patterns from React Navigation docs and GitHub issues:

### iOS Modal Stacking (UIKit Behavior)

```
// Source: Apple Developer Documentation - Presenting a View Controller
// iOS native behavior: modals stack on top of each other.
// Each presentViewController:animated: adds to the presentation stack.
//
// Stack order (bottom to top):
// 1. Root view controller (MainTabs)
// 2. transparentModal (PhotoDetail) — presented modally
// 3. fullScreenModal (ProfileFromPhotoDetail) — presented on top of #2
//
// Going back pops the stack: #3 dismissed first, then #2.
```

### Nested Navigator Inside Modal Screen

```javascript
// Source: React Navigation maintainer suggestion (GitHub #11214)
// "Consider nesting a navigator inside a modal to show a screen
//  within the modal context"

import { createNativeStackNavigator } from '@react-navigation/native-stack';
import ProfileScreen from '../screens/ProfileScreen';
import AlbumGridScreen from '../screens/AlbumGridScreen';
import MonthlyAlbumGridScreen from '../screens/MonthlyAlbumGridScreen';

const ProfileModalStack = createNativeStackNavigator();

function ProfileFromPhotoDetailNavigator({ route }) {
  // Forward params from root stack to nested initial screen
  const { userId, username } = route.params;

  return (
    <ProfileModalStack.Navigator
      screenOptions={{
        headerShown: false,
        contentStyle: { backgroundColor: colors.background.primary },
      }}
    >
      <ProfileModalStack.Screen
        name="ProfileMain"
        component={ProfileScreen}
        initialParams={{ userId, username }}
        options={{
          animation: 'none', // Already animating via fullScreenModal
        }}
      />
      <ProfileModalStack.Screen
        name="AlbumGrid"
        component={AlbumGridScreen}
        options={{ animation: 'slide_from_right' }}
      />
      <ProfileModalStack.Screen
        name="MonthlyAlbumGrid"
        component={MonthlyAlbumGridScreen}
        options={{ animation: 'slide_from_right' }}
      />
    </ProfileModalStack.Navigator>
  );
}
```

### Root Stack Screen Registration

```javascript
// Source: React Navigation docs - presentation option
// Register alongside existing screens in AppNavigator root stack

<Stack.Screen
  name="ProfileFromPhotoDetail"
  component={ProfileFromPhotoDetailNavigator}
  options={{
    presentation: 'fullScreenModal', // Renders above transparentModal
    headerShown: false,
    animation: 'slide_from_right',   // Card-like feel, not bottom sheet
    gestureEnabled: true,
    contentStyle: { backgroundColor: colors.background.primary },
  }}
/>

// Existing OtherUserProfile stays unchanged
<Stack.Screen
  name="OtherUserProfile"
  component={ProfileScreen}
  options={{
    presentation: 'card', // Card (not modal) so AlbumGrid can push on top
    animation: 'slide_from_right',
    headerShown: false,
    gestureEnabled: true,
    contentStyle: { backgroundColor: colors.background.primary },
  }}
/>
```

### Navigation Call from PhotoDetail Context

```javascript
// Source: Existing pattern in FeedScreen.js / PhotoDetailContext.js
// Change the onAvatarPress callback to use the modal variant

const handleAvatarPress = (userId, displayName) => {
  // Navigate to fullScreenModal variant (renders above transparentModal)
  navigation.navigate('ProfileFromPhotoDetail', {
    userId,
    username: displayName,
  });
};
```

</code_examples>

<sota_updates>

## State of the Art (2025-2026)

| Old Approach                             | Current Approach                              | When Changed | Impact                                                                                     |
| ---------------------------------------- | --------------------------------------------- | ------------ | ------------------------------------------------------------------------------------------ |
| JS-based stack (@react-navigation/stack) | Native stack (@react-navigation/native-stack) | 2021+        | Native stack uses real iOS UIViewController modals — z-order is OS-managed, not JS-managed |
| react-navigation v6                      | react-navigation v7                           | 2024         | v7 presentation modes unchanged from v6 for native-stack; same iOS modal behavior          |
| react-native-screens ~3.x                | react-native-screens ~4.16.0                  | 2024         | No changes to modal stacking behavior; some animation improvements                         |

**Key stability note:** The presentation mode behavior and iOS modal stacking semantics are stable across React Navigation v6→v7 and react-native-screens 3→4. This is fundamentally iOS UIKit behavior, not library behavior — it won't change unless Apple changes UIKit modal presentation.

**New patterns to consider:**

- **formSheet presentation (iOS 16+):** React Navigation v7 supports `presentation: 'formSheet'` with sheet detents. Could theoretically be used for PhotoDetail but would change the visual design significantly. Not relevant for this fix.

**Deprecated/outdated:**

- **JS-based stack for modals:** The JS stack (`@react-navigation/stack`) manages its own z-order via React Native views. It wouldn't have this issue but has worse performance and native feel. Not worth switching back.
  </sota_updates>

<open_questions>

## Open Questions

1. **Animation behavior when stacking fullScreenModal on transparentModal**
   - What we know: iOS supports modal stacking, but react-native-screens #1819 reports animation glitches when stacking modals.
   - What's unclear: Whether `transparentModal` → `fullScreenModal` specifically triggers animation issues, or if it only affects `fullScreenModal` → `modal` stacking.
   - Recommendation: Test on physical iOS device during implementation. If animations are janky, try `animation: 'slide_from_right'` or `animation: 'fade'` as alternatives to default modal animation.

2. **Gesture back behavior in nested stack within fullScreenModal**
   - What we know: Native stack navigator handles swipe-back gesture. Nested navigators have their own gesture context.
   - What's unclear: Whether swipe-back from the nested stack's initial screen dismisses just the fullScreenModal or also affects PhotoDetail underneath.
   - Recommendation: Test and configure `gestureEnabled` per-screen in the nested navigator. May need `gestureEnabled: false` on the initial ProfileScreen and custom back button instead.

3. **Screen name conflicts between root and nested navigator**
   - What we know: React Navigation resolves screen names from nearest navigator first.
   - What's unclear: Whether ProfileScreen's existing `navigation.navigate('AlbumGrid')` calls will resolve to the nested navigator's AlbumGrid or the root stack's AlbumGrid.
   - Recommendation: Test navigation from ProfileScreen inside the nested navigator. If it resolves incorrectly, rename nested screens (e.g., `ModalAlbumGrid`) and update ProfileScreen to use the appropriate name based on context.
     </open_questions>

<sources>
## Sources

### Primary (HIGH confidence)

- [React Navigation Native Stack Docs](https://reactnavigation.org/docs/native-stack-navigator/) — presentation mode definitions and behavior
- [React Navigation Modal Guide](https://reactnavigation.org/docs/modal/) — modal best practices, nested navigator recommendations
- [Apple UIViewController Presentation Guide](https://developer.apple.com/library/archive/featuredarticles/ViewControllerPGforiPhoneOS/PresentingaViewController.html) — iOS modal stacking behavior confirmed: "the cards stack up"
- [GitHub #11214](https://github.com/react-navigation/react-navigation/issues/11214) — React Navigation maintainer confirms transparentModal is "expected to always be on top" and suggests "nesting a navigator inside a modal"

### Secondary (MEDIUM confidence)

- [GitHub #597 (react-native-screens)](https://github.com/software-mansion/react-native-screens/issues/597) — Confirms transparentModal blocks external navigation; workarounds documented
- [GitHub #11379](https://github.com/react-navigation/react-navigation/issues/11379) — Confirms containedModal/modal screens stay visible when navigating to card screens (same z-order issue)
- [GitHub Discussion #1976](https://github.com/software-mansion/react-native-screens/discussions/1976) — Modal stacking on iOS confirmed: "navigate from one modal to another"

### Tertiary (LOW confidence — needs validation during implementation)

- [GitHub #1819 (react-native-screens)](https://github.com/software-mansion/react-native-screens/issues/1819) — Animation issues when stacking modals. May or may not affect transparentModal → fullScreenModal specifically.
- [GitHub #9879](https://github.com/react-navigation/react-navigation/issues/9879) — Nested stack in transparentModal has opaque background. Relevant if we ever need nested nav inside transparentModal (we don't — we nest inside fullScreenModal instead).
  </sources>

<metadata>
## Metadata

**Research scope:**

- Core technology: React Navigation v7 native-stack presentation modes
- Ecosystem: react-native-screens iOS modal implementation, iOS UIKit UIViewController presentation
- Patterns: Modal stacking, nested navigator inside modal, duplicate screen registration
- Pitfalls: Animation glitches, gesture conflicts, param forwarding, screen name resolution

**Confidence breakdown:**

- Root cause analysis: HIGH — Confirmed by React Navigation maintainers and Apple UIKit docs
- Recommended solution: HIGH — Uses documented patterns (nested navigator inside modal, iOS modal stacking)
- Animation behavior: MEDIUM — Known issues exist but may not affect this specific combination
- Gesture behavior: MEDIUM — Needs testing on device; native stack gesture handling is complex
- Code examples: HIGH — Based on React Navigation docs and maintainer suggestions

**Research date:** 2026-02-12
**Valid until:** 2026-06-12 (120 days — React Navigation presentation modes are stable, tied to iOS UIKit behavior)
</metadata>

---

_Phase: 48.1-photodetail-profile-nav_
_Research completed: 2026-02-12_
_Ready for planning: yes_
