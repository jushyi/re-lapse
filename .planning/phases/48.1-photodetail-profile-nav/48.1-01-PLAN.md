---
phase: 48.1-photodetail-profile-nav
plan: 01
type: execute
---

<objective>
Fix ISS-014: Profile navigation from PhotoDetail renders behind the transparentModal overlay. Users cannot view any profile from within the photo detail / comments view.

Purpose: Restore all profile navigation from PhotoDetail — photo owner header tap, comment author tap, and @mention tap — by layering the profile screen above the transparentModal using iOS native modal stacking.
Output: Working profile navigation from all PhotoDetail entry points, with child screen navigation (albums) intact, and no regression to existing OtherUserProfile card presentation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48.1-photodetail-profile-nav/48.1-RESEARCH.md
@.planning/phases/48.1-photodetail-profile-nav/48.1-CONTEXT.md

# Key source files:

@src/navigation/AppNavigator.js
@src/screens/FeedScreen.js
@src/context/PhotoDetailContext.js
@src/screens/ProfileScreen.js

**Root cause (from RESEARCH.md):** iOS UIKit modal presentations (transparentModal, fullScreenModal) create native UIViewController modal layers that always render above non-modal (card) screens in the same stack. PhotoDetail uses `presentation: 'transparentModal'`, so any `card` screen navigated to in the same root stack renders below it. This is expected iOS behavior confirmed by React Navigation maintainers.

**Solution (from RESEARCH.md):** Register a separate root-level screen `ProfileFromPhotoDetail` with `presentation: 'fullScreenModal'` whose component is a nested stack navigator containing ProfileScreen, AlbumGrid, and MonthlyAlbumGrid. iOS supports modal stacking — `fullScreenModal` renders above `transparentModal`. Card screens inside the nested navigator push within the nested stack's own view hierarchy. Existing `OtherUserProfile` (card) stays untouched for all other navigation contexts.

**Constraining decisions:**

- Phase 46.1: OtherUserProfile uses `presentation: 'card'` (not fullScreenModal) to allow child card screens on iOS — MUST preserve
- Phase 15.3-02: PhotoDetail is a transparentModal navigation screen (not a React Native Modal component) — root cause of z-order conflict

**Issues being addressed:** ISS-014
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProfileFromPhotoDetailNavigator and register in AppNavigator</name>
  <files>src/navigation/AppNavigator.js</files>
  <action>
Create a nested stack navigator component `ProfileFromPhotoDetailNavigator` at the top of AppNavigator.js (above the main component, after imports). This navigator wraps ProfileScreen, AlbumGridScreen, and MonthlyAlbumGridScreen:

```
const ProfileModalStack = createNativeStackNavigator();

function ProfileFromPhotoDetailNavigator({ route }) {
  const { userId, username } = route.params;
  return (
    <ProfileModalStack.Navigator screenOptions={{ headerShown: false, contentStyle: { backgroundColor: colors.background.primary } }}>
      <ProfileModalStack.Screen name="ProfileMain" component={ProfileScreen} initialParams={{ userId, username }} options={{ animation: 'none' }} />
      <ProfileModalStack.Screen name="AlbumGrid" component={AlbumGridScreen} options={{ animation: 'slide_from_right' }} />
      <ProfileModalStack.Screen name="MonthlyAlbumGrid" component={MonthlyAlbumGridScreen} options={{ animation: 'slide_from_right' }} />
    </ProfileModalStack.Navigator>
  );
}
```

Then register `ProfileFromPhotoDetail` as a new Stack.Screen in the root stack navigator, placed AFTER the PhotoDetail screen and BEFORE OtherUserProfile:

```
<Stack.Screen
  name="ProfileFromPhotoDetail"
  component={ProfileFromPhotoDetailNavigator}
  options={{
    presentation: 'fullScreenModal',
    headerShown: false,
    animation: 'slide_from_right',
    gestureEnabled: true,
    contentStyle: { backgroundColor: colors.background.primary },
  }}
/>
```

**Critical: Do NOT modify the existing OtherUserProfile, AlbumGrid, or MonthlyAlbumGrid screen registrations.** They must remain as `presentation: 'card'` for all non-PhotoDetail navigation contexts.

**Screen name note:** The nested navigator uses `ProfileMain` (not `OtherUserProfile`) as its initial route name to avoid confusion, but renders the same `ProfileScreen` component. The nested `AlbumGrid` and `MonthlyAlbumGrid` names match the existing root-level names — React Navigation resolves to the nearest navigator first, so ProfileScreen's `navigation.navigate('AlbumGrid')` calls will correctly resolve to the nested stack's screens when inside this navigator.

**WHY fullScreenModal:** iOS UIKit supports modal stacking. fullScreenModal presented after transparentModal renders on a higher native layer. Card screens inside the nested navigator push within the fullScreenModal's own view hierarchy, not the root stack's.

**WHY slide_from_right animation:** Default modal animation (slide_from_bottom) can have glitches when stacking modals (react-native-screens #1819). slide_from_right gives a card-like transition that feels natural for profile navigation.
</action>
<verify>App builds without errors: `npx expo start` launches successfully. No TypeScript/lint errors from the new screen registration.</verify>
<done>ProfileFromPhotoDetail screen registered in root stack with fullScreenModal presentation. Nested navigator contains ProfileMain, AlbumGrid, MonthlyAlbumGrid. Existing screen registrations unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Route PhotoDetail avatar navigation to ProfileFromPhotoDetail</name>
  <files>src/screens/FeedScreen.js</files>
  <action>
In FeedScreen.js, update the `onAvatarPress` callback inside the `setCallbacks` useEffect (around line 346-353). Change it from calling `handleAvatarPress(userId, username)` (which navigates to `OtherUserProfile`) to navigating directly to `ProfileFromPhotoDetail`:

Before:

```javascript
onAvatarPress: (userId, username) => {
  if (isOwnStoriesRef.current && userId === user?.uid) {
    navigation.navigate('Profile');
  } else {
    handleAvatarPress(userId, username);
  }
},
```

After:

```javascript
onAvatarPress: (userId, username) => {
  if (isOwnStoriesRef.current && userId === user?.uid) {
    navigation.navigate('Profile');
  } else {
    navigation.navigate('ProfileFromPhotoDetail', { userId, username });
  }
},
```

**Critical: Do NOT modify `handleAvatarPress` itself (line 392-395).** It is still used directly by FeedPhotoCard (line 956) and FriendStoryCard (line 1137) for avatar presses on feed cards and story cards — those navigations happen outside PhotoDetail and must continue using the regular `OtherUserProfile` card screen.

**Why this single change covers all three entry points:**

1. Photo owner header tap → PhotoDetailScreen.handleAvatarPress → contextAvatarPress → this callback
2. Comment author avatar tap → PhotoDetailScreen.handleCommentAvatarPress → contextAvatarPress → this callback
3. @mention tap in comment text → CommentsBottomSheet.handleMentionProfilePress → onAvatarPress → this callback

All three flow through the same `onAvatarPress` callback registered in PhotoDetailContext via setCallbacks. One change fixes all three.

**ActivityScreen coverage:** ActivityScreen also opens PhotoDetail via `openPhotoDetail()` but does not call `setCallbacks()` — it uses FeedScreen's previously registered callbacks (FeedScreen is the initial tab, so its callbacks are always available). This fix automatically covers photos opened from ActivityScreen too.
</action>
<verify>Search codebase to confirm: (1) `handleAvatarPress` at line ~392 still navigates to 'OtherUserProfile', (2) setCallbacks onAvatarPress now navigates to 'ProfileFromPhotoDetail', (3) FeedPhotoCard and FriendStoryCard still receive `handleAvatarPress` as their onAvatarPress prop.</verify>
<done>PhotoDetail context avatar navigation routes to ProfileFromPhotoDetail (fullScreenModal). Feed card and story card avatar navigation still routes to OtherUserProfile (card). All three PhotoDetail entry points (header, comment author, @mention) use the updated callback.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Profile navigation from PhotoDetail now uses a fullScreenModal wrapper that renders above the transparentModal overlay. All three entry points (photo owner header, comment author avatar, @mention tap) should navigate to the profile, which appears on top of PhotoDetail.</what-built>
  <how-to-verify>
    1. Run: `npx expo start` and open on iOS simulator or device
    2. Navigate to Feed and tap a friend's photo to open PhotoDetail
    3. **Test photo owner header tap:** Tap the username/avatar at the top of PhotoDetail → Profile should slide in from the right, fully visible above PhotoDetail
    4. **Test comment author tap:** Open comments, tap a commenter's avatar → Profile should appear above PhotoDetail
    5. **Test @mention tap:** If there's an @mention in a comment, tap it → Profile should appear above PhotoDetail
    6. **Test gesture back:** From any profile opened above, swipe back (iOS swipe from left edge) → Should return to PhotoDetail with comments still open, scroll position preserved
    7. **Test album navigation:** From a profile opened above PhotoDetail, tap an album → AlbumGrid should push within the profile view (not behind it)
    8. **Test monthly album:** Tap a monthly album → MonthlyAlbumGrid should push within the profile view
    9. **Test back from nested screens:** Swipe back from AlbumGrid → Returns to profile. Swipe back from profile → Returns to PhotoDetail
    10. **Regression: Feed card avatar:** Close PhotoDetail, tap an avatar on a feed card directly → Should navigate to regular OtherUserProfile (card presentation, not fullScreenModal)
    11. **Regression: Story card avatar:** Tap a friend story ring, then from story viewer tap their avatar → Should work correctly
    12. **Animation quality:** Check that the slide_from_right transition into and out of the profile feels smooth, no flashing or janky frames
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Profile navigation works from all three PhotoDetail entry points (header, comment author, @mention)
- [ ] Profile renders above PhotoDetail (not behind it)
- [ ] Album and monthly album navigation works from profile opened via PhotoDetail
- [ ] Gesture back returns to PhotoDetail with state preserved
- [ ] Regular OtherUserProfile navigation from feed cards still works (card presentation)
- [ ] No animation glitches during transitions
- [ ] `npm run lint` passes
</verification>

<success_criteria>

- ISS-014 resolved: all profile navigation from PhotoDetail works
- Phase 46.1 preserved: OtherUserProfile card presentation unchanged
- PhotoDetail state preservation: comments, scroll position, input state all intact after round-trip
- No regression to feed card or story card avatar navigation
- Smooth animations on iOS
  </success_criteria>

<output>
After completion, create `.planning/phases/48.1-photodetail-profile-nav/48.1-01-SUMMARY.md`
</output>
