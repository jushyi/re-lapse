---
phase: 34-push-infrastructure
plan: 02
type: execute
domain: expo-notifications
---

<objective>
Implement push notification receipt checking to detect and remove invalid tokens.

Purpose: Expo Push API returns tickets immediately but actual delivery status is available ~15 minutes later via receipts. Checking receipts allows us to detect DeviceNotRegistered errors and remove stale tokens, improving notification reliability.
Output: Receipt tracking system and scheduled Cloud Function that cleans invalid tokens automatically.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-push-infrastructure/34-RESEARCH.md
@.planning/phases/34-push-infrastructure/34-01-SUMMARY.md

# Key files to reference:

@functions/notifications/sender.js
@functions/index.js

**Tech stack available:** expo-server-sdk (from 34-01), Firebase Cloud Functions scheduled triggers
**Established patterns:** Scheduled Cloud Functions (processDarkroomReveals runs every 2 min)

**From research - receipt checking pattern:**

- Check receipts ~15 minutes after sending
- Use expo.chunkPushNotificationReceiptIds() for batching
- DeviceNotRegistered error → remove token from Firestore
- MessageTooBig, InvalidCredentials → log but don't remove token

**Constraining decisions:**

- Use Firestore collection for pending receipts (simple, fits existing patterns)
- 15-minute scheduled function (matches Expo recommendation)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Add ticket tracking to sender module</name>
  <files>functions/notifications/sender.js, functions/notifications/receipts.js</files>
  <action>
    1. Create `functions/notifications/receipts.js` with:
       - Import Firestore from firebase-admin
       - Export `storePendingReceipt(ticketId, userId, token)` that:
         - Stores to `pendingReceipts` collection with ticketId as doc ID
         - Fields: userId, token (for cleanup), createdAt (serverTimestamp)
         - TTL: Firestore TTL policy will auto-delete after 24 hours (optional enhancement)
       - Export `getPendingReceipts()` that queries all pending receipts
       - Export `deletePendingReceipt(ticketId)` for cleanup
       - Export `removeInvalidToken(userId)` that:
         - Updates user doc to set fcmToken to null
         - Logs the removal

    2. Update `functions/notifications/sender.js`:
       - Import `storePendingReceipt` from receipts.js
       - After successful send in `sendPushNotification`, if ticket has id:
         - Extract ticket from response
         - If ticket.status === 'ok', call `storePendingReceipt(ticket.id, userId, token)`
         - Note: Need to pass userId to sendPushNotification or determine from context
       - Update function signature to accept optional userId: `sendPushNotification(token, title, body, data, userId = null)`
       - Only store receipt if userId provided (for cleanup capability)

    AVOID: Storing receipts in-memory (stateless functions). Don't block on receipt storage (fire and forget).

  </action>
  <verify>
    - `ls functions/notifications/receipts.js` shows file exists
    - `grep "storePendingReceipt" functions/notifications/sender.js` shows integration
    - `grep "pendingReceipts" functions/notifications/receipts.js` shows collection name
  </verify>
  <done>
    - receipts.js module created with store/get/delete functions
    - sender.js stores pending receipts after successful sends
    - Token and userId tracked for invalid token cleanup
  </done>
</task>

<task type="auto">
  <name>Task 2: Create scheduled receipt checking function</name>
  <files>functions/index.js</files>
  <action>
    1. Import receipts module: `const { getPendingReceipts, deletePendingReceipt, removeInvalidToken } = require('./notifications/receipts');`

    2. Import Expo from sender or create shared instance: `const { Expo } = require('expo-server-sdk');`

    3. Add new scheduled Cloud Function `checkPushReceipts`:
       - Trigger: `functions.pubsub.schedule('every 15 minutes').onRun(async (context) => { ... })`
       - Implementation:
         a. Get all pending receipts from Firestore
         b. If empty, return early (log "No pending receipts")
         c. Extract receipt IDs
         d. Chunk with `expo.chunkPushNotificationReceiptIds(receiptIds)`
         e. For each chunk, call `expo.getPushNotificationReceiptsAsync(chunk)`
         f. Process each receipt:
            - If status === 'ok': delete from pendingReceipts
            - If status === 'error':
              - If details.error === 'DeviceNotRegistered': call removeInvalidToken(userId), delete receipt
              - Else: log error, delete receipt (transient errors)
       - Log summary: "Checked X receipts, removed Y invalid tokens"

    4. Update existing notification senders to pass userId where available:
       - sendPhotoRevealNotification: userId is available (userId param)
       - sendFriendRequestNotification: receiverId is available
       - sendReactionNotification: ownerId is available
       - sendCommentNotification: photo.userId (owner) is available

    AVOID: Blocking on receipt check completion. Don't retry failed receipt fetches (let next run handle it).

  </action>
  <verify>
    - `grep "checkPushReceipts" functions/index.js` shows function exists
    - `grep "every 15 minutes" functions/index.js` shows schedule
    - `grep "DeviceNotRegistered" functions/index.js` shows error handling
    - Deploy and check Firebase Console for new function
  </verify>
  <done>
    - checkPushReceipts scheduled function created
    - Runs every 15 minutes
    - Checks all pending receipts against Expo API
    - Removes invalid tokens when DeviceNotRegistered detected
    - Cleans up processed receipts from Firestore
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `firebase deploy --only functions` succeeds
- [ ] Firebase Console shows checkPushReceipts function
- [ ] `grep "pendingReceipts" functions/notifications/receipts.js` confirms collection
- [ ] `grep "removeInvalidToken" functions/index.js` confirms cleanup integration
</verification>

<success_criteria>

- Receipt checking scheduled function runs every 15 minutes
- Pending receipts stored in Firestore after successful sends
- DeviceNotRegistered errors trigger token removal from user doc
- Processed receipts cleaned up automatically
- Phase 34 infrastructure complete - ready for Phase 35 (Social Notification Events)
  </success_criteria>

<output>
After completion, create `.planning/phases/34-push-infrastructure/34-02-SUMMARY.md`:

# Phase 34 Plan 02: Push Infrastructure - Receipt Checking Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 34 complete, ready for Phase 35: Social Notification Events
</output>
