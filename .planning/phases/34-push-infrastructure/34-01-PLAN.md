---
phase: 34-push-infrastructure
plan: 01
type: execute
domain: expo-notifications
---

<objective>
Establish reliable push notification delivery foundation using expo-server-sdk and token refresh handling.

Purpose: Replace raw fetch calls with expo-server-sdk for automatic rate limiting, chunking, and retry logic. Add client-side token refresh listener to handle token changes on app reinstall.
Output: Robust push notification sender module with SDK-based sending and reliable token management.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-push-infrastructure/34-RESEARCH.md
@.planning/phases/34-push-infrastructure/34-CONTEXT.md

# Key files to reference:

@functions/index.js
@functions/package.json
@App.js
@src/services/firebase/notificationService.js

**Tech stack available:** expo-notifications, expo-server-sdk (to add)
**Established patterns:** Firebase Cloud Functions triggers, dual token storage (Firestore + SecureStore)

**From research - don't hand-roll:**

- Rate limiting → use expo-server-sdk
- Chunking → use expo.chunkPushNotifications()
- Token validation → use Expo.isExpoPushToken()
- Retry logic → expo-server-sdk built-in

**Constraining decisions:**

- Architecture: Firebase backend decides when to send, Expo delivers to devices
- Token storage: Dual storage pattern (Firestore for Cloud Functions, SecureStore for offline access)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Install expo-server-sdk and create sender module</name>
  <files>functions/package.json, functions/notifications/sender.js</files>
  <action>
    1. Run `cd functions && npm install expo-server-sdk` to add dependency
    2. Create `functions/notifications/` directory
    3. Create `functions/notifications/sender.js` with:
       - Initialize Expo client with optional access token from env
       - Export `sendPushNotification(token, title, body, data)` function that:
         - Validates token with `Expo.isExpoPushToken()`
         - Creates message with proper structure (to, sound:'default', title, body, data, priority:'high', channelId:'default')
         - Uses `expo.sendPushNotificationsAsync()` for sending
         - Returns `{ success, tickets }` or `{ success: false, error }`
         - Logs using functions.logger
       - Export `sendBatchNotifications(messages)` for future batch sends that:
         - Filters invalid tokens
         - Uses `expo.chunkPushNotifications()` for proper batching
         - Returns array of tickets

    AVOID: Using raw fetch calls (defeats the purpose of SDK). Don't hand-roll rate limiting or chunking.

  </action>
  <verify>
    - `ls functions/notifications/sender.js` shows file exists
    - `grep "expo-server-sdk" functions/package.json` shows dependency
    - `grep "Expo.isExpoPushToken" functions/notifications/sender.js` shows token validation
  </verify>
  <done>
    - expo-server-sdk installed in functions/package.json
    - sender.js exports sendPushNotification and sendBatchNotifications
    - Token validation uses Expo.isExpoPushToken
    - Sending uses expo.sendPushNotificationsAsync
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate existing sendPushNotification to use sender module</name>
  <files>functions/index.js</files>
  <action>
    1. Import sender module at top: `const { sendPushNotification } = require('./notifications/sender');`
    2. Delete the existing `sendPushNotification` function (lines ~165-204) that uses raw fetch
    3. Verify all existing callers (5 locations) still work:
       - sendPhotoRevealNotification (line ~302)
       - sendFriendRequestNotification (line ~404)
       - sendReactionNotification (line ~458)
       - sendCommentNotification (line ~800)
       - deletion reminder in checkDeletionWarnings (line ~1069)
    4. The function signature is identical (`sendPushNotification(token, title, body, data)`) so callers don't need changes

    AVOID: Changing the function signature (would break callers). Don't add new features yet - just migrate.

  </action>
  <verify>
    - `grep -c "exp.host" functions/index.js` returns 0 (no raw fetch calls)
    - `grep "require.*sender" functions/index.js` shows import
    - Run `firebase emulators:start --only functions` and verify no syntax errors (if emulators available)
  </verify>
  <done>
    - Old sendPushNotification removed from index.js
    - Import from notifications/sender.js added
    - All 5 notification trigger points still call sendPushNotification
    - No raw fetch calls to exp.host remain
  </done>
</task>

<task type="auto">
  <name>Task 3: Add token refresh listener to client</name>
  <files>App.js, src/services/firebase/notificationService.js</files>
  <action>
    1. In `notificationService.js`, export a new function `addTokenRefreshListener(userId, onRefresh)`:
       - Takes userId and optional callback
       - Returns `Notifications.addPushTokenListener(async ({ data }) => { ... })`
       - Inside listener: call `storeNotificationToken(userId, data)` to update Firestore
       - Log token refresh with logger

    2. In `App.js`, add token refresh listener in the notification useEffect:
       - After the existing token storage on startup (line ~84)
       - Add: `const tokenRefreshSub = Notifications.addPushTokenListener(async ({ data }) => { ... })`
       - Inside listener: if currentUser exists, call storeNotificationToken
       - Add cleanup in return: `if (tokenRefreshSub) tokenRefreshSub.remove()`

    AVOID: Creating a separate hook file - keep it simple in App.js since it's a single listener.

  </action>
  <verify>
    - `grep "addPushTokenListener" App.js` shows listener added
    - `grep "tokenRefreshSub" App.js` shows subscription variable
    - App still builds: `npx expo start --no-dev --minify` (or just verify no syntax errors)
  </verify>
  <done>
    - Token refresh listener added to App.js notification setup
    - Listener calls storeNotificationToken when token changes
    - Cleanup removes listener on unmount
    - Token refreshes will automatically sync to Firestore
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm ls expo-server-sdk --prefix functions` shows package installed
- [ ] `grep -c "exp.host" functions/index.js` returns 0
- [ ] `grep "addPushTokenListener" App.js` shows listener
- [ ] Functions deploy without errors: `firebase deploy --only functions`
</verification>

<success_criteria>

- expo-server-sdk installed and used for all notification sending
- No raw fetch calls to Expo Push API remain
- Token refresh listener syncs token changes to Firestore
- All existing notification triggers still work (reveal, friend request, reaction, comment, deletion)
  </success_criteria>

<output>
After completion, create `.planning/phases/34-push-infrastructure/34-01-SUMMARY.md`:

# Phase 34 Plan 01: Push Infrastructure - Reliability Foundation Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 34-02-PLAN.md (Receipt Checking)
</output>
