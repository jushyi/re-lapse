---
phase: 18.1-batched-darkroom-triage-with-undo
plan: 02
type: execute
---

<objective>
Implement reverse card animation for undo and Done button batch save flow.

Purpose: Complete the undo experience with smooth reverse animations and implement the batch save when user taps Done.
Output: Polished undo animation (cards slide back from exit direction) and Done button that saves all decisions to Firestore then closes darkroom.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18.1-batched-darkroom-triage-with-undo/18.1-CONTEXT.md

**Key source files:**
@src/screens/DarkroomScreen.js
@src/components/SwipeablePhotoCard.js
@src/services/firebase/photoService.js

**Previous plan context:**
Plan 01 established:
- undoStack state with entries: { photo, action, exitDirection }
- Local-only triage (no Firestore writes on swipe)
- Undo button UI in header with count display
- Basic undo (card restoration without animation)

**Phase context from discuss-phase:**
- Undo Animation: Card reverses its exit animation when undo is tapped
  - If card flew off to the right (journal), it slides back in from the right
  - Same for left (archive) or down (delete)
- Done Flow: Must explicitly tap Done to save
  - Silent save in background
  - Immediately closes darkroom and returns to camera
  - No success screen or confirmation message

**Exit directions:**
- archive → left → card slides back from left
- journal → right → card slides back from right
- delete → down → card slides back from bottom
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement reverse card animation for undo</name>
  <files>src/screens/DarkroomScreen.js, src/components/SwipeablePhotoCard.js</files>
  <action>
Implement smooth reverse animation when undo is tapped:

**In SwipeablePhotoCard.js:**

1. Add new prop `enterFrom` to control entry animation:
   ```javascript
   // In component props
   const SwipeablePhotoCard = forwardRef(({
     photo,
     onSwipeLeft,
     onSwipeRight,
     onSwipeDown,
     onSwipeStart,
     stackIndex = 0,
     isActive = true,
     cascading = false,
     enterFrom = null  // NEW: 'left', 'right', 'down', or null for no entry animation
   }, ref) => {
   ```

2. Add entry animation effect:
   ```javascript
   // Initialize position based on enterFrom (for undo animation)
   useEffect(() => {
     if (enterFrom && isActive) {
       // Start card off-screen in the direction it exited
       const ENTRY_DURATION = 400;

       if (enterFrom === 'left') {
         translateX.value = -SCREEN_WIDTH * 1.5;
         translateY.value = SCREEN_HEIGHT * 0.5;
       } else if (enterFrom === 'right') {
         translateX.value = SCREEN_WIDTH * 1.5;
         translateY.value = SCREEN_HEIGHT * 0.5;
       } else if (enterFrom === 'down') {
         translateX.value = 0;
         translateY.value = SCREEN_HEIGHT;
       }

       // Animate to center position
       translateX.value = withTiming(0, {
         duration: ENTRY_DURATION,
         easing: Easing.out(Easing.cubic),
       });
       translateY.value = withTiming(0, {
         duration: ENTRY_DURATION,
         easing: Easing.out(Easing.cubic),
       });
     }
   }, [enterFrom, isActive]);
   ```

**In DarkroomScreen.js:**

3. Add state to track undo animation:
   ```javascript
   const [undoingPhoto, setUndoingPhoto] = useState(null);
   // { photo, enterFrom } when animating undo, null otherwise
   ```

4. Modify handleUndo() for animated undo:
   ```javascript
   const handleUndo = useCallback(() => {
     if (undoStack.length === 0 || undoingPhoto) return;
     logger.info('DarkroomScreen: User tapped Undo button', { stackSize: undoStack.length });
     Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium);

     const lastDecision = undoStack[undoStack.length - 1];

     // Set up entry animation
     setUndoingPhoto({
       photo: lastDecision.photo,
       enterFrom: lastDecision.exitDirection,
     });

     // Update state
     setUndoStack(prev => prev.slice(0, -1));
     setPhotos(prev => [lastDecision.photo, ...prev]);

     // Clear undo animation state after animation completes
     setTimeout(() => {
       setUndoingPhoto(null);
     }, 450); // Slightly longer than ENTRY_DURATION

     // Reset success states if we had them
     setPendingSuccess(false);
     setTriageComplete(false);
   }, [undoStack, undoingPhoto]);
   ```

5. Pass enterFrom to SwipeablePhotoCard when rendering:
   ```javascript
   // In the photo cards map:
   <SwipeablePhotoCard
     ref={isActive ? cardRef : undefined}
     key={photo.id}
     photo={photo}
     stackIndex={stackIndex}
     isActive={isActive}
     cascading={cascading}
     enterFrom={isActive && undoingPhoto?.photo.id === photo.id ? undoingPhoto.enterFrom : null}
     onSwipeStart={isActive ? handleSwipeStart : undefined}
     // ... other props
   />
   ```

6. Disable undo during animation:
   - Add `undoingPhoto` to the disabled condition in handleUndo
   - Add visual feedback (optional: slightly dim button during animation)
  </action>
  <verify>
App builds without errors. In darkroom:
1. Swipe a card right (journal) - card exits to right
2. Tap Undo - card slides back in from the right smoothly
3. Swipe a card left (archive) - card exits to left
4. Tap Undo - card slides back in from the left
5. Tap delete button - card drops down
6. Tap Undo - card slides back up from bottom
7. Animation is smooth with appropriate timing (~400ms)
  </verify>
  <done>
Undo animation slides cards back from their exit direction with smooth easing. Cards re-enter the deck at front position.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Done button batch save and close flow</name>
  <files>src/screens/DarkroomScreen.js, src/services/firebase/photoService.js</files>
  <action>
Implement the Done button that saves all decisions and closes darkroom:

**In photoService.js:**

1. Add batch triage function:
   ```javascript
   /**
    * Batch triage multiple photos at once
    * @param {Array} decisions - Array of { photoId, action } objects
    * @returns {Promise<{success: boolean, error?: string}>}
    */
   export const batchTriagePhotos = async (decisions) => {
     try {
       logger.debug('PhotoService.batchTriagePhotos: Starting batch', { count: decisions.length });

       for (const { photoId, action } of decisions) {
         await triagePhoto(photoId, action);
       }

       logger.info('PhotoService.batchTriagePhotos: Batch complete', { count: decisions.length });
       return { success: true };
     } catch (error) {
       logger.error('PhotoService.batchTriagePhotos: Failed', { error: error.message });
       return { success: false, error: error.message };
     }
   };
   ```

**In DarkroomScreen.js:**

2. Import batchTriagePhotos:
   ```javascript
   import { getDevelopingPhotos, revealPhotos, triagePhoto, batchTriagePhotos } from '../services/firebase/photoService';
   ```

3. Add saving state:
   ```javascript
   const [saving, setSaving] = useState(false);
   ```

4. Implement handleDone():
   ```javascript
   const handleDone = async () => {
     if (saving) return;

     logger.info('DarkroomScreen: User tapped Done button', {
       photosRemaining: photos.length,
       decisionsToSave: undoStack.length
     });

     Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium);

     // If no decisions made, just close
     if (undoStack.length === 0) {
       navigation.goBack();
       return;
     }

     setSaving(true);

     // Build decisions array from undo stack
     const decisions = undoStack.map(entry => ({
       photoId: entry.photo.id,
       action: entry.action,
     }));

     // Batch save to Firestore (silent - no loading indicator shown to user)
     const result = await batchTriagePhotos(decisions);

     if (!result.success) {
       logger.error('DarkroomScreen: Batch save failed', { error: result.error });
       // On error, stay on screen and show alert
       setSaving(false);
       Alert.alert('Save Failed', 'Could not save your decisions. Please try again.');
       return;
     }

     // Success - close immediately (no celebration screen)
     successNotification(); // Play haptic on successful save
     navigation.goBack();
   };
   ```

5. Replace Done button in success state:
   - Change from current handleDonePress to handleDone
   - Update button text from "✓ Done" to just "Done" (no checkmark needed)
   - Add disabled state during saving

6. Also add Done button to normal triage view:
   - Add Done button in the header (next to Undo button) OR
   - Add Done button below the triage button bar
   - Button visible when undoStack.length > 0 OR photos.length === 0

   Recommendation: Add Done button in header next to Undo:
   ```javascript
   // In header, replace headerPlaceholder section with:
   <View style={styles.headerActions}>
     {(undoStack.length > 0 || photos.length === 0) && (
       <TouchableOpacity
         style={[styles.doneButton, saving && styles.doneButtonDisabled]}
         onPress={handleDone}
         disabled={saving}
       >
         <Text style={styles.doneButtonTextHeader}>Done</Text>
       </TouchableOpacity>
     )}
     <TouchableOpacity
       style={[styles.undoButton, undoStack.length === 0 && styles.undoButtonDisabled]}
       onPress={handleUndo}
       disabled={undoStack.length === 0 || undoingPhoto !== null}
     >
       <Text style={styles.undoIcon}>↩</Text>
       <Text style={[styles.undoText, undoStack.length === 0 && styles.undoTextDisabled]}>
         Undo{undoStack.length > 0 ? ` (${undoStack.length})` : ''}
       </Text>
     </TouchableOpacity>
   </View>
   ```

7. Add styles:
   ```javascript
   headerActions: {
     flexDirection: 'row',
     alignItems: 'center',
     gap: 8,
   },
   doneButton: {
     paddingHorizontal: 16,
     paddingVertical: 8,
     backgroundColor: '#007AFF',
     borderRadius: 20,
   },
   doneButtonDisabled: {
     opacity: 0.5,
   },
   doneButtonTextHeader: {
     fontSize: 14,
     fontWeight: '600',
     color: '#FFFFFF',
   },
   ```

8. Clean up the success state view:
   - Keep simple "All done!" message
   - Done button triggers batch save
   - Remove the separate doneButtonBottom from success state (use header Done button)
  </action>
  <verify>
App builds without errors. Full triage flow:
1. Open darkroom with photos
2. Swipe several cards (decisions stored locally)
3. Done button appears in header after first swipe
4. Tap Done - photos are saved to Firestore (verify in Firebase console)
5. Darkroom closes immediately, returns to camera
6. No success/celebration screen shown
7. Re-open darkroom - previously triaged photos are gone
  </verify>
  <done>
Done button saves all decisions to Firestore in batch, then immediately closes darkroom without celebration screen.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete batch triage with undo system</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. Open app on device, navigate to darkroom with revealed photos
    3. Test undo flow:
       - Swipe 3-4 cards in different directions
       - Tap Undo repeatedly - cards should animate back from correct direction
       - Verify card order is correct after undo
    4. Test Done flow:
       - Swipe all cards
       - Tap Done
       - Verify immediate close (no celebration)
       - Check Firebase console - photos should have updated status
    5. Test edge cases:
       - Close without tapping Done (go back) - changes should NOT save
       - Undo all the way back, then tap Done with empty undoStack
       - Error handling: disconnect network and tap Done
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] SwipeablePhotoCard accepts enterFrom prop for reverse animation
- [ ] Undo animates card back from correct exit direction
- [ ] Animation timing is smooth (~400ms)
- [ ] batchTriagePhotos function exists in photoService.js
- [ ] Done button visible after first decision
- [ ] Done saves all decisions to Firestore
- [ ] Done closes darkroom immediately (no celebration)
- [ ] Closing without Done does NOT save decisions
- [ ] Error handling shows alert on save failure
- [ ] No console errors or warnings
</verification>

<success_criteria>
- Reverse card animation working for all three directions
- Done button batch saves all decisions
- Silent close after Done (no success screen)
- Changes not persisted if user closes without Done
- Phase 18.1 complete
</success_criteria>

<output>
After completion, create `.planning/phases/18.1-batched-darkroom-triage-with-undo/18.1-02-SUMMARY.md`
</output>
