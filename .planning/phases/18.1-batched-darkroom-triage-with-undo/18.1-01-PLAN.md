---
phase: 18.1-batched-darkroom-triage-with-undo
plan: 01
type: execute
---

<objective>
Add undo stack state management and UI button for local triage decisions.

Purpose: Enable users to make triage decisions locally without immediate Firestore saves, with an Undo button to reverse decisions.
Output: DarkroomScreen with undo stack state, Undo button in header (dimmed when empty), and local-only triage handling.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18.1-batched-darkroom-triage-with-undo/18.1-CONTEXT.md

**Key source files:**
@src/screens/DarkroomScreen.js
@src/components/SwipeablePhotoCard.js
@src/services/firebase/photoService.js

**Architecture context:**
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

**Phase context from discuss-phase:**
- Batch save gives control — Nothing is permanent until user taps Done
- Multi-level undo — Can step back through multiple decisions by tapping Undo repeatedly
- Explicit Done tap required — Even after swiping the last card, must tap Done to save
- No session persistence — If app closes mid-triage, draft is discarded
- Undo button: rectangular with rounded edges, small icon + "Undo" text, top right of header
- Button dimmed when nothing to undo, active after first swipe decision

**Current behavior to change:**
- handleTriage() currently calls triagePhoto() immediately (Firestore write)
- Need to defer Firestore writes until Done button pressed
- Need to track decisions in undo stack for reversal
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add undo stack state and defer Firestore saves</name>
  <files>src/screens/DarkroomScreen.js</files>
  <action>
Modify DarkroomScreen to use local undo stack instead of immediate Firestore saves:

1. Add new state:
   ```javascript
   const [undoStack, setUndoStack] = useState([]);
   // Each entry: { photo: PhotoObject, action: 'archive'|'journal'|'delete', exitDirection: 'left'|'right'|'down' }
   ```

2. Modify handleTriage() to:
   - NOT call triagePhoto() (remove the Firestore save)
   - Push the photo + action + exit direction to undoStack
   - Remove photo from photos array (visual removal only)
   - Keep the existing animation timing and state management
   - exitDirection determined by action: archive='left', journal='right', delete='down'

3. Update success state logic:
   - Change from "triageComplete && photos.length === 0" to just "photos.length === 0 && undoStack.length > 0"
   - This shows the "All done!" state but still requires Done tap to save
   - Remove the successNotification() call (no celebration until Done)

4. Preserve existing:
   - Loading state
   - Empty state (no photos and no undo stack = truly empty)
   - Card animations and cascading behavior
   - Haptic feedback during swipes

Note: Do NOT remove the triagePhoto import yet - it will be used in Plan 2 for batch save.
  </action>
  <verify>
App builds without errors. Darkroom opens with photos. Swiping a card:
1. Card animates off screen as before
2. Card is removed from view
3. No Firestore write occurs (check Firebase console - photo status should still be 'revealed')
4. undoStack now contains the decision
  </verify>
  <done>
Swiping cards stores decisions locally in undoStack without saving to Firestore. Photos are visually removed but not permanently triaged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Undo button to header UI</name>
  <files>src/screens/DarkroomScreen.js</files>
  <action>
Add Undo button in header that shows decision count:

1. Replace headerPlaceholder (right side) with Undo button:
   ```javascript
   <TouchableOpacity
     style={[
       styles.undoButton,
       undoStack.length === 0 && styles.undoButtonDisabled
     ]}
     onPress={handleUndo}
     disabled={undoStack.length === 0}
   >
     <Text style={styles.undoIcon}>↩</Text>
     <Text style={[
       styles.undoText,
       undoStack.length === 0 && styles.undoTextDisabled
     ]}>
       Undo{undoStack.length > 0 ? ` (${undoStack.length})` : ''}
     </Text>
   </TouchableOpacity>
   ```

2. Add styles for Undo button:
   - undoButton: flexDirection row, alignItems center, paddingHorizontal 12, paddingVertical 8, backgroundColor rgba(255,255,255,0.1), borderRadius 20
   - undoButtonDisabled: opacity 0.3
   - undoIcon: fontSize 16, color white, marginRight 4
   - undoText: fontSize 14, fontWeight 600, color white
   - undoTextDisabled: opacity 0.5

3. Add handleUndo() stub (actual animation in Plan 2):
   ```javascript
   const handleUndo = () => {
     if (undoStack.length === 0) return;
     logger.info('DarkroomScreen: User tapped Undo button', { stackSize: undoStack.length });
     Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
     // Animation implementation in Plan 2
     // For now, just pop from stack and restore to photos
     const lastDecision = undoStack[undoStack.length - 1];
     setUndoStack(prev => prev.slice(0, -1));
     setPhotos(prev => [lastDecision.photo, ...prev]);
     // Reset pendingSuccess/triageComplete if needed
     setPendingSuccess(false);
     setTriageComplete(false);
   };
   ```

4. Ensure button appears in all states:
   - Normal triage view (with photos)
   - "All done" success state (photos.length === 0 but undoStack has entries)

5. Update header layout:
   - Remove headerPlaceholder from styles
   - Ensure Undo button width matches back button width for centered title
  </action>
  <verify>
App builds without errors. In darkroom:
1. Undo button appears in top right of header
2. Button is dimmed/disabled when no decisions made
3. After swiping a card, button becomes active and shows "(1)"
4. Tapping Undo restores the last swiped card to the deck
5. Undo count updates correctly with each swipe/undo
  </verify>
  <done>
Undo button visible in header, disabled when empty, shows count when decisions exist, basic undo functionality restores cards to deck.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx expo start` builds without errors
- [ ] Swiping cards does NOT save to Firestore (verify in Firebase console)
- [ ] undoStack tracks all decisions with photo, action, exitDirection
- [ ] Undo button appears in header, properly styled
- [ ] Undo button disabled (dimmed) when undoStack is empty
- [ ] Undo button shows count "(N)" when decisions exist
- [ ] Tapping Undo restores card to deck and decrements count
- [ ] Success state shows after all cards swiped (but before Done)
- [ ] No console errors or warnings
</verification>

<success_criteria>
- Undo stack state management implemented
- Firestore saves deferred (no immediate writes on swipe)
- Undo button UI complete with proper styling
- Basic undo functionality working (card restoration)
- All existing functionality preserved (loading, empty state, animations)
</success_criteria>

<output>
After completion, create `.planning/phases/18.1-batched-darkroom-triage-with-undo/18.1-01-SUMMARY.md`
</output>
