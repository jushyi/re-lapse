---
phase: 18.1-batched-darkroom-triage-with-undo
plan: FIX-3
type: fix
---

<objective>
Fix UAT-003: Black flash during card transitions by migrating from React Native Image to expo-image.

Source: 18.1-ISSUES.md, 18.1-UAT003-RESEARCH.md
Priority: 1 major issue
Root cause: RN Image has unreliable caching and no built-in transitions, causing rendering delay when cards animate forward in the stack.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/18.1-batched-darkroom-triage-with-undo/18.1-ISSUES.md

**Research findings:**
@.planning/phases/18.1-batched-darkroom-triage-with-undo/18.1-UAT003-RESEARCH.md

**Files to modify:**
@src/components/SwipeablePhotoCard.js
@src/screens/DarkroomScreen.js
</context>

<tasks>
<task type="auto">
  <name>Task 1: Install expo-image</name>
  <files>package.json</files>
  <action>
Install expo-image using the Expo CLI:
```bash
npx expo install expo-image
```

This adds the native caching (SDWebImage on iOS, Glide on Android) and built-in transition support that will eliminate the black flash.
  </action>
  <verify>
```bash
npm list expo-image
```
Package should be installed and listed in package.json dependencies.
  </verify>
  <done>expo-image ~2.0.x installed in project</done>
</task>

<task type="auto">
  <name>Task 2: Migrate SwipeablePhotoCard to expo-image</name>
  <files>src/components/SwipeablePhotoCard.js</files>
  <action>
Replace React Native Image with expo-image in SwipeablePhotoCard.js:

1. **Change import:**
   - Remove: `Image,` from react-native imports
   - Add: `import { Image } from 'expo-image';`

2. **Update Image component props:**
   Replace the current Image component (lines ~524-540):
   ```jsx
   <Image
     source={{ uri: photo.imageURL }}
     style={styles.photoImage}
     contentFit="cover"
     transition={200}
     cachePolicy="memory-disk"
     onError={(error) =>
       logger.error('SwipeablePhotoCard: Image load error', {
         photoId: photo.id,
         error: error.error,
       })
     }
     onLoad={() =>
       logger.debug('SwipeablePhotoCard: Image loaded successfully', {
         photoId: photo.id,
       })
     }
   />
   ```

   Key changes:
   - `resizeMode="cover"` → `contentFit="cover"` (expo-image API)
   - Add `transition={200}` - 200ms cross-dissolve prevents flash
   - Add `cachePolicy="memory-disk"` - fast memory + disk fallback
   - Remove `fadeDuration={0}` (not needed, expo-image handles this)
   - Update error callback: `error.nativeEvent.error` → `error.error` (expo-image API)

3. **Remove stack blur overlay (simplification):**
   The blur overlay was a workaround for RN Image rendering delay. With expo-image's built-in transition, it's no longer needed.

   Remove:
   - Line ~85: `const stackBlurOpacityAnim = useSharedValue(getStackBlurOpacity(stackIndex));`
   - Lines ~77-78: `getStackBlurOpacity` helper function
   - All references to `stackBlurOpacityAnim` in useEffect hooks (lines ~118, ~124, ~151, ~156)
   - Lines ~495-499: `stackBlurOverlayStyle` animated style
   - Lines ~542-546: Stack blur overlay View from render
   - Lines ~622-629: `stackBlurOverlay` style from StyleSheet

   This removes ~50 lines of workaround code that expo-image makes unnecessary.

IMPORTANT: Do NOT remove the cascadeHandledTransition flag logic - that's still needed to prevent double-animation during cascade. Only remove the blur overlay.
  </action>
  <verify>
Build the project and verify no TypeScript/syntax errors:
```bash
npx expo start --clear
```
Check that the app loads and DarkroomScreen opens without crashes.
  </verify>
  <done>
- expo-image imported and used for photo display
- transition={200} and cachePolicy="memory-disk" props added
- Stack blur overlay removed (no longer needed)
- App builds without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Add image prefetching to DarkroomScreen</name>
  <files>src/screens/DarkroomScreen.js</files>
  <action>
Add image prefetching when photos load to ensure all visible stack cards are cached before animations:

1. **Add import:**
   ```jsx
   import { Image as ExpoImage } from 'expo-image';
   ```
   (Use alias to avoid conflicts if Image is used elsewhere)

2. **Add prefetch useEffect** after the photos state is loaded:
   ```jsx
   // Prefetch visible stack card images for smooth animations
   useEffect(() => {
     const prefetchStackImages = async () => {
       if (photos.length === 0) return;

       // Get first 4 visible photos (visible in stack)
       const visiblePhotos = photos.filter(p => !hiddenPhotoIds.has(p.id)).slice(0, 4);
       const urls = visiblePhotos.map(p => p.imageURL).filter(Boolean);

       if (urls.length === 0) return;

       try {
         await ExpoImage.prefetch(urls, 'memory-disk');
         logger.debug('DarkroomScreen: Prefetched stack images', { count: urls.length });
       } catch (error) {
         // Non-blocking - images will load on demand if prefetch fails
         logger.warn('DarkroomScreen: Failed to prefetch some images', { error: error?.message });
       }
     };

     prefetchStackImages();
   }, [photos, hiddenPhotoIds]);
   ```

   This ensures:
   - First 4 cards are prefetched into memory-disk cache
   - As cards are swiped away (hiddenPhotoIds changes), new cards get prefetched
   - Undo animations have cached images ready

Place this useEffect near other photo-related effects in the component.
  </action>
  <verify>
Open DarkroomScreen with photos and check console logs for prefetch debug messages.
Verify no errors during prefetch.
  </verify>
  <done>
- ExpoImage.prefetch() called when photos load
- First 4 visible photos prefetched to memory-disk cache
- Prefetch re-runs when hiddenPhotoIds changes
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Migrated from React Native Image to expo-image with:
- Built-in 200ms transition (eliminates flash)
- Native memory-disk caching
- Image prefetching for stack cards
- Removed unnecessary blur overlay workaround
  </what-built>
  <how-to-verify>
1. Start the app: `npx expo start --clear`
2. Open Darkroom with 2+ photos
3. Test forward swipe:
   - Swipe first card left/right to Archive/Journal
   - Watch transition to next card
   - **Expected:** Smooth transition, NO black flash
4. Test undo:
   - Tap Undo button
   - Watch card animate back
   - **Expected:** Smooth entry animation, NO black flash
5. Repeat swiping through multiple cards
6. Test button-triggered actions:
   - Use Archive/Journal/Delete buttons instead of swipes
   - **Expected:** Smooth exit with NO flash on next card
  </how-to-verify>
  <resume-signal>Type "approved" if black flash is eliminated, or describe remaining issues</resume-signal>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] expo-image installed and working
- [ ] SwipeablePhotoCard uses expo-image with transition prop
- [ ] Image prefetching works in DarkroomScreen
- [ ] Black flash eliminated on forward swipe
- [ ] Black flash eliminated on undo animation
- [ ] All existing triage functionality works (Archive/Journal/Delete)
</verification>

<success_criteria>
- UAT-003 resolved: No black flash during card transitions (forward or undo)
- expo-image properly integrated
- Image prefetching in place for smooth animations
- Code simplified by removing blur overlay workaround
</success_criteria>

<output>
After completion, create `.planning/phases/18.1-batched-darkroom-triage-with-undo/18.1-FIX-3-SUMMARY.md`
</output>
