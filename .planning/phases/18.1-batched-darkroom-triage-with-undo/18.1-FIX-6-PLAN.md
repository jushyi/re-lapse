---
phase: 18.1-batched-darkroom-triage-with-undo
plan: FIX-6
type: fix
---

<objective>
Fix UAT-006: Card cascade animation snaps to position instead of smooth 350ms glide.

Source: 18.1-ISSUES.md
Priority: 0 critical, 0 major, 1 minor

Root cause hypothesis: The timing animation in the stackIndex useEffect is being overwritten or reset because:
1. React component identity is preserved via stable `key={photo.id}`
2. When stackIndex changes (e.g., 1â†’0), the useEffect correctly detects the change
3. However, the shared values (stackScaleAnim, stackOffsetAnim, stackOpacityAnim) may be instantly set to their target values on the SAME tick that the animation starts, causing a "snap"

Investigation needed: Verify whether the animation is being interrupted or never playing at all.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/18.1-batched-darkroom-triage-with-undo/18.1-ISSUES.md

**Key file:**
@src/components/SwipeablePhotoCard.js
@src/screens/DarkroomScreen.js
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add animation debugging to identify root cause</name>
  <files>src/components/SwipeablePhotoCard.js</files>
  <action>
Add console.log statements inside the stackIndex useEffect to verify:
1. Whether the useEffect is firing when stackIndex changes
2. What the current values of stackScaleAnim, stackOffsetAnim, stackOpacityAnim are BEFORE animation starts
3. What the target values are

Also add runOnJS logging inside the animation callbacks to verify if animations complete.

This is diagnostic code that will be removed once the fix is verified.
  </action>
  <verify>Run the app, swipe a card, check console logs to understand if:
- useEffect is firing
- Animation is starting from expected values
- Animation is completing or being interrupted</verify>
  <done>Logs reveal whether animation plays or is being overwritten</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Added diagnostic logging to cascade animation</what-built>
  <how-to-verify>
    1. Run the app: npx expo start
    2. Open darkroom with 3+ photos
    3. Swipe a card to triage
    4. Check console output for animation logs
    5. Report what you see:
       - Does "stackIndex changed" log appear?
       - What are the "before" values?
       - Does "animation complete" log appear?
  </how-to-verify>
  <resume-signal>Report the log output findings</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Fix animation based on diagnostic findings</name>
  <files>src/components/SwipeablePhotoCard.js</files>
  <action>
Based on diagnostic findings, implement one of these fixes:

**If animation never fires:** Check useEffect dependencies and prevStackIndex comparison logic.

**If animation starts but snaps:** The shared values may be getting reset elsewhere. Ensure initial values are set correctly on component mount but not reset on re-render.

**If animation is interrupted:** Look for competing animations on the same shared values.

**Likely fix (based on code review):**
The issue is that `getStackScale/Offset/Opacity(stackIndex)` is used to initialize shared values, but these functions are called on every render. When stackIndex changes:
1. Component re-renders with new stackIndex
2. Initial value calculation happens: `const stackScaleAnim = useSharedValue(getStackScale(stackIndex))`
3. useEffect fires and starts animation from current value TO same target
4. Animation has nowhere to go because initialValue = targetValue

**Solution:** Only set initial values on mount, not on stackIndex change. Use a `useMemo` or initialization flag to ensure shared values are only set once, then animated on subsequent stackIndex changes.
  </action>
  <verify>`npx expo export --platform ios` builds without errors</verify>
  <done>Animation plays smoothly when card transitions to front position</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed cascade animation to glide smoothly</what-built>
  <how-to-verify>
    1. Run the app: npx expo start
    2. Open darkroom with 3+ photos
    3. Swipe a card to triage
    4. Observe the next card moving to front position
    5. Verify: Card glides smoothly over 350ms (no snap)
    6. Test multiple swipes to ensure consistent behavior
  </how-to-verify>
  <resume-signal>Type "approved" if animation glides smoothly, or describe any issues</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Remove diagnostic logging</name>
  <files>src/components/SwipeablePhotoCard.js</files>
  <action>
Remove all console.log statements added for debugging in Task 1.
Keep only production-ready code.
  </action>
  <verify>`npx expo export --platform ios` builds without errors</verify>
  <done>Diagnostic code removed, production code clean</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx expo export --platform ios` succeeds without errors
- [ ] Card cascade animation glides smoothly (350ms)
- [ ] No diagnostic code remaining in production
- [ ] Undo animation still works correctly
- [ ] New card fade-in animation still works correctly
</verification>

<success_criteria>
- UAT-006 resolved: Card cascade animates smoothly, not snapping
- No regressions in undo or fade-in animations
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/18.1-batched-darkroom-triage-with-undo/18.1-FIX-6-SUMMARY.md`
</output>
