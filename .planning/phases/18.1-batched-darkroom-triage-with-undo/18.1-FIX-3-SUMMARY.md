---
phase: 18.1-batched-darkroom-triage-with-undo
plan: FIX-3
subsystem: ui
tags: [expo-image, react-native, image-caching, animations]

# Dependency graph
requires:
  - phase: 18.1-FIX-2
    provides: Hidden state tracking to prevent black flash from array mutation
provides:
  - expo-image integration with native caching and transitions
  - Image prefetching for stack card animations
  - Simplified code (removed blur overlay workaround)
affects: [darkroom-animations, image-performance]

# Tech tracking
tech-stack:
  added: [expo-image@3.0.11]
  patterns: [expo-image-prefetch, memory-disk-caching, built-in-transitions]

key-files:
  created: []
  modified: [src/components/SwipeablePhotoCard.js, src/screens/DarkroomScreen.js, package.json]

key-decisions:
  - "Use expo-image instead of RN Image for native caching and built-in transitions"
  - "Remove blur overlay workaround - expo-image transition prop eliminates need"
  - "Prefetch first 4 visible stack images on photos load and hiddenPhotoIds change"

patterns-established:
  - "expo-image with transition={200} and cachePolicy='memory-disk' for animated images"
  - "ExpoImage.prefetch() for preloading images before animations"

issues-created: []

# Metrics
duration: 12min
completed: 2026-01-23
---

# Phase 18.1 FIX-3: UAT-003 Black Flash Fix via expo-image Migration Summary

**Migrated from React Native Image to expo-image with native caching, 200ms cross-dissolve transitions, and image prefetching to eliminate black flash during card triage animations**

## Performance

- **Duration:** 12 min
- **Started:** 2026-01-23T11:00:00Z
- **Completed:** 2026-01-23T11:12:00Z
- **Tasks:** 4 (3 auto + 1 verify checkpoint)
- **Files modified:** 3

## Accomplishments

- Installed expo-image@3.0.11 with native SDWebImage (iOS) / Glide (Android) caching
- Migrated SwipeablePhotoCard from RN Image to expo-image with transition={200} and cachePolicy="memory-disk"
- Removed ~60 lines of blur overlay workaround code (no longer needed with expo-image)
- Added image prefetching to DarkroomScreen for first 4 visible stack cards

## Task Commits

Each task was committed atomically:

1. **Task 1: Install expo-image** - `486fd7b` (chore)
2. **Task 2: Migrate SwipeablePhotoCard to expo-image** - `1dbb3ba` (feat)
3. **Task 3: Add image prefetching to DarkroomScreen** - `f747c6d` (feat)

**Plan metadata:** TBD (docs: complete plan)

## Files Created/Modified

- `package.json` - Added expo-image@3.0.11 dependency
- `src/components/SwipeablePhotoCard.js` - Replaced RN Image with expo-image, removed blur overlay
- `src/screens/DarkroomScreen.js` - Added ExpoImage import and prefetch useEffect

## Decisions Made

1. **expo-image over RN Image** - Native caching (SDWebImage/Glide) and built-in transition prop eliminate the black flash caused by RN Image's unreliable HTTP-based caching
2. **Remove blur overlay** - The blur overlay was a workaround for RN Image rendering delay; expo-image's transition prop handles this automatically and better
3. **Prefetch 4 cards** - Prefetching first 4 visible photos ensures all animated cards have cached images ready

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

- **Native module error in Expo Go:** After installing expo-image, received "Cannot find native module 'ExpoImage'" error. This is expected because:
  - Project uses `expo-dev-client` and `@react-native-firebase` (requires development build)
  - expo-image native module requires rebuilding the development client
  - **Resolution:** User needs to run `npx expo run:ios` or `npx expo run:android` to rebuild with expo-image included
  - **Note:** This is not a code bug - the fix is correct, just requires native rebuild

## Next Phase Readiness

- UAT-003 fix ready for verification after development build rebuild
- All code changes committed and working
- User should rebuild dev client and verify:
  - No black flash on forward swipe (Archive/Journal)
  - No black flash on undo animation
  - No black flash on button-triggered triage

---
*Phase: 18.1-batched-darkroom-triage-with-undo*
*Completed: 2026-01-23*
