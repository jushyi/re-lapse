---
phase: 18.1-batched-darkroom-triage-with-undo
plan: FIX-6
subsystem: ui
tags: [reanimated, animation, cascade, triage, darkroom]

# Dependency graph
requires:
  - phase: 18.1
    provides: SwipeablePhotoCard with cascade animation
provides:
  - Smooth cascade animation when card transitions to front position
  - isTransitioningToFront flag for animation-to-gesture handoff
affects: [18.2, 18.3, 18.4]

# Tech tracking
tech-stack:
  added: []
  patterns: ["isTransitioningToFront flag for animated style branching"]

key-files:
  created: []
  modified: [src/components/SwipeablePhotoCard.js]

key-decisions:
  - "Use isTransitioningToFront flag to control cardStyle transform source"
  - "Clear flag via animation callback (not setTimeout) for accurate timing"

patterns-established:
  - "When animated style switches transform sources (stack vs gesture), use flag to delay switch until animation completes"

issues-created: []

# Metrics
duration: 12min
completed: 2026-01-23
---

# Phase 18.1 FIX-6: UAT-006 Cascade Animation Snap Fix Summary

**Fixed cascade animation snap by tracking transition state - cardStyle now continues using stackOffsetAnim during 450ms transition to front position before switching to gesture transforms**

## Performance

- **Duration:** 12 min
- **Started:** 2026-01-23T19:40:00Z
- **Completed:** 2026-01-23T19:52:00Z
- **Tasks:** 3 (+ 2 checkpoints)
- **Files modified:** 1

## Accomplishments

- Identified root cause: cardStyle immediately switched from stackOffsetAnim to translateX/Y when isActive became true, ignoring the running animation
- Added isTransitioningToFront shared value flag to track transition state
- Modified cardStyle to continue using stack animation values during transition
- Flag clears via animation callback for accurate timing

## Task Commits

Each task was committed atomically:

1. **Task 1: Add animation debugging** - `49d1d19` (chore)
2. **Task 2: Fix animation with transition flag** - `91652e6` (fix)
3. **Task 3: Remove diagnostic logging** - `c4fb75a` (chore)

## Files Created/Modified

- `src/components/SwipeablePhotoCard.js` - Added isTransitioningToFront flag, modified cardStyle to use it

## Decisions Made

1. **Use shared value flag instead of state** - Shared values update synchronously in worklets, ensuring cardStyle sees the flag immediately
2. **Clear flag via animation callback** - More accurate than setTimeout, ensures flag clears exactly when animation completes
3. **Branch on `isTransitioningToFront.value === 1 || !isActive`** - Simple condition that handles both stack cards and transitioning front card

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - diagnostic logging immediately revealed the root cause.

## Root Cause Analysis

The cascade animation snap was caused by a transform source mismatch:

1. Card at `stackIndex=1` used `stackOffsetAnim` in cardStyle (correct)
2. Card receives new prop `stackIndex=0`, triggering useEffect to animate
3. Card also receives `isActive=true` from DarkroomScreen
4. On same render, cardStyle condition `if (isActive)` became true
5. cardStyle switched to using `translateX/translateY` instead of `stackOffsetAnim`
6. The animation running on `stackOffsetAnim` was ignored - no visual effect
7. Card appeared to "snap" because it was now using static translateX/Y values (0,0)

The fix adds `isTransitioningToFront` flag that:
- Sets to 1 when animation starts for card moving to front
- Keeps cardStyle using stackOffsetAnim until animation completes
- Clears to 0 via animation callback
- Only then does cardStyle switch to translateX/Y for gestures

## Next Phase Readiness

- Phase 18.1 complete - all 6 FIX plans resolved UAT issues
- All cascade animation issues resolved (UAT-001 through UAT-006)
- Ready for Phase 18.2: Success Sound Effect on Triage Completion

---
*Phase: 18.1-batched-darkroom-triage-with-undo*
*Completed: 2026-01-23*
