---
phase: 40-feed-photo-tagging
plan: 01
type: execute
---

<objective>
Add friend tagging to feed photos via PhotoDetailScreen — owner can add/remove tags using the existing TagFriendsModal, non-owners can view tagged people and navigate to their profiles.

Purpose: Extend photo tagging from darkroom-only (Phase 39) to existing feed photos, giving users a way to tag friends after the fact.
Output: Tag button on PhotoDetailScreen, TaggedPeopleModal for viewers, direct tag persistence to Firestore.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-feed-photo-tagging/40-CONTEXT.md

# Direct dependency — tagging infrastructure:

@.planning/phases/39-darkroom-tagging/39-01-SUMMARY.md

# Key source files:

@src/screens/PhotoDetailScreen.js
@src/styles/PhotoDetailScreen.styles.js
@src/components/TagFriendsModal.js
@src/styles/TagFriendsModal.styles.js
@src/services/firebase/photoService.js
@src/components/FeedPhotoCard.js
@src/components/index.js

**Tech stack available:** React Native + Expo, Firebase Firestore, Ionicons
**Established patterns:**

- TagFriendsModal: slide-up dark modal with friend multi-select (Phase 39)
- Tag data: `{ taggedUserIds: string[], taggedAt: serverTimestamp() }` on photo docs
- photoMenuButton: absolute positioned button at bottom-right of PhotoDetailScreen
- DropdownMenu: anchored menu pattern for owner actions
- Profile navigation: `onAvatarPress(userId, displayName)` callback pattern

**Constraining decisions:**

- Phase 39: Tags written directly to photo doc, Cloud Function auto-detects changes
- Phase 36: sendTaggedPhotoNotification Cloud Function triggers on taggedUserIds update — no extra notification work needed here
- Phase 40 CONTEXT.md: Tag button above three-dots menu, not in submenu. Icon highlights when tags exist (no count badge).

**Out of scope (from CONTEXT.md):**

- Tag notifications — Phase 41 (Cloud Function already exists from Phase 36, fires automatically)
- Self-untagging — future work
- Other locations (stories, album viewer) — feed only
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Add tag button and owner tagging to PhotoDetailScreen</name>
  <files>src/screens/PhotoDetailScreen.js, src/styles/PhotoDetailScreen.styles.js, src/services/firebase/photoService.js</files>
  <action>
**photoService.js — Add updatePhotoTags function:**
- Export `updatePhotoTags(photoId, taggedUserIds)` that writes `{ taggedUserIds, taggedAt: serverTimestamp() }` to the photo doc via `updateDoc`. If taggedUserIds is empty array, write `{ taggedUserIds: deleteField(), taggedAt: deleteField() }` to clean up (same pattern as darkroom — empty arrays not stored). Return `{ success: true }` or `{ success: false, error }`.

**PhotoDetailScreen.js — Add tag button and modal:**

- Import `TagFriendsModal` from components and `updatePhotoTags` from photoService.
- Add state: `tagModalVisible` (boolean), `taggedPeopleModalVisible` (boolean).
- Read `currentPhoto.taggedUserIds` (may be undefined) to determine if photo has tags.
- Add tag button positioned ABOVE the existing photoMenuButton (use absolute positioning, same right alignment, bottom value ~150 to sit above the menu button at bottom: 102). Style: 44x44 container, centered icon.
- Icon logic: If photo has taggedUserIds with length > 0, use `person` (filled) icon. Otherwise use `person-add-outline`. Icon color: `colors.text.primary` always (highlight is the icon fill, not color change).
- Tag button visible for ALL users (both owner and non-owner) BUT only when photo has tags OR user is owner. Non-owners only see it when tags exist.
- onPress behavior:
  - If `isOwnPhoto`: set `tagModalVisible = true` (opens TagFriendsModal for editing)
  - If NOT `isOwnPhoto`: set `taggedPeopleModalVisible = true` (opens TaggedPeopleModal for viewing — Task 2)
- Render TagFriendsModal with:
  - `visible={tagModalVisible}`
  - `onClose={() => setTagModalVisible(false)}`
  - `initialSelectedIds={currentPhoto?.taggedUserIds || []}`
  - `onConfirm={async (selectedIds) => { await updatePhotoTags(currentPhoto.id, selectedIds); setTagModalVisible(false); }}` — persist immediately (unlike darkroom which batches on Done)
- Do NOT show tag button in stories mode (`contextMode === 'stories'`) — tagging is for feed photos only.

**PhotoDetailScreen.styles.js — Add tag button style:**

- `tagButton`: absolute positioned, bottom: 150 (above photoMenuButton at 102), right: 8, width: 44, height: 46, justifyContent/alignItems center, zIndex: 10. Same pattern as photoMenuButton.
  </action>
  <verify>App builds without errors. Tag button appears above three-dots menu on own feed photos in PhotoDetailScreen. Tapping opens TagFriendsModal. Selecting friends and confirming writes taggedUserIds to Firestore photo doc.</verify>
  <done>Tag button visible on PhotoDetailScreen for own photos. Owner can open TagFriendsModal, select friends, and tags persist to Firestore. Icon changes to filled person when tags exist. Button hidden in stories mode.</done>
  </task>

<task type="auto">
  <name>Task 2: Create TaggedPeopleModal for non-owner viewing</name>
  <files>src/components/TaggedPeopleModal.js, src/styles/TaggedPeopleModal.styles.js, src/components/index.js, src/screens/PhotoDetailScreen.js</files>
  <action>
**TaggedPeopleModal.js — New component:**
- Same slide-up dark modal pattern as TagFriendsModal (Modal with transparent backdrop, animated slide-up content).
- Props: `visible`, `onClose`, `taggedUserIds` (string[]), `onPersonPress(userId, displayName)`.
- On visible, fetch user profiles for each taggedUserIds entry using `getUserProfile` from friendService (same approach TagFriendsModal uses to fetch friend data).
- Render list of tagged people: each row has profile photo (40x40 circle), display name, and username. Use FlatList.
- Tapping a row calls `onPersonPress(userId, displayName)` then closes modal.
- Header: "Tagged People" title with close X button (same layout as TagFriendsModal header).
- Loading state: ActivityIndicator while fetching profiles.
- Empty state: Should not occur (button only shows when tags exist), but handle gracefully with "No one tagged" message.
- Max height: 400px (same as TagFriendsModal).

**TaggedPeopleModal.styles.js — Styles:**

- Follow TagFriendsModal.styles.js pattern exactly: modalOverlay, modalContent (maxHeight 400), header, title, closeButton, personRow (flexDirection row, alignItems center, padding 12), profilePhoto (40x40 circle), textContainer (marginLeft 12), displayName (white, 16px), username (secondary color, 14px).

**index.js — Export:**

- Add `export { default as TaggedPeopleModal } from './TaggedPeopleModal';`

**PhotoDetailScreen.js — Wire up TaggedPeopleModal:**

- Import TaggedPeopleModal.
- Render TaggedPeopleModal with:
  - `visible={taggedPeopleModalVisible}`
  - `onClose={() => setTaggedPeopleModalVisible(false)}`
  - `taggedUserIds={currentPhoto?.taggedUserIds || []}`
  - `onPersonPress={(userId, userName) => { setTaggedPeopleModalVisible(false); contextAvatarPress?.(userId, userName); }}` — navigates to profile using existing pattern.
    </action>
    <verify>Non-owner viewing a tagged photo sees tag button. Tapping opens TaggedPeopleModal showing tagged people with profile photos and names. Tapping a person navigates to their profile.</verify>
    <done>TaggedPeopleModal created and integrated. Non-owners can view tagged people and navigate to profiles. Component exported from index.js.</done>
    </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Feed photo tagging — owner can tag friends via TagFriendsModal, non-owners can view tagged people via TaggedPeopleModal</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. Open a feed photo you own (tap to open PhotoDetailScreen)
    3. Verify: Tag button (person-add-outline icon) appears above the three-dots menu
    4. Tap tag button → TagFriendsModal opens with friend list
    5. Select 1-2 friends → tap Done
    6. Verify: Tag button icon changes to filled person (person icon)
    7. Close and reopen the same photo → tags persist (filled icon still shows)
    8. Log in as a different user (or view from friend's perspective)
    9. Open the same tagged photo → tag button visible (filled person icon)
    10. Tap tag button → TaggedPeopleModal shows tagged people with photos/names
    11. Tap a tagged person → navigates to their profile
    12. Open a photo in stories mode → verify tag button is NOT shown
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] App builds without errors (`npx expo start` runs)
- [ ] Tag button appears on own feed photos in PhotoDetailScreen
- [ ] Tag button hidden in stories mode
- [ ] Owner: TagFriendsModal opens, tags persist to Firestore
- [ ] Viewer: TaggedPeopleModal shows tagged people, profile navigation works
- [ ] Icon changes between outline (no tags) and filled (has tags)
- [ ] Empty tag arrays cleaned up (deleteField, not empty array in Firestore)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Owner can tag friends on feed photos via existing TagFriendsModal
- Non-owners can view tagged people and navigate to profiles
- Tags persist to Firestore with correct schema (taggedUserIds, taggedAt)
- Phase 40 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/40-feed-photo-tagging/40-01-SUMMARY.md`
</output>
