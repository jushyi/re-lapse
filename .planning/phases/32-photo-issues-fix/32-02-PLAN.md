---
phase: 32-photo-issues-fix
plan: 02
type: execute
---

<objective>
Build custom profile photo crop UI with circular preview and gesture support.

Purpose: Replace expo-image-picker's square crop with a custom screen that shows circular preview matching how profile photos display, with pinch-to-zoom and pan gestures.
Output: ProfilePhotoCropScreen integrated into EditProfileScreen and ProfileSetupScreen flows.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-photo-issues-fix/32-CONTEXT.md
@.planning/ISSUES.md

**Issue being addressed:** ISS-011 (Custom profile photo crop UI with circular preview)

**Key files:**
@src/screens/EditProfileScreen.js
@src/screens/ProfileSetupScreen.js

**Tech available:**

- expo-image-manipulator (for cropping)
- react-native-gesture-handler (for pinch/pan)
- react-native-reanimated (for smooth animations)
- expo-image (for image display)

**From 32-CONTEXT.md:**

- Full photo visible with circle overlay, dimmed areas outside
- Confirm/Cancel buttons (explicit commit, not auto-save)
- Pinch-to-zoom and pan gestures
- Crisp, direct gesture response - no bouncy animations
- Reasonable zoom limits: minimum shows full photo in circle, maximum prevents pixelation

**Current state:**

- Both screens use expo-image-picker with `allowsEditing: true, aspect: [1, 1]`
- System provides square crop mask, not circular preview
- No ability to edit/re-crop existing profile photo

**Target state:**

- Custom crop screen with circular mask overlay
- Pinch-to-zoom and pan to position
- Cropped output is square (1:1) matching the circular preview area
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProfilePhotoCropScreen with circular overlay and gestures</name>
  <files>src/screens/ProfilePhotoCropScreen.js</files>
  <action>
    Create new screen with:

    1. **Layout:**
       - Full-screen dark background (colors.background.primary)
       - Image displayed centered, transformable via gestures
       - Circular mask overlay: transparent circle in center, dimmed (#000 at ~70% opacity) outside
       - Header with Cancel (left) and Confirm (right) buttons

    2. **Gestures (react-native-gesture-handler + reanimated):**
       - PinchGestureHandler for zoom
       - PanGestureHandler for positioning
       - Compose gestures so both work simultaneously
       - Direct response (no spring animations) - photo moves exactly with finger

    3. **Zoom limits:**
       - Minimum: image fills the circle (can't zoom out beyond this)
       - Maximum: ~4x zoom (prevents excessive pixelation)

    4. **Crop logic (on Confirm):**
       - Calculate the square region that corresponds to the visible circle
       - Use expo-image-manipulator to crop to that region
       - Output should be square (1:1 aspect ratio)
       - Return cropped URI to calling screen via navigation params or callback

    5. **Props/Params:**
       - Receive: imageUri (the selected photo to crop)
       - Return: croppedUri (via route.params.onCropComplete callback)

    Use Animated from react-native-reanimated for gesture transforms.
    Circle size: approximately 80% of screen width, centered vertically.

  </action>
  <verify>
    - Screen renders with image and circular overlay
    - Pinch and pan gestures work smoothly
    - Confirm produces a cropped square image
    - Cancel returns without changes
  </verify>
  <done>ProfilePhotoCropScreen created with working gestures and crop functionality</done>
</task>

<task type="auto">
  <name>Task 2: Integrate crop screen into EditProfileScreen and ProfileSetupScreen</name>
  <files>src/screens/EditProfileScreen.js, src/screens/ProfileSetupScreen.js, src/navigation/AuthNavigator.js</files>
  <action>
    1. **Add screen to navigation:**
       - Add ProfilePhotoCropScreen to the appropriate navigator (likely MainNavigator or a modal stack)
       - Screen should be presented as a modal (fullScreenModal presentation)

    2. **Modify EditProfileScreen:**
       - In pickImage and takePhoto functions:
         - Remove `allowsEditing: true` and `aspect: [1, 1]` from ImagePicker options
         - After getting the image URI, navigate to ProfilePhotoCropScreen
         - Pass imageUri and onCropComplete callback
         - onCropComplete sets the photoUri state with the cropped result

    3. **Modify ProfileSetupScreen:**
       - Same changes as EditProfileScreen
       - pickImage and takePhoto navigate to crop screen after selection
       - Cropped result is set to photoUri state

    4. **Handle Cancel:**
       - If user cancels in crop screen, return to the calling screen without setting a new photo

    The flow becomes: Select photo → Crop screen → Cropped photo set

  </action>
  <verify>
    - Selecting a photo in EditProfileScreen opens the crop screen
    - Selecting a photo in ProfileSetupScreen opens the crop screen
    - Cropped photo appears correctly in the profile photo preview
    - Cancel in crop screen returns without changes
  </verify>
  <done>Both profile screens use the new crop flow</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Custom profile photo crop UI with circular preview and gesture support</what-built>
  <how-to-verify>
    1. Run the app: `npx expo start`

    **Test EditProfileScreen:**
    2. Go to Profile → Edit Profile
    3. Tap "Change Photo" → Choose from Library
    4. Select any photo
    5. Verify crop screen appears with:
       - Circular preview overlay (dimmed outside the circle)
       - Pinch-to-zoom works smoothly
       - Pan/drag to reposition works
       - Cancel and Confirm buttons visible
    6. Position and zoom the photo, tap Confirm
    7. Verify the cropped photo appears in the profile preview
    8. Verify the crop matches the circular preview shown

    **Test ProfileSetupScreen:**
    9. Sign out and start fresh signup flow
    10. Get to profile setup screen
    11. Tap the photo placeholder
    12. Select a photo and verify same crop experience
    13. Confirm and verify photo appears correctly

    **Test Cancel:**
    14. Select a photo, open crop screen
    15. Tap Cancel
    16. Verify no photo change occurred

  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ProfilePhotoCropScreen created with circular overlay
- [ ] Pinch-to-zoom and pan gestures work smoothly
- [ ] Crop produces correct square output
- [ ] EditProfileScreen uses new crop flow
- [ ] ProfileSetupScreen uses new crop flow
- [ ] Cancel flow works correctly
- [ ] No TypeScript/ESLint errors
- [ ] App builds and runs without crashes
</verification>

<success_criteria>

- ISS-011 resolved
- Profile photo selection shows circular crop preview
- Gestures feel responsive and direct
- Cropped result matches circular preview exactly
- Both EditProfileScreen and ProfileSetupScreen integrated
  </success_criteria>

<output>
After completion, create `.planning/phases/32-photo-issues-fix/32-02-SUMMARY.md`
</output>
