---
phase: 51-ios-release-preparation
plan: 05
type: execute
---

<objective>
Create a Cloud Function that automatically emails user reports to the support address, so reports don't just sit unread in Firestore.

Purpose: Reports currently only write to Firestore's `reports/` collection. Without email routing, they won't be seen until someone manually checks the database. This ensures every report gets immediate attention.
Output: Cloud Function that triggers on new report creation and sends formatted email to support.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/51-ios-release-preparation/51-CONTEXT.md

@src/services/firebase/reportService.js
@functions/index.js

**Current report flow:**

- `submitReport(reporterId, reportedUserId, reason, details, profileSnapshot)` in reportService.js
- Writes to `reports/{autoId}` with: reporterId, reportedUserId, reason, details, profileSnapshot (displayName, username, bio, profilePhotoURL), status: 'pending', createdAt
- REPORT_REASONS: spam, harassment, inappropriate, impersonation, other
- UI: ReportUserScreen.js with reason selection + optional details

**Desired:** Same UI, same Firestore write, but also triggers a Cloud Function that emails the report to support@[domain] with a "REPORT" flag in subject.

**Dependency:** Requires domain from 51-04 for the support email address. If not yet known, use a configurable env var.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add email sending capability to Cloud Functions</name>
  <files>functions/package.json, functions/index.js</files>
  <action>
Install Nodemailer in the functions directory for sending emails:
```bash
cd functions && npm install nodemailer
```

Set up Firebase Functions config for SMTP credentials. Use Gmail SMTP with an App Password (simplest for a single-developer app):

Create a utility function in the Cloud Functions for sending emails:

```javascript
const nodemailer = require('nodemailer');

// Configure with Firebase Functions environment config
// Set via: firebase functions:config:set smtp.email="your@gmail.com" smtp.password="app-password" support.email="support@domain.com"
const getTransporter = () => {
  const config = functions.config();
  return nodemailer.createTransport({
    service: 'gmail',
    auth: {
      user: config.smtp.email,
      pass: config.smtp.password,
    },
  });
};
```

**Important:** Do NOT hardcode credentials. Use `functions.config()` for SMTP credentials and support email. These will be set via `firebase functions:config:set` in the deployment step.

If the project already uses a different email pattern, follow that. Otherwise, Nodemailer + Gmail SMTP is the simplest approach for a single-developer app.
</action>
<verify>Run `cd functions && node -e "require('nodemailer')"` succeeds without error</verify>
<done>Nodemailer installed and email utility function created in Cloud Functions.</done>
</task>

<task type="auto">
  <name>Task 2: Create onReportCreated Firestore trigger</name>
  <files>functions/index.js</files>
  <action>
Add a Firestore trigger Cloud Function that fires when a new document is created in the `reports/` collection:

```javascript
exports.onReportCreated = functions.firestore
  .document('reports/{reportId}')
  .onCreate(async (snapshot, context) => {
    const report = snapshot.data();
    const reportId = context.params.reportId;

    const subject = `[REPORT] ${report.reason} — ${report.profileSnapshot?.username || 'Unknown user'}`;

    const body = `
New Report Submitted
====================

Report ID: ${reportId}
Date: ${new Date().toISOString()}

Reporter: ${report.reporterId}
Reported User: ${report.reportedUserId}
  Username: ${report.profileSnapshot?.username || 'N/A'}
  Display Name: ${report.profileSnapshot?.displayName || 'N/A'}

Reason: ${report.reason}
Details: ${report.details || 'No additional details provided'}

---
View in Firebase Console:
https://console.firebase.google.com/project/${process.env.GCLOUD_PROJECT}/firestore/data/reports/${reportId}
    `.trim();

    try {
      const transporter = getTransporter();
      const config = functions.config();
      await transporter.sendMail({
        from: `"Flick Reports" <${config.smtp.email}>`,
        to: config.support.email,
        subject,
        text: body,
      });
      logger.info('Report email sent', { reportId, reason: report.reason });
    } catch (error) {
      logger.error('Failed to send report email', { reportId, error: error.message });
      // Don't throw — the report is already saved in Firestore.
      // Email failure shouldn't prevent report submission.
    }
  });
```

**Key design decisions:**

- Fire-and-forget: email failure doesn't affect the report write (already in Firestore)
- Plain text email (not HTML) — simpler, more reliable, easier to read on mobile
- Subject includes reason and username for easy scanning/filtering
- Links directly to Firebase Console for quick investigation
- Uses `functions.config()` for all sensitive values
  </action>
  <verify>Run `cd functions && node -e "const f = require('./index.js'); console.log(typeof f.onReportCreated)"` outputs "object" (Firestore trigger functions are objects, not plain functions)</verify>
  <done>onReportCreated Cloud Function created, triggers on new report, sends formatted email to support address.</done>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `nodemailer` in functions/package.json dependencies
- [ ] `onReportCreated` exported from functions/index.js
- [ ] Function handles email failure gracefully (no throw)
- [ ] No hardcoded credentials in source code
- [ ] `cd functions && npm test` passes (if tests exist)
</verification>

<success_criteria>

- Cloud Function triggers on new report document creation
- Email sent to configurable support address with report details
- Subject includes [REPORT] flag, reason, and username
- Email failure doesn't break report submission
- Credentials stored in functions config, not source code
  </success_criteria>

<output>
After completion, create `.planning/phases/51-ios-release-preparation/51-05-SUMMARY.md`

Note: SMTP credentials and support email need to be configured via `firebase functions:config:set` before deploying to production. This will be done during final deployment (51-10).
</output>
