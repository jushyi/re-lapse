---
phase: 51-ios-release-preparation
plan: 07
type: execute
---

<objective>
Build the Contributions page with IAP (In-App Purchase) integration — a new Settings screen where users can support the app with one-time purchases that unlock a custom name color perk.

Purpose: Sustainable revenue through optional contributions. The perk (custom name color) gives contributors a visible, subtle mark of support without gating features.
Output: ContributionsScreen with IAP tier buttons, purchase flow, and color picker that appears after purchase.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/51-ios-release-preparation/51-CONTEXT.md

@src/screens/SettingsScreen.js
@src/screens/EditProfileScreen.js
@src/navigation/AppNavigator.js
@src/context/AuthContext.js
@src/constants/colors.js
@src/constants/spacing.js
@src/constants/typography.js

**From CONTEXT.md:**

- IAP tiers: $0.99, $2.99, $4.99, $9.99 — all one-time, all unlock the same perk
- Perk: Custom name color (replaces default white username display)
- After purchase: Color picker appears right on the contributions page
- Color also changeable from Edit Profile
- Heartfelt personal pitch at top, not corporate

**Current state:**

- No IAP library installed (clean slate)
- No ContributionsScreen exists
- SettingsScreen has Account, Notifications, Privacy, Legal, Support sections
- EditProfileScreen has: photo, display name, username, bio fields

**IAP library choice:**

- `react-native-iap` is the standard for Expo dev client builds
- Alternatively, `expo-in-app-purchases` (deprecated in newer Expo SDKs)
- Use `react-native-iap` — more actively maintained, works with EAS builds
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-native-iap and configure IAP products</name>
  <files>package.json, app.json, src/services/iapService.js</files>
  <action>
1. Install the IAP library:
```bash
npm install react-native-iap
```

2. Create `src/services/iapService.js` — service module following project's service pattern:

```javascript
// IAP product IDs — these must match what's configured in App Store Connect
export const PRODUCT_IDS = [
  'flick_contribution_099', // $0.99
  'flick_contribution_299', // $2.99
  'flick_contribution_499', // $4.99
  'flick_contribution_999', // $9.99
];

// Functions:
// initializeIAP() — call on app start or contributions screen mount
// getProducts() — fetch product details (price, title) from App Store
// purchaseProduct(productId) — initiate purchase flow
// finishTransaction(purchase) — acknowledge/finish the transaction
// restorePurchases() — check previous purchases
// checkContributorStatus(userId) — check if user has contributed (reads Firestore)
// saveContribution(userId, productId, transactionId) — save purchase to Firestore
```

Follow the project's `{ success, error }` return pattern for all functions.

Store contribution records in a new Firestore collection `contributions/{autoId}`:

```
{
  userId: string,
  productId: string,
  transactionId: string,
  amount: string (product price),
  createdAt: serverTimestamp()
}
```

Also add a `isContributor: true` and `nameColor: null` field to the user's document on first contribution. This allows quick checks without querying the contributions collection.

**Important:** Transaction validation should happen server-side ideally (Cloud Function), but for a single-developer app with one-time consumable purchases, client-side validation with `finishTransaction()` is acceptable. Do NOT skip `finishTransaction()` — Apple will re-deliver unfinished transactions on every app launch.

3. Add `react-native-iap` to app.json plugins if needed for auto-linking.
   </action>
   <verify>Run `node -e "require('react-native-iap')"` succeeds. File `src/services/iapService.js` exists with all listed exports.</verify>
   <done>react-native-iap installed, iapService.js created with product IDs, purchase flow, and Firestore integration.</done>
   </task>

<task type="auto">
  <name>Task 2: Build ContributionsScreen with pitch and IAP buttons</name>
  <files>src/screens/ContributionsScreen.js, src/styles/ContributionsScreen.styles.js, src/navigation/AppNavigator.js, src/screens/SettingsScreen.js</files>
  <action>
Create `ContributionsScreen.js` with:

**Layout (top to bottom):**

1. **Header:** "Support Flick" with back button (standard screen header pattern)
2. **Personal pitch section:** A warm, heartfelt paragraph about supporting an indie app. Not corporate — personal. Example tone: "Flick is built by one person who loves what disposable cameras do for friendships. Every contribution helps keep the servers running and new features coming. If Flick has brought you closer to your friends, consider supporting it — it means the world."
3. **Contribution tier buttons:** 4 buttons showing price and a small label:
   - $0.99 — "Buy me a coffee"
   - $2.99 — "Keep the lights on"
   - $4.99 — "Fuel new features"
   - $9.99 — "Champion supporter"
     Each button calls `purchaseProduct()` from iapService. Show loading state during purchase.
4. **Color picker section (conditional):** Only visible AFTER a successful purchase (or if user is already a contributor). Shows a color picker for choosing name color. Use a simple grid of preset colors (12-16 curated colors that look good on dark backgrounds) plus a "Reset to default" option. Save selected color to user document via AuthContext's updateProfile.
5. **Thank you message (conditional):** If already a contributor, show a small thank you message above the tiers: "You're already a contributor — thank you! You can contribute again anytime or change your name color below."

**Styling:** Match existing dark theme. Tier buttons should be visually distinct (use the app's accent colors or subtle gradients). Color picker grid should show color swatches as circles.

**Navigation:**

- Register `ContributionsScreen` in AppNavigator.js
- Add "Support Flick" item to SettingsScreen.js in the Account section (after Edit Profile), with a heart icon

**State management:**

- Check `userProfile.isContributor` from AuthContext on mount
- After purchase success: update user document with `isContributor: true`, show color picker
- Color selection: update `userProfile.nameColor` via AuthContext's updateProfile

**Error handling:**

- Purchase cancelled by user → no error shown (normal flow)
- Purchase failed → Alert with error message
- Network error fetching products → Show "Unable to load" with retry button
  </action>
  <verify>File exists at `src/screens/ContributionsScreen.js`. Screen registered in AppNavigator. SettingsScreen has "Support Flick" link. `npm run lint` passes.</verify>
  <done>ContributionsScreen built with personal pitch, 4 IAP tiers, conditional color picker, and proper navigation wiring.</done>
  </task>

<task type="auto">
  <name>Task 3: Add color picker to Edit Profile screen</name>
  <files>src/screens/EditProfileScreen.js</files>
  <action>
Add a "Name Color" section to EditProfileScreen, visible only for contributors (`userProfile.isContributor === true`):

- Place it after the Bio field
- Label: "Name Color" with a small colored circle showing current selection
- Tapping opens the same color picker grid used in ContributionsScreen
- Extract the color picker into a shared component `src/components/ColorPickerGrid.js` so both screens can use it
- Include "Reset to default (white)" option
- Save color changes as part of the existing Edit Profile save flow (add nameColor to the update payload)

If user is NOT a contributor, don't show this section at all (no teaser, no upsell — keep Edit Profile clean).
</action>
<verify>Open EditProfileScreen as a contributor → Name Color section visible with color picker. Open as non-contributor → section hidden. `npm run lint` passes.</verify>
<done>EditProfileScreen has conditional Name Color section for contributors, using shared ColorPickerGrid component.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `react-native-iap` in package.json dependencies
- [ ] `iapService.js` exports all required functions
- [ ] ContributionsScreen renders with pitch + 4 tier buttons
- [ ] Color picker appears after purchase (or for existing contributors)
- [ ] EditProfileScreen shows color picker for contributors
- [ ] ColorPickerGrid is a shared component
- [ ] SettingsScreen has "Support Flick" navigation item
- [ ] `npm run lint` passes
</verification>

<success_criteria>

- IAP service layer complete with product configuration
- ContributionsScreen has warm pitch + 4 purchase tiers
- Color picker unlocks after purchase
- Color also editable from Edit Profile
- Contributor status stored in user document
- All navigation wiring complete
  </success_criteria>

<output>
After completion, create `.planning/phases/51-ios-release-preparation/51-07-SUMMARY.md`

Note: IAP products must also be configured in App Store Connect before they work in production. This will be handled in 51-09.
</output>
