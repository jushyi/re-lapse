---
phase: 46-performance-optimization
plan: 04
type: execute
---

<objective>
Add FlatList optimization props to all unoptimized lists, wrap renderItem callbacks in useCallback, fix ListHeaderComponent call pattern, and add React.memo to list item components.

Purpose: Eliminate unnecessary re-renders and enable FlatList virtualization across all scrollable lists. The app has 17+ FlatLists but only 5 are optimized — the remaining 12 (including the main feed) render all items eagerly and re-create renderItem functions on every parent render.
Output: All FlatLists optimized with performance props, all renderItem callbacks memoized, all list item components wrapped with React.memo.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/46-performance-optimization/46-RESEARCH.md
@.planning/codebase/PERFORMANCE.md

**Research patterns to follow:**

- RESEARCH.md Pattern 5: FlatList Optimization Props
- RESEARCH.md HIGH-1: No FlatList optimization props on FeedScreen
- RESEARCH.md HIGH-2: renderFeedItem not wrapped in useCallback
- RESEARCH.md HIGH-3: ListHeaderComponent called with () — creates new JSX tree every render
- RESEARCH.md anti-pattern: Missing useCallback on renderItem defeats React.memo on list items
- PERFORMANCE.md: Standard FlatList optimization pattern (getItemLayout, initialNumToRender, maxToRenderPerBatch, windowSize, removeClippedSubviews)

**Established pattern from Phase 30:**

```javascript
<FlatList
  getItemLayout={(data, index) => ({ length: ITEM_HEIGHT, offset: ITEM_HEIGHT * index, index })}
  initialNumToRender={9}
  maxToRenderPerBatch={6}
  windowSize={5}
  removeClippedSubviews={true}
/>
```

**FlatLists already optimized (skip these):**

- MonthlyAlbumGridScreen, AlbumPhotoViewer, AlbumGridScreen, AlbumPhotoPickerScreen, RecentlyDeletedScreen
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Add FlatList optimization props to all unoptimized lists</name>
  <files>src/screens/FeedScreen.js, src/screens/FriendsScreen.js, src/screens/NotificationsScreen.js, src/components/comments/CommentsBottomSheet.js, src/screens/BlockedUsersScreen.js, src/screens/ContactsSyncScreen.js, src/screens/SongSearchScreen.js, src/components/TagFriendsModal.js, src/components/TaggedPeopleModal.js, src/components/AddToAlbumSheet.js, src/components/AlbumBar.js, src/screens/PhoneInputScreen.js</files>
  <action>
Add optimization props to each FlatList. Adjust values based on item type:

**Fixed-height item lists (add getItemLayout):**

1. **FeedScreen.js** (Animated.FlatList — main feed):
   - `initialNumToRender={4}` (feed items are tall — 4 fills screen)
   - `maxToRenderPerBatch={3}`
   - `windowSize={5}`
   - `removeClippedSubviews={true}`
   - Skip `getItemLayout` — feed items have variable height (photo + reactions + comments)
   - Add `updateCellsBatchingPeriod={50}`

2. **FriendsScreen.js** (3 FlatLists — friends tab, suggestions tab, requests tab):
   - `initialNumToRender={10}` (friend cards are small)
   - `maxToRenderPerBatch={8}`
   - `windowSize={5}`
   - `removeClippedSubviews={true}`
   - Add `getItemLayout` if FriendCard has fixed height

3. **NotificationsScreen.js**:
   - `initialNumToRender={10}`
   - `maxToRenderPerBatch={8}`
   - `windowSize={5}`
   - `removeClippedSubviews={true}`
   - Skip `getItemLayout` — notifications may have variable height

4. **CommentsBottomSheet.js**:
   - `initialNumToRender={10}`
   - `maxToRenderPerBatch={5}`
   - `windowSize={5}`
   - `removeClippedSubviews={true}`
   - Skip `getItemLayout` — comments have variable height (text + replies)

5. **BlockedUsersScreen.js**:
   - `initialNumToRender={10}`
   - `maxToRenderPerBatch={8}`
   - `windowSize={5}`
   - `removeClippedSubviews={true}`

6. **ContactsSyncScreen.js**:
   - `initialNumToRender={15}`
   - `maxToRenderPerBatch={10}`
   - `windowSize={5}`
   - `removeClippedSubviews={true}`

7. **SongSearchScreen.js**:
   - `initialNumToRender={10}`
   - `maxToRenderPerBatch={8}`
   - `windowSize={5}`
   - `removeClippedSubviews={true}`

8. **TagFriendsModal.js**:
   - `initialNumToRender={10}`
   - `maxToRenderPerBatch={8}`
   - `windowSize={5}`
   - `removeClippedSubviews={true}`

9. **TaggedPeopleModal.js**:
   - `initialNumToRender={10}`
   - `maxToRenderPerBatch={8}`
   - `windowSize={5}`

10. **AddToAlbumSheet.js**:
    - `initialNumToRender={6}`
    - `maxToRenderPerBatch={4}`
    - `windowSize={5}`

11. **AlbumBar.js** (horizontal scroll):
    - `initialNumToRender={4}`
    - `maxToRenderPerBatch={3}`
    - `windowSize={3}` (horizontal — fewer off-screen items needed)

12. **PhoneInputScreen.js** (country picker): - `initialNumToRender={15}` - `maxToRenderPerBatch={10}` - `windowSize={5}` - `removeClippedSubviews={true}` - Add `getItemLayout` — country items have fixed height
    </action>
    <verify>
    Grep for `FlatList` and `Animated.FlatList` across all source files. Verify every instance has at least `initialNumToRender`, `maxToRenderPerBatch`, and `windowSize` props.
    </verify>
    <done>All 12 previously unoptimized FlatLists now have performance props. Combined with the 5 already optimized, all 17 FlatLists in the app are optimized.</done>
    </task>

<task type="auto">
  <name>Task 2: Add useCallback to renderItem, fix ListHeaderComponent, add React.memo to list items</name>
  <files>src/screens/FeedScreen.js, src/screens/FriendsScreen.js, src/screens/NotificationsScreen.js, src/components/comments/CommentsBottomSheet.js, src/components/FriendCard.js, src/components/comments/CommentRow.js, src/components/AlbumCard.js, src/components/MonthlyAlbumCard.js</files>
  <action>
**useCallback on renderItem:**
Wrap all renderItem functions in useCallback for the FlatLists modified in Task 1. Identify each renderItem function and wrap it:

```javascript
const renderItem = useCallback(
  ({ item }) => <ComponentName {...props} />,
  [
    /* minimal dependencies */
  ]
);
```

Key files:

- FeedScreen.js: wrap renderFeedItem in useCallback
- FriendsScreen.js: wrap all 3 renderItem functions in useCallback
- NotificationsScreen.js: wrap renderNotificationItem in useCallback
- CommentsBottomSheet.js: wrap renderCommentItem in useCallback

Keep dependency arrays minimal — only include values that the renderItem actually references. If the renderItem references callbacks that change, those callbacks should also be wrapped in useCallback or use refs.

**Fix ListHeaderComponent in FeedScreen:**
Find the `ListHeaderComponent` prop on the FeedScreen FlatList. If it's written as `ListHeaderComponent={renderStoriesRow()}` (with parentheses — CALLING the function), change to `ListHeaderComponent={renderStoriesRow}` (function REFERENCE). The parentheses cause a new JSX tree to be created on every render.

**React.memo on list item components:**
Wrap these components with React.memo:

1. **FriendCard.js**: `export default React.memo(FriendCard)` — rendered in 3 FlatLists in FriendsScreen
2. **CommentRow.js**: `export default React.memo(CommentRow)` — rendered in CommentsBottomSheet FlatList
3. **AlbumCard.js**: `export default React.memo(AlbumCard)` — rendered in AlbumBar FlatList
4. **MonthlyAlbumCard.js**: `export default React.memo(MonthlyAlbumCard)` — rendered in horizontal scroll list

For each, ensure the component function is defined as a named function (not anonymous) before wrapping with memo. If the default export is already `export default function ComponentName(...)`, change to:

```javascript
function ComponentName({ ...props }) { ... }
export default React.memo(ComponentName);
```

Verify that FeedPhotoCard.js and FriendStoryCard.js already have memo (they should per earlier research — skip if already wrapped).
</action>
<verify>

- Grep for `renderItem` in all FlatList-containing files — each should be wrapped in useCallback
- Check FeedScreen ListHeaderComponent uses function ref (no parentheses)
- Grep for `React.memo` — FriendCard, CommentRow, AlbumCard, MonthlyAlbumCard should all use it
- Verify FeedPhotoCard and FriendStoryCard already have memo
  </verify>
  <done>All renderItem callbacks wrapped in useCallback. ListHeaderComponent uses function reference. 4 list item components wrapped with React.memo. Combined with existing memo usage, all list items properly memoized.</done>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 17 FlatLists have optimization props
- [ ] All renderItem callbacks wrapped in useCallback
- [ ] FeedScreen ListHeaderComponent uses function ref
- [ ] FriendCard, CommentRow, AlbumCard, MonthlyAlbumCard wrapped with React.memo
- [ ] No renderItem creates new component instances on every render
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Every FlatList in the app has performance props
- No unnecessary re-renders from renderItem or list item changes
- ListHeaderComponent doesn't create new JSX trees on render
  </success_criteria>

<output>
After completion, create `.planning/phases/46-performance-optimization/46-04-SUMMARY.md`
</output>
