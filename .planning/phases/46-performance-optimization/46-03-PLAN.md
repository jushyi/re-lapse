---
phase: 46-performance-optimization
plan: 03
type: execute
---

<objective>
Complete the expo-image migration, add stable cacheKey to all image sources, and enable CDN edge caching via Cache-Control headers on Storage uploads.

Purpose: Ensure all remote images use expo-image's native caching, prevent cache invalidation when Firebase download URL tokens rotate, and enable CDN caching for faster global delivery. This is a photo-sharing app — image loading speed is the core experience.
Output: All remote images use expo-image with cacheKey, all uploads include Cache-Control metadata.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/46-performance-optimization/46-RESEARCH.md
@.planning/codebase/PERFORMANCE.md

**Research patterns to follow:**

- RESEARCH.md Pitfall 3: StoriesViewerModal uses wrong Image import
- RESEARCH.md Pitfall 4: No cacheKey on Image sources — Firebase URLs contain tokens
- RESEARCH.md HIGH-7: Storage uploads lack Cache-Control headers
- RESEARCH.md code example: cacheKey + enhanced Image props
- PERFORMANCE.md: expo-image migration pattern (contentFit, cachePolicy, priority, recyclingKey, transition)

**Issues being addressed:**

- CRIT-6: StoriesViewerModal imports Image from react-native (line 7) — bypasses expo-image cache
- HIGH-4: No cacheKey on any Image source — re-downloads on URL token change
- HIGH-7: Storage uploads lack Cache-Control headers — CDN edge caching disabled
- Remaining 6 files still using RN Image for remote URLs

**Files already using expo-image (from PERFORMANCE.md):**
17 files including: PhotoDetailScreen, PhotoDetailModal, SwipeablePhotoCard, CommentRow, CommentInput, MeStoryCard, FriendStoryCard, ClipSelectionModal, SongSearchResult, useDarkroom, SelectsBanner, SelectsScreen, RecentlyDeletedScreen, AlbumPhotoPickerScreen, AlbumGridScreen, AlbumPhotoViewer, MonthlyAlbumGridScreen
</context>

<tasks>

<task type="auto">
  <name>Task 1: Complete expo-image migration for remaining files</name>
  <files>src/screens/StoriesViewerModal.js, src/components/AlbumCard.js, src/components/MonthlyAlbumCard.js, src/components/FullscreenSelectsViewer.js, src/components/InAppNotificationBanner.js, src/screens/ProfileScreen.js, src/components/ProfileSong/ProfileSongCard.js</files>
  <action>
For each file, change `Image` import from `react-native` to `expo-image`:

1. **StoriesViewerModal.js** (CRIT-6 — most important):
   - Remove `Image` from the `react-native` import destructure
   - Add `import { Image } from 'expo-image';`
   - Add props: `contentFit="cover"`, `cachePolicy="memory-disk"`, `priority="high"` (fullscreen stories)
   - Add `recyclingKey` if images are rendered in a list/FlatList

2. **AlbumCard.js** (3 Image instances — cover photo + 2 stack photos):
   - Change import to expo-image
   - Add `contentFit="cover"`, `cachePolicy="memory-disk"`, `priority="normal"`
   - Add `recyclingKey={album.id}` (rendered in AlbumBar FlatList)

3. **MonthlyAlbumCard.js** (cover photo in scrollable list):
   - Change import to expo-image
   - Add `contentFit="cover"`, `cachePolicy="memory-disk"`, `priority="normal"`
   - Add `recyclingKey` with monthly album ID

4. **FullscreenSelectsViewer.js** (fullscreen modal viewer):
   - Change import to expo-image
   - Add `contentFit="contain"`, `cachePolicy="memory-disk"`, `priority="high"`

5. **InAppNotificationBanner.js** (notification avatar):
   - Change import to expo-image
   - Add `contentFit="cover"`, `cachePolicy="memory-disk"`, `priority="normal"`

6. **ProfileScreen.js** (profile photo):
   - Change import to expo-image
   - Add `contentFit="cover"`, `cachePolicy="memory-disk"`, `priority="high"`

7. **ProfileSongCard.js** (iTunes album art thumbnail):
   - Change import to expo-image
   - Add `contentFit="cover"`, `cachePolicy="memory-disk"`, `priority="low"`

For each file, keep any existing `style` props on Image unchanged. The `expo-image` Image component accepts the same style props as RN Image.

Do NOT change images that use `require()` for local assets (bundled images) — only change images that use `{ uri: ... }` for remote URLs.
</action>
<verify>
Grep for `from 'react-native'` imports that include `Image` — should find zero results (except for cases where Image is used for local assets only, which should be rare/none).
Grep for `from 'expo-image'` — should find all image-displaying components.
</verify>
<done>All remote image loading uses expo-image. Zero files import Image from react-native for remote URL display. StoriesViewerModal bug fixed.</done>
</task>

<task type="auto">
  <name>Task 2: Add cacheKey to all expo-image sources and Cache-Control to uploads</name>
  <files>src/components/FeedPhotoCard.js, src/screens/PhotoDetailScreen.js, src/components/PhotoDetailModal.js, src/components/SwipeablePhotoCard.js, src/components/comments/CommentRow.js, src/components/comments/CommentInput.js, src/components/MeStoryCard.js, src/components/FriendStoryCard.js, src/components/SelectsBanner.js, src/screens/SelectsScreen.js, src/screens/RecentlyDeletedScreen.js, src/screens/AlbumPhotoPickerScreen.js, src/screens/AlbumGridScreen.js, src/components/AlbumPhotoViewer.js, src/screens/MonthlyAlbumGridScreen.js, src/components/ProfileSong/ClipSelectionModal.js, src/components/ProfileSong/SongSearchResult.js, src/hooks/useDarkroom.js, src/screens/StoriesViewerModal.js, src/components/AlbumCard.js, src/components/MonthlyAlbumCard.js, src/components/FullscreenSelectsViewer.js, src/components/InAppNotificationBanner.js, src/screens/ProfileScreen.js, src/components/ProfileSong/ProfileSongCard.js, src/services/firebase/storageService.js</files>
  <action>
**cacheKey — all expo-image sources:**

For every `<Image source={{ uri: ... }}>` in the codebase, add a `cacheKey` prop with a stable identifier that doesn't change when the Firebase download URL token rotates:

- Photo images: `cacheKey={\`photo-${photo.id}\`}` or `cacheKey={\`photo-${item.id}\`}`
- User profile photos: `cacheKey={\`profile-${userId}\`}` or `cacheKey={\`profile-${user.uid}\`}`
- Album covers: `cacheKey={\`album-${album.id}\`}`
- Comment avatars: `cacheKey={\`avatar-${comment.userId}\`}`
- Story photos: `cacheKey={\`story-${photo.id}\`}`
- iTunes album art: No cacheKey needed (URLs are stable Apple CDN URLs without tokens)
- Notification avatars: `cacheKey={\`notif-avatar-${notification.senderId}\`}`

The cacheKey ensures expo-image's disk cache recognizes the same image even when Firebase regenerates download URLs with new tokens. Without this, every URL token rotation causes a full re-download.

Use the `source` object syntax: `source={{ uri: imageUrl, cacheKey: \`photo-${id}\` }}`

If the Image already uses `source={{ uri: ... }}`, just add the cacheKey field. If it uses `source={uri}` (shorthand), convert to object syntax.

**Cache-Control — Storage uploads:**

In storageService.js, add `cacheControl` metadata to all upload calls:

For all `uploadBytes()`, `uploadBytesResumable()`, or `putFile()` calls, add metadata:

```javascript
const metadata = {
  contentType: 'image/jpeg',
  cacheControl: 'public, max-age=31536000', // 1 year — images are immutable (identified by unique ID)
};
```

This enables Firebase Storage CDN edge caching. Since each photo has a unique ID, images are effectively immutable and can be cached aggressively.

Find all upload calls in storageService.js and add this metadata parameter.
</action>
<verify>

- Grep for `expo-image` Image usage and verify cacheKey is present on all instances with remote URLs
- Read storageService.js and confirm cacheControl metadata on all upload calls
- Verify no Image sources use bare URI strings without cacheKey (except local assets and stable external URLs like iTunes)
  </verify>
  <done>All expo-image sources have stable cacheKey props. All Storage uploads include Cache-Control headers for CDN edge caching. Images won't re-download on URL token rotation.</done>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Zero files import Image from react-native for remote URLs
- [ ] All expo-image sources have cacheKey with stable identifiers
- [ ] storageService.js upload calls include cacheControl metadata
- [ ] No regression in image display (all images still load correctly)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- All remote images use expo-image with cacheKey
- Storage uploads have Cache-Control headers
- StoriesViewerModal correctly uses expo-image cache
  </success_criteria>

<output>
After completion, create `.planning/phases/46-performance-optimization/46-03-SUMMARY.md`
</output>
