---
phase: 46-performance-optimization
plan: 05
type: execute
---

<objective>
Enable React Compiler for automatic memoization and configure console.log stripping for production builds.

Purpose: React Compiler analyzes data flow at compile time and automatically inserts useMemo/useCallback/React.memo where beneficial — providing 20-30% render reduction app-wide with zero manual effort. Console stripping removes logging overhead from production bundles.
Output: babel.config.js configured with React Compiler and production console stripping.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/46-performance-optimization/46-RESEARCH.md
@babel.config.js

**Research patterns to follow:**

- RESEARCH.md standard_stack: babel-plugin-react-compiler ^1.0.0 + babel-plugin-transform-remove-console
- RESEARCH.md code example: babel.config.js configuration
- RESEARCH.md Don't Hand-Roll: Auto-memoization via React Compiler instead of manual React.memo/useMemo everywhere
- RESEARCH.md Don't Hand-Roll: Console stripping via babel plugin instead of manual **DEV** guards
- RESEARCH.md Open Question 1: React Compiler + Reanimated compatibility — may need `sources` option for gradual adoption

**Key constraints:**

- React Compiler plugin MUST come BEFORE reanimated/plugin in babel.config.js
- reanimated/plugin MUST remain the LAST plugin
- Test build after enabling — if Reanimated worklet errors occur, add `sources` option to restrict compiler
- Expo SDK 54 officially supports React Compiler
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure React Compiler and console stripping plugins</name>
  <files>babel.config.js, package.json</files>
  <action>
**Install dependencies:**
```bash
npm install --save-dev babel-plugin-react-compiler babel-plugin-transform-remove-console
```

**Update babel.config.js:**
Read the current babel.config.js first, then modify:

1. Add `'babel-plugin-react-compiler'` to the plugins array BEFORE `'react-native-reanimated/plugin'`
2. Add a `env.production` block with `plugins: ['transform-remove-console']`
3. Ensure `'react-native-reanimated/plugin'` remains the LAST entry in plugins

The final structure should look like:

```javascript
module.exports = function (api) {
  api.cache(true);
  return {
    presets: ['babel-preset-expo'],
    plugins: [
      // ... existing plugins (module:react-native-dotenv, etc.)
      ['babel-plugin-react-compiler'], // ADD — auto-memoization
      'react-native-reanimated/plugin', // MUST remain LAST
    ],
    env: {
      production: {
        plugins: ['transform-remove-console'], // ADD — strip console.log
      },
    },
  };
};
```

IMPORTANT: Do NOT remove or reorder any existing plugins. Only ADD the two new ones in the correct positions.
</action>
<verify>
Read babel.config.js to confirm:

- react-compiler plugin is present and comes before reanimated
- reanimated/plugin is still the last plugin
- transform-remove-console is in env.production.plugins
- All existing plugins are preserved
  </verify>
  <done>React Compiler and console stripping plugins installed and configured in babel.config.js.</done>
  </task>

<task type="auto">
  <name>Task 2: Verify build passes and test Reanimated compatibility</name>
  <files>babel.config.js</files>
  <action>
Run the build to verify React Compiler doesn't conflict with Reanimated worklets:

```bash
npx expo export --platform ios
```

**If build succeeds:** React Compiler and Reanimated are compatible. No further action needed.

**If build fails with Reanimated worklet errors:**
The React Compiler may be trying to optimize Reanimated worklet functions (which use the `'worklet'` directive). Fix by adding the `sources` option to restrict the compiler to specific directories:

```javascript
['babel-plugin-react-compiler', {
  sources: (filename) => {
    // Only compile files in src/ that aren't animation-heavy
    return filename.includes('src/') && !filename.includes('hooks/useSwipeable');
  },
}],
```

If that's too complex, a simpler approach: exclude known problematic files:

```javascript
['babel-plugin-react-compiler', {
  sources: (filename) => {
    return !filename.includes('node_modules');
  },
}],
```

After any fix, re-run `npx expo export --platform ios` to confirm.

**If the build still fails:** Remove the react-compiler plugin entirely (the manual memoization from Plan 46-04 already provides the key benefits). Document the incompatibility in the summary.
</action>
<verify>
`npx expo export --platform ios` completes without errors.
</verify>
<done>Build passes with React Compiler enabled. Reanimated worklets function correctly. (Or: React Compiler removed due to incompatibility — documented in summary.)</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm install` completed successfully for both babel plugins
- [ ] babel.config.js has correct plugin order
- [ ] `npx expo export --platform ios` passes
- [ ] No runtime errors in animated components (verified via build, not runtime test)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Build completes without errors
- React Compiler active (or documented as incompatible)
- Console stripping active in production builds
  </success_criteria>

<output>
After completion, create `.planning/phases/46-performance-optimization/46-05-SUMMARY.md`
</output>
