---
phase: 46-performance-optimization
plan: 01
type: execute
---

<objective>
Refactor feed queries to use server-side Firestore filtering with the `in` operator, cursor-based pagination, and limits — eliminating the critical O(N) pattern where all journal photos are fetched and filtered client-side.

Purpose: The feed currently reads every journal photo in the entire database and filters in JavaScript. At 500 active photos this costs 600+ reads per load; at scale it's unbounded. Server-side filtering with `in` reduces this to ~25 reads per load (96% reduction).
Output: Optimized getFeedPhotos, subscribeFeedPhotos, and getRandomFriendPhotos functions using Firestore `in` operator with cursor pagination.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-performance-optimization/46-RESEARCH.md
@.planning/phases/46-performance-optimization/46-CONTEXT.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/PERFORMANCE.md
@src/services/firebase/feedService.js
@src/hooks/useFeedPhotos.js

**Constraining decisions:**

- CONTEXT.md: No architecture changes — optimize within existing structure
- CONTEXT.md: Speed first, even if it means more Firebase reads
- RESEARCH.md: Firestore `in` operator limit is 30 — chunk for >30 friends
- RESEARCH.md: Keep client-side exclusion of own photos and blocked users (can't express in Firestore)

**Research patterns to follow:**

- Pattern 1: Server-Side Feed Filtering with `in` Operator (RESEARCH.md)
- Pattern 3: Cursor-Based Pagination (RESEARCH.md)
- Anti-pattern: Never fetch all documents and filter client-side

**Issues being addressed:**

- CRIT-1: getFeedPhotos fetches ALL journal photos, filters client-side (lines 68-97)
- CRIT-2: subscribeFeedPhotos fetches ALL journal photos as real-time listener (lines 166-231)
- CRIT-3: getRandomFriendPhotos fetches ENTIRE photos collection (lines 730-805)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor getFeedPhotos with server-side filtering and cursor pagination</name>
  <files>src/services/firebase/feedService.js</files>
  <action>
Refactor getFeedPhotos (lines 68-97) to use Firestore `in` operator for server-side friend filtering:

1. Accept friendIds array as parameter (caller provides from friendship data)
2. Chunk friendIds into batches of 30 (Firestore `in` limit)
3. For each chunk, query with: `where('userId', 'in', chunk)`, `where('photoState', '==', 'journal')`, `where('triagedAt', '>=', cutoff)`, `orderBy('triagedAt', 'desc')`, `limit(limitCount)`
4. Implement cursor-based pagination: accept optional `lastDocSnapshot` parameter, use `startAfter(lastDocSnapshot)` when provided
5. Store and return the last DocumentSnapshot for cursor-based paging (NOT the doc data — the actual snapshot reference)
6. Keep client-side filtering for: own photos exclusion, blocked user exclusion (these can't be expressed server-side)
7. Remove the old pattern of fetching all photos and filtering by friend IDs in JavaScript

IMPORTANT: The `in` operator requires a composite index with `userId` + `photoState` + `triagedAt`. This index will be added in Plan 46-02. The query may fail until that index is deployed — this is expected and documented.

Do NOT change the function signature in a breaking way — ensure callers (useFeedPhotos hook) still work. Add new parameters as optional with defaults.

Also refactor getUserFeedPhotos (lines ~289-321) to add `limit()` and cursor pagination with the same pattern.
</action>
<verify>
Read the refactored getFeedPhotos and getUserFeedPhotos functions to confirm:

- `in` operator used with friendIds chunking at 30
- `limit()` present on all queries
- `startAfter()` cursor pagination supported
- Client-side filtering only for own photos and blocked users
- No unbounded queries remain
  </verify>
  <done>getFeedPhotos and getUserFeedPhotos use server-side `in` filtering with cursor pagination and limits. No unbounded photo queries remain in these functions.</done>
  </task>

<task type="auto">
  <name>Task 2: Refactor subscribeFeedPhotos and getRandomFriendPhotos</name>
  <files>src/services/firebase/feedService.js</files>
  <action>
Refactor subscribeFeedPhotos (lines 166-231):
1. Apply same `in` operator pattern as getFeedPhotos — accept friendIds, chunk into batches of 30
2. For real-time listeners with chunked `in` queries: create one `onSnapshot` listener per chunk, merge results client-side
3. Add `limit()` to each chunk query to cap results
4. Keep `orderBy('triagedAt', 'desc')` for consistent ordering
5. Return a cleanup function that unsubscribes ALL chunk listeners
6. Keep client-side filtering for own photos and blocked users

Refactor getRandomFriendPhotos (lines 730-805):

1. Accept friendIds parameter instead of querying all photos
2. Use `in` operator with friendIds (chunked at 30) and `where('photoState', '==', 'journal')`
3. Add `limit()` to cap results (e.g., limit(50) — we only need a few random photos)
4. Random selection happens client-side AFTER server-side filtering (this is fine — the set is now small)
5. Remove the pattern of querying the entire photos collection

IMPORTANT: subscribeFeedPhotos with multiple `in` chunks creates multiple listeners. Each listener fires independently. The merge logic should:

- Maintain a Map keyed by photo ID to deduplicate
- Re-sort merged results by triagedAt on each listener update
- Call the subscriber callback with the merged, sorted array
  </action>
  <verify>
  Read the refactored functions to confirm:
- subscribeFeedPhotos uses `in` operator with chunking and limit
- Multiple listeners properly merged and cleaned up
- getRandomFriendPhotos uses server-side filtering, not full collection scan
- No unbounded queries remain
  </verify>
  <done>subscribeFeedPhotos uses chunked `in` operator with proper listener cleanup. getRandomFriendPhotos uses server-side filtering with limit. All feed queries are server-side filtered.</done>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All feed query functions use Firestore `in` operator for friend filtering
- [ ] All queries have `limit()` applied
- [ ] Cursor-based pagination implemented for getFeedPhotos and getUserFeedPhotos
- [ ] subscribeFeedPhotos properly manages multiple chunk listeners
- [ ] getRandomFriendPhotos no longer scans entire photos collection
- [ ] No client-side filtering of friend IDs remains (only own photos + blocked users filtered client-side)
- [ ] No breaking changes to function signatures (new params have defaults)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Feed queries reduced from O(all_photos) to O(friends \* limit)
- Cursor pagination enables incremental loading
- Real-time listener properly scoped to friends only
  </success_criteria>

<output>
After completion, create `.planning/phases/46-performance-optimization/46-01-SUMMARY.md`
</output>
