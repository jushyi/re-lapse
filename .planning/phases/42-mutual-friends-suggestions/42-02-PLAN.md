---
phase: 42-mutual-friends-suggestions
plan: 02
type: execute
---

<objective>
Integrate mutual friend suggestions into the FriendsScreen UI alongside existing contact-based suggestions.

Purpose: Surface friend-of-friend suggestions to users in the existing Friends screen, completing the mutual friends feature.
Output: FriendsScreen displays mutual friend suggestions in a separate subsection with "X mutual friends" subtitle on each card.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-mutual-friends-suggestions/42-CONTEXT.md
@.planning/phases/42-mutual-friends-suggestions/42-01-SUMMARY.md

@src/screens/FriendsScreen.js
@src/styles/FriendsScreen.styles.js
@src/components/FriendCard.js
@src/services/firebase/friendshipService.js
@src/services/firebase/contactSyncService.js

**Tech stack available:** React Native, Expo, Firebase Firestore
**Established patterns:**

- FriendsScreen builds sections array with `{ type, title/data }` objects for FlatList rendering
- Contact suggestions use `dismissSuggestion()` and `getDismissedSuggestionIds()` from contactSyncService
- Suggestion cards render via `renderSuggestionCard()` with FriendCard (onAction=add, onDismiss=dismiss)
- `loadData()` calls all fetch functions in parallel via Promise.all

**Constraining decisions:**

- Phase 42 CONTEXT: Mutual suggestions appear as separate subsection alongside contact suggestions, not mixed together
- Phase 42 CONTEXT: Show "X mutual friends" count as subtitle (not friend names)
- Dismissed suggestions array on user doc is shared — same dismiss mechanism works for both suggestion types
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate mutual friend suggestions into FriendsScreen</name>
  <files>src/screens/FriendsScreen.js</files>
  <action>
Modify FriendsScreen.js to fetch and display mutual friend suggestions:

**1. Add import:**
Add `getMutualFriendSuggestions` to the friendshipService import block (line ~27-36).

**2. Add state (around line 91-93, near existing suggestions state):**

```
const [mutualSuggestions, setMutualSuggestions] = useState([]);
```

**3. Add fetch function (after existing fetchSuggestions, around line 244):**
Create `fetchMutualSuggestions` async function:

- Call `getMutualFriendSuggestions(user.uid)`
- If successful, filter out dismissed suggestions using existing `getDismissedSuggestionIds` + `filterDismissedSuggestions` from contactSyncService (already imported)
- Also filter out any IDs in `blockedUserIds` state
- Set state with filtered results
- On error, log and set empty array

**4. Add to loadData (line ~266):**
Add `fetchMutualSuggestions()` to the existing `Promise.all` array alongside fetchFriends, fetchRequests, fetchSuggestions, fetchBlockedUsers.

**5. Update sections building in renderRequestsTab (around line 966-977):**
After the existing contact suggestions section block, add a mutual suggestions section:

```javascript
// Add mutual friend suggestions section
const hasMutualSuggestions = mutualSuggestions.length > 0;
if (hasMutualSuggestions) {
  sections.push({ type: 'header', title: 'People You May Know' });
  mutualSuggestions.forEach(suggestion => {
    sections.push({ type: 'mutual_suggestion', data: suggestion });
  });
}
```

**6. Add renderItem case for 'mutual_suggestion' (around line 1034-1038):**
Add before the `return null`:

```javascript
if (item.type === 'mutual_suggestion') {
  return (
    <FriendCard
      user={{
        userId: item.data.userId,
        displayName: item.data.displayName,
        username: item.data.username,
        profilePhotoURL: item.data.profilePhotoURL,
      }}
      relationshipStatus="none"
      subtitle={`${item.data.mutualCount} mutual friend${item.data.mutualCount !== 1 ? 's' : ''}`}
      onAction={userId => handleAddFriend(userId)}
      onDismiss={userId => handleDismissMutualSuggestion(userId)}
      loading={actionLoading[item.data.userId]}
      onPress={() => {
        navigation.navigate('OtherUserProfile', {
          userId: item.data.userId,
          username: item.data.username,
        });
      }}
      onBlock={handleBlockUser}
      onUnblock={handleUnblockUser}
      onReport={handleReportUser}
      isBlocked={blockedUserIds.includes(item.data.userId)}
    />
  );
}
```

**7. Add handleDismissMutualSuggestion (near existing handleDismissSuggestion, around line 438):**

```javascript
const handleDismissMutualSuggestion = async userId => {
  try {
    mediumImpact();
    // Optimistic update
    setMutualSuggestions(prev => prev.filter(s => s.userId !== userId));
    // Persist dismissal (reuses same dismissedSuggestions array)
    await dismissSuggestion(user.uid, userId);
  } catch (err) {
    logger.error('Error dismissing mutual suggestion', err);
    fetchMutualSuggestions();
  }
};
```

**8. Update handleAddFriend to also remove from mutualSuggestions (around line 400-405):**
After the existing `setSuggestions(prev => prev.filter(...))` line, add:

```javascript
setMutualSuggestions(prev => prev.filter(s => s.userId !== userId));
```

**9. Update handleBlockUser to filter mutualSuggestions (around line 647):**
After the existing `setSuggestions(prev => prev.filter(...))` line, add:

```javascript
setMutualSuggestions(prev => prev.filter(s => s.userId !== userId));
```

**10. Update keyExtractor (around line 1042-1046):**
The existing keyExtractor handles items with `item.data?.id`. Mutual suggestions use `item.data?.userId` instead. Update:

```javascript
return item.data?.id || item.data?.userId || `item-${index}`;
```

Important: The existing "Suggestions" header (line 969) is for contact-based suggestions. Keep it as "Suggestions" and use "People You May Know" for the mutual suggestions header — this matches the CONTEXT.md vision of two distinct subsections.

Do NOT restructure the existing rendering logic. Add the mutual suggestion section after the contact suggestion section in the sections array.
</action>
<verify>Read FriendsScreen.js and verify: mutualSuggestions state exists, fetchMutualSuggestions called in loadData, sections include mutual_suggestion type, renderItem handles mutual_suggestion, dismiss handler exists, keyExtractor handles userId.</verify>
<done>FriendsScreen fetches and displays mutual friend suggestions in "People You May Know" subsection. Each card shows "X mutual friends" subtitle. Add, dismiss, and block actions work correctly. Contact suggestions remain in separate "Suggestions" subsection.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Mutual friend suggestions integrated into FriendsScreen with two subsections: contact-based "Suggestions" and mutual-based "People You May Know"</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. Open app on device/simulator and navigate to Friends screen
    3. Tap the "Requests" tab
    4. Scroll down past any incoming/sent requests
    5. Verify: Contact-based "Suggestions" section appears (if contacts synced)
    6. Verify: "People You May Know" section appears below with mutual friend suggestions
    7. Verify: Each mutual suggestion card shows "X mutual friends" subtitle below username
    8. Test: Tap "Add" on a mutual suggestion — card moves to Sent section
    9. Test: Tap dismiss (X) on a mutual suggestion — card disappears
    10. Test: Pull to refresh — suggestions reload correctly
    11. Verify: No duplicate users between contact suggestions and mutual suggestions
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Mutual friend suggestions appear in "People You May Know" section
- [ ] Each suggestion shows "X mutual friends" subtitle
- [ ] Add friend works from mutual suggestions
- [ ] Dismiss works and persists across refreshes
- [ ] Block removes user from mutual suggestions
- [ ] No duplicates between contact and mutual suggestions
- [ ] Pull-to-refresh reloads both suggestion types
- [ ] No errors in console during normal operation
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Mutual friend suggestions display correctly alongside contact suggestions
- Phase 42 complete — v1.7 milestone finished
  </success_criteria>

<output>
After completion, create `.planning/phases/42-mutual-friends-suggestions/42-02-SUMMARY.md`
</output>
