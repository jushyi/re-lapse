---
phase: 42-mutual-friends-suggestions
plan: 01
type: execute
---

<objective>
Add mutual friends suggestion service and update FriendCard to support subtitle display.

Purpose: Enable friend-of-friend discovery by computing mutual connections from existing friendship data, and prepare the UI component for displaying mutual friend counts.
Output: `getMutualFriendSuggestions()` function in friendshipService.js and `subtitle` prop on FriendCard.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-mutual-friends-suggestions/42-CONTEXT.md

@src/services/firebase/friendshipService.js
@src/services/firebase/contactSyncService.js
@src/components/FriendCard.js
@src/styles/FriendCard.styles.js

**Tech stack available:** React Native, Expo, Firebase Firestore (modular v9 API with @react-native-firebase/firestore)
**Established patterns:**

- friendshipService uses `or(where('user1Id', '==', userId), where('user2Id', '==', userId))` for friendship queries
- Services return `{ success: true/false, data/error }` objects
- contactSyncService returns suggestion objects with full user profile data (displayName, username, profilePhotoURL)
- FriendCard uses `friendsSince` pattern for subtitle-style text below username

**Constraining decisions:**

- Phase 20: Contact suggestions use `dismissedSuggestions` array on user document — reuse for mutual friend dismissals
- Phase 42 CONTEXT: Show "X mutual friends" count only (not names), separate subsection from contact suggestions
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Add getMutualFriendSuggestions to friendshipService</name>
  <files>src/services/firebase/friendshipService.js</files>
  <action>
Add a new exported async function `getMutualFriendSuggestions(userId)` at the end of friendshipService.js.

Algorithm:

1. Query ALL friendships involving `userId` using existing `or()` pattern (single query, same as getFriendships)
2. From results, build two sets:
   - `friendIds` (Set): user IDs from accepted friendships (these are the user's actual friends)
   - `excludeIds` (Set): ALL connected user IDs from any status (accepted + pending) PLUS `userId` itself — these are excluded from suggestions
3. Take up to 30 friend IDs from `friendIds` (slice to limit query volume)
4. For each friend, query THEIR friendships using the same `or()` pattern (run all in parallel with `Promise.all`)
5. From each friend's friendships, extract accepted friend IDs. For each friend-of-friend NOT in `excludeIds`, increment a count in a `mutualCounts` Map (key: userId, value: count)
6. Sort entries by count descending, take top 20
7. Fetch user profile data for each suggestion ID: use `Promise.all` with individual `getDoc(doc(db, 'users', userId))` calls. Extract: displayName, username, profilePhotoURL
8. Return `{ success: true, suggestions }` where each suggestion is `{ userId, displayName, username, profilePhotoURL, mutualCount }`

Error handling: wrap in try/catch, return `{ success: false, error: error.message }` on failure. Log via `logger.error`.

Performance notes:

- Cap at 30 friends processed to limit Firestore reads (each friend = 1 query using or())
- Cap at 20 returned suggestions to limit user profile fetches
- All friend queries run in parallel (Promise.all) — Firestore handles concurrent reads well
- No server-side caching needed for MVP — results computed on demand

Do NOT create a separate file. Add to existing friendshipService.js alongside other exports. Follow the existing JSDoc pattern with @param/@returns annotations.
</action>
<verify>Import `getMutualFriendSuggestions` in a test context or verify the export is available: `node -e "console.log('parse check')"` after syntax validation. Verify the function signature matches: `getMutualFriendSuggestions(userId)` returning `{ success, suggestions }`.</verify>
<done>Function exported from friendshipService.js, follows existing service patterns (async, try/catch, { success } return), handles edge cases (no friends, no mutual connections), caps processing at 30 friends and 20 suggestions.</done>
</task>

<task type="auto">
  <name>Task 2: Add subtitle prop to FriendCard</name>
  <files>src/components/FriendCard.js, src/styles/FriendCard.styles.js</files>
  <action>
Add an optional `subtitle` prop to FriendCard component.

In FriendCard.js:

1. Add `subtitle` to the destructured props (alongside onDismiss, isBlocked, etc.)
2. In the "User info" section (after the username Text element, around line 278), add a conditional render:
   ```
   {subtitle && (
     <Text style={styles.subtitle} numberOfLines={1}>
       {subtitle}
     </Text>
   )}
   ```
3. Place this BEFORE the existing `showFriendsSince` block so both can coexist but typically only one is used

In FriendCard.styles.js:

1. Add a `subtitle` style that matches the existing `friendsSince` style pattern:
   - fontSize matching friendsSince (likely ~12)
   - color: `colors.text.tertiary`
   - marginTop: 2
   - This keeps visual consistency with the existing "Friends since" subtitle

Do NOT change any existing FriendCard behavior. The subtitle prop is purely additive. When not provided, nothing changes.
</action>
<verify>Read FriendCard.js and confirm the `subtitle` prop is destructured and rendered conditionally. Read FriendCard.styles.js and confirm the `subtitle` style exists with appropriate typography.</verify>
<done>FriendCard accepts optional `subtitle` string prop, renders it below username in tertiary text color, style matches existing `friendsSince` pattern. No visual change when prop is not provided.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `getMutualFriendSuggestions` is exported from friendshipService.js
- [ ] Function follows existing service patterns ({ success } return, JSDoc, logger.error)
- [ ] FriendCard accepts and renders `subtitle` prop
- [ ] FriendCard.styles.js has `subtitle` style
- [ ] No existing functionality broken (FriendCard still works without subtitle)
- [ ] No lint/syntax errors in modified files
</verification>

<success_criteria>

- getMutualFriendSuggestions function added to friendshipService with correct algorithm
- FriendCard supports subtitle prop with consistent styling
- All verification checks pass
- No errors introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/42-mutual-friends-suggestions/42-01-SUMMARY.md`
</output>
