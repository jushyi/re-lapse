# Phase 15.3: Modal Architecture Fix - Research

**Researched:** 2026-02-02
**Domain:** React Navigation modal stacking and screen architecture
**Confidence:** HIGH

<research_summary>

## Summary

Researched how to properly implement modal stacking in React Native for the profile peek feature. The core issue is that `PhotoDetailModal` uses React Native's `<Modal>` component, which renders outside the navigation hierarchy. iOS only allows one `<Modal>` at a time - opening a second causes app freezing.

The standard approach is to **convert Modal components to navigation screens** with `presentation: 'transparentModal'` or `presentation: 'modal'`. React Navigation's native stack navigator allows modal stacking by navigating from one modal screen to another. This is how Instagram/TikTok likely implement their story viewers and profile peek overlays.

**Primary recommendation:** Convert PhotoDetailModal from React Native `Modal` component to a React Navigation screen with `presentation: 'transparentModal'`. Profile navigation then stacks naturally on top, and back navigation reveals the photo detail screen underneath.
</research_summary>

<standard_stack>

## Standard Stack

### Core (Already in Project)

| Library                        | Version | Purpose                  | Why Standard                             |
| ------------------------------ | ------- | ------------------------ | ---------------------------------------- |
| @react-navigation/native       | 6.x     | Navigation framework     | The standard for React Native navigation |
| @react-navigation/native-stack | 6.x     | Native stack navigator   | Proper modal presentation support        |
| react-native-screens           | 3.x     | Native screen components | Powers native stack presentations        |

### Supporting (Already in Project)

| Library                       | Version | Purpose        | When to Use                    |
| ----------------------------- | ------- | -------------- | ------------------------------ |
| @react-navigation/bottom-tabs | 6.x     | Tab navigation | Tab bar in MainTabNavigator    |
| react-native-reanimated       | 3.x     | Animations     | Smooth transitions, gestures   |
| react-native-gesture-handler  | 2.x     | Gestures       | Swipe to dismiss, pan gestures |

### Alternatives Considered

| Instead of        | Could Use           | Tradeoff                                                                      |
| ----------------- | ------------------- | ----------------------------------------------------------------------------- |
| transparentModal  | fullScreenModal     | fullScreenModal covers entire screen; transparentModal keeps previous visible |
| Navigation screen | React Native Portal | Portal adds complexity; navigation is native and already in stack             |
| Navigation modal  | Wix RNN modals      | Would require major navigation refactor; stick with React Navigation          |

**No new dependencies needed** - the project already has all required libraries.
</standard_stack>

<architecture_patterns>

## Architecture Patterns

### Recommended Project Structure (Modals as Navigation Screens)

```
AppNavigator (Root Stack)
├── Auth screens (PhoneInput, Verification)
├── Onboarding (ProfileSetup, Selects)
└── Main App
    ├── MainTabs (Feed, Camera, Profile)
    ├── Darkroom
    ├── Activity/Friends
    ├── PhotoDetail       ← NEW: transparentModal presentation
    ├── OtherUserProfile  ← stacks on top of PhotoDetail
    └── Albums screens
```

### Pattern 1: Photo Detail as Navigation Screen

**What:** Convert PhotoDetailModal from `<Modal>` component to navigation screen
**When to use:** When the "modal" needs to navigate to other screens and maintain stacking
**Example:**

```typescript
// In AppNavigator.js
<Stack.Screen
  name="PhotoDetail"
  component={PhotoDetailScreen}
  options={{
    presentation: 'transparentModal', // Previous screen stays visible
    headerShown: false,
    animation: 'fade', // Or 'slide_from_bottom'
  }}
/>

<Stack.Screen
  name="OtherUserProfile"
  component={ProfileScreen}
  options={{
    presentation: 'modal', // Stacks on top of PhotoDetail
    headerShown: false,
  }}
/>

// In FeedScreen - navigate instead of showing modal
const handlePhotoPress = (photo) => {
  navigation.navigate('PhotoDetail', { photo, mode: 'feed' });
};
```

### Pattern 2: Modal Stacking via Navigation

**What:** Navigate from one modal screen to another for proper stacking
**When to use:** When user needs to view a profile from within a photo viewer
**Example:**

```typescript
// In PhotoDetailScreen - navigate to profile
const handleAvatarPress = (userId, displayName) => {
  navigation.navigate('OtherUserProfile', { userId, displayName });
};
// Back navigation automatically returns to PhotoDetail
```

### Pattern 3: Transparent Modal with Background Visible

**What:** Use `transparentModal` presentation to keep feed visible behind photo detail
**When to use:** When the modal should overlay content rather than replace it
**Example:**

```typescript
// Screen options
{
  presentation: 'transparentModal',
  cardStyle: { backgroundColor: 'transparent' },
  cardOverlayEnabled: true, // Shows dimmed overlay
}

// Component must have semi-transparent background
const PhotoDetailScreen = () => (
  <View style={{ flex: 1, backgroundColor: 'rgba(0,0,0,0.95)' }}>
    {/* Photo content */}
  </View>
);
```

### Anti-Patterns to Avoid

- **Using React Native's `<Modal>` component for complex flows:** It renders outside navigation, causes iOS stacking issues
- **Nesting Modal components:** iOS only allows one at a time; second modal freezes app
- **Using fullScreenModal when content underneath should be visible:** Use transparentModal instead
- **Pushing regular screens on top of modal screens:** Modals should be last in stack
  </architecture_patterns>

<dont_hand_roll>

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem                      | Don't Build                     | Use Instead                              | Why                                                 |
| ---------------------------- | ------------------------------- | ---------------------------------------- | --------------------------------------------------- |
| Modal stacking               | Custom z-index management       | React Navigation `presentation: 'modal'` | iOS native limitations; navigation handles properly |
| Keep previous screen visible | Manual rendering of background  | `presentation: 'transparentModal'`       | Built-in, handles detachment correctly              |
| Swipe to dismiss             | Custom PanResponder on Modal    | Navigation gesture handling              | Native feel, handles edge cases                     |
| Modal over modal             | Portal systems, custom mounting | Navigate from modal to modal             | iOS only allows one Modal; navigation stacks work   |
| Save/restore state           | Manual state preservation       | Keep screens mounted (transparentModal)  | Navigation already handles this                     |

**Key insight:** React Native's `Modal` component was designed for simple confirmations, not complex navigation flows. For anything involving navigation (like profile peek), use navigation screens with modal presentation. The navigation system handles iOS limitations, gesture dismissal, and proper stacking automatically.
</dont_hand_roll>

<common_pitfalls>

## Common Pitfalls

### Pitfall 1: iOS Single-Modal Limitation

**What goes wrong:** App freezes when trying to show second `<Modal>` while one is open
**Why it happens:** iOS UIKit only allows one modal presentation at a time
**How to avoid:** Use navigation screens with `presentation: 'modal'` instead of `<Modal>` component
**Warning signs:** Modal doesn't appear, app becomes unresponsive on iOS

### Pitfall 2: Previous Screen Unmounting

**What goes wrong:** Going back to photo detail shows stale data or blank screen
**Why it happens:** Default `card` presentation unmounts previous screen
**How to avoid:** Use `presentation: 'transparentModal'` which keeps previous screen rendered
**Warning signs:** Flash of content on back navigation, lost scroll position

### Pitfall 3: Modal Not Receiving Navigation Props

**What goes wrong:** `navigation.navigate()` doesn't work from within modal
**Why it happens:** `<Modal>` renders outside navigation context
**How to avoid:** Convert to navigation screen, or pass navigation prop explicitly
**Warning signs:** "navigation.navigate is not a function" errors

### Pitfall 4: Animation Conflicts

**What goes wrong:** Custom animations conflict with navigation animations
**Why it happens:** Both React Navigation and manual Animated.Value try to animate
**How to avoid:** Remove custom show/hide animations, let navigation handle transitions
**Warning signs:** Janky transitions, double animations, stuck states

### Pitfall 5: Gesture Handler Conflicts

**What goes wrong:** Swipe gestures don't work or conflict with content gestures
**Why it happens:** Multiple gesture handlers competing (pan to dismiss vs swipe content)
**How to avoid:** Use `gestureEnabled` option, configure `gestureResponseDistance`
**Warning signs:** Can't dismiss modal, content gestures blocked
</common_pitfalls>

<code_examples>

## Code Examples

Verified patterns from official sources:

### Converting Modal Component to Navigation Screen

```typescript
// BEFORE: React Native Modal component
// src/components/PhotoDetailModal.js
import { Modal } from 'react-native';

const PhotoDetailModal = ({ visible, onClose, photo }) => (
  <Modal visible={visible} transparent animationType="none">
    {/* content */}
  </Modal>
);

// AFTER: Navigation Screen
// src/screens/PhotoDetailScreen.js
const PhotoDetailScreen = ({ route, navigation }) => {
  const { photo, mode } = route.params;

  const handleClose = () => {
    navigation.goBack();
  };

  const handleAvatarPress = (userId, displayName) => {
    // Stacks profile on top - PhotoDetail stays mounted
    navigation.navigate('OtherUserProfile', { userId, displayName });
  };

  return (
    <View style={styles.container}>
      {/* Same content, but now in navigation context */}
    </View>
  );
};

// Navigator configuration
<Stack.Screen
  name="PhotoDetail"
  component={PhotoDetailScreen}
  options={{
    presentation: 'transparentModal',
    headerShown: false,
    gestureEnabled: true,
    gestureDirection: 'vertical',
  }}
/>
```

### Proper Modal Stacking

```typescript
// Source: react-native-screens maintainer recommendation
// Both screens use modal presentation - stacking works on iOS
<Stack.Navigator>
  <Stack.Screen name="Home" component={HomeScreen} />
  <Stack.Screen
    name="PhotoDetail"
    component={PhotoDetailScreen}
    options={{ presentation: 'transparentModal' }}
  />
  <Stack.Screen
    name="OtherUserProfile"
    component={ProfileScreen}
    options={{ presentation: 'modal' }}
  />
</Stack.Navigator>

// Navigation flow:
// 1. Feed (in MainTabs) → PhotoDetail (transparentModal)
// 2. PhotoDetail → OtherUserProfile (modal, stacks on top)
// 3. Back → OtherUserProfile dismisses, PhotoDetail visible
// 4. Back → PhotoDetail dismisses, Feed visible
```

### FeedScreen Navigation (Instead of Modal)

```typescript
// BEFORE: Managing modal state
const [photoModalVisible, setPhotoModalVisible] = useState(false);
const [selectedPhoto, setSelectedPhoto] = useState(null);

const handlePhotoPress = photo => {
  setSelectedPhoto(photo);
  setPhotoModalVisible(true);
};

// AFTER: Navigation
const handlePhotoPress = photo => {
  navigation.navigate('PhotoDetail', {
    photo,
    mode: 'feed',
    initialShowComments: false,
  });
};
```

### Stories Mode Navigation

```typescript
// Stories with multiple photos - pass array
const handleStoryPress = (friendPhotos, initialIndex) => {
  navigation.navigate('PhotoDetail', {
    photos: friendPhotos,
    initialIndex,
    mode: 'stories',
    hasNextFriend: true,
    onRequestNextFriend: handleNextFriend, // Needs different approach
  });
};
```

</code_examples>

<sota_updates>

## State of the Art (2025-2026)

What's changed recently:

| Old Approach                             | Current Approach                           | When Changed     | Impact                                |
| ---------------------------------------- | ------------------------------------------ | ---------------- | ------------------------------------- |
| React Native `<Modal>` for complex views | Navigation screens with modal presentation | 2023+            | Proper stacking, better performance   |
| Manual state preservation                | transparentModal keeps screens mounted     | React Nav 6.x    | No save/restore code needed           |
| fullScreenModal for overlays             | transparentModal for see-through overlays  | Always available | Better UX, content visible underneath |
| Custom portal systems                    | Navigation-first approach                  | 2024+            | Simpler, native behavior              |

**New tools/patterns to consider:**

- **React Navigation 7** (if upgrading): Improved modal handling, new presentation options
- **Expo Router modals**: If using Expo Router, provides cleaner modal syntax

**Deprecated/outdated:**

- **Save/restore modal state pattern**: Not needed with transparentModal - previous screen stays mounted
- **Using React Native's Modal for navigation flows**: Use navigation screens instead
- **Manual z-index management for stacking**: Navigation handles this natively
  </sota_updates>

<open_questions>

## Open Questions

Things that couldn't be fully resolved:

1. **Stories mode callbacks (onRequestNextFriend)**
   - What we know: Stories mode uses callback props for friend-to-friend transitions
   - What's unclear: How to handle callbacks when using navigation params (can't pass functions)
   - Recommendation: Use navigation events, shared state (Zustand), or navigation listeners

2. **Cube rotation animation preservation**
   - What we know: PhotoDetailModal has cube transition animation for friend changes
   - What's unclear: Whether animation works same way as navigation screen
   - Recommendation: Test animation behavior, may need adjustment for navigation context

3. **CommentsBottomSheet integration**
   - What we know: Currently rendered inside PhotoDetailModal
   - What's unclear: Whether @gorhom/bottom-sheet works inside transparentModal screen
   - Recommendation: Should work, but test interaction between bottom sheet and modal dismissal
     </open_questions>

<sources>
## Sources

### Primary (HIGH confidence)

- [React Navigation Native Stack Docs](https://reactnavigation.org/docs/native-stack-navigator/) - presentation options, modal behavior
- [React Navigation Modal Guide](https://reactnavigation.org/docs/modal/) - best practices, transparent modals
- [react-native-screens Discussion #1976](https://github.com/software-mansion/react-native-screens/discussions/1976) - maintainer confirms modal stacking via navigation

### Secondary (MEDIUM confidence)

- [react-native-screens Issue #525](https://github.com/software-mansion/react-native-screens/issues/525) - iOS modal limitations
- [Solito Modal Recipes](https://solito.dev/recipes/modals) - modal freezing problem, mounting patterns
- [React Native Modals 2025 Guide](https://addjam.com/blog/2025-03-24/react-native-modals-2025-comprehensive-guide/) - when to use Modal vs navigation

### Tertiary (LOW confidence - needs validation)

- Instagram/TikTok use navigation screens for story viewers - inference from behavior, not confirmed
  </sources>

<metadata>
## Metadata

**Research scope:**

- Core technology: React Navigation native stack
- Ecosystem: react-native-screens, Modal component
- Patterns: Modal stacking, transparent modals, navigation-based modals
- Pitfalls: iOS single-modal limitation, screen unmounting, gesture conflicts

**Confidence breakdown:**

- Standard stack: HIGH - using existing project libraries
- Architecture: HIGH - pattern confirmed by react-native-screens maintainer
- Pitfalls: HIGH - documented in GitHub issues and official docs
- Code examples: HIGH - from official documentation and verified patterns

**Research date:** 2026-02-02
**Valid until:** 2026-03-02 (30 days - React Navigation ecosystem stable)
</metadata>

---

_Phase: 15.3-modal-architecture_
_Research completed: 2026-02-02_
_Ready for planning: yes_
