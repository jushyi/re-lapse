---
phase: 15.3-modal-architecture
plan: 01
type: execute
---

<objective>
Convert PhotoDetailModal from React Native Modal component to a React Navigation screen with transparentModal presentation.

Purpose: Enable proper modal stacking so profile navigation keeps photo viewer visible underneath (ISS-003). This also fixes ISS-002 since navigation works properly from navigation screens.
Output: PhotoDetailScreen navigation screen, PhotoDetailContext for state management, updated AppNavigator.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15.3-modal-architecture/15.3-RESEARCH.md
@.planning/phases/15.2-modal-state-preservation/15.2-01-FIX2-SUMMARY.md
@.planning/ISSUES.md
@src/components/PhotoDetailModal.js
@src/navigation/AppNavigator.js
@src/screens/FeedScreen.js

**Research findings:**

- React Native's Modal component renders outside navigation hierarchy
- iOS only allows one Modal at a time - second modal freezes app
- Solution: Use navigation screens with `presentation: 'transparentModal'`
- React Navigation handles stacking natively

**Constraining decisions:**

- Phase 15.2: fullScreenModal for OtherUserProfile (keeps parent mounted but hidden)
- Phase 7.2: Screen + Modal overlay pattern for song search

**Issues being addressed:**

- ISS-002: Comment avatar profile navigation not working
- ISS-003: Modal stacking architecture issue
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create PhotoDetailContext for state management</name>
  <files>src/context/PhotoDetailContext.js</files>
  <action>
Create PhotoDetailContext to manage photo detail state that PhotoDetailScreen and FeedScreen both need access to:

1. Create context with provider component
2. State to manage:
   - currentPhoto (single photo for feed mode)
   - photos (array for stories mode)
   - currentIndex (for stories navigation)
   - mode ('feed' | 'stories')
   - isOwnStory (boolean)
   - hasNextFriend (boolean for stories mode)

3. Callback handlers (set by FeedScreen, called by PhotoDetailScreen):
   - onReactionToggle(emoji, currentCount)
   - onPhotoChange(photo, index)
   - onRequestNextFriend()
   - onClose()
   - onAvatarPress(userId, displayName)

4. Methods:
   - openPhotoDetail(params) - sets state and indicates screen should open
   - closePhotoDetail() - clears state

Pattern: Use refs for callbacks to avoid re-renders when callbacks change. Export usePhotoDetail hook for consuming components.

Do NOT use Zustand or external state libraries - use React Context as per project conventions.
</action>
<verify>File exists at src/context/PhotoDetailContext.js with exported PhotoDetailProvider, usePhotoDetail hook, and all required state/callbacks.</verify>
<done>PhotoDetailContext created with provider, hook, and all state/callback management for photo detail modal</done>
</task>

<task type="auto">
  <name>Task 2: Convert PhotoDetailModal to PhotoDetailScreen</name>
  <files>src/screens/PhotoDetailScreen.js, src/styles/PhotoDetailScreen.styles.js</files>
  <action>
Convert PhotoDetailModal.js to a navigation screen:

1. Create src/screens/PhotoDetailScreen.js based on PhotoDetailModal.js:
   - Remove Modal wrapper component
   - Get photo state from usePhotoDetail() context instead of props
   - Keep all internal logic (usePhotoDetailModal hook, animations, etc.)
   - Get callbacks (onReactionToggle, onAvatarPress, etc.) from context
   - Use navigation.goBack() instead of onClose prop
   - Keep CommentsBottomSheet rendered inside (it's a Modal but that's OK - it's a simple overlay)

2. Move styles to src/styles/PhotoDetailScreen.styles.js:
   - Copy styles from PhotoDetailModal.styles.js
   - Update container style to work as navigation screen:
     - backgroundColor: 'rgba(0,0,0,0.98)' for slight transparency
     - flex: 1

3. Key changes from Modal to Screen:
   - No `visible` prop - screen visibility controlled by navigation
   - No `animationType` - use navigation animation instead
   - Remove Modal import from react-native
   - Get route.params for any initial configuration

4. Handle navigation.goBack() for close:
   - When swipe-to-dismiss completes, call navigation.goBack()
   - When close button pressed, call navigation.goBack()

5. Keep all existing features:
   - Swipe-down-to-dismiss gesture (panResponder)
   - Stories mode with progress bar
   - Cube transition animation
   - Emoji reactions
   - Comments bottom sheet

Do NOT modify the original PhotoDetailModal.js yet - we'll remove it in a later phase after verification.
</action>
<verify>src/screens/PhotoDetailScreen.js exists, imports usePhotoDetail context, renders same UI as PhotoDetailModal but without Modal wrapper.</verify>
<done>PhotoDetailScreen created as navigation screen using context for state/callbacks, with all original features preserved</done>
</task>

<task type="auto">
  <name>Task 3: Add PhotoDetailScreen to AppNavigator</name>
  <files>src/navigation/AppNavigator.js</files>
  <action>
Add PhotoDetailScreen to AppNavigator with transparentModal presentation:

1. Import PhotoDetailScreen:

   ```javascript
   import PhotoDetailScreen from '../screens/PhotoDetailScreen';
   ```

2. Add Stack.Screen in the Main App section (after MainTabs, before Darkroom):

   ```javascript
   <Stack.Screen
     name="PhotoDetail"
     component={PhotoDetailScreen}
     options={{
       presentation: 'transparentModal',
       headerShown: false,
       animation: 'fade',
       gestureEnabled: true,
       gestureDirection: 'vertical',
       contentStyle: { backgroundColor: 'transparent' },
     }}
   />
   ```

3. Why transparentModal:
   - Previous screen (Feed/MainTabs) stays mounted and visible
   - PhotoDetailScreen overlays with semi-transparent background
   - Profile navigation stacks on top, keeps PhotoDetail visible
   - Back navigation reveals PhotoDetail, then Feed

4. Position in navigator:
   - Place after MainTabs but before OtherUserProfile
   - This allows PhotoDetail â†’ OtherUserProfile stacking

5. Add to deep linking config if desired (optional, can skip for now)

Do NOT change OtherUserProfile presentation yet - it currently works with fullScreenModal and we may need to test if transparentModal on PhotoDetail is sufficient.
</action>
<verify>
Run `npx react-native start` and verify no syntax errors.
Check AppNavigator.js includes PhotoDetailScreen import and Stack.Screen configuration.
</verify>
<done>PhotoDetailScreen added to AppNavigator with transparentModal presentation, positioned for proper modal stacking</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] PhotoDetailContext.js exists with provider and hook
- [ ] PhotoDetailScreen.js exists and uses context for state
- [ ] PhotoDetailScreen.styles.js exists with appropriate styles
- [ ] AppNavigator.js includes PhotoDetailScreen with transparentModal
- [ ] No TypeScript/lint errors (if applicable)
- [ ] Metro bundler starts without errors
</verification>

<success_criteria>

- PhotoDetailContext created with all required state and callbacks
- PhotoDetailScreen converted from Modal to navigation screen
- AppNavigator updated with transparentModal presentation
- All files compile without errors
- Foundation ready for FeedScreen integration in Plan 02
  </success_criteria>

<output>
After completion, create `.planning/phases/15.3-modal-architecture/15.3-01-SUMMARY.md` with:
- Duration and task completion
- Files created/modified
- Any deviations or issues
- Ready for Plan 02
</output>
