---
phase: 15.3-modal-architecture
plan: 02
type: execute
---

<objective>
Integrate FeedScreen with PhotoDetailScreen navigation and verify ISS-002/ISS-003 fixes.

Purpose: Complete the modal architecture migration by wiring up FeedScreen to use navigation instead of Modal component, enabling proper profile navigation from photo viewer.
Output: Working photo detail viewer via navigation, fixed comment avatar navigation, verified modal stacking.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15.3-modal-architecture/15.3-RESEARCH.md
@.planning/phases/15.3-modal-architecture/15.3-01-SUMMARY.md (will exist after Plan 01)
@src/screens/FeedScreen.js
@src/context/PhotoDetailContext.js (created in Plan 01)
@src/screens/PhotoDetailScreen.js (created in Plan 01)
@src/navigation/AppNavigator.js

**Prior decisions:**

- PhotoDetailContext manages state and callbacks
- PhotoDetailScreen uses transparentModal presentation
- Callbacks passed via context refs to avoid re-renders

**Issues being addressed:**

- ISS-002: Comment avatar profile navigation not working
- ISS-003: Modal stacking architecture issue
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Wrap App with PhotoDetailProvider</name>
  <files>App.js</files>
  <action>
Wrap the app with PhotoDetailProvider so all screens have access to the context:

1. Import PhotoDetailProvider:

   ```javascript
   import { PhotoDetailProvider } from './src/context/PhotoDetailContext';
   ```

2. Wrap AppNavigator with PhotoDetailProvider:

   ```javascript
   <PhotoDetailProvider>
     <AppNavigator />
   </PhotoDetailProvider>
   ```

3. Position in provider hierarchy:
   - After other providers (Theme, Auth if any)
   - Before AppNavigator

This ensures FeedScreen (which sets callbacks) and PhotoDetailScreen (which uses them) share the same context.
</action>
<verify>App.js imports PhotoDetailProvider and wraps AppNavigator with it.</verify>
<done>PhotoDetailProvider wraps AppNavigator, enabling context sharing between screens</done>
</task>

<task type="auto">
  <name>Task 2: Update FeedScreen to use navigation + context (feed mode)</name>
  <files>src/screens/FeedScreen.js</files>
  <action>
Update FeedScreen to use PhotoDetailContext and navigation instead of PhotoDetailModal:

1. Import usePhotoDetail and useNavigation:

   ```javascript
   import { usePhotoDetail } from '../context/PhotoDetailContext';
   ```

2. Get context methods:

   ```javascript
   const { openPhotoDetail, setCallbacks } = usePhotoDetail();
   ```

3. Remove PhotoDetailModal imports and state:
   - Remove: import PhotoDetailModal
   - Remove: const [showPhotoModal, setShowPhotoModal] = useState(false);
   - Remove: const [selectedPhoto, setSelectedPhoto] = useState(null);
   - Remove: const [initialShowComments, setInitialShowComments] = useState(false);

4. Set up callbacks in useEffect (once on mount):

   ```javascript
   useEffect(() => {
     setCallbacks({
       onReactionToggle: handleReactionToggle,
       onClose: () => {}, // Navigation handles this
       onAvatarPress: handleAvatarPress,
     });
   }, []);
   ```

5. Update handlePhotoPress to navigate:

   ```javascript
   const handlePhotoPress = photo => {
     openPhotoDetail({
       mode: 'feed',
       photo,
       currentUserId: user?.uid,
       initialShowComments: false,
     });
     navigation.navigate('PhotoDetail');
   };
   ```

6. Update handleCommentPress similarly:

   ```javascript
   const handleCommentPress = photo => {
     openPhotoDetail({
       mode: 'feed',
       photo,
       currentUserId: user?.uid,
       initialShowComments: true,
     });
     navigation.navigate('PhotoDetail');
   };
   ```

7. Update handleReactionToggle to also update context photo:
   - After updating local photo state, also update context if needed
   - OR: Move all photo state to context (simpler)

8. Remove the feed mode PhotoDetailModal JSX from render

Keep stories mode Modal for now (we'll convert it in Task 3).
</action>
<verify>
FeedScreen.js no longer renders PhotoDetailModal for feed mode.
Tapping a feed photo navigates to PhotoDetail screen.
</verify>
<done>FeedScreen uses navigation + context for feed mode photo detail</done>
</task>

<task type="auto">
  <name>Task 3: Update FeedScreen for stories mode</name>
  <files>src/screens/FeedScreen.js</files>
  <action>
Convert stories mode to also use PhotoDetailScreen navigation:

1. Remove stories-related PhotoDetailModal state:
   - Remove: storiesModalVisible, selectedFriend, selectedFriendIndex
   - Remove: storiesInitialIndex, storiesCurrentIndex
   - Move these to context or keep as local state passed to context

2. Update setCallbacks to include stories callbacks:

   ```javascript
   setCallbacks({
     onReactionToggle: handleStoriesReactionToggle, // Will be set dynamically
     onPhotoChange: handleStoriesPhotoChange,
     onRequestNextFriend: handleRequestNextFriend,
     onClose: handleCloseStories,
     onAvatarPress: handleAvatarPress,
   });
   ```

3. Update handleOpenStories:

   ```javascript
   const handleOpenStories = friend => {
     const startIndex = getFirstUnviewedIndex(friend.topPhotos || []);
     // ... existing friend index calculation ...

     openPhotoDetail({
       mode: 'stories',
       photos: friend.topPhotos || [],
       currentIndex: startIndex,
       currentUserId: user?.uid,
       hasNextFriend: hasNextFriendForIndex(friendIdx),
       isOwnStory: false,
     });

     // Store friend info locally for handleRequestNextFriend
     setSelectedFriend(friend);
     setSelectedFriendIndex(friendIdx);

     navigation.navigate('PhotoDetail');
   };
   ```

4. Similarly update handleOpenMyStories for own stories

5. Update handleRequestNextFriend:
   - After setting next friend, call context.updatePhotoDetail() with new photos array
   - Context will update PhotoDetailScreen without re-mounting

6. Remove all three PhotoDetailModal JSX blocks from render

7. Keep reaction state updates working:
   - handleStoriesReactionToggle updates local friend state
   - Also update context photo if needed
     </action>
     <verify>
     FeedScreen.js has no PhotoDetailModal JSX.
     Tapping friend story navigates to PhotoDetail screen.
     Friend-to-friend cube transition still works (updates context, screen reflects change).
     </verify>
     <done>FeedScreen uses navigation + context for both feed and stories modes</done>
     </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>PhotoDetailModal converted to PhotoDetailScreen navigation with transparentModal presentation. FeedScreen uses navigation instead of Modal component. Comment avatar navigation should now work (ISS-002). Profile navigation should keep photo viewer visible (ISS-003).</what-built>
  <how-to-verify>
    1. Run: npx react-native start && npx react-native run-ios
    2. Navigate to Feed tab
    3. **Feed mode test:**
       - Tap any feed photo to open photo detail
       - Verify: Photo detail appears with semi-transparent overlay
       - Verify: Swipe down to dismiss works
       - Tap avatar in photo detail
       - Verify: Profile opens as modal overlay
       - Verify: Photo detail is visible underneath (not hidden)
       - Press back → returns to photo detail
       - Press back again → returns to feed
    4. **Stories mode test:**
       - Tap any friend's story in stories bar
       - Verify: Stories viewer opens with progress bar
       - Verify: Tap left/right to navigate photos
       - Tap avatar → profile opens, stories visible underneath
       - Back → returns to stories
       - Navigate to end of friend's photos → cube transition to next friend
    5. **ISS-002 test (comment avatar):**
       - Open any photo detail
       - Tap comment button to open comments
       - Tap a commenter's avatar
       - Verify: Profile opens successfully (was previously broken)
       - Back → returns to comments sheet
       - Close comments → still in photo detail
    6. **Own stories test:**
       - Tap own story card (leftmost in stories bar)
       - Verify: Own photos show, reactions disabled (grayed)
       - Tap avatar → goes to Profile tab
    7. Confirm: No app freezes, smooth animations
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] App.js wraps AppNavigator with PhotoDetailProvider
- [ ] FeedScreen no longer renders PhotoDetailModal
- [ ] Feed mode: Photo tap navigates to PhotoDetail screen
- [ ] Stories mode: Story tap navigates to PhotoDetail screen
- [ ] Avatar tap in photo detail navigates to profile
- [ ] Profile shows over photo detail (transparentModal working)
- [ ] Back navigation returns to photo detail then feed
- [ ] ISS-002: Comment avatar navigation works
- [ ] ISS-003: Modal stacking architecture fixed
- [ ] No crashes or freezes on iOS
</verification>

<success_criteria>

- FeedScreen uses navigation instead of Modal for photo detail
- PhotoDetailProvider wraps app for context sharing
- All photo detail features work (reactions, comments, stories navigation)
- ISS-002 fixed: Comment avatar navigation works
- ISS-003 fixed: Profile overlays photo detail instead of hiding it
- Smooth animations and no iOS freezing
  </success_criteria>

<output>
After completion, create `.planning/phases/15.3-modal-architecture/15.3-02-SUMMARY.md` with:
- Duration and task completion
- ISS-002 and ISS-003 resolution status
- Files created/modified
- Any issues encountered
- Phase 15.3 complete status

Also update `.planning/ISSUES.md` to close ISS-002 and ISS-003.
</output>
