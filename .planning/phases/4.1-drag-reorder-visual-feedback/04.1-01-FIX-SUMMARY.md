---
phase: 04.1-drag-reorder-visual-feedback
plan: 01-FIX
subsystem: ui
tags: [react-native, LayoutAnimation, reanimated, drag-reorder]

# Dependency graph
requires:
  - phase: 04.1-01
    provides: Drag-to-reorder implementation with shift animations
provides:
  - Flash-free reorder and delete animations
  - Duplicate photo validation
  - Drag selection preview
affects: []

# Tech tracking
tech-stack:
  added: []
  patterns:
    - LayoutAnimation for array state transitions
    - photoId-based React keys for stable component identity

key-files:
  created: []
  modified:
    - src/screens/SelectsScreen.js

key-decisions:
  - 'Use LayoutAnimation.Presets.easeInEaseOut for smooth array transitions'
  - 'Use photoId as React key instead of index to prevent content flash'
  - 'withDelay(16ms) + withTiming(200ms) to sync transform reset with LayoutAnimation'

patterns-established:
  - 'LayoutAnimation before state update for list reordering'
  - 'Unique content-based keys for draggable list items'

issues-created: []

# Metrics
duration: 25min
completed: 2026-01-27
---

# Phase 4.1 FIX: UAT Issues Summary

**Fixed flash on drop and added slide animation for delete, plus duplicate validation and drag preview selection**

## Performance

- **Duration:** 25 min
- **Started:** 2026-01-27
- **Completed:** 2026-01-27
- **Tasks:** 2 (+ checkpoint)
- **Files modified:** 1

## UAT Issues Fixed

### UAT-001: Flash on Drop (Major) - FIXED

- **Root cause:** React reused component instances by index, causing content to swap before animation
- **Fix:**
  1. Added LayoutAnimation.configureNext before handleReorder state update
  2. Changed DraggableThumbnail key from `index` to `photoId` for stable identity
  3. Added withDelay(16ms) + withTiming(200ms) to sync transform reset with LayoutAnimation

### UAT-002: No Slide on Delete (Major) - FIXED

- **Root cause:** Array state update happened instantly without layout animation
- **Fix:** Added LayoutAnimation.configureNext before handleRemovePhoto state update

## Additional Improvements

### Duplicate Photo Validation

- **Issue discovered:** Using photoId as key caused React error when same photo selected twice
- **Fix:** Added duplicate detection to both single and multi-select photo pickers
- **UX:** Shows "Already Added" alert when duplicate detected

### Drag Preview Selection

- **Enhancement:** Dragged photo now shows in preview during drag
- **Implementation:** setSelectedIndex(index) in handleDragStart

## Task Commits

1. **Task 1: Fix UAT-001 - LayoutAnimation for reorder** - `7770553` (fix)
2. **Task 2: Fix UAT-002 - LayoutAnimation for delete** - `50442ea` (fix)
3. **Refinements: Keys, validation, preview, timing** - `4347633` (fix)

## Files Modified

- `src/screens/SelectsScreen.js` - All fixes applied to single file

## Technical Details

### Imports Added

```javascript
import { LayoutAnimation, Platform, UIManager } from 'react-native';
import { withDelay } from 'react-native-reanimated';
```

### Android LayoutAnimation Setup

```javascript
if (Platform.OS === 'android' && UIManager.setLayoutAnimationEnabledExperimental) {
  UIManager.setLayoutAnimationEnabledExperimental(true);
}
```

### Key Pattern Change

```javascript
// Before (caused content flash)
key = { index };

// After (stable component identity)
const photoKey = photo.assetId || photo.uri;
key = { photoKey };
```

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] React key collision on duplicate photos**

- **Found during:** Checkpoint verification
- **Issue:** Using photoId as key caused crash when same photo selected twice
- **Fix:** Added duplicate validation to both photo pickers
- **Files modified:** src/screens/SelectsScreen.js
- **Verification:** Selecting same photo twice now shows alert instead of crashing

**2. [Rule 2 - Missing Critical] Dragged photo not visible in preview**

- **Found during:** Checkpoint verification (user request)
- **Issue:** Preview didn't update to show which photo was being dragged
- **Fix:** Added setSelectedIndex(index) to handleDragStart
- **Files modified:** src/screens/SelectsScreen.js
- **Verification:** Dragged photo now displays in preview during drag

---

**Total deviations:** 2 auto-fixed (1 bug, 1 missing critical)
**Impact on plan:** Necessary for correct functionality and improved UX

## Issues Encountered

- Animation timing required multiple iterations to find right balance between flash elimination and smooth visual
- Final solution uses withDelay(16ms) + withTiming(200ms) which has slight animation quirk but no flash

## Verification Results

- [x] UAT-001 fixed: No flash on drop
- [x] UAT-002 fixed: Delete causes slide animation
- [x] Shift animations during drag still work (regression check)
- [x] Gap collapse toward delete zone still works (regression check)
- [x] Duplicate photo validation works
- [x] Dragged photo shows in preview

---

_Phase: 04.1-drag-reorder-visual-feedback_
_Plan: 01-FIX_
_Completed: 2026-01-27_
