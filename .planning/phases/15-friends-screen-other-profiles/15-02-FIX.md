---
phase: 15-friends-screen-other-profiles
plan: 02-FIX
type: fix
---

<objective>
Fix 4 UAT issues from plan 15-02.

Source: 15-02-ISSUES.md
Priority: 0 critical, 4 major, 0 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/15-friends-screen-other-profiles/15-02-ISSUES.md

**Original plan for reference:**
@.planning/phases/15-friends-screen-other-profiles/15-02-PLAN.md

**Key files:**
@src/screens/ProfileScreen.js
@src/components/ProfileSongCard.js
@src/screens/FriendsScreen.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-001 - Hide empty profile song state for other users</name>
  <files>src/screens/ProfileScreen.js</files>
  <action>
The ProfileSongCard currently shows for all users, including the empty "Add a song" state when viewing another user who has no profile song. When tapped, it incorrectly modifies the logged-in user's song.

**Fix:**

1. Only render ProfileSongCard for other users IF they have a song set
2. When `!isOwnProfile && !profileData?.profileSong`, don't render the song section at all

Update the song container section (around line 605-612):

```jsx
{
  /* 4. Profile Song - hide empty state for other users */
}
{
  (isOwnProfile || profileData?.profileSong) && (
    <View style={styles.songContainer}>
      <ProfileSongCard
        song={profileData?.profileSong || null}
        isOwnProfile={isOwnProfile}
        onPress={handleSongPress}
        onLongPress={handleSongLongPress}
      />
    </View>
  );
}
```

This ensures:

- Own profile: Always shows (empty state prompts to add song)
- Other user WITH song: Shows their song
- Other user WITHOUT song: Hidden entirely
  </action>
  <verify>View a friend's profile who has no song - song section should be hidden</verify>
  <done>Empty profile song state hidden for other users, visible only when they have a song</done>
  </task>

<task type="auto">
  <name>Task 2: Fix UAT-002/004 - Show albums and monthly albums for friends</name>
  <files>src/screens/ProfileScreen.js</files>
  <action>
Two related issues:
1. Albums section not showing for friends (UAT-002)
2. Monthly albums hidden for friends (UAT-004)

**Root cause for UAT-002:**
The `isFriend` variable is derived on line 223 from `friendshipStatus`, but `fetchAlbums()` in the useFocusEffect (line 179-183) runs immediately on focus. At that point, `friendshipStatus` is still the default 'none' because `fetchFriendshipStatus()` is async and hasn't completed yet. The dependency array includes `isFriend`, but the initial render always sees `isFriend = false`.

**Fix for UAT-002:**

1. Move the albums fetch to happen AFTER friendship status is determined
2. Add a flag to track when friendship status is loaded
3. Only fetch albums once we know the friendship status

Add state to track friendship status loaded:

```javascript
const [friendshipStatusLoaded, setFriendshipStatusLoaded] = useState(false);
```

Update fetchFriendshipStatus to set the loaded flag:

```javascript
const fetchFriendshipStatus = useCallback(async () => {
  if (isOwnProfile || !userId || !user?.uid) {
    setFriendshipStatusLoaded(true); // Mark as loaded for own profile
    return;
  }

  try {
    const result = await checkFriendshipStatus(user.uid, userId);
    if (result.success) {
      setFriendshipStatus(result.status);
      setFriendshipId(result.friendshipId);
    }
  } catch (error) {
    logger.error('ProfileScreen: Error fetching friendship status', { error: error.message });
  } finally {
    setFriendshipStatusLoaded(true); // Mark as loaded even on error
  }
}, [isOwnProfile, userId, user?.uid]);
```

Update the albums fetch useFocusEffect to depend on friendshipStatusLoaded:

```javascript
useFocusEffect(
  useCallback(() => {
    // For own profile, fetch immediately
    // For other profiles, wait until friendship status is determined
    if (isOwnProfile || friendshipStatusLoaded) {
      fetchAlbums();
    }
  }, [isOwnProfile, user?.uid, userId, friendshipStatus, friendshipStatusLoaded])
);
```

Note: Change dependency from `isFriend` to `friendshipStatus` since `isFriend` is derived.

**Fix for UAT-004:**
Remove the `isOwnProfile` gate on MonthlyAlbumsSection. Friends should see monthly albums.

Change line 669-672 from:

```jsx
{
  isOwnProfile && <MonthlyAlbumsSection userId={user?.uid} onMonthPress={handleMonthPress} />;
}
```

To:

```jsx
<MonthlyAlbumsSection userId={isOwnProfile ? user?.uid : userId} onMonthPress={handleMonthPress} />
```

Note: The CONTEXT.md says friends should see monthly albums. Firestore security rules may need updating separately, but the UI should attempt to show them.
</action>
<verify>View a friend's profile - albums bar and monthly albums section should be visible</verify>
<done>Albums and monthly albums visible for friends, properly gated for non-friends</done>
</task>

<task type="auto">
  <name>Task 3: Fix UAT-003 - Profile opens as overlay, not on Profile tab</name>
  <files>
src/navigation/AppNavigator.js
src/screens/FriendsScreen.js
src/screens/ProfileScreen.js
  </files>
  <action>
Current behavior: Tapping a friend navigates to Profile tab with params, polluting tab state.
Desired behavior: Profile opens as modal/overlay on current screen, back returns to Friends list.

**Solution:** Create a standalone OtherUserProfileScreen that's a modal in the navigation stack, separate from the Profile tab.

**Step 1: Create navigation route for other user profiles**

In AppNavigator.js, add a new modal screen for viewing other users' profiles:

```jsx
// In the main stack or as a modal group
<Stack.Screen
  name="OtherUserProfile"
  component={ProfileScreen}
  options={{
    presentation: 'modal', // Or 'card' for slide-from-right
    headerShown: false,
  }}
/>
```

If using tab navigator with nested stacks, add OtherUserProfile to the root stack (outside tabs) so it overlays the current tab.

**Step 2: Update FriendsScreen navigation**

In FriendsScreen.js, change navigation from going to Profile tab to the new modal:

- Find where `handleProfilePress` or similar navigates
- Change from: `navigation.navigate('Profile', { userId, username })`
- To: `navigation.navigate('OtherUserProfile', { userId, username })`

This keeps the navigation in the current stack rather than switching tabs.

**Step 3: Verify ProfileScreen handles modal dismissal**

ProfileScreen already has a back button for non-own profiles. Verify `navigation.goBack()` works correctly when in modal context.

**Step 4: Update any other places that navigate to other profiles**

Search for other places that might navigate to Profile with userId params:

- FeedScreen (story taps, comment avatars)
- StoryModal (avatar taps)
- Any other avatar/username taps

All should navigate to 'OtherUserProfile' instead of 'Profile' when viewing other users.

**Important:** Keep the Profile tab for own profile only. The Profile tab should always show the logged-in user's profile.
</action>
<verify>

1. From Feed, tap friend icon → Friends screen
2. Tap a friend's card → Profile opens as overlay (not on Profile tab)
3. Tap back → Returns to Friends screen
4. Tap Profile tab → Shows YOUR profile, not the friend's
   </verify>
   <done>Other user profiles open as modal overlay, Profile tab always shows own profile</done>
   </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed all 4 UAT issues for other user profile viewing</what-built>
  <how-to-verify>
    1. Run: npx expo start

    **Test UAT-001 (Profile song):**
    2. View a friend's profile who has NO profile song
    3. Verify: No song section visible (no "Add a song" prompt)
    4. View a friend's profile who HAS a profile song
    5. Verify: Their song is visible and playable

    **Test UAT-002 (Albums):**
    6. View a friend's profile
    7. Verify: Albums bar is visible (or empty state if they have no albums)

    **Test UAT-003 (Navigation):**
    8. From Feed, tap friend icon to open Friends screen
    9. Tap on a friend's card
    10. Verify: Profile opens as overlay/modal (not switching to Profile tab)
    11. Tap back button
    12. Verify: Returns to Friends screen (not Feed)
    13. Tap Profile tab at bottom
    14. Verify: Shows YOUR profile, not the friend's

    **Test UAT-004 (Monthly albums):**
    15. View a friend's profile
    16. Verify: Monthly albums section visible (year headers with month cards)

    **Test non-friend:**
    17. View a non-friend's profile
    18. Verify: Albums hidden, "Add Friend" button shown
    19. Verify: Monthly albums hidden

  </how-to-verify>
  <resume-signal>Type "approved" or describe any remaining issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] UAT-001: Empty profile song state hidden for other users
- [ ] UAT-002: Albums visible for friends
- [ ] UAT-003: Profile opens as overlay, back returns correctly, Profile tab shows own profile
- [ ] UAT-004: Monthly albums visible for friends
- [ ] Non-friends still see Add Friend button instead of albums
- [ ] No crashes or errors when viewing profiles
</verification>

<success_criteria>

- All 4 UAT issues from 15-02-ISSUES.md addressed
- Profile navigation works correctly without tab pollution
- Content visibility matches friendship status correctly
- Ready for re-verification
  </success_criteria>

<output>
After completion, create `.planning/phases/15-friends-screen-other-profiles/15-02-FIX-SUMMARY.md`
</output>
