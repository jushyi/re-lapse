---
phase: 15-friends-screen-other-profiles
plan: 02
type: execute
---

<objective>
Enable viewing other users' profiles with proper data fetching and conditional content visibility based on friendship status.

Purpose: Transform ProfileScreen from placeholder-based other-user viewing to real data fetching with friendship-aware content visibility.
Output: ProfileScreen fetches other user data from Firestore, displays appropriate content based on friendship status, and shows Add Friend button for non-friends.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-friends-screen-other-profiles/15-CONTEXT.md
@.planning/phases/15-friends-screen-other-profiles/15-01-SUMMARY.md

# Current ProfileScreen (uses placeholder for other users):

@src/screens/ProfileScreen.js

# Friendship service (status checking):

@src/services/firebase/friendshipService.js

**From CONTEXT.md - Conditional Profile Display:**

- **Friends:** See everything — selects, albums, monthly albums, profile song, bio
- **Non-friends:** See profile photo, display name, username, bio, selects, profile song — but NO albums
- Where albums would appear for non-friends: prominent "Add Friend" button

**Prior decisions from Phase 5:**

- isOwnProfile pattern with route params already exists
- Placeholder data for other users (TODO: Firestore fetch)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create userService.getUserProfile function</name>
  <files>src/services/firebase/userService.js</files>
  <action>
Add a new function to fetch any user's profile data from Firestore:

```javascript
/**
 * Get a user's public profile data
 * @param {string} userId - User ID to fetch
 * @returns {Promise<{success: boolean, profile?: object, error?: string}>}
 */
export const getUserProfile = async userId => {
  // Fetch from 'users' collection
  // Return: userId, displayName, username, bio, photoURL, profilePhotoURL,
  //         selects (array of photo URIs), profileSong (object or null)
  // DO NOT return sensitive data (email, phone, etc.)
};
```

This function will be used by ProfileScreen to fetch other users' data.

Also export from the firebase services index if not already.
</action>
<verify>Function exists, can fetch user data by ID, returns expected shape</verify>
<done>getUserProfile function in userService.js, exported from services index</done>
</task>

<task type="auto">
  <name>Task 2: Update ProfileScreen to fetch other user data and check friendship</name>
  <files>src/screens/ProfileScreen.js</files>
  <action>
Update ProfileScreen to fetch real data for other users and check friendship status:

**When viewing another user (!isOwnProfile):**

1. **Fetch profile data:**
   - Call getUserProfile(userId) on mount/focus
   - Store in local state (otherUserProfile)
   - Show loading state while fetching

2. **Check friendship status:**
   - Call checkFriendshipStatus(currentUser.uid, userId)
   - Store status: 'none' | 'friends' | 'pending_sent' | 'pending_received'
   - Store friendshipId for actions

3. **Update profileData resolution:**

   ```javascript
   const profileData = isOwnProfile ? userProfile : otherUserProfile;
   const isFriend = friendshipStatus === 'friends';
   ```

4. **Add friendship action handler:**
   - handleAddFriend() - calls sendFriendRequest, updates local status
   - handleCancelRequest() - calls declineFriendRequest (cancel sent)
   - handleAcceptRequest() - calls acceptFriendRequest

5. **Loading state:**
   - Show spinner while fetching other user's profile
   - Handle error state gracefully
     </action>
     <verify>Other user profile loads from Firestore, friendship status is determined</verify>
     <done>ProfileScreen fetches other user data, determines friendship status</done>
     </task>

<task type="auto">
  <name>Task 3: Implement conditional content visibility</name>
  <files>src/screens/ProfileScreen.js</files>
  <action>
Add conditional rendering based on friendship status:

**Visible to everyone (friends AND non-friends):**

- Profile photo
- Display name
- Username
- Bio
- Selects banner (their highlights)
- Profile song

**Visible to friends ONLY:**

- AlbumBar (user-created albums)
- MonthlyAlbumsSection

**For non-friends, replace albums section with Add Friend button:**

```jsx
{!isOwnProfile && !isFriend ? (
  <View style={styles.addFriendSection}>
    <TouchableOpacity
      style={styles.addFriendButton}
      onPress={handleAddFriend}
      disabled={friendshipStatus === 'pending_sent'}
    >
      <Ionicons name="person-add-outline" size={24} color="#FFF" />
      <Text style={styles.addFriendText}>
        {friendshipStatus === 'pending_sent' ? 'Request Sent' :
         friendshipStatus === 'pending_received' ? 'Accept Request' : 'Add Friend'}
      </Text>
    </TouchableOpacity>
    {friendshipStatus === 'pending_sent' && (
      <TouchableOpacity onPress={handleCancelRequest}>
        <Text style={styles.cancelText}>Cancel Request</Text>
      </TouchableOpacity>
    )}
  </View>
) : (
  <>
    <AlbumBar ... />
    <MonthlyAlbumsSection ... />
  </>
)}
```

**Add Friend button styling:**

- Prominent, full-width in the albums area
- Purple background (brand color)
- Icon + text
- Disabled state for pending
- Cancel option below when pending

**Accept incoming request:**

- If pending_received, show "Accept Request" instead of "Add Friend"
- Tapping accepts and refreshes status to 'friends'
  </action>
  <verify>Non-friends see Add Friend button, friends see albums, pending states work</verify>
  <done>Conditional content visibility working based on friendship status</done>
  </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Profile viewing with friendship-based content visibility</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. **Test with a friend:** Navigate to a friend's profile
       - Verify: All content visible (selects, albums, monthly albums, song)
    3. **Test with non-friend:** Navigate to a non-friend's profile
       - Verify: Profile photo, name, username, bio, selects, song visible
       - Verify: Albums section replaced with "Add Friend" button
    4. **Test Add Friend:** Tap the Add Friend button
       - Verify: Button changes to "Request Sent" with cancel option
    5. **Test cancel:** Tap "Cancel Request"
       - Verify: Returns to "Add Friend" state
    6. **Test accept:** If you have incoming request, verify "Accept Request" works
       - After accepting, albums should become visible

    Note: To test, you may need two accounts or mock the friendship status.

  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] getUserProfile function fetches other user's public data
- [ ] ProfileScreen fetches real data for other users
- [ ] Friendship status is checked and stored
- [ ] Friends see all content (including albums)
- [ ] Non-friends see limited content (no albums)
- [ ] Add Friend button appears for non-friends
- [ ] Pending state shows "Request Sent" with cancel option
- [ ] Accept incoming request works
- [ ] No errors or crashes when viewing other profiles
</verification>

<success_criteria>

- Other user profiles load real data from Firestore
- Friendship status determines content visibility
- Albums hidden for non-friends, Add Friend button shown instead
- All friend request actions work from profile view
- Smooth loading states and error handling
  </success_criteria>

<output>
After completion, create `.planning/phases/15-friends-screen-other-profiles/15-02-SUMMARY.md`
</output>
