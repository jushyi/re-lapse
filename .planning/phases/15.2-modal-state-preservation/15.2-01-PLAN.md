---
phase: 15.2-modal-state-preservation
plan: 01
type: execute
---

<objective>
Preserve modal state when navigating to profiles from avatar taps - back navigation returns users to the exact modal state they left.

Purpose: Create seamless "profile peek" experience where tapping an avatar feels like a quick detour, not a disruptive navigation that loses context.
Output: Avatar taps from modals navigate to profile, back returns to exact modal state (same photo, scroll position, comments visible).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15.2-modal-state-preservation/15.2-CONTEXT.md
@.planning/phases/15-friends-screen-other-profiles/15-03-SUMMARY.md

# Key source files:

@src/screens/FeedScreen.js
@src/components/PhotoDetailModal.js
@src/components/StoriesViewerModal.js
@src/components/comments/CommentsBottomSheet.js

**Tech stack available:** React Navigation 6, React Native Modal, useFocusEffect
**Established patterns:**

- Avatar handlers close modal before navigation (100-500ms timeouts)
- PhotoDetailModal has two modes: 'feed' and 'stories'
- CommentsBottomSheet is nested inside PhotoDetailModal
- OtherUserProfile is a root Stack.Screen (not tab-nested)

**Constraining decisions:**

- [Phase 15-03]: Avatar handlers call onClose() then onAvatarPress() with timing delays
- [Phase 15-03]: Navigation uses navigation.navigate('OtherUserProfile', {userId, username})

**Current behavior:**

- Avatar tap → close modal → navigate to profile
- Back from profile → FeedScreen with modal closed (lost context)

**Desired behavior:**

- Avatar tap → save state → close modal → navigate to profile
- Back from profile → FeedScreen restores modal with exact state
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Add modal state preservation infrastructure to FeedScreen</name>
  <files>src/screens/FeedScreen.js</files>
  <action>
Add refs to FeedScreen for modal state preservation:

1. Add `savedModalStateRef` useRef to store modal configuration before navigation:

```javascript
const savedModalStateRef = useRef(null);
// Shape: {
//   type: 'photoDetail' | 'stories',
//   selectedPhoto: object,
//   selectedFriend: object,
//   initialShowComments: boolean,
//   storiesInitialIndex: number
// }
```

2. Add `isProfilePeekRef` useRef(false) to track if we navigated from a modal avatar tap.

3. Add helper function `saveModalState(type)` that captures current modal state:

- For 'photoDetail': save selectedPhoto, initialShowComments state
- For 'stories': save selectedFriend, current photo index

4. Add helper function `restoreModalState()` that:

- Reads savedModalStateRef.current
- Sets appropriate state to reopen modal
- Clears savedModalStateRef and isProfilePeekRef

Place refs near other state declarations. Place helpers near other handler functions.
</action>
<verify>FeedScreen.js compiles without errors, refs and helpers defined</verify>
<done>savedModalStateRef, isProfilePeekRef, saveModalState(), restoreModalState() added to FeedScreen</done>
</task>

<task type="auto">
  <name>Task 2: Update avatar handlers to save state before closing</name>
  <files>src/screens/FeedScreen.js, src/components/PhotoDetailModal.js</files>
  <action>
Modify avatar press handling to save modal state before close/navigation:

**In FeedScreen.js:**

1. Update `handleAvatarPress` to accept optional `modalType` parameter:

```javascript
const handleAvatarPress = (userId, username, modalType = null) => {
  if (modalType) {
    saveModalState(modalType);
    isProfilePeekRef.current = true;
  }
  navigation.navigate('OtherUserProfile', { userId, username });
};
```

2. Create `handleModalAvatarPress` wrapper for PhotoDetailModal that:

- Determines modal type ('photoDetail' for feed mode, 'stories' for stories mode)
- Calls saveModalState with type
- Sets isProfilePeekRef.current = true
- Then proceeds with existing close → navigate flow

3. Update PhotoDetailModal prop passing to use new handler that preserves state.

**In PhotoDetailModal.js:**

4. Update `handleAvatarPress` (header avatar) to call onAvatarPress with a flag indicating it came from modal, OR pass modal type through callback.

5. Update `handleCommentAvatarPress` similarly - the state saving happens in FeedScreen before the close/navigate sequence.

Keep existing setTimeout delays for close animations - they still need to complete before navigation. The state is saved BEFORE the close sequence starts.
</action>
<verify>Avatar taps from PhotoDetailModal still navigate to profile (existing behavior works)</verify>
<done>Avatar handlers save modal state before close sequence, isProfilePeekRef set to true</done>
</task>

<task type="auto">
  <name>Task 3: Implement focus-based modal restoration</name>
  <files>src/screens/FeedScreen.js</files>
  <action>
Add focus effect to detect return from profile and restore modal:

1. Import useFocusEffect from @react-navigation/native if not already imported.

2. Add useFocusEffect hook that runs on screen focus:

```javascript
useFocusEffect(
  useCallback(() => {
    // Check if returning from profile peek
    if (isProfilePeekRef.current && savedModalStateRef.current) {
      // Small delay to let navigation complete
      const timer = setTimeout(() => {
        restoreModalState();
      }, 100);
      return () => clearTimeout(timer);
    }
  }, [])
);
```

3. Implement `restoreModalState()` logic:

- Read savedModalStateRef.current
- If type === 'photoDetail':
  - setSelectedPhoto(saved.selectedPhoto)
  - setInitialShowComments(saved.initialShowComments)
  - setShowPhotoModal(true)
- If type === 'stories':
  - setSelectedFriend(saved.selectedFriend)
  - setStoriesInitialIndex(saved.storiesInitialIndex)
  - setStoriesModalVisible(true)
- Clear refs: savedModalStateRef.current = null, isProfilePeekRef.current = false

4. Handle edge case: If user navigates elsewhere from profile (not back), clear refs on next focus without restoring.

Add logger.debug calls to track restoration flow for debugging.
</action>
<verify>Console shows restoration logs when navigating back from profile</verify>
<done>useFocusEffect restores modal state on return from OtherUserProfile</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Modal state preservation for avatar navigation - tapping avatar in modals navigates to profile, back returns to exact modal state</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. Open app on device/simulator

    **Test 1: PhotoDetailModal (Feed) → Profile → Back**
    - Tap a photo in feed to open PhotoDetailModal
    - Tap the author's avatar in the modal header
    - View their profile, then press back
    - Confirm: Same photo modal reopens in same state

    **Test 2: PhotoDetailModal Comments → Profile → Back**
    - Open a photo modal, tap comments icon to show CommentsBottomSheet
    - Tap a commenter's avatar
    - View their profile, then press back
    - Confirm: Photo modal reopens (comments may or may not be visible - either is acceptable)

    **Test 3: Stories Mode → Profile → Back**
    - Tap a friend's story card to open stories viewer
    - Tap the friend's avatar in the header
    - View their profile, then press back
    - Confirm: Stories viewer reopens showing same friend's content

    **Test 4: Normal navigation still works**
    - From profile you navigated to, tap Settings or navigate elsewhere
    - Press back multiple times to return to feed
    - Confirm: No unexpected modal popups (state should have been cleared)

  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx expo start` runs without errors
- [ ] No TypeScript/JavaScript errors in console
- [ ] PhotoDetailModal avatar → profile → back restores modal
- [ ] Stories viewer avatar → profile → back restores viewer
- [ ] Comment avatar → profile → back restores photo modal
- [ ] Normal navigation (not from modal) doesn't trigger unexpected restoration
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Avatar taps from any modal preserve state on back navigation
- No regressions to existing avatar navigation functionality
- Seamless "profile peek" experience achieved
  </success_criteria>

<output>
After completion, create `.planning/phases/15.2-modal-state-preservation/15.2-01-SUMMARY.md`:

# Phase 15.2 Plan 01: Modal State Preservation Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 15.2 complete, ready for Phase 16 (Color Constants Standardization)
</output>
