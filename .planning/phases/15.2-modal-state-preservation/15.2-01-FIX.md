---
phase: 15.2-modal-state-preservation
plan: 15.2-01-FIX
type: fix
---

<objective>
Fix UAT issues by implementing layered profile architecture (Part 1 of 2).

Source: 15.2-01-ISSUES.md
Focus: Navigation configuration and back button setup

**Core change:** Present OtherUserProfile as a modal overlay instead of replacing the screen. The underlying feed and modals remain mounted underneath.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/15.2-modal-state-preservation/15.2-01-ISSUES.md

**Key source files:**
@src/navigation/AppNavigator.js
@src/screens/ProfileScreen.js

**Current OtherUserProfile config (around line 468-476):**

```javascript
<Stack.Screen
  name="OtherUserProfile"
  component={ProfileScreen}
  options={{
    presentation: 'card',
    animation: 'slide_from_right',
    headerShown: false,
  }}
/>
```

</context>

<tasks>

<task type="auto">
  <name>Task 1: Change OtherUserProfile to modal presentation</name>
  <files>src/navigation/AppNavigator.js</files>
  <action>
Update the OtherUserProfile Stack.Screen options to use modal presentation while keeping slide_from_right animation:

```javascript
<Stack.Screen
  name="OtherUserProfile"
  component={ProfileScreen}
  options={{
    presentation: 'fullScreenModal', // Modal overlay - doesn't dismiss underlying content
    animation: 'slide_from_right', // Keep existing right-slide animation
    headerShown: false,
    gestureEnabled: true, // Allow swipe from edge to go back
    gestureDirection: 'horizontal', // Horizontal swipe (from left edge) to dismiss
  }}
/>
```

Notes:

- `presentation: 'fullScreenModal'` creates a modal that covers the screen but doesn't unmount underlying content
- The feed and any open PhotoDetailModal/stories modal remain mounted underneath
- Dismissing (back button or swipe from left edge) reveals them unchanged
- `gestureDirection: 'horizontal'` enables the standard iOS swipe-from-edge-to-go-back gesture
  </action>
  <verify>App compiles without errors, OtherUserProfile screen slides in from right</verify>
  <done>OtherUserProfile uses fullScreenModal presentation with slide_from_right animation and horizontal swipe gesture</done>
  </task>

<task type="auto">
  <name>Task 2: Add back chevron to ProfileScreen for modal dismissal</name>
  <files>src/screens/ProfileScreen.js</files>
  <action>
When ProfileScreen is presented as a modal (via OtherUserProfile route), add a back chevron matching app patterns:

1. **Detect if presented as modal:**
   Check if the screen was navigated to as OtherUserProfile:

   ```javascript
   const route = useRoute();
   const isOtherUser = route.name === 'OtherUserProfile' || route.params?.userId;
   ```

   Note: Check existing code - there may already be `isOwnProfile` logic that can be leveraged.

2. **Add back chevron for other user profiles:**
   When viewing another user's profile, render a back chevron in the header area that calls `navigation.goBack()`.

   Use the existing pattern from other screens (FriendsListScreen, etc.):

   ```javascript
   {
     !isOwnProfile && (
       <TouchableOpacity style={styles.backButton} onPress={() => navigation.goBack()}>
         <Ionicons name="chevron-back" size={28} color={colors.textPrimary} />
       </TouchableOpacity>
     );
   }
   ```

3. **Position the back button:**
   Position it in the top-left, matching the pattern used in FriendsListScreen and other screens.
   Use absolute positioning with appropriate safe area insets.

4. **Check if back button already exists:**
   The ProfileScreen may already have a back button for other user profiles. If so, verify it works correctly with the modal presentation and make any necessary adjustments.

5. **Ensure swipe-from-edge gesture works:**
   The navigation options enable horizontal swipe gesture. Test that swiping from the left edge dismisses the profile.
   </action>
   <verify>Navigate to OtherUserProfile - back chevron visible in top-left, tapping it or swiping from left edge dismisses and reveals feed</verify>
   <done>ProfileScreen shows back chevron when viewing other users, swipe-from-edge gesture works</done>
   </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>OtherUserProfile now presents as a fullScreenModal overlay with slide_from_right animation and horizontal swipe-to-dismiss gesture</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. Open app on device/simulator

    **Test 1: Profile opens as modal overlay**
    - From feed, tap any avatar to open a user's profile
    - Profile should slide in from the right (same animation as before)
    - Back chevron should be visible in top-left

    **Test 2: Back navigation works**
    - Tap the back chevron
    - Profile should slide out to the right
    - Feed should be visible underneath (may still have old save/restore code running - that's OK for now)

    **Test 3: Swipe gesture works**
    - Open another user's profile
    - Swipe from left edge of screen toward right
    - Profile should dismiss with swipe gesture

    **Test 4: Own profile unchanged**
    - Tap Profile tab to view your own profile
    - Should NOT have a back chevron (you're on the tab, not modal)

  </how-to-verify>
  <resume-signal>Type "approved" to continue to FIX2 plan, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx expo start` runs without errors
- [ ] OtherUserProfile slides in from right as modal overlay
- [ ] Back chevron visible when viewing other user's profile
- [ ] Tapping back chevron dismisses profile
- [ ] Swipe from left edge dismisses profile
- [ ] Own profile (via tab) has no back chevron
</verification>

<success_criteria>

- Modal presentation configured correctly
- Back navigation works (both button and gesture)
- Ready for FIX2 plan to clean up old save/restore code
  </success_criteria>

<output>
After completion, create `.planning/phases/15.2-modal-state-preservation/15.2-01-FIX-SUMMARY.md`

Note: After this plan, run FIX2 to remove save/restore infrastructure and fix feed refresh.
</output>
