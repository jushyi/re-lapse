---
phase: 15.2-modal-state-preservation
plan: 15.2-01-FIX2
type: fix
---

<objective>
Fix UAT issues by cleaning up old save/restore code and fixing feed refresh (Part 2 of 2).

Source: 15.2-01-ISSUES.md
Focus: Remove unnecessary code, fix feed refresh behavior, simplify avatar handlers

**Prerequisite:** FIX plan must be completed first (modal presentation configured).

Now that OtherUserProfile is a modal overlay, the save/restore state infrastructure is unnecessary. The underlying content stays mounted, so there's nothing to save or restore.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/15.2-modal-state-preservation/15.2-01-ISSUES.md

**Key source files:**
@src/screens/FeedScreen.js
@src/components/PhotoDetailModal.js

**What FIX plan established:**

- OtherUserProfile now uses `presentation: 'fullScreenModal'`
- Underlying feed and modals remain mounted when profile is shown
- Back chevron and swipe gesture work for dismissal

**Code to remove from FeedScreen.js:**

- `savedModalStateRef` (line ~107)
- `isProfilePeekRef` (line ~109)
- useFocusEffect restoration hook (lines ~136-155)
- `saveModalState` function (lines ~275-301)
- `restoreModalState` function (lines ~307-338)
- Focus listener that refreshes on every navigation (lines ~116-130)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Remove save/restore state infrastructure from FeedScreen</name>
  <files>src/screens/FeedScreen.js</files>
  <action>
Remove the now-unnecessary modal state preservation code:

1. **Remove refs** (around line 106-109):
   - Delete `savedModalStateRef` useRef declaration
   - Delete `isProfilePeekRef` useRef declaration
   - Delete the comments above them about "Modal state preservation refs"

2. **Remove useFocusEffect restoration hook** (around line 136-155):
   - Delete the entire useFocusEffect block that checks `isProfilePeekRef.current && savedModalStateRef.current`
   - This was for detecting back navigation and restoring modal state - no longer needed

3. **Remove saveModalState function** (around line 275-301):
   - Delete the entire `saveModalState` function and its JSDoc comment

4. **Remove restoreModalState function** (around line 307-338):
   - Delete the entire `restoreModalState` function and its JSDoc comment

5. **Keep imports clean:**
   - If useFocusEffect is no longer used elsewhere in the file, it can be removed from imports
   - Check if useCallback is still needed (used elsewhere for other memoized functions)
     </action>
     <verify>FeedScreen.js compiles without errors, no references to removed functions/refs</verify>
     <done>All save/restore infrastructure removed from FeedScreen</done>
     </task>

<task type="auto">
  <name>Task 2: Fix feed refresh on every navigation (UAT-004)</name>
  <files>src/screens/FeedScreen.js</files>
  <action>
Stop the feed from refreshing every time the screen gains focus:

1. **Remove the navigation focus listener** (around line 116-130):
   Delete this entire useEffect block:

   ```javascript
   useEffect(() => {
     const unsubscribe = navigation.addListener('focus', () => {
       // Skip refresh if returning from profile peek...
       logger.debug('Feed screen focused - refreshing feed and stories');
       refreshFeed();
       loadFriendStories();
       loadMyStories();
     });
     return unsubscribe;
   }, [navigation, refreshFeed]);
   ```

   This was causing the feed to refresh on every navigation, showing loading indicators unnecessarily.

2. **Verify initial load still works:**
   - The useFeedPhotos hook handles initial data fetch on mount
   - The separate useEffect for `loadFriendStories()` and `loadMyStories()` on mount should remain (around line 206-211)
   - These only run when `user?.uid` changes (essentially just on mount)

3. **Keep pull-to-refresh logic unchanged:**
   - `handleRefresh` function remains as-is
   - Pull-to-refresh is the user-initiated way to refresh data

**Result:** Feed data persists during navigation. Only refreshes on:

- Initial app launch / component mount
- Pull-to-refresh gesture
  </action>
  <verify>Navigate away from feed and back - no loading indicator appears, data still present</verify>
  <done>Feed only refreshes on initial load and pull-to-refresh, not on every navigation</done>
  </task>

<task type="auto">
  <name>Task 3: Simplify handleAvatarPress in FeedScreen</name>
  <files>src/screens/FeedScreen.js</files>
  <action>
Simplify the handleAvatarPress function now that save/restore is removed:

1. **Find handleAvatarPress** (around line 348-363):
   Current implementation returns a function for deferred navigation.

2. **Simplify to direct navigation:**

   ```javascript
   /**
    * Handle avatar press - navigate to user's profile
    * @param {string} userId - User ID to navigate to
    * @param {string} username - Username for display
    */
   const handleAvatarPress = (userId, username) => {
     logger.debug('FeedScreen: Avatar pressed, navigating to profile', { userId, username });
     navigation.navigate('OtherUserProfile', { userId, username });
   };
   ```

   - Remove the `modalType` parameter entirely
   - Remove the conditional logic that returned a deferred navigation function
   - Just navigate directly - the profile is now a modal overlay

3. **Update any callers that expect a returned function:**
   If PhotoDetailModal or other components call handleAvatarPress and expect a function back, they'll need to be updated (Task 4 handles this).
   </action>
   <verify>FeedScreen.js compiles, handleAvatarPress has simple signature (userId, username)</verify>
   <done>handleAvatarPress simplified to direct navigation, no deferred pattern</done>
   </task>

<task type="auto">
  <name>Task 4: Simplify PhotoDetailModal avatar handlers</name>
  <files>src/components/PhotoDetailModal.js</files>
  <action>
Simplify avatar press handlers now that profile is a modal overlay:

1. **Find handleAvatarPress** (header avatar handler):
   Current implementation may have complex close-then-navigate or deferred navigation logic.

2. **Simplify to direct call:**

   ```javascript
   const handleAvatarPress = () => {
     if (photo?.userId && photo?.username) {
       onAvatarPress(photo.userId, photo.username);
     }
   };
   ```

   - Remove any setTimeout delays for closing
   - Remove any deferred navigation pattern (calling returned function)
   - The PhotoDetailModal stays open underneath the profile modal
   - When user dismisses profile, they see the photo modal still there

3. **Find handleCommentAvatarPress** (comment avatar handler):
   Same simplification:

   ```javascript
   const handleCommentAvatarPress = (userId, username) => {
     onAvatarPress(userId, username);
   };
   ```

   - Remove any close modal logic
   - Remove any setTimeout delays
   - Just call the prop directly

4. **Check for any deferred navigation usage:**
   Look for patterns like:

   ```javascript
   const navigateFn = onAvatarPress(userId, username, 'photoDetail');
   if (navigateFn) navigateFn();
   ```

   Replace with simple:

   ```javascript
   onAvatarPress(userId, username);
   ```

5. **Verify CommentsBottomSheet integration:**
   If handleCommentAvatarPress is passed to CommentsBottomSheet, ensure the simplified version works correctly.
   </action>
   <verify>Tap avatar in photo modal - profile opens, dismiss profile - photo modal still visible</verify>
   <done>PhotoDetailModal avatar handlers simplified, no close/timing/deferred patterns</done>
   </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Removed all save/restore infrastructure, fixed feed refresh, simplified avatar handlers. The layered profile architecture is now complete.</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. Open app on device/simulator

    **Test 1: Profile from Feed Photo Modal**
    - Tap a photo in feed to open PhotoDetailModal
    - Tap the author's avatar in the modal header
    - Profile should open (slide from right)
    - Dismiss profile (back button or swipe)
    - Confirm: Photo modal is still open underneath - no flash, no loading

    **Test 2: Profile from Comments (UAT-001 fix)**
    - Open a photo modal, tap comments icon
    - Tap a commenter's avatar
    - Profile should open
    - Dismiss profile
    - Confirm: Photo modal and comments still visible

    **Test 3: Profile from Stories**
    - Tap a friend's story card to open stories viewer
    - Tap the friend's avatar
    - Profile should open
    - Dismiss profile
    - Confirm: Stories viewer still open at same position

    **Test 4: No Feed Refresh on Navigation (UAT-004 fix)**
    - From feed (with data loaded), navigate to Profile tab
    - Navigate back to Feed tab
    - Confirm: NO loading indicator, data already present
    - Navigate to Camera, then back to Feed
    - Confirm: Still no loading indicator

    **Test 5: Pull-to-Refresh Still Works**
    - On Feed, pull down past threshold
    - Confirm: Refresh triggers, loading indicator shows briefly, data updates

    **Test 6: Initial Load Still Works**
    - Force close and reopen the app
    - Confirm: Feed loads data on initial launch

  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any remaining issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx expo start` runs without errors
- [ ] No console errors related to removed code
- [ ] No references to savedModalStateRef, isProfilePeekRef, saveModalState, restoreModalState
- [ ] Feed does NOT refresh on every navigation (UAT-004 fixed)
- [ ] Pull-to-refresh still works
- [ ] Initial load still works
- [ ] Comment avatar navigation works (UAT-001 fixed)
- [ ] No flash on back navigation (UAT-002 fixed)
- [ ] Underlying modals remain visible when profile dismissed (UAT-003 architecture implemented)
</verification>

<success_criteria>

- All UAT issues from 15.2-01-ISSUES.md addressed
- Old save/restore code completely removed
- Feed refresh behavior fixed
- Avatar handlers simplified
- Clean, simple architecture
  </success_criteria>

<output>
After completion, create `.planning/phases/15.2-modal-state-preservation/15.2-01-FIX2-SUMMARY.md`

Then update 15.2-01-ISSUES.md to move issues to "Resolved" section.
</output>
