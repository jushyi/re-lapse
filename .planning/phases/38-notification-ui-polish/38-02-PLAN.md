---
phase: 38-notification-ui-polish
plan: 02
type: execute
---

<objective>
Polish the notification list UI and implement per-tap read state management.

Purpose: The ActivityScreen currently shows notifications with plain text formatting, marks ALL as read on screen focus (not per-tap), and has no visual unread indicator. This plan adds bold username formatting, unread dot indicators, per-tap mark-as-read behavior, and makes notification items tappable for navigation.
Output: Polished ActivityScreen with unread indicators, bold usernames, tappable items with deep navigation, per-tap read marking.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/38-notification-ui-polish/38-CONTEXT.md
@.planning/phases/38-notification-ui-polish/38-01-SUMMARY.md

# Key source files:

@src/screens/ActivityScreen.js
@src/services/firebase/notificationService.js
@src/screens/FeedScreen.js
@src/navigation/AppNavigator.js
@src/constants/colors.js

# Prior phase context:

@.planning/phases/35-social-notification-events/35-01-SUMMARY.md
@.planning/phases/35-social-notification-events/35-02-SUMMARY.md
@.planning/phases/36-photo-notification-events/36-01-SUMMARY.md
@.planning/phases/36-photo-notification-events/36-02-SUMMARY.md

**Tech stack available:** React Native, Firestore, expo-notifications
**Established patterns:** Color constants system, service {success, data/error} pattern, Firestore queries
**Constraining decisions:**

- Phase 16: All colors must use constants from colors.js
- Phase 35: Notification preferences stored in user doc, shouldSendNotification helper checks preferences
- CONTEXT.md: Mark-as-read on TAP only (not on screen view), dot-only unread indicator, bold username formatting
- CONTEXT.md out of scope: No grouping, no swipe actions, no mark-all-as-read, no sound customization

**Existing unread badge:** FeedScreen already has a real-time Firestore listener for unread notifications showing a dot on the heart icon header button. This will continue working as-is since it queries `read == false`.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Polish notification list UI with bold usernames and unread dot</name>
  <files>src/screens/ActivityScreen.js</files>
  <action>
Refactor the notification rendering in ActivityScreen:

**1. Remove bulk mark-as-read on focus:**
Remove the `useFocusEffect` block that calls `markNotificationsAsRead(user.uid)`. Notifications will now only be marked as read on tap (Task 2).

**2. Update notification text formatting with bold username:**
In `renderNotification`, replace the plain text message with a formatted Text component that bolds the sender name:

```jsx
<Text style={styles.notifMessage} numberOfLines={2}>
  <Text style={styles.notifSenderName}>{item.senderName || 'Someone'}</Text> {actionText}
</Text>
```

Create a helper `getActionText(item)` that returns the action description based on notification type/content:

- If `item.message` exists and starts with the sender name, strip the sender name prefix and return the rest
- If `item.message` exists but doesn't start with sender name, return the full message
- If `item.reactions` exists, return `reacted ${formatReactionsText(item.reactions)} to your photo`
- Default: return `sent you a notification`

This preserves the Cloud Function's `message` field (which includes human-readable text for story, tagged, mention, friend_accepted notifications) while ensuring the username is always bold.

**3. Add unread dot indicator:**
Add a small dot (6x6, borderRadius 3, colors.brand.purple) to the left of each notification item when `item.read !== true`:

```jsx
{
  !item.read && <View style={styles.unreadDot} />;
}
```

Position the dot: absolute, left 6, centered vertically. Add paddingLeft: 20 to notificationItem when unread to make room, or simply place the dot at the start of the row (before avatar). Simpler approach: add the dot as the first element in the row with marginRight: 6, and give it a fixed width of 6 so read items get a 6px transparent spacer instead to keep alignment.

**4. Make entire notification item tappable:**
Wrap each notification item in a TouchableOpacity that:

- Calls `handleNotificationPress(item)` on tap
- The `handleNotificationPress` function navigates based on notification data, then marks as read (Task 2 adds the service function)

```javascript
const handleNotificationPress = async item => {
  // Mark as read locally (optimistic update)
  setNotifications(prev => prev.map(n => (n.id === item.id ? { ...n, read: true } : n)));

  // Mark as read in Firestore
  await markSingleNotificationAsRead(item.id);

  // Navigate based on notification type/data
  const { type, photoId, userId: notifUserId, taggerId } = item;
  if (type === 'reaction' && photoId) {
    navigation.navigate('MainTabs', { screen: 'Feed', params: { photoId } });
  } else if (type === 'story' && notifUserId) {
    navigation.navigate('MainTabs', {
      screen: 'Feed',
      params: { highlightUserId: notifUserId, openStory: true },
    });
  } else if (type === 'tagged' && taggerId) {
    navigation.navigate('MainTabs', {
      screen: 'Feed',
      params: { highlightUserId: taggerId, highlightPhotoId: photoId, openStory: true },
    });
  } else if (type === 'friend_accepted' || type === 'friend_request') {
    navigation.navigate('FriendRequests');
  } else if (item.senderId) {
    // Default: navigate to sender's profile
    handleAvatarPress(item.senderId, item.senderName);
  }
};
```

**5. Add new styles:**

- `notifSenderName`: fontWeight '700', color colors.text.primary (bold username)
- `unreadDot`: width 6, height 6, borderRadius 3, backgroundColor colors.brand.purple
- `readSpacer`: width 6, height 6 (transparent spacer for alignment on read items)

Import `markSingleNotificationAsRead` from notificationService (created in Task 2). If the import doesn't exist yet, add the import and use it. The function signature is: `markSingleNotificationAsRead(notificationId)`.
</action>
<verify>

1. `npm run lint` passes
2. ActivityScreen no longer has useFocusEffect calling markNotificationsAsRead
3. Notification items show bold sender name followed by action text
4. Unread notifications show a small purple dot
5. Tapping a notification item navigates and marks as read (optimistic UI update)
   </verify>
   <done>Notification list shows bold usernames, unread purple dot indicator, items are tappable with navigation. Bulk mark-as-read on focus removed.</done>
   </task>

<task type="auto">
  <name>Task 2: Add markSingleNotificationAsRead service function</name>
  <files>src/services/firebase/notificationService.js</files>
  <action>
Add a new exported function `markSingleNotificationAsRead` to notificationService.js:

```javascript
/**
 * Mark a single notification as read
 * @param {string} notificationId - The notification document ID
 * @returns {Promise<{success: boolean, error?: string}>}
 */
export const markSingleNotificationAsRead = async notificationId => {
  try {
    if (!notificationId) {
      return { success: false, error: 'Invalid notification ID' };
    }

    const notifRef = doc(db, 'notifications', notificationId);
    await updateDoc(notifRef, { read: true });

    logger.debug('markSingleNotificationAsRead: Notification marked as read', {
      notificationId,
    });

    return { success: true };
  } catch (error) {
    logger.error('markSingleNotificationAsRead: Failed', {
      notificationId,
      error: error.message,
    });
    return { success: false, error: error.message };
  }
};
```

This is a simple single-doc update — no batch needed. The existing `markNotificationsAsRead` (bulk) function stays in case it's needed elsewhere, but ActivityScreen will now use `markSingleNotificationAsRead` for per-tap marking.

Do NOT remove the existing `markNotificationsAsRead` function — it may be used by other screens (NotificationsScreen).
</action>
<verify>

1. `npm run lint` passes
2. Function `markSingleNotificationAsRead` exported from notificationService.js
3. Function takes notificationId, updates single doc to read: true
4. Existing markNotificationsAsRead function unchanged
   </verify>
   <done>markSingleNotificationAsRead service function created. Updates single notification document to read: true. Follows existing service patterns ({success, error} return). Existing bulk function preserved.</done>
   </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Polished notification list with bold usernames, unread indicators, per-tap read marking, and tappable items</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. Open app on device, navigate to Notifications (heart icon in feed header)
    3. Check notification items: Verify sender names are bold, followed by action text
    4. Check unread state: Verify unread notifications show a small purple dot on the left
    5. Tap a notification: Verify it navigates to the correct content (feed photo, story, profile)
    6. Return to notifications: Verify the tapped notification no longer shows the unread dot
    7. Verify that just viewing the screen does NOT mark all notifications as read
    8. Check the heart icon in feed header: Verify dot still shows when unread notifications exist
    9. Verify the dot disappears from heart icon only after all notifications are individually tapped
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run lint` passes
- [ ] Notification items show bold username + action text
- [ ] Unread dot visible on unread items
- [ ] Tapping notification navigates to correct screen
- [ ] Tapping notification marks it as read (optimistic + Firestore)
- [ ] Bulk mark-on-focus removed from ActivityScreen
- [ ] FeedScreen unread badge dot still works (real-time listener unchanged)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No lint errors introduced
- Notifications show bold usernames with action text
- Unread purple dot indicator visible on unread items
- Per-tap mark-as-read works (tap → read in Firestore + UI update)
- Screen view no longer marks all as read
- FeedScreen heart icon badge dot continues working
- Phase 38 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/38-notification-ui-polish/38-02-SUMMARY.md`
</output>
