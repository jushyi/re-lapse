---
phase: 38-notification-ui-polish
plan: 01
type: execute
---

<objective>
Create a custom in-app notification banner that replaces the default system-style expo-notifications foreground display with a dark-themed banner matching the app aesthetic.

Purpose: Foreground notifications currently show as generic iOS system banners. This plan creates a custom dark-themed banner that slides down from the top, shows the sender avatar and message, auto-dismisses, and navigates on tap — providing a cohesive in-app experience.
Output: InAppNotificationBanner component integrated into App.js, system foreground notifications suppressed.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/38-notification-ui-polish/38-CONTEXT.md

# Key source files:

@App.js
@src/services/firebase/notificationService.js
@src/constants/colors.js
@src/components/index.js

# Prior phase context:

@.planning/phases/34-push-infrastructure/34-01-SUMMARY.md
@.planning/phases/37-darkroom-notifications/37-01-SUMMARY.md

**Tech stack available:** expo-notifications, React Native Animated API, expo-server-sdk
**Established patterns:** Push enable banner pattern, color constants system, component/styles split
**Constraining decisions:**

- Phase 16: All colors must use constants from colors.js (no hardcoded hex)
- Phase 34: expo-notifications handles foreground via setNotificationHandler
- Phase 37: handleNotificationReceived currently just logs (comment says "Could add custom in-app banner here")
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create InAppNotificationBanner component</name>
  <files>src/components/InAppNotificationBanner.js, src/styles/InAppNotificationBanner.styles.js, src/components/index.js</files>
  <action>
Create a reusable in-app notification banner component:

**InAppNotificationBanner.js:**

- Accepts props: `visible` (boolean), `title` (string), `body` (string), `avatarUrl` (string|null), `onPress` (function), `onDismiss` (function)
- Uses React Native `Animated` API to slide down from top (translateY from -120 to 0) with spring animation (useNativeDriver: true)
- Auto-dismisses after 4 seconds via setTimeout (clear on unmount/new notification)
- Swipe-up to dismiss: use PanResponder — if dy < -30, trigger dismiss animation (translateY back to -120) and call onDismiss
- Tap triggers onPress then onDismiss
- Layout: horizontal row inside SafeAreaView inset — [avatar 36x36 circular | title bold + body text | chevron-forward icon]
- If no avatarUrl, show Ionicons "notifications" icon in a circular placeholder (colors.background.tertiary)
- Title: fontSize 14, fontWeight '600', colors.text.primary, numberOfLines={1}
- Body: fontSize 13, colors.text.secondary, numberOfLines={1}
- Container: colors.background.secondary background, borderRadius 12, marginHorizontal 12, paddingHorizontal 12, paddingVertical 10, shadow (shadowColor black, shadowOffset {0, 4}, shadowOpacity 0.3, shadowRadius 8, elevation 8)
- Position: absolute, top 0, left 0, right 0, zIndex 9999
- Wrap in SafeAreaView with edges={['top']} so banner sits below the status bar/notch
- When visible transitions from false→true, reset animation value to -120 and animate to 0. When dismissing, animate to -120 then call onDismiss

**InAppNotificationBanner.styles.js:**

- Extract all StyleSheet styles. Use colors constants exclusively (no hardcoded values).

**index.js:**

- Add InAppNotificationBanner to barrel exports

Do NOT use react-native-reanimated for this — stick with React Native's built-in Animated API to keep it simple. Do NOT use react-native-gesture-handler — use PanResponder from react-native.
</action>
<verify>
Component file exists at src/components/InAppNotificationBanner.js with Animated slide animation, PanResponder swipe-up dismiss, auto-dismiss timer, and proper dark styling using color constants. Styles file exists. Export added to index.js.
</verify>
<done>InAppNotificationBanner component created with slide-down animation, 4s auto-dismiss, swipe-up dismiss, tap handler, dark theme styling using color constants, and barrel export.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate banner into App.js and suppress system foreground notifications</name>
  <files>App.js, src/services/firebase/notificationService.js</files>
  <action>
**notificationService.js changes:**

1. Change `setNotificationHandler` to suppress foreground display:

```javascript
Notifications.setNotificationHandler({
  handleNotification: async () => ({
    shouldShowAlert: false, // Changed: suppress system banner
    shouldPlaySound: true, // Keep sound
    shouldSetBadge: true, // Keep badge
  }),
});
```

2. Update `handleNotificationReceived` to return structured banner data instead of just logging:

```javascript
export const handleNotificationReceived = notification => {
  try {
    const { title, body, data } = notification.request.content;
    const { senderProfilePhotoURL, senderName, type } = data || {};

    logger.debug('Notification received in foreground', { title, body, type });

    return {
      success: true,
      data: {
        title: title || senderName || 'New notification',
        body: body || '',
        avatarUrl: senderProfilePhotoURL || null,
        notificationType: type,
        notificationData: data || {},
      },
    };
  } catch (error) {
    logger.error('Error handling notification received', error);
    return { success: false, error: error.message };
  }
};
```

**App.js changes:**

1. Import InAppNotificationBanner from components
2. Add state for banner: `const [bannerData, setBannerData] = useState(null);`
3. Update the foreground notification listener to use banner:

```javascript
notificationListener.current = Notifications.addNotificationReceivedListener(notification => {
  const result = handleNotificationReceived(notification);
  if (result.success) {
    setBannerData(result.data);
  }
});
```

4. Add handleBannerPress function that uses existing handleNotificationTapped logic to navigate:

```javascript
const handleBannerPress = () => {
  if (!bannerData?.notificationData) return;
  // Build a minimal notification object for handleNotificationTapped
  const fakeNotification = {
    request: { content: { data: bannerData.notificationData } },
  };
  const navigationData = handleNotificationTapped(fakeNotification);
  if (navigationData.success && navigationRef.current?.isReady()) {
    // Same navigation logic as the tap listener
    const { screen, params } = navigationData.data;
    // ... reuse existing navigation switch from responseListener
  }
  setBannerData(null);
};
```

5. Extract the navigation-from-notification logic into a shared helper function (used by both tap listener and banner press) to avoid duplication. Define it inside the App component:

```javascript
const navigateToNotification = navData => {
  if (!navData.success || !navigationRef.current?.isReady()) return;
  const { screen, params } = navData.data;
  // ... existing switch logic for Camera, Feed, Profile, FriendRequests
};
```

Then use it in both the responseListener and handleBannerPress.

6. Render InAppNotificationBanner inside the View wrapper, above SafeAreaProvider:

```jsx
<View style={{ flex: 1, backgroundColor: colors.background.primary }}>
  <InAppNotificationBanner
    visible={!!bannerData}
    title={bannerData?.title || ''}
    body={bannerData?.body || ''}
    avatarUrl={bannerData?.avatarUrl}
    onPress={handleBannerPress}
    onDismiss={() => setBannerData(null)}
  />
  <SafeAreaProvider>...</SafeAreaProvider>
</View>
```

Do NOT remove any existing notification tap handling logic. The responseListener for background/killed-app taps stays unchanged. The banner is ONLY for foreground notifications.
</action>
<verify>

1. `npm run lint` passes without errors
2. In notificationService.js: shouldShowAlert is false in setNotificationHandler
3. In App.js: InAppNotificationBanner is rendered, bannerData state exists, foreground listener calls setBannerData
4. Navigation helper function is shared between tap listener and banner press (no duplicated switch statements)
   </verify>
   <done>System foreground notifications suppressed (shouldShowAlert: false). Custom InAppNotificationBanner renders in App.js. Foreground notifications show dark-themed banner. Banner tap navigates using shared navigation helper. Background/killed-app tap handling unchanged.</done>
   </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Custom in-app notification banner replacing system foreground notification display</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. Open app on device, ensure you're logged in
    3. Send a test push notification (use Expo push tool at https://expo.dev/notifications or trigger from another device)
    4. While app is in foreground: Verify custom dark banner slides down from top (NOT the system-style notification)
    5. Check banner shows: avatar (or icon placeholder), title text, body text
    6. Wait 4 seconds: Verify banner auto-dismisses with slide-up animation
    7. Trigger another notification: Verify tapping the banner navigates to the correct screen
    8. Trigger another notification: Verify swiping up on the banner dismisses it immediately
    9. Background the app, send notification: Verify system notification still appears normally (not affected by changes)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run lint` passes
- [ ] InAppNotificationBanner component exists with animation, auto-dismiss, swipe-up
- [ ] System foreground notification suppressed (shouldShowAlert: false)
- [ ] Banner renders in App.js with proper state management
- [ ] Navigation from banner tap works (shared helper, no duplication)
- [ ] Background/killed-app notification tap handling unchanged
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No lint errors introduced
- Foreground notifications show custom dark banner instead of system notification
- Banner auto-dismisses after 4s, can be swiped up, navigates on tap
- Background notifications unaffected
  </success_criteria>

<output>
After completion, create `.planning/phases/38-notification-ui-polish/38-01-SUMMARY.md`
</output>
