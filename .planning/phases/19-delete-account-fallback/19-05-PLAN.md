---
phase: 19-delete-account-fallback
plan: 05
type: execute
---

<objective>
Add deletion reminder notification (3 days before) and handle orphaned data display ("Deleted User" for comments/reactions from deleted accounts).

Purpose: Remind users before final deletion and gracefully handle references to deleted users.
Output: Reminder notification Cloud Function and "Deleted User" fallback display in comments/reactions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-delete-account-fallback/19-CONTEXT.md
@functions/index.js
@src/components/comments/CommentItem.js
@src/components/FeedPhotoCard.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deletion reminder notification Cloud Function</name>
  <files>functions/index.js</files>
  <action>
Add scheduled Cloud Function to send reminder notifications 3 days before deletion:

```javascript
/**
 * Cloud Function: Send reminder notification 3 days before account deletion
 * Runs daily at 9 AM UTC to check for accounts approaching deletion
 */
exports.sendDeletionReminderNotification = functions.pubsub
  .schedule('0 9 * * *') // Daily at 9 AM UTC
  .onRun(async context => {
    try {
      const now = admin.firestore.Timestamp.now();

      // Calculate 3 days from now window (check accounts deleting in ~3 days)
      const threeDaysFromNow = admin.firestore.Timestamp.fromMillis(
        now.toMillis() + 3 * 24 * 60 * 60 * 1000
      );
      const threeDaysFromNowEnd = admin.firestore.Timestamp.fromMillis(
        now.toMillis() + 4 * 24 * 60 * 60 * 1000
      );

      // Query users scheduled for deletion in ~3 days
      // (between 3 and 4 days from now to avoid duplicate notifications)
      const usersSnapshot = await admin
        .firestore()
        .collection('users')
        .where('scheduledForDeletionAt', '>=', threeDaysFromNow)
        .where('scheduledForDeletionAt', '<', threeDaysFromNowEnd)
        .get();

      if (usersSnapshot.empty) {
        logger.info('sendDeletionReminderNotification: No users approaching deletion');
        return null;
      }

      logger.info('sendDeletionReminderNotification: Found users', {
        count: usersSnapshot.size,
      });

      let sentCount = 0;
      for (const userDoc of usersSnapshot.docs) {
        const userData = userDoc.data();
        const fcmToken = userData.fcmToken;

        if (!fcmToken) {
          logger.debug('sendDeletionReminderNotification: No FCM token', {
            userId: userDoc.id,
          });
          continue;
        }

        // Send reminder notification
        const title = '⚠️ Account Deletion Reminder';
        const body =
          "Your account will be permanently deleted in 3 days. Log in to cancel if you've changed your mind.";

        await sendPushNotification(fcmToken, title, body, {
          type: 'deletion_reminder',
        });

        sentCount++;
      }

      logger.info('sendDeletionReminderNotification: Complete', {
        found: usersSnapshot.size,
        sent: sentCount,
      });

      return { found: usersSnapshot.size, sent: sentCount };
    } catch (error) {
      logger.error('sendDeletionReminderNotification: Error', { error: error.message });
      return null;
    }
  });
```

IMPORTANT: This function requires a composite index on users collection:

- Field: scheduledForDeletionAt (ascending)
- Add to firestore.indexes.json if needed
  </action>
  <verify>firebase deploy --only functions succeeds, function appears in console</verify>
  <done>sendDeletionReminderNotification Cloud Function deployed, runs daily at 9 AM UTC</done>
  </task>

<task type="auto">
  <name>Task 2: Handle "Deleted User" display for orphaned comments and reactions</name>
  <files>src/components/comments/CommentItem.js, src/hooks/useComments.js, src/components/FeedPhotoCard.js</files>
  <action>
Update components to gracefully handle deleted users:

**CommentItem.js:**
Update to handle missing user data:

```javascript
// In the component, check if user data is available
const displayName = comment.userName || 'Deleted User';
const profilePhotoURL = comment.userProfilePhotoURL || null;

// For the avatar, show default placeholder if no photo
// The ProfileIcon component should already handle null photoURL

// For the username tap handler, check if userId exists and user is valid
const handleUsernameTap = () => {
  if (comment.userId && comment.userName !== 'Deleted User') {
    // Navigate to profile
    onNavigateToProfile?.(comment.userId);
  }
  // If deleted user, do nothing on tap
};
```

**useComments.js:**
When fetching comments, handle cases where commenter no longer exists:

```javascript
// In fetchComments or comment processing:
// If user lookup fails (user deleted), use fallback values:
const commenterData = userDoc.exists()
  ? userDoc.data()
  : {
      displayName: 'Deleted User',
      username: 'deleted',
      profilePhotoURL: null,
    };
```

Note: The current implementation stores userName and userProfilePhotoURL in comment documents at creation time, so most comments will have data. The fallback is for edge cases where comment was created before this data was denormalized.

**FeedPhotoCard.js (reactions display):**
Reactions are stored as `{ [userId]: { emoji: count } }` structure. The user info isn't displayed directly in reaction pills (just emoji + count), so no changes needed for reaction display.

However, if there's a reaction details view showing who reacted:

- Check if user exists when fetching reactor info
- Use "Deleted User" as fallback name
- Use null as fallback photo (shows default avatar)

**Key principle:** Never crash or show errors for deleted user references. Always fall back to "Deleted User" display with default avatar.
</action>
<verify>Comments from deleted users show "Deleted User" name, no crashes on missing data</verify>
<done>Components gracefully handle deleted users with "Deleted User" fallback display</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] sendDeletionReminderNotification Cloud Function deployed
- [ ] Function queries correct date range (3-4 days from now)
- [ ] CommentItem handles missing user data gracefully
- [ ] No crashes when user document doesn't exist
- [ ] "Deleted User" shown as fallback name
</verification>

<success_criteria>

- All tasks completed
- Reminder notifications sent 3 days before deletion
- Comments/reactions display gracefully for deleted users
- No UI crashes from orphaned data references
- Phase 19 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/19-delete-account-fallback/19-05-SUMMARY.md`

Include in summary:

- Reminder notification schedule
- Components updated for deleted user handling
- Any index additions needed

Mark Phase 19 complete in summary.
</output>
