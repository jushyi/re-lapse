---
phase: 19-delete-account-fallback
plan: 02
type: execute
---

<objective>
Implement the download all photos feature using expo-media-library, allowing users to save all their photos to camera roll before account deletion.

Purpose: Users shouldn't lose their memories when leaving the app - give them a one-tap export option.
Output: Working downloadPhotosService and DownloadProgress component.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-delete-account-fallback/19-CONTEXT.md
@src/services/firebase/photoService.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install expo-media-library and create download service</name>
  <files>src/services/downloadPhotosService.js, package.json</files>
  <action>
1. Install expo-media-library:
   ```
   npx expo install expo-media-library
   ```

2. Create `src/services/downloadPhotosService.js`:

```javascript
/**
 * Download Photos Service
 *
 * Downloads all user photos to device camera roll.
 * Used before account deletion to preserve memories.
 */

import * as MediaLibrary from 'expo-media-library';
import * as FileSystem from 'expo-file-system';
import { getUserPhotos } from './firebase/photoService';
import logger from '../utils/logger';

/**
 * Request media library permissions
 * @returns {Promise<boolean>} - Whether permission was granted
 */
export const requestMediaLibraryPermission = async () => {
  const { status } = await MediaLibrary.requestPermissionsAsync();
  return status === 'granted';
};

/**
 * Download all user photos to camera roll
 * @param {string} userId - User ID
 * @param {function} onProgress - Callback with { current, total, photoId }
 * @returns {Promise<{ success: boolean, downloaded: number, failed: number, error?: string }>}
 */
export const downloadAllPhotos = async (userId, onProgress) => {
  // Implementation:
  // 1. Request permission (return early if denied)
  // 2. Get all user photos via getUserPhotos
  // 3. Create album "Rewind Export" (or use existing)
  // 4. For each photo:
  //    a. Download from imageURL to FileSystem.cacheDirectory
  //    b. Save to MediaLibrary via createAssetAsync
  //    c. Add to album
  //    d. Delete cache file
  //    e. Call onProgress({ current, total, photoId })
  // 5. Return { success: true, downloaded: N, failed: M }
  // Handle errors per-photo (log and continue), not fatal
  // Album name: "Rewind Export"
};
```

Key implementation details:

- Use FileSystem.downloadAsync to fetch each photo URL to cache
- Use MediaLibrary.createAssetAsync to save to camera roll
- Use MediaLibrary.createAlbumAsync / addAssetsToAlbumAsync for organization
- Progress callback enables UI updates
- Continue on individual photo failures (log and count)
  </action>
  <verify>npm run lint passes, service imports correctly</verify>
  <done>expo-media-library installed, downloadPhotosService exports requestMediaLibraryPermission and downloadAllPhotos</done>
  </task>

<task type="auto">
  <name>Task 2: Create DownloadProgress component</name>
  <files>src/components/DownloadProgress.js</files>
  <action>
Create a reusable progress component for photo downloads:

```javascript
/**
 * DownloadProgress
 *
 * Shows download progress with animated bar and count.
 * Used during "Download All Photos" before account deletion.
 */

import React from 'react';
import { View, Text, StyleSheet, Animated } from 'react-native';
import { colors } from '../constants/colors';

const DownloadProgress = ({ current, total, status }) => {
  // Props:
  // - current: number of photos downloaded
  // - total: total photos to download
  // - status: 'preparing' | 'downloading' | 'complete' | 'error'
  // UI:
  // - Progress bar (animated width based on current/total)
  // - Text: "Downloading X of Y photos..." or status message
  // - Use colors.brand.primary for progress bar fill
  // - Use colors.background.secondary for track
  // Status messages:
  // - preparing: "Preparing download..."
  // - downloading: "Downloading {current} of {total} photos..."
  // - complete: "Download complete! {total} photos saved."
  // - error: "Download failed. Some photos may not have been saved."
};
```

Style specs:

- Progress bar height: 8px, rounded corners (4px)
- Container padding: 16px
- Text below bar, centered, colors.text.secondary
- Animate progress bar width with Animated.timing (200ms)
  </action>
  <verify>Component renders without errors, progress animates smoothly</verify>
  <done>DownloadProgress component created with animated progress bar and status messages</done>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] expo-media-library is in package.json dependencies
- [ ] downloadPhotosService.js exports both functions
- [ ] DownloadProgress.js renders with mock props
- [ ] Manual test: Call downloadAllPhotos with a test user, verify photos appear in camera roll
</verification>

<success_criteria>

- All tasks completed
- Photos can be downloaded to camera roll
- Progress component shows accurate download state
- Album "Rewind Export" created with downloaded photos
  </success_criteria>

<output>
After completion, create `.planning/phases/19-delete-account-fallback/19-02-SUMMARY.md`
</output>
