---
phase: 19-delete-account-fallback
plan: 04
type: execute
---

<objective>
Implement grace period recovery - detect pending deletion on login and show recovery prompt allowing user to cancel or proceed with deletion.

Purpose: Give users who change their mind an easy way to recover their account during the 30-day grace period.
Output: Auth flow detects pending deletion and shows recovery modal with cancel/proceed options.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-delete-account-fallback/19-CONTEXT.md
@src/context/AuthContext.js
@src/services/firebase/accountService.js
@src/navigation/AppNavigator.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deletion status detection to AuthContext</name>
  <files>src/context/AuthContext.js</files>
  <action>
Update AuthContext to detect and expose pending deletion status:

**New state:**

```javascript
const [pendingDeletion, setPendingDeletion] = useState(null);
// { isScheduled: boolean, scheduledDate: Date } or null
```

**Update auth state listener (in useEffect):**
After fetching user profile successfully, check for pending deletion:

```javascript
// After: setUserProfile(profileResult.data);
// Add:
if (profileResult.data?.scheduledForDeletionAt) {
  const scheduledDate = profileResult.data.scheduledForDeletionAt.toDate
    ? profileResult.data.scheduledForDeletionAt.toDate()
    : new Date(profileResult.data.scheduledForDeletionAt);

  setPendingDeletion({
    isScheduled: true,
    scheduledDate: scheduledDate,
  });
  logger.info('AuthContext: User has pending deletion', {
    scheduledDate: scheduledDate.toISOString(),
  });
} else {
  setPendingDeletion(null);
}
```

**Add cancelDeletion method:**

```javascript
const cancelDeletion = async () => {
  try {
    const result = await cancelAccountDeletion();
    if (result.success) {
      setPendingDeletion(null);
      // Refresh user profile to clear the field
      const refreshedProfile = await getUserDocumentNative(user.uid);
      if (refreshedProfile.success) {
        setUserProfile(refreshedProfile.data);
      }
      logger.info('AuthContext: Deletion canceled');
      return { success: true };
    }
    return result;
  } catch (error) {
    logger.error('AuthContext: Failed to cancel deletion', { error: error.message });
    return { success: false, error: error.message };
  }
};
```

**Update context value:**
Add to value object: pendingDeletion, cancelDeletion

**Import:**
Add: cancelAccountDeletion from accountService
</action>
<verify>AuthContext exposes pendingDeletion state and cancelDeletion method</verify>
<done>AuthContext detects pending deletion on login, exposes pendingDeletion and cancelDeletion</done>
</task>

<task type="auto">
  <name>Task 2: Create DeletionRecoveryModal and integrate with AppNavigator</name>
  <files>src/components/DeletionRecoveryModal.js, src/navigation/AppNavigator.js</files>
  <action>
**Create DeletionRecoveryModal component:**

```javascript
/**
 * DeletionRecoveryModal
 *
 * Shown when user logs in with a pending account deletion.
 * Offers choice to cancel deletion or proceed (sign out).
 */

import React, { useState } from 'react';
import { Modal, View, Text, StyleSheet, TouchableOpacity, ActivityIndicator } from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { colors } from '../constants/colors';
import { format } from 'date-fns';

const DeletionRecoveryModal = ({ visible, scheduledDate, onCancel, onProceed }) => {
  const [loading, setLoading] = useState(false);

  const handleCancel = async () => {
    setLoading(true);
    await onCancel();
    setLoading(false);
  };

  const handleProceed = () => {
    onProceed();
  };

  const formattedDate = scheduledDate ? format(scheduledDate, 'MMMM d, yyyy') : 'Unknown';

  // UI Layout:
  // - Modal centered, dark semi-transparent backdrop
  // - White/card background (colors.background.secondary)
  // - Warning icon at top (colors.status.warning - yellow/orange)
  // - Title: "Account Scheduled for Deletion"
  // - Body: "Your account is scheduled to be permanently deleted on {date}."
  // - Question: "Would you like to cancel the deletion and keep your account?"
  // - Two buttons:
  //   1. "Keep My Account" (primary, colors.brand.primary) - calls onCancel
  //   2. "Continue with Deletion" (text only, colors.text.secondary) - calls onProceed
  // - Loading state on Keep My Account button when processing
};
```

**Style specs:**

- Modal width: 90% of screen, max 400px
- Border radius: 16px
- Padding: 24px
- Buttons stacked vertically, 16px gap
- "Keep My Account" button: solid background, white text
- "Continue with Deletion": text button, smaller font

**Integrate with AppNavigator:**

In AppNavigator.js, after the main navigator content:

```javascript
import { useAuth } from '../context/AuthContext';
import DeletionRecoveryModal from '../components/DeletionRecoveryModal';

// Inside AppNavigator component:
const { pendingDeletion, cancelDeletion, signOut } = useAuth();

const handleCancelDeletion = async () => {
  const result = await cancelDeletion();
  if (!result.success) {
    Alert.alert('Error', 'Failed to cancel deletion. Please try again.');
  }
  // Modal auto-hides when pendingDeletion becomes null
};

const handleProceedWithDeletion = () => {
  signOut();
  // User is signed out, returns to login screen
};

// After NavigationContainer, before closing fragment:
<DeletionRecoveryModal
  visible={!!pendingDeletion?.isScheduled}
  scheduledDate={pendingDeletion?.scheduledDate}
  onCancel={handleCancelDeletion}
  onProceed={handleProceedWithDeletion}
/>;
```

  </action>
  <verify>Modal appears when user with pending deletion logs in, cancel/proceed buttons work</verify>
  <done>DeletionRecoveryModal created, integrated with AppNavigator, shows on login with pending deletion</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Grace period recovery flow - detection and modal prompt</what-built>
  <how-to-verify>
    1. First, schedule deletion for a test account (Settings → Delete Account → complete flow)
    2. Verify user is signed out
    3. Log back in with the same phone number
    4. Verify: DeletionRecoveryModal appears showing scheduled date
    5. Test: Tap "Keep My Account" - modal should close, user stays logged in
    6. Verify: scheduledForDeletionAt is cleared in Firebase Console
    7. Schedule deletion again, log back in
    8. Test: Tap "Continue with Deletion" - user should be signed out
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] AuthContext detects scheduledForDeletionAt on login
- [ ] pendingDeletion state exposed from useAuth
- [ ] DeletionRecoveryModal renders when pendingDeletion is set
- [ ] "Keep My Account" cancels deletion and clears modal
- [ ] "Continue with Deletion" signs out user
</verification>

<success_criteria>

- All tasks completed
- Recovery modal appears for users with pending deletion
- Cancel flow clears deletion schedule
- Proceed flow signs out user
- Clear UX with scheduled date shown
  </success_criteria>

<output>
After completion, create `.planning/phases/19-delete-account-fallback/19-04-SUMMARY.md`
</output>
