---
phase: 19-delete-account-fallback
plan: 01
type: execute
---

<objective>
Build the scheduled deletion infrastructure - user schema updates and service methods for scheduling/canceling deletion, plus Cloud Function for processing scheduled deletions.

Purpose: Enable 30-day grace period deletion instead of immediate deletion, allowing users to recover their account.
Output: Working schedule/cancel deletion flow with server-side scheduled deletion processing.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-delete-account-fallback/19-CONTEXT.md
@src/services/firebase/accountService.js
@functions/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update user schema and accountService methods</name>
  <files>src/services/firebase/accountService.js</files>
  <action>
Add new Cloud Function callable methods to accountService.js:

1. `scheduleAccountDeletion()` - Calls new Cloud Function that:
   - Sets `scheduledForDeletionAt` to 30 days from now
   - Sets `deletionScheduledAt` to current timestamp
   - Returns { success: true, scheduledDate }

2. `cancelAccountDeletion()` - Calls new Cloud Function that:
   - Clears `scheduledForDeletionAt` (set to null)
   - Clears `deletionScheduledAt` (set to null)
   - Returns { success: true }

3. `checkDeletionStatus()` - Reads user doc directly to check if deletion is scheduled:
   - Returns { isScheduled: boolean, scheduledDate: Date | null }

Keep existing `deleteUserAccount()` for now (will be called by scheduled function).

Error handling: Map common Firebase error codes to user-friendly messages. On network error, return { success: false, error: 'Network error...' }.
</action>
<verify>TypeScript/ESLint passes, functions are exported correctly</verify>
<done>Three new methods exported: scheduleAccountDeletion, cancelAccountDeletion, checkDeletionStatus</done>
</task>

<task type="auto">
  <name>Task 2: Create Cloud Functions for scheduled deletion</name>
  <files>functions/index.js</files>
  <action>
Add three new Cloud Functions:

1. `scheduleUserAccountDeletion` (onCall):
   - Require authentication
   - Get userId from request.auth.uid
   - Calculate scheduledForDeletionAt = 30 days from now
   - Update user document with scheduledForDeletionAt and deletionScheduledAt
   - Log action: "User scheduled account for deletion"
   - Return { success: true, scheduledDate }

2. `cancelUserAccountDeletion` (onCall):
   - Require authentication
   - Get userId from request.auth.uid
   - Set scheduledForDeletionAt and deletionScheduledAt to null
   - Log action: "User canceled scheduled deletion"
   - Return { success: true }

3. `processScheduledDeletions` (pubsub.schedule):
   - Run daily at 3 AM UTC: `schedule('0 3 * * *')`
   - Query users where scheduledForDeletionAt <= now
   - For each user found:
     a. Call existing deletion logic (storage, photos, friendships, darkroom, user doc, auth)
     b. Log: "Account permanently deleted: {userId}"
   - Handle errors gracefully - if one user fails, continue to others
   - Return { processed: N, deleted: N, failed: N }

IMPORTANT: The existing `deleteUserAccount` function should remain unchanged - it handles the actual deletion cascade. The new scheduled function queries for users to delete and calls the same deletion logic.
</action>
<verify>firebase deploy --only functions succeeds, functions appear in Firebase console</verify>
<done>Three Cloud Functions deployed: scheduleUserAccountDeletion, cancelUserAccountDeletion, processScheduledDeletions (scheduled daily)</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] accountService exports scheduleAccountDeletion, cancelAccountDeletion, checkDeletionStatus
- [ ] Cloud Functions deploy without errors
- [ ] Manual test: Call scheduleAccountDeletion, verify user doc has scheduledForDeletionAt field
- [ ] Manual test: Call cancelAccountDeletion, verify field is cleared
</verification>

<success_criteria>

- All tasks completed
- User documents can have deletion scheduled/canceled
- Scheduled deletion Cloud Function runs daily
- No errors in Firebase Functions logs
  </success_criteria>

<output>
After completion, create `.planning/phases/19-delete-account-fallback/19-01-SUMMARY.md`
</output>
