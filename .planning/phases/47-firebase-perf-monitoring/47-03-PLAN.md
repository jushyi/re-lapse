---
phase: 47-firebase-perf-monitoring
plan: 03
type: execute
---

<objective>
Add screen load timing traces to key screens and verify the complete Phase 47 integration builds successfully.

Purpose: Measure time-to-interactive for the 6 most important screens, then verify the entire Firebase Performance Monitoring integration compiles and is correctly structured. This completes the instrumentation layer.
Output: 6 screens instrumented with useScreenTrace, build verified, Phase 47 complete.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/47-firebase-perf-monitoring/47-RESEARCH.md
@.planning/phases/47-firebase-perf-monitoring/47-01-SUMMARY.md
@.planning/phases/47-firebase-perf-monitoring/47-02-SUMMARY.md

# Key files (from 47-01):

@src/hooks/useScreenTrace.js

# Screen files to instrument:

@src/screens/FeedScreen.js
@src/screens/ProfileScreen.js
@src/screens/StoriesViewerModal.js
@src/screens/DarkroomScreen.js
@src/screens/NotificationsScreen.js
@src/screens/FriendsScreen.js

**Established patterns:** useScreenTrace(screenName) returns { markLoaded }, call markLoaded(metrics) when data is ready
**Constraining decisions:**

- [RESEARCH]: Use custom code traces (screen/X), NOT startScreenTrace() (iOS crashes)
- [RESEARCH]: Call markLoaded after initial data load, not on every re-render
- [RESEARCH]: Pass relevant metrics to markLoaded (e.g., { photo_count: photos.length })
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Add screen load traces to 6 key screens</name>
  <files>src/screens/FeedScreen.js, src/screens/ProfileScreen.js, src/screens/StoriesViewerModal.js, src/screens/DarkroomScreen.js, src/screens/NotificationsScreen.js, src/screens/FriendsScreen.js</files>
  <action>
Import `{ useScreenTrace }` from `'../hooks/useScreenTrace'` in each screen, then add the hook and call markLoaded when initial data finishes loading.

**FeedScreen.js** — `screen/FeedScreen`:

- Add `const { markLoaded } = useScreenTrace('FeedScreen');` near the top of the component
- Call `markLoaded({ photo_count: photos.length })` after the initial feed data loads (inside the effect or callback that sets feed photos for the first time)
- Only call markLoaded ONCE — guard with a ref or ensure it's in the initial load path only

**ProfileScreen.js** — `screen/ProfileScreen`:

- Add `const { markLoaded } = useScreenTrace('ProfileScreen');`
- Call `markLoaded()` after profile data loads

**StoriesViewerModal.js** — `screen/StoriesViewer`:

- Add `const { markLoaded } = useScreenTrace('StoriesViewer');`
- Call `markLoaded({ story_count: stories.length })` after stories data is ready for display

**DarkroomScreen.js** — `screen/DarkroomScreen`:

- Add `const { markLoaded } = useScreenTrace('DarkroomScreen');`
- Call `markLoaded()` after darkroom photos load

**NotificationsScreen.js** — `screen/NotificationsScreen`:

- Add `const { markLoaded } = useScreenTrace('NotificationsScreen');`
- Call `markLoaded({ notif_count: notifications.length })` after notification feed loads

**FriendsScreen.js** — `screen/FriendsScreen`:

- Add `const { markLoaded } = useScreenTrace('FriendsScreen');`
- Call `markLoaded({ friend_count: friends.length })` after friends list loads

**Key rules:**

- Call markLoaded only ONCE per screen mount (the hook internally stops the trace on first call, subsequent calls are no-ops)
- Place markLoaded call right after setState for the initial data load, not in a render path
- If the screen uses real-time listeners, call markLoaded after the FIRST snapshot, not on every update
- Look at each screen's actual data loading pattern (useEffect, callbacks, etc.) to find the right insertion point
  </action>
  <verify>
- `grep -rn "useScreenTrace" src/screens/` shows 6 screen files using the hook
- Each screen passes a unique screen name string
- markLoaded is called in data-loading callbacks, not in render paths
  </verify>
  <done>6 screens instrumented with useScreenTrace: FeedScreen, ProfileScreen, StoriesViewer, DarkroomScreen, NotificationsScreen, FriendsScreen</done>
  </task>

<task type="auto">
  <name>Task 2: Build verification and trace inventory audit</name>
  <files>(none created — verification only)</files>
  <action>
1. Run `npx expo export --platform ios` to verify the full app builds without errors
2. Audit all traces added across plans 01-03:
   - Count total withTrace calls across service files: `grep -rn "withTrace(" src/services/firebase/`
   - Count total useScreenTrace calls across screens: `grep -rn "useScreenTrace(" src/screens/`
   - Verify all trace names follow feature-area convention
   - Estimate event budget: total unique trace types × ~2 invocations per 10 min should be well under 300
3. Verify no traces in hot paths by checking that withTrace/useScreenTrace do NOT appear in:
   - renderItem callbacks
   - scroll handlers
   - animation callbacks
   - Components rendered in FlatList items

If build fails: fix the error (likely import path or syntax issue), re-run build until it passes.
</action>
<verify>

- `npx expo export --platform ios` exits with code 0
- grep confirms ~18 service traces + 6 screen traces = ~24 total
- No traces in render paths or FlatList items
  </verify>
  <done>iOS build passes, ~24 traces confirmed across service files and screens, no hot-path traces, estimated ~48 events/10min (well within 300 limit)</done>
  </task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx expo export --platform ios` succeeds without errors
- [ ] 6 screens have useScreenTrace with markLoaded calls
- [ ] ~18 service traces + 6 screen traces = ~24 total custom traces
- [ ] All trace names follow feature-area convention
- [ ] No traces in hot paths (scroll handlers, renderItem, animations)
- [ ] Estimated event budget well within 300/10min limit
- [ ] performanceService.js disables collection in __DEV__
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- iOS build succeeds
- Phase 47 complete — Firebase Performance Monitoring fully integrated
- ~24 custom traces covering auth, feed, camera, photo, stories, profile, social, notifications, and screen loading
- Automatic HTTP monitoring enabled via firebase.json config
  </success_criteria>

<output>
After completion, create `.planning/phases/47-firebase-perf-monitoring/47-03-SUMMARY.md`:

# Phase 47 Plan 03: Screen Traces & Build Verification Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- [File list]

## Decisions Made

[Key decisions]

## Issues Encountered

[Problems and resolutions]

## Next Step

Phase 47 complete, ready for Phase 48: UI/UX Consistency Audit
</output>
