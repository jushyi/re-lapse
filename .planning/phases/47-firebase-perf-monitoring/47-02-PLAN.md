---
phase: 47-firebase-perf-monitoring
plan: 02
type: execute
---

<objective>
Instrument all Firebase service files with custom performance traces using the withTrace wrapper.

Purpose: Add ~18 custom traces across 8 service files to measure critical backend operations — auth flows, feed queries, photo uploads, social actions, and notification loading. This provides full-stack visibility into the operations users experience most.
Output: 8 service files instrumented with withTrace calls, organized by feature area naming convention.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/47-firebase-perf-monitoring/47-RESEARCH.md
@.planning/phases/47-firebase-perf-monitoring/47-01-SUMMARY.md

# Key files (from 47-01):

@src/services/firebase/performanceService.js
@src/services/firebase/index.js

# Service files to instrument:

@src/services/firebase/phoneAuthService.js
@src/services/firebase/feedService.js
@src/services/firebase/storageService.js
@src/services/firebase/photoService.js
@src/services/firebase/userService.js
@src/services/firebase/friendshipService.js
@src/services/firebase/notificationService.js
@src/services/firebase/viewedStoriesService.js

**Established patterns:** withTrace(traceName, operation, attributes) wrapper from performanceService.js
**Constraining decisions:**

- [RESEARCH]: Feature-area trace naming: auth/, feed/, camera/, stories/, profile/, social/, notif/
- [RESEARCH]: Max 5 attributes per trace (withTrace reserves 1 for success, leaving 4 for caller)
- [RESEARCH]: Max 32 metrics per trace (use putMetric for counts like photo_count, friend_count)
- [RESEARCH]: Trace aggregate operations, NOT per-document reads (300-event rate limit)
- [RESEARCH]: No traces in hot paths (scroll handlers, render functions, animation callbacks)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Instrument auth, feed, camera, and photo services</name>
  <files>src/services/firebase/phoneAuthService.js, src/services/firebase/feedService.js, src/services/firebase/storageService.js, src/services/firebase/photoService.js</files>
  <action>
Import `{ withTrace }` from `'./performanceService'` in each file, then wrap the following functions:

**phoneAuthService.js** (3 traces):

- `sendVerificationCode` → wrap in `withTrace('auth/login', ...)` — the phone auth entry point
- `verifyCode` → wrap in `withTrace('auth/verify_code', ...)`
- If there's a separate signup-specific function, trace as `auth/signup`; otherwise auth/login covers both since phone auth is the same flow

**feedService.js** (3 traces):

- `getFeedPhotos` → wrap in `withTrace('feed/load', ...)` with metrics: `trace.putMetric('photo_count', snapshot.size)`, `trace.putMetric('friend_count', friendIds.length)`. Add attribute `{ cache_status: lastDoc ? 'paginated' : 'initial' }`
- `getUserFeedPhotos` → wrap in `withTrace('feed/refresh', ...)` with metric: `trace.putMetric('photo_count', result.length)`
- `subscribeFeedPhotos` is a real-time listener (not async/await) — do NOT wrap with withTrace. Real-time subscriptions are long-lived and don't have a natural stop point.

**storageService.js** (2 traces):

- `uploadPhoto` → wrap in `withTrace('camera/upload', ...)` with metric: `trace.putMetric('file_size_kb', Math.round(fileSize / 1024))` if file size is available
- `uploadProfilePhoto` → wrap in `withTrace('profile/upload_photo', ...)`

**photoService.js** (1 trace):

- `triagePhoto` (or whatever the main triage function is called) → wrap in `withTrace('photo/triage', ...)`

**Wrapping pattern:** Wrap the BODY of each function in withTrace, not the entire function. The function signature stays the same. Example:

```javascript
export async function getFeedPhotos(userId, friendIds, lastDoc, limit = 20) {
  return withTrace(
    'feed/load',
    async trace => {
      // ... existing function body ...
      trace.putMetric('photo_count', results.length);
      return results;
    },
    { cache_status: lastDoc ? 'paginated' : 'initial' }
  );
}
```

Do NOT trace `subscribeFeedPhotos` or any real-time listener. Do NOT trace helper/utility functions called frequently. Do NOT add more than 4 attributes per trace call.
</action>
<verify>

- `grep -n "withTrace" src/services/firebase/phoneAuthService.js` shows trace calls
- `grep -n "withTrace" src/services/firebase/feedService.js` shows trace calls
- `grep -n "withTrace" src/services/firebase/storageService.js` shows trace calls
- `grep -n "withTrace" src/services/firebase/photoService.js` shows trace calls
- No syntax errors in any modified file
  </verify>
  <done>phoneAuthService.js has 2-3 traces (auth/), feedService.js has 2 traces (feed/), storageService.js has 2 traces (camera/ + profile/), photoService.js has 1 trace (photo/triage)</done>
  </task>

<task type="auto">
  <name>Task 2: Instrument social, profile, notification, and stories services</name>
  <files>src/services/firebase/userService.js, src/services/firebase/friendshipService.js, src/services/firebase/notificationService.js, src/services/firebase/viewedStoriesService.js</files>
  <action>
Import `{ withTrace }` from `'./performanceService'` in each file, then wrap the following functions:

**userService.js** (2 traces):

- `getUserProfile` (or the main profile-loading function) → wrap in `withTrace('profile/load', ...)`
- `updateUserProfile` (or the main profile-update function) → wrap in `withTrace('profile/update', ...)`

**friendshipService.js** (3 traces):

- The main function that loads friends list → wrap in `withTrace('social/load_friends', ...)` with metric: `trace.putMetric('friend_count', friends.length)`
- `sendFriendRequest` → wrap in `withTrace('social/send_request', ...)`
- `acceptFriendRequest` → wrap in `withTrace('social/accept_request', ...)`

**notificationService.js** (2 traces):

- The function that loads notification feed/list → wrap in `withTrace('notif/load_feed', ...)` with metric: `trace.putMetric('notif_count', notifications.length)`
- `storeNotificationToken` → wrap in `withTrace('notif/register_token', ...)`

**viewedStoriesService.js** (1 trace):

- The main mark-as-viewed function → wrap in `withTrace('stories/mark_viewed', ...)`

Same wrapping pattern as Task 1 — wrap function BODY in withTrace, keep signature unchanged. Do NOT trace real-time listeners or subscription setup functions. Do NOT trace functions that are called on every scroll or render.

Look at the actual function names in each file — the RESEARCH.md trace inventory provides guidance but use the real function names found in the code.
</action>
<verify>

- `grep -n "withTrace" src/services/firebase/userService.js` shows trace calls
- `grep -n "withTrace" src/services/firebase/friendshipService.js` shows trace calls
- `grep -n "withTrace" src/services/firebase/notificationService.js` shows trace calls
- `grep -n "withTrace" src/services/firebase/viewedStoriesService.js` shows trace calls
- No syntax errors in any modified file
  </verify>
  <done>userService.js has 2 traces (profile/), friendshipService.js has 3 traces (social/), notificationService.js has 2 traces (notif/), viewedStoriesService.js has 1 trace (stories/)</done>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 8 service files import withTrace from performanceService
- [ ] ~18 total traces added across all service files
- [ ] Trace names follow feature-area convention (auth/, feed/, camera/, profile/, social/, notif/, stories/, photo/)
- [ ] No real-time listeners or subscriptions traced
- [ ] putMetric used for counts (photo_count, friend_count, notif_count, file_size_kb)
- [ ] No more than 4 attributes passed to any withTrace call
- [ ] No syntax errors introduced
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- ~18 custom traces instrumenting all critical backend operations
- No trace calls in hot paths or real-time listeners
- Feature-area naming convention consistently applied
  </success_criteria>

<output>
After completion, create `.planning/phases/47-firebase-perf-monitoring/47-02-SUMMARY.md`
</output>
