---
phase: 47-firebase-perf-monitoring
plan: 01
type: execute
---

<objective>
Install Firebase Performance Monitoring SDK and create the core performance service utilities.

Purpose: Establish the instrumentation foundation — SDK, config, reusable trace wrapper, screen trace hook — so subsequent plans can instrument service files and screens without setup overhead.
Output: @react-native-firebase/perf installed, config files updated, performanceService.js and useScreenTrace.js created, perf monitoring initialized in App.js.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-firebase-perf-monitoring/47-RESEARCH.md
@.planning/phases/47-firebase-perf-monitoring/47-CONTEXT.md
@.planning/phases/46-performance-optimization/46-07-SUMMARY.md

# Key files:

@App.js
@app.json
@firebase.json
@src/services/firebase/index.js

**Tech stack available:** @react-native-firebase/app ^23.8.2, expo-dev-client, withFirebaseFix plugin
**Established patterns:** Firebase service files in src/services/firebase/, barrel exports via index.js, top-level SDK init in App.js (see initializeGiphy pattern)
**Constraining decisions:**

- [Phase 46]: All @react-native-firebase modules at ^23.8.2 (resolves to 23.8.6)
- [Phase 46]: expo-dev-client already installed, withFirebaseFix handles iOS static frameworks
- [RESEARCH]: Use `withTrace()` wrapper pattern, not raw start/stop calls
- [RESEARCH]: Disable collection in `__DEV__` to prevent polluting production metrics
- [RESEARCH]: Use custom code traces (`startTrace`) not `startScreenTrace()` (iOS crashes)
- [RESEARCH]: 300-event-per-10-minute rate limit — trace aggregate operations, not per-document
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Install SDK and update configuration files</name>
  <files>package.json, app.json, firebase.json</files>
  <action>
1. Install the perf package: `npx expo install @react-native-firebase/perf`
2. Add `"@react-native-firebase/perf"` to the plugins array in app.json — insert it after `"@react-native-firebase/auth"` and before `"./plugins/withFirebaseFix"` to keep Firebase plugins grouped
3. Add `"react-native"` config to firebase.json to enable automatic performance collection:
```json
"react-native": {
  "perf_auto_collection_enabled": true
}
```

Do NOT modify any native files manually — the Expo config plugin handles all native setup (Android Gradle plugin, iOS CocoaPods). Do NOT use version 23.8.0-23.8.2 (broken Expo plugin — see RESEARCH pitfall 7).
</action>
<verify>

- `cat package.json | grep perf` shows @react-native-firebase/perf in dependencies
- `cat app.json` shows perf in plugins array after auth
- `cat firebase.json` shows react-native.perf_auto_collection_enabled = true
  </verify>
  <done>@react-native-firebase/perf installed, app.json plugin added, firebase.json configured</done>
  </task>

<task type="auto">
  <name>Task 2: Create performance service, screen trace hook, and App.js initialization</name>
  <files>src/services/firebase/performanceService.js, src/hooks/useScreenTrace.js, src/services/firebase/index.js, App.js</files>
  <action>
1. Create `src/services/firebase/performanceService.js` with two exports:
   - `initPerformanceMonitoring()`: Calls `perf().setPerformanceCollectionEnabled(false)` when `__DEV__` is true. No-op in production (collection enabled by firebase.json config).
   - `withTrace(traceName, operation, attributes)`: Async wrapper that starts a trace, sets up to 4 attributes (reserving 1 slot for success), runs the operation (passing trace as arg so callers can add metrics via `trace.putMetric()`), sets `success` attribute to `'true'`/`'false'`, guarantees `trace.stop()` in finally block, re-throws errors. In `__DEV__`, skip trace creation entirely and just run the operation with a no-op trace stub `{ putMetric: () => {}, putAttribute: () => {} }`.

Import: `import perf from '@react-native-firebase/perf';`

2. Create `src/hooks/useScreenTrace.js`:
   - `useScreenTrace(screenName)` hook: On mount, starts a trace named `screen/${screenName}`. Returns `{ markLoaded }` callback. `markLoaded(metrics)` adds optional metrics to the trace and stops it. Uses refs to handle unmount-before-load (cleanup stops trace). In `__DEV__`, return a no-op `markLoaded`.

3. Update `src/services/firebase/index.js`: Add barrel exports for `initPerformanceMonitoring` and `withTrace` from `'./performanceService'`.

4. Update `App.js`: Import `initPerformanceMonitoring` from `'./src/services/firebase/performanceService'` and call it at module level (after the existing `initializeGiphy` call, before the `App` function).

Follow the exact code patterns from RESEARCH.md code_examples section. Do NOT use `startScreenTrace()` (iOS crashes). Do NOT add more than 4 custom attributes in withTrace (reserve 1 for success).
</action>
<verify>

- `cat src/services/firebase/performanceService.js` shows initPerformanceMonitoring and withTrace exports
- `cat src/hooks/useScreenTrace.js` shows useScreenTrace hook with markLoaded
- `grep -n "performanceService" src/services/firebase/index.js` shows barrel exports
- `grep -n "initPerformanceMonitoring" App.js` shows initialization call
  </verify>
  <done>performanceService.js created with initPerformanceMonitoring + withTrace, useScreenTrace.js hook created, barrel exports updated, App.js calls initPerformanceMonitoring at startup</done>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] @react-native-firebase/perf in package.json dependencies
- [ ] app.json plugins include @react-native-firebase/perf
- [ ] firebase.json has react-native.perf_auto_collection_enabled
- [ ] performanceService.js exports initPerformanceMonitoring and withTrace
- [ ] useScreenTrace.js exports useScreenTrace hook
- [ ] index.js barrel includes perf exports
- [ ] App.js calls initPerformanceMonitoring
- [ ] __DEV__ guard in both performanceService and useScreenTrace
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No import errors or missing dependencies
- SDK installed and configured for automatic + custom trace collection
- Core utilities ready for service/screen instrumentation in plans 02 and 03
  </success_criteria>

<output>
After completion, create `.planning/phases/47-firebase-perf-monitoring/47-01-SUMMARY.md`
</output>
