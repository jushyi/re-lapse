---
phase: 18-content-visibility
plan: 01
type: execute
---

<objective>
Implement content visibility duration rules so stories stay visible for 7 days and feed posts stay visible for 1 day, with own posts excluded from the feed.

Purpose: Keep the feed feeling fresh with recent friend activity while giving stories more time to be seen. Reinforce that the feed is for discovering friends' posts, not reviewing your own.
Output: Updated feedService.js with server-side Firestore time-based filtering applied to all relevant queries.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-content-visibility/18-CONTEXT.md

# Key source file:

@src/services/firebase/feedService.js

**Context summary:**

- Stories: 7-day visibility window
- Feed posts: 1-day visibility window
- Own posts never appear in own feed (feed = 100% friend activity)
- Own photos appear in "Me" story card and on profile (albums, monthly albums)
- Expired content stays in albums/monthly albums, just drops from active feed/stories views
- No visual countdown indicators - seamless expiration
- Existing empty feed states (Phase 10) handle cases where no recent content exists
- Server-side Firestore filtering with composite indexes is the established pattern
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Add visibility duration constants and cutoff timestamp helper</name>
  <files>src/services/firebase/feedService.js</files>
  <action>
Add imports if not present: `Timestamp` from `@react-native-firebase/firestore`

Add constants at the top of feedService.js (after imports):

- `STORIES_VISIBILITY_DAYS = 7` - stories visible for 7 days
- `FEED_VISIBILITY_DAYS = 1` - feed posts visible for 1 day

Add a helper function `getCutoffTimestamp(days)`:

- Calculate the cutoff date: `new Date(Date.now() - days * 24 * 60 * 60 * 1000)`
- Return a Firestore Timestamp using `Timestamp.fromDate(cutoffDate)`
- This timestamp can be used directly in `where('capturedAt', '>=', cutoff)` queries

The helper should be a private function (not exported) since it's only used internally.
</action>
<verify>Read the file and confirm constants, Timestamp import, and getCutoffTimestamp helper function are present</verify>
<done>Constants STORIES_VISIBILITY_DAYS (7) and FEED_VISIBILITY_DAYS (1) exist, Timestamp is imported, and getCutoffTimestamp helper returns a Firestore Timestamp for use in queries</done>
</task>

<task type="auto">
  <name>Task 2: Apply server-side visibility filtering to Firestore queries</name>
  <files>src/services/firebase/feedService.js</files>
  <action>
Update four functions to add server-side time-based filtering in Firestore queries:

1. **getFeedPhotos**:
   - Add `where('capturedAt', '>=', getCutoffTimestamp(FEED_VISIBILITY_DAYS))` to the query
   - In the client-side filter, EXCLUDE current user's own photos: change the filter to only include friends (not currentUserId)
   - Result: Feed shows only friend posts from last 1 day

2. **subscribeFeedPhotos**:
   - Add same `where('capturedAt', '>=', getCutoffTimestamp(FEED_VISIBILITY_DAYS))` to the query
   - Exclude current user's photos in client-side filter (friends only, not currentUserId)
   - Result: Real-time feed shows only friend posts from last 1 day

3. **getFriendStoriesData** (in the inner photosQuery for each friend):
   - Add `where('capturedAt', '>=', getCutoffTimestamp(STORIES_VISIBILITY_DAYS))` to the photos query
   - Result: Friend stories show last 7 days of photos

4. **getUserStoriesData** (in the photosQuery):
   - Add `where('capturedAt', '>=', getCutoffTimestamp(STORIES_VISIBILITY_DAYS))` to the photos query
   - Result: "Me" story card shows user's last 7 days of photos

Important: Don't modify getTopPhotosByEngagement or getUserFeedPhotos - those are for profile views where all photos should remain visible regardless of age.
</action>
<verify>
Run `grep -n "getCutoffTimestamp\|FEED_VISIBILITY_DAYS\|STORIES_VISIBILITY_DAYS" src/services/firebase/feedService.js` to confirm the constants and cutoff function are used in all four query functions.
</verify>
<done>

- getFeedPhotos query filters to 1-day window server-side, excludes own photos client-side
- subscribeFeedPhotos query filters to 1-day window server-side, excludes own photos client-side
- getFriendStoriesData query filters to 7-day window server-side
- getUserStoriesData query filters to 7-day window server-side
  </done>
  </task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Constants STORIES_VISIBILITY_DAYS (7) and FEED_VISIBILITY_DAYS (1) are defined
- [ ] Timestamp is imported from @react-native-firebase/firestore
- [ ] getCutoffTimestamp helper function returns a Firestore Timestamp
- [ ] getFeedPhotos query includes capturedAt >= cutoff filter, excludes current user client-side
- [ ] subscribeFeedPhotos query includes capturedAt >= cutoff filter, excludes current user client-side
- [ ] getFriendStoriesData query includes capturedAt >= cutoff filter
- [ ] getUserStoriesData query includes capturedAt >= cutoff filter
- [ ] getTopPhotosByEngagement and getUserFeedPhotos remain unchanged (profile views)
- [ ] App builds without errors: `npx react-native start --reset-cache` succeeds
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Feed shows only friend posts from last 24 hours (no own posts)
- Stories bar shows friend stories from last 7 days
- "Me" story card shows own photos from last 7 days
- Profile views (albums, monthly albums) still show all photos regardless of age
  </success_criteria>

<output>
After completion, create `.planning/phases/18-content-visibility/18-01-SUMMARY.md`
</output>
