---
phase: 28.1-fix-photo-upload-permission
plan: 01
subsystem: database
tags: [firestore, security-rules, photo-upload]

# Dependency graph
requires:
  - phase: 23
    provides: Firestore security rules with immutable field protection
provides:
  - Fixed photo upload flow allowing initial imageURL setting
  - Maintained imageURL tampering protection for existing photos
affects: [photo-capture, upload-queue]

# Tech tracking
tech-stack:
  added: []
  patterns: [conditional-immutability]

key-files:
  created: []
  modified: [firestore.rules]

key-decisions:
  - 'Split immutable field check: userId/capturedAt always protected, imageURL protected only after set'

patterns-established:
  - 'Conditional immutability: fields can be set once but not changed'

issues-created: []

# Metrics
duration: 9min
completed: 2026-01-25
---

# Phase 28.1 Plan 01: Fix Photo Upload Permission Denied Summary

**Updated Firestore security rules to allow initial imageURL setting while maintaining tampering protection for existing photos**

## Performance

- **Duration:** 9 min
- **Started:** 2026-01-25T16:10:00Z
- **Completed:** 2026-01-25T16:19:26Z
- **Tasks:** 3 (1 automated, 2 manual verification)
- **Files modified:** 1

## Accomplishments

- Fixed `immutablePhotoFieldsUnchanged()` function to allow initial imageURL setting
- Maintained security: imageURL cannot be changed once set to non-empty value
- Deployed updated security rules to Firebase project `re-lapse-fa89b`

## Task Commits

Each task was committed atomically:

1. **Task 1: Update security rules to allow initial imageURL setting** - `d3bf1f3` (fix)

**Tasks 2-3:** Manual verification steps (no code changes, verification instructions provided)

**Plan metadata:** (this commit)

## Files Created/Modified

- `firestore.rules` - Updated `immutablePhotoFieldsUnchanged()` to split immutability logic:
  - `userId` and `capturedAt` remain always immutable
  - `imageURL` can be set when empty (allows initial upload from UploadQueueService)
  - `imageURL` protected once set to non-empty value (prevents tampering)

## Decisions Made

- **Conditional immutability for imageURL**: Allow empty→non-empty transition (initial set), block non-empty→anything transition (tampering). This preserves Phase 23's security intent while fixing the upload flow.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Corrected Firebase project ID in deploy command**

- **Found during:** Task 1 (security rules deployment)
- **Issue:** Plan specified `--project lapse-clone-app` but correct project ID is `re-lapse-fa89b`
- **Fix:** Used correct project ID from `.firebaserc`
- **Verification:** Deploy succeeded

---

**Total deviations:** 1 auto-fixed (blocking - wrong project ID)
**Impact on plan:** Minor - deploy command corrected, no impact on fix approach

## Issues Encountered

None - security rules updated and deployed successfully.

## Verification Required (Tasks 2-3)

**Task 2 - Test photo upload flow:**

1. Start the app with `npx expo start`
2. Capture a photo
3. Verify logs show successful upload without `[firestore/permission-denied]` error
4. Check Firestore Console - photo document should have valid imageURL

**Task 3 - Verify tampering protection:**

- Existing photos with non-empty imageURL should still reject changes to imageURL field

## Next Phase Readiness

- Security rules fix deployed and live
- Ready for Phase 29 (Documentation) after manual verification
- No blockers

---

_Phase: 28.1-fix-photo-upload-permission_
_Completed: 2026-01-25_
