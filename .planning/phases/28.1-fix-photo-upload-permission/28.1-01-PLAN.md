---
phase: 28.1-fix-photo-upload-permission
plan: 01
type: execute
---

<objective>
Fix Firestore permission-denied error when updating photo document after Storage upload.

Purpose: Enable the background upload flow to successfully set imageURL on photo documents after Storage upload completes.
Output: Working photo upload flow - photos capture, upload to Storage, and update Firestore document with URL.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Root Cause (from analysis):**
The UploadQueueService creates photo documents with `imageURL: ''` (placeholder), then updates to set the real URL after Storage upload completes. Phase 23's security hardening added `immutablePhotoFieldsUnchanged()` which requires `imageURL` to be in `unchangedKeys()`. Since the URL is being CHANGED (from '' to real URL), the update fails.

**Current problematic rule (firestore.rules lines 56-59):**

```javascript
function immutablePhotoFieldsUnchanged() {
  return request.resource.data
    .diff(resource.data)
    .unchangedKeys()
    .hasAll(['userId', 'capturedAt', 'imageURL']);
}
```

**Upload flow (src/services/uploadQueueService.js lines 261-298):**

1. Create doc with `imageURL: ''` (line 263)
2. Upload to Storage
3. Update doc with `imageURL: uploadResult.url` (line 296-298) ‚Üê FAILS HERE

**Fix approach:**
Allow `imageURL` to change from empty to non-empty (initial set), but prevent changing once set (tampering). This preserves the security intent while fixing the upload flow.

@firestore.rules
@src/services/uploadQueueService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update security rules to allow initial imageURL setting</name>
  <files>firestore.rules</files>
  <action>
Modify the `immutablePhotoFieldsUnchanged()` function to split the immutable field check:
- `userId` and `capturedAt` must ALWAYS remain unchanged
- `imageURL` can change ONLY if the current value is empty string (allows initial set, blocks tampering)

Replace the current function with:

```javascript
// Helper function to ensure immutable photo fields are not changed
// Protects userId, capturedAt from ALL modification
// Protects imageURL from modification AFTER it's set (allows initial setting from empty)
function immutablePhotoFieldsUnchanged() {
  let immutableAlways = request.resource.data
    .diff(resource.data)
    .unchangedKeys()
    .hasAll(['userId', 'capturedAt']);
  // imageURL can be changed only if current value is empty (initial set after Storage upload)
  let imageURLProtected =
    resource.data.imageURL == '' ||
    request.resource.data.diff(resource.data).unchangedKeys().hasAny(['imageURL']);
  return immutableAlways && imageURLProtected;
}
```

This preserves the Phase 23 security intent (prevent imageURL tampering) while allowing the background upload flow to set the URL initially.
</action>
<verify>Run `firebase deploy --only firestore:rules --project lapse-clone-app` - should deploy without errors</verify>
<done>Security rules deployed, function updated to allow initial imageURL setting</done>
</task>

<task type="auto">
  <name>Task 2: Test photo upload flow end-to-end</name>
  <files>N/A (manual test)</files>
  <action>
Test the complete upload flow in the app:
1. Start the app with `npx expo start`
2. Open on iOS device/simulator
3. Navigate to Camera
4. Capture a photo
5. Verify in logs:
   - `UploadQueueService.uploadQueueItem: Creating Firestore document` (should succeed)
   - `StorageService.uploadPhoto: Upload successful` (should succeed)
   - `UploadQueueService.uploadQueueItem: Updating document with URL` (should NOW succeed - was failing before)
   - `UploadQueueService.uploadQueueItem: Complete` (should succeed)
6. Verify NO `[firestore/permission-denied]` error appears

Also verify Firestore Console shows the photo document with a valid imageURL (not empty string).
</action>
<verify>Check logs show successful upload flow without permission-denied errors. Check Firestore Console shows photo with imageURL set.</verify>
<done>Photo capture and upload flow works end-to-end, imageURL set correctly on documents</done>
</task>

<task type="auto">
  <name>Task 3: Verify imageURL tampering is still blocked</name>
  <files>N/A (security verification)</files>
  <action>
Verify the security rule still prevents imageURL tampering on photos that already have a URL set.

Using Firebase Console or a test script, attempt to update an existing photo's imageURL (one that already has a non-empty URL) to a different value. This should fail with permission-denied.

Alternatively, add a temporary test in the app that attempts:

```javascript
// This should fail - attempting to change an already-set imageURL
await updateDoc(doc(db, 'photos', existingPhotoId), {
  imageURL: 'https://malicious-url.com/image.jpg',
});
```

Expected: permission-denied error (imageURL tampering blocked)
</action>
<verify>Attempting to change an existing non-empty imageURL results in permission-denied</verify>
<done>Security verification complete - imageURL tampering still blocked for existing photos</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `firebase deploy --only firestore:rules` succeeds
- [ ] Photo capture flow works end-to-end (no permission-denied errors)
- [ ] Photo documents in Firestore have valid imageURL values
- [ ] imageURL tampering on existing photos is still blocked
</verification>

<success_criteria>

- Security rules updated and deployed
- Photo upload flow works without permission errors
- imageURL set correctly on photo documents after Storage upload
- Security: imageURL cannot be changed once set to non-empty value
- No regressions in other photo operations (triage, reactions)
  </success_criteria>

<output>
After completion, create `.planning/phases/28.1-fix-photo-upload-permission/28.1-01-SUMMARY.md` following the summary template.
</output>
