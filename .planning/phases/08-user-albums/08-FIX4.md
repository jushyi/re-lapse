---
phase: 08-user-albums
plan: FIX4
type: fix
---

<objective>
Photo viewer enhancements - navigation fixes, thumbnail bar, swipe gestures.

Issues: UAT-006, UAT-008, UAT-010 (major), UAT-011
Scope: 1 major + 3 minor fixes
</objective>

<context>
@.planning/phases/08-user-albums/08-ISSUES.md
@src/components/AlbumPhotoViewer.js
@src/screens/AlbumGridScreen.js
@src/services/firebase/albumService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-006 - Remove photo navigates to album grid</name>
  <files>src/components/AlbumPhotoViewer.js</files>
  <action>
After removing a photo via the viewer's menu:
- Currently: navigates to ProfileScreen (wrong)
- Should: navigate back to AlbumGridScreen

Fix the navigation in the remove handler:

- If photos remain after removal: stay in viewer, adjust index
- If no photos remain: close viewer (parent AlbumGridScreen handles empty state)

The onClose callback should NOT navigate to Profile - just close the viewer modal.
Check how navigation.goBack() or the onClose prop is being used.
</action>
<verify>Remove photo → stays in viewer or returns to album grid, NOT profile</verify>
<done>Remove navigates correctly to album grid</done>
</task>

<task type="auto">
  <name>Task 2: Fix UAT-008 - Last photo deletion prompts album delete</name>
  <files>src/components/AlbumPhotoViewer.js, src/screens/AlbumGridScreen.js</files>
  <action>
When removing the last photo from an album:

Instead of error dialog, show:

```
Alert.alert(
  "Delete Album?",
  "Removing the last photo will delete this album.",
  [
    { text: "Cancel", style: "cancel" },
    {
      text: "Delete Album",
      style: "destructive",
      onPress: async () => {
        await albumService.deleteAlbum(albumId);
        navigation.navigate('ProfileMain');
      }
    }
  ]
)
```

Logic:

1. Before removal, check if photos.length === 1
2. If last photo, show album deletion confirmation
3. On confirm: delete album, navigate to ProfileMain
4. On cancel: do nothing
   </action>
   <verify>Remove last photo → "Delete Album?" prompt → Cancel keeps album, Delete removes and goes to profile</verify>
   <done>Last photo removal offers album deletion</done>
   </task>

<task type="auto">
  <name>Task 3: Fix UAT-010 - Add thumbnail navigation bar (MAJOR)</name>
  <files>src/components/AlbumPhotoViewer.js</files>
  <action>
Add horizontal thumbnail bar at bottom of photo viewer:

Structure:

```jsx
<View style={styles.thumbnailBar}>
  <FlatList
    horizontal
    data={photos}
    renderItem={({ item, index }) => (
      <TouchableOpacity onPress={() => scrollToIndex(index)}>
        <Image
          source={{ uri: item.url }}
          style={[styles.thumbnail, index === currentIndex && styles.thumbnailActive]}
        />
      </TouchableOpacity>
    )}
    showsHorizontalScrollIndicator={false}
  />
</View>
```

Styles:

- Bar: positioned above safe area bottom, semi-transparent background (rgba(0,0,0,0.5))
- Thumbnail: 50x67 (3:4 ratio), margin 4px, border-radius 4px
- Active thumbnail: 2px white border
- Auto-scroll FlatList to keep current thumbnail visible (scrollToIndex)

When user taps thumbnail: scroll main photo FlatList to that index.
When user swipes main photos: update thumbnail bar selection.
</action>
<verify>

1. Open photo viewer
2. Thumbnail bar visible at bottom
3. Current photo has white border
4. Tap thumbnail → jumps to that photo
5. Swipe photos → thumbnail selection updates
   </verify>
   <done>Thumbnail navigation bar functional with current photo indicator</done>
   </task>

<task type="auto">
  <name>Task 4: Fix UAT-011 - Swipe down to close viewer</name>
  <files>src/components/AlbumPhotoViewer.js</files>
  <action>
Add swipe-down gesture to dismiss photo viewer:

Using react-native-gesture-handler (already in project):

```jsx
import { PanGestureHandler } from 'react-native-gesture-handler';
import Animated, {
  useAnimatedGestureHandler,
  useSharedValue,
  useAnimatedStyle,
  withSpring,
  runOnJS,
} from 'react-native-reanimated';

const translateY = useSharedValue(0);

const gestureHandler = useAnimatedGestureHandler({
  onActive: event => {
    if (event.translationY > 0) {
      // Only track downward
      translateY.value = event.translationY;
    }
  },
  onEnd: event => {
    if (event.translationY > 150 || event.velocityY > 500) {
      runOnJS(onClose)();
    } else {
      translateY.value = withSpring(0);
    }
  },
});
```

Wrap viewer content in PanGestureHandler.
Add animated style for translateY during drag.
</action>
<verify>Swipe down on photo → viewer slides down and closes</verify>
<done>Swipe down dismisses photo viewer</done>
</task>

</tasks>

<verification>
- [ ] Remove photo returns to album grid
- [ ] Last photo removal prompts album deletion
- [ ] Thumbnail bar displays at bottom
- [ ] Thumbnail tap navigates photos
- [ ] Swipe down closes viewer
- [ ] App builds without errors
</verification>

<success_criteria>

- UAT-006, UAT-008, UAT-010, UAT-011 resolved
- Photo viewer fully enhanced
  </success_criteria>

<output>
Create `.planning/phases/08-user-albums/08-FIX4-SUMMARY.md`
</output>
