---
phase: 09-firestore-services-migration
plan: 01
type: execute
---

<objective>
Migrate photoService.js and darkroomService.js from Firebase JS SDK to React Native Firebase SDK.

Purpose: Fix permission-denied errors caused by auth state mismatch between JS SDK Firestore and RN Firebase Auth. Users authenticated via phone auth (RN Firebase) cannot access Firestore data via JS SDK because the SDKs don't share authentication state.

Output: photoService.js and darkroomService.js using `@react-native-firebase/firestore` with all existing functionality preserved.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Migration Pattern (from AuthContext.js):**
The correct RN Firebase Firestore pattern is already established in AuthContext.js:

```javascript
// BEFORE (JS SDK - doesn't share auth state with RN Firebase Auth):
import { doc, getDoc, setDoc, updateDoc } from 'firebase/firestore';
import { db } from './firebaseConfig';
const docRef = doc(db, 'collection', 'docId');
const snapshot = await getDoc(docRef);
if (snapshot.exists()) { ... }

// AFTER (RN Firebase - shares auth state with phone auth):
import firestore from '@react-native-firebase/firestore';
const snapshot = await firestore().collection('collection').doc('docId').get();
const exists = typeof snapshot.exists === 'function' ? snapshot.exists() : snapshot.exists;
if (exists) { ... }
```

**Key differences:**
- No import of individual functions (getDoc, setDoc, etc.)
- No db config import - firestore() is self-contained
- Method chaining: `firestore().collection().doc().get()`
- Timestamp: `firestore.FieldValue.serverTimestamp()` instead of `Timestamp.now()`
- exists check: Handle both function and property (RN Firebase version differences)

@src/context/AuthContext.js (lines 1-65 demonstrate the pattern)
@src/services/firebase/photoService.js
@src/services/firebase/darkroomService.js
@src/services/firebase/firebaseConfig.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate photoService.js to RN Firebase</name>
  <files>src/services/firebase/photoService.js</files>
  <action>
Rewrite photoService.js to use @react-native-firebase/firestore instead of Firebase JS SDK.

**Migration steps:**
1. Replace imports:
   - Remove: `import { collection, doc, addDoc, getDoc, updateDoc, deleteDoc, query, where, orderBy, getDocs, Timestamp } from 'firebase/firestore';`
   - Remove: `import { db } from './firebaseConfig';`
   - Add: `import firestore from '@react-native-firebase/firestore';`

2. Migrate each function (9 total):
   - `createPhoto()`: Use `firestore().collection('photos').add({...})` with `firestore.FieldValue.serverTimestamp()` for capturedAt
   - `getCurrentMonth()`: No changes (pure JS)
   - `getUserPhotos()`: Use `firestore().collection('photos').where().orderBy().get()`
   - `getDevelopingPhotoCount()`: Use `firestore().collection('photos').where().where().get()` then `.size`
   - `getDarkroomCounts()`: Two queries with Promise.all, same pattern
   - `getDevelopingPhotos()`: Two queries (developing + revealed), combine and sort client-side
   - `revealPhotos()`: Query + batch update pattern
   - `triagePhoto()`: Use `firestore().collection('photos').doc(photoId).update()`
   - `addReaction()` / `removeReaction()`: Get doc, modify reactions object, update

3. Handle exists check consistently:
   ```javascript
   const exists = typeof snapshot.exists === 'function' ? snapshot.exists() : snapshot.exists;
   ```

4. Replace Timestamp.now() with firestore.FieldValue.serverTimestamp()

5. Keep all logging unchanged (logger.debug, logger.info, logger.error)

**DO NOT change:**
- Function signatures (same params and return types)
- Error handling pattern (try/catch returning {success, error})
- Logging calls
- Business logic
  </action>
  <verify>
1. Check imports at top of file: should only have `import firestore from '@react-native-firebase/firestore'` for Firestore
2. Search for any remaining JS SDK patterns: no `from 'firebase/firestore'`, no `db` import
3. App launches without import errors
  </verify>
  <done>
- photoService.js uses @react-native-firebase/firestore exclusively
- No firebase/firestore imports remain
- All 9 functions follow RN Firebase patterns
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate darkroomService.js to RN Firebase</name>
  <files>src/services/firebase/darkroomService.js</files>
  <action>
Rewrite darkroomService.js to use @react-native-firebase/firestore instead of Firebase JS SDK.

**Migration steps:**
1. Replace imports:
   - Remove: `import { collection, doc, getDoc, setDoc, updateDoc, Timestamp } from 'firebase/firestore';`
   - Remove: `import { db } from './firebaseConfig';`
   - Add: `import firestore from '@react-native-firebase/firestore';`

2. Migrate each function (4 total):
   - `getDarkroom()`:
     - `firestore().collection('darkrooms').doc(userId).get()`
     - Handle exists check for both function and property
     - Use `firestore().collection('darkrooms').doc(userId).set({...})` for creation

   - `isDarkroomReadyToReveal()`:
     - Compare `nextRevealAt.seconds` to current time
     - Can use `firestore.Timestamp.now()` for comparison

   - `scheduleNextReveal()`:
     - `firestore().collection('darkrooms').doc(userId).update({...})`
     - Use `firestore.FieldValue.serverTimestamp()` for lastRevealedAt

   - `calculateNextRevealTime()`:
     - Use `firestore.Timestamp.fromDate(revealTime)` instead of `Timestamp.fromDate()`

3. Handle Timestamp differences:
   - `Timestamp.now()` -> `firestore.Timestamp.now()`
   - `Timestamp.fromDate()` -> `firestore.Timestamp.fromDate()`

**DO NOT change:**
- Function signatures
- Error handling pattern
- Logging calls
- Random reveal time calculation logic (0-2 hours)
  </action>
  <verify>
1. Check imports: only `import firestore from '@react-native-firebase/firestore'` for Firestore
2. No remaining JS SDK imports
3. Timestamp usage follows RN Firebase pattern
  </verify>
  <done>
- darkroomService.js uses @react-native-firebase/firestore exclusively
- No firebase/firestore imports remain
- All 4 functions follow RN Firebase patterns
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] No `import ... from 'firebase/firestore'` in photoService.js or darkroomService.js
- [ ] No `import { db }` from firebaseConfig in these files
- [ ] App launches without import errors: `npx expo start`
- [ ] Camera capture flow works (creates photo doc, uploads to storage)
- [ ] Darkroom reveal timing logic works (calculates next reveal time)
</verification>

<success_criteria>
- photoService.js migrated to RN Firebase (9 functions)
- darkroomService.js migrated to RN Firebase (4 functions)
- No JS SDK Firestore imports in migrated files
- Existing functionality preserved (same function signatures, return types)
- App launches and core photo flow works
</success_criteria>

<output>
After completion, create `.planning/phases/09-firestore-services-migration/09-01-SUMMARY.md` following the summary template with:
- Accomplishments: Which services migrated, function counts
- Files Modified: photoService.js, darkroomService.js
- Decisions Made: Any patterns established during migration
- Issues Encountered: Any edge cases or surprises
- Next Step: Ready for 09-02-PLAN.md (social services migration)
</output>
