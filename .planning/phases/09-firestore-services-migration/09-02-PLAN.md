---
phase: 09-firestore-services-migration
plan: 02
type: execute
---

<objective>
Migrate feedService.js and friendshipService.js from Firebase JS SDK to React Native Firebase SDK.

Purpose: Complete the Firestore SDK consolidation by migrating the remaining social feature services. This ensures all Firestore operations use the same SDK that shares auth state with phone authentication.

Output: feedService.js and friendshipService.js using `@react-native-firebase/firestore` with all existing functionality preserved, including real-time listeners.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-firestore-services-migration/09-01-SUMMARY.md

**Migration Pattern (established in 09-01):**
```javascript
// RN Firebase pattern:
import firestore from '@react-native-firebase/firestore';

// Collection reference
firestore().collection('photos')

// Document reference
firestore().collection('photos').doc(photoId)

// Query with where/orderBy
firestore().collection('photos')
  .where('photoState', '==', 'journal')
  .orderBy('capturedAt', 'desc')
  .get()

// Real-time listener
const unsubscribe = firestore().collection('photos')
  .where('photoState', '==', 'journal')
  .onSnapshot(
    snapshot => { /* handle docs */ },
    error => { /* handle error */ }
  );

// OR queries (important for friendshipService)
// Note: RN Firebase uses Filter.or() for OR queries
import firestore, { Filter } from '@react-native-firebase/firestore';
firestore().collection('friendships')
  .where(Filter.or(
    Filter.where('user1Id', '==', userId),
    Filter.where('user2Id', '==', userId)
  ))
  .get()

// Timestamps
firestore.FieldValue.serverTimestamp()
firestore.Timestamp.now()
```

@src/services/firebase/feedService.js
@src/services/firebase/friendshipService.js
@src/context/AuthContext.js (reference pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate feedService.js to RN Firebase</name>
  <files>src/services/firebase/feedService.js</files>
  <action>
Rewrite feedService.js to use @react-native-firebase/firestore instead of Firebase JS SDK.

**Migration steps:**
1. Replace imports:
   - Remove: `import { collection, doc, query, where, getDocs, getDoc, onSnapshot, updateDoc } from 'firebase/firestore';`
   - Remove: `import { db } from './firebaseConfig';`
   - Add: `import firestore from '@react-native-firebase/firestore';`

2. Migrate each function (6 total):

   **getFeedPhotos():**
   - Query: `firestore().collection('photos').where('photoState', '==', 'journal').get()`
   - User data fetch: `firestore().collection('users').doc(userId).get()`
   - Handle exists: `const exists = typeof userDoc.exists === 'function' ? userDoc.exists() : userDoc.exists;`
   - Keep client-side sorting and filtering logic unchanged

   **subscribeFeedPhotos():**
   - Use `.onSnapshot()` on the query
   - `firestore().collection('photos').where('photoState', '==', 'journal').onSnapshot(...)`
   - Return unsubscribe function
   - Keep async user data fetch inside snapshot handler

   **getPhotoById():**
   - `firestore().collection('photos').doc(photoId).get()`
   - `firestore().collection('users').doc(userId).get()`

   **getUserFeedPhotos():**
   - `firestore().collection('photos').where('userId', '==', userId).where('status', '==', 'triaged').orderBy('capturedAt', 'desc').get()`

   **getFeedStats():**
   - Three parallel queries with Promise.all
   - Same pattern as photoService migration

   **toggleReaction():**
   - `firestore().collection('photos').doc(photoId).get()`
   - `firestore().collection('photos').doc(photoId).update({...})`

3. Handle document exists checks consistently

4. Keep all client-side filtering, sorting, and pagination logic unchanged

**DO NOT change:**
- Function signatures
- Client-side filtering logic (friendUserIds filtering)
- Pagination implementation
- Error handling pattern
- Logging calls
  </action>
  <verify>
1. No `import ... from 'firebase/firestore'` in feedService.js
2. No `import { db }` from firebaseConfig
3. Real-time subscription returns unsubscribe function
4. Feed loads in app (shows journaled photos)
  </verify>
  <done>
- feedService.js uses @react-native-firebase/firestore exclusively
- All 6 functions migrated
- Real-time listeners work correctly
- Client-side filtering preserved
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate friendshipService.js to RN Firebase</name>
  <files>src/services/firebase/friendshipService.js</files>
  <action>
Rewrite friendshipService.js to use @react-native-firebase/firestore instead of Firebase JS SDK.

**Migration steps:**
1. Replace imports:
   - Remove: `import { collection, doc, getDoc, getDocs, setDoc, deleteDoc, updateDoc, query, where, or, onSnapshot, serverTimestamp } from 'firebase/firestore';`
   - Remove: `import { db } from './firebaseConfig';`
   - Add: `import firestore, { Filter } from '@react-native-firebase/firestore';`

2. **CRITICAL - OR queries:**
   The friendshipService uses `or()` queries extensively. In RN Firebase, use Filter:
   ```javascript
   // BEFORE (JS SDK):
   query(friendshipsRef, or(
     where('user1Id', '==', userId),
     where('user2Id', '==', userId)
   ))

   // AFTER (RN Firebase):
   firestore().collection('friendships')
     .where(Filter.or(
       Filter.where('user1Id', '==', userId),
       Filter.where('user2Id', '==', userId)
     ))
   ```

3. Migrate each function (11 total):

   **generateFriendshipId():** No changes (pure JS)

   **sendFriendRequest():**
   - `firestore().collection('friendships').doc(friendshipId).get()`
   - `firestore().collection('friendships').doc(friendshipId).set({...})`
   - Use `firestore.FieldValue.serverTimestamp()` for createdAt

   **acceptFriendRequest():**
   - Get: `firestore().collection('friendships').doc(friendshipId).get()`
   - Update: `firestore().collection('friendships').doc(friendshipId).update({...})`

   **declineFriendRequest():**
   - Get then delete: `firestore().collection('friendships').doc(friendshipId).delete()`

   **removeFriend():**
   - Same pattern as declineFriendRequest

   **getFriendships():** (uses OR query)
   - Use `Filter.or(Filter.where(...), Filter.where(...))`
   - Client-side filter for status === 'accepted'

   **getPendingRequests():** (uses OR query)
   - Use Filter.or pattern
   - Client-side filter for status === 'pending' AND requestedBy !== userId

   **getSentRequests():**
   - Simple where query (no OR needed)
   - `firestore().collection('friendships').where('requestedBy', '==', userId).where('status', '==', 'pending').get()`

   **checkFriendshipStatus():**
   - `firestore().collection('friendships').doc(friendshipId).get()`

   **subscribeFriendships():** (uses OR query + listener)
   - Use Filter.or with onSnapshot
   - Return unsubscribe function

   **getFriendUserIds():**
   - Calls getFriendships(), no changes needed

4. Handle serverTimestamp:
   - `serverTimestamp()` -> `firestore.FieldValue.serverTimestamp()`

5. Handle toMillis() for timestamp sorting - should work the same in RN Firebase

**DO NOT change:**
- Function signatures
- Friendship ID generation logic
- Client-side filtering and sorting
- Error handling pattern
- Logging calls
  </action>
  <verify>
1. No `import ... from 'firebase/firestore'` in friendshipService.js
2. No `import { db }` from firebaseConfig
3. Import includes Filter: `import firestore, { Filter } from '@react-native-firebase/firestore'`
4. All OR queries use Filter.or pattern
5. Friend requests can be sent/accepted in app
  </verify>
  <done>
- friendshipService.js uses @react-native-firebase/firestore exclusively
- All 11 functions migrated
- OR queries use Filter.or pattern
- Real-time listener works correctly
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] No `import ... from 'firebase/firestore'` in feedService.js or friendshipService.js
- [ ] No `import { db }` from firebaseConfig in these files
- [ ] App launches without import errors: `npx expo start`
- [ ] Feed loads correctly (shows friends' journaled photos)
- [ ] Friend requests work (send, accept, decline)
- [ ] Real-time updates work (feed updates when new photos posted)
</verification>

<success_criteria>
- feedService.js migrated to RN Firebase (6 functions)
- friendshipService.js migrated to RN Firebase (11 functions)
- OR queries use Filter.or pattern correctly
- Real-time listeners work
- No JS SDK Firestore imports in migrated files
- Existing functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/09-firestore-services-migration/09-02-SUMMARY.md` following the summary template with:
- Accomplishments: Social services migrated, OR query pattern established
- Files Modified: feedService.js, friendshipService.js
- Decisions Made: Filter.or pattern for OR queries
- Issues Encountered: Any edge cases
- Next Step: Ready for Phase 10 (Storage Migration & Cleanup)
</output>
