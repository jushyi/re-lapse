---
phase: 17-nested-reply-comments
plan: 02
type: execute
---

<objective>
Implement @mention text rendering and scroll-to-comment navigation with highlight animation.

Purpose: Make @mentions in comment text visually distinct and tappable, allowing users to quickly navigate to the referenced comment for conversation context.
Output: @mentions render as highlighted tappable text, tapping scrolls the comment list to the referenced comment with a brief highlight animation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-nested-reply-comments/17-CONTEXT.md
@.planning/phases/17-nested-reply-comments/17-01-SUMMARY.md

# Key files for this phase:

@src/components/comments/CommentsBottomSheet.js
@src/components/comments/CommentRow.js
@src/components/comments/CommentWithReplies.js
@src/hooks/useComments.js
@src/styles/CommentRow.styles.js
@src/styles/CommentsBottomSheet.styles.js
@src/constants/colors.js

**From 17-01:**

- Comments now have mentionedCommentId field linking to the specific comment being replied to
- @username is auto-inserted when replying to any comment

**Established patterns:**

- FlatList with ref for scrollToIndex capability
- Animated.Value for highlight animations (see AlbumBar scale animation pattern)
- colors.brand.purple for interactive highlights
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create MentionText component for parsing and rendering @mentions</name>
  <files>src/components/comments/MentionText.js, src/styles/MentionText.styles.js, src/components/comments/index.js</files>
  <action>
**Create MentionText.js:**
A component that takes text string and renders @mentions as tappable highlighted spans.

Props:

- `text` (string) - The comment text to parse
- `onMentionPress` (function) - Callback when @mention is tapped, receives (username, mentionedCommentId)
- `mentionedCommentId` (string, optional) - The comment ID this @mention refers to (from comment data)
- `style` (object, optional) - Base text style

Implementation:

1. Parse text using regex: `/@(\w+)/g` to find @mentions
2. Split text into segments: regular text and @mention spans
3. Render using Text with nested Text for @mentions
4. @mention Text has:
   - onPress handler calling onMentionPress(username, mentionedCommentId)
   - Style: colors.brand.purple color, slightly bolder weight
5. Only the FIRST @mention in a comment gets the mentionedCommentId (auto-inserted from Reply)
6. Subsequent @mentions (manually typed) are still highlighted but onMentionPress receives null for commentId

**Create MentionText.styles.js:**

- mentionText: { color: colors.brand.purple, fontWeight: '500' }
- baseText: inherit from parent style

**Update CommentRow.js:**

- Replace direct Text rendering of comment.text with MentionText component
- Pass mentionedCommentId from comment data to MentionText
- Add onMentionPress prop to CommentRow, pass through to MentionText

**Update index.js:**

- Export MentionText component
  </action>
  <verify>
  Manual test:

1. Create a reply (auto-inserts @username)
2. Verify @username renders in purple/highlighted
3. Verify @username is tappable (console.log or haptic feedback for now)
4. Manually type additional @mentions in comment - verify they also highlight
   </verify>
   <done>MentionText component parses and renders @mentions as highlighted tappable text, integrated into CommentRow</done>
   </task>

<task type="auto">
  <name>Task 2: Implement scroll-to-comment and highlight animation on @mention tap</name>
  <files>src/components/comments/CommentsBottomSheet.js, src/components/comments/CommentWithReplies.js, src/components/comments/CommentRow.js, src/hooks/useComments.js, src/styles/CommentsBottomSheet.styles.js</files>
  <action>
**useComments.js:**
- Add state: `highlightedCommentId` (string or null)
- Add function: `highlightComment(commentId)` - sets highlightedCommentId, auto-clears after 1.5s
- Export highlightedCommentId and highlightComment

**CommentsBottomSheet.js:**

1. Add `flatListRef` (already exists) for scroll control
2. Add `handleMentionPress(username, mentionedCommentId)` callback:
   - If mentionedCommentId exists: find index of that comment in threadedComments (search both top-level and replies)
   - If not found by ID, search by username (first comment by that user)
   - Call flatListRef.scrollToIndex with found index
   - Call highlightComment(commentId) from useComments
   - Add Haptics feedback
3. Pass handleMentionPress down through CommentWithReplies to CommentRow to MentionText
4. Handle scrollToIndex failure (item not yet rendered) with scrollToIndex onScrollToIndexFailed prop

**CommentWithReplies.js:**

- Accept and pass through onMentionPress prop to CommentRow for both parent and reply comments
- Also expand replies section if the highlighted comment is a reply that's currently hidden

**CommentRow.js:**

- Accept onMentionPress prop, pass to MentionText
- Add highlight animation when comment.id matches highlightedCommentId:
  - Animated.View wrapper around the comment container
  - backgroundColor interpolation: transparent -> rgba(purple, 0.2) -> transparent over 1.5s
  - Use Animated.sequence or timing with delay

**Styles:**

- Add highlightedComment style with subtle purple background
- Ensure animation looks smooth (consider using react-native-reanimated if needed, but Animated should work)

**Edge cases:**

- If comment is in collapsed replies section, auto-expand that section before scrolling
- If comment not found, show no feedback (silent fail for manual @mentions to non-existent users)
- Disable scroll-to for own comments (prevent circular scroll if replying to self)
  </action>
  <verify>
  Test flow:

1. Create reply to a comment (auto @mention inserted)
2. View the reply in the thread
3. Tap the @mention in the reply
4. Verify: smooth scroll to the referenced comment
5. Verify: brief purple highlight animation on the referenced comment
6. Verify: highlight fades after ~1.5s
7. Test with collapsed replies - should auto-expand if needed
   </verify>
   <done>Tapping @mention scrolls comment list to referenced comment with smooth highlight animation, works for both top-level and reply comments</done>
   </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] @mentions in comment text render with purple highlight
- [ ] Tapping @mention triggers scroll to referenced comment
- [ ] Referenced comment briefly highlights with purple glow/background
- [ ] Highlight animation fades after ~1.5s
- [ ] Works for replies in collapsed sections (auto-expands)
- [ ] No crashes when tapping @mention for non-existent comment
- [ ] No TypeScript/ESLint errors
- [ ] App builds and runs without crashes
</verification>

<success_criteria>

- @mentions render as purple highlighted text throughout comment thread
- Tapping @mention scrolls to and highlights the referenced comment
- Highlight animation is subtle and temporary (~1.5s)
- Collapsed reply sections expand when scroll target is inside
- Phase 17 complete - nested reply comments fully functional
  </success_criteria>

<output>
After completion, create `.planning/phases/17-nested-reply-comments/17-02-SUMMARY.md`:

Include:

- Summary of @mention parsing approach
- Details of scroll-to implementation
- Any edge cases handled
- Phase 17 complete status
  </output>
