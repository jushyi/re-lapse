---
phase: 17-nested-reply-comments
plan: 01
type: execute
---

<objective>
Enable replying to any comment (including replies) with auto-inserted @mention prefix.

Purpose: Transform the comment system to support Instagram-style threaded replies where replying to a reply auto-inserts the @username for conversation context while keeping the flat visual structure.
Output: Users can tap Reply on any comment, @username is auto-inserted, and the reply appears under the original thread.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-nested-reply-comments/17-CONTEXT.md

# Key files for this phase:

@src/services/firebase/commentService.js
@src/hooks/useComments.js
@src/components/comments/CommentWithReplies.js
@src/components/comments/CommentRow.js
@src/components/comments/CommentInput.js
@src/styles/CommentRow.styles.js

**Established patterns:**

- Comments use parentId for single-level threading (null = top-level, id = reply)
- useComments hook manages reply state via replyingTo/setReplyingTo
- CommentInput shows "Replying to @name" banner when replyingTo is set
- CommentRow has Reply button (currently only on top-level via isTopLevel prop)

**Current limitation being addressed:**

- commentService.addComment blocks replies to replies (lines 109-114)
- CommentWithReplies passes onReply={null} for reply comments (line 103)
- CommentRow only shows Reply when isTopLevel=true (lines 198-205)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Update commentService to support reply-to-reply with mentionedCommentId</name>
  <files>src/services/firebase/commentService.js</files>
  <action>
Modify addComment function to:
1. Remove the restriction that prevents replies to replies (lines 109-114 check if parentData.parentId exists)
2. When replying to a reply: use the ORIGINAL parent's ID as parentId (keep flat threading structure), store the reply's ID as new field `mentionedCommentId`
3. When replying to a top-level comment: parentId = that comment's ID, mentionedCommentId = same ID
4. Add mentionedCommentId to the comment document data structure

The goal: All replies appear under the same top-level parent visually, but mentionedCommentId tracks which specific comment was replied to (enables scroll-to in Plan 02).

Update the addComment function signature to accept optional mentionedCommentId parameter.

Logic:

- If parentId is provided and that comment has a parentId (it's a reply), use that parent's parentId as the new comment's parentId
- Set mentionedCommentId to the comment being replied to (the one user tapped Reply on)

Also update JSDocs to document the new field.
</action>
<verify>
Review the modified function logic:

- Replying to top-level: parentId = top-level ID, mentionedCommentId = top-level ID
- Replying to reply: parentId = reply's parentId (original thread), mentionedCommentId = reply's ID
  </verify>
  <done>commentService.addComment accepts replies to any comment, maintains flat thread structure via parentId, tracks specific replied-to comment via mentionedCommentId</done>
  </task>

<task type="auto">
  <name>Task 2: Enable Reply button on replies and auto-insert @username</name>
  <files>src/components/comments/CommentWithReplies.js, src/components/comments/CommentRow.js, src/components/comments/CommentInput.js, src/hooks/useComments.js, src/styles/CommentRow.styles.js</files>
  <action>
**CommentWithReplies.js:**
- Pass onReply to CommentRow for reply items (currently passes null on line 103)
- The reply callback should pass the reply comment object

**CommentRow.js:**

- Remove isTopLevel condition for Reply button (show on all comments)
- Keep the Reply button styling consistent (same position/style as top-level)

**CommentInput.js:**

- Add new prop `initialMention` (string, optional) - the @username to pre-fill
- When initialMention changes (and is non-empty), set text to `@${initialMention} ` with trailing space
- The "Replying to @name" banner can remain for visual context OR be removed (user's call - keep it for now as it reinforces the reply action)

**useComments.js:**

- Update handleAddComment to pass mentionedCommentId to the service
- When replyingTo is a reply (has parentId), pass mentionedCommentId = replyingTo.id
- When replyingTo is top-level, pass mentionedCommentId = replyingTo.id
- Update setReplyingTo to also set an initialMention value based on replyingTo.user.username

- Add new state: `initialMention` (string or null)
- When setReplyingTo is called with a comment, set initialMention to that user's username
- Export initialMention from the hook
- Clear initialMention when reply is submitted or cancelled

**CommentsBottomSheet.js:**

- Pass initialMention from useComments to CommentInput
  </action>
  <verify>
  Test flow:

1. Tap Reply on a TOP-LEVEL comment:
   - Banner shows "Replying to @name"
   - Input pre-fills with "@username "
   - Submitted comment appears as reply under that thread
2. Tap Reply on a REPLY comment:
   - Banner shows "Replying to @name"
   - Input pre-fills with "@username "
   - Submitted comment appears under SAME thread (flat structure)
     </verify>
     <done>Reply button visible on all comments, tapping Reply auto-inserts @username into input, replies to replies maintain flat thread structure</done>
     </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Can tap Reply on top-level comment, @username appears in input
- [ ] Can tap Reply on reply comment, @username appears in input
- [ ] Reply to reply appears under same parent thread (not nested deeper)
- [ ] mentionedCommentId is stored in Firestore for new replies
- [ ] No TypeScript/ESLint errors
- [ ] App builds and runs without crashes
</verification>

<success_criteria>

- Reply button visible on ALL comments (top-level and replies)
- Tapping Reply auto-inserts @username at start of input with trailing space
- Replies to replies use original thread's parentId (flat visual structure)
- mentionedCommentId field stored for scroll-to functionality (Plan 02)
- Existing reply functionality unchanged for top-level replies
  </success_criteria>

<output>
After completion, create `.planning/phases/17-nested-reply-comments/17-01-SUMMARY.md`
</output>
