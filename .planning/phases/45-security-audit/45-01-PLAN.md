---
phase: 45-security-audit
plan: 01
type: execute
---

<objective>
Harden Firebase Security Rules (Storage and Firestore) to close access control gaps discovered during security audit.

Purpose: Fix critical vulnerabilities where profile photos are publicly readable without authentication, all photos in Storage are accessible to any authenticated user (bypassing Firestore access controls), and comment/like subcollections are readable regardless of parent photo access restrictions.
Output: Updated storage.rules and firestore.rules with proper access controls, file type validation, and size limits.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-security-audit/45-CONTEXT.md
@storage.rules
@firestore.rules

**Constraining decisions:**

- Phase 23: Firestore rules hardened with self-reaction prevention, immutable field protection, friendship accept restrictions
- Phase 21: Blocks + reports collections added to Firestore rules

**Critical findings from security audit:**

1. CRITICAL: storage.rules line 16 — `allow read: if true` on profile-photos makes ALL profile photos publicly accessible without ANY authentication
2. CRITICAL: storage.rules line 22 — `allow read: if isAuthenticated()` on photos/ lets ANY authenticated user access ANY user's photos, completely bypassing Firestore's friend/owner/journal access controls
3. HIGH: firestore.rules line 155 — Comments subcollection `allow read: if isAuthenticated()` lets any user read comments on photos they can't access (breaks access hierarchy)
4. HIGH: firestore.rules line 182 — Same issue for likes subcollection
5. MEDIUM: storage.rules — Missing file type validation on profile-photos and photos uploads (comment-images already validates)
6. MEDIUM: storage.rules — Missing file size limits on profile-photos and photos (comment-images already has 5MB limit)
7. LOW: firestore.rules lines 292-306 — photoViews collection rules defined but collection not used anywhere in codebase
8. LOW: firestore.rules line 283 — Album updates lack field-level restrictions (owner can change userId field)
   </context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Storage security rules</name>
  <files>storage.rules</files>
  <action>
Fix three critical issues in storage.rules:

1. **Profile photos** (line 15-18): Change `allow read: if true` to `allow read: if isAuthenticated()`. Profile photos should require authentication — the app only displays them to logged-in users anyway. Public access means anyone with a direct URL can view user photos without an account.

2. **Main photos** (line 21-24): Change `allow read: if isAuthenticated()` to `allow read: if isAuthenticated() && isOwner(userId)`. Only the photo owner should be able to read directly from Storage. Other users access photos through the app's Firestore-controlled flows. Note: Cloud Functions use Admin SDK which bypasses these rules, so getSignedPhotoUrl still works for authorized access.

3. **Add file type validation**: Add `request.resource.contentType.matches('image/.*')` to write rules for both profile-photos and photos paths (matching the pattern already used by comment-images).

4. **Add file size limits**: Add `request.resource.size < 10 * 1024 * 1024` (10MB) to write rules for both profile-photos and photos paths. This matches the MAX_PHOTO_SIZE constant in src/utils/validation.js.

Preserve the existing comment-images rules unchanged — they already have proper validation.
Preserve the default deny rule at the bottom.

**What to avoid:** Do NOT add friend-based read access to Storage rules — Firebase Storage rules cannot query Firestore to check friendships. The pattern should be: owner reads directly from Storage, friends access via getSignedPhotoUrl Cloud Function (which will get access validation in plan 45-02).
</action>
<verify>Review the updated storage.rules file to confirm: profile-photos requires auth for read, photos requires owner for read, file type validation on all write paths, size limits on all write paths, comment-images unchanged, default deny preserved.</verify>
<done>Storage rules require authentication for profile photo reads, owner-only for main photo reads, file type and size validation on all upload paths.</done>
</task>

<task type="auto">
  <name>Task 2: Fix Firestore security rules</name>
  <files>firestore.rules</files>
  <action>
Fix access control gaps in firestore.rules:

1. **Comment read access** (line 155): Change from `allow read: if isAuthenticated()` to inherit parent photo access restrictions. Replace with:

```
allow read: if isAuthenticated() &&
  (get(/databases/$(database)/documents/photos/$(photoId)).data.userId == request.auth.uid ||
   get(/databases/$(database)/documents/photos/$(photoId)).data.photoState == 'journal' ||
   areFriends(get(/databases/$(database)/documents/photos/$(photoId)).data.userId));
```

This ensures comments are only readable by users who can also read the parent photo (owner, or photo is journal state, or user is friends with photo owner). Note: this adds a Firestore read per comment query — acceptable for security.

2. **Like read access** (line 182): Apply the same restriction as comments. Replace `allow read: if isAuthenticated()` with the same parent-photo access check used for comments.

3. **Album update field protection** (line 283): Change from `allow update: if isOwner(resource.data.userId)` to also restrict which fields can change. The userId and createdAt fields should be immutable:

```
allow update: if isOwner(resource.data.userId) &&
  !request.resource.data.diff(resource.data).affectedKeys().hasAny(['userId', 'createdAt']);
```

4. **Remove unused photoViews rules** (lines 289-306): Delete the entire photoViews match block and its header comment. This collection is not used anywhere in the codebase — keeping rules for non-existent collections creates maintenance confusion. If the feature is needed later, rules can be re-added.

**What to avoid:** Do NOT change the users collection read rule (`allow read: if isAuthenticated()`) — this is intentional for friend search functionality. Do NOT modify the existing notification, friendship, block, or report rules — they were already hardened in Phase 23.
</action>
<verify>Review updated firestore.rules to confirm: comment read checks parent photo access, like read checks parent photo access, album update has immutable field protection, photoViews block removed, all other rules unchanged.</verify>
<done>Firestore rules enforce comment/like read access matches parent photo restrictions, album updates protect immutable fields, unused photoViews rules removed.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] storage.rules has no `if true` read access
- [ ] storage.rules photos require owner for direct read
- [ ] storage.rules all write paths validate content type and size
- [ ] firestore.rules comments require parent photo access
- [ ] firestore.rules likes require parent photo access
- [ ] firestore.rules album update protects userId and createdAt
- [ ] firestore.rules photoViews block removed
- [ ] Default deny rules preserved in both files
- [ ] No unintended changes to other rules
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No syntax errors in rules files
- Storage rules close the public access and cross-user access vulnerabilities
- Firestore rules enforce comment/like access hierarchy
  </success_criteria>

<output>
After completion, create `.planning/phases/45-security-audit/45-01-SUMMARY.md`
</output>
