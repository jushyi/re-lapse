---
phase: 35-social-notification-events
plan: 02
type: execute
---

<objective>
Add missing notification triggers (friend acceptance, @mentions) and respect user notification preferences in all Cloud Functions.

Purpose: Complete the social notification coverage so users are notified of all relevant social activity, while respecting their preferences.
Output: Two new notification triggers + all notification functions check user preferences before sending.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-social-notification-events/35-CONTEXT.md

**Key files:**
@functions/index.js
@functions/validation.js

**Existing Cloud Functions for notifications:**

- sendPhotoRevealNotification (darkroom onUpdate)
- sendFriendRequestNotification (friendship onCreate, status=pending)
- sendReactionNotification (photo onUpdate, reactions changed)
- sendCommentNotification (comment onCreate)

**Notification preference schema (from Plan 35-01):**

```javascript
notificationPreferences: {
  enabled: true,        // Master toggle
  likes: true,          // Reaction notifications
  comments: true,       // Comment notifications
  follows: true,        // Friend accepted notifications
  friendRequests: true, // Friend request notifications
  mentions: true,       // @mention notifications
}
```

**Friendship document structure:**

- status: 'pending' | 'accepted'
- requestedBy: userId who sent request
- user1Id, user2Id: alphabetically ordered
- acceptedAt: timestamp (set when accepted)

**Comment text format for mentions:**

- @username patterns in comment.text field
- Need to parse and match against user documents
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Add sendFriendAcceptedNotification Cloud Function</name>
  <files>functions/index.js</files>
  <action>
Add new Cloud Function triggered on friendship document update:

```javascript
exports.sendFriendAcceptedNotification = functions.firestore
  .document('friendships/{friendshipId}')
  .onUpdate(async (change, context) => {
    // Implementation
  });
```

Logic:

1. Check if status changed from 'pending' to 'accepted' (before.status !== after.status && after.status === 'accepted')
2. Get the original requester (requestedBy field) - they are the recipient of this notification
3. Check recipient's notificationPreferences.enabled AND notificationPreferences.follows (if either false, skip)
4. Get acceptor's display name (the other user who accepted)
5. Send push notification:
   - Title: "ðŸŽ‰ Friend Request Accepted"
   - Body: "{acceptorName} accepted your friend request"
   - Data: { type: 'friend_accepted', friendshipId }
6. Write to notifications collection for in-app display

Add guards for:

- Invalid document data
- Missing user IDs
- No FCM token

Follow existing patterns from sendFriendRequestNotification.
</action>
<verify>firebase deploy --only functions succeeds, check Firebase Functions logs</verify>
<done>sendFriendAcceptedNotification function deployed, triggers on friendship acceptance</done>
</task>

<task type="auto">
  <name>Task 2: Add @mention notifications and preference checks</name>
  <files>functions/index.js</files>
  <action>
Two changes to make:

**A. Add @mention notification to sendCommentNotification:**

After sending the comment notification to photo owner, parse comment.text for @mentions:

1. Extract @mentions: `const mentions = (comment.text || '').match(/@(\w+)/g) || []`
2. For each unique username (strip @ prefix):
   - Query users collection for matching username (case-insensitive)
   - Skip if mentioned user is commenter (don't self-notify)
   - Skip if mentioned user is photo owner (already notified above)
   - Check mentioned user's notificationPreferences.enabled AND notificationPreferences.mentions
   - Send push notification:
     - Title: "ðŸ’¬ You were mentioned"
     - Body: "{commenterName} mentioned you in a comment"
     - Data: { type: 'mention', photoId, commentId }
   - Write to notifications collection

**B. Add preference checks to ALL existing notification functions:**

Create helper function:

```javascript
async function shouldSendNotification(userId, notificationType) {
  const userDoc = await admin.firestore().collection('users').doc(userId).get();
  if (!userDoc.exists) return false;

  const prefs = userDoc.data().notificationPreferences || {};
  // Default to true if preferences not set
  const masterEnabled = prefs.enabled !== false;
  const typeEnabled = prefs[notificationType] !== false;

  return masterEnabled && typeEnabled;
}
```

Update these functions to check preferences:

- sendFriendRequestNotification: check 'friendRequests' preference
- sendReactionNotification: check 'likes' preference
- sendCommentNotification: check 'comments' preference (for photo owner notification)

Note: sendPhotoRevealNotification should NOT check preferences - users always want their own photo reveals.

Pattern: Early return if shouldSendNotification returns false.
</action>
<verify>firebase deploy --only functions succeeds, test by commenting with @mention</verify>
<done>@mention notifications sent to mentioned users, all social notifications respect user preferences</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `firebase deploy --only functions` succeeds without errors
- [ ] sendFriendAcceptedNotification appears in Firebase Console > Functions
- [ ] Friend acceptance triggers notification to requester
- [ ] @mention in comment triggers notification to mentioned user
- [ ] Disabling master toggle stops all social notifications
- [ ] Disabling individual type stops only that notification type
- [ ] Photo reveal notifications still work regardless of preferences
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No Cloud Function deployment errors
- Friend acceptance notification works
- @mention notification works
- User preferences respected in all social notification functions
- Phase 35 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/35-social-notification-events/35-02-SUMMARY.md`
</output>
