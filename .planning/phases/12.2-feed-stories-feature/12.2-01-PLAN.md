---
phase: 12.2-feed-stories-feature
plan: 01
type: execute
domain: react-native
---

<objective>
Extend feedService with functions to fetch friend stories data and top photos by engagement.

Purpose: Provide the data layer needed for the Stories UI - aggregated friend data with their photos ranked by engagement.
Output: Two new service functions (`getTopPhotosByEngagement`, `getFriendStoriesData`) ready for UI consumption.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary-format.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12.1-friends-list-screen-crash-fix/12.1-01-SUMMARY.md

# Codebase context
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/STACK.md

# Key source files
@src/services/firebase/feedService.js
@src/services/firebase/friendshipService.js
@src/hooks/useFeedPhotos.js

**Existing patterns:**
- feedService uses React Native Firebase modular API
- Error handling returns `{ success: true/false, error: 'message' }`
- Logging via logger utility at debug/info/error levels
- Client-side sorting used throughout (avoids composite indexes)

**Photo data structure:**
```javascript
{
  userId: string,
  imageURL: string,
  capturedAt: timestamp,
  status: 'developing' | 'revealed' | 'triaged',
  photoState: 'journal' | 'archive',
  reactions: { [userId]: { [emoji]: count } },
  reactionCount: number  // Total engagement metric
}
```

**Note:** The roadmap mentions "comments + reactions" but no comments system exists. Use `reactionCount` as the engagement metric.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getTopPhotosByEngagement function</name>
  <files>src/services/firebase/feedService.js</files>
  <action>
Add a new function `getTopPhotosByEngagement(userId, limit = 5)` that:
1. Queries photos where `userId` matches and `photoState == 'journal'` (only feed-visible photos)
2. Fetches all matching photos (don't use Firestore orderBy to avoid index requirement)
3. Sorts client-side by `reactionCount` descending (highest engagement first)
4. Returns top N photos (default 5)
5. Returns `{ success: true, photos: [...] }` or `{ success: false, error: 'message' }`

Use existing logging patterns. Match the style of `getUserFeedPhotos()`.

Important: Only include photos with `photoState == 'journal'` - archive photos should not appear in stories.
  </action>
  <verify>
Function exists in feedService.js with proper logging. Can be imported and called.
Manually test: Import in useFeedPhotos or create temp test to verify query returns photos sorted by reactionCount.
  </verify>
  <done>
- Function `getTopPhotosByEngagement(userId, limit)` exported from feedService
- Returns photos sorted by reactionCount DESC
- Handles errors gracefully with proper logging
  </done>
</task>

<task type="auto">
  <name>Task 2: Add getFriendStoriesData function</name>
  <files>src/services/firebase/feedService.js</files>
  <action>
Add a new function `getFriendStoriesData(currentUserId)` that:
1. Gets friend IDs using existing `getFriendUserIds(currentUserId)` from friendshipService
2. For each friend, fetches:
   - User profile data (username, displayName, profilePhotoURL) from users collection
   - Top 5 photos by engagement using `getTopPhotosByEngagement(friendId, 5)`
3. Returns array of friend story objects:
   ```javascript
   {
     userId: string,
     username: string,
     displayName: string,
     profilePhotoURL: string,
     topPhotos: [...],  // Top 5 photos sorted by engagement
     totalPhotoCount: number,  // Total journal photos (for badge display)
     hasPhotos: boolean  // Quick check if friend has any photos
   }
   ```
4. Sort friends by most recent photo (capturedAt of their top photo) or alphabetically if no photos
5. Filter out friends with zero photos (hasPhotos: false)
6. Return `{ success: true, friendStories: [...] }` or `{ success: false, error: 'message' }`

Use Promise.all for parallel fetching of friend data to optimize performance.

Import `getFriendUserIds` from friendshipService at top of file.
  </action>
  <verify>
Function exists and is exported. Returns aggregated friend data with photos.
Test manually: Call with current user ID, verify friends with photos appear in result.
  </verify>
  <done>
- Function `getFriendStoriesData(currentUserId)` exported from feedService
- Returns friend profiles with their top 5 photos by engagement
- Friends without photos filtered out
- Parallel fetching for performance
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `getTopPhotosByEngagement` function exists and is exported
- [ ] `getFriendStoriesData` function exists and is exported
- [ ] Both functions have proper logging (debug entry, info success, error failure)
- [ ] Both functions return standardized `{ success, data/error }` objects
- [ ] No TypeScript/syntax errors in feedService.js
- [ ] App still builds: `npx expo start` runs without crashing
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Service layer ready for Stories UI components
- No breaking changes to existing feed functionality
</success_criteria>

<output>
After completion, create `.planning/phases/12.2-feed-stories-feature/12.2-01-SUMMARY.md`
</output>
