---
phase: 12.2-feed-stories-feature
plan: 03
type: execute
domain: react-native
---

<objective>
Create the StoriesViewerModal - full-screen photo viewer with horizontal swipe navigation between photos.

Purpose: Build the core Stories viewing experience where users swipe through a friend's photos with Instagram-style navigation.
Output: Full-screen modal with horizontal paging, progress indicators, and gesture-based navigation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary-format.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12.2-feed-stories-feature/12.2-01-SUMMARY.md
@.planning/phases/12.2-feed-stories-feature/12.2-02-SUMMARY.md

# Codebase context
@.planning/codebase/CONVENTIONS.md

# Key source files - REUSE PATTERNS FROM THESE
@src/components/PhotoDetailModal.js
@src/screens/FeedScreen.js
@src/components/index.js

**Patterns to reuse from PhotoDetailModal:**
- Modal with full-screen black background
- Animated opacity for fade in/out
- PanResponder for swipe gestures
- Profile photo overlay positioning
- Close button (X) at top right
- User info (name + timestamp) positioning

**New patterns needed for Stories:**
- Horizontal paging (swipe left/right to change photos)
- Progress bar at top showing photo position (segmented bar)
- Auto-advance timer (optional, can skip for MVP)
- Tap left/right sides to navigate
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StoriesViewerModal component</name>
  <files>src/components/StoriesViewerModal.js, src/components/index.js</files>
  <action>
Create `StoriesViewerModal.js` - a full-screen modal for viewing friend's photos as stories:

**Props:**
```javascript
{
  visible: boolean,
  onClose: () => void,
  friend: {
    userId: string,
    displayName: string,
    profilePhotoURL: string,
    topPhotos: [...]
  },
  onPhotoChange: (photo) => void  // Optional callback when photo changes
}
```

**Core Structure:**
1. Use Modal from react-native with transparent background
2. Animated.View wrapper for fade in/out transitions
3. Full-screen container with black background

**Header (top):**
1. Progress bar showing current position (horizontal segmented bar)
   - One segment per photo, current segment highlighted
   - Container at top with paddingTop for safe area
   - Each segment: height 2-3px, white/gray colors
2. Friend info row below progress bar:
   - Small profile photo (32x32 circular)
   - Display name (white, bold)
   - Time ago (gray, smaller font)
   - Close button (X) at far right

**Photo Display (center):**
1. Current photo fills most of screen
2. Use Image component with resizeMode="contain"
3. Track current index in state: `const [currentIndex, setCurrentIndex] = useState(0)`

**Navigation:**
1. Tap left 30% of screen → go to previous photo
2. Tap right 30% of screen → go to next photo
3. Tap center 40% → do nothing (future: pause auto-advance)
4. When at first photo and tap left → close modal
5. When at last photo and tap right → close modal

Implementation:
```javascript
const handleTap = (event) => {
  const { locationX } = event.nativeEvent;
  const screenWidth = Dimensions.get('window').width;

  if (locationX < screenWidth * 0.3) {
    // Left tap - previous
    if (currentIndex === 0) {
      onClose();
    } else {
      setCurrentIndex(prev => prev - 1);
    }
  } else if (locationX > screenWidth * 0.7) {
    // Right tap - next
    if (currentIndex === friend.topPhotos.length - 1) {
      onClose();
    } else {
      setCurrentIndex(prev => prev + 1);
    }
  }
};
```

**Swipe-down-to-close:**
1. Reuse PanResponder pattern from PhotoDetailModal
2. Swipe down dismisses modal with fade animation
3. Threshold: 100px vertical or velocity > 0.5

**Styles:**
- Match PhotoDetailModal dark theme
- Progress bar segments: white for viewed/current, gray for remaining
- Safe area handling for notch devices

Export from components/index.js barrel file.
  </action>
  <verify>
Component renders without errors when visible=true.
Modal displays full-screen with photo, progress bar, and friend info.
Import works from components/index.js.
  </verify>
  <done>
- StoriesViewerModal component created with full-screen layout
- Progress bar shows current photo position
- Friend info header with close button
- Photo display fills screen
- Exported from components/index.js
  </done>
</task>

<task type="auto">
  <name>Task 2: Add navigation gestures and integrate with FeedScreen</name>
  <files>src/components/StoriesViewerModal.js, src/screens/FeedScreen.js</files>
  <action>
**In StoriesViewerModal.js:**

1. Implement tap navigation (if not done in Task 1):
   - Wrap photo in TouchableWithoutFeedback
   - Handle left/right/center tap zones
   - Log navigation: `logger.debug('StoriesViewer: Navigating', { direction, newIndex })`

2. Implement swipe-down-to-close:
   - PanResponder setup for vertical gestures
   - Animated translateY for drag feedback
   - Close modal when threshold exceeded

3. Add haptic feedback:
   - Light impact when changing photos
   - Medium impact when closing
   ```javascript
   import * as Haptics from 'expo-haptics';
   Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
   ```

4. Reset state when modal opens with new friend:
   ```javascript
   useEffect(() => {
     if (visible) {
       setCurrentIndex(0);
     }
   }, [visible, friend?.userId]);
   ```

**In FeedScreen.js:**

1. Add state for stories viewer:
   ```javascript
   const [storiesModalVisible, setStoriesModalVisible] = useState(false);
   const [selectedFriend, setSelectedFriend] = useState(null);
   ```

2. Update handleOpenStories:
   ```javascript
   const handleOpenStories = (friend) => {
     logger.info('FeedScreen: Opening stories viewer', { friendId: friend.userId });
     setSelectedFriend(friend);
     setStoriesModalVisible(true);
   };

   const handleCloseStories = () => {
     setStoriesModalVisible(false);
     setSelectedFriend(null);
   };
   ```

3. Add StoriesViewerModal to render:
   ```jsx
   <StoriesViewerModal
     visible={storiesModalVisible}
     onClose={handleCloseStories}
     friend={selectedFriend}
   />
   ```

4. Import StoriesViewerModal from components
  </action>
  <verify>
- Tapping friend card opens StoriesViewerModal
- Tap left/right sides navigates between photos
- Swipe down closes modal
- Progress bar updates as photos change
- Haptic feedback fires on navigation
- Modal closes when reaching end of photos
  </verify>
  <done>
- Tap navigation working (left/right zones)
- Swipe-down-to-close working
- StoriesViewerModal integrated with FeedScreen
- Haptic feedback on navigation
- State resets properly on open/close
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Full-screen Stories viewer with horizontal navigation and gestures</what-built>
  <how-to-verify>
    1. Run: `npx expo start` and open on device
    2. Navigate to Feed tab
    3. Tap a friend's story card in the stories row
    4. Verify: Full-screen modal opens with friend's photo
    5. Verify: Progress bar at top shows current position
    6. Verify: Friend info (name, avatar) visible in header
    7. Verify: Tap right side of screen → goes to next photo
    8. Verify: Tap left side → goes to previous photo
    9. Verify: Swipe down → closes modal with animation
    10. Verify: At last photo, tap right → closes modal
    11. Verify: Haptic feedback fires when navigating
    12. Verify: Close button (X) works
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] StoriesViewerModal component created and exported
- [ ] Tap navigation works (left/right zones)
- [ ] Swipe-down-to-close works
- [ ] Progress bar updates with photo changes
- [ ] Modal integrated with FeedScreen
- [ ] Haptic feedback on navigation
- [ ] App builds without errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verification approved
- Stories viewer feels native and responsive
- Gestures match Instagram Stories experience
</success_criteria>

<output>
After completion, create `.planning/phases/12.2-feed-stories-feature/12.2-03-SUMMARY.md`
</output>
