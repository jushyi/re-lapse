---
phase: 12.2-feed-stories-feature
plan: 04
type: execute
domain: react-native
---

<objective>
Modify the main feed to show curated top 5 photos per friend ranked by engagement, and polish the complete Stories feature.

Purpose: Complete the Feed Stories feature by curating the feed content and adding polish touches.
Output: Main feed shows top 5 photos from each friend (by engagement), complete Stories feature working end-to-end.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary-format.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12.2-feed-stories-feature/12.2-01-SUMMARY.md
@.planning/phases/12.2-feed-stories-feature/12.2-02-SUMMARY.md
@.planning/phases/12.2-feed-stories-feature/12.2-03-SUMMARY.md

# Codebase context
@.planning/codebase/CONVENTIONS.md

# Key source files
@src/screens/FeedScreen.js
@src/hooks/useFeedPhotos.js
@src/services/firebase/feedService.js

**Current feed behavior:**
- Shows ALL journaled photos from friends
- Sorted by capturedAt DESC (most recent first)
- Infinite scroll with pagination

**New feed behavior (per requirements):**
- Shows only TOP 5 photos per friend
- Ranked by engagement (reactionCount)
- Still shows friend context (who posted)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify useFeedPhotos to curate top 5 per friend</name>
  <files>src/hooks/useFeedPhotos.js</files>
  <action>
Modify the useFeedPhotos hook to return curated feed (top 5 photos per friend by engagement):

**Option A - Modify existing fetch logic:**

In the data processing section after fetching photos, add curation:

```javascript
// After fetching all photos, curate to top 5 per friend
const curateTopPhotosPerFriend = (photos, limit = 5) => {
  // Group photos by userId
  const photosByUser = {};
  photos.forEach(photo => {
    if (!photosByUser[photo.userId]) {
      photosByUser[photo.userId] = [];
    }
    photosByUser[photo.userId].push(photo);
  });

  // For each user, sort by reactionCount and take top N
  const curatedPhotos = [];
  Object.values(photosByUser).forEach(userPhotos => {
    // Sort by reactionCount DESC, then capturedAt DESC as tiebreaker
    userPhotos.sort((a, b) => {
      const countDiff = (b.reactionCount || 0) - (a.reactionCount || 0);
      if (countDiff !== 0) return countDiff;
      return b.capturedAt?.seconds - a.capturedAt?.seconds;
    });
    // Take top N
    curatedPhotos.push(...userPhotos.slice(0, limit));
  });

  // Sort final list by reactionCount DESC for overall feed order
  curatedPhotos.sort((a, b) => (b.reactionCount || 0) - (a.reactionCount || 0));

  return curatedPhotos;
};
```

**Integration:**
1. After fetching and processing photos, apply curation:
   ```javascript
   const processedPhotos = curateTopPhotosPerFriend(fetchedPhotos, 5);
   ```
2. This happens BEFORE pagination logic
3. Pagination then works on the curated set

**Note:** This changes feed behavior. If user wants to see ALL photos, they can tap friend's story card to see full history. The main feed becomes a "highlights" view.

Add logging:
```javascript
logger.debug('useFeedPhotos: Curating feed', {
  totalPhotos: fetchedPhotos.length,
  curatedPhotos: processedPhotos.length,
  friendCount: Object.keys(photosByUser).length
});
```
  </action>
  <verify>
Hook still works - feed loads and displays photos.
Feed now shows max 5 photos per friend.
Photos sorted by engagement (most reacted first).
Pagination still works on curated set.
  </verify>
  <done>
- useFeedPhotos hook curates feed to top 5 per friend
- Photos sorted by reactionCount (engagement)
- Existing pagination works with curated data
- Logging added for curation metrics
  </done>
</task>

<task type="auto">
  <name>Task 2: Polish and edge case handling</name>
  <files>src/screens/FeedScreen.js, src/components/StoriesViewerModal.js, src/components/FriendStoryCard.js</files>
  <action>
Add polish and handle edge cases throughout the Stories feature:

**FeedScreen.js:**
1. Refresh stories row when feed refreshes:
   ```javascript
   const refreshFeed = async () => {
     // Existing refresh logic...
     // Also refresh stories:
     const storiesResult = await getFriendStoriesData(user.uid);
     if (storiesResult.success) {
       setFriendStories(storiesResult.friendStories);
     }
   };
   ```

2. Empty state for stories row (when no friends have photos):
   - Don't show stories row at all (already handled)
   - Or show subtle message: "No stories from friends yet"

3. Error handling for stories fetch:
   ```javascript
   if (!result.success) {
     logger.warn('FeedScreen: Failed to load stories', { error: result.error });
   }
   ```

**StoriesViewerModal.js:**
1. Handle case where friend has no photos (shouldn't happen but defensive):
   ```javascript
   if (!friend?.topPhotos?.length) {
     onClose();
     return null;
   }
   ```

2. Add loading state for images:
   - Show placeholder/skeleton while image loads
   - Use Image onLoad callback to track loading

3. Preload next image for smoother transitions:
   ```javascript
   useEffect(() => {
     if (currentIndex < friend.topPhotos.length - 1) {
       Image.prefetch(friend.topPhotos[currentIndex + 1].imageURL);
     }
   }, [currentIndex]);
   ```

4. Show photo timestamp in header:
   - Use getTimeAgo from timeUtils for consistent formatting

**FriendStoryCard.js:**
1. Handle missing profile photo gracefully:
   - Show first letter of displayName as fallback
   - Use colored background based on userId hash for variety

2. Add subtle animation on tap:
   - Scale down slightly on press (activeOpacity or Animated)
  </action>
  <verify>
- Stories row refreshes with feed
- Edge cases handled (no photos, missing profile photo)
- Image preloading works (smoother transitions)
- Photo timestamps show in viewer
- No crashes on edge cases
  </verify>
  <done>
- Stories row refreshes with feed pull-to-refresh
- Edge cases handled gracefully
- Image preloading for smoother navigation
- Photo timestamps displayed
- Polish animations added
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Feed Stories feature with curated feed and polish</what-built>
  <how-to-verify>
    1. Run: `npx expo start` and open on device
    2. Navigate to Feed tab

    **Test curated feed:**
    3. Verify: Feed shows max 5 photos per friend
    4. Verify: Photos sorted by engagement (most reacted first)
    5. Verify: If a friend has 10 photos, only top 5 by reactions shown

    **Test stories integration:**
    6. Verify: Stories row at top shows friends with photos
    7. Verify: Tapping friend opens StoriesViewerModal
    8. Verify: Full Stories viewer works (swipe, tap navigation)
    9. Verify: Progress bar shows position correctly

    **Test refresh:**
    10. Pull-to-refresh on feed
    11. Verify: Both feed and stories row refresh

    **Test edge cases:**
    12. Friend with no profile photo shows initials
    13. Very long display names truncate properly
    14. Stories viewer handles photos loading gracefully

    **Overall UX:**
    15. Confirm: Feature feels Instagram Stories-like
    16. Confirm: Transitions are smooth
    17. Confirm: No visual glitches or crashes
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Feed curated to top 5 photos per friend
- [ ] Photos sorted by engagement
- [ ] Stories row refreshes with feed
- [ ] Edge cases handled gracefully
- [ ] Image preloading implemented
- [ ] Polish touches added
- [ ] App builds without errors
- [ ] No regressions in existing functionality
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verification approved
- Complete Feed Stories feature working end-to-end
- Phase 12.2 complete, ready for Phase 13
</success_criteria>

<output>
After completion, create `.planning/phases/12.2-feed-stories-feature/12.2-04-SUMMARY.md`:

# Phase 12.2 Plan 04: Feed Curation & Polish Summary

**Feed Stories feature complete with curated top 5 per friend feed and polished Stories viewer**

## Accomplishments
- Feed now shows top 5 photos per friend ranked by engagement
- Stories row refreshes with feed pull-to-refresh
- Edge cases handled (missing photos, missing avatars)
- Image preloading for smooth transitions
- Complete Instagram Stories-style experience

## Files Modified
- `src/hooks/useFeedPhotos.js` - Added feed curation logic
- `src/screens/FeedScreen.js` - Stories refresh integration
- `src/components/StoriesViewerModal.js` - Polish and preloading
- `src/components/FriendStoryCard.js` - Fallback avatar handling

## Phase 12.2 Complete
Total: 4 plans, ~8 tasks
Feature: Feed Stories with curated feed, friend story cards, and full-screen viewer

## Next Step
Phase 13: Production Build & Branding - EAS build setup, app icon, TestFlight prep
</output>
