---
phase: 23-firestore-security-rules-audit
plan: 01
type: execute
---

<objective>
Harden Firestore Security Rules to prevent self-reactions, enforce reaction authenticity, protect immutable fields, and tighten friendship update logic.

Purpose: Close security gaps identified in research - users should not be able to react to their own photos, spoof other users' reactions, or modify critical fields after creation.
Output: Updated firestore.rules with comprehensive protection, verified to not break existing app functionality.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-firestore-security-rules-audit/23-RESEARCH.md
@.planning/phases/23-firestore-security-rules-audit/23-CONTEXT.md
@.planning/phases/22-environment-configuration/22-01-SUMMARY.md

# Key files to modify:

@firestore.rules

**Tech stack available:** Firebase Security Rules v2
**Established patterns:** Helper functions (isAuthenticated, isOwner, isFriendshipMember, etc.)

**Constraining decisions from research:**

- Use affectedKeys() and unchangedKeys() for field change validation
- Self-reaction prevention: request.auth.uid != resource.data.userId
- Reaction authenticity: Only user's own key in reactions map should change
- exists() checks are costly (1 read each) - use sparingly

**Boundaries from CONTEXT.md:**

- No rate limiting implementation
- No Cloud Functions changes
- Audit and harden, not redesign
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Harden photo rules with reaction validation and immutable fields</name>
  <files>firestore.rules</files>
  <action>
Update the photos collection rules to:

1. Add helper function `onlyChangesReactionFields()`:
   - Use affectedKeys() to check only 'reactions' and 'reactionCount' changed
   - Returns true if no other fields affected

2. Add helper function `immutablePhotoFieldsUnchanged()`:
   - Use unchangedKeys().hasAll() to ensure 'userId', 'capturedAt', 'imageURL' never change
   - Protects core photo identity

3. Split photo update rule into two cases:
   a) Owner updates (full access except immutable fields):
   - isOwner(resource.data.userId)
   - immutablePhotoFieldsUnchanged()

   b) Non-owner reaction updates (friends adding reactions):
   - isAuthenticated()
   - request.auth.uid != resource.data.userId (SELF-REACTION PREVENTION)
   - onlyChangesReactionFields()
   - Note: Skip areFriendsAccepted() check for now - client-side filtering is acceptable per CONTEXT.md

Keep existing read rules (owner + journaled photos visible to authenticated users).

WHY these changes matter:

- Self-reaction prevention enforces business logic at DB level
- Immutable fields prevent data corruption attacks
- Split update rules clearly separate owner vs reactor permissions
  </action>
  <verify>

1. Read the updated firestore.rules and verify:
   - onlyChangesReactionFields() helper exists
   - immutablePhotoFieldsUnchanged() helper exists
   - Photo update rule has two distinct allow clauses
   - Self-reaction check (request.auth.uid != resource.data.userId) present
     </verify>
     <done>

- Photo update rules have self-reaction prevention
- Immutable field protection on userId, capturedAt, imageURL
- Helper functions reusable for future rules
  </done>
  </task>

<task type="auto">
  <name>Task 2: Harden friendship and notification rules</name>
  <files>firestore.rules</files>
  <action>
Update friendship rules to be more precise:

1. Tighten friendship update rule:
   - Only recipient (NOT requester) can accept: resource.data.requestedBy != request.auth.uid
   - When accepting, only allow status and acceptedAt to change (use affectedKeys().hasOnly())
   - Remove the overly permissive "Or update other friendship data if they're a member" clause

2. Update notification update rule:
   - Add affectedKeys().hasOnly(['read', 'readAt']) to prevent modifying other fields
   - Users should only mark notifications as read, not modify content

Keep existing create, read, delete rules unchanged for both collections.

WHY these changes matter:

- Prevents requester from accepting their own request (forces recipient confirmation)
- Field-level update restrictions prevent data tampering
- Notification integrity ensures Cloud Functions remain authoritative source
  </action>
  <verify>

1. Read updated firestore.rules and verify:
   - Friendship update rule requires resource.data.requestedBy != request.auth.uid for acceptance
   - Friendship update uses affectedKeys().hasOnly(['status', 'acceptedAt'])
   - Notification update uses affectedKeys().hasOnly(['read', 'readAt'])
     </verify>
     <done>

- Friendship accept restricted to recipient only
- Friendship update restricted to status/acceptedAt fields only
- Notification update restricted to read/readAt fields only
  </done>
  </task>

<task type="auto">
  <name>Task 3: Deploy and verify rules don't break existing functionality</name>
  <files>firestore.rules</files>
  <action>
1. Deploy rules to Firebase:
   - Run: firebase deploy --only firestore:rules
   - Verify deployment succeeds

2. Document the changes in a comment block at top of file:
   - Add comment: // Hardened: 2026-01-24 - Phase 23 Security Audit
   - List changes: self-reaction prevention, immutable fields, tightened updates

3. If deployment fails with syntax errors:
   - Review error message
   - Fix syntax issues
   - Retry deployment

WHY deployment verification matters:

- Syntax errors not caught until deploy
- Real Firebase validator stricter than local linting
- Confirms rules are active in production
  </action>
  <verify>

1. Run: firebase deploy --only firestore:rules
2. Confirm output shows "Deploy complete!" or similar success message
3. Rules file has updated header comment with date and changes
   </verify>
   <done>

- Rules deployed successfully to Firebase
- Header comment documents Phase 23 changes
- No deployment errors
  </done>
  </task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] firestore.rules has all new helper functions
- [ ] Photo update has self-reaction prevention
- [ ] Photo update protects immutable fields
- [ ] Friendship accept restricted to recipient
- [ ] Notification update restricted to read fields
- [ ] firebase deploy --only firestore:rules succeeds
- [ ] Header comment documents Phase 23 changes
</verification>

<success_criteria>

- All 3 tasks completed
- All verification checks pass
- No Firebase deployment errors
- Rules are stricter than before, but existing app functionality preserved
  </success_criteria>

<output>
After completion, create `.planning/phases/23-firestore-security-rules-audit/23-01-SUMMARY.md`:

# Phase 23 Plan 01: Firestore Security Rules Audit Summary

**[Substantive one-liner describing security hardening]**

## Accomplishments

- [Key hardening 1]
- [Key hardening 2]

## Files Created/Modified

- `firestore.rules` - Description of changes

## Decisions Made

[Any decisions during implementation]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 23 complete, ready for Phase 24 (Cloud Functions Validation and Security).
</output>
