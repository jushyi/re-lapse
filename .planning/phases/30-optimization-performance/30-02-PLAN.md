---
phase: 30-optimization-performance
plan: 02
type: execute
---

<objective>
Migrate AlbumPhotoViewer from React Native Image to expo-image for both fullscreen photos and thumbnail strip.

Purpose: Fix the second primary performance issue - slow photo loading in the fullscreen viewer and thumbnail navigation.
Output: AlbumPhotoViewer using expo-image with proper caching, priority, and recycling for both photo displays.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/30-optimization-performance/30-RESEARCH.md
@.planning/phases/30-optimization-performance/30-01-SUMMARY.md
@src/components/AlbumPhotoViewer.js

**Key findings from research:**

- AlbumPhotoViewer uses React Native `Image` (line 7)
- Fullscreen photos (line 402) and thumbnails (line 436) both use RN Image
- Already has `getItemLayout` for both FlatLists (good!) - just needs image optimization
- Missing: `recyclingKey` for thumbnails, proper caching policy

**Migration patterns (from research):**

```javascript
// Full-screen photo - high priority, no transition needed
<Image
  source={{ uri: item.imageURL }}
  style={styles.photo}
  contentFit="cover"
  cachePolicy="memory-disk"
  priority="high"
/>

// Thumbnail in list - low priority, enable recycling
<Image
  source={{ uri: item.imageURL }}
  style={styles.thumbnail}
  contentFit="cover"
  cachePolicy="memory-disk"
  priority="low"
  recyclingKey={`thumb-${item.id}`}
/>
```

</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate fullscreen photo Image to expo-image</name>
  <files>src/components/AlbumPhotoViewer.js</files>
  <action>
1. Change import from `import { Image } from 'react-native'` to `import { Image } from 'expo-image'`
   Note: Keep other react-native imports on separate line

2. In `renderPhoto` callback (around line 399), update the Image component:
   - Remove `resizeMode="cover"` prop
   - Add `contentFit="cover"` (expo-image equivalent)
   - Add `cachePolicy="memory-disk"` (enables proper disk + memory caching)
   - Add `priority="high"` (fullscreen photos should load first)

3. The updated renderPhoto should look like:
   ```javascript
   const renderPhoto = useCallback(
     ({ item }) => (
       <TouchableOpacity activeOpacity={1} onPress={handleImagePress} style={styles.photoContainer}>
         <Image
           source={{ uri: item.imageURL }}
           style={styles.photo}
           contentFit="cover"
           cachePolicy="memory-disk"
           priority="high"
         />
       </TouchableOpacity>
     ),
     [handleImagePress]
   );
   ```
     </action>
     <verify>Open AlbumPhotoViewer, swipe through photos - should load smoothly</verify>
     <done>Fullscreen photos use expo-image with contentFit, cachePolicy, and high priority</done>
   </task>

<task type="auto">
  <name>Task 2: Migrate thumbnail strip Image to expo-image</name>
  <files>src/components/AlbumPhotoViewer.js</files>
  <action>
1. In `renderThumbnail` callback (around line 429), update the Image component:
   - Add `contentFit="cover"` (ensures proper fill)
   - Add `cachePolicy="memory-disk"` (enables caching)
   - Add `priority="low"` (thumbnails less important than fullscreen)
   - Add `recyclingKey={`thumb-${item.id}`}` (prevents flicker during scroll)
   - Add `transition={100}` (quick fade-in)

2. The updated renderThumbnail should look like:

   ```javascript
   const renderThumbnail = useCallback(
     ({ item, index }) => (
       <TouchableOpacity
         onPress={() => goToIndex(index)}
         activeOpacity={0.8}
         style={styles.thumbnailWrapper}
       >
         <Image
           source={{ uri: item.imageURL }}
           style={[styles.thumbnail, index === currentIndex && styles.thumbnailActive]}
           contentFit="cover"
           cachePolicy="memory-disk"
           priority="low"
           recyclingKey={`thumb-${item.id}`}
           transition={100}
         />
       </TouchableOpacity>
     ),
     [currentIndex, goToIndex]
   );
   ```

3. Add FlatList optimization props to thumbnail FlatList (around line 508) if not present:
   - `initialNumToRender={10}` (visible thumbnails plus buffer)
   - `maxToRenderPerBatch={5}`
   - `windowSize={7}` (more buffer for horizontal scroll)
     </action>
     <verify>Open AlbumPhotoViewer, scroll thumbnail strip rapidly - no wrong images should flash</verify>
     <done>Thumbnails use expo-image with recyclingKey to prevent flicker, FlatList optimized</done>
     </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] App builds without errors
- [ ] AlbumPhotoViewer opens from any album grid
- [ ] Fullscreen photos load quickly
- [ ] Thumbnail strip scrolls smoothly without flicker
- [ ] Swiping between photos is responsive
- [ ] No TypeScript/ESLint errors
</verification>

<success_criteria>

- expo-image import replaces react-native Image
- Fullscreen photos: contentFit, cachePolicy, priority="high"
- Thumbnails: contentFit, cachePolicy, priority="low", recyclingKey, transition
- Thumbnail FlatList has optimization props
- No visual regressions
  </success_criteria>

<output>
After completion, create `.planning/phases/30-optimization-performance/30-02-SUMMARY.md`
</output>
