---
phase: 30-optimization-performance
plan: 03
type: execute
---

<objective>
Migrate AlbumGridScreen and AlbumPhotoPickerScreen from React Native Image to expo-image with FlatList optimizations.

Purpose: Optimize album grid views for better photo loading performance.
Output: Both screens using expo-image with proper caching, and FlatLists with optimization props.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/30-optimization-performance/30-RESEARCH.md
@.planning/phases/30-optimization-performance/30-02-SUMMARY.md
@src/screens/AlbumGridScreen.js
@src/screens/AlbumPhotoPickerScreen.js

**Key findings from research:**

- AlbumGridScreen uses React Native `Image` (line 8)
- AlbumPhotoPickerScreen uses React Native `Image`
- Both have photo grids with similar patterns to MonthlyAlbumGridScreen
- FlatLists missing optimization props

**Established pattern from 30-01:**

```javascript
import { Image } from 'expo-image';

<Image
  source={{ uri: photo.imageURL }}
  style={styles.photoImage}
  contentFit="cover"
  cachePolicy="memory-disk"
  priority="normal"
  recyclingKey={photo.id}
  transition={150}
/>;
```

</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate AlbumGridScreen to expo-image</name>
  <files>src/screens/AlbumGridScreen.js</files>
  <action>
1. Change import from `import { Image } from 'react-native'` to `import { Image } from 'expo-image'`
   Keep other react-native imports

2. In `renderItem` (around line 278), update the Image component:
   - Add `contentFit="cover"`
   - Add `cachePolicy="memory-disk"`
   - Add `priority="normal"`
   - Add `recyclingKey={item.photo.id}`
   - Add `transition={150}`

3. Add FlatList optimization props (around line 363):
   - Add `getItemLayout` callback:
     ```javascript
     const getItemLayout = useCallback(
       (data, index) => ({
         length: CELL_HEIGHT + GRID_GAP,
         offset: (CELL_HEIGHT + GRID_GAP) * Math.floor(index / NUM_COLUMNS),
         index,
       }),
       []
     );
     ```
   - Add props to FlatList:
     - `getItemLayout={getItemLayout}`
     - `initialNumToRender={9}` (3 rows of 3)
     - `maxToRenderPerBatch={6}`
     - `windowSize={5}`

4. Wrap `renderItem` in useCallback if not already:
   ```javascript
   const renderItem = useCallback(
     ({ item, index }) => {
       // existing implementation
     },
     [handlePhotoPress, handlePhotoLongPress, handleAddPhotosPress, isOwnProfile]
   );
   ```
     </action>
     <verify>Open any album grid, scroll through - should be smooth with no blank cells</verify>
     <done>AlbumGridScreen uses expo-image with all optimization props, FlatList optimized</done>
   </task>

<task type="auto">
  <name>Task 2: Migrate AlbumPhotoPickerScreen to expo-image</name>
  <files>src/screens/AlbumPhotoPickerScreen.js</files>
  <action>
1. Read the file first to understand current structure

2. Change import from `import { Image } from 'react-native'` to `import { Image } from 'expo-image'`

3. Find all Image components in renderItem/render functions and update:
   - Add `contentFit="cover"`
   - Add `cachePolicy="memory-disk"`
   - Add `priority="normal"`
   - Add `recyclingKey={photo.id}` (or appropriate unique key)
   - Add `transition={150}`

4. Add FlatList optimization props:
   - Calculate cell dimensions from existing constants
   - Add `getItemLayout` based on cell size
   - Add `initialNumToRender={12}` (4 rows of 3)
   - Add `maxToRenderPerBatch={6}`
   - Add `windowSize={5}`

5. Ensure renderItem is wrapped in useCallback
   </action>
   <verify>Open photo picker, scroll through library - should be smooth</verify>
   <done>AlbumPhotoPickerScreen uses expo-image with all optimization props, FlatList optimized</done>
   </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] App builds without errors
- [ ] AlbumGridScreen displays photos correctly
- [ ] AlbumPhotoPickerScreen displays photos correctly
- [ ] Both screens scroll smoothly
- [ ] Selection/interaction still works
- [ ] No TypeScript/ESLint errors
</verification>

<success_criteria>

- Both screens use expo-image imports
- All Image components have: contentFit, cachePolicy, priority, recyclingKey, transition
- Both FlatLists have: getItemLayout, initialNumToRender, maxToRenderPerBatch, windowSize
- renderItem functions are memoized
- No functional regressions
  </success_criteria>

<output>
After completion, create `.planning/phases/30-optimization-performance/30-03-SUMMARY.md`
</output>
