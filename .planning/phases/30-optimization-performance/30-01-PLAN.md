---
phase: 30-optimization-performance
plan: 01
type: execute
---

<objective>
Migrate MonthlyAlbumGridScreen from React Native Image to expo-image and add FlatList optimization props.

Purpose: Fix the primary performance issue - slow photo loading in monthly album grid views.
Output: MonthlyAlbumGridScreen using expo-image with proper caching, priority, and FlatList optimization.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/30-optimization-performance/30-RESEARCH.md
@.planning/phases/30-optimization-performance/30-CONTEXT.md
@src/screens/MonthlyAlbumGridScreen.js

**Key findings from research:**

- MonthlyAlbumGridScreen uses React Native `Image` (line 8) which has unreliable caching and blocks UI thread
- FlatList missing optimization props (`getItemLayout`, `initialNumToRender`, `windowSize`)
- expo-image already installed (v3.0.11) - just needs adoption

**Migration pattern (from research):**

```javascript
import { Image } from 'expo-image';

<Image
  source={{ uri: photo.imageURL }}
  style={styles.photoImage}
  contentFit="cover"
  cachePolicy="memory-disk"
  priority="normal"
  recyclingKey={photo.id}
  transition={150}
/>;
```

</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Image components to expo-image</name>
  <files>src/screens/MonthlyAlbumGridScreen.js</files>
  <action>
1. Change import from `import { Image } from 'react-native'` to `import { Image } from 'expo-image'`
2. In `renderRowItem`, update the Image component inside the photo TouchableOpacity (around line 250):
   - Add `contentFit="cover"` (replaces implicit cover behavior)
   - Add `cachePolicy="memory-disk"` (enables proper caching)
   - Add `priority="normal"` (balanced loading priority)
   - Add `recyclingKey={photoItem.key}` (prevents flicker during scroll)
   - Add `transition={150}` (smooth fade-in)
3. Remove any `resizeMode` props (expo-image uses `contentFit` instead)
  </action>
  <verify>App builds without errors: `npx expo start` shows no red screen</verify>
  <done>MonthlyAlbumGridScreen imports expo-image and all Image components use expo-image props</done>
</task>

<task type="auto">
  <name>Task 2: Add FlatList optimization props</name>
  <files>src/screens/MonthlyAlbumGridScreen.js</files>
  <action>
1. Define row height constants at the top of the file (after existing constants):
   ```javascript
   const DAY_HEADER_HEIGHT = 38; // paddingVertical 12 * 2 + fontSize 14
   const PHOTO_ROW_HEIGHT = CELL_HEIGHT + GRID_GAP;
   ```

2. Add `getItemLayout` callback to calculate item positions:

   ```javascript
   const getItemLayout = useCallback((data, index) => {
     // Note: This is an approximation since rows vary (header vs photo row)
     // Using photo row height as default since majority are photo rows
     return {
       length: PHOTO_ROW_HEIGHT,
       offset: PHOTO_ROW_HEIGHT * index,
       index,
     };
   }, []);
   ```

3. Add optimization props to the FlatList (around line 296):
   - `getItemLayout={getItemLayout}`
   - `initialNumToRender={6}` (enough to fill screen)
   - `maxToRenderPerBatch={4}` (smaller batches for smoother scrolling)
   - `windowSize={5}` (2 screens above + 1 visible + 2 below)
   - `removeClippedSubviews={true}` (detach offscreen views)

4. Wrap `renderRowItem` in useCallback if not already wrapped:
   ```javascript
   const renderRowItem = useCallback(
     ({ item }) => {
       // existing implementation
     },
     [handlePhotoPress]
   );
   ```
     </action>
     <verify>Scroll through monthly album - should feel smoother, no blank cells during fast scroll</verify>
     <done>FlatList has getItemLayout, initialNumToRender, maxToRenderPerBatch, windowSize, removeClippedSubviews, and memoized renderItem</done>
   </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] App builds without errors
- [ ] MonthlyAlbumGridScreen opens and displays photos
- [ ] Scrolling is smooth without visible jank
- [ ] Photos load faster than before (subjective check)
- [ ] No TypeScript/ESLint errors
</verification>

<success_criteria>

- expo-image import replaces react-native Image
- All Image components use cachePolicy, priority, recyclingKey, transition props
- FlatList has all optimization props configured
- renderRowItem is memoized with useCallback
- No regressions in functionality
  </success_criteria>

<output>
After completion, create `.planning/phases/30-optimization-performance/30-01-SUMMARY.md`
</output>
