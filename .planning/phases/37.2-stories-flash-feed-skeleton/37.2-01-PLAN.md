---
phase: 37.2-stories-flash-feed-skeleton
plan: 01
type: execute
---

<objective>
Fix stories thumbnail flash on modal dismiss and update feed loading skeleton to match current design.

Purpose: Visual polish - eliminate jarring gray flash when returning from photo modal, and align loading state with current feed structure.
Output: Smooth thumbnail persistence, accurate loading skeleton preview.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/37.2-stories-flash-feed-skeleton/37.2-CONTEXT.md

# Relevant prior work:

@.planning/phases/35.3-stories-performance-view-state-fix/35.3-01-SUMMARY.md

# Source files to modify:

@src/components/FriendStoryCard.js
@src/components/FeedLoadingSkeleton.js
@src/styles/FeedPhotoCard.styles.js

**Tech stack available:**

- expo-image (already used in PhotoDetailModal for native caching)
- Animated API for pulse animation

**Established patterns:**

- expo-image with transition={0} and cachePolicy='memory-disk' for instant loads
- Dark theme background (#000000 for feed, colors.background.tertiary for placeholders)
- Stories cards: 88x130px rectangular with 32x32 profile photo at bottom
- Feed cards: full-width square photo + info row (36x36 profile photo, name, timestamp)

**Constraining decisions:**

- Phase 35.3-01: expo-image for all modal photos (native caching, instant loads)
- Phase 34.1-01: Pure black background (#000000) for feed, edge-to-edge photos
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Fix stories thumbnail flash with expo-image</name>
  <files>src/components/FriendStoryCard.js</files>
  <action>
Replace React Native's built-in Image component with expo-image for the blurred thumbnail:

1. Import { Image } from 'expo-image' (replace RN Image import for thumbnail only)
2. Keep RN Image import as `import { Image as RNImage }` for profile photo (simpler, no flash issue)
3. Update renderPhotoContent() to use expo-image:
   - Add transition={0} for instant display (no fade)
   - Add cachePolicy="memory-disk" for persistent caching
   - Add contentFit="cover" (expo-image equivalent of resizeMode)
   - Keep blurRadius={20} (expo-image supports this)

Pattern reference from PhotoDetailModal.js:

```jsx
<Image
  source={{ uri: thumbnailUrl }}
  style={styles.photoThumbnail}
  contentFit="cover"
  transition={0}
  cachePolicy="memory-disk"
  blurRadius={20}
/>
```

Do NOT change the profile photo Image - it's small and doesn't have the flash issue.
</action>
<verify>

1. Run app: npx expo start
2. Open feed, tap a story card to open modal
3. Swipe down to dismiss modal
4. Confirm story thumbnails do NOT flash gray - they remain visible throughout
5. Repeat 3-4 times to confirm consistency
   </verify>
   <done>Story thumbnails persist smoothly when returning from modal - no gray flash</done>
   </task>

<task type="auto">
  <name>Task 2: Update feed loading skeleton for current design</name>
  <files>src/components/FeedLoadingSkeleton.js</files>
  <action>
Completely rewrite FeedLoadingSkeleton to match current feed structure:

**Stories Row Skeleton (top):**

- Horizontal ScrollView with 4-5 placeholder story cards
- Each card: 88x130 rectangular placeholder with rounded corners (14px)
- Small 32x32 circle below each card (profile photo placeholder)
- 10px spacing between cards
- Dark gray background (#2A2A2A = colors.background.tertiary)

**Feed Cards Skeleton (below stories):**

- Full-width square photo placeholder (aspectRatio: 1)
- Info row below: 36x36 circle (profile) + two text lines (name 120px, timestamp 60px)
- Dark gray background (#2A2A2A)
- 20px spacing between cards
- Show 2-3 card placeholders

**General:**

- Pure black container background (#000000)
- Keep existing pulse animation (opacity 0.3 â†’ 0.7)
- Use colors.background.tertiary (#2A2A2A) for all placeholder elements
- Match exact dimensions from FriendStoryCard and FeedPhotoCard.styles

Structure:

```jsx
const FeedLoadingSkeleton = () => {
  // Pulse animation setup (keep existing)

  return (
    <View style={styles.container}>
      {/* Stories Row */}
      <View style={styles.storiesRow}>
        {Array.from({ length: 4 }).map((_, i) => (
          <View key={i} style={styles.storyCardSkeleton}>
            <Animated.View style={[styles.storyPhoto, { opacity }]} />
            <Animated.View style={[styles.storyProfile, { opacity }]} />
          </View>
        ))}
      </View>

      {/* Feed Cards */}
      {Array.from({ length: 2 }).map((_, i) => (
        <View key={i} style={styles.feedCard}>
          <Animated.View style={[styles.feedPhoto, { opacity }]} />
          <View style={styles.feedInfoRow}>
            <Animated.View style={[styles.feedProfile, { opacity }]} />
            <View style={styles.feedTextContainer}>
              <Animated.View style={[styles.feedName, { opacity }]} />
              <Animated.View style={[styles.feedTimestamp, { opacity }]} />
            </View>
          </View>
        </View>
      ))}
    </View>
  );
};
```

  </action>
  <verify>
1. Temporarily add loading delay in FeedScreen (or set loading=true)
2. Confirm skeleton shows:
   - 4 rectangular story card placeholders in a row at top
   - 2 full-width feed card placeholders below
3. Confirm pulse animation works on all elements
4. Confirm dark theme colors match actual feed
5. Remove test delay
  </verify>
  <done>Loading skeleton accurately represents current feed structure (stories row + full-width cards) with dark theme</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Stories thumbnails do NOT flash gray when dismissing modal (test 3+ times)
- [ ] Feed loading skeleton shows stories row placeholder
- [ ] Feed loading skeleton shows full-width feed card placeholders
- [ ] All placeholder colors match dark theme (#2A2A2A)
- [ ] Pulse animation works smoothly
- [ ] No console errors or warnings
- [ ] `npm run lint` passes
</verification>

<success_criteria>

- Stories thumbnail flash issue resolved with expo-image caching
- Feed loading skeleton accurately previews current feed structure
- No visual regressions in feed or stories functionality
- All tasks completed with atomic commits
  </success_criteria>

<output>
After completion, create `.planning/phases/37.2-stories-flash-feed-skeleton/37.2-01-SUMMARY.md` with:

# Phase 37.2 Plan 01: Stories Flash & Feed Skeleton Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file` - Description

## Decisions Made

[Any decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

[Status and what's next]
</output>
