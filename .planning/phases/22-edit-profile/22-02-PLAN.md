---
phase: 22-edit-profile
plan: 02
type: execute
---

<objective>
Implement the full EditProfileScreen with photo editing, form fields, username restriction, and save flow.

Purpose: Enable users to update their profile information (display name, username, bio, photo) with proper validation.
Output: Fully functional EditProfileScreen with Instagram-style minimal design, 14-day username restriction, and photo management.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-edit-profile/22-CONTEXT.md
@.planning/phases/22-edit-profile/22-01-SUMMARY.md

@src/screens/ProfileSetupScreen.js
@src/screens/EditProfileScreen.js
@src/services/firebase/userService.js
@src/services/firebase/storageService.js
@src/context/AuthContext.js
@src/components/Input.js

**Established patterns:**

- ProfileSetupScreen: username availability check with debounce, image picker with aspect [1,1]
- Input component: maxLength, showCharacterCount, error, rightIcon props
- Character limits: displayName (24), username (24), bio (240)
- Alert.alert for option menus
- useAuth for userProfile and updateUserProfile

**Key requirements from CONTEXT.md:**

- Clean, minimal Instagram-style edit screen
- Photo options: Take New Picture, Choose New Picture, Remove Photo
- 14-day username restriction with disabled field + tooltip
- Real-time username availability check (500ms debounce)
- Navigate to Profile screen after save
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Implement EditProfileScreen layout and form</name>
  <files>src/screens/EditProfileScreen.js</files>
  <action>
Replace the placeholder EditProfileScreen with full implementation:

**Header:**

- Left: Cancel button (text or X icon)
- Center: "Edit Profile" title
- Right: Save button (disabled when no changes or invalid)

**Layout (ScrollView):**

1. Profile photo at top center (120x120 circular)
   - Tap to show photo options (Task 2)
   - Show current photo or placeholder (ProfileIcon SVG pattern from ProfileSetupScreen)

2. Form fields (use Input component):
   - Display Name (required, maxLength 24, showCharacterCount)
   - Username (maxLength 24, showCharacterCount) - restriction handled in Task 2
   - Bio (optional, multiline, maxLength 240, showCharacterCount)

**State management:**

- Initialize from userProfile (useAuth)
- Track changes to enable/disable Save button
- Track form validity (display name required, username valid)

**Patterns to follow from ProfileSetupScreen:**

- KeyboardAvoidingView wrapper
- ScrollView with keyboardShouldPersistTaps="handled"
- Form validation on save
- Same styling (colors.background.primary, padding 24, etc.)

Cancel: navigation.goBack() - no confirmation needed if no changes
If changes made, show "Discard changes?" confirmation dialog
</action>
<verify>Read EditProfileScreen.js and verify it has header with Cancel/Save, photo container, and Input components for display name, username, bio</verify>
<done>EditProfileScreen has header, photo display, and form fields using Input component with proper maxLength values</done>
</task>

<task type="auto">
  <name>Task 2: Implement username restriction and photo options</name>
  <files>src/screens/EditProfileScreen.js</files>
  <action>
**Username 14-day restriction:**
1. Import canChangeUsername from userService
2. On mount, check if user can change username using lastUsernameChange from userProfile
3. If cannot change:
   - Disable username Input (editable={false})
   - Show tooltip/hint below field: "Can change username in X days"
   - Style disabled field with reduced opacity (0.6)
4. If can change:
   - Enable real-time availability check (copy pattern from ProfileSetupScreen):
     - 500ms debounce
     - setCheckingUsername state
     - rightIcon: 'loading' | 'check' | null
     - Skip check if username matches current

**Photo options menu:**

1. When photo container is tapped, show Alert.alert with options:
   - "Take New Picture" → launchCameraAsync with aspect [1,1], allowsEditing: true
   - "Choose from Library" → launchImageLibraryAsync with same options
   - "Remove Photo" (only if photo exists) → set photoUri to null, show placeholder
   - "Cancel"

2. Track photoUri state separate from original photoURL
3. Show pending photo or current photo based on state
4. Handle remove photo: show ProfileIcon placeholder

**Save flow:**

1. Validate all fields (same validation as ProfileSetupScreen)
2. If photoUri changed:
   - If new photo: upload via uploadProfilePhoto from storageService
   - If removed: set photoURL to null
3. Call updateUserProfile from userService with:
   - displayName, bio (always)
   - username (only if changed and allowed)
   - photoURL (new URL, existing, or null for removed)
4. Update local userProfile via updateUserProfile from AuthContext
5. Navigate to 'ProfileMain' with navigation.navigate() to show updated profile
6. Show success feedback (optional toast or just navigation)
   </action>
   <verify>Read EditProfileScreen.js and verify username restriction logic, photo options Alert, and save flow are implemented</verify>
   <done>Username shows disabled state with days remaining tooltip when restricted, photo options menu works, save updates profile and navigates to ProfileMain</done>
   </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Edit Profile screen with photo management, form validation, and username restriction</what-built>
  <how-to-verify>
    1. Run the app and sign in
    2. Navigate: Profile → Settings (gear icon) → Edit Profile
    3. Verify layout: Cancel (left), "Edit Profile" (center), Save (right, disabled if no changes)
    4. Verify photo: tap photo shows options menu (Take, Choose, Remove if has photo)
    5. Test photo selection: choose from library, confirm circular crop appears, photo updates
    6. Test remove photo: if you have a photo, remove it, confirm placeholder shows
    7. Verify form fields: display name, username, bio all show with character counts on focus
    8. Test username restriction:
       - If you've never changed username, it should be editable
       - Type a new username, see loading indicator, then checkmark if available
    9. Test Save: make a change, Save enables, tap Save
    10. Confirm navigation to Profile screen with updated info visible
    11. Test Cancel with changes: make change, tap Cancel, should show "Discard changes?" dialog
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] EditProfileScreen has header with Cancel/Save buttons
- [ ] Photo tap shows options (Take, Choose, Remove)
- [ ] Photo selection works with circular crop
- [ ] Remove photo shows placeholder
- [ ] Display name, username, bio fields work with character limits
- [ ] Username disabled with tooltip when within 14-day restriction
- [ ] Username availability check works (debounced, shows loading/check icons)
- [ ] Save updates profile and navigates to ProfileMain
- [ ] Cancel with changes shows confirmation dialog
- [ ] No Metro bundler errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Human verification approved
- Profile editing works end-to-end
- Phase 22 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/22-edit-profile/22-02-SUMMARY.md`
</output>
