---
phase: 46.1-other-users-albums-fix
plan: 01
type: execute
---

<objective>
Fix the regression where viewing other users' albums no longer works. Restore the previous behavior: tapping an album on a friend's profile opens AlbumGridScreen with their photos in a read-only gallery view.

Purpose: This is a critical regression — album viewing for other users was working and broke during v0.9.0 (Phases 32-45). The app's social experience depends on being able to view friends' albums.
Output: Working album viewing for other users, verified on device.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46.1-other-users-albums-fix/46.1-CONTEXT.md

# Key source files (the full album viewing flow):

@src/screens/ProfileScreen.js
@src/screens/AlbumGridScreen.js
@src/components/AlbumBar.js
@src/components/AlbumPhotoViewer.js
@src/services/firebase/albumService.js
@src/services/firebase/photoService.js
@src/navigation/AppNavigator.js
@firestore.rules

**Regression context:** Broke during v0.9.0 (Phases 32-45). Key commits in that window:

- Phase 32: Photo issues fix (contentFit changes in AlbumPhotoViewer)
- Phase 33: Navigation fix (CommentsBottomSheet Modal→Animated.View)
- Phase 45: Security audit (Firestore rules hardening — album update protection, comment/like access hierarchy)
- Phase 46: Performance optimization (query limits on albumService, FlatList optimization on AlbumBar/AlbumCard, React.memo wrappers)

**Established patterns:**

- Services return `{ success: true, data }` or `{ success: false, error }`
- Firestore rules use `areFriends(resource.data.userId)` for friend-based access
- `useFocusEffect` with `useCallback` for data fetching tied to screen focus
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Diagnose and fix the other-user album viewing regression</name>
  <files>src/screens/ProfileScreen.js, src/screens/AlbumGridScreen.js, src/services/firebase/albumService.js, src/services/firebase/photoService.js, firestore.rules</files>
  <action>
Systematically investigate the album viewing flow for other users. The flow is:
1. ProfileScreen (as OtherUserProfile) fetches friendship status → fetches albums → renders AlbumBar
2. User taps album → handleAlbumPress navigates to AlbumGrid with { albumId, isOwnProfile }
3. AlbumGridScreen fetches album via getAlbum(albumId) → fetches photos via getPhotosByIds
4. Photos render in grid, AlbumPhotoViewer handles fullscreen viewing

**Check each failure point in order:**

A. **ProfileScreen album fetch timing (MOST LIKELY):** In ProfileScreen.js, the album fetch uses `albumsFetchedRef.current` as a one-shot guard in the useFocusEffect (~line 229-239). Check if there's a race condition where `friendshipStatusLoaded` becomes true before `friendshipStatus` is set to 'friends', causing `fetchAlbums` to run with `isFriend = false` (which sets albums to empty array), and then the ref guard prevents re-fetching when `friendshipStatus` updates. If found, fix by either:

- Removing the ref guard and using a different dedup mechanism
- Adding `isFriend` as a trigger condition (e.g., only set albumsFetchedRef when albums are actually fetched with friend access)
- Using a useEffect instead of useFocusEffect for the friendship-dependent album fetch

B. **ProfileScreen conditional rendering (~line 871):** Check the ternary `{!isOwnProfile && !isFriend ? ... : ...}`. The AlbumBar is in the else branch. Verify `isFriend` is derived correctly from `friendshipStatus === 'friends'`.

C. **handleAlbumPress navigation params (~line 638-643):** Verify `navigation.navigate('AlbumGrid', { albumId: album.id, isOwnProfile })` passes correct values. The root stack has AlbumGrid as a sibling of OtherUserProfile — verify navigation reaches the right screen.

D. **AlbumGridScreen getAlbum call (~line 70-105):** Check if `getAlbum(albumId)` fails for non-owner reads. The Firestore rule requires `areFriends(resource.data.userId)`. If the rule check fails, the catch returns `{ success: false }` and the screen shows "Album not found". Add temporary console.log to surface any permission errors.

E. **getPhotosByIds (~photoService line 470-502):** Each photo is read individually via `getDoc`. If a photo read throws a permission error (not just non-existent), `Promise.all` rejects and the entire function returns `{ success: false }`. Check if photos in non-journal states (archive, deleted) cause permission failures for non-owners.

F. **Firestore rules deployment:** Check if the current firestore.rules (which allows friends to read albums via `areFriends`) are actually deployed to Firebase. Run `firebase deploy --only firestore:rules` if they might be stale. The friend-read rules were added in commit `ddc9a34` (Phase 15-02-FIX) and the latest update was `18c5414` (Phase 45-01).

G. **Firestore indexes deployment:** Check if the albums composite index (userId ASC, updatedAt DESC) is deployed. Run `firebase deploy --only firestore:indexes` if needed.

**After identifying the root cause, fix it.** Keep the fix minimal — this is a regression fix, not a refactor. Do NOT add new features or change UI behavior.

**Important:** The fix must not break own-profile album viewing. Both flows share ProfileScreen and AlbumGridScreen.
</action>
<verify>

- `npm run lint` passes
- Review the fix: own-profile album flow is unchanged
- Review the fix: other-user album flow now works (friendship status → album fetch → navigation → album display)
  </verify>
  <done>Root cause identified and fixed. Lint passes. Both own-profile and other-user album flows are correct in code.</done>
  </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed the other-user album viewing regression</what-built>
  <how-to-verify>
    1. Run: `npx expo start` to launch the dev server
    2. Open the app on a device/simulator
    3. Navigate to a friend's profile (from Friends list or feed)
    4. Verify: Albums section is visible (AlbumBar shows their albums)
    5. Tap one of their albums
    6. Verify: AlbumGridScreen opens with the album's photos displayed in a 3-column grid
    7. Tap a photo in the grid
    8. Verify: AlbumPhotoViewer opens in fullscreen, showing the photo
    9. Swipe through photos, close the viewer
    10. Go back to the friend's profile
    11. Verify: Albums section still shows (no re-fetch issues)
    12. Also verify: Navigate to YOUR OWN profile tab → albums still work (no regression)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Other-user album viewing works end-to-end (profile → album grid → photo viewer)
- [ ] Own-profile album viewing is not broken (no regression)
- [ ] `npm run lint` passes with no new warnings
- [ ] Fix is minimal — no unnecessary changes
</verification>

<success_criteria>

- Root cause identified and documented
- Album viewing for other users restored to working state
- Own-profile album viewing unchanged
- No new lint warnings or errors
- Human verification confirms fix works on device
  </success_criteria>

<output>
After completion, create `.planning/phases/46.1-other-users-albums-fix/46.1-01-SUMMARY.md`:

# Phase 46.1 Plan 01: Other Users Albums View Fix Summary

**[One-liner describing the root cause and fix]**

## Root Cause

[What broke and why — which commit/phase introduced the regression]

## Fix Applied

[What was changed and why]

## Accomplishments

- [Key outcome]

## Files Created/Modified

- `path/to/file.js` - Description

## Decisions Made

[Any decisions, or "None"]

## Issues Encountered

[Problems found during investigation, or "None"]

## Next Step

Phase 46.1 complete, ready for Phase 47.
</output>
