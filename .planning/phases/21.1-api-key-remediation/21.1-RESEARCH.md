# Phase 21.1: API Key Exposure Remediation - Research

**Researched:** 2026-01-24
**Domain:** Git history rewriting and sensitive data removal
**Confidence:** HIGH

<research_summary>

## Summary

Researched the ecosystem for removing sensitive files (GoogleService-Info.plist) from git history after accidental commits to a public repository. The standard approach uses either BFG Repo-Cleaner (simpler, faster) or git-filter-repo (more flexible, GitHub-recommended) to rewrite git history, followed by force-pushing and coordinating with GitHub Support for cache purging.

Key finding: While the values in GoogleService-Info.plist are technically "identifiers not secrets" according to Firebase, best practice is still to remove them and add to .gitignore. The keys have already been rotated, so the remaining task is cleaning git history and preventing future exposure.

**Primary recommendation:** Use BFG Repo-Cleaner for its simplicity and speed, force-push to rewrite remote history, contact GitHub Support for cache purging if any pull requests referenced the file, and add proper .gitignore entries to prevent recurrence.
</research_summary>

<standard_stack>

## Standard Stack

### Core Tools

| Tool             | Version | Purpose                            | Why Standard                                      |
| ---------------- | ------- | ---------------------------------- | ------------------------------------------------- |
| BFG Repo-Cleaner | 1.15.0  | Remove files/text from git history | 10-720x faster than git-filter-branch, simple CLI |
| git-filter-repo  | 2.47+   | Advanced history rewriting         | GitHub's recommended tool, more flexible          |
| Java Runtime     | 11+     | Required for BFG                   | BFG dependency                                    |

### Supporting

| Tool                  | Purpose                  | When to Use                                  |
| --------------------- | ------------------------ | -------------------------------------------- |
| GitHub Support Portal | Cache purging requests   | When PRs referenced sensitive data           |
| git gc                | Garbage collection       | After history rewrite to clean loose objects |
| git reflog            | Reference log management | Expire old references before GC              |

### Tool Selection: BFG vs git-filter-repo

| Feature                | BFG Repo-Cleaner             | git-filter-repo           |
| ---------------------- | ---------------------------- | ------------------------- |
| **Speed**              | Very fast (multi-core Scala) | Fast                      |
| **Ease of use**        | Simpler CLI                  | More complex but flexible |
| **Dependencies**       | Java 11+                     | Python                    |
| **Flexibility**        | Limited to common use cases  | Highly flexible           |
| **GitHub recommended** | Yes                          | Primary recommendation    |
| **Best for**           | Quick file/password removal  | Advanced history surgery  |

**Recommendation:** Use BFG for this specific use case (deleting a single file type from history).

**Installation:**

```bash
# macOS with Homebrew
brew install bfg

# Or download JAR directly
# https://rtyley.github.io/bfg-repo-cleaner/
```

</standard_stack>

<architecture_patterns>

## Architecture Patterns

### Recommended Workflow: Complete History Scrub

```
1. PREREQUISITE: Rotate/revoke exposed credentials (DONE)
         ↓
2. Ensure current commit is clean (file already removed/gitignored)
         ↓
3. Clone repository with --mirror flag
         ↓
4. Run BFG to delete file from history
         ↓
5. Run git gc to clean loose objects
         ↓
6. Force push to overwrite remote history
         ↓
7. Contact GitHub Support for cache purging (if PRs affected)
         ↓
8. Notify collaborators to re-clone or hard reset
```

### Pattern 1: BFG File Deletion

**What:** Remove specific file(s) from all git history
**When to use:** Single file or file pattern to remove completely
**Example:**

```bash
# Clone with mirror flag (full git database, no working files)
git clone --mirror https://github.com/USER/REPO.git

# Delete file by name (matches anywhere in repo)
bfg --delete-files GoogleService-Info.plist repo.git

# Cleanup
cd repo.git
git reflog expire --expire=now --all
git gc --prune=now --aggressive

# Push rewritten history
git push --force
```

### Pattern 2: Verification After Cleanup

**What:** Confirm sensitive file is completely removed
**When to use:** After any history rewrite operation
**Example:**

```bash
# Search for file in all history
git log --all --full-history -- "**/GoogleService-Info.plist"

# Search for specific strings (API key patterns)
git log -S "AIzaSy" --all

# Full integrity check
git fsck --full
```

### Pattern 3: Prevention with .gitignore

**What:** Prevent future accidental commits of sensitive files
**When to use:** After cleanup, as permanent prevention
**Example:**

```gitignore
# Firebase config files (contain project identifiers)
GoogleService-Info.plist
google-services.json

# iOS specific
ios/GoogleService-Info.plist
**/GoogleService-Info.plist

# Android specific
android/app/google-services.json
**/google-services.json
```

### Anti-Patterns to Avoid

- **Using git-filter-branch:** Deprecated, slow, error-prone. Use BFG or git-filter-repo instead.
- **Merging after force-push:** Collaborators must rebase, not merge, or tainted history returns.
- **Forgetting forks:** Forks retain original history - must coordinate with fork owners.
- **Skipping gc:** Without garbage collection, objects remain in repo consuming space.
- **Using --force instead of --force-with-lease:** Risks overwriting others' work.
  </architecture_patterns>

<dont_hand_roll>

## Don't Hand-Roll

| Problem                     | Don't Build            | Use Instead            | Why                                            |
| --------------------------- | ---------------------- | ---------------------- | ---------------------------------------------- |
| History rewriting           | Manual git commands    | BFG Repo-Cleaner       | Handles all refs, tags, branches automatically |
| File deletion from history  | git-filter-branch      | BFG --delete-files     | 10-720x faster, safer                          |
| Text replacement in history | Manual sed/awk scripts | BFG --replace-text     | Handles binary detection, encoding             |
| Cache purging               | Hope GitHub clears it  | GitHub Support request | Only they can purge CDN/PR caches              |
| Verification                | Manual log inspection  | git log --all searches | Covers all refs including detached             |

**Key insight:** Git history rewriting is complex with many edge cases (refs, tags, reflogs, packed objects). BFG handles all of these automatically. Manual approaches miss references and leave data recoverable.
</dont_hand_roll>

<common_pitfalls>

## Common Pitfalls

### Pitfall 1: Protected Commit Contains Sensitive Data

**What goes wrong:** BFG doesn't modify the latest commit by default
**Why it happens:** Safety feature to prevent modifying current working state
**How to avoid:** Ensure sensitive file is removed/gitignored BEFORE running BFG
**Warning signs:** File still appears in `git ls-files` after BFG completes

### Pitfall 2: Forks Retain Original History

**What goes wrong:** Sensitive data remains accessible in forked repositories
**Why it happens:** Forks are independent copies with their own history
**How to avoid:** Coordinate with fork owners to delete forks or run same cleanup
**Warning signs:** File accessible via `raw.githubusercontent.com/FORK_OWNER/...`

### Pitfall 3: Pull Requests Cache Original Diffs

**What goes wrong:** PR diffs show sensitive data even after repo cleanup
**Why it happens:** GitHub caches PR diffs separately from repo
**How to avoid:** Contact GitHub Support with list of affected PR numbers
**Warning signs:** Visiting old PR shows file contents in diff view

### Pitfall 4: Collaborators Merge Instead of Rebase

**What goes wrong:** Tainted history reintroduced through merge commit
**Why it happens:** Normal git workflow merges, but after history rewrite need rebase
**How to avoid:** Communicate clearly: collaborators must `git fetch && git reset --hard origin/main` or re-clone
**Warning signs:** Old commit hashes reappear in log

### Pitfall 5: Forgetting Reflogs

**What goes wrong:** Data recoverable from reflog even after BFG
**Why it happens:** Git keeps reflog for safety/recovery
**How to avoid:** Always run `git reflog expire --expire=now --all` before `git gc`
**Warning signs:** `git reflog` shows old commits with sensitive data

### Pitfall 6: Not Rotating Credentials First

**What goes wrong:** Attackers use credentials between exposure and cleanup
**Why it happens:** History rewrite takes time; credentials exploitable immediately
**How to avoid:** Rotate ALL exposed credentials BEFORE starting history cleanup
**Warning signs:** This has already been done per STATE.md - proceed with cleanup
</common_pitfalls>

<code_examples>

## Code Examples

Verified patterns from official sources:

### Complete BFG Workflow

```bash
# Source: BFG official docs + GitHub docs

# Step 1: Clone with mirror (creates bare repo with full history)
git clone --mirror https://github.com/maser/Lapse-Clone.git

# Step 2: Delete the sensitive file from all history
# Note: BFG matches filename only, not path
bfg --delete-files GoogleService-Info.plist Lapse-Clone.git

# Step 3: Clean up refs and garbage collect
cd Lapse-Clone.git
git reflog expire --expire=now --all
git gc --prune=now --aggressive

# Step 4: Force push the cleaned history
git push --force

# Step 5: Verify cleanup locally
git log --all --full-history -- "**/GoogleService-Info.plist"
# Should return nothing
```

### Verification Commands

```bash
# Source: GitHub docs

# Check if file exists in any commit
git log --all --full-history -- GoogleService-Info.plist

# Search for API key pattern in history
git log -S "AIzaSy" --all

# Check for any Firebase config patterns
git log -S "GOOGLE_APP_ID" --all
git log -S "CLIENT_ID" --all

# Full integrity check
git fsck --full
```

### .gitignore Entries for Firebase

```gitignore
# Source: Firebase quickstart-ios official .gitignore

# Firebase config files
*GoogleService-Info.plist
GoogleService-Info.plist
google-services.json

# Expo/React Native specific paths
ios/GoogleService-Info.plist
ios/*/GoogleService-Info.plist
android/app/google-services.json
```

### EAS Build with Secrets (Alternative to Committing)

```javascript
// Source: Expo documentation
// app.config.js - Reference files that exist at build time via EAS secrets

export default {
  expo: {
    ios: {
      googleServicesFile: process.env.GOOGLE_SERVICES_PLIST
        ? './GoogleService-Info.plist'
        : undefined,
    },
    android: {
      googleServicesFile: process.env.GOOGLE_SERVICES_JSON ? './google-services.json' : undefined,
    },
  },
};
```

</code_examples>

<sota_updates>

## State of the Art (2025-2026)

| Old Approach                    | Current Approach          | When Changed | Impact                                      |
| ------------------------------- | ------------------------- | ------------ | ------------------------------------------- |
| git-filter-branch               | git-filter-repo or BFG    | 2020+        | filter-branch deprecated, much slower       |
| Manual GitHub cache clearing    | GitHub Support ticket     | Ongoing      | Only GitHub can purge CDN caches            |
| Commit GoogleService-Info.plist | EAS Secrets or local-only | 2023+        | Better security posture with managed builds |

**New tools/patterns to consider:**

- **git-filter-repo 2.47+:** Has `--sensitive-data-removal` flag specifically for this use case
- **EAS Secrets:** Inject Firebase config at build time without committing to repo
- **GitHub Secret Scanning:** Alerts on common secret patterns (may have caught this)

**Deprecated/outdated:**

- **git-filter-branch:** Officially deprecated, don't use
- **Manual commit editing:** Unreliable, misses refs
- **BFG versions < 1.14.0:** Require Java 8, use 1.15.0 with Java 11+
  </sota_updates>

<open_questions>

## Open Questions

Things that couldn't be fully resolved:

1. **Are there any forks of this repository?**
   - What we know: Forks retain original history independently
   - What's unclear: Need to check if any forks exist
   - Recommendation: Check GitHub for forks before cleanup; coordinate with fork owners if any exist

2. **Are there any open/closed PRs that touched GoogleService-Info.plist?**
   - What we know: PR diffs are cached separately and require GitHub Support to clear
   - What's unclear: Number of affected PRs
   - Recommendation: After BFG cleanup, check PR history and contact GitHub Support if any referenced the file

3. **Should we use EAS Secrets going forward?**
   - What we know: EAS can inject Firebase config at build time from secrets
   - What's unclear: Whether current build workflow supports this
   - Recommendation: For immediate fix, .gitignore is sufficient; EAS Secrets is a future enhancement
     </open_questions>

<sources>
## Sources

### Primary (HIGH confidence)

- [GitHub Docs: Removing sensitive data from a repository](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/removing-sensitive-data-from-a-repository) - Official GitHub guidance on history rewriting, tools, and cache purging
- [BFG Repo-Cleaner Official Site](https://rtyley.github.io/bfg-repo-cleaner/) - Installation, commands, workflow
- [Firebase quickstart-ios .gitignore](https://github.com/firebase/quickstart-ios/blob/main/.gitignore) - Official Firebase .gitignore patterns

### Secondary (MEDIUM confidence)

- [Expo Using Firebase Documentation](https://docs.expo.dev/guides/using-firebase/) - Firebase integration with Expo, verified approach
- [git-filter-repo GitHub](https://github.com/newren/git-filter-repo) - Alternative tool documentation
- [Git Tower: Force Push Guide](https://www.git-tower.com/learn/git/faq/git-force-push) - Force push best practices

### Tertiary (LOW confidence - needs validation)

- Community discussions on firebase-ios-sdk about GoogleService-Info.plist security - General guidance, not security-specific
  </sources>

<metadata>
## Metadata

**Research scope:**

- Core technology: Git history rewriting (BFG Repo-Cleaner, git-filter-repo)
- Ecosystem: GitHub cache purging, Firebase config patterns
- Patterns: History scrubbing workflow, prevention with .gitignore
- Pitfalls: Protected commits, forks, PR caches, collaborator merges

**Confidence breakdown:**

- Standard stack: HIGH - Official GitHub and BFG documentation
- Architecture: HIGH - Well-documented workflow from multiple sources
- Pitfalls: HIGH - Documented extensively in GitHub docs and community
- Code examples: HIGH - From official BFG and GitHub documentation

**Research date:** 2026-01-24
**Valid until:** 2026-02-24 (30 days - tools and processes stable)
</metadata>

---

_Phase: 21.1-api-key-remediation_
_Research completed: 2026-01-24_
_Ready for planning: yes_
