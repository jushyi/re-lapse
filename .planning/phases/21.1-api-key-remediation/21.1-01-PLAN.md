---
phase: 21.1-api-key-remediation
plan: 01
type: execute
---

<objective>
Remove exposed GoogleService-Info.plist from git history and prevent future exposure.

Purpose: Security incident response - the file containing Firebase identifiers was pushed to a public repository. Keys have been rotated, but the file remains in git history. Complete remediation requires scrubbing the file from all history and adding .gitignore rules.

Output: Clean git history with no trace of GoogleService-Info.plist, updated .gitignore, and working app with new Firebase config.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21.1-api-key-remediation/21.1-RESEARCH.md
@.planning/phases/21.1-api-key-remediation/21.1-CONTEXT.md

**Current state:**

- GoogleService-Info.plist is tracked in git (in at least 2 commits)
- File is NOT in .gitignore
- Keys have been rotated in Firebase Console
- Python 3.14 available, git-filter-repo can be pip installed
- No forks of the repository detected
- Repository: https://github.com/jushyi/re-lapse.git

**From research:**

- Use git-filter-repo (GitHub recommended, Python-based)
- BFG unavailable (no Java on system)
- Must make HEAD clean before history rewrite
- Force push required after rewrite
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Install git-filter-repo</name>
  <files>N/A (pip package)</files>
  <action>Install git-filter-repo via pip. This is the GitHub-recommended tool for removing sensitive data from git history. It requires Python which is available on this system. Do NOT use git-filter-branch (deprecated, slow) or BFG (requires Java not available).</action>
  <verify>Run `git-filter-repo --version` to confirm installation</verify>
  <done>git-filter-repo installed and accessible from command line</done>
</task>

<task type="auto">
  <name>Task 2: Remove file from tracking and update .gitignore</name>
  <files>.gitignore, GoogleService-Info.plist</files>
  <action>
1. Add Firebase config files to .gitignore:
   - GoogleService-Info.plist
   - **/GoogleService-Info.plist
   - google-services.json
   - **/google-services.json

2. Remove the file from git tracking (but keep local copy):
   - `git rm --cached GoogleService-Info.plist`

3. Commit these changes so HEAD is clean before history rewrite.

IMPORTANT: git-filter-repo requires a clean working directory and won't modify the latest commit by default. Making HEAD clean first ensures the file is removed from current state.
</action>
<verify>

- `git status` shows .gitignore modified and GoogleService-Info.plist removed from tracking
- `git ls-files GoogleService-Info.plist` returns empty
- File still exists locally: `ls GoogleService-Info.plist`
  </verify>
  <done>.gitignore updated with Firebase patterns, file untracked but preserved locally, committed</done>
  </task>

<task type="auto">
  <name>Task 3: Rewrite git history to remove GoogleService-Info.plist</name>
  <files>N/A (git history operation)</files>
  <action>
Use git-filter-repo to completely remove GoogleService-Info.plist from all git history:

```bash
git filter-repo --invert-paths --path GoogleService-Info.plist --force
```

Flags explained:

- `--invert-paths`: Remove paths that match (instead of keeping only matches)
- `--path GoogleService-Info.plist`: Target this specific file
- `--force`: Required when working in a non-fresh clone

After running, verify with:

```bash
git log --all --full-history -- GoogleService-Info.plist
```

Should return nothing.

IMPORTANT: This rewrites all commit hashes. The remote will need force push.
</action>
<verify>

- `git log --all --full-history -- GoogleService-Info.plist` returns nothing
- `git log --all --full-history -- "**/GoogleService-Info.plist"` returns nothing
- `git log -S "REVERSED_CLIENT_ID" --all` returns nothing (search for typical plist content)
  </verify>
  <done>GoogleService-Info.plist completely removed from all git history</done>
  </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Rewrote git history to remove GoogleService-Info.plist from all commits</what-built>
  <how-to-verify>
1. Verify local cleanup is complete:
   - Run: `git log --all --full-history -- GoogleService-Info.plist`
   - Expected: No output (file gone from history)

2. Verify file still exists locally for app to work:
   - Run: `ls GoogleService-Info.plist`
   - Expected: File exists

3. Verify .gitignore has the new rules:
   - Run: `grep -i googleservice .gitignore`
   - Expected: Shows GoogleService-Info.plist patterns

4. IMPORTANT: The next step will force push to GitHub, overwriting remote history.
   - All collaborators will need to re-clone or hard reset
   - This is necessary for security remediation
   - Confirm you want to proceed with force push
     </how-to-verify>
     <resume-signal>Type "approved" to proceed with force push, or describe any concerns</resume-signal>
     </task>

<task type="auto">
  <name>Task 4: Re-add remote and force push cleaned history</name>
  <files>N/A (git remote operation)</files>
  <action>
git-filter-repo removes the origin remote as a safety measure. Re-add it and force push:

```bash
# Re-add the remote
git remote add origin https://github.com/jushyi/re-lapse.git

# Force push all branches
git push --force --all origin

# Force push tags if any
git push --force --tags origin
```

Use `--force` not `--force-with-lease` because we intentionally want to overwrite the remote with our cleaned history.
</action>
<verify>

- `git remote -v` shows origin pointing to GitHub
- `git push` succeeds (no errors about diverged history)
- GitHub repo shows updated commit dates/hashes
  </verify>
  <done>Cleaned history pushed to GitHub, remote history overwritten</done>
  </task>

<task type="auto">
  <name>Task 5: Final verification and cleanup</name>
  <files>N/A (verification)</files>
  <action>
Perform final verification that cleanup is complete:

1. Clone fresh copy to verify:

   ```bash
   cd /tmp
   git clone https://github.com/jushyi/re-lapse.git verify-cleanup
   cd verify-cleanup
   git log --all --full-history -- GoogleService-Info.plist
   # Should return nothing
   ```

2. Verify app still works:
   - The local GoogleService-Info.plist (with rotated keys) should still exist
   - App functionality depends on this file being present

3. Run git gc locally to clean up loose objects:
   ```bash
   git reflog expire --expire=now --all
   git gc --prune=now --aggressive
   ```

Note: If any PRs on GitHub referenced this file, will need to contact GitHub Support for cache purging. Check this and document in summary.
</action>
<verify>

- Fresh clone shows no GoogleService-Info.plist in history
- Local GoogleService-Info.plist exists
- `git fsck --full` shows no errors
  </verify>
  <done>Cleanup verified complete, git history scrubbed, app has working config</done>
  </task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] git-filter-repo installed
- [ ] .gitignore contains Firebase config file patterns
- [ ] GoogleService-Info.plist removed from all git history (local)
- [ ] GoogleService-Info.plist removed from all git history (remote/GitHub)
- [ ] Local GoogleService-Info.plist file exists (for app to work)
- [ ] Fresh clone verification shows clean history
- [ ] No errors from `git fsck --full`
</verification>

<success_criteria>

- GoogleService-Info.plist completely removed from git history (all branches, all commits)
- .gitignore updated to prevent future accidental commits
- GitHub repository reflects cleaned history
- Local copy of file preserved for app functionality
- App can still build and run with rotated Firebase keys
  </success_criteria>

<output>
After completion, create `.planning/phases/21.1-api-key-remediation/21.1-01-SUMMARY.md`:

# Phase 21.1 Plan 01: API Key Exposure Remediation Summary

**[One-liner outcome]**

## Accomplishments

- git-filter-repo installed and used for history rewrite
- GoogleService-Info.plist removed from all git history
- .gitignore updated with Firebase config patterns
- Force push completed to GitHub
- Local file preserved for app functionality

## Files Created/Modified

- `.gitignore` - Added Firebase config patterns
- `GoogleService-Info.plist` - Removed from tracking (kept locally)

## Decisions Made

- Used git-filter-repo (GitHub recommended, Python-based) over BFG (no Java available)
- Force pushed to overwrite remote history (required for security remediation)

## Issues Encountered

- [Any GitHub cache purging needed?]
- [Any collaborator coordination needed?]

## Next Phase Readiness

Phase 21.1 complete, ready for Phase 22 (Environment and Configuration)
</output>
