rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper function to check if user is part of a friendship
    function isFriendshipMember(friendshipData) {
      return isAuthenticated() &&
             (friendshipData.user1Id == request.auth.uid ||
              friendshipData.user2Id == request.auth.uid);
    }

    // Helper function to check if users are friends
    function areFriends(userId) {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/friendships/$(generateFriendshipId(request.auth.uid, userId)));
    }

    // Generate deterministic friendship ID
    function generateFriendshipId(uid1, uid2) {
      return uid1 < uid2 ? uid1 + '_' + uid2 : uid2 + '_' + uid1;
    }

    // =============================================================================
    // USERS COLLECTION
    // =============================================================================
    match /users/{userId} {
      // Anyone authenticated can read any user profile (for friend search, etc.)
      allow read: if isAuthenticated();

      // Users can only create/update/delete their own profile
      allow create: if isOwner(userId) &&
                       request.resource.data.keys().hasAll(['username', 'email', 'createdAt']) &&
                       request.resource.data.username is string &&
                       request.resource.data.email is string;

      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    // =============================================================================
    // PHOTOS COLLECTION
    // =============================================================================
    match /photos/{photoId} {
      // Read access:
      // - Owner can always read their own photos
      // - Friends can read journaled photos (photoState == 'journal')
      allow read: if isOwner(resource.data.userId) ||
                     (isAuthenticated() &&
                      resource.data.photoState == 'journal' &&
                      areFriends(resource.data.userId));

      // Create: Only authenticated users can create photos for themselves
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.keys().hasAll(['userId', 'imageURL', 'capturedAt', 'status']) &&
                       request.resource.data.status in ['developing', 'revealed', 'triaged'] &&
                       (request.resource.data.photoState == null ||
                        request.resource.data.photoState in ['journal', 'archive']);

      // Update: Only owner can update their photos
      allow update: if isOwner(resource.data.userId) &&
                       request.resource.data.userId == resource.data.userId; // Prevent userId change

      // Delete: Only owner can delete their photos
      allow delete: if isOwner(resource.data.userId);
    }

    // =============================================================================
    // DARKROOMS COLLECTION
    // =============================================================================
    match /darkrooms/{userId} {
      // Users can only read/write their own darkroom
      allow read: if isOwner(userId);

      allow create: if isOwner(userId) &&
                       request.resource.data.userId == userId &&
                       request.resource.data.keys().hasAll(['userId', 'nextRevealAt', 'createdAt']);

      allow update: if isOwner(userId) &&
                       request.resource.data.userId == userId;

      allow delete: if isOwner(userId);
    }

    // =============================================================================
    // FRIENDSHIPS COLLECTION
    // =============================================================================
    match /friendships/{friendshipId} {
      // Read: Users can read friendships they're part of
      allow read: if isFriendshipMember(resource.data);

      // Create: Users can create friendships where they are the requester
      allow create: if isAuthenticated() &&
                       request.resource.data.requestedBy == request.auth.uid &&
                       (request.resource.data.user1Id == request.auth.uid ||
                        request.resource.data.user2Id == request.auth.uid) &&
                       request.resource.data.status == 'pending' &&
                       request.resource.data.keys().hasAll(['user1Id', 'user2Id', 'status', 'requestedBy', 'createdAt']);

      // Update: Users can accept/decline requests they received
      allow update: if isFriendshipMember(resource.data) &&
                       // User can only accept requests sent TO them
                       (request.resource.data.status == 'accepted' &&
                        resource.data.requestedBy != request.auth.uid) ||
                       // Or update other friendship data if they're a member
                       isFriendshipMember(request.resource.data);

      // Delete: Users can delete friendships they're part of (unfriend/cancel request)
      allow delete: if isFriendshipMember(resource.data);
    }

    // =============================================================================
    // NOTIFICATIONS COLLECTION
    // =============================================================================
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Only system (Cloud Functions) can create notifications
      // Users cannot create notifications directly
      allow create: if false;

      // Users can update their own notifications (e.g., mark as read)
      allow update: if isOwner(resource.data.userId) &&
                       request.resource.data.userId == resource.data.userId;

      // Users can delete their own notifications
      allow delete: if isOwner(resource.data.userId);
    }

    // =============================================================================
    // PHOTO VIEWS COLLECTION (for "NEW" indicator tracking)
    // =============================================================================
    match /photoViews/{viewId} {
      // Users can read their own photo view records
      allow read: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Users can create view records for themselves
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;

      // Users can update their own view records
      allow update: if isOwner(resource.data.userId);

      // Users can delete their own view records
      allow delete: if isOwner(resource.data.userId);
    }

    // =============================================================================
    // DEFAULT DENY
    // =============================================================================
    // Deny access to all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
